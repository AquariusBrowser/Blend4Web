var b4w=typeof b4w==="object"?b4w:function(exports){var _module={};exports.module=_module;var _ns_requires={};exports.register=function(module_id,fun){if(_module[module_id])return;_module[module_id]=fun};exports.require=require;function require(module_id,ns){var mod=_module[module_id];if(!mod)throw new Error('Module "'+module_id+'" not found');ns=ns||"__b4w_default";if(!_ns_requires[ns])_ns_requires[ns]=function(ns){return function(module_id){var mod=_module[module_id];if(!mod)throw new Error('Module "'+
module_id+'" not found');if(!mod._compiled)mod._compiled={};if(!mod._compiled[ns]){mod._compiled[ns]={};mod(mod._compiled[ns],_ns_requires[ns])}return mod._compiled[ns]}}(ns);return _ns_requires[ns](module_id)}exports.module_check=function(module_id){if(_module[module_id])return true;else return false};exports.get_namespace=function(mod_ns_require){for(var ns in _ns_requires)if(_ns_requires[ns]==mod_ns_require)return ns;return""};exports.worker_listeners=[];exports.worker_namespaces=[];return exports}({});if(typeof module=="object"&&module.exports)GLOBAL.b4w={module:{}};
b4w.module["__version"]=function(exports,require){var TYPE="RELEASE";var DATE=new Date(2015,9-1,30,10,21,0);var VERSION=[15,9];exports.version=version;function version(){if(TYPE=="DEBUG"){var d=date();return[parseInt(String(d.getFullYear()).slice(-2)),d.getMonth()+1]}else return VERSION}exports.version_str=function(){var str="";var ver=version();for(var i=0;i<ver.length;i++){if(i==1)str+=ver[i]<10?"0"+ver[i]:ver[i];else str+=ver[i];if(i!=ver.length-1)str+="."}return str};exports.type=function(){return TYPE};
exports.date=date;function date(){if(TYPE=="DEBUG")return new Date;else return DATE}exports.date_str=date_str;function date_str(){var d=date();var day=d.getDate();day=day<10?"0"+String(day):String(day);var month=d.getMonth()+1;month=month<10?"0"+String(month):String(month);var year=String(d.getFullYear());var hour=d.getHours();hour=hour<10?"0"+String(hour):String(hour);var minute=d.getMinutes();minute=minute<10?"0"+String(minute):String(minute);var second=d.getSeconds();second=second<10?"0"+String(second):
String(second);var date_str=day+"."+month+"."+year+" "+hour+":"+minute+":"+second;return date_str}exports.timestamp=function(){var ts=date_str();ts=ts.split(" ").join("").split(":").join("").split(".").join("");ts="?t="+ts;return ts}};if(typeof module=="object"&&module.exports)b4w.module["__version"](exports);b4w.module["__config"]=function(exports,require){var m_print=require("__print");var m_util=require("__util");exports.P_LOW=1;exports.P_HIGH=2;exports.P_ULTRA=3;exports.P_CUSTOM=4;exports.context={alpha:true,antialias:false,premultipliedAlpha:true};exports.context_save=m_util.clone_object_r(exports.context);exports.defaults={alpha_sort:true,alpha_sort_threshold:.1,alpha_clip_filtering_hack:false,min_format_version:[5,6],max_fps:1E4,console_verbose:false,do_not_load_resources:false,use_min50:false,
fps_measurement_interval:1.5,fps_callback_interval:10,background_color:[0,0,0,0],lod_transition_ratio:.01,render_resolution_factor:1,canvas_resolution_factor:1,texture_min_filter:3,allow_cors:false,force_low_quality_nodes:false,anisotropic_filtering:true,show_hud_debug_info:false,depth_textures:true,shadows:true,anaglyph_use:false,reflections:true,refractions:true,ssao:true,dof:true,god_rays:true,bloom:true,motion_blur:true,compositing:true,antialiasing:true,smaa:false,wireframe_debug:false,water_wireframe_debug:false,
foam:true,parallax:true,dynamic_grass:true,procedural_fog:true,water_dynamic:true,shore_smoothing:true,shore_distance:true,max_texture_size:1024,max_cube_map_size:512,use_dds:true,precision:"highp",quality:exports.P_HIGH,allow_vertex_textures:true,no_phy_interp_hack:false,shader_constants_hack:false,disable_blend_shadows_hack:false,vert_anim_mix_normals_hack:false,is_mobile_device:false,disable_doppler_hack:false,cors_chrome_hack:false,init_wa_context_hack:false,clear_procedural_sky_hack:false,sky_update_hack:false,
seq_video_fallback:false,allow_hidpi:false,gyro_use:false,firefox_shadows_slink_hack:false,mobile_firefox_media_hack:false,enable_selectable:true,enable_outlining:true,glow_materials:true,max_vertex_uniform_vectors:128,ie11_edge_touchscreen_hack:false,ios_depth_hack:false,macos_tex_reuse_hack:false,loaded_data_version:[0,0],edge_min_tex_size_hack:false,quality_aa:true};exports.defaults_save=m_util.clone_object_r(exports.defaults);exports.animation={framerate:-1,frames_blending_hack:false,frame_steps:1};
exports.controls={mouse_wheel_notch_multiplier:1/120};exports.assets={dir:"ASSETS=../../assets/",max_requests:15,prevent_caching:true,min50_available:false,dds_available:false};exports.assets_save=m_util.clone_object_r(exports.assets);exports.paths={shaders_dir:"",shaders_include_dir:"include/",shaders_postp_dir:"postprocessing/",built_in_data_module:"built_in_data",js_src_search_paths:["b4w.min.js","b4w.full.min.js","b4w.simple.min.js","b4w.whitespace.min.js","src/b4w.js","USER_DEFINED_MODULE"],
resources_dir:"./",smaa_search_texture_path:"",smaa_area_texture_path:""};exports.physics={enabled:true,max_fps:60,uranium_path:"",calc_fps:false,ping:false,use_workers:true};exports.physics_save=m_util.clone_object_r(exports.physics);exports.scenes={grass_tex_size:2*512,cubemap_tex_size:384,cube_reflect_low:32,cube_reflect_medium:128,cube_reflect_high:256,plane_reflect_low:.25,plane_reflect_medium:.5,plane_reflect_high:1};exports.scenes_save=m_util.clone_object_r(exports.scenes);exports.sfx={webaudio:true,
mix_mode:false,audio_loading_hack:false,clamp_playback_rate_hack:false,disable_playback_rate_hack:false};exports.sfx_save=m_util.clone_object_r(exports.sfx);exports.outlining={outlining_overview_mode:false,outline_color:[1,.4,.05],outline_duration:.2,outline_period:3.8,outline_relapses:1};exports.debug_subs={enabled:false,subs_type:"MAIN_OPAQUE",subs_number:0,slink_type:"DEPTH"};exports.debug_subs_save=m_util.clone_object_r(exports.debug_subs);exports.apply_quality=function(){var cfg_def=exports.defaults;
var cfg_phy=exports.physics;var cfg_scs=exports.scenes;switch(cfg_def.quality){case exports.P_ULTRA:cfg_def.shadows=true,cfg_def.shore_smoothing=true,cfg_def.ssao=true;cfg_def.dof=true;cfg_def.god_rays=true;cfg_def.bloom=true;cfg_def.reflections=true;cfg_def.refractions=true;cfg_def.foam=true;cfg_def.parallax=true;cfg_def.dynamic_grass=true;cfg_def.procedural_fog=true;cfg_def.render_resolution_factor=1.75;cfg_scs.grass_tex_size=4*512;cfg_def.texture_min_filter=3;cfg_def.anisotropic_filtering=true;
cfg_def.use_min50=false;cfg_def.precision="highp";cfg_def.water_dynamic=true;cfg_def.shore_distance=true;cfg_def.antialiasing=true;cfg_def.smaa=true;cfg_def.compositing=true;cfg_def.motion_blur=true;cfg_def.allow_hidpi=true;cfg_def.enable_outlining=true;cfg_def.glow_materials=true;cfg_phy.max_fps=120;break;case exports.P_HIGH:cfg_def.shadows=true;cfg_def.shore_smoothing=true;cfg_def.ssao=true;cfg_def.dof=true;cfg_def.god_rays=true;cfg_def.bloom=true;cfg_def.reflections=true;cfg_def.refractions=true;
cfg_def.foam=true;cfg_def.parallax=true;cfg_def.dynamic_grass=true;cfg_def.procedural_fog=true;cfg_def.render_resolution_factor=1;cfg_scs.grass_tex_size=2*512;cfg_def.texture_min_filter=3;cfg_def.anisotropic_filtering=true;cfg_def.use_min50=false;cfg_def.precision="highp";cfg_def.water_dynamic=true;cfg_def.shore_distance=true;cfg_def.antialiasing=true;cfg_def.smaa=false;cfg_def.compositing=true;cfg_def.motion_blur=true;cfg_def.allow_hidpi=false;cfg_def.enable_outlining=true;cfg_def.glow_materials=
true;cfg_phy.max_fps=60;break;case exports.P_LOW:cfg_def.shadows=false;cfg_def.shore_smoothing=false;cfg_def.ssao=false;cfg_def.dof=false;cfg_def.god_rays=false;cfg_def.bloom=false;cfg_def.reflections=false;cfg_def.refractions=false;cfg_def.foam=false;cfg_def.parallax=false;cfg_def.dynamic_grass=false;cfg_def.procedural_fog=false;cfg_def.render_resolution_factor=1;cfg_scs.grass_tex_size=1*512;cfg_def.texture_min_filter=2;cfg_def.anisotropic_filtering=false;cfg_def.use_min50=true;cfg_def.precision=
"mediump";cfg_def.water_dynamic=false;cfg_def.shore_distance=false;cfg_def.antialiasing=false;cfg_def.smaa=false;cfg_def.compositing=false;cfg_def.motion_blur=false;cfg_def.allow_hidpi=false;cfg_def.enable_outlining=false;cfg_def.glow_materials=false;cfg_phy.max_fps=60;break}};exports.set=set;function set(prop,value){switch(prop){case "allow_cors":exports.defaults.allow_cors=value;break;case "allow_hidpi":exports.defaults.allow_hidpi=value;break;case "alpha":exports.context.alpha=value;break;case "alpha_sort":exports.defaults.alpha_sort=
value;break;case "alpha_sort_threshold":exports.defaults.alpha_sort_threshold=value;break;case "anaglyph_use":exports.defaults.anaglyph_use=value;break;case "animation_framerate":exports.animation.framerate=value;break;case "antialiasing":exports.defaults.antialiasing=value;break;case "assets_dds_available":exports.assets.dds_available=value;break;case "assets_min50_available":exports.assets.min50_available=value;break;case "audio":exports.sfx.webaudio=value;break;case "background_color":exports.defaults.background_color=
value;break;case "built_in_module_name":exports.paths.built_in_data_module=value;break;case "canvas_resolution_factor":exports.defaults.canvas_resolution_factor=value;break;case "console_verbose":exports.defaults.console_verbose=value;break;case "do_not_load_resources":exports.defaults.do_not_load_resources=value;break;case "gyro_use":exports.defaults.gyro_use=value;break;case "physics_enabled":exports.physics.enabled=value;break;case "physics_uranium_path":exports.physics.uranium_path=value;break;
case "physics_calc_fps":exports.physics.calc_fps=value;break;case "physics_use_workers":exports.physics.use_workers=value;break;case "precision":exports.defaults.precision=value;break;case "quality":exports.defaults.quality=value;break;case "render_resolution_factor":exports.defaults.render_resolution_factor=value;break;case "sfx_mix_mode":exports.sfx.mix_mode=value;break;case "shaders_dir":exports.paths.shaders_dir=value;break;case "show_hud_debug_info":exports.defaults.show_hud_debug_info=value;
break;case "smaa":exports.defaults.smaa=value;break;case "smaa_search_texture_path":exports.paths.smaa_search_texture_path=value;break;case "smaa_area_texture_path":exports.paths.smaa_area_texture_path=value;break;case "wireframe_debug":exports.defaults.wireframe_debug=value;break;case "enable_selectable":exports.defaults.enable_selectable=value;break;case "enable_outlining":exports.defaults.enable_outlining=value;break;case "outlining_overview_mode":exports.outlining.outlining_overview_mode=value;
break;case "glow_materials":exports.defaults.glow_materials=value;break;default:m_print.error("Unknown config property: "+prop);break}}exports.get=function(prop){switch(prop){case "allow_cors":return exports.defaults.allow_cors;case "allow_hidpi":return exports.defaults.allow_hidpi;case "alpha":return exports.context.alpha;case "alpha_sort":return exports.defaults.alpha_sort;case "alpha_sort_threshold":return exports.defaults.alpha_sort_threshold;case "anaglyph_use":return exports.defaults.anaglyph_use;
case "animation_framerate":return exports.animation.framerate;case "antialiasing":return exports.defaults.antialiasing;case "assets_dds_available":return exports.assets.dds_available;case "assets_min50_available":return exports.assets.min50_available;case "audio":return exports.sfx.webaudio;case "background_color":return exports.defaults.background_color;case "built_in_module_name":return exports.paths.built_in_data_module;case "canvas_resolution_factor":return exports.defaults.canvas_resolution_factor;
case "console_verbose":return exports.defaults.console_verbose;case "do_not_load_resources":return exports.defaults.do_not_load_resources;case "gyro_use":return exports.defaults.gyro_use;case "physics_enabled":return exports.physics.enabled;case "physics_uranium_path":return exports.physics.uranium_path;case "physics_calc_fps":return exports.physics.calc_fps;case "physics_use_workers":return exports.physics.use_workers;case "precision":return exports.defaults.precision;case "quality":return exports.defaults.quality;
case "render_resolution_factor":return exports.defaults.render_resolution_factor;case "sfx_mix_mode":return exports.sfx.mix_mode;case "shaders_dir":return exports.paths.shaders_dir;case "show_hud_debug_info":return exports.defaults.show_hud_debug_info;case "smaa":return exports.defaults.smaa;case "smaa_search_texture_path":return exports.paths.smaa_search_texture_path;case "smaa_area_texture_path":return exports.paths.smaa_area_texture_path;case "wireframe_debug":return exports.defaults.wireframe_debug;
case "enable_selectable":return exports.defaults.enable_selectable;case "enable_outlining":return exports.defaults.enable_outlining;case "outlining_overview_mode":return exports.outlining.outlining_overview_mode;case "glow_materials":return exports.defaults.glow_materials;default:m_print.error("Unknown config property: "+prop);break}};exports.reset=function(){exports.context=m_util.clone_object_r(exports.context_save);exports.defaults=m_util.clone_object_r(exports.defaults_save);exports.assets=m_util.clone_object_r(exports.assets_save);
exports.physics=m_util.clone_object_r(exports.physics_save);exports.scenes=m_util.clone_object_r(exports.scenes_save);exports.sfx=m_util.clone_object_r(exports.sfx_save);exports.debug_subs=m_util.clone_object_r(exports.debug_subs_save)};exports.is_built_in_data=is_built_in_data;function is_built_in_data(){return b4w.module_check(exports.paths.built_in_data_module)}exports.set_paths=function(){var cfg_pth=exports.paths;var cfg_phy=exports.physics;if(!is_built_in_data()&&cfg_pth.shaders_dir=="")cfg_pth.shaders_dir=
js_src_dir()+"../shaders/";if(is_built_in_data()){cfg_pth.smaa_search_texture_path="smaa_search_texture.png";cfg_pth.smaa_area_texture_path="smaa_area_texture.png"}else if(cfg_pth.smaa_search_texture_path==""||cfg_pth.smaa_area_texture_path==""){var resources_dir=js_src_dir()+cfg_pth.resources_dir;cfg_pth.smaa_search_texture_path=cfg_pth.smaa_search_texture_path||resources_dir+"smaa_search_texture.png";cfg_pth.smaa_area_texture_path=cfg_pth.smaa_area_texture_path||resources_dir+"smaa_area_texture.png"}if(cfg_phy.enabled&&
cfg_phy.uranium_path==""){var resources_dir=js_src_dir()+cfg_pth.resources_dir;cfg_phy.uranium_path=resources_dir+"uranium.js"}};function js_src_dir(){var cfg_pth=exports.paths;var src_path=null;var scripts=document.getElementsByTagName("script");for(var i=0;i<scripts.length;i++){var src=scripts[i].src;for(var j=0;j<cfg_pth.js_src_search_paths.length;j++){var script_path=cfg_pth.js_src_search_paths[j];if(src.indexOf(script_path)>=0){src_path=src;break}}if(src_path!==null)break}if(!src_path){m_print.warn("Couldn't determine path to ancillary resources, "+
"fallback to the current page directory");src_path=document.location.href}var index=src_path.indexOf("?");if(index>=0)src_path=src_path.substring(0,index);return src_path.substring(0,src_path.lastIndexOf("/")+1)}exports.get_std_assets_path=function(){return exports.assets.dir.replace("ASSETS=","")}};b4w.module["__anchors"]=function(exports,require){var m_batch=require("__batch");var m_cam=require("__camera");var m_cont=require("__container");var m_obj=require("__objects");var m_print=require("__print");var m_render=require("__renderer");var m_scenes=require("__scenes");var m_time=require("__time");var m_util=require("__util");var cfg_def=require("__config").defaults;var _is_paused=false;var _anchors=[];var _anchor_batch_pos=new Float32Array(0);var _pixels=new Uint8Array(16);var _vec2_tmp=new Float32Array(2);
var _vec3_tmp=new Float32Array(3);exports.append=function(obj){if(has_anchor_obj(obj))return;var det_vis=obj.anchor.detect_visibility&&Boolean(m_scenes.get_subs(m_scenes.get_main(),"ANCHOR_VISIBILITY"));var anchor={type:obj.anchor.type,obj:obj,x:0,y:0,depth:0,appearance:"out",detect_visibility:det_vis,element:null,move_cb:null,annotation_max_width:obj.anchor.max_width,annotation_height:0,element_id:obj.anchor.element_id};switch(anchor.type){case "ANNOTATION":anchor.element=create_annotation(obj,anchor.annotation_max_width);
anchor.annotation_height=anchor.element.offsetHeight;break;case "ELEMENT":anchor.element=document.getElementById(obj.anchor.element_id);if(!anchor.element){m_print.warn("Anchor HTML element was not found, making it generic");anchor.type="GENERIC"}break;case "GENERIC":break}_anchors.push(anchor);resize_anchor_batch_pos()};function has_anchor_obj(obj){for(var i=0;i<_anchors.length;i++)if(_anchors[i].obj==obj)return true;return false}function create_annotation(obj,max_width){var div=document.createElement("div");
var div_style=div.style;div_style.position="absolute";div_style.backgroundColor="black";div_style.borderRadius="20px 20px 20px 0px";div_style.boxShadow="0px 0px 10px rgb(180, 180, 200)";div_style.opacity=1;div_style.padding="8px 12px";div_style.lineHeight="15px";div_style.visibility="hidden";div_style.fontSize="12px";var canvas_cont=m_cont.get_container();canvas_cont.appendChild(div);var meta_tags=m_obj.get_meta_tags(obj);var title=meta_tags.title||obj.name;var title_span=document.createElement("span");
var title_span_style=title_span.style;title_span.innerHTML=title;title_span_style.fontWeight="bold";title_span_style.fontSize="12px";title_span_style.lineHeight="15px";title_span_style.color="#fff";title_span_style.fontFamily="Arial";add_noselect_style(title_span);div.appendChild(title_span);var desc=meta_tags.description;if(desc){var desc_div=document.createElement("div");var desc_div_style=desc_div.style;desc_div_style.position="absolute";desc_div_style.bottom="0px";desc_div_style.left="0px";desc_div_style.backgroundColor=
"#000";desc_div_style.borderRadius="20px 20px 20px 0px";desc_div_style.boxShadow="0px 0px 10px rgb(180, 180, 200)";desc_div_style.visibility="hidden";desc_div_style.padding="8px 12px";desc_div_style.overflow="hidden";desc_div_style.lineHeight="15px";desc_div_style.fontSize="12px";desc_div_style.zIndex="2";div.appendChild(desc_div);var desc_span=document.createElement("span");var desc_span_style=desc_span.style;desc_span.innerHTML=desc;desc_span_style.fontSize="12px";desc_span_style.fontFamily="Arial";
desc_span_style.fontWeight="bold";desc_span_style.lineHeight="15px";desc_span_style.color="#fff";desc_span_style.visibility="hidden";desc_div.appendChild(desc_span);var width_anim=false;var height_anim=false;canvas_cont.addEventListener("click",function(e){if(width_anim||height_anim||_is_paused)return;if((e.target==title_span||e.target==div)&&desc_div_style.visibility=="hidden"&&div_style.opacity==1){div_style.visibility="hidden";title_span_style.visibility="hidden";desc_div_style.visibility="visible";
width_anim=height_anim=true;var parent_width=div.offsetWidth-24;var parent_height=div.offsetHeight-16;var descr_width=Math.min(max_width,str_width(desc,"12px"));var descr_height=str_height(desc,"12px",descr_width);if(descr_height==parent_height)desc_div_style.height=descr_height+"px";if(descr_width!=parent_width)m_time.animate(parent_width,descr_width,200,function(e){if(e==descr_width){if(desc_div_style.visibility=="visible")desc_span_style.visibility="visible";width_anim=false}desc_div_style.width=
e+"px"});else width_anim=false;if(descr_height!=parent_height)m_time.animate(parent_height,descr_height,200,function(e){if(e==descr_height){if(desc_div_style.visibility=="visible")desc_span_style.visibility="visible";height_anim=false}desc_div_style.height=e+"px"});else height_anim=false;if(!height_anim&&!width_anim)desc_span_style.visibility="visible"}else if(desc_div_style.visibility=="visible"){div_style.visibility="visible";title_span_style.visibility="visible";desc_div_style.visibility="hidden";
desc_span_style.visibility="hidden"}},false)}return div}function str_width(str,font_size,max_width){var div=document.createElement("div");var span=document.createElement("span");var div_style=div.style;span.innerHTML=str;span.style.fontSize=font_size;span.style.fontFamily="Arial";span.style.fontWeight="bold";span.style.color="#fff";span.style.visibility="hidden";div_style.lineHeight="15px";div.appendChild(span);div_style.position="absolute";div_style.visibility="hidden";div_style.fontSize=font_size;
div_style.display="inline-block";div_style.lineHeight="15px";document.body.appendChild(div);var w=div.offsetWidth+1;document.body.removeChild(div);return w}function str_height(str,font_size,max_width){var div=document.createElement("div");var span=document.createElement("span");var div_style=div.style;span.innerHTML=str;span.style.fontSize=font_size;span.style.fontFamily="Arial";span.style.fontWeight="bold";span.style.color="#fff";span.style.visibility="hidden";div_style.lineHeight="15px";div.appendChild(span);
div_style.position="absolute";div_style.visibility="hidden";div_style.fontSize=font_size;div_style.display="inline-block";div_style.width=max_width+"px";div_style.lineHeight="15px";document.body.appendChild(div);var h=div.offsetHeight;document.body.removeChild(div);return h}function add_noselect_style(elem){elem.style["-webkit-touch-callout"]="none";elem.style["-webkit-user-select"]="none";elem.style["-khtml-user-select"]="none";elem.style["-moz-user-select"]="none";elem.style["-ms-user-select"]=
"none";elem.style["user-select"]="none";elem.style["cursor"]="default"}function resize_anchor_batch_pos(){var num=0;for(var i=0;i<_anchors.length;i++)if(_anchors[i].detect_visibility)num++;_anchor_batch_pos=new Float32Array(3*num)}exports.remove=function(obj){for(var i=0;i<_anchors.length;i++){var anchor=_anchors[i];if(anchor.obj==obj){if(anchor.type=="ANNOTATION")remove_annotation(anchor);_anchors.splice(i,1);resize_anchor_batch_pos();i--;break}}};function sort_anchors_zindex(a,b){return b.depth-
a.depth}exports.update=function(){var det_vis_cnt=0;for(var i=_anchors.length;i--;){var anchor=_anchors[i];if(anchor.detect_visibility){_anchor_batch_pos.set(anchor.obj.render.trans,3*det_vis_cnt);det_vis_cnt++}var pp=anchor_project(anchor,_vec3_tmp);var x=pp[0];var y=pp[1];var depth=pp[2];if(x==anchor.x&&y==anchor.y&&depth==anchor.depth)continue;switch(anchor.type){case "ANNOTATION":var element=anchor.element;element.style.left=Math.floor(x)+"px";element.style.top=Math.floor(y-anchor.annotation_height)+
"px";break;case "ELEMENT":var element=anchor.element;var bounding_box=element.getBoundingClientRect();element.style.cssText+="left:"+Math.floor(x-bounding_box.width/2)+"px;"+"top:"+Math.floor(y-bounding_box.height/2)+"px;";break;case "GENERIC":break}anchor.x=x;anchor.y=y;anchor.depth=depth;if(anchor.move_cb)anchor.move_cb(x,y,anchor.appearance,anchor.obj,element)}_anchors.sort(sort_anchors_zindex);for(var i=0;i<_anchors.length;i++){var anchor=_anchors[i];if(anchor.type!="GENERIC")anchor.element.style.zIndex=
i}if(det_vis_cnt>0){var subs_anchor=m_scenes.get_subs(m_scenes.get_main(),"ANCHOR_VISIBILITY");var batch_anchor=subs_anchor.bundles[0].batch;m_batch.update_anchor_visibility_batch(batch_anchor,_anchor_batch_pos)}};function anchor_project(anchor,dest){var camobj=m_scenes.get_camera(m_scenes.get_main());var dest=m_cam.project_point(camobj,anchor.obj.render.trans,dest);return dest}exports.update_visibility=function(){var canvas_cont=m_cont.get_container();for(var i=_anchors.length;i--;){var anchor=_anchors[i];
var obj=anchor.obj;var x=anchor.x;var y=anchor.y;var depth=anchor.depth;if(x<0||y<0||depth<0||depth>1||m_scenes.is_hidden(obj)||x>=canvas_cont.clientWidth||y>=canvas_cont.clientHeight)var appearance="out";else var appearance="visible";if(anchor.detect_visibility&&appearance!="out")appearance=pick_anchor_visibility(anchor);if(appearance==anchor.appearance)continue;switch(anchor.type){case "ANNOTATION":case "ELEMENT":var element=anchor.element;if(!element)break;if(appearance=="out"){element.style.visibility=
"hidden";if(element.children.length)element.children[0].style.visibility="hidden";if(anchor.type=="ANNOTATION"&&element.children.length>1){var child=element.children[1];child.style.visibility="hidden";if(child.children.length)child.children[0].style.visibility="hidden"}}else if(appearance=="visible"){element.style.visibility="visible";if(element.children.length)element.children[0].style.visibility="visible";element.style.opacity=1}else{element.style.visibility="visible";element.style.opacity=.1;if(element.children.length)element.children[0].style.visibility=
"visible";if(anchor.type=="ANNOTATION"&&element.children.length>1){var child=element.children[1];child.style.visibility="hidden";if(child.children.length)child.children[0].style.visibility="hidden"}}break;case "GENERIC":break}anchor.appearance=appearance;if(anchor.move_cb)anchor.move_cb(x,y,anchor.appearance,obj,element)}};function pick_anchor_visibility(anchor){var subs_anchor=m_scenes.get_subs(m_scenes.get_main(),"ANCHOR_VISIBILITY");var anchor_cam=subs_anchor.camera;var viewport_xy=m_cont.canvas_to_viewport_coords(anchor.x,
anchor.y,_vec2_tmp,anchor_cam);m_render.read_pixels(anchor_cam.framebuffer,viewport_xy[0],anchor_cam.height-viewport_xy[1],2,2,_pixels);if(_pixels[0]+_pixels[4]+_pixels[8]+_pixels[12]==4*255)return"visible";else if(anchor.appearance=="out"||_pixels[0]+_pixels[4]+_pixels[8]+_pixels[12]==0)return"covered";else return anchor.appearance}exports.attach_move_cb=function(obj,callback){for(var i=0;i<_anchors.length;i++)if(_anchors[i].obj==obj)_anchors[i].move_cb=callback};exports.detach_move_cb=function(obj){for(var i=
0;i<_anchors.length;i++)if(_anchors[i].obj==obj)_anchors[i].move_cb=null};function remove_annotation(anchor){var canvas_cont=m_cont.get_container();canvas_cont.removeChild(anchor.element)}exports.cleanup=function(){for(var i=0;i<_anchors.length;i++){var anchor=_anchors[i];if(anchor.type=="ANNOTATION")remove_annotation(anchor)}_anchors.length=0};exports.is_anchor=function(obj){for(var i=0;i<_anchors.length;i++)if(_anchors[i].obj==obj)return true;return false};exports.get_element_id=function(obj){for(var i=
0;i<_anchors.length;i++)if(_anchors[i].obj==obj)return _anchors[i].element_id;return false};exports.pause=function(){_is_paused=true};exports.resume=function(){_is_paused=false}};b4w.module["__armature"]=function(exports,require){var m_util=require("__util");var m_tsr=require("__tsr");var m_quat=require("__quat");var m_mat4=require("__mat4");var m_vec3=require("__vec3");var _tsr8_tmp=new Float32Array(8);var _tsr8_tmp2=new Float32Array(8);var _vec4_tmp=new Float32Array(4);var _quat4_tmp=new Float32Array(4);var _quat4_tmp2=new Float32Array(4);function init_bone_pointer(){var bone_ptr={bone_index:0,vgroup_index:-1,parent_bone_ptr:null,descend_bones_ptrs:[],chain:[],constraint:null,
tsr_bone_rest:m_tsr.create(),tsr_bone_pose:m_tsr.create(),tsr_local_rest:m_tsr.create(),tsr_local_pose:m_tsr.create(),tsr_basis:m_tsr.create(),tsr_channel_cache:m_tsr.create(),tsr_channel_cache_valid:false,tail:new Float32Array(3)};return bone_ptr}exports.update_object=update_object;function update_object(bpy_armobj,armobj){var arm_bones=bpy_armobj["data"]["bones"];var pose_bones=bpy_armobj["pose"]["bones"];var bone_pointers={};for(var i=0;i<pose_bones.length;i++){var pose_bone=pose_bones[i];var arm_bone=
pose_bone["bone"];var bone_name=arm_bone["name"];var bpointer=bone_pointers[bone_name]=init_bone_pointer();var mat_loc=new Float32Array(arm_bone["matrix_local"]);var mat_loc_inv=new Float32Array(16);m_mat4.invert(mat_loc,mat_loc_inv);var mat_bas=new Float32Array(pose_bone["matrix_basis"]);var tail=bpointer.tail;m_vec3.subtract(arm_bone["tail_local"],arm_bone["head_local"],tail);m_util.vecdir_multiply_matrix(tail,mat_loc_inv,tail);m_tsr.from_mat4(mat_loc,bpointer.tsr_local_rest);m_tsr.from_mat4(mat_bas,
bpointer.tsr_basis);m_tsr.copy(bpointer.tsr_local_rest,bpointer.tsr_local_pose)}for(var i=0;i<arm_bones.length;i++){var bone=arm_bones[i];var bone_name=bone["name"];var pose_bone=m_util.keysearch("name",bone_name,pose_bones);var bpointer=bone_pointers[bone_name];var parent_pose_bones=pose_bone["parent_recursive"];bpointer.chain.push(bpointer);for(var j=0;j<parent_pose_bones.length;j++){var parent_bone=parent_pose_bones[j];var parent_bone_name=parent_bone["name"];var parent_bone_ptr=bone_pointers[parent_bone_name];
bpointer.chain.push(parent_bone_ptr)}if(parent_pose_bones.length){var parent_bone=parent_pose_bones[0];var parent_bone_name=parent_bone["name"];var parent_bone_ptr=bone_pointers[parent_bone_name];bpointer.parent_bone_ptr=parent_bone_ptr;m_tsr.invert(parent_bone_ptr.tsr_local_rest,_tsr8_tmp);m_tsr.multiply(_tsr8_tmp,bpointer.tsr_local_rest,bpointer.tsr_bone_rest);parent_bone_ptr.descend_bones_ptrs.push(bpointer)}else m_tsr.copy(bpointer.tsr_local_rest,bpointer.tsr_bone_rest);bpointer.bone_index=i;
bpointer.name=bone_name;m_tsr.multiply(bpointer.tsr_bone_rest,bpointer.tsr_basis,bpointer.tsr_bone_pose)}armobj.render.bone_pointers=bone_pointers}exports.get_bone_tsr=function(armobj,bone_name,get_pose_tail,use_bone_space,dest_tsr){var render=armobj.render;var frame_factor=render.frame_factor;var bone_pointer=render.bone_pointers[bone_name];var index=bone_pointer.bone_index;var tsr_local=bone_pointer.tsr_local_rest;var transcale=_vec4_tmp;var trans_before=render.trans_before;var trans_after=render.trans_after;
var quats_before=render.quats_before;var quats_after=render.quats_after;var x=trans_before[4*index];var y=trans_before[4*index+1];var z=trans_before[4*index+2];var s=trans_before[4*index+3];var xn=trans_after[4*index];var yn=trans_after[4*index+1];var zn=trans_after[4*index+2];var sn=trans_after[4*index+3];transcale[0]=(1-frame_factor)*x+frame_factor*xn;transcale[1]=(1-frame_factor)*y+frame_factor*yn;transcale[2]=(1-frame_factor)*z+frame_factor*zn;transcale[3]=(1-frame_factor)*s+frame_factor*sn;var quat=
_quat4_tmp;var quatn=_quat4_tmp2;quat[0]=quats_before[4*index];quat[1]=quats_before[4*index+1];quat[2]=quats_before[4*index+2];quat[3]=quats_before[4*index+3];quatn[0]=quats_after[4*index];quatn[1]=quats_after[4*index+1];quatn[2]=quats_after[4*index+2];quatn[3]=quats_after[4*index+3];m_quat.slerp(quat,quatn,frame_factor,quat);var tsr_bone=_tsr8_tmp;m_tsr.set_transcale(transcale,tsr_bone);m_tsr.set_quat(quat,tsr_bone);if(get_pose_tail){var tsr_local_tail=_tsr8_tmp2;m_tsr.translate(tsr_local,bone_pointer.tail,
tsr_local_tail);m_tsr.multiply(tsr_bone,tsr_local_tail,tsr_bone)}else m_tsr.multiply(tsr_bone,tsr_local,tsr_bone);if(use_bone_space){var parent_bone_ptr=bone_pointer.parent_bone_ptr;if(parent_bone_ptr){var tsr_par_local=parent_bone_ptr.tsr_local_pose;var inv_tsr_par_local=_tsr8_tmp2;m_tsr.invert(tsr_par_local,inv_tsr_par_local);m_tsr.multiply(inv_tsr_par_local,tsr_bone,tsr_bone)}var tsr_bone_rest=bone_pointer.tsr_bone_rest;var inv_tsr_bone_rest=_tsr8_tmp2;m_tsr.invert(tsr_bone_rest,inv_tsr_bone_rest);
m_tsr.multiply(inv_tsr_bone_rest,tsr_bone,tsr_bone)}m_tsr.copy(tsr_bone,dest_tsr)};exports.set_bone_tsr=function(armobj,bone_name,tsr,use_bone_space){var render=armobj.render;var bone_pointer=render.bone_pointers[bone_name];var trans_before=render.trans_before;var quats_before=render.quats_before;if(use_bone_space)m_tsr.multiply(bone_pointer.tsr_bone_rest,tsr,bone_pointer.tsr_bone_pose);else m_tsr.copy(tsr,bone_pointer.tsr_local_pose);update_bone_tsr_r(bone_pointer,use_bone_space,trans_before,quats_before);
render.frame_factor=0;update_skinned_renders(armobj)};exports.update_skinned_renders=update_skinned_renders;function update_skinned_renders(armobj){var render=armobj.render;var skinned_renders=render.skinned_renders;var bone_maps=render.mesh_to_arm_bone_maps;for(var i=0;i<skinned_renders.length;i++){var skinned_render=skinned_renders[i];var bone_map=bone_maps[i];for(var j=0;j<bone_map.length;j+=2){var sk_ind=bone_map[j];var arm_ind=bone_map[j+1];for(var k=0;k<4;k++){skinned_render.quats_before[sk_ind+
k]=render.quats_before[arm_ind+k];skinned_render.quats_after[sk_ind+k]=render.quats_after[arm_ind+k];skinned_render.trans_before[sk_ind+k]=render.trans_before[arm_ind+k];skinned_render.trans_after[sk_ind+k]=render.trans_after[arm_ind+k]}}skinned_render.frame_factor=render.frame_factor}}exports.update_bone_tsr_r=update_bone_tsr_r;function update_bone_tsr_r(bone_pointer,use_bone_space,trans,quats){var tsr_bone_pose=bone_pointer.tsr_bone_pose;var tsr_local_rest=bone_pointer.tsr_local_rest;var tsr_local_pose=
bone_pointer.tsr_local_pose;var parent_bone_ptr=bone_pointer.parent_bone_ptr;if(parent_bone_ptr){var tsr_par_local=parent_bone_ptr.tsr_local_pose;if(use_bone_space)m_tsr.multiply(tsr_par_local,tsr_bone_pose,tsr_local_pose);else{var inv_tsr_par_local=_tsr8_tmp2;m_tsr.invert(tsr_par_local,inv_tsr_par_local);m_tsr.multiply(inv_tsr_par_local,tsr_local_pose,tsr_bone_pose)}}else if(use_bone_space)m_tsr.copy(tsr_bone_pose,tsr_local_pose);else m_tsr.copy(tsr_local_pose,tsr_bone_pose);var dest_tsr=_tsr8_tmp;
m_tsr.invert(tsr_local_rest,dest_tsr);m_tsr.multiply(tsr_local_pose,dest_tsr,dest_tsr);var index=bone_pointer.bone_index;trans[4*index]=dest_tsr[0];trans[4*index+1]=dest_tsr[1];trans[4*index+2]=dest_tsr[2];trans[4*index+3]=dest_tsr[3];quats[4*index]=dest_tsr[4];quats[4*index+1]=dest_tsr[5];quats[4*index+2]=dest_tsr[6];quats[4*index+3]=dest_tsr[7];var descend_ptrs=bone_pointer.descend_bones_ptrs;for(var i=0;i<descend_ptrs.length;i++){var desc_bone_ptr=descend_ptrs[i];if(desc_bone_ptr.constraint)continue;
update_bone_tsr_r(desc_bone_ptr,true,trans,quats)}}exports.check_bone=function(armobj,bone_name){return bone_name in armobj.render.bone_pointers}};b4w.module["__boundings"]=function(exports,require){var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("__vec3");var _bb_corners_cache=new Float32Array(3*8);var _vec3_tmp=new Float32Array(3);var _vec3_tmp2=new Float32Array(3);var _vec3_tmp3=new Float32Array(3);exports.copy_bb=function(bb_from,bb_to){bb_to.min_x=bb_from.min_x;bb_to.max_x=bb_from.max_x;bb_to.min_y=bb_from.min_y;bb_to.max_y=bb_from.max_y;bb_to.min_z=bb_from.min_z;bb_to.max_z=bb_from.max_z};exports.big_bounding_box=
function(){return{max_x:1E12,min_x:-1E12,max_y:1E12,min_y:-1E12,max_z:1E12,min_z:-1E12}};exports.zero_bounding_box=function(dest){if(!dest)dest={};dest.max_x=0;dest.min_x=0;dest.max_y=0;dest.min_y=0;dest.max_z=0;dest.min_z=0;return dest};exports.expand_bounding_box=function(bb,bb_exp){var max_x=bb.max_x;var max_y=bb.max_y;var max_z=bb.max_z;var min_x=bb.min_x;var min_y=bb.min_y;var min_z=bb.min_z;bb.max_x=Math.max(bb_exp.max_x,max_x);bb.max_y=Math.max(bb_exp.max_y,max_y);bb.max_z=Math.max(bb_exp.max_z,
max_z);bb.min_x=Math.min(bb_exp.min_x,min_x);bb.min_y=Math.min(bb_exp.min_y,min_y);bb.min_z=Math.min(bb_exp.min_z,min_z);return bb};exports.bb_from_coords=bb_from_coords;function bb_from_coords(coords,bb){var max_x=coords[0];var max_y=coords[1];var max_z=coords[2];var min_x=coords[0];var min_y=coords[1];var min_z=coords[2];for(var i=3;i<coords.length;i+=3){var x=coords[i];var y=coords[i+1];var z=coords[i+2];max_x=Math.max(max_x,x);max_y=Math.max(max_y,y);max_z=Math.max(max_z,z);min_x=Math.min(min_x,
x);min_y=Math.min(min_y,y);min_z=Math.min(min_z,z)}bb.max_x=max_x;bb.max_y=max_y;bb.max_z=max_z;bb.min_x=min_x;bb.min_y=min_y;bb.min_z=min_z;return bb}exports.bounding_box_transform=function(bb,matrix,bb_new){if(!bb_new)var bb_new=exports.zero_bounding_box();var bb_corners=extract_bb_corners(bb,_bb_corners_cache);m_util.positions_multiply_matrix(bb_corners,matrix,bb_corners);return bb_from_coords(bb_corners,bb_new)};exports.extract_bb_corners=extract_bb_corners;function extract_bb_corners(bb,dest){if(!dest)var dest=
new Float32Array(3*8);var max_x=bb.max_x;var max_y=bb.max_y;var max_z=bb.max_z;var min_x=bb.min_x;var min_y=bb.min_y;var min_z=bb.min_z;dest[0]=min_x;dest[1]=min_y;dest[2]=min_z;dest[3]=max_x;dest[4]=min_y;dest[5]=min_z;dest[6]=max_x;dest[7]=max_y;dest[8]=min_z;dest[9]=min_x;dest[10]=max_y;dest[11]=min_z;dest[12]=min_x;dest[13]=min_y;dest[14]=max_z;dest[15]=max_x;dest[16]=min_y;dest[17]=max_z;dest[18]=max_x;dest[19]=max_y;dest[20]=max_z;dest[21]=min_x;dest[22]=max_y;dest[23]=max_z;return dest}exports.shrink_bounding_box=
function(bb,bb_shrink,bb_new){if(!bb_new)var bb_new=exports.zero_bounding_box();var s_min_x=bb_shrink.min_x;var s_max_x=bb_shrink.max_x;var s_min_y=bb_shrink.min_y;var s_max_y=bb_shrink.max_y;var s_min_z=bb_shrink.min_z;var s_max_z=bb_shrink.max_z;if(s_min_x>=bb.max_x||s_max_x<=bb.min_x||s_min_y>=bb.max_y||s_max_y<=bb.min_y||s_min_z>=bb.max_z||s_max_z<=bb.min_z){bb_new.min_x=-.1;bb_new.max_x=.1;bb_new.min_y=-.1;bb_new.max_y=.1;bb_new.min_z=-.2;bb_new.max_z=-.1;return bb_new}bb_new.min_x=Math.max(bb.min_x,
s_min_x);bb_new.max_x=Math.min(bb.max_x,s_max_x);bb_new.min_y=Math.max(bb.min_y,s_min_y);bb_new.max_y=Math.min(bb.max_y,s_max_y);bb_new.min_z=Math.max(bb.min_z,s_min_z);bb_new.max_z=Math.min(bb.max_z,s_max_z);return bb_new};exports.stretch_bounding_box=function(bb,factor,bb_new){if(!bb_new)var bb_new=exports.zero_bounding_box();var size_x=bb.max_x-bb.min_x;var size_y=bb.max_y-bb.min_y;var size_z=bb.max_z-bb.min_z;bb_new.min_x=bb.min_x-.5*(factor-1)*size_x;bb_new.max_x=bb.max_x+.5*(factor-1)*size_x;
bb_new.min_y=bb.min_y-.5*(factor-1)*size_y;bb_new.max_y=bb.max_y+.5*(factor-1)*size_y;bb_new.min_z=bb.min_z-.5*(factor-1)*size_z;bb_new.max_z=bb.max_z+.5*(factor-1)*size_z;return bb_new};exports.bounding_sphere_transform=function(bs,matrix,bs_new){if(!bs_new)var bs_new=exports.zero_bounding_sphere();m_vec3.transformMat4(bs.center,matrix,bs_new.center);bs_new.radius=bs.radius*m_util.matrix_to_scale(matrix);return bs_new};exports.bounding_ellipsoid_transform=function(be,tsr,be_new){if(!be_new)var be_new=
zero_bounding_ellipsoid();m_tsr.transform_vec3(be.center,tsr,be_new.center);m_vec3.copy(be.axis_x,be_new.axis_x);m_vec3.copy(be.axis_y,be_new.axis_y);m_vec3.copy(be.axis_z,be_new.axis_z);m_tsr.transform_dir_vec3(be_new.axis_x,tsr,be_new.axis_x);m_tsr.transform_dir_vec3(be_new.axis_y,tsr,be_new.axis_y);m_tsr.transform_dir_vec3(be_new.axis_z,tsr,be_new.axis_z);return be_new};exports.create_bounding_sphere=function(radius,center){return{radius:radius,center:new Float32Array(center)}};exports.zero_bounding_sphere=
function(){return{center:new Float32Array([0,0,0]),radius:0}};function zero_bounding_ellipsoid(){return{axis_x:new Float32Array(3),axis_y:new Float32Array(3),axis_z:new Float32Array(3),center:new Float32Array([0,0,0])}}exports.create_bounding_ellipsoid=function(axis_x,axis_y,axis_z,center){return{axis_x:new Float32Array(axis_x),axis_y:new Float32Array(axis_y),axis_z:new Float32Array(axis_z),center:new Float32Array([center[0],center[1],center[2]])}};exports.big_bounding_sphere=function(){return{center:new Float32Array([0,
0,0]),radius:1E12}};exports.expand_bounding_sphere=function(bs,bs_exp){var v=m_vec3.subtract(bs_exp.center,bs.center,m_vec3.create());if(m_vec3.length(v)==0)m_vec3.set(1,0,0,v);var vn=m_vec3.normalize(v,m_vec3.create());var e1p=m_vec3.scale(vn,bs.radius,m_vec3.create());m_vec3.add(e1p,bs.center,e1p);var e1n=m_vec3.scale(vn,-bs.radius,m_vec3.create());m_vec3.add(e1n,bs.center,e1n);var e2p=m_vec3.scale(vn,bs_exp.radius,m_vec3.create());m_vec3.add(e2p,bs_exp.center,e2p);var e2n=m_vec3.scale(vn,-bs_exp.radius,
m_vec3.create());m_vec3.add(e2n,bs_exp.center,e2n);var min_max=find_min_max_extent([e1p,e1n,e2p,e2n],vn);var min=min_max[0];var max=min_max[1];bs.center=m_vec3.scale(m_vec3.add(min,max,m_vec3.create()),.5,m_vec3.create());bs.radius=m_vec3.length(m_vec3.subtract(max,min,m_vec3.create()))/2};function find_min_max_extent(exts,dir){var dir_n=m_vec3.normalize(dir,m_vec3.create());var min=exts[0];var max=exts[0];for(var i=1;i<exts.length;i++){var proj=m_vec3.dot(exts[i],dir_n);if(proj<m_vec3.dot(min,dir_n))min=
exts[i];if(proj>m_vec3.dot(max,dir_n))max=exts[i]}return[min,max]}exports.create_bounding_capsule=function(radius,bounding_box){var max_y=bounding_box.max_y;var min_y=bounding_box.min_y;var height=Math.max(0,max_y-min_y-2*radius);var bcap_local={radius:radius,height:height,center:new Float32Array([0,(max_y+min_y)/2,0])};return bcap_local};exports.create_bounding_cylinder=function(radius,bounding_box){var max_y=bounding_box.max_y;var min_y=bounding_box.min_y;var height=Math.max(0,max_y-min_y);var bcyl_local=
{radius:radius,height:height,center:new Float32Array([0,(max_y+min_y)/2,0])};return bcyl_local};exports.create_bounding_cone=function(radius,bounding_box){var max_y=bounding_box.max_y;var min_y=bounding_box.min_y;var height=Math.max(0,max_y-min_y);var bcon_local={radius:radius,height:height,center:new Float32Array([0,(max_y+min_y)/2,0])};return bcon_local};exports.check_bb_intersection=function(bb1,bb2){if(bb1.min_x>bb2.max_x||bb1.max_x<bb2.min_x)return false;else if(bb1.min_y>bb2.max_y||bb1.max_y<
bb2.min_y)return false;else if(bb1.min_z>bb2.max_z||bb1.max_z<bb2.min_z)return false;else return true};exports.recalculate_mesh_boundings=function(mesh){var max_x=0,max_y=0,max_z=0,min_x=0,min_y=0,min_z=0;var srad=0;var crad=0;for(var i=0;i<mesh["submeshes"].length;i++){var submesh=mesh["submeshes"][i];if(submesh["position"].length){max_x=min_x=submesh["position"][0];max_y=min_y=submesh["position"][1];max_z=min_z=submesh["position"][2];break}}for(var i=0;i<mesh["submeshes"].length;i++){var submesh=
mesh["submeshes"][i];var positions=submesh["position"];for(var j=0;j<positions.length/3;j++){var x=positions[3*j];var y=positions[3*j+1];var z=positions[3*j+2];max_x=Math.max(x,max_x);max_y=Math.max(y,max_y);max_z=Math.max(z,max_z);min_x=Math.min(x,min_x);min_y=Math.min(y,min_y);min_z=Math.min(z,min_z);srad=Math.max(Math.sqrt(x*x+y*y+z*z),srad);crad=Math.max(Math.sqrt(x*x+z*z),crad)}}mesh["b4w_bounding_box"]["max_x"]=max_x;mesh["b4w_bounding_box"]["min_x"]=min_x;mesh["b4w_bounding_box"]["max_y"]=
max_y;mesh["b4w_bounding_box"]["min_y"]=min_y;mesh["b4w_bounding_box"]["max_z"]=max_z;mesh["b4w_bounding_box"]["min_z"]=min_z;mesh["b4w_bounding_box_source"]["max_x"]=max_x;mesh["b4w_bounding_box_source"]["min_x"]=min_x;mesh["b4w_bounding_box_source"]["max_y"]=max_y;mesh["b4w_bounding_box_source"]["min_y"]=min_y;mesh["b4w_bounding_box_source"]["max_z"]=max_z;mesh["b4w_bounding_box_source"]["min_z"]=min_z;mesh["b4w_bounding_sphere_radius"]=srad;mesh["b4w_bounding_cylinder_radius"]=crad};exports.get_frustum_mec=
function(corners){var p0=corners.subarray(0,3);var p1=corners.subarray(6,9);var p2=corners.subarray(12,15);var p3=corners.subarray(18,21);var l=m_vec3.subtract(p1,p0,_vec3_tmp);m_vec3.normalize(l,l);var normal=m_util.get_plane_normal(p0,p1,p2,_vec3_tmp2);var m=m_vec3.cross(normal,l,normal);m_vec3.normalize(m,m);var q0=m_vec3.create();var q1=m_vec3.create();m_vec3.subtract(p1,p0,_vec3_tmp3);q1[0]=m_vec3.dot(_vec3_tmp3,l);q1[1]=m_vec3.dot(_vec3_tmp3,m);var q2=m_vec3.create();m_vec3.subtract(p2,p0,_vec3_tmp3);
q2[0]=m_vec3.dot(_vec3_tmp3,l);q2[1]=m_vec3.dot(_vec3_tmp3,m);var q3=m_vec3.create();m_vec3.subtract(p3,p0,_vec3_tmp3);q3[0]=m_vec3.dot(_vec3_tmp3,l);q3[1]=m_vec3.dot(_vec3_tmp3,m);var bs=exports.zero_bounding_sphere();bs=get_mec_2d([q0,q1,q2,q3],bs);var center_origin=m_vec3.scale(l,bs.center[0],_vec3_tmp3);m_vec3.scaleAndAdd(center_origin,m,bs.center[1],center_origin);m_vec3.add(center_origin,p0,bs.center);return bs};function get_mec_2d(points,bs){bs=mec_by_2_points(bs,points[0],points[1]);for(var i=
2;i<points.length;i++)if(m_vec3.distance(bs.center,points[i])>bs.radius)bs=mec_step1(bs,points,points[i],i-1);return bs}function mec_step1(bs,points,q,points_range){bs=mec_by_2_points(bs,q,points[0]);for(var i=1;i<=points_range;i++)if(m_vec3.distance(bs.center,points[i])>bs.radius)bs=mec_step2(bs,points,q,points[i],i-1);return bs}function mec_step2(bs,points,q0,q1,points_range){bs=mec_by_2_points(bs,q0,q1);for(var i=0;i<=points_range;i++)if(m_vec3.distance(bs.center,points[i])>bs.radius)bs=mec_by_3_points(bs,
q0,q1,points[i]);return bs}function mec_by_2_points(bs,A,B){m_vec3.add(A,B,bs.center);m_vec3.scale(bs.center,.5,bs.center);bs.radius=m_vec3.distance(bs.center,A);return bs}function mec_by_3_points(bs,A,B,C){var BC=m_vec3.subtract(B,C,_vec3_tmp3);var a_sq=m_vec3.squaredLength(BC);var AC=m_vec3.subtract(A,C,_vec3_tmp3);var b_sq=m_vec3.squaredLength(AC);var AB=m_vec3.subtract(A,B,_vec3_tmp3);var c_sq=m_vec3.squaredLength(AB);var a_coeff=a_sq*(b_sq+c_sq-a_sq);var b_coeff=b_sq*(c_sq+a_sq-b_sq);var c_coeff=
c_sq*(a_sq+b_sq-c_sq);var sum=a_coeff+b_coeff+c_coeff;m_vec3.copy(A,bs.center);m_vec3.scale(bs.center,a_coeff/sum,bs.center);m_vec3.scaleAndAdd(bs.center,B,b_coeff/sum,bs.center);m_vec3.scaleAndAdd(bs.center,C,c_coeff/sum,bs.center);bs.radius=m_vec3.distance(bs.center,A);return bs}};b4w.module["__compat"]=function(exports,require){var m_cfg=require("__config");var m_ext=require("__extensions");var m_print=require("__print");var m_util=require("__util");var MIN_VARYINGS_REQUIRED=10;var MIN_FRAGMENT_UNIFORMS_SUPPORTED=128;exports.detect_tegra_invalid_enum_issue=function(gl){if(gl.getError()==gl.INVALID_ENUM)m_print.warn("Possible Tegra invalid enum issue detected, ignoring")};exports.set_hardware_defaults=function(gl){var cfg_anim=m_cfg.animation;var cfg_def=m_cfg.defaults;var cfg_ctx=
m_cfg.context;var cfg_scs=m_cfg.scenes;var cfg_sfx=m_cfg.sfx;var cfg_phy=m_cfg.physics;cfg_def.max_vertex_uniform_vectors=gl.getParameter(gl.MAX_VERTEX_UNIFORM_VECTORS);cfg_def.max_texture_size=gl.getParameter(gl.MAX_TEXTURE_SIZE);cfg_def.max_cube_map_size=gl.getParameter(gl.MAX_CUBE_MAP_TEXTURE_SIZE);var depth_tex_available=Boolean(m_ext.get_depth_texture());if(check_user_agent("Firefox/28.0")&&(check_user_agent("Linux")||check_user_agent("Macintosh"))){m_print.warn("Firefox 28 detected, applying depth hack");
depth_tex_available=false}if(!check_user_agent("Windows Phone"))if(check_user_agent("iPad")||check_user_agent("iPhone")){m_print.warn("iOS detected, applying alpha hack, applying vertex "+"animation mix normals hack, applying ios depth hack and "+"disable smaa. Disable ssao for performance. Disable video "+"textures. Initialize WebAudio context with empty sound.");if(!cfg_ctx.alpha)cfg_def.background_color[3]=1;cfg_def.vert_anim_mix_normals_hack=true;cfg_def.smaa=false;cfg_def.ssao=false;cfg_def.precision=
"highp";cfg_def.init_wa_context_hack=true;cfg_def.ios_depth_hack=true}else if(check_user_agent("Mac OS X")&&check_user_agent("Safari")&&!check_user_agent("Chrome")){m_print.warn("OS X / Safari detected, force to wait complete loading. "+"Applying playback rate hack for video textures.");cfg_sfx.audio_loading_hack=true;cfg_sfx.clamp_playback_rate_hack=true}if(check_user_agent("Windows")&&(check_user_agent("Chrome/40")||check_user_agent("Firefox/33")||check_user_agent("Firefox/34")||check_user_agent("Firefox/35")||
check_user_agent("Firefox/36"))){m_print.warn("Windows/Chrome40 or Firefox33-36 detected. Applying clear procedural skydome hack.");cfg_def.clear_procedural_sky_hack=true}if(detect_mobile()){m_print.warn("Mobile detected, applying various hacks for video textures.");cfg_def.is_mobile_device=true;if(!(check_user_agent("iPad")||check_user_agent("iPhone"))&&!check_user_agent("Windows Phone")){m_print.warn("Mobile (not iOS) detected, disable playback rate for video textures.");cfg_sfx.disable_playback_rate_hack=
true}}if((check_user_agent("Firefox/35.0")||check_user_agent("Firefox/36.0"))&&check_user_agent("Windows")){m_print.warn("Windows/Firefox 35/36 detected, applying shadows slink hack");cfg_def.firefox_shadows_slink_hack=true}if(check_user_agent("iPhone")||is_ie11()||check_user_agent("Edge")){m_print.warn("iPhone, IE11 or Edge detected. Enable sequential video fallback for video textures.");cfg_def.seq_video_fallback=true}if(gl.getParameter(gl.MAX_VARYING_VECTORS)<MIN_VARYINGS_REQUIRED){m_print.warn("Not enough varyings, disable shadows on blend objects");
cfg_def.disable_blend_shadows_hack=true}if(check_user_agent("Windows Phone")){m_print.warn("Windows Phone detected. Disable wireframe mode, "+"glow materials, ssao, smaa, shadows, reflections, refractions.");cfg_def.wireframe_debug=false;cfg_def.precision="highp";cfg_def.glow_materials=false;cfg_def.ssao=false;cfg_def.smaa=false;cfg_def.shadows=false;cfg_def.reflections=false;cfg_def.refractions=false;cfg_def.quality_aa=false}if(check_user_agent("Firefox")&&cfg_def.is_mobile_device){m_print.warn("Mobile FireFox detected, applying depth hack");
cfg_phy.use_workers=false;depth_tex_available=false}var rinfo=m_ext.get_renderer_info();if(rinfo){if(check_user_agent("Macintosh")&&gl.getParameter(rinfo.UNMASKED_RENDERER_WEBGL).indexOf("Intel HD Graphics 3000")>-1){m_print.warn("OS X / Intel HD 3000 detected, applying depth hack");depth_tex_available=false}if(gl.getParameter(rinfo.UNMASKED_VENDOR_WEBGL).indexOf("ARM")>-1&&gl.getParameter(rinfo.UNMASKED_RENDERER_WEBGL).indexOf("Mali-400")>-1){m_print.warn("ARM Mali-400 detected, applying depth and frames blending hacks");
depth_tex_available=false;cfg_anim.frames_blending_hack=true}if(gl.getParameter(rinfo.UNMASKED_VENDOR_WEBGL).indexOf("ARM")>-1&&gl.getParameter(rinfo.UNMASKED_RENDERER_WEBGL).indexOf("Mali-T604")>-1){m_print.warn('ARM Mali-T604 detected, set "highp" precision and disable shadows.');cfg_def.precision="highp";cfg_def.shadows=false}if(gl.getParameter(rinfo.UNMASKED_VENDOR_WEBGL).indexOf("ARM")>-1&&gl.getParameter(rinfo.UNMASKED_RENDERER_WEBGL).indexOf("Mali-T760")>-1){m_print.warn('ARM Mali-T760 detected, set "highp" precision and disable SSAO.');
cfg_def.precision="highp";cfg_def.ssao=false}if(gl.getParameter(rinfo.UNMASKED_VENDOR_WEBGL).indexOf("Qualcomm")>-1&&gl.getParameter(rinfo.UNMASKED_RENDERER_WEBGL).indexOf("Adreno")>-1){m_print.warn("Qualcomm Adreno detected, applying shader constants hack.");cfg_def.shader_constants_hack=true;if(gl.getParameter(rinfo.UNMASKED_RENDERER_WEBGL).indexOf("305")>-1){m_print.warn('Qualcomm Adreno305 detected, set "highp" precision.');cfg_def.precision="highp"}if(gl.getParameter(rinfo.UNMASKED_RENDERER_WEBGL).indexOf("330")>
-1){m_print.warn('Qualcomm Adreno330 detected, set "highp" precision.');cfg_def.precision="highp"}}if(gl.getParameter(rinfo.UNMASKED_VENDOR_WEBGL).indexOf("NVIDIA")>-1&&gl.getParameter(rinfo.UNMASKED_RENDERER_WEBGL).indexOf("Tegra 3")>-1){m_print.warn("NVIDIA Tegra 3 detected, force low quality for "+"B4W_LEVELS_OF_QUALITY nodes.");cfg_def.force_low_quality_nodes=true}if(check_user_agent("Windows")&&check_user_agent("Chrome")&&!check_user_agent("Edge")&&gl.getParameter(rinfo.UNMASKED_RENDERER_WEBGL).match(/NVIDIA GeForce 8..0/)){m_print.warn("Chrome / Windows / NVIDIA GeForce 8000 series detected, "+
"setting max cubemap size to 256.");cfg_def.max_cube_map_size=256}}if(gl.getParameter(gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS)==0){m_print.warn("Vertex textures are not allowed. Disabling vertex textures");cfg_def.allow_vertex_textures=false}if(cfg_def.allow_hidpi&&window.devicePixelRatio>1){m_print.log("%cENABLE HIDPI MODE","color: #00a");cfg_def.render_resolution_factor=1;cfg_def.smaa=false}if(!depth_tex_available){cfg_def.foam=false;cfg_def.parallax=false;cfg_def.dynamic_grass=false;cfg_def.water_dynamic=
false;cfg_def.shore_smoothing=false;cfg_def.shore_distance=false;cfg_def.smaa=false}cfg_def.use_dds=Boolean(m_ext.get_s3tc());cfg_def.depth_tex_available=depth_tex_available;var high=gl.getShaderPrecisionFormat(gl.FRAGMENT_SHADER,gl.HIGH_FLOAT);var medium=gl.getShaderPrecisionFormat(gl.FRAGMENT_SHADER,gl.MEDIUM_FLOAT);if(high.precision===0)cfg_def.precision="mediump";if(is_ie11()){m_print.warn("IE11 detected. Set sky cubemap texture size to 512 (power of two).");cfg_scs.cubemap_tex_size=512}if(is_ie11()&&
check_user_agent("Touch")||check_user_agent("Edge")){m_print.warn("IE11 and touchscreen or Edge detected. Behaviour of the mouse move sensor will be changed.");cfg_def.ie11_edge_touchscreen_hack=true}if(gl.getParameter(gl.MAX_FRAGMENT_UNIFORM_VECTORS)<=MIN_FRAGMENT_UNIFORMS_SUPPORTED){m_print.warn("Not enough fragment uniforms, force low quality for "+"B4W_LEVELS_OF_QUALITY nodes.");cfg_def.force_low_quality_nodes=true}if(check_user_agent("Chrome")&&!check_user_agent("Edge")){m_print.log("Chrome detected. Some of deprecated functions related to the Doppler effect won't be called.");
cfg_def.cors_chrome_hack=true}if(check_user_agent("Chrome")&&!check_user_agent("Edge")||check_user_agent("Firefox"))cfg_def.disable_doppler_hack=true;if(is_ie11()||check_user_agent("iPad")){m_print.warn("iPad or Internet Explorer detected. Applying alpha clip hack.");cfg_def.alpha_clip_filtering_hack=true}if(detect_mobile()&&check_user_agent("Firefox")){m_print.log("Mobile firefox detected. Applying autoplay media hack.");cfg_def.mobile_firefox_media_hack=true}if(check_user_agent("Edge")){m_print.warn("Microsoft Edge detected, set up new minimal texture size.");
cfg_def.edge_min_tex_size_hack=true}};function check_user_agent(str){var user_agent=navigator.userAgent;if(user_agent.indexOf(str)>-1)return true;else return false}exports.detect_mobile=detect_mobile;function detect_mobile(){return navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i)}
exports.apply_context_alpha_hack=function(){if(check_user_agent("Firefox/35.0")&&check_user_agent("Windows")){m_print.warn("Windows/Firefox 35 detected, forcing context's alpha");m_cfg.context.alpha=true}};exports.is_ie11=is_ie11;function is_ie11(){return!window.ActiveXObject&&"ActiveXObject"in window}};b4w.module["__constraints"]=function(exports,require){var m_cam=require("__camera");var m_mat3=require("__mat3");var m_quat=require("__quat");var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("__vec3");var m_armat=require("__armature");var CONS_TYPE_STIFF_OBJ=1;var CONS_TYPE_STIFF_BONE=2;var CONS_TYPE_TRACK_OBJ=3;var CONS_TYPE_TRACK_POINT=4;var CONS_TYPE_FOLLOW_OBJ=5;var CONS_TYPE_FOLLOW_POINT=6;var CONS_TYPE_STIFF_TRANS_OBJ=7;var CONS_TYPE_COPY_TRANS_OBJ=8;var CONS_TYPE_SEMI_STIFF_OBJ=
9;var CONS_TYPE_SEMI_STIFF_CAM_OBJ=10;var CONS_TYPE_CHILD_OF=11;var CONS_TYPE_CHILD_OF_BONE=12;var CONS_TYPE_SEMI_SOFT_CAM_OBJ=13;var CONS_TYPE_STIFF_TRANS_ROT_OBJ=14;var CONS_TYPE_STIFF_VIEWPORT=15;var BONE_CONS_TYPE_STIFF_OBJ=1;exports.CONS_TYPE_STIFF_OBJ=CONS_TYPE_STIFF_OBJ;exports.CONS_TYPE_STIFF_BONE=CONS_TYPE_STIFF_BONE;exports.CONS_TYPE_TRACK_OBJ=CONS_TYPE_TRACK_OBJ;exports.CONS_TYPE_TRACK_POINT=CONS_TYPE_TRACK_POINT;exports.CONS_TYPE_FOLLOW_OBJ=CONS_TYPE_FOLLOW_OBJ;exports.CONS_TYPE_FOLLOW_POINT=
CONS_TYPE_FOLLOW_POINT;exports.CONS_TYPE_STIFF_TRANS_OBJ=CONS_TYPE_STIFF_TRANS_OBJ;exports.CONS_TYPE_COPY_TRANS_OBJ=CONS_TYPE_COPY_TRANS_OBJ;exports.CONS_TYPE_SEMI_STIFF_OBJ=CONS_TYPE_SEMI_STIFF_OBJ;exports.CONS_TYPE_SEMI_STIFF_CAM_OBJ=CONS_TYPE_SEMI_STIFF_CAM_OBJ;exports.CONS_TYPE_CHILD_OF=CONS_TYPE_CHILD_OF;exports.CONS_TYPE_CHILD_OF_BONE=CONS_TYPE_CHILD_OF_BONE;exports.CONS_TYPE_SEMI_SOFT_CAM_OBJ=CONS_TYPE_SEMI_SOFT_CAM_OBJ;exports.CONS_TYPE_STIFF_TRANS_ROT_OBJ=CONS_TYPE_STIFF_TRANS_ROT_OBJ;exports.CONS_TYPE_STIFF_VIEWPORT=
CONS_TYPE_STIFF_VIEWPORT;exports.BONE_CONS_TYPE_STIFF_OBJ=BONE_CONS_TYPE_STIFF_OBJ;var _vec2_tmp=new Float32Array(2);var _vec2_tmp_2=new Float32Array(2);var _vec3_tmp=new Float32Array(3);var _vec3_tmp_2=new Float32Array(3);var _vec3_tmp_3=new Float32Array(3);var _vec4_tmp=new Float32Array(4);var _quat4_tmp=new Float32Array(4);var _mat3_tmp=new Float32Array(9);var _mat3_tmp2=new Float32Array(9);var _tsr8_tmp=new Float32Array(8);var _parent_y_axis=new Float32Array(3);exports.append_stiff_obj=function(obj,
obj_parent,offset,rotation_offset,scale_offset){var cons=init_cons(CONS_TYPE_STIFF_OBJ);cons.obj_parent=obj_parent;cons.offset=new Float32Array(offset);cons.rotation_offset=rotation_offset?new Float32Array(rotation_offset):null;cons.scale_offset=scale_offset;apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_stiff_bone=function(obj,armobj,bone_name,offset,rotation_offset,scale_offset){var cons=init_cons(CONS_TYPE_STIFF_BONE);cons.obj_parent=armobj;cons.bone_name=bone_name;cons.offset=new Float32Array(offset);
cons.rotation_offset=rotation_offset?new Float32Array(rotation_offset):null;cons.scale_offset=scale_offset;apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_semi_stiff_obj=function(obj,obj_parent,offset,rotation_offset){var cons=init_cons(CONS_TYPE_SEMI_STIFF_OBJ);var quat=obj.render.quat;var p_quat=obj_parent.render.quat;cons.obj_parent=obj_parent;cons.offset=new Float32Array(offset);cons.parent_prev_rotation=new Float32Array(p_quat);if(rotation_offset){m_quat.copy(rotation_offset,quat);
m_quat.multiply(p_quat,quat,quat)}apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_semi_stiff_cam_obj=function(obj,obj_parent,offset,rotation_offset,clamp_left,clamp_right,clamp_up,clamp_down){var cons=init_cons(CONS_TYPE_SEMI_STIFF_CAM_OBJ);var quat=obj.render.quat;var p_quat=obj_parent.render.quat;cons.obj_parent=obj_parent;cons.offset=new Float32Array(offset);cons.parent_prev_rotation=new Float32Array(p_quat);cons.clamp_left=m_util.angle_wrap_0_2pi(clamp_left);cons.clamp_right=m_util.angle_wrap_0_2pi(clamp_right);
cons.clamp_up=m_util.angle_wrap_periodic(clamp_up,-Math.PI,Math.PI);cons.clamp_down=m_util.angle_wrap_periodic(clamp_down,-Math.PI,Math.PI);if(rotation_offset){cons.rotation_offset=new Float32Array(rotation_offset);m_quat.copy(rotation_offset,quat);m_quat.multiply(p_quat,quat,quat)}else cons.rotation_offset=m_quat.create();apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_semi_soft_cam_obj=function(obj,obj_parent,offset,softness){var cons=init_cons(CONS_TYPE_SEMI_SOFT_CAM_OBJ);cons.obj_parent=
obj_parent;cons.offset=new Float32Array(offset);cons.softness=softness;apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_stiff_trans_rot_obj=function(obj,obj_parent,offset,rotation_offset,scale_offset){var cons=init_cons(CONS_TYPE_STIFF_TRANS_ROT_OBJ);cons.obj_parent=obj_parent;cons.offset=new Float32Array(offset);cons.scale_offset=scale_offset||1;cons.rotation_offset=rotation_offset?new Float32Array(rotation_offset):null;apply_cons(obj,cons);update_cons(obj,cons,0)};function init_cons(type){var cons=
{};cons.type=type;return cons}function apply_cons(obj,cons){if(obj.constraint&&obj.constraint.obj_parent)remove_parent_descendant(obj.constraint.obj_parent,obj);if(cons.obj_parent)assign_parent_descendant(cons.obj_parent,obj);obj.constraint=cons}function assign_parent_descendant(obj_parent,obj){if(obj_parent.cons_descends.indexOf(obj)==-1)obj_parent.cons_descends.push(obj);else throw"Descendant object override is forbidden";}exports.remove_parent_descendant=remove_parent_descendant;function remove_parent_descendant(obj_parent,
obj){var ind=obj_parent.cons_descends.indexOf(obj);if(ind!=-1)obj_parent.cons_descends.splice(ind,1);else throw"No descendant object";}exports.append_track_obj=function(obj,obj_parent){var cons=init_cons(CONS_TYPE_TRACK_OBJ);cons.obj_parent=obj_parent;apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_track_point=function(obj,target){var cons=init_cons(CONS_TYPE_TRACK_POINT);cons.target=new Float32Array(target);apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_follow_obj=function(obj,
obj_parent,dist_min,dist_max){var cons=init_cons(CONS_TYPE_FOLLOW_OBJ);cons.obj_parent=obj_parent;cons.dist_min=dist_min;cons.dist_max=dist_max;apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_follow_point=function(obj,target,dist_min,dist_max){var cons=init_cons(CONS_TYPE_FOLLOW_POINT);cons.target=new Float32Array(target);cons.dist_min=dist_min;cons.dist_max=dist_max;apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_stiff_trans_obj=function(obj,obj_parent,offset){var cons=
init_cons(CONS_TYPE_STIFF_TRANS_OBJ);cons.obj_parent=obj_parent;cons.offset=new Float32Array(offset);apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_copy_trans_obj=function(obj,obj_parent,offset){var cons=init_cons(CONS_TYPE_COPY_TRANS_OBJ);cons.obj_parent=obj_parent;cons.offset=new Float32Array(offset);apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_child_of=function(obj,obj_parent,tsr_offset){var cons=init_cons(CONS_TYPE_CHILD_OF);cons.obj_parent=obj_parent;cons.tsr_offset=
new Float32Array(tsr_offset);apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_child_of_bone=function(obj,armobj,bone_name,tsr_offset){var cons=init_cons(CONS_TYPE_CHILD_OF_BONE);cons.obj_parent=armobj;cons.bone_name=bone_name;cons.tsr_offset=new Float32Array(tsr_offset);apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_stiff_viewport=function(obj,camobj,positioning){var cons=init_cons(CONS_TYPE_STIFF_VIEWPORT);cons.obj_parent=camobj;if("left"in positioning){cons.left_edge=true;
cons.left_right_dist=positioning["left"]}else if("right"in positioning){cons.left_edge=false;cons.left_right_dist=positioning["right"]}else{m_print.error("append_stiff_viewport: Wrong positioning params");return}if("top"in positioning){cons.top_edge=true;cons.top_bottom_dist=positioning["top"]}else if("bottom"in positioning){cons.top_edge=false;cons.top_bottom_dist=positioning["bottom"]}else{m_print.error("append_stiff_viewport: Wrong positioning params");return}if("distance"in positioning)cons.distance=
positioning["distance"];else{m_print.error("append_stiff_viewport: Wrong positioning params");return}if("rotation"in positioning)cons.rotation_offset=new Float32Array(positioning["rotation"]);else cons.rotation_offset=null;apply_cons(obj,cons);update_cons(obj,cons,0)};exports.update_constraint=function(obj,elapsed){if(obj.constraint)update_cons(obj,obj.constraint,elapsed)};function update_cons(obj,cons,elapsed){switch(cons.type){case CONS_TYPE_STIFF_OBJ:var quat=obj.render.quat;var p_world_matrix=
cons.obj_parent.render.world_matrix;var p_quat=cons.obj_parent.render.quat;if(cons.rotation_offset){m_quat.copy(cons.rotation_offset,quat);m_quat.multiply(p_quat,quat,quat)}else m_quat.copy(p_quat,quat);m_vec3.transformMat4(cons.offset,p_world_matrix,obj.render.trans);obj.render.scale=cons.scale_offset*cons.obj_parent.render.scale;break;case CONS_TYPE_SEMI_STIFF_OBJ:var trans=obj.render.trans;var quat=obj.render.quat;var p_world_matrix=cons.obj_parent.render.world_matrix;var p_quat=cons.obj_parent.render.quat;
m_quat.multiply(m_quat.invert(cons.parent_prev_rotation,cons.parent_prev_rotation),quat,quat);m_quat.multiply(p_quat,quat,quat);m_vec3.transformMat4(cons.offset,p_world_matrix,trans);m_quat.copy(p_quat,cons.parent_prev_rotation);break;case CONS_TYPE_SEMI_STIFF_CAM_OBJ:var trans=obj.render.trans;var quat=obj.render.quat;var p_world_matrix=cons.obj_parent.render.world_matrix;var p_quat=cons.obj_parent.render.quat;m_quat.multiply(m_quat.invert(cons.parent_prev_rotation,cons.parent_prev_rotation),quat,
quat);m_quat.multiply(p_quat,quat,quat);m_vec3.transformMat4(cons.offset,p_world_matrix,trans);m_quat.copy(p_quat,cons.parent_prev_rotation);clamp_orientation(obj,cons);break;case CONS_TYPE_SEMI_SOFT_CAM_OBJ:var trans=obj.render.trans;var quat=obj.render.quat;var p_world_matrix=cons.obj_parent.render.world_matrix;var p_trans=cons.obj_parent.render.trans;var softness=cons.softness;var trans_pivot=_vec3_tmp;var quat_pivot=_quat4_tmp;var softness_ratio=.16;m_vec3.transformMat4(cons.offset,p_world_matrix,
trans_pivot);m_util.smooth_v(trans_pivot,trans,elapsed,softness,trans);var dir_to_obj=_vec3_tmp;m_vec3.sub(p_trans,trans,dir_to_obj);m_vec3.normalize(dir_to_obj,dir_to_obj);cam_rotate_to(quat,dir_to_obj,quat_pivot);m_util.smooth_q(quat_pivot,quat,elapsed,softness*softness_ratio,quat);break;case CONS_TYPE_STIFF_BONE:var quat=obj.render.quat;var p_tsr=_tsr8_tmp;m_armat.get_bone_tsr(cons.obj_parent,cons.bone_name,true,false,p_tsr);m_tsr.multiply(cons.obj_parent.render.tsr,p_tsr,p_tsr);quat[0]=p_tsr[4];
quat[1]=p_tsr[5];quat[2]=p_tsr[6];quat[3]=p_tsr[7];if(cons.rotation_offset){m_quat.copy(cons.rotation_offset,quat);m_quat.multiply(quat,cons.rotation_offset,quat)}obj.render.scale=cons.scale_offset*p_tsr[3];m_tsr.transform_vec3(cons.offset,p_tsr,obj.render.trans);break;case CONS_TYPE_TRACK_OBJ:var trans=obj.render.trans;var quat=obj.render.quat;var t_trans=cons.obj_parent.render.trans;rotate_to(trans,quat,t_trans);break;case CONS_TYPE_TRACK_POINT:var trans=obj.render.trans;var quat=obj.render.quat;
var t_trans=cons.target;rotate_to(trans,quat,t_trans);break;case CONS_TYPE_FOLLOW_OBJ:var trans=obj.render.trans;var quat=obj.render.quat;var t_trans=cons.obj_parent.render.trans;rotate_to(trans,quat,t_trans);var dist=m_vec3.dist(trans,t_trans);if(dist>cons.dist_max)var delta=dist-cons.dist_max;else if(dist<cons.dist_min)var delta=dist-cons.dist_min;else var delta=0;if(delta){m_vec3.sub(t_trans,trans,_vec3_tmp);m_vec3.normalize(_vec3_tmp,_vec3_tmp);m_vec3.scale(_vec3_tmp,delta,_vec3_tmp);m_vec3.add(trans,
_vec3_tmp,trans)}break;case CONS_TYPE_FOLLOW_POINT:var trans=obj.render.trans;var quat=obj.render.quat;var t_trans=cons.target;rotate_to(trans,quat,t_trans);var dist=m_vec3.dist(trans,t_trans);if(dist>cons.dist_max)var delta=dist-cons.dist_max;else if(dist<cons.dist_min)var delta=dist-cons.dist_min;else var delta=0;if(delta){m_vec3.sub(t_trans,trans,_vec3_tmp);m_vec3.normalize(_vec3_tmp,_vec3_tmp);m_vec3.scale(_vec3_tmp,delta,_vec3_tmp);m_vec3.add(trans,_vec3_tmp,trans)}break;case CONS_TYPE_STIFF_TRANS_OBJ:var p_world_matrix=
cons.obj_parent.render.world_matrix;m_vec3.transformMat4(cons.offset,p_world_matrix,obj.render.trans);break;case CONS_TYPE_COPY_TRANS_OBJ:var p_trans=cons.obj_parent.render.trans;var trans=obj.render.trans;m_vec3.add(p_trans,cons.offset,trans);break;case CONS_TYPE_STIFF_TRANS_ROT_OBJ:var quat=obj.render.quat;var p_world_matrix=cons.obj_parent.render.world_matrix;var p_quat=cons.obj_parent.render.quat;if(cons.rotation_offset){m_quat.copy(cons.rotation_offset,quat);m_quat.multiply(p_quat,quat,quat)}else m_quat.copy(p_quat,
quat);m_vec3.transformMat4(cons.offset,p_world_matrix,obj.render.trans);break;case CONS_TYPE_CHILD_OF:var prender=cons.obj_parent.render;var ptsr=m_tsr.create_sep(prender.trans,prender.scale,prender.quat,_tsr8_tmp);var tsr_offset=cons.tsr_offset;m_tsr.multiply(ptsr,tsr_offset,ptsr);var trans=obj.render.trans;trans[0]=ptsr[0];trans[1]=ptsr[1];trans[2]=ptsr[2];obj.render.scale=ptsr[3];var quat=obj.render.quat;quat[0]=ptsr[4];quat[1]=ptsr[5];quat[2]=ptsr[6];quat[3]=ptsr[7];break;case CONS_TYPE_CHILD_OF_BONE:var tsr_offset=
cons.tsr_offset;var p_tsr=_tsr8_tmp;m_armat.get_bone_tsr(cons.obj_parent,cons.bone_name,true,false,p_tsr);m_tsr.multiply(cons.obj_parent.render.tsr,p_tsr,p_tsr);m_tsr.multiply(p_tsr,tsr_offset,p_tsr);var trans=obj.render.trans;trans[0]=p_tsr[0];trans[1]=p_tsr[1];trans[2]=p_tsr[2];obj.render.scale=p_tsr[3];var quat=obj.render.quat;quat[0]=p_tsr[4];quat[1]=p_tsr[5];quat[2]=p_tsr[6];quat[3]=p_tsr[7];break;case CONS_TYPE_STIFF_VIEWPORT:var camobj=cons.obj_parent;var cam=m_cam.get_first_cam(camobj);var trans=
obj.render.trans;var top=m_cam.get_edge(cam,"TOP");var bottom=m_cam.get_edge(cam,"BOTTOM");var height=top-bottom;if(cons.left_edge){var left=m_cam.get_edge(cam,"LEFT");trans[0]=left+height*cons.left_right_dist}else{var right=m_cam.get_edge(cam,"RIGHT");trans[0]=right-height*cons.left_right_dist}if(cons.top_edge)trans[2]=-(top-height*cons.top_bottom_dist);else trans[2]=-(bottom+height*cons.top_bottom_dist);if(m_cam.is_ortho(cam))trans[1]=-cons.distance;else{trans[1]=-1;m_vec3.normalize(trans,trans);
var scale=cons.distance/Math.abs(trans[1]);m_vec3.scale(trans,scale,trans)}m_tsr.transform_dir_vec3(trans,camobj.render.tsr,trans);m_vec3.add(camobj.render.trans,trans,trans);var quat=obj.render.quat;if(cons.rotation_offset){m_quat.copy(cons.rotation_offset,quat);m_quat.multiply(camobj.render.quat,quat,quat)}else m_quat.copy(camobj.render.quat,quat);break;default:break}if(obj.render.type=="CAMERA"){var corr_axis=m_util.AXIS_Y;if(cons.type==CONS_TYPE_SEMI_STIFF_CAM_OBJ){var p_quat=cons.obj_parent.render.quat;
corr_axis=m_vec3.transformQuat(corr_axis,p_quat,_parent_y_axis)}m_cam.update_camera_upside_down(obj);correct_up(obj,corr_axis)}}exports.append_stiff_bone_to_obj=function(armobj,obj,bone_name,offset,rotation_offset,scale_offset){var cons=init_cons(BONE_CONS_TYPE_STIFF_OBJ);var bone_pointer=armobj.render.bone_pointers[bone_name];cons.bone_name=bone_name;cons.target=obj;cons.offset=new Float32Array(offset);cons.rotation_offset=rotation_offset?new Float32Array(rotation_offset):null;cons.scale_offset=
scale_offset;apply_bone_cons(armobj,cons);update_bone_cons(armobj,cons)};function apply_bone_cons(armobj,cons){var target=cons.target;var bone_name=cons.bone_name;var bone_pointer=armobj.render.bone_pointers[bone_name];remove_arm_bone_descendant(target,armobj,bone_name);target.cons_armat_bone_descends.push([armobj,bone_name]);bone_pointer.constraint=cons}function remove_arm_bone_descendant(obj,armobj,bone_name){var cons_armat_bone_descends=obj.cons_armat_bone_descends;for(var i=0;i<cons_armat_bone_descends;i++){var cons_desc=
cons_armat_bone_descends[i];if(cons_desc[0]==armobj&&cons_desc[1]==bone_name){cons_armat_bone_descends.splice(i,1);return}}}exports.update_bone_constraint=function(armobj,bone_name){var bone_pointer=armobj.render.bone_pointers[bone_name];if(bone_pointer.constraint)update_bone_cons(armobj,bone_pointer.constraint)};function update_bone_cons(armobj,cons){switch(cons.type){case BONE_CONS_TYPE_STIFF_OBJ:var target_obj=cons.target;var target_tsr=target_obj.render.tsr;var armobj_tsr=armobj.render.tsr;var b_tsr=
_tsr8_tmp;m_tsr.invert(armobj_tsr,b_tsr);m_tsr.multiply(b_tsr,target_tsr,b_tsr);m_armat.set_bone_tsr(armobj,cons.bone_name,b_tsr,false);break;default:break}armobj.need_update_transform=true}function clamp_orientation(obj,cons){var quat=obj.render.quat;var p_quat=cons.obj_parent.render.quat;var quat_base=m_quat.multiply(p_quat,cons.rotation_offset,_quat4_tmp);var base_angles=m_cam.get_camera_angles_from_quat(quat_base,_vec2_tmp);var curr_angles=m_cam.get_camera_angles_from_quat(quat,_vec2_tmp_2);var d_phi=
m_util.calc_returning_angle(curr_angles[0],base_angles[0]+cons.clamp_right,base_angles[0]+cons.clamp_left);var d_theta=m_util.calc_returning_angle(curr_angles[1],base_angles[1]+cons.clamp_down,base_angles[1]+cons.clamp_up);m_cam.rotate_eye_camera(obj,d_phi,d_theta)}exports.rotate_to=rotate_to;function rotate_to(trans,quat,target){var dir_from=_vec3_tmp;m_util.quat_to_dir(quat,m_util.AXIS_MY,dir_from);m_vec3.normalize(dir_from,dir_from);var dir_to=_vec3_tmp_2;m_vec3.subtract(target,trans,dir_to);m_vec3.normalize(dir_to,
dir_to);var rotation=m_util.rotation_to_stable(dir_from,dir_to,_vec4_tmp);m_quat.multiply(rotation,quat,quat);m_quat.normalize(quat,quat)}function cam_rotate_to(quat,dir,dest){var mat_dst=_mat3_tmp;var x_cam_world=mat_dst.subarray(0,3);var y_cam_world=mat_dst.subarray(3,6);var z_cam_world=mat_dst.subarray(6,9);m_vec3.copy(dir,y_cam_world);m_vec3.negate(y_cam_world,y_cam_world);m_vec3.normalize(y_cam_world,y_cam_world);var up_down=Boolean(Math.abs(m_vec3.dot(dir,m_util.AXIS_Y))>.999999);if(up_down){var mat_src=
m_mat3.fromQuat(m_quat.normalize(quat,dest),_mat3_tmp2);m_vec3.copy(mat_src.subarray(0,3),x_cam_world)}else m_vec3.cross(m_util.AXIS_Y,y_cam_world,x_cam_world);m_vec3.normalize(x_cam_world,x_cam_world);m_vec3.cross(x_cam_world,y_cam_world,z_cam_world);m_vec3.normalize(z_cam_world,z_cam_world);m_quat.fromMat3(mat_dst,dest);m_quat.normalize(dest,dest)}exports.correct_up=correct_up;function correct_up(camobj,y_axis){var render=camobj.render;var quat=render.quat;var y_world=y_axis;var y_cam_world=m_util.quat_to_dir(render.quat,
m_util.AXIS_Y,_vec3_tmp);m_vec3.normalize(y_cam_world,y_cam_world);if(Math.abs(m_vec3.dot(y_world,y_cam_world))>.999999)var rotation=m_quat.identity(_quat4_tmp);else{var x_cam_world_new=m_vec3.cross(y_world,y_cam_world,_vec3_tmp_2);m_vec3.normalize(x_cam_world_new,x_cam_world_new);if(render.move_style==m_cam.MS_TARGET_CONTROLS){if(render.target_cam_upside_down)m_vec3.negate(x_cam_world_new,x_cam_world_new)}else{var z_cam_world=m_util.quat_to_dir(render.quat,m_util.AXIS_Z,_vec3_tmp_3);if(m_vec3.dot(z_cam_world,
y_axis)>0)m_vec3.negate(x_cam_world_new,x_cam_world_new)}var x_cam_world=m_util.quat_to_dir(render.quat,m_util.AXIS_X,_vec3_tmp_3);m_vec3.normalize(x_cam_world,x_cam_world);var cosine=m_util.clamp(m_vec3.dot(x_cam_world,x_cam_world_new),-1,1);var angle=Math.acos(cosine);if(cosine<=-.999999)var rotation=m_quat.setAxisAngle(y_cam_world,angle,_quat4_tmp);else var rotation=m_quat.rotationTo(x_cam_world,x_cam_world_new,_quat4_tmp);m_quat.normalize(rotation,rotation)}m_quat.multiply(rotation,quat,quat);
m_cam.update_camera_upside_down(camobj)}exports.check_constraint=function(obj){if(obj.constraint)return true;else return false};exports.remove=function(obj){if(obj.constraint.obj_parent)remove_parent_descendant(obj.constraint.obj_parent,obj);obj.constraint=null};exports.get_type=function(obj){if(obj.constraint)return obj.constraint.type;else return null};exports.has_child_of=function(obj){var cons=obj.constraint;if(cons&&(cons.type==CONS_TYPE_CHILD_OF||cons.type==CONS_TYPE_CHILD_OF_BONE))return true;
else return false};exports.get_child_of_parent_tsr=function(obj){var cons=obj.constraint;if(cons&&cons.type==CONS_TYPE_CHILD_OF)return cons.obj_parent.render.tsr;else if(cons&&cons.type==CONS_TYPE_CHILD_OF_BONE){var p_tsr=_tsr8_tmp;m_armat.get_bone_tsr(cons.obj_parent,cons.bone_name,true,false,p_tsr);m_tsr.multiply(cons.obj_parent.render.tsr,p_tsr,p_tsr);return p_tsr}else return null};exports.get_child_of_offset=function(obj){var cons=obj.constraint;if(cons&&(cons.type==CONS_TYPE_CHILD_OF||cons.type==
CONS_TYPE_CHILD_OF_BONE))return cons.tsr_offset;else return null}};b4w.module["__container"]=function(exports,require){var m_print=require("__print");var m_util=require("__util");var _canvas=null;var _canvas_cont=null;var _offsets_updating_needed=false;var _viewport_layout={width:0,height:0,scale:1,offset_top:0,offset_left:0};exports.get_canvas=function(){return _canvas};exports.get_container=function(){return _canvas_cont};exports.init=function(canvas){if(canvas&&canvas.parentNode){_canvas=canvas;_canvas_cont=canvas.parentNode}else m_util.panic("canvas container is not available")};
exports.insert_to_container=function(elem,stack_order){stack_order=stack_order||"LAST";switch(stack_order){case "FIRST":var cont_first_child=_canvas_cont.firstElementChild;_canvas_cont.insertBefore(elem,cont_first_child);break;case "JUST_BEFORE_CANVAS":_canvas_cont.insertBefore(elem,_canvas);break;case "JUST_AFTER_CANVAS":if(_canvas.nextElementSibling)_canvas_cont.insertBefore(elem,_canvas.nextElementSibling);else _canvas_cont.appendChild(elem,_canvas);break;case "LAST":_canvas_cont.appendChild(elem,
_canvas);break;default:m_print.error(stack_order+" invalid stack order");break}};exports.get_viewport_width=function(){return _viewport_layout.width};exports.get_viewport_height=function(){return _viewport_layout.height};exports.set_canvas_offsets=set_canvas_offsets;function set_canvas_offsets(left,top){_viewport_layout.offset_left=left;_viewport_layout.offset_top=top}exports.update_canvas_offsets=update_canvas_offsets;function update_canvas_offsets(){var boundaries=_canvas.getBoundingClientRect();
set_canvas_offsets(boundaries.left,boundaries.top)}exports.setup_viewport_dim=function(width,height,scale){_viewport_layout.width=width;_viewport_layout.height=height;_viewport_layout.scale=scale;update_canvas_offsets()};exports.force_offsets_updating=function(){_offsets_updating_needed=true};function get_offset_top(){if(_offsets_updating_needed){update_canvas_offsets();_offsets_updating_needed=false}return _viewport_layout.offset_top}function get_offset_left(){if(_offsets_updating_needed){update_canvas_offsets();
_offsets_updating_needed=false}return _viewport_layout.offset_left}exports.client_to_canvas_coords=function(client_x,client_y,dest){if(!dest)dest=new Float32Array(2);dest[0]=client_x-get_offset_left();dest[1]=client_y-get_offset_top();return dest};exports.canvas_to_viewport_coords=function(canvas_x,canvas_y,dest,camera){if(!dest)dest=new Float32Array(2);dest[0]=canvas_x*_viewport_layout.scale;dest[1]=canvas_y*_viewport_layout.scale;if(camera){var camera_resolution_scale=camera.width/_viewport_layout.width;
dest[0]*=camera_resolution_scale;dest[1]*=camera_resolution_scale}return dest};exports.viewport_to_canvas_coords=function(viewport_x,viewport_y,dest,camera){if(!dest)dest=new Float32Array(2);dest[0]=viewport_x/_viewport_layout.scale;dest[1]=viewport_y/_viewport_layout.scale;if(camera){var camera_resolution_scale=camera.width/_viewport_layout.width;dest[0]/=camera_resolution_scale;dest[1]/=camera_resolution_scale}return dest};exports.is_child=function(elem){if(!elem||!elem.parentNode)return false;
else if(elem.parentNode==_canvas_cont)return true;else return exports.is_child(elem.parentNode)};exports.find_script=function(src){var scripts=document.getElementsByTagName("script");var norm_src=m_util.normpath_preserve_protocol(src);for(var i=0;i<scripts.length;i++)if(scripts[i].src==norm_src)return scripts[i];return null}};b4w.module["__controls"]=function(exports,require){var m_cfg=require("__config");var m_cont=require("__container");var m_obj=require("__objects");var m_print=require("__print");var m_phy=require("__physics");var m_quat=require("__quat");var m_time=require("__time");var m_util=require("__util");var m_vec3=require("__vec3");var cfg_ctl=m_cfg.controls;var cfg_dft=m_cfg.defaults;var _objects=[];var _sensors=[];var _global_object={};var _wheel_delta=0;var _mouse_curr_x=0;var _mouse_curr_y=0;var _mouse_last_x=
0;var _mouse_last_y=0;var _is_mouse_downed=false;var _touches_curr_x=new Float32Array(2);var _touches_curr_y=new Float32Array(2);var _touches_last_x=new Float32Array(2);var _touches_last_y=new Float32Array(2);var _vec2_tmp=new Float32Array(2);var _vec2_tmp2=new Float32Array(2);var _touch_zoom_curr_dist=0;var _touch_zoom_last_dist=0;var _manifolds_updated=false;var _update_counter=0;var _prev_def_keyboard_events=false;var _prev_def_mouse_events=false;var _prev_def_wheel_events=false;var _prev_def_touch_events=
false;var _allow_element_mouse_event=false;var _callback_keyboard_events=null;var _callback_mouse_events=null;var _callback_wheel_events=null;var _callback_touch_events=null;var ST_CUSTOM=10;var ST_KEYBOARD=20;var ST_MOUSE_WHEEL=30;var ST_MOUSE_MOVE=40;var ST_MOUSE_CLICK=50;var ST_TOUCH_MOVE=60;var ST_TOUCH_ZOOM=70;var ST_COLLISION=80;var ST_COLLISION_IMPULSE=90;var ST_RAY=100;var ST_MOTION=110;var ST_V_VELOCITY=120;var ST_TIMER=130;var ST_ELAPSED=140;var ST_TIMELINE=150;var ST_SELECTION=160;var ST_GYRO_DELTA=
170;var ST_GYRO_ANGLES=180;exports.CT_CONTINUOUS=10;exports.CT_TRIGGER=20;exports.CT_SHOT=30;exports.CT_LEVEL=40;exports.CT_CHANGE=50;exports.PL_SINGLE_TOUCH_MOVE=0;exports.PL_MULTITOUCH_MOVE_ZOOM=1;exports.PL_MULTITOUCH_MOVE_PAN=2;var SENSOR_SMOOTH_PERIOD=.3;var KEY_SHIFT=16;exports.update=function(timeline,elapsed){for(var i=0;i<_sensors.length;i++){var sensor=_sensors[i];update_sensor(sensor,timeline,elapsed)}for(var i=0;i<_objects.length;i++){var obj=_objects[i];var manifolds_arr=obj.sensor_manifolds_arr;
for(var j=0;j<manifolds_arr.length;j++){var manifold=manifolds_arr[j];if(manifold.update_counter==_update_counter)continue;manifold.update_counter=_update_counter;var pulse=manifold_gen_pulse(manifold);if(pulse){var cb_obj=obj==_global_object?null:obj;_manifolds_updated=false;manifold.callback(cb_obj,manifold.id,pulse,manifold.callback_param);if(_manifolds_updated){i=-1;break}}}}for(var i=0;i<_objects.length;i++){var obj=_objects[i];var manifolds_arr=obj.sensor_manifolds_arr;for(var j=0;j<manifolds_arr.length;j++){var manifold=
manifolds_arr[j];discharge_sensors(manifold.sensors)}}_wheel_delta=0;_mouse_last_x=_mouse_curr_x;_mouse_last_y=_mouse_curr_y;_touches_last_x.set(_touches_curr_x);_touches_last_y.set(_touches_curr_y);_touch_zoom_last_dist=_touch_zoom_curr_dist;_update_counter++};exports.create_custom_sensor=function(value){var sensor=init_sensor(ST_CUSTOM);sensor_set_value(sensor,value);return sensor};function init_sensor(type){var sensor={type:type,value:0,payload:null,do_activation:false,key:0,collision_id:"",calc_pos_norm:false,
collision_obj:null,collision_cb:function(){},col_imp_obj:null,col_imp_cb:function(){},source_object:null,from:new Float32Array(3),to:new Float32Array(3),is_binary_value:false,ign_src_rot:false,ray_test_id:0,ray_test_cb:function(){},axis:"",time_last:0,trans_last:new Float32Array(3),quat_last:new Float32Array(4),threshold:0,quat_temp:new Float32Array(4),avg_linear_vel:0,avg_angular_vel:0,rotation_threshold:0,avg_vertical_vel:0,period:0,repeat:false,auto_release:false,gyro_gamma_new:0,gyro_beta_new:0,
gyro_alpha_new:0,gyro_gamma_last:0,gyro_beta_last:0,gyro_alpha_last:0};return sensor}exports.create_keyboard_sensor=function(key){var sensor=init_sensor(ST_KEYBOARD);sensor.key=key;return sensor};exports.create_collision_sensor=function(obj,collision_id,calc_pos_norm){if(!(obj&&m_phy.obj_has_physics(obj))){m_print.error("Wrong collision object");return null}var sensor=init_sensor(ST_COLLISION);sensor.collision_obj=obj;sensor.collision_id=collision_id;sensor.calc_pos_norm=calc_pos_norm;sensor.payload=
{coll_obj:null,coll_pos:calc_pos_norm?new Float32Array(3):null,coll_norm:calc_pos_norm?new Float32Array(3):null,coll_dist:0};sensor.collision_cb=function(is_collision,coll_obj,coll_pos,coll_norm,coll_dist){sensor_set_value(sensor,is_collision);var payload=sensor.payload;payload.coll_obj=coll_obj;if(sensor.calc_pos_norm){payload.coll_pos.set(coll_pos);payload.coll_norm.set(coll_norm);payload.coll_dist=coll_dist}};sensor.do_activation=true;return sensor};exports.create_collision_impulse_sensor=function(obj){if(!(obj&&
obj.physics)){m_print.error("Wrong collision impulse object");return null}var sensor=init_sensor(ST_COLLISION_IMPULSE);sensor.col_imp_obj=obj;sensor.col_imp_cb=function(impulse){sensor_set_value(sensor,impulse)};sensor.do_activation=true;return sensor};exports.create_ray_sensor=function(obj_src,from,to,collision_id,is_binary_value,calc_pos_norm,ign_src_rot){var sensor=init_sensor(ST_RAY);sensor.source_object=obj_src;sensor.from=from;sensor.to=to;sensor.collision_id=collision_id;sensor.is_binary_value=
is_binary_value;sensor.calc_pos_norm=calc_pos_norm;sensor.ign_src_rot=ign_src_rot;sensor.payload={hit_fract:0,obj_hit:null,hit_time:0,hit_pos:new Float32Array(3),hit_norm:new Float32Array(3)};sensor.ray_test_cb=function(id,hit_fract,obj_hit,hit_time,hit_pos,hit_norm){if(sensor.is_binary_value)sensor_set_value(sensor,hit_fract==-1?0:1);else sensor_set_value(sensor,hit_fract);sensor.payload.hit_fract=hit_fract;sensor.payload.obj_hit=obj_hit;sensor.payload.hit_time=hit_time;if(sensor.calc_pos_norm){sensor.payload.hit_pos.set(hit_pos);
sensor.payload.hit_norm.set(hit_norm)}};sensor.do_activation=true;return sensor};exports.create_mouse_click_sensor=function(){var sensor=init_sensor(ST_MOUSE_CLICK);return sensor};exports.create_mouse_wheel_sensor=function(){var sensor=init_sensor(ST_MOUSE_WHEEL);return sensor};exports.create_mouse_move_sensor=function(axis){var sensor=init_sensor(ST_MOUSE_MOVE);sensor.axis=axis||"XY";sensor.payload=sensor.axis=="XY"?new Float32Array(2):0;return sensor};exports.create_touch_move_sensor=function(axis){var sensor=
init_sensor(ST_TOUCH_MOVE);sensor.axis=axis||"XY";sensor.payload=0;return sensor};exports.create_touch_zoom_sensor=function(){var sensor=init_sensor(ST_TOUCH_ZOOM);sensor.payload=0;return sensor};exports.create_motion_sensor=function(obj,threshold,rotation_threshold){if(!obj){m_print.error("Wrong collision object");return null}var sensor=init_sensor(ST_MOTION);sensor.source_object=obj;var trans=obj.render.trans;var quat=obj.render.quat;sensor.quat_temp=new Float32Array(4);sensor.trans_last=new Float32Array(trans);
sensor.quat_last=new Float32Array(quat);sensor.avg_linear_vel=0;sensor.avg_angular_vel=0;sensor.threshold=threshold||.1;sensor.rotation_threshold=rotation_threshold||.1;sensor.time_last=0;sensor.payload=new Float32Array([0,0]);return sensor};exports.create_vertical_velocity_sensor=function(obj,threshold){if(!obj){m_print.error("Wrong collision object");return null}var sensor=init_sensor(ST_V_VELOCITY);sensor.source_object=obj;var trans=obj.render.trans;var quat=obj.render.quat;sensor.trans_last=new Float32Array(trans);
sensor.quat_last=new Float32Array(quat);sensor.avg_vertical_vel=0;sensor.threshold=threshold||1;sensor.time_last=0;sensor.payload=0;return sensor};exports.create_timer_sensor=function(period,do_repeat){var sensor=init_sensor(ST_TIMER);sensor.period=period;sensor.repeat=do_repeat;sensor.do_activation=true;return sensor};exports.reset_timer_sensor=function(obj,manifold_id,num,period){obj=obj||_global_object;var manifolds=obj.sensor_manifolds;if(!manifolds||!manifolds[manifold_id]){m_print.error("reset_timer_sensor(): wrong object");
return null}var sensor=manifolds[manifold_id].sensors[num];if(!sensor){m_print.error("reset_timer_sensor(): sensor not found");return null}sensor.time_last=m_time.get_timeline();sensor.period=period};exports.create_elapsed_sensor=function(){var sensor=init_sensor(ST_ELAPSED);sensor.time_last=0;return sensor};exports.create_gyro_delta_sensor=function(){var sensor=init_sensor(ST_GYRO_DELTA);sensor.payload=new Float32Array(3);return sensor};exports.create_gyro_angles_sensor=function(){var sensor=init_sensor(ST_GYRO_ANGLES);
sensor.payload=new Float32Array(3);return sensor};exports.create_timeline_sensor=function(){var sensor=init_sensor(ST_TIMELINE);return sensor};exports.create_selection_sensor=function(obj,auto_release){var sensor=init_sensor(ST_SELECTION);sensor.source_object=obj;sensor.auto_release=auto_release;return sensor};exports.sensor_set_value=sensor_set_value;function sensor_set_value(sensor,value){sensor.value=Number(value)}function manifold_logic_result(manifold){var sensors=manifold.sensors;var values=
manifold.sensor_values;for(var i=0;i<sensors.length;i++)values[i]=sensors[i].value;var logic_result=manifold.logic_fun(values);return logic_result}exports.get_sensor_value=function(obj,manifold_id,num){obj=obj||_global_object;var manifolds=obj.sensor_manifolds;if(!manifolds||!manifolds[manifold_id]){m_print.error("get_sensor_value(): wrong object");return null}var sensor=manifolds[manifold_id].sensors[num];if(!sensor){m_print.error("get_sensor_value(): sensor not found");return null}return sensor.value};
exports.get_sensor_payload=function(obj,manifold_id,num){obj=obj||_global_object;var manifolds=obj.sensor_manifolds;if(!manifolds||!manifolds[manifold_id]){m_print.error("get_sensor_payload(): wrong object");return null}var sensor=manifolds[manifold_id].sensors[num];if(!sensor){m_print.error("get_sensor_payload(): sensor not found");return null}return sensor.payload};function update_sensor(sensor,timeline,elapsed){if(!elapsed)return;switch(sensor.type){case ST_MOTION:var obj=sensor.source_object;
var trans=obj.render.trans;var quat=obj.render.quat;var dist=m_vec3.dist(sensor.trans_last,trans);var quat_temp=sensor.quat_temp;m_quat.invert(sensor.quat_last,quat_temp);m_quat.multiply(quat,quat_temp,quat_temp);m_quat.normalize(quat_temp,quat_temp);var angle=Math.abs(2*Math.acos(quat_temp[3]));var linear_vel=dist/elapsed;sensor.avg_linear_vel=m_util.smooth(linear_vel,sensor.avg_linear_vel,elapsed,SENSOR_SMOOTH_PERIOD);sensor.payload[0]=linear_vel;var angular_vel=angle/elapsed;sensor.avg_angular_vel=
m_util.smooth(angular_vel,sensor.avg_angular_vel,elapsed,SENSOR_SMOOTH_PERIOD);sensor.payload[1]=angular_vel;if(sensor.avg_linear_vel>=sensor.threshold||sensor.avg_angular_vel>=sensor.rotation_threshold)sensor_set_value(sensor,1);else sensor_set_value(sensor,0);m_vec3.copy(trans,sensor.trans_last);m_quat.copy(quat,sensor.quat_last);sensor.time_last=timeline;break;case ST_V_VELOCITY:var obj=sensor.source_object;var trans=obj.render.trans;var vel=Math.abs(trans[1]-sensor.trans_last[1])/elapsed;sensor.avg_vertical_vel=
m_util.smooth(vel,sensor.avg_vertical_vel,elapsed,SENSOR_SMOOTH_PERIOD);sensor.payload=vel;if(sensor.avg_vertical_vel>=sensor.threshold)sensor_set_value(sensor,1);else sensor_set_value(sensor,0);m_vec3.copy(trans,sensor.trans_last);sensor.time_last=timeline;break;case ST_TIMER:if(!sensor.do_activation&&sensor.period>=0&&timeline-sensor.time_last>=sensor.period){sensor_set_value(sensor,1);if(sensor.repeat)sensor.time_last=timeline;else sensor.period=-sensor.period}break;case ST_ELAPSED:if(!sensor.time_last)sensor.time_last=
timeline;sensor_set_value(sensor,timeline-sensor.time_last);sensor.time_last=timeline;break;case ST_TIMELINE:sensor_set_value(sensor,timeline);break;case ST_GYRO_DELTA:sensor.payload[0]=Math.PI*(sensor.gyro_gamma_new-sensor.gyro_gamma_last)/180;sensor.payload[1]=Math.PI*(sensor.gyro_beta_new-sensor.gyro_beta_last)/180;sensor.payload[2]=Math.PI*(sensor.gyro_alpha_new-sensor.gyro_alpha_last)/180;sensor.gyro_gamma_last=sensor.gyro_gamma_new;sensor.gyro_beta_last=sensor.gyro_beta_new;sensor.gyro_alpha_last=
sensor.gyro_alpha_new;break;case ST_GYRO_ANGLES:sensor.payload[0]=Math.PI*sensor.gyro_gamma_new/180;sensor.payload[1]=Math.PI*sensor.gyro_beta_new/180;sensor.payload[2]=Math.PI*sensor.gyro_alpha_new/180;break;default:break}}function manifold_gen_pulse(manifold){var pulse=0;switch(manifold.type){case exports.CT_CONTINUOUS:var last_pulse=manifold.last_pulse;var logic_result=manifold_logic_result(manifold);if(logic_result){pulse=1;manifold.last_pulse=1}else if(last_pulse==1){pulse=-1;manifold.last_pulse=
-1}else pulse=0;break;case exports.CT_TRIGGER:var last_pulse=manifold.last_pulse;var logic_result=manifold_logic_result(manifold);if(logic_result&&last_pulse==-1){pulse=1;manifold.last_pulse=1}else if(!logic_result&&last_pulse==1){pulse=-1;manifold.last_pulse=-1}else pulse=0;break;case exports.CT_SHOT:var last_pulse=manifold.last_pulse;var logic_result=manifold_logic_result(manifold);if(logic_result&&last_pulse==-1){pulse=1;manifold.last_pulse=1}else if(!logic_result&&last_pulse==1){pulse=0;manifold.last_pulse=
-1}else pulse=0;break;case exports.CT_LEVEL:var logic_result=manifold_logic_result(manifold);if(manifold.last_logic_result!=logic_result){pulse=1;manifold.last_logic_result=logic_result}else pulse=0;break;case exports.CT_CHANGE:var sensors=manifold.sensors;var last_values=manifold.last_sensor_values;for(var i=0;i<sensors.length;i++){var value=sensors[i].value;if(!pulse&&value!=last_values[i])pulse=1;last_values[i]=value}break;default:m_util.panic("Wrong sensor manifold type: "+manifold.type);break}return pulse}
function manifold_get_value(manifold,logic_result){if(logic_result)var value=manifold.sensors[0].value;else var value=0;return value}function discharge_sensors(sensors){for(var i=0;i<sensors.length;i++){var sensor=sensors[i];switch(sensor.type){case ST_MOUSE_WHEEL:sensor_set_value(sensor,0);break;case ST_MOUSE_MOVE:sensor_set_value(sensor,0);break;case ST_TOUCH_MOVE:sensor_set_value(sensor,0);break;case ST_TOUCH_ZOOM:sensor_set_value(sensor,0);break;case ST_TIMER:sensor_set_value(sensor,0);break;
default:break}}}exports.cleanup=function(){_objects=[];_sensors=[];_global_object={}};exports.check_sensor_manifold=function(obj,id){obj=obj||_global_object;if(!obj.sensor_manifolds)return false;if(id&&obj.sensor_manifolds[id])return true;else if(id)return false;else for(var i in obj.sensor_manifolds)return true;return false};exports.remove_sensor_manifold=function(obj,id){obj=obj||_global_object;var manifolds=obj.sensor_manifolds;if(!manifolds)return;var manifolds_arr=obj.sensor_manifolds_arr;if(id){var manifold=
manifolds[id];if(manifold){var sensors=manifold.sensors;for(var j=0;j<sensors.length;j++)if(get_sensor_users_num(sensors[j],_objects)===1)remove_sensor(sensors[j],_sensors);delete manifolds[id];var man_index=manifolds_arr.indexOf(manifold);if(man_index>-1)manifolds_arr.splice(man_index,1);else m_util.panic("Incorrect manifolds array");if(!Object.getOwnPropertyNames(manifolds).length)remove_from_objects(obj)}return}for(var id in manifolds){var manifold=manifolds[id];var sensors=manifold.sensors;for(var j=
0;j<sensors.length;j++)if(get_sensor_users_num(sensors[j],_objects)===1)remove_sensor(sensors[j],_sensors);delete manifolds[id];var man_index=manifolds_arr.indexOf(manifold);if(man_index>-1)manifolds_arr.splice(man_index,1);else m_util.panic("Incorrect manifolds array")}remove_from_objects(obj);_manifolds_updated=true};function remove_from_objects(obj){var obj_index=_objects.indexOf(obj);if(obj_index>-1)_objects.splice(obj_index,1);else{m_print.error("Wrong object");return}}function get_sensor_users_num(sensor,
objects){var users=0;for(var i=0;i<objects.length;i++){var obj=objects[i];var manifolds_arr=obj.sensor_manifolds_arr;for(var j=0;j<manifolds_arr.length;j++){var manifold=manifolds_arr[j];var sensors=manifold.sensors;for(var k=0;k<sensors.length;k++)if(sensors[k]===sensor)users++}}return users}function remove_sensor(sensor,sensors){switch(sensor.type){case ST_COLLISION:m_phy.remove_collision_test(sensor.collision_obj,sensor.collision_id,sensor.collision_cb);sensor.do_activation=true;break;case ST_COLLISION_IMPULSE:m_phy.clear_collision_impulse_test(sensor.col_imp_obj);
sensor.do_activation=true;break;case ST_RAY:m_phy.remove_ray_test(sensor.ray_test_id);sensor.do_activation=true;break;case ST_TIMER:sensor.do_activation=true;break}var sens_index=sensors.indexOf(sensor);if(sens_index>-1)sensors.splice(sens_index,1)}exports.create_sensor_manifold=function(obj,id,type,sensors,logic_fun,callback,callback_param){obj=obj||_global_object;obj.sensor_manifolds_arr=obj.sensor_manifolds_arr||[];obj.sensor_manifolds=obj.sensor_manifolds||{};var manifolds=obj.sensor_manifolds;
var manifolds_arr=obj.sensor_manifolds_arr;var old_manifold=manifolds[id];if(old_manifold){var sensors=old_manifold.sensors;for(var i=0;i<sensors.length;i++)if(get_sensor_users_num(sensors[i],_objects)===1)remove_sensor(sensors[i],_sensors);var man_index=manifolds_arr.indexOf(old_manifold);if(man_index>-1)manifolds_arr.splice(man_index,1);else m_util.panic("Incorrect manifolds array")}var manifold={id:id,type:type,sensors:sensors.slice(0),logic_fun:logic_fun,sensor_values:new Array(sensors.length),
callback:callback,callback_param:callback_param,last_pulse:-1,last_logic_result:0,last_sensor_values:new Array(sensors.length),update_counter:-1};manifolds[id]=manifold;manifolds_arr.push(manifold);if(_objects.indexOf(obj)==-1)_objects.push(obj);append_sensors(manifold.sensors);_manifolds_updated=true};exports.default_AND_logic_fun=default_AND_logic_fun;function default_AND_logic_fun(s){for(var i=0;i<s.length;i++)if(!s[i])return s[i];return s[s.length-1]}exports.default_OR_logic_fun=function(s){for(var i=
0;i<s.length;i++)if(s[i])return s[i];return s[s.length-1]};function append_sensors(sensors){for(var i=0;i<sensors.length;i++){var sensor=sensors[i];if(sensor.do_activation){switch(sensor.type){case ST_COLLISION:m_phy.append_collision_test(sensor.collision_obj,sensor.collision_id,sensor.collision_cb,sensor.calc_pos_norm);break;case ST_COLLISION_IMPULSE:m_phy.apply_collision_impulse_test(sensor.col_imp_obj,sensor.col_imp_cb);break;case ST_RAY:sensor.ray_test_id=m_phy.append_ray_test(sensor.source_object,
sensor.from,sensor.to,sensor.collision_id,sensor.ray_test_cb,false,false,sensor.calc_pos_norm,sensor.ign_src_rot);break;case ST_TIMER:sensor.time_last=m_time.get_timeline();if(sensor.period<0)sensor.period=-sensor.period;break}sensor.do_activation=false}if(_sensors.indexOf(sensor)==-1)_sensors.push(sensor)}}exports.reset=function(){for(var i=0;i<_objects.length;i++){var obj=_objects[i];var manifolds=obj.sensor_manifolds;var manifolds_arr=obj.sensor_manifolds_arr;for(var j in manifolds)delete manifolds[j];
manifolds_arr.splice(0,manifolds_arr.length)}for(var i=0;i<_sensors.length;i++){remove_sensor(_sensors[i],_sensors);i--}_objects.splice(0,_objects.length)};exports.debug=function(){m_print.log(String(_objects.length)+" objects with manifolds",_objects);m_print.log(String(_sensors.length)+" sensors",_sensors);var collisions=[];var rays=[];for(var i=0;i<_sensors.length;i++){var sensor=_sensors[i];if(sensor.type==ST_COLLISION)collisions.push(sensor);if(sensor.type==ST_RAY)rays.push(sensor)}m_print.log(String(collisions.length)+
" collision sensors",collisions);m_print.log(String(rays.length)+" ray sensors",rays)};function keydown_cb(e){for(var i=0;i<_sensors.length;i++){var sensor=_sensors[i];if(sensor.type==ST_KEYBOARD&&e.keyCode==sensor.key)sensor_set_value(sensor,1)}if(_prev_def_keyboard_events)e.preventDefault();if(_callback_keyboard_events)_callback_keyboard_events(e)}function keyup_cb(e){for(var i=0;i<_sensors.length;i++){var sensor=_sensors[i];if(sensor.type==ST_KEYBOARD&&e.keyCode==0&&sensor.key==KEY_SHIFT)sensor_set_value(sensor,
0);if(sensor.type==ST_KEYBOARD&&e.keyCode==sensor.key)sensor_set_value(sensor,0)}if(_prev_def_keyboard_events)e.preventDefault();if(_callback_keyboard_events)_callback_keyboard_events(e)}function mouse_down_cb(e){var pick=false;var selected_obj=null;_is_mouse_downed=true;_mouse_last_x=e.clientX;_mouse_last_y=e.clientY;_mouse_curr_x=e.clientX;_mouse_curr_y=e.clientY;for(var i=0;i<_sensors.length;i++){var sensor=_sensors[i];if(sensor.type==ST_MOUSE_CLICK){sensor_set_value(sensor,1);sensor.payload=e.which}if(sensor.type==
ST_SELECTION){if(!pick){var canvas_xy=m_cont.client_to_canvas_coords(e.clientX,e.clientY,_vec2_tmp);selected_obj=m_obj.pick_object(canvas_xy[0],canvas_xy[1]);pick=true}if(selected_obj==sensor.source_object)sensor.value=1;else sensor.value=0}}if(_prev_def_mouse_events)e.preventDefault();if(_callback_mouse_events)_callback_mouse_events(e)}function mouse_up_cb(e){for(var i=0;i<_sensors.length;i++){var sensor=_sensors[i];if(sensor.type==ST_MOUSE_CLICK)sensor_set_value(sensor,0);if(sensor.type==ST_SELECTION&&
sensor.auto_release)sensor.value=0}_is_mouse_downed=false;if(_prev_def_mouse_events&&!_allow_element_mouse_event)e.preventDefault();if(_callback_mouse_events)_callback_mouse_events(e)}function mouse_move_cb(e){var x=e.clientX;var y=e.clientY;_mouse_curr_x=x;_mouse_curr_y=y;if(!cfg_dft.ie11_edge_touchscreen_hack||_is_mouse_downed){var delta_x=x-_mouse_last_x;var delta_y=y-_mouse_last_y;var delta=Math.sqrt(delta_x*delta_x+delta_y*delta_y);for(var i=0;i<_sensors.length;i++){var sensor=_sensors[i];if(sensor.type===
ST_MOUSE_MOVE)switch(sensor.axis){case "X":sensor_set_value(sensor,delta_x);sensor.payload=x;break;case "Y":sensor_set_value(sensor,delta_y);sensor.payload=y;break;case "XY":sensor_set_value(sensor,delta);sensor.payload[0]=x;sensor.payload[1]=y;break}}}if(_prev_def_mouse_events&&!_allow_element_mouse_event)e.preventDefault();if(_callback_mouse_events)_callback_mouse_events(e)}function mouse_out_cb(e){if(!m_cont.is_child(e.relatedTarget))mouse_up_cb(e)}function mouse_wheel_cb(e){var wd=e.wheelDelta||
-40*e.detail;wd*=cfg_ctl.mouse_wheel_notch_multiplier;_wheel_delta+=wd;for(var i=0;i<_sensors.length;i++){var sensor=_sensors[i];if(sensor.type===ST_MOUSE_WHEEL)sensor_set_value(sensor,_wheel_delta)}if(_prev_def_wheel_events)e.preventDefault();if(_callback_wheel_events)_callback_wheel_events(e)}function touch_start_cb(e){var touches=e.targetTouches;if(touches.length==1){var touch=touches[0];var x=touch.clientX;var y=touch.clientY;var pick=false;var selected_obj=null;for(var i=0;i<_sensors.length;i++){var sensor=
_sensors[i];if(sensor.type==ST_SELECTION){if(!pick){var canvas_xy=m_cont.client_to_canvas_coords(x,y,_vec2_tmp);selected_obj=m_obj.pick_object(canvas_xy[0],canvas_xy[1]);pick=true}sensor.value=selected_obj==sensor.source_object}}_touches_last_x[0]=x;_touches_last_x[1]=-1;_touches_last_y[0]=y;_touches_last_y[1]=-1}else if(touches.length>1){var zoom_dist=touch_zoom_dist(touches);_touch_zoom_curr_dist=_touch_zoom_last_dist=zoom_dist;_touches_last_x[0]=touches[0].clientX;_touches_last_x[1]=touches[1].clientX;
_touches_last_y[0]=touches[0].clientY;_touches_last_y[1]=touches[1].clientY}_touches_curr_x.set(_touches_last_x);_touches_curr_y.set(_touches_last_y);if(_callback_touch_events)_callback_touch_events(e)}function touch_move_cb(e){var touches=e.targetTouches;if(touches.length===0)return;if(touches.length===1){_touches_curr_x[0]=touches[0].clientX;_touches_curr_x[1]=-1;_touches_curr_y[0]=touches[0].clientY;_touches_curr_y[1]=-1;var delta_x=_touches_curr_x[0]-_touches_last_x[0];var delta_y=_touches_curr_y[0]-
_touches_last_y[0];var delta=Math.sqrt(delta_x*delta_x+delta_y*delta_y);if(_touches_last_x[1]!=-1&&_touches_last_y[1]!=-1){var delta_second_x=_touches_curr_x[0]-_touches_last_x[1];var delta_second_y=_touches_curr_y[0]-_touches_last_y[1];var delta_second=Math.sqrt(delta_second_x*delta_second_x+delta_second_y*delta_second_y);if(delta_second<delta){delta_x=delta_second_x;delta_y=delta_second_y;delta=delta_second}}for(var i=0;i<_sensors.length;i++){var sensor=_sensors[i];if(sensor.type===ST_TOUCH_MOVE){sensor.payload=
exports.PL_SINGLE_TOUCH_MOVE;switch(sensor.axis){case "X":sensor_set_value(sensor,delta_x);break;case "Y":sensor_set_value(sensor,delta_y);break;case "XY":sensor_set_value(sensor,delta);break}}}}else if(touches.length>1){_touches_curr_x[0]=touches[0].clientX;_touches_curr_x[1]=touches[1].clientX;_touches_curr_y[0]=touches[0].clientY;_touches_curr_y[1]=touches[1].clientY;var zoom_dist=touch_zoom_dist(touches);_touch_zoom_curr_dist=zoom_dist;var delta_dist=_touch_zoom_curr_dist-_touch_zoom_last_dist;
var cur_center=_vec2_tmp;cur_center[0]=(_touches_curr_x[0]+_touches_curr_x[1])/2;cur_center[1]=(_touches_curr_y[0]+_touches_curr_y[1])/2;var last_center=_vec2_tmp2;last_center[0]=(_touches_last_x[0]+_touches_last_x[1])/2;last_center[1]=(_touches_last_y[0]+_touches_last_y[1])/2;var delta_centers=touch_center_dist(cur_center,last_center);for(var i=0;i<_sensors.length;i++){var sensor=_sensors[i];if(sensor.type===ST_TOUCH_ZOOM&&Math.abs(delta_centers)<Math.abs(delta_dist)){sensor.payload=exports.PL_MULTITOUCH_MOVE_ZOOM;
sensor_set_value(sensor,delta_dist)}if(sensor.type===ST_TOUCH_MOVE&&Math.abs(delta_centers)>Math.abs(delta_dist)){sensor.payload=exports.PL_MULTITOUCH_MOVE_PAN;switch(sensor.axis){case "X":var delta_x=cur_center[0]-last_center[0];sensor_set_value(sensor,delta_x);break;case "Y":var delta_y=cur_center[1]-last_center[1];sensor_set_value(sensor,delta_y);break;case "XY":sensor_set_value(sensor,delta_centers);break}}}}if(_prev_def_touch_events)e.preventDefault();if(_callback_touch_events)_callback_touch_events(e)}
function touch_end_cb(e){var touches=e.targetTouches;if(touches.length==1)for(var i=0;i<_sensors.length;i++){var sensor=_sensors[i];if(sensor.type==ST_SELECTION&&sensor.auto_release)sensor_set_value(sensor,0)}if(_callback_touch_events)_callback_touch_events(e)}function orient_handler_cb(e){for(var i=0;i<_sensors.length;i++){var sensor=_sensors[i];if(sensor.type==ST_GYRO_DELTA||sensor.type==ST_GYRO_ANGLES){sensor.gyro_beta_new=e.beta;sensor.gyro_gamma_new=e.gamma;sensor.gyro_alpha_new=e.alpha;if(!sensor.value){sensor.gyro_gamma_last=
e.gamma;sensor.gyro_beta_last=e.beta;sensor.gyro_alpha_last=e.alpha;sensor_set_value(sensor,1)}}}}function touch_center_dist(first,second){var x1=first[0];var y1=first[1];var x2=second[0];var y2=second[1];var center_dist=Math.sqrt((x1-x2)*(x1-x2)+(y1-y2)*(y1-y2));return center_dist}function touch_zoom_dist(touches){var touch1=touches[0];var touch2=touches[1];var x1=touch1.clientX;var y1=touch1.clientY;var x2=touch2.clientX;var y2=touch2.clientY;var zoom_dist=Math.sqrt((x1-x2)*(x1-x2)+(y1-y2)*(y1-
y2));return zoom_dist}exports.register_keyboard_events=function(element,prevent_default){element.addEventListener("keydown",keydown_cb,false);element.addEventListener("keyup",keyup_cb,false);_prev_def_keyboard_events=prevent_default};exports.register_mouse_events=function(element,prevent_default,allow_element_exit){if(allow_element_exit)var replace_elem=window;else{var replace_elem=element;replace_elem.addEventListener("mouseout",mouse_out_cb,false)}element.addEventListener("mousedown",mouse_down_cb,
false);replace_elem.addEventListener("mousemove",mouse_move_cb,false);replace_elem.addEventListener("mouseup",mouse_up_cb,false);_prev_def_mouse_events=prevent_default;_allow_element_mouse_event=allow_element_exit};exports.register_wheel_events=function(element,prevent_default){element.addEventListener("mousewheel",mouse_wheel_cb,false);element.addEventListener("DOMMouseScroll",mouse_wheel_cb,false);_prev_def_wheel_events=prevent_default};exports.register_touch_events=function(element,prevent_default){element.addEventListener("touchstart",
touch_start_cb,false);element.addEventListener("touchmove",touch_move_cb,false);document.addEventListener("touchstart",function(){});_prev_def_touch_events=prevent_default};exports.register_device_orientation=function(){if(window.DeviceOrientationEvent&&cfg_dft.gyro_use)window.addEventListener("deviceorientation",orient_handler_cb,false)};exports.unregister_keyboard_events=function(element){element.removeEventListener("keydown",keydown_cb,false);element.removeEventListener("keyup",keyup_cb,false)};
exports.unregister_mouse_events=function(element){element.removeEventListener("mousedown",mouse_down_cb,false);element.removeEventListener("mousemove",mouse_move_cb,false);element.removeEventListener("mouseout",mouse_out_cb,false);element.removeEventListener("mouseup",mouse_up_cb,false)};exports.unregister_wheel_events=function(element){element.removeEventListener("mousewheel",mouse_wheel_cb,false);element.removeEventListener("DOMMouseScroll",mouse_wheel_cb,false)};exports.unregister_touch_events=
function(element){element.removeEventListener("touchstart",touch_start_cb,false);element.removeEventListener("touchmove",touch_move_cb,false);document.removeEventListener("touchstart",function(){})};exports.unregister_device_orientation=function(){if(window.DeviceOrientationEvent&&cfg_dft.gyro_use)window.removeEventListener("deviceorientation",orient_handler_cb,false)};exports.assign_keyboard_callback=function(cb){_callback_keyboard_events=cb};exports.assign_mouse_callback=function(cb){_callback_mouse_events=
cb};exports.assign_wheel_callback=function(cb){_callback_wheel_events=cb};exports.assign_touch_callback=function(cb){_callback_touch_events=cb}};b4w.module["__curve"]=function(exports,require){var m_print=require("__print");var m_util=require("__util");var SPLINE_POINTS=1E3;exports.create_spline=function(bpy_obj){var spline={};var bpy_curve=bpy_obj["data"];var bpy_spline=bpy_curve["splines"][0];if(!(bpy_spline&&bpy_spline["type"]=="NURBS"&&bpy_spline["use_endpoint_u"]))return null;var order=bpy_spline["order_u"];spline.order=order;var points=bpy_spline["points"];var knot=gen_open_knot(points.length/5,order,[]);spline.knot=knot;if(bpy_curve["dimensions"]==
"2D")spline.is_3d=false;else if(bpy_curve["dimensions"]=="3D")spline.is_3d=true;else throw"Wrong curve dimensions";var cpoints=[];var weights=[];for(var i=0;i<points.length;i+=5){cpoints.push(points[i]);cpoints.push(points[i+1]);cpoints.push(points[i+2]);if(spline.is_3d)cpoints.push(points[i+3]);weights.push(points[i+4])}spline.cpoints=cpoints;spline.weights=weights;var points=spline_points(spline,SPLINE_POINTS,[]);var ncoords=spline.is_3d?4:3;var clen=new Float32Array(SPLINE_POINTS);clen[0]=0;for(var i=
1;i<SPLINE_POINTS;i+=1){var x0=points[(i-1)*ncoords];var y0=points[(i-1)*ncoords+1];var z0=points[(i-1)*ncoords+2];var x=points[i*ncoords];var y=points[i*ncoords+1];var z=points[i*ncoords+2];var len=Math.sqrt((x-x0)*(x-x0)+(y-y0)*(y-y0)+(z-z0)*(z-z0));clen[i]=clen[i-1]+len}spline.cumulative_length=clen;return spline};function gen_open_knot(n,order,dest){if(!dest)var dest=[];var nplusorder=n+order;var nplus2=n+2;dest[0]=0;for(var i=2;i<=nplusorder;i++)if(i>order&&i<nplus2)dest[i-1]=dest[i-2]+1;else dest[i-
1]=dest[i-2];return dest}function gen_periodic_knot(n,order,dest){if(!dest)var dest=[];var nplusorder=n+order;var nplus2=n+2;dest[0]=0;for(var i=2;i<=nplusorder;i++)dest[i-1]=i-1;return dest}function gen_rational_basis(order,t,knot,weights,r){var n=weights.length;if(!r)var r=new Float32Array(n);var nplusorder=n+order;var temp=new Float32Array(nplusorder);for(var i=1;i<=nplusorder-1;i++)if(t>=knot[i-1]&&t<knot[i+1-1])temp[i-1]=1;else temp[i-1]=0;for(var k=2;k<=order;k++)for(var i=1;i<=nplusorder-k;i++){if(temp[i-
1]!=0)var d=(t-knot[i-1])*temp[i-1]/(knot[i+k-1-1]-knot[i-1]);else var d=0;if(temp[i+1-1]!=0)var e=(knot[i+k-1]-t)*temp[i+1-1]/(knot[i+k-1]-knot[i+1-1]);else var e=0;temp[i-1]=d+e}if(t==knot[nplusorder-1])temp[n-1]=1;var sum=0;for(var i=1;i<=n;i++)sum=sum+temp[i-1]*weights[i-1];for(var i=1;i<=n;i++)if(sum!=0)r[i-1]=temp[i-1]*weights[i-1]/sum;else r[i-1]=0;return r}function gen_rational_dbasis(order,t,knot,weights,rd){var num=weights.length;if(!rd)var rd=new Float32Array(num);var n=new Float32Array(num);
var d=new Float32Array(num);gen_basis_d(num,order,t,knot,n,d);var sum=0;for(var i=1;i<=num;i++)sum=sum+n[i-1]*weights[i-1];var dsum=0;for(var i=1;i<=num;i++)dsum=dsum+d[i-1]*weights[i-1];for(var i=1;i<=num;i++)if(sum!=0){var rd1=d[i-1]*weights[i-1]/sum;var rd2=n[i-1]*weights[i-1]*dsum/(sum*sum);rd[i-1]=rd1+rd2}else rd[i-1]=0;return rd}function gen_basis_d(num,order,t,knot,n,d){if(!n)var n=new Float32Array(num);if(!d)var d=new Float32Array(num);var nplusorder=num+order;var temp=new Float32Array(nplusorder);
var tempd=new Float32Array(nplusorder);for(var i=1;i<=nplusorder-1;i++)if(t>=knot[i-1]&&t<knot[i+1-1])temp[i-1]=1;else temp[i-1]=0;if(t==knot[nplusorder-1])temp[num-1]=1;for(var k=2;k<=order;k++)for(var i=1;i<=nplusorder-k;i++){if(temp[i-1]!=0)var b1=(t-knot[i-1])*temp[i-1]/(knot[i+k-1-1]-knot[i-1]);else var b1=0;if(temp[i+1-1]!=0)var b2=(knot[i+k-1]-t)*temp[i+1-1]/(knot[i+k-1]-knot[i+1-1]);else var b2=0;if(temp[i-1]!=0)var f1=temp[i-1]/(knot[i+k-1-1]-knot[i-1]);else var f1=0;if(temp[i+1-1]!=0)var f2=
-temp[i+1-1]/(knot[i+k-1]-knot[i+1-1]);else var f2=0;if(tempd[i-1]!=0)var f3=(t-knot[i-1])*tempd[i-1]/(knot[i+k-1-1]-knot[i-1]);else var f3=0;if(tempd[i+1-1]!=0)var f4=(knot[i+k-1]-t)*tempd[i+1-1]/(knot[i+k-1]-knot[i+1-1]);else var f4=0;temp[i-1]=b1+b2;tempd[i-1]=f1+f2+f3+f4}for(var i=1;i<=num;i++){n[i-1]=temp[i-1];d[i-1]=tempd[i-1]}return n}function spline_points(spline,num,dest){if(!dest)var dest=[];var cpoints=spline.cpoints;var ncoords=spline.is_3d?4:3;var weights=spline.weights;var knot=spline.knot;
var order=spline.order;var n=cpoints.length/ncoords;var nplusorder=n+order;var t=0;var step=knot[nplusorder-1]/(num-1);var icount=0;for(var i=0;i<num;i++){if(knot[nplusorder-1]-t<5E-6)t=knot[nplusorder-1];var basis=gen_rational_basis(order,t,knot,weights);for(var j=0;j<ncoords;j++){dest[ncoords*i+j]=0;for(var k=0;k<n;k++){var temp=basis[k]*cpoints[ncoords*k+j];dest[ncoords*i+j]+=temp}}t=t+step}return dest}exports.spline_point=function(spline,t,dest){if(!dest)var dest=[];var t=clamped_t(spline,t);
var cpoints=spline.cpoints;var ncoords=spline.is_3d?4:3;var weights=spline.weights;var knot=spline.knot;var order=spline.order;var n=cpoints.length/ncoords;var nplusorder=n+order;if(knot[nplusorder-1]-t<5E-6)t=knot[nplusorder-1];var basis=new Float32Array(n);gen_rational_basis(order,t,knot,weights,basis);for(var i=0;i<ncoords;i++){dest[i]=0;for(var j=0;j<n;j++)dest[i]+=basis[j]*cpoints[ncoords*j+i]}return dest};function clamped_t(spline,t){var t_clamped=Math.max(t,0);var max_t=spline_max_t(spline);
t_clamped=Math.min(t,max_t);return t_clamped}exports.spline_derivative=function(spline,t,dest){if(!dest)var dest=[];var cpoints=spline.cpoints;var ncoords=spline.is_3d?4:3;var weights=spline.weights;var knot=spline.knot;var order=spline.order;var n=cpoints.length/ncoords;var nplusorder=n+order;if(knot[nplusorder-1]-t<5E-6)t=knot[nplusorder-1];var dbasis=new Float32Array(n);gen_rational_dbasis(order,t,knot,weights,dbasis);for(var i=0;i<ncoords;i++){dest[i]=0;for(var j=0;j<n;j++)dest[i]+=dbasis[j]*
cpoints[ncoords*j+i]}return dest};exports.spline_max_t=spline_max_t;function spline_max_t(spline){var knot=spline.knot;return knot[knot.length-1]}exports.spline_length=spline_length;function spline_length(spline){var clen=spline.cumulative_length;return clen[clen.length-1]}exports.spline_len_to_t=function(spline,len){if(len<=0)return 0;var max_t=spline_max_t(spline);if(len>=spline_length(spline))return max_t;var clen=spline.cumulative_length;var index=m_util.binary_search_max(clen,len,0,clen.length-
1);var index_float=index+(len-clen[index])/(clen[index+1]-clen[index]);var t=max_t*index_float/SPLINE_POINTS;return t}};b4w.module["__dds"]=function(exports,require){var m_print=require("__print");var DDS_MAGIC=542327876;var DDSD_CAPS=1,DDSD_HEIGHT=2,DDSD_WIDTH=4,DDSD_PITCH=8,DDSD_PIXELFORMAT=4096,DDSD_MIPMAPCOUNT=131072,DDSD_LINEARSIZE=524288,DDSD_DEPTH=8388608;var DDSCAPS_COMPLEX=8,DDSCAPS_MIPMAP=4194304,DDSCAPS_TEXTURE=4096;var DDSCAPS2_CUBEMAP=512,DDSCAPS2_CUBEMAP_POSITIVEX=1024,DDSCAPS2_CUBEMAP_NEGATIVEX=2048,DDSCAPS2_CUBEMAP_POSITIVEY=4096,DDSCAPS2_CUBEMAP_NEGATIVEY=8192,DDSCAPS2_CUBEMAP_POSITIVEZ=16384,DDSCAPS2_CUBEMAP_NEGATIVEZ=
32768,DDSCAPS2_VOLUME=2097152;var DDPF_ALPHAPIXELS=1,DDPF_ALPHA=2,DDPF_FOURCC=4,DDPF_RGB=64,DDPF_YUV=512,DDPF_LUMINANCE=131072;var FOURCC_DXT1=fourcc_to_int32("DXT1");var FOURCC_DXT3=fourcc_to_int32("DXT3");var FOURCC_DXT5=fourcc_to_int32("DXT5");var HEADER_LENGTH_INT=31;var OFFSET_MAGIC=0;var OFFSET_SIZE=1;var OFFSET_FLAGS=2;var OFFSET_HEIGHT=3;var OFFSET_WIDTH=4;var OFFSET_MIPMAPCOUNT=7;var OFFSET_PF_FLAGS=20;var OFFSET_PF_FOUR_CC=21;exports.dxt_to_rgb_565=dxt_to_rgb_565;function dxt_to_rgb_565(src,
src16Offset,width,height){var c=new Uint16Array(4);var dst=new Uint16Array(width*height);var nWords=width*height/4;var m=0;var dstI=0;var i=0;var r0=0,g0=0,b0=0,r1=0,g1=0,b1=0;var blockWidth=width/4;var blockHeight=height/4;for(var blockY=0;blockY<blockHeight;blockY++)for(var blockX=0;blockX<blockWidth;blockX++){i=src16Offset+4*(blockY*blockWidth+blockX);c[0]=src[i];c[1]=src[i+1];r0=c[0]&31;g0=c[0]&2016;b0=c[0]&63488;r1=c[1]&31;g1=c[1]&2016;b1=c[1]&63488;c[2]=5*r0+3*r1>>3|5*g0+3*g1>>3&2016|5*b0+3*
b1>>3&63488;c[3]=5*r1+3*r0>>3|5*g1+3*g0>>3&2016|5*b1+3*b0>>3&63488;m=src[i+2];dstI=blockY*4*width+blockX*4;dst[dstI]=c[m&3];dst[dstI+1]=c[m>>2&3];dst[dstI+2]=c[m>>4&3];dst[dstI+3]=c[m>>6&3];dstI+=width;dst[dstI]=c[m>>8&3];dst[dstI+1]=c[m>>10&3];dst[dstI+2]=c[m>>12&3];dst[dstI+3]=c[m>>14];m=src[i+3];dstI+=width;dst[dstI]=c[m&3];dst[dstI+1]=c[m>>2&3];dst[dstI+2]=c[m>>4&3];dst[dstI+3]=c[m>>6&3];dstI+=width;dst[dstI]=c[m>>8&3];dst[dstI+1]=c[m>>10&3];dst[dstI+2]=c[m>>12&3];dst[dstI+3]=c[m>>14]}return dst}
exports.upload_dds_levels=upload_dds_levels;function upload_dds_levels(gl,ext,arrayBuffer,loadMipmaps){var header=new Int32Array(arrayBuffer,0,HEADER_LENGTH_INT),fourCC,blockBytes,internalFormat,width,height,dataLength,dataOffset,rgb565Data,byteArray,mipmapCount,i;if(header[OFFSET_MAGIC]!=DDS_MAGIC){m_print.error("Invalid magic number in DDS header");return 0}if(!header[OFFSET_PF_FLAGS]&DDPF_FOURCC){m_print.error("Unsupported format, must contain a FourCC code");return 0}fourCC=header[OFFSET_PF_FOUR_CC];
switch(fourCC){case FOURCC_DXT1:blockBytes=8;internalFormat=ext?ext.COMPRESSED_RGB_S3TC_DXT1_EXT:null;break;case FOURCC_DXT3:blockBytes=16;internalFormat=ext?ext.COMPRESSED_RGBA_S3TC_DXT3_EXT:null;break;case FOURCC_DXT5:blockBytes=16;internalFormat=ext?ext.COMPRESSED_RGBA_S3TC_DXT5_EXT:null;break;default:m_print.error("Unsupported FourCC code:",int32_to_fourcc(fourCC));return null}mipmapCount=1;if(header[OFFSET_FLAGS]&DDSD_MIPMAPCOUNT&&loadMipmaps!==false)mipmapCount=Math.max(1,header[OFFSET_MIPMAPCOUNT]);
width=header[OFFSET_WIDTH];height=header[OFFSET_HEIGHT];dataOffset=header[OFFSET_SIZE]+4;if(ext)for(i=0;i<mipmapCount;++i){dataLength=Math.max(4,width)/4*Math.max(4,height)/4*blockBytes;byteArray=new Uint8Array(arrayBuffer,dataOffset,dataLength);gl.compressedTexImage2D(gl.TEXTURE_2D,i,internalFormat,width,height,0,byteArray);dataOffset+=dataLength;width=Math.max(width*.5,1);height=Math.max(height*.5,1)}else if(fourCC==FOURCC_DXT1){dataLength=Math.max(4,width)/4*Math.max(4,height)/4*blockBytes;byteArray=
new Uint16Array(arrayBuffer);rgb565Data=dxt_to_rgb_565(byteArray,dataOffset/2,width,height);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGB,width,height,0,gl.RGB,gl.UNSIGNED_SHORT_5_6_5,rgb565Data);if(loadMipmaps)gl.generateMipmap(gl.TEXTURE_2D)}else{m_print.error("No manual decoder for",int32_to_fourcc(fourCC),"and no native support");return 0}return mipmapCount}exports.get_width_height=function(arrayBuffer){var header=new Int32Array(arrayBuffer,0,HEADER_LENGTH_INT);return{width:header[OFFSET_WIDTH],height:header[OFFSET_HEIGHT]}};
exports.get_compress_ratio=function(arrayBuffer){var comp_ratio=1;var header=new Int32Array(arrayBuffer,0,HEADER_LENGTH_INT);var fourCC=header[OFFSET_PF_FOUR_CC];switch(fourCC){case FOURCC_DXT1:var comp_ratio=6;break;case FOURCC_DXT3:case FOURCC_DXT5:var comp_ratio=4;break;default:m_print.error("Unsupported FourCC code:",int32_to_fourcc(fourCC));break}return comp_ratio};exports.load_dds_texture_ex=load_dds_texture_ex;function load_dds_texture_ex(gl,ext,src,texture,loadMipmaps,callback){var xhr=new XMLHttpRequest;
xhr.open("GET",src,true);xhr.responseType="arraybuffer";xhr.onload=function(){if(xhr.status==200){gl.bindTexture(gl.TEXTURE_2D,texture);var mipmaps=upload_dds_levels(gl,ext,xhr.response,loadMipmaps);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,mipmaps>1?gl.LINEAR_MIPMAP_LINEAR:gl.LINEAR)}if(callback)callback(texture)};xhr.send(null);return texture}exports.load_dds_texture=function(gl,ext,src,callback){var texture=gl.createTexture();
load_dds_texture_ex(gl,ext,src,texture,true,callback);return texture};function fourcc_to_int32(value){return value.charCodeAt(0)+(value.charCodeAt(1)<<8)+(value.charCodeAt(2)<<16)+(value.charCodeAt(3)<<24)}function int32_to_fourcc(value){return String.fromCharCode(value&255,value>>8&255,value>>16&255,value>>24&255)}};b4w.module["__debug"]=function(exports,require){var m_ext=require("__extensions");var m_print=require("__print");var m_tex=require("__textures");var m_time=require("__time");var m_util=require("__util");var _gl=null;var ERRORS={};var FAKE_LOAD_INTERVAL=5E3;var FAKE_LOAD_START_PERCENTAGE=0;var FAKE_LOAD_END_PERCENTAGE=100;var _check_errors=false;var _exec_counters={};var _telemetry_messages=[];var _depth_only_issue=-1;var _assert_struct_last_obj=null;var _assert_struct_init=false;exports.WM_NONE=0;
exports.WM_OPAQUE_WIREFRAME=1;exports.WM_TRANSPARENT_WIREFRAME=2;exports.WM_FRONT_BACK_VIEW=3;exports.WM_DEBUG_SPHERES=4;exports.setup_context=function(gl){var errors=["INVALID_ENUM","INVALID_VALUE","INVALID_OPERATION","OUT_OF_MEMORY","INVALID_FRAMEBUFFER_OPERATION","CONTEXT_LOST_WEBGL"];for(var i in errors){var error=errors[i];if(error in gl)ERRORS[gl[error]]=error}_gl=gl};exports.check_gl=function(msg){if(!_check_errors)return;var error=_gl.getError();if(error==_gl.NO_ERROR)return;if(error in ERRORS)m_util.panic("GL Error: "+
error+", gl."+ERRORS[error]+" ("+msg+")");else m_util.panic("Unknown GL error: "+error+" ("+msg+")")};exports.check_bound_fb=function(){if(!_check_errors)return true;switch(_gl.checkFramebufferStatus(_gl.FRAMEBUFFER)){case _gl.FRAMEBUFFER_COMPLETE:return true;case _gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:m_print.error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");return false;case _gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:m_print.error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");
return false;case _gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:m_print.error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");return false;case _gl.FRAMEBUFFER_UNSUPPORTED:m_print.error("Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED");return false;default:m_print.error("FRAMEBUFFER CHECK FAILED");return false}};exports.check_depth_only_issue=function(){if(_depth_only_issue!=-1)return _depth_only_issue;var framebuffer=_gl.createFramebuffer();_gl.bindFramebuffer(_gl.FRAMEBUFFER,framebuffer);
var texture=m_tex.create_texture("DEBUG",m_tex.TT_DEPTH);m_tex.resize(texture,1,1);var w_tex=texture.w_texture;var w_target=texture.w_target;_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.DEPTH_ATTACHMENT,w_target,w_tex,0);if(_gl.checkFramebufferStatus(_gl.FRAMEBUFFER)!=_gl.FRAMEBUFFER_COMPLETE){_depth_only_issue=true;m_print.warn("depth-only issue was found")}else _depth_only_issue=false;_gl.bindFramebuffer(_gl.FRAMEBUFFER,null);return _depth_only_issue};exports.check_shader_compiling=function(shader,
shader_id,shader_text){if(!_check_errors)return;if(!_gl.getShaderParameter(shader,_gl.COMPILE_STATUS)){shader_text=supply_line_numbers(shader_text);m_print.error("shader compilation failed:\n"+shader_text+"\n"+_gl.getShaderInfoLog(shader)+" ("+shader_id+")");throw"Engine failed: see above for error messages";}};function supply_line_numbers(text){var lines=text.split("\n");for(var i=0;i<lines.length;i++)lines[i]=i+1+" "+lines[i];text=lines.join("\n");return text}exports.check_shader_linking=function(program,
shader_id,vshader,fshader,vshader_text,fshader_text){if(!_check_errors)return;if(!_gl.getProgramParameter(program,_gl.LINK_STATUS)){var ext_ds=m_ext.get_debug_shaders();if(ext_ds){var vshader_text=ext_ds.getTranslatedShaderSource(vshader);var fshader_text=ext_ds.getTranslatedShaderSource(fshader)}vshader_text=supply_line_numbers(vshader_text);fshader_text=supply_line_numbers(fshader_text);m_print.error("shader linking failed:\n"+vshader_text+"\n\n\n"+fshader_text+"\n"+_gl.getProgramInfoLog(program)+
" ("+shader_id+")");throw"Engine failed: see above for error messages";}};exports.set_check_gl_errors=function(val){_check_errors=val};exports.exec_count=function(counter){if(counter in _exec_counters)_exec_counters[counter]+=1;else _exec_counters[counter]=1};exports.update=function(){for(var i in _exec_counters){m_print.log(i,_exec_counters[i]);_exec_counters[i]=0}};exports.fbmsg=function(){var msg=[performance.now()];for(var i=0;i<arguments.length;i++){var arg=arguments[i];if(m_util.is_vector(arg))for(var j=
0;j<arg.length;j++)msg.push(arg[j]);else msg.push(arguments[i])}_telemetry_messages.push(msg)};exports.msg=function(){var id_count=1;for(var i=0;i<_telemetry_messages.length;i++){var msg=_telemetry_messages[i];if(msg[1]==arguments[0])id_count++}var msg=[id_count];for(var i=0;i<arguments.length;i++){var arg=arguments[i];if(m_util.is_vector(arg))for(var j=0;j<arg.length;j++)msg.push(arg[j]);else msg.push(arguments[i])}_telemetry_messages.push(msg)};var COLORS=["color: #3366FF","color: #CC33FF","color: #FF3366",
"color: #33FF66","color: #FFCC33"];exports.print_telemetry=function(time){if(!time)time=1;var color_counter=0;var color_by_id={};var start_time_ms=Math.max(0,performance.now()-time*1E3);for(var i=0;i<_telemetry_messages.length;i++){var msg=_telemetry_messages[i];var time=msg[0];if(time<start_time_ms)continue;var id=String(msg[1]);if(!color_by_id[id])color_by_id[id]=COLORS[color_counter++%COLORS.length];var color=color_by_id[id];var console_args=["%c"+(time/1E3).toFixed(6),color,id];for(var j=2;j<
msg.length;j++)console_args.push(msg[j]);m_print.log.apply(this,console_args)}_telemetry_messages.splice(0)};exports.plot_telemetry=function(time){if(!time)time=1;var msg_by_id={};var start_time_ms=Math.max(0,performance.now()-time*1E3);for(var i=0;i<_telemetry_messages.length;i++){var msg=_telemetry_messages[i];var time=msg[0];if(time<start_time_ms)continue;for(var j=2;j<msg.length;j++){var id=String(msg[1]);if(msg.length>3)id+="_"+String(j-2);if(!msg_by_id[id])msg_by_id[id]=id+"\n";msg_by_id[id]+=
String(time)+" "+msg[j]+"\n"}}var plot_str="";for(var id in msg_by_id)plot_str+=msg_by_id[id]+"\n\n";m_print.log(plot_str);_telemetry_messages.splice(0)};exports.check_browser=function(name){var user_agent=navigator.userAgent.toLowerCase();var check_ua=function(name){if(user_agent.indexOf(name)>-1)return true;else return false};switch(name.toLowerCase()){case "chrome":return check_ua("mozilla")&&check_ua("applewebkit")&&check_ua("chrome");case "firefox":return check_ua("mozilla")&&check_ua("gecko")&&
check_ua("firefox");case "msie":return check_ua("mozilla")&&check_ua("trident")&&check_ua("msie");case "opera":return check_ua("opera")&&check_ua("presto");case "safari":return check_ua("mozilla")&&check_ua("applewebkit")&&check_ua("safari")&&!check_ua("chrome");default:return false}};exports.check_finite=function(o){if(m_util.is_vector(o)){for(var i=0;i<o.length;i++)if(!isFinite(o[i]))return false;return Boolean(o.length)}else if(!isFinite(o))return false;else return true};exports.assert_cons=function(value,
constructor){if(value.constructor!=constructor)m_util.panic("Type assertion failed: value <"+value+"> has type <"+value.constructor+">, required <"+constructor+">")};exports.assert_structure=assert_structure;function assert_structure(obj1,obj2){if(typeof obj1!=typeof obj2)m_util.panic("Structure assertion failed: incompatible types");if(!(obj1!==null&&obj2!==null&&typeof obj1=="object"))return;for(var i in obj1)if(!(i in obj2))m_util.panic("Structure assertion failed: missing key in the first object: "+
i);for(var i in obj2){if(!(i in obj1))m_util.panic("Structure assertion failed: missing key in the second object: "+i);if(typeof obj1[i]!=typeof obj2[i])m_util.panic("Structure assertion failed: incompatible types for key "+i)}}exports.assert_structure_seq=function(obj){if(!_assert_struct_init)_assert_struct_init=true;else assert_structure(obj,_assert_struct_last_obj);_assert_struct_last_obj=obj};exports.fake_load=function(stageload_cb,interval,start,end,loaded_cb){stageload_cb=stageload_cb||null;
if(!stageload_cb)m_util.panic("Stage load callback is undefined");interval=interval||FAKE_LOAD_INTERVAL;start=start||FAKE_LOAD_START_PERCENTAGE;end=end||FAKE_LOAD_END_PERCENTAGE;if(end>100)m_util.panic("Max percentage must be less than 100");if(start<0)m_util.panic("Min percentage must be greater than 0");if(start>end)m_util.panic("Max percentage must be greater than min percentage");var animator=m_time.animate(start,end,interval,function(e){var rounded_percentage=e.toFixed();stageload_cb(rounded_percentage);
if(rounded_percentage==100){m_time.clear_animation(animator);if(loaded_cb)loaded_cb();return}})}};b4w.module["__extensions"]=function(exports,require){var m_print=require("__print");var _gl=null;var _ext_cache={};exports.setup_context=function(gl){_gl=gl};exports.get_s3tc=function(){var ext_s3tc=get("WEBGL_compressed_texture_s3tc")||get("WEBKIT_WEBGL_compressed_texture_s3tc")||get("MOZ_WEBGL_compressed_texture_s3tc");return ext_s3tc};exports.get_depth_texture=function(){var ext_dtex=get("WEBGL_depth_texture")||get("WEBKIT_WEBGL_depth_texture")||get("MOZ_WEBGL_depth_texture");return ext_dtex};
exports.get_aniso=function(){var ext_aniso=get("EXT_texture_filter_anisotropic")||get("WEBKIT_EXT_texture_filter_anisotropic")||get("MOZ_EXT_texture_filter_anisotropic");return ext_aniso};exports.get_debug_shaders=function(){var ext_ds=get("WEBGL_debug_shaders");return ext_ds};exports.get_renderer_info=function(){var ext_ri=get("WEBGL_debug_renderer_info");return ext_ri};exports.get_elem_index_uint=function(){var ext_elem_index_uint=get("OES_element_index_uint");return ext_elem_index_uint};exports.get_standard_derivatives=
function(){var ext_standard_derivatives=get("OES_standard_derivatives");return ext_standard_derivatives};function get(name){if(name in _ext_cache)return _ext_cache[name];var ext=_gl.getExtension(name)||null;_ext_cache[name]=ext;if(ext)var color="0a0";else var color="a00";m_print.log("%cGET EXTENSION","color: #"+color,name);return ext}exports.cleanup=function(){_ext_cache={}}};b4w.module["__graph"]=function(exports,require){var m_print=require("__print");var m_util=require("__util");var NULL_NODE=-1;var NULL=0;var FORWARD_DIR=10;var BACKWARD_DIR=20;var TWO_WAY=30;var _next_pair_cache=[NULL_NODE,NULL_NODE];exports.NULL_NODE=NULL_NODE;exports.FORWARD_DIR=FORWARD_DIR;exports.BACKWARD_DIR=BACKWARD_DIR;exports.TWO_WAY=TWO_WAY;exports.create=function(){var node_edge_arr=arguments;var nodes=[];var edges=[];for(var i=0;i<node_edge_arr.length;i++){var node_edge=node_edge_arr[i];
switch(node_edge.length){case 2:nodes.push(node_edge[0],node_edge[1]);break;case 3:edges.push(node_edge[0],node_edge[1],node_edge[2]);break;default:throw"Wrong graph constructor params";break}}var graph={nodes:nodes,edges:edges};return graph};exports.clone=function(graph,nodes_cb,edges_cb){if(nodes_cb){var nodes=new Array(graph.nodes.length);for(var i=0;i<graph.nodes.length;i+=2){nodes[i]=graph.nodes[i];nodes[i+1]=nodes_cb(graph.nodes[i+1])}}else var nodes=m_util.clone_object_r(graph.nodes);if(edges_cb){var edges=
new Array(graph.edges.length);for(var i=0;i<graph.edges.length;i+=3){edges[i]=graph.edges[i];edges[i+1]=graph.edges[i+1];edges[i+2]=edges_cb(graph.edges[i+2])}}else var edges=m_util.clone_object_r(graph.edges);var graph={nodes:nodes,edges:edges};return graph};exports.create_node_edge_arr=function(nodes_arr,edges_arr){var nodes=[];var edges=[];for(var i=0;i<nodes_arr.length;i++)nodes.push(nodes_arr[i][0],nodes_arr[i][1]);for(var i=0;i<edges_arr.length;i++)edges.push(edges_arr[i][0],edges_arr[i][1],
edges_arr[i][2]);var graph={nodes:nodes,edges:edges};return graph};exports.append_node=append_node;function append_node(graph,id,attr){if(!attr)attr=null;if(has_node(graph,id))throw"Graph already has node with given ID";else graph.nodes.push(id,attr)}exports.has_node=has_node;function has_node(graph,id){var nodes=graph.nodes;for(var i=0;i<nodes.length;i+=2)if(nodes[i]==id)return true;return false}exports.append_edge=append_edge;function append_edge(graph,id1,id2,attr){if(!attr)attr=null;if(!has_node(graph,
id1)||!has_node(graph,id2))throw"Wrong node IDs";else graph.edges.push(id1,id2,attr)}exports.remove_node=remove_node;function remove_node(graph,id){if(!has_node(graph,id))throw"Node not found";var nodes=graph.nodes;for(var i=0;i<nodes.length;i+=2)if(nodes[i]==id){nodes.splice(i,2);i-=2}}exports.remove_edge=remove_edge;function remove_edge(graph,id1,id2,edge_num){if(!has_edge(graph,id1,id2))throw"Edge not found";var edges=graph.edges;var count=0;for(var i=0;i<edges.length;i+=3)if(edges[i]==id1&&edges[i+
1]==id2){if(edge_num==-1)edges.splice(i,3);else{if(edge_num==count){edges.splice(i,3);break}count++}i-=3}}exports.remove_edge_by_attr=remove_edge_by_attr;function remove_edge_by_attr(graph,id1,id2,attr){if(!has_edge(graph,id1,id2))throw"Edge not found";var edges=graph.edges;for(var i=0;i<edges.length;i+=3)if(edges[i]==id1&&edges[i+1]==id2&&edges[i+2][0]==attr[0]&&edges[i+2][1]==attr[1]){edges.splice(i,3);break}}exports.append_node_attr=function(graph,attr){if(node_by_attr(graph,attr)==NULL_NODE){var node_id=
gen_node_id(graph);append_node(graph,node_id,attr);return node_id}else throw"Non-unique attribute";};exports.replace_edge_attr=function(graph,id1,id2,attr_old,attr_new){var edges=graph.edges;for(var i=0;i<edges.length;i+=3)if(edges[i]==id1&&edges[i+1]==id2&&edges[i+2]==attr_old)edges[i+2]=attr_new};exports.gen_node_id=gen_node_id;function gen_node_id(graph){var nodes=graph.nodes;var counter=-1;for(var i=0;i<nodes.length;i+=2)counter=Math.max(counter,nodes[i]);return++counter}exports.node_by_attr=
node_by_attr;function node_by_attr(graph,attr){var nodes=graph.nodes;for(var i=0;i<nodes.length;i+=2)if(nodes[i+1]==attr)return nodes[i];return NULL_NODE}exports.append_edge_attr=function(graph,attr_node1,attr_node2,attr_edge){var id1=node_by_attr(graph,attr_node1);var id2=node_by_attr(graph,attr_node2);if(id1!=NULL_NODE&&id2!=NULL_NODE)append_edge(graph,id1,id2,attr_edge);else throw"Attributes not found";};exports.traverse=function(graph,callback){var nodes=graph.nodes;for(var i=0;i<nodes.length;i+=
2)if(callback(nodes[i],nodes[i+1]))break};exports.traverse_edges=function(graph,callback){var edges=graph.edges;for(var i=0;i<edges.length;i+=3)if(callback(edges[i],edges[i+1],edges[i+2]))break};exports.traverse_inputs=function(graph,node,callback){var edges=graph.edges;for(var i=0;i<edges.length;i+=3)if(edges[i+1]==node){var node_in=edges[i];if(callback(node_in,get_node_attr(graph,node_in),edges[i+2]))return}};exports.traverse_outputs=function(graph,node,callback){var edges=graph.edges;for(var i=
0;i<edges.length;i+=3)if(edges[i]==node){var node_out=edges[i+1];if(callback(node_out,get_node_attr(graph,node_out),edges[i+2]))return}};exports.topsort=topsort;function topsort(graph){var new_nodes=[];var visit_state={};set_unvisited(graph,visit_state);var nodes=graph.nodes;for(var i=0;i<nodes.length;i+=2)if(in_edge_count(graph,nodes[i])==0)topsort_iter(graph,nodes[i],visit_state,new_nodes);var new_graph={nodes:new_nodes,edges:graph.edges.slice(0)};return new_graph}function set_unvisited(graph,visit_state){var nodes=
graph.nodes;for(var i=0;i<nodes.length;i+=2)visit_state[nodes[i]]=false}function topsort_iter(graph,node_id,visit_state,new_nodes){if(!visit_state[node_id]){visit_state[node_id]=true;for(var i=0;i<out_edge_count(graph,node_id);i++){var other=get_out_edge(graph,node_id,i);topsort_iter(graph,other,visit_state,new_nodes)}new_nodes.unshift(node_id,get_node_attr(graph,node_id))}}exports.topsort_attr=function(graph){var nodes=topsort(graph).nodes;var result=[];for(var i=0;i<nodes.length;i+=2)result.push(nodes[i+
1]);return result};exports.is_connected=function(graph){};exports.subgraph_node_conn=function(graph,node_id,dir){if(!has_node(graph,node_id))throw"No such node";var visit_state={};set_unvisited(graph,visit_state);subgraph_node_conn_iter(graph,node_id,visit_state,dir);var new_nodes=[];for(var id in visit_state)if(visit_state[id]){var id=Number(id);new_nodes.push(id,get_node_attr(graph,id))}var new_graph={nodes:new_nodes,edges:graph.edges.slice(0)};cleanup_loose_edges(new_graph);return new_graph};function subgraph_node_conn_iter(graph,
node_id,visit_state,dir){if(!visit_state[node_id]){visit_state[node_id]=true;if(dir==FORWARD_DIR||dir==TWO_WAY)for(var i=0;i<out_edge_count(graph,node_id);i++){var other=get_out_edge(graph,node_id,i);subgraph_node_conn_iter(graph,other,visit_state,dir)}if(dir==BACKWARD_DIR||dir==TWO_WAY)for(var i=0;i<in_edge_count(graph,node_id);i++){var other=get_in_edge(graph,node_id,i);subgraph_node_conn_iter(graph,other,visit_state,dir)}}}function cleanup_loose_edges(graph){var nodes=graph.nodes;var edges=graph.edges;
for(var i=0;i<edges.length;i+=3){var node1=edges[i];var node2=edges[i+1];if(!has_node(graph,node1)||!has_node(graph,node2)){edges.splice(i,3);i-=3}}}exports.get_source_nodes=function(graph){var result=[];var nodes=graph.nodes;for(var i=0;i<nodes.length;i+=2){var node=nodes[i];if(!in_edge_count(graph,node))result.push(node)}return result};exports.get_sink_nodes=get_sink_nodes;function get_sink_nodes(graph){var result=[];var nodes=graph.nodes;for(var i=0;i<nodes.length;i+=2){var node=nodes[i];if(!out_edge_count(graph,
node))result.push(node)}return result}exports.match=function(graph1,graph2,node_comp,edge_comp){var state={};state.g1=gen_ordered_graph(graph1);state.g2=gen_ordered_graph(graph2);state.node_comp=node_comp||function(attr1,attr2){return attr1==attr2};state.edge_comp=edge_comp||function(attr1,attr2){return attr1==attr2};var n1=node_count(graph1);var n2=node_count(graph2);state.n1=n1;state.n2=n2;state.order=NULL;state.core_len=state.orig_core_len=0;state.t1both_len=state.t1in_len=state.t1out_len=0;state.t2both_len=
state.t2in_len=state.t2out_len=0;state.added_node1=NULL_NODE;state.core_1=Array(n1);state.core_2=Array(n2);state.in_1=new Array(n1);state.in_2=new Array(n2);state.out_1=new Array(n1);state.out_2=new Array(n2);state.share_count=[1];for(var i=0;i<n1;i++){state.core_1[i]=NULL_NODE;state.in_1[i]=0;state.out_1[i]=0}for(var i=0;i<n2;i++){state.core_2[i]=NULL_NODE;state.in_2[i]=0;state.out_2[i]=0}var c1=new Array(n1);var c2=new Array(n1);var res=match_iter(c1,c2,state);if(res){for(var i=0;i<c1.length;i++){c1[i]=
graph1.nodes[2*c1[i]];c2[i]=graph2.nodes[2*c2[i]]}return[c1,c2]}else return null};function node_count(graph){return graph.nodes.length/2}function gen_ordered_graph(graph){var nodes=graph.nodes;var edges=graph.edges;var new_nodes=[];var new_edges=[];var map=[];for(var i=0;i<nodes.length;i++){map[nodes[2*i]]=i;new_nodes.push(i,nodes[2*i+1])}for(var i=0;i<edges.length;i+=3)new_edges.push(map[edges[i]],map[edges[i+1]],edges[i+2]);var new_graph={nodes:new_nodes,edges:new_edges};return new_graph}function match_iter(c1,
c2,state){if(state_is_goal(state)){state_get_core_set(state,c1,c2);return true}if(state_is_dead(state))return false;var n1=NULL_NODE;var n2=NULL_NODE;var found=false;while(!found&&state_next_pair(state,_next_pair_cache,n1,n2)){var n1=_next_pair_cache[0];var n2=_next_pair_cache[1];if(state_is_feasible_pair(state,n1,n2)){var new_state=state_clone(state);state_add_pair(new_state,n1,n2);found=match_iter(c1,c2,new_state);state_back_track(new_state)}}return found}function state_is_goal(state){return state.core_len==
state.n1}function state_core_len(state){return state.core_len}function state_get_core_set(state,c1,c2){for(var i=0,j=0;i<state.n1;i++)if(state.core_1[i]!=NULL_NODE){c1[j]=i;c2[j]=state.core_1[i];j++}}function state_is_dead(state){return state.n1>state.n2||state.t1both_len>state.t2both_len||state.t1out_len>state.t2out_len||state.t1in_len>state.t2in_len}function state_next_pair(state,next_pair,prev_n1,prev_n2){if(prev_n1==NULL_NODE)prev_n1=0;if(prev_n2==NULL_NODE)prev_n2=0;else prev_n2++;var t1both_len=
state.t1both_len;var t2both_len=state.t2both_len;var t1out_len=state.t1out_len;var t2out_len=state.t2out_len;var t1in_len=state.t1in_len;var t2in_len=state.t2in_len;var core_len=state.core_len;var n1=state.n1;var n2=state.n2;var core_1=state.core_1;var core_2=state.core_2;var in_1=state.in_1;var in_2=state.in_2;var out_1=state.out_1;var out_2=state.out_2;if(t1both_len>core_len&&t2both_len>core_len)while(prev_n1<n1&&(core_1[prev_n1]!=NULL_NODE||out_1[prev_n1]==0||in_1[prev_n1]==0)){prev_n1++;prev_n2=
0}else if(t1out_len>core_len&&t2out_len>core_len)while(prev_n1<n1&&(core_1[prev_n1]!=NULL_NODE||out_1[prev_n1]==0)){prev_n1++;prev_n2=0}else if(t1in_len>core_len&&t2in_len>core_len)while(prev_n1<n1&&(core_1[prev_n1]!=NULL_NODE||in_1[prev_n1]==0)){prev_n1++;prev_n2=0}else if(prev_n1==0&&state.order!=NULL){var i=0;while(i<n1&&core_1[prev_n1=state.order[i]]!=NULL_NODE)i++;if(i==n1)prev_n1=n1}else while(prev_n1<n1&&core_1[prev_n1]!=NULL_NODE){prev_n1++;prev_n2=0}if(t1both_len>core_len&&t2both_len>core_len)while(prev_n2<
n2&&(core_2[prev_n2]!=NULL_NODE||out_2[prev_n2]==0||in_2[prev_n2]==0))prev_n2++;else if(t1out_len>core_len&&t2out_len>core_len)while(prev_n2<n2&&(core_2[prev_n2]!=NULL_NODE||out_2[prev_n2]==0))prev_n2++;else if(t1in_len>core_len&&t2in_len>core_len)while(prev_n2<n2&&(core_2[prev_n2]!=NULL_NODE||in_2[prev_n2]==0))prev_n2++;else while(prev_n2<n2&&core_2[prev_n2]!=NULL_NODE)prev_n2++;if(prev_n1<n1&&prev_n2<n2){next_pair[0]=prev_n1;next_pair[1]=prev_n2;return true}return false}function state_is_feasible_pair(state,
node1,node2){var g1=state.g1;var g2=state.g2;var n1=state.n1;var n2=state.n2;var core_1=state.core_1;var core_2=state.core_2;var in_1=state.in_1;var in_2=state.in_2;var out_1=state.out_1;var out_2=state.out_2;assert(node1<n1);assert(node2<n2);assert(core_1[node1]==NULL_NODE);assert(core_2[node2]==NULL_NODE);if(!compatible_node(state.node_comp,g1,node1,g2,node2))return false;var termout1=0,termout2=0,termin1=0,termin2=0,new1=0,new2=0;for(var i=0;i<out_edge_count(g1,node1);i++){var other1=get_out_edge(g1,
node1,i);if(core_1[other1]!=NULL_NODE){var other2=core_1[other1];if(!has_edge(g2,node2,other2)||!compatible_edge(state.edge_comp,g1,node1,other1,g2,node2,other2))return false}else{if(in_1[other1])termin1++;if(out_1[other1])termout1++;if(!in_1[other1]&&!out_1[other1])new1++}}for(var i=0;i<in_edge_count(g1,node1);i++){var other1=get_in_edge(g1,node1,i);if(core_1[other1]!=NULL_NODE){var other2=core_1[other1];if(!has_edge(g2,other2,node2)||!compatible_edge(state.edge_comp,g1,other1,node1,g2,other2,node2))return false}else{if(in_1[other1])termin1++;
if(out_1[other1])termout1++;if(!in_1[other1]&&!out_1[other1])new1++}}for(var i=0;i<out_edge_count(g2,node2);i++){var other2=get_out_edge(g2,node2,i);if(core_2[other2]!=NULL_NODE){var other1=core_2[other2];if(!has_edge(g1,node1,other1))return false}else{if(in_2[other2])termin2++;if(out_2[other2])termout2++;if(!in_2[other2]&&!out_2[other2])new2++}}for(var i=0;i<in_edge_count(g2,node2);i++){var other2=get_in_edge(g2,node2,i);if(core_2[other2]!=NULL_NODE){var other1=core_2[other2];if(!has_edge(g1,other1,
node1))return false}else{if(in_2[other2])termin2++;if(out_2[other2])termout2++;if(!in_2[other2]&&!out_2[other2])new2++}}return termin1<=termin2&&termout1<=termout2&&new1<=new2}function assert(expr){if(!expr)throw"Assertion failed";}function compatible_node(node_comp,graph1,node1,graph2,node2){if(node_comp(get_node_attr(graph1,node1),get_node_attr(graph2,node2)))return true;else return false}exports.get_node_attr=get_node_attr;function get_node_attr(graph,node){var nodes=graph.nodes;for(var i=0;i<
nodes.length;i+=2)if(nodes[i]==node)return nodes[i+1];return null}exports.out_edge_count=out_edge_count;function out_edge_count(graph,node){var edges=graph.edges;var count=0;for(var i=0;i<edges.length;i+=3)if(edges[i]==node)count++;return count}exports.in_edge_count=in_edge_count;function in_edge_count(graph,node){var edges=graph.edges;var count=0;for(var i=0;i<edges.length;i+=3)if(edges[i+1]==node)count++;return count}exports.get_out_edge=get_out_edge;function get_out_edge(graph,node,num){var edges=
graph.edges;var count=0;for(var i=0;i<edges.length;i+=3)if(edges[i]==node){if(count==num)return edges[i+1];count++}return NULL_NODE}exports.get_in_edge=get_in_edge;function get_in_edge(graph,node,num){var edges=graph.edges;var count=0;for(var i=0;i<edges.length;i+=3)if(edges[i+1]==node){if(count==num)return edges[i];count++}return NULL_NODE}function has_edge(graph,node1,node2){var edges=graph.edges;for(var i=0;i<edges.length;i+=3)if(edges[i]==node1&&edges[i+1]==node2)return true;return false}function compatible_edge(edge_comp,
graph1,node11,node12,graph2,node21,node22){var graph1_edge_count=get_edge_count(graph1,node11,node12);var graph2_edge_count=get_edge_count(graph2,node21,node22);for(var i=0;i<graph1_edge_count;i++){var edge_match=false;for(var j=0;j<graph2_edge_count;j++)if(edge_comp(get_edge_attr(graph1,node11,node12,i),get_edge_attr(graph2,node21,node22,j))){edge_match=true;break}if(!edge_match)return false}return true}exports.get_edge_count=get_edge_count;function get_edge_count(graph,node1,node2){var count=0;
var edges=graph.edges;for(var i=0;i<edges.length;i+=3)if(edges[i]==node1&&edges[i+1]==node2)count++;return count}exports.get_edge_attr=get_edge_attr;function get_edge_attr(graph,node1,node2,num){var edges=graph.edges;var count=0;for(var i=0;i<edges.length;i+=3)if(edges[i]==node1&&edges[i+1]==node2){if(count==num)return edges[i+2];count++}return null}function state_add_pair(state,node1,node2){var g1=state.g1;var g2=state.g2;var n1=state.n1;var n2=state.n2;var core_1=state.core_1;var core_2=state.core_2;
var in_1=state.in_1;var in_2=state.in_2;var out_1=state.out_1;var out_2=state.out_2;assert(node1<n1);assert(node2<n2);assert(state.core_len<n1);assert(state.core_len<n2);var core_len=++state.core_len;state.added_node1=node1;if(!in_1[node1]){in_1[node1]=core_len;state.t1in_len++;if(out_1[node1])state.t1both_len++}if(!out_1[node1]){out_1[node1]=core_len;state.t1out_len++;if(in_1[node1])state.t1both_len++}if(!in_2[node2]){in_2[node2]=core_len;state.t2in_len++;if(out_2[node2])state.t2both_len++}if(!out_2[node2]){out_2[node2]=
core_len;state.t2out_len++;if(in_2[node2])state.t2both_len++}core_1[node1]=node2;core_2[node2]=node1;for(var i=0;i<in_edge_count(g1,node1);i++){var other=get_in_edge(g1,node1,i);if(!in_1[other]){in_1[other]=core_len;state.t1in_len++;if(out_1[other])state.t1both_len++}}for(var i=0;i<out_edge_count(g1,node1);i++){var other=get_out_edge(g1,node1,i);if(!out_1[other]){out_1[other]=core_len;state.t1out_len++;if(in_1[other])state.t1both_len++}}for(var i=0;i<in_edge_count(g2,node2);i++){var other=get_in_edge(g2,
node2,i);if(!in_2[other]){in_2[other]=core_len;state.t2in_len++;if(out_2[other])state.t2both_len++}}for(var i=0;i<out_edge_count(g2,node2);i++){var other=get_out_edge(g2,node2,i);if(!out_2[other]){out_2[other]=core_len;state.t2out_len++;if(in_2[other])state.t2both_len++}}}function state_back_track(state){assert(state.core_len-state.orig_core_len<=1);assert(state.added_node1!=NULL_NODE);var g1=state.g1;var g2=state.g2;var core_len=state.core_len;var added_node1=state.added_node1;var core_1=state.core_1;
var core_2=state.core_2;var in_1=state.in_1;var in_2=state.in_2;var out_1=state.out_1;var out_2=state.out_2;if(state.orig_core_len<core_len){if(in_1[added_node1]==core_len)in_1[added_node1]=0;for(var i=0;i<in_edge_count(g1,added_node1);i++){var other=get_in_edge(g1,added_node1,i);if(in_1[other]==core_len)in_1[other]=0}if(out_1[added_node1]==core_len)out_1[added_node1]=0;for(var i=0;i<out_edge_count(g1,added_node1);i++){var other=get_out_edge(g1,added_node1,i);if(out_1[other]==core_len)out_1[other]=
0}var node2=core_1[added_node1];if(in_2[node2]==core_len)in_2[node2]=0;for(var i=0;i<in_edge_count(g2,node2);i++){var other=get_in_edge(g2,node2,i);if(in_2[other]==core_len)in_2[other]=0}if(out_2[node2]==core_len)out_2[node2]=0;for(var i=0;i<out_edge_count(g2,node2);i++){var other=get_out_edge(g2,node2,i);if(out_2[other]==core_len)out_2[other]=0}core_1[added_node1]=NULL_NODE;core_2[node2]=NULL_NODE;state.core_len=state.orig_core_len;state.added_node1=NULL_NODE}}function state_clone(state){var new_state=
{};new_state.g1=state.g1;new_state.g2=state.g2;new_state.node_comp=state.node_comp;new_state.edge_comp=state.edge_comp;new_state.n1=state.n1;new_state.n2=state.n2;new_state.order=state.order;new_state.core_len=new_state.orig_core_len=state.core_len;new_state.t1in_len=state.t1in_len;new_state.t1out_len=state.t1out_len;new_state.t1both_len=state.t1both_len;new_state.t2in_len=state.t2in_len;new_state.t2out_len=state.t2out_len;new_state.t2both_len=state.t2both_len;new_state.added_node1=NULL_NODE;new_state.core_1=
state.core_1;new_state.core_2=state.core_2;new_state.in_1=state.in_1;new_state.in_2=state.in_2;new_state.out_1=state.out_1;new_state.out_2=state.out_2;new_state.share_count=state.share_count;state.share_count[0]+=1;return new_state}exports.replace=function(graph,rnode_ids,new_node_attr){var nodes=graph.nodes;var edges=graph.edges;var new_node_id=gen_node_id(graph);for(var i=0;i<rnode_ids.length;i++){var rnode_id=rnode_ids[i];remove_node(graph,rnode_id);for(var j=0;j<edges.length;j+=3){if(edges[j]==
rnode_id)edges[j]=new_node_id;if(edges[j+1]==rnode_id)edges[j+1]=new_node_id;if(edges[j]==edges[j+1]){edges.splice(j,3);j-=3}}}append_node(graph,new_node_id,new_node_attr)};exports.reconnect_edges=function(graph,id1,id2,new_id1,new_id2){if(!has_edge(graph,id1,id2))throw"Edge not found";var edges=graph.edges;for(var i=0;i<edges.length;i+=3)if(edges[i]==id1&&edges[i+1]==id2){edges[i]=new_id1;edges[i+1]=new_id2}};exports.enforce_acyclic=function(graph,main_node){if(!main_node)var main_node=get_sink_nodes(graph)[0];
var edges=graph.edges;if(!edges.length)return graph;var graph_data={};var count=0;for(var i=0;i<edges.length;i=i+3){if(edges[i+1]in graph_data)graph_data[edges[i+1]].push(edges[i]);else graph_data[edges[i+1]]=[edges[i]];count++}var tracking=[];var wrong_edges=[];function find_redundant_edges(node,top_edges){var index=tracking.indexOf(node);if(index!=-1){var cycle=tracking.slice(tracking.indexOf(node));if(graph_data[cycle[cycle.length-1]].indexOf(cycle[0])!=-1){wrong_edges.push([node,cycle[cycle.length-
1]]);return}}tracking.push(node);for(var i=0;i<top_edges.length;i++)if(top_edges[i]in graph_data)find_redundant_edges(top_edges[i],graph_data[top_edges[i]])}find_redundant_edges(main_node,graph_data[main_node]);for(var i=0;i<wrong_edges.length;i++){var count=0;for(var k=0;k<edges.length;k=k+3){if(wrong_edges[i][1]==edges[k+1]&&wrong_edges[i][0]==edges[k])remove_edge(graph,edges[k],edges[k+1],count);count++}}return graph};exports.debug_dot=function(graph,node_label_cb,edge_label_cb){var nodes=graph.nodes;
var edges=graph.edges;var dot_str="digraph debug {\n";dot_str+="    ";dot_str+="node [shape=box];\n";for(var i=0;i<nodes.length;i+=2){var node=nodes[i];var attr=nodes[i+1];var label=node_label_cb?node_label_cb(node,attr):String(node);dot_str+="    ";dot_str+=String(node)+' [label="'+label.replace(/\"/g,'\\"')+'"];\n'}for(var i=0;i<edges.length;i+=3){var node1=edges[i];var node2=edges[i+1];var attr=edges[i+2];dot_str+="    ";dot_str+=String(node1)+" -> "+String(node2);if(edge_label_cb)dot_str+=' [label="'+
edge_label_cb(node1,node2,attr)+'"]';dot_str+=";\n"}dot_str+="}";return dot_str}};b4w.module["__ipc"]=function(exports,require){var IN_LOADED=exports.IN_LOADED=0;var IN_COLLISION=exports.IN_COLLISION=1;var IN_COLLISION_POS_NORM=exports.IN_COLLISION_POS_NORM=2;var IN_COLLISION_IMPULSE=exports.IN_COLLISION_IMPULSE=3;var IN_ERROR=exports.IN_ERROR=4;var IN_FBMSG=exports.IN_FBMSG=5;var IN_FLOATER_BOB_TRANSFORM=exports.IN_FLOATER_BOB_TRANSFORM=6;var IN_LOG=exports.IN_LOG=7;var IN_PROP_OFFSET=exports.IN_PROP_OFFSET=8;var IN_RAY_HIT=exports.IN_RAY_HIT=9;var IN_RAY_HIT_POS_NORM=exports.IN_RAY_HIT_POS_NORM=
10;var IN_REMOVE_RAY_TEST=exports.IN_REMOVE_RAY_TEST=11;var IN_TRANSFORM=exports.IN_TRANSFORM=12;var IN_VEHICLE_SPEED=exports.IN_VEHICLE_SPEED=13;var IN_PING=exports.IN_PING=14;var IN_FPS=exports.IN_FPS=15;var IN_DEBUG_STATS=exports.IN_DEBUG_STATS=16;var OUT_INIT=exports.OUT_INIT=100;var OUT_ACTIVATE=exports.OUT_ACTIVATE=101;var OUT_ADD_BOAT_BOB=exports.OUT_ADD_BOAT_BOB=102;var OUT_ADD_CAR_WHEEL=exports.OUT_ADD_CAR_WHEEL=103;var OUT_ADD_FLOATER_BOB=exports.OUT_ADD_FLOATER_BOB=104;var OUT_APPEND_BOUNDING_BODY=
exports.OUT_APPEND_BOUNDING_BODY=105;var OUT_APPEND_BOAT=exports.OUT_APPEND_BOAT=106;var OUT_APPEND_CAR=exports.OUT_APPEND_CAR=107;var OUT_APPEND_CHARACTER=exports.OUT_APPEND_CHARACTER=108;var OUT_APPEND_COLLISION_TEST=exports.OUT_APPEND_COLLISION_TEST=109;var OUT_APPEND_CONSTRAINT=exports.OUT_APPEND_CONSTRAINT=110;var OUT_APPEND_FLOATER=exports.OUT_APPEND_FLOATER=111;var OUT_APPEND_GHOST_MESH_BODY=exports.OUT_APPEND_GHOST_MESH_BODY=112;var OUT_APPEND_STATIC_MESH_BODY=exports.OUT_APPEND_STATIC_MESH_BODY=
113;var OUT_APPEND_WATER=exports.OUT_APPEND_WATER=114;var OUT_REMOVE_BODY=exports.OUT_REMOVE_BODY=115;var OUT_APPLY_CENTRAL_FORCE=exports.OUT_APPLY_CENTRAL_FORCE=116;var OUT_APPLY_COLLISION_IMPULSE_TEST=exports.OUT_APPLY_COLLISION_IMPULSE_TEST=117;var OUT_APPLY_TORQUE=exports.OUT_APPLY_TORQUE=118;var OUT_CHARACTER_JUMP=exports.OUT_CHARACTER_JUMP=119;var OUT_CHARACTER_ROTATION_INCREMENT=exports.OUT_CHARACTER_ROTATION_INCREMENT=120;var OUT_CLEAR_COLLISION_IMPULSE_TEST=exports.OUT_CLEAR_COLLISION_IMPULSE_TEST=
121;var OUT_DISABLE_SIMULATION=exports.OUT_DISABLE_SIMULATION=122;var OUT_ENABLE_SIMULATION=exports.OUT_ENABLE_SIMULATION=123;var OUT_PAUSE=exports.OUT_PAUSE=124;var OUT_APPEND_RAY_TEST=exports.OUT_APPEND_RAY_TEST=125;var OUT_REMOVE_RAY_TEST=exports.OUT_REMOVE_RAY_TEST=126;var OUT_CHANGE_RAY_TEST_FROM_TO=exports.OUT_CHANGE_RAY_TEST_FROM_TO=127;var OUT_REMOVE_COLLISION_TEST=exports.OUT_REMOVE_COLLISION_TEST=128;var OUT_REMOVE_CONSTRAINT=exports.OUT_REMOVE_CONSTRAINT=129;var OUT_RESUME=exports.OUT_RESUME=
130;var OUT_SET_CHARACTER_FLY_VELOCITY=exports.OUT_SET_CHARACTER_FLY_VELOCITY=131;var OUT_SET_CHARACTER_HOR_ROTATION=exports.OUT_SET_CHARACTER_HOR_ROTATION=132;var OUT_SET_CHARACTER_MOVE_DIR=exports.OUT_SET_CHARACTER_MOVE_DIR=133;var OUT_SET_CHARACTER_MOVE_TYPE=exports.OUT_SET_CHARACTER_MOVE_TYPE=134;var OUT_SET_CHARACTER_ROTATION=exports.OUT_SET_CHARACTER_ROTATION=135;var OUT_SET_CHARACTER_RUN_VELOCITY=exports.OUT_SET_CHARACTER_RUN_VELOCITY=136;var OUT_SET_CHARACTER_VERT_ROTATION=exports.OUT_SET_CHARACTER_VERT_ROTATION=
137;var OUT_SET_CHARACTER_WALK_VELOCITY=exports.OUT_SET_CHARACTER_WALK_VELOCITY=138;var OUT_SET_GRAVITY=exports.OUT_SET_GRAVITY=139;var OUT_SET_LINEAR_VELOCITY=exports.OUT_SET_LINEAR_VELOCITY=140;var OUT_SET_TRANSFORM=exports.OUT_SET_TRANSFORM=141;var OUT_SET_WATER_TIME=exports.OUT_SET_WATER_TIME=142;var OUT_ADD_WATER_WRAPPER=exports.OUT_ADD_WATER_WRAPPER=143;var OUT_UPDATE_BOAT_CONTROLS=exports.OUT_UPDATE_BOAT_CONTROLS=144;var OUT_UPDATE_CAR_CONTROLS=exports.OUT_UPDATE_CAR_CONTROLS=145;var OUT_PING=
exports.OUT_PING=146;var OUT_DEBUG=exports.OUT_DEBUG=147;var OUT_UPDATE_WORLD=exports.OUT_UPDATE_WORLD=148;var _worker_listeners=b4w.worker_listeners;var _worker_namespaces=b4w.worker_namespaces;var _msg_cache_IN_TRANSFORM={msg_id:IN_TRANSFORM,body_id:0,time:0,trans:new Float32Array(3),quat:new Float32Array(4),linvel:new Float32Array(3),angvel:new Float32Array(3),len:0};var _msg_cache_IN_PROP_OFFSET={msg_id:IN_PROP_OFFSET,chassis_hull_body_id:0,prop_ind:0,trans:new Float32Array(3),quat:new Float32Array(4),
len:0};var _msg_cache_IN_RAY_HIT={msg_id:IN_RAY_HIT,id:0,body_id_hit:0,hit_fract:0,hit_time:0,len:0};var _msg_cache_IN_RAY_HIT_POS_NORM={msg_id:IN_RAY_HIT_POS_NORM,id:0,body_id_hit:0,hit_fract:0,hit_time:0,hit_pos:new Float32Array(3),hit_norm:new Float32Array(3),len:0};var _msg_cache_IN_COLLISION={msg_id:IN_COLLISION,body_id_a:0,body_id_b:0,result:0,len:0};var _msg_cache_IN_COLLISION_POS_NORM={msg_id:IN_COLLISION_POS_NORM,body_id_a:0,body_id_b:0,result:0,coll_point:new Float32Array(3),coll_norm:new Float32Array(3),
coll_dist:0,len:0};var _msg_cache_OUT_SET_TRANSFORM={msg_id:OUT_SET_TRANSFORM,body_id:0,trans:new Float32Array(3),quat:new Float32Array(4),len:0};var _msg_cache_list=[_msg_cache_IN_TRANSFORM,_msg_cache_IN_PROP_OFFSET,_msg_cache_IN_RAY_HIT,_msg_cache_IN_RAY_HIT_POS_NORM,_msg_cache_IN_COLLISION,_msg_cache_IN_COLLISION_POS_NORM,_msg_cache_OUT_SET_TRANSFORM];exports.create_worker=function(path,fallback){var worker={is_main:path?true:false,web_worker:null,buf_arr:[],fb_worker_ns:""};if(fallback){var web_worker_fallback=
{addEventListener:function(type,listener,useCapture){if(type!="message")panic("Wrong web worker event");set_fallback_listener(worker.fb_worker_ns,worker.is_main,listener)},removeEventListener:function(type,listener,useCapture){if(type!="message")panic("Wrong web worker event");set_fallback_listener(worker.fb_worker_ns,worker.is_main,null)},postMessage:function(msg,msg2){var listener=find_fallback_listener(worker.fb_worker_ns,!worker.is_main);listener({"data":msg})},terminate:function(){for(var i=
0;i<_worker_namespaces.length;i+=2)if(_worker_namespaces[i+1]==worker.fb_worker_ns){_worker_listeners.splice(i,2);_worker_namespaces.splice(i,2);return}}};worker.web_worker=web_worker_fallback;if(worker.is_main){var m_util=require("__util");var m_cont=require("__container");var main_ns=b4w.get_namespace(require);var worker_ns=m_util.unique_name(main_ns+"_worker");_worker_namespaces.push(main_ns);_worker_namespaces.push(worker_ns);_worker_listeners.push(null);_worker_listeners.push(null);worker.fb_worker_ns=
worker_ns;if(m_cont.find_script(path)){var uranium_js=m_cont.find_script(path);uranium_js.addEventListener("load",function(){b4w.require("__bindings",worker.fb_worker_ns)},false)}else{var uranium_js=document.createElement("script");uranium_js.src=path;uranium_js.defer="defer";uranium_js.async="async";uranium_js.addEventListener("load",function(){b4w.require("__bindings",worker.fb_worker_ns)},false);document.head.appendChild(uranium_js)}}else worker.fb_worker_ns=b4w.get_namespace(require)}else if(path)worker.web_worker=
new Worker(path);else worker.web_worker=self;return worker};function set_fallback_listener(worker_ns,is_main,listener){for(var i=0;i<_worker_namespaces.length;i+=2)if(_worker_namespaces[i+1]==worker_ns)_worker_listeners[i+Number(!is_main)]=listener}function find_fallback_listener(worker_ns,is_main){for(var i=0;i<_worker_namespaces.length;i+=2)if(_worker_namespaces[i+1]==worker_ns)return _worker_listeners[i+Number(!is_main)];return null}exports.attach_handler=function(worker,process_message_cb){assign_msg_cache_length(_msg_cache_list);
var preprocess_message_cb=function(event_data){if(event_data.constructor==ArrayBuffer)event_data=new Float32Array(event_data);else if(event_data[0].constructor==ArrayBuffer){for(var i=0;i<event_data.length;i++)preprocess_message_cb(event_data[i]);return}var msg_id=event_data[0]|0;switch(msg_id){case IN_TRANSFORM:var data=_msg_cache_IN_TRANSFORM;data.body_id=event_data[1]|0;data.time=event_data[2];data.trans[0]=event_data[3];data.trans[1]=event_data[4];data.trans[2]=event_data[5];data.quat[0]=event_data[6];
data.quat[1]=event_data[7];data.quat[2]=event_data[8];data.quat[3]=event_data[9];data.linvel[0]=event_data[10];data.linvel[1]=event_data[11];data.linvel[2]=event_data[12];data.angvel[0]=event_data[13];data.angvel[1]=event_data[14];data.angvel[2]=event_data[15];break;case IN_PROP_OFFSET:var data=_msg_cache_IN_PROP_OFFSET;data.chassis_hull_body_id=event_data[1]|0;data.prop_ind=event_data[2]|0;data.trans[0]=event_data[3];data.trans[1]=event_data[4];data.trans[2]=event_data[5];data.quat[0]=event_data[6];
data.quat[1]=event_data[7];data.quat[2]=event_data[8];data.quat[3]=event_data[9];break;case IN_RAY_HIT:var data=_msg_cache_IN_RAY_HIT;data.id=event_data[1]|0;data.body_id_hit=event_data[2]|0;data.hit_fract=event_data[3];data.hit_time=event_data[4];break;case IN_RAY_HIT_POS_NORM:var data=_msg_cache_IN_RAY_HIT_POS_NORM;data.id=event_data[1]|0;data.body_id_hit=event_data[2]|0;data.hit_fract=event_data[3];data.hit_time=event_data[4];data.hit_pos[0]=event_data[5];data.hit_pos[1]=event_data[6];data.hit_pos[2]=
event_data[7];data.hit_norm[0]=event_data[8];data.hit_norm[1]=event_data[9];data.hit_norm[2]=event_data[10];break;case IN_COLLISION:var data=_msg_cache_IN_COLLISION;data.body_id_a=event_data[1]|0;data.body_id_b=event_data[2]|0;data.result=!!event_data[3];break;case IN_COLLISION_POS_NORM:var data=_msg_cache_IN_COLLISION_POS_NORM;data.body_id_a=event_data[1]|0;data.body_id_b=event_data[2]|0;data.result=!!event_data[3];data.coll_point[0]=event_data[4];data.coll_point[1]=event_data[5];data.coll_point[2]=
event_data[6];data.coll_norm[0]=event_data[7];data.coll_norm[1]=event_data[8];data.coll_norm[2]=event_data[9];data.coll_dist=event_data[10];break;case OUT_SET_TRANSFORM:var data=_msg_cache_OUT_SET_TRANSFORM;data.body_id=event_data[1]|0;data.trans[0]=event_data[2];data.trans[1]=event_data[3];data.trans[2]=event_data[4];data.quat[0]=event_data[5];data.quat[1]=event_data[6];data.quat[2]=event_data[7];data.quat[3]=event_data[8];break;default:var data=event_data;break}process_message_cb(worker,msg_id,
data)};worker.web_worker.addEventListener("message",function(event){preprocess_message_cb(event.data)},false)};function assign_msg_cache_length(msg_cache_list){for(var i=0;i<msg_cache_list.length;i++){var cache=msg_cache_list[i];var len=0;for(var j in cache){var prop=cache[j];switch(prop.constructor){case Float32Array:len+=prop.length;break;case Number:len+=1;break;default:break}}len-=1;cache.len=len}}exports.cleanup=function(){};exports.post_msg=function(worker,msg_id){if(!worker)return;switch(msg_id){case IN_TRANSFORM:var data=
_msg_cache_IN_TRANSFORM;var msg=new Float32Array(data.len);msg[0]=data.msg_id;msg[1]=data.body_id;msg[2]=data.time;msg[3]=data.trans[0];msg[4]=data.trans[1];msg[5]=data.trans[2];msg[6]=data.quat[0];msg[7]=data.quat[1];msg[8]=data.quat[2];msg[9]=data.quat[3];msg[10]=data.linvel[0];msg[11]=data.linvel[1];msg[12]=data.linvel[2];msg[13]=data.angvel[0];msg[14]=data.angvel[1];msg[15]=data.angvel[2];worker.buf_arr.push(msg.buffer);break;case IN_PROP_OFFSET:var data=_msg_cache_IN_PROP_OFFSET;var msg=new Float32Array(data.len);
msg[0]=data.msg_id;msg[1]=data.chassis_hull_body_id;msg[2]=data.prop_ind;msg[3]=data.trans[0];msg[4]=data.trans[1];msg[5]=data.trans[2];msg[6]=data.quat[0];msg[7]=data.quat[1];msg[8]=data.quat[2];msg[9]=data.quat[3];worker.buf_arr.push(msg.buffer);break;case IN_RAY_HIT:var data=_msg_cache_IN_RAY_HIT;var msg=new Float32Array(data.len);msg[0]=data.msg_id;msg[1]=data.id;msg[2]=data.body_id_hit;msg[3]=data.hit_fract;msg[4]=data.hit_time;worker.buf_arr.push(msg.buffer);break;case IN_RAY_HIT_POS_NORM:var data=
_msg_cache_IN_RAY_HIT_POS_NORM;var msg=new Float32Array(data.len);msg[0]=data.msg_id;msg[1]=data.id;msg[2]=data.body_id_hit;msg[3]=data.hit_fract;msg[4]=data.hit_time;msg[5]=data.hit_pos[0];msg[6]=data.hit_pos[1];msg[7]=data.hit_pos[2];msg[8]=data.hit_norm[0];msg[9]=data.hit_norm[1];msg[10]=data.hit_norm[2];worker.buf_arr.push(msg.buffer);break;case IN_COLLISION:var data=_msg_cache_IN_COLLISION;var msg=new Float32Array(data.len);msg[0]=data.msg_id;msg[1]=data.body_id_a;msg[2]=data.body_id_b;msg[3]=
data.result;worker.buf_arr.push(msg.buffer);break;case IN_COLLISION_POS_NORM:var data=_msg_cache_IN_COLLISION_POS_NORM;var msg=new Float32Array(data.len);msg[0]=data.msg_id;msg[1]=data.body_id_a;msg[2]=data.body_id_b;msg[3]=data.result;msg[4]=data.coll_point[0];msg[5]=data.coll_point[1];msg[6]=data.coll_point[2];msg[7]=data.coll_norm[0];msg[8]=data.coll_norm[1];msg[9]=data.coll_norm[2];msg[10]=data.coll_dist;worker.buf_arr.push(msg.buffer);break;case OUT_SET_TRANSFORM:var data=_msg_cache_OUT_SET_TRANSFORM;
var msg=new Float32Array(data.len);msg[0]=data.msg_id;msg[1]=data.body_id;msg[2]=data.trans[0];msg[3]=data.trans[1];msg[4]=data.trans[2];msg[5]=data.quat[0];msg[6]=data.quat[1];msg[7]=data.quat[2];msg[8]=data.quat[3];worker.buf_arr.push(msg.buffer);break;default:var msg=[];for(var i=1;i<arguments.length;i++)msg.push(arguments[i]);worker.web_worker.postMessage(msg);break}};exports.post_msg_arr=function(worker){if(!worker||!worker.buf_arr.length)return;worker.web_worker.postMessage(worker.buf_arr);
worker.buf_arr.length=0};exports.get_msg_cache=function(msg_id){switch(msg_id){case IN_TRANSFORM:return _msg_cache_IN_TRANSFORM;case IN_PROP_OFFSET:return _msg_cache_IN_PROP_OFFSET;case IN_RAY_HIT:return _msg_cache_IN_RAY_HIT;case IN_RAY_HIT_POS_NORM:return _msg_cache_IN_RAY_HIT_POS_NORM;case IN_COLLISION:return _msg_cache_IN_COLLISION;case IN_COLLISION_POS_NORM:return _msg_cache_IN_COLLISION_POS_NORM;case OUT_SET_TRANSFORM:return _msg_cache_OUT_SET_TRANSFORM;default:return null}};exports.terminate=
function(worker){worker.web_worker.terminate();worker.web_worker=null};exports.is_active=function(worker){return!!worker.web_worker};exports.is_fallback=function(worker){return!!worker.fb_worker_ns}};b4w.module["__hud"]=function(exports,require){var m_graph=require("__graph");var m_print=require("__print");var START_POINT_X=30;var START_POINT_Y=80;var LINE_WIDTH=20;var OFFSETS=[5,19,3,10,4,3,5];var _canvas_context=null;var _carriage=[0,0];exports.init=function(canvas_elem){var ctx=canvas_elem.getContext("2d");set_style(ctx);_canvas_context=ctx;return ctx};function set_style(ctx){ctx.font="bold 15px Courier";ctx.textBaseline="middle";ctx.shadowBlur=0;ctx.shadowColor=null}exports.update_dim=function(){if(_canvas_context)set_style(_canvas_context)};
exports.reset=function(){var ctx=_canvas_context;if(!ctx)return;ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);ctx.fillStyle="rgba(0,0,0,0.5)";ctx.fillRect(0,0,ctx.canvas.width,ctx.canvas.height);reset_carriage()};exports.show_debug_info=function(scenes,elapsed){var ctx=_canvas_context;if(!ctx)return;ctx.textAlign="left";ctx.fillStyle="rgba(0,255,0,255)";print(" FPS",(1/elapsed).toFixed(2));new_line();var sum_bundles=0;var sum_rcalls=0;for(var i=0;i<scenes.length;i++){var sum=show_debug_info_scene(scenes[i]);
sum_bundles+=sum[0];sum_rcalls+=sum[1];new_line()}print(" -----------------------------------------------");print("    ","TOTAL ACTIVE","","",sum_rcalls,"of",sum_bundles)};function show_debug_info_scene(scene){print(' SCENE "'+scene["name"]+'"');if(!scene._render){print("No INFO");return}var sum_bundles=0;var sum_rcalls=0;var next_slot=2;var graph=scene._render.graph;m_graph.traverse(graph,function(node,attr){var subs=attr;if(subs.type=="SINK"){print(" (F)",subs.type);return}var type=subs.type;var size=
Math.round(subs.camera.width)+"x"+Math.round(subs.camera.height);var bundles=subs.bundles.length;var rcalls=subs.debug_render_calls;if(subs.type=="MAIN_CUBE_REFLECT")bundles*=6;var is_active=subs.enqueue&&subs.do_render;if(is_active)print(" (A)",type,subs.num_lights,size,rcalls,"of",bundles);else print(" (P)",type,subs.num_lights,size,rcalls,"of",bundles);subs.debug_render_calls=0;if(is_active){sum_bundles+=bundles;sum_rcalls+=rcalls}});return[sum_bundles,sum_rcalls]}function reset_carriage(){_carriage[0]=
0;_carriage[1]=0}function new_line(){_carriage[0]++}exports.print=function(){var ctx=_canvas_context;if(!ctx)return;ctx.textAlign="left";ctx.fillStyle="rgba(0,255,0,255)";print.apply(Math,arguments)};function print(){var x=START_POINT_X;var y=START_POINT_Y+_carriage[0]*LINE_WIDTH;var text=arguments[0];for(var i=1;i<arguments.length;i++){var arg=arguments[i];var num_spaces=OFFSETS[i]-String(arg).length;text+=spaces(num_spaces)+arguments[i]}new_line();_canvas_context.fillText(text,x,y)}function spaces(n){var s=
"";for(var i=0;i<n;i++)s+=" ";return s}function wrap_text(context,text,x,y,maxWidth,lineHeight){var words=text.split(" ");var line="";for(var n=0;n<words.length;n++){var testLine=line+words[n]+" ";var metrics=context.measureText(testLine);var testWidth=metrics.width;if(testWidth>maxWidth){context.fillText(line,x,y);line=words[n]+" ";y+=lineHeight}else line=testLine}context.fillText(line,x,y)}exports.plot_array=function(header,slot,arr,arg_min,arg_max,val_min,val_max){var ctx=_canvas_context;if(!ctx)return;
var box=create_strip_box(slot);box_split_v(box,4,5,box);ctx.textAlign="center";ctx.fillStyle="#00FF00";_canvas_context.fillText(header,box_mid_h(box),box.y-10);ctx.strokeStyle="#00FF00";ctx.lineWidth=.5;ctx.beginPath();ctx.moveTo(box.x,box.y);ctx.lineTo(box.x+box.w,box.y);ctx.lineTo(box.x+box.w,box.y+box.h);ctx.lineTo(box.x,box.y+box.h);ctx.closePath();ctx.stroke();if(!val_min&&!val_max){val_min=1E6;val_max=-1E6;for(var i=0;i<arr.length;i++){val_min=Math.min(val_min,arr[i]);val_max=Math.max(val_max,
arr[i])}}ctx.textAlign="right";_canvas_context.fillText(String(val_min),box.x-10,box.y+box.h);_canvas_context.fillText(String(val_max),box.x-10,box.y);ctx.textAlign="center";_canvas_context.fillText(String(arg_min),box.x,box.y+box.h+15);_canvas_context.fillText(String(arg_max),box.x+box.w,box.y+box.h+15);ctx.strokeStyle="#FF0000";ctx.lineWidth=1.5;ctx.beginPath();var dx=box.w/(arr.length-1);var dy=box.h/(val_max-val_min);for(var i=0;i<arr.length;i++){var x=box.x+dx*i;var y=box.y+box.h-(arr[i]-val_min)*
dy;if(i==0)ctx.moveTo(x,y);else ctx.lineTo(x,y)}ctx.stroke()};function box_create(){return{x:0,y:0,w:0,h:0}}function box_set(x,y,w,h,dest){dest.x=x;dest.y=y;dest.w=w;dest.h=h;return dest}function box_split_h(box,part,parts,dest){var dw=box.w/parts;dest.x=box.x+dw*part;dest.y=box.y;dest.w=dw;dest.h=box.h;return dest}function box_split_v(box,part,parts,dest){var dh=box.h/parts;dest.x=box.x;dest.y=box.y+dh*part;dest.w=box.w;dest.h=dh;return dest}function box_trim_h(box,ratio,dest){var dw=box.w*ratio;
dest.x=box.x+dw;dest.y=box.y;dest.w=box.w-2*dw;dest.h=box.h;return dest}function box_trim_v(box,ratio,dest){var dh=box.h*ratio;dest.x=box.x;dest.y=box.y+dh;dest.w=box.w;dest.h=box.h-2*dh;return dest}function box_mid_h(box){return box.x+box.w/2}function box_mid_v(box){return box.y+box.h/2}function box_debug_draw(box){var ctx=_canvas_context;var ss=ctx.strokeStyle;var lw=ctx.lineWidth;ctx.strokeStyle="#FF0000";ctx.lineWidth=.5;ctx.beginPath();ctx.moveTo(box.x,box.y);ctx.lineTo(box.x+box.w,box.y);ctx.lineTo(box.x+
box.w,box.y+box.h);ctx.lineTo(box.x,box.y+box.h);ctx.closePath();ctx.stroke();ctx.strokeStyle=ss;ctx.lineWidth=lw}function create_strip_box(slot){var ctx=_canvas_context;var box=box_create();box_set(0,0,ctx.canvas.width,ctx.canvas.height,box);box_trim_h(box,.01,box);box_trim_v(box,.02,box);box_split_h(box,slot,8,box);box_trim_h(box,.02,box);return box}exports.draw_mixer_strip=function(id,is_active,slot,params,active_param,mute,solo){var ctx=_canvas_context;if(!ctx)return;ctx.textAlign="center";ctx.fillStyle=
"#00FF00";ctx.font="bold 12px Courier";var box_strip=create_strip_box(slot);var strip_title=is_active?"["+id+"]":id;_canvas_context.fillText(strip_title,box_mid_h(box_strip),box_strip.y);if(mute>=0)_canvas_context.fillText(mute?"[M]":"[ ]",box_mid_h(box_strip)-15,box_strip.y+30);if(solo>=0)_canvas_context.fillText(solo?"[S]":"[ ]",box_mid_h(box_strip)+15,box_strip.y+30);var box_param=box_create();for(var i=0;i<params.length;i++){var param=params[i];var is_volume=param[0]=="VOLUME";if(is_volume)box_set(box_strip.x,
box_strip.y+350,box_strip.w,250,box_param);else box_set(box_strip.x,box_strip.y+10+50*i,box_strip.w,box_strip.h,box_param);draw_param_bar(ctx,is_volume,box_param,param,i==active_param)}};function draw_param_bar(ctx,vertical,box,param,is_active){var name=param[0];var value=param[1];var min=param[2];var max=param[3];var steps=param[4];var is_log=param[5];var step=(max-min)/steps;if(step<1)var digits=Math.floor(1/step-1E-5).toFixed(0).length;else var digits=0;if(is_log)var val_pos_factor=Math.log(value/
min)/Math.log(max/min);else var val_pos_factor=(value-min)/(max-min);ctx.textAlign="center";if(is_active)ctx.fillText("["+name+"]",box_mid_h(box),box.y);else ctx.fillText(name,box_mid_h(box),box.y);ctx.strokeStyle="#00FF00";if(vertical)ctx.lineWidth=3;else ctx.lineWidth=1;if(vertical){ctx.textAlign="right";ctx.fillText(max.toFixed(digits),box_mid_h(box)-10,box.y+15);ctx.textAlign="right";ctx.fillText(min.toFixed(digits),box_mid_h(box)-10,box.y+box.h-15)}else{ctx.textAlign="right";ctx.fillText(min.toFixed(digits),
box.x+28,box.y+15);ctx.textAlign="left";ctx.fillText(max.toFixed(digits),box.x+box.w-28,box.y+15)}ctx.beginPath();if(vertical){var val_pos_y=box.y+15+(box.h-30)*(1-val_pos_factor);ctx.moveTo(box_mid_h(box),box.y+15);ctx.lineTo(box_mid_h(box),box.y+box.h-15);ctx.moveTo(box_mid_h(box)-5,box.y+15);ctx.lineTo(box_mid_h(box)+5,box.y+15);ctx.moveTo(box_mid_h(box)-5,box.y+box.h-15);ctx.lineTo(box_mid_h(box)+5,box.y+box.h-15);ctx.moveTo(box_mid_h(box)-5,val_pos_y);ctx.lineTo(box_mid_h(box)+5,val_pos_y)}else{var val_pos_x=
box.x+30+(box.w-60)*val_pos_factor;ctx.moveTo(box.x+30,box.y+15);ctx.lineTo(box.x+box.w-30,box.y+15);ctx.moveTo(box.x+30,box.y+15-5);ctx.lineTo(box.x+30,box.y+15+5);ctx.moveTo(box.x+box.w-30,box.y+15-5);ctx.lineTo(box.x+box.w-30,box.y+15+5);ctx.moveTo(val_pos_x,box.y+15-5);ctx.lineTo(val_pos_x,box.y+15+5)}ctx.stroke();if(name=="EQ_Q"){var Q=value;var Y=1+1/(2*Q*Q)+Math.sqrt((2+1/(Q*Q))*(2+1/(Q*Q))/4-1);var N=Math.log(Y)/Math.log(2);if(vertical){ctx.textAlign="left";ctx.fillText(value.toFixed(digits),
box_mid_h(box)+10,val_pos_y);ctx.textAlign="left";ctx.fillText("("+N.toFixed(digits+1)+")",box_mid_h(box)+10,val_pos_y+10)}else{ctx.textAlign="right";ctx.fillText(value.toFixed(digits),val_pos_x,box.y+30);ctx.textAlign="left";ctx.fillText("("+N.toFixed(digits+1)+")",val_pos_x,box.y+30)}}else if(vertical){ctx.textAlign="left";ctx.fillText(value.toFixed(digits),box_mid_h(box)+10,val_pos_y)}else{ctx.textAlign="center";ctx.fillText(value.toFixed(digits),val_pos_x,box.y+30)}}};b4w.module["__renderer"]=function(exports,require){var m_cam=require("__camera");var m_cfg=require("__config");var m_debug=require("__debug");var m_textures=require("__textures");var m_util=require("__util");var cfg_def=m_cfg.defaults;var USE_BACKFACE_CULLING=true;var DEBUG_DISABLE_RENDER_LOCK=false;var SHADOW_BG_COLOR=[1,1,1,1];var DEPTH_BG_COLOR=[1,1,1,1];var COLOR_PICKING_BG_COLOR=[0,0,0,1];var BLACK_BG_COLOR=[0,0,0,0];var SKY_HACK_COLOR=new Uint8Array([.36*255,.56*255,.96*255,255]);var FLOAT_BYTE_SIZE=
4;var CUBEMAP_UPPER_SIDE=2;var CUBEMAP_BOTTOM_SIDE=3;var JITTER=[new Float32Array([.25,-.25]),new Float32Array([-.25,.25])];var SUBSAMPLE_IND=[new Float32Array([1,1,1,0]),new Float32Array([2,2,2,0])];var _gl=null;var _subpixel_index=0;var _ivec4_tmp=new Uint8Array(4);exports.setup_context=function(gl){var bc=cfg_def.background_color;gl.clearColor(bc[0],bc[1],bc[2],bc[3]);gl.clearDepth(1);gl.enable(gl.DEPTH_TEST);gl.depthFunc(gl.LEQUAL);if(USE_BACKFACE_CULLING){gl.enable(gl.CULL_FACE);gl.frontFace(gl.CCW);
gl.cullFace(gl.BACK)}else gl.disable(gl.CULL_FACE);gl.enable(gl.BLEND);gl.blendFunc(gl.ONE,gl.ONE_MINUS_SRC_ALPHA);_gl=gl};exports.draw=function(subscene){if(!subscene.do_render)return;prepare_subscene(subscene);if(subscene.type=="MAIN_CUBE_REFLECT")draw_cube_reflection_subs(subscene);else draw_subs(subscene);m_debug.check_gl("draw subscene: "+subscene.type);_gl.bindFramebuffer(_gl.FRAMEBUFFER,null)};function draw_cube_reflection_subs(subscene){var camera=subscene.camera;var color_attachment=camera.color_attachment;
var w_tex=color_attachment.w_texture;var v_matrs=subscene.cube_view_matrices;for(var i=0;i<6;i++){var w_target=get_cube_target_by_id(i);camera.view_matrix=subscene.cube_view_matrices[i];m_cam.calc_sky_vp_inverse(camera);_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,w_target,w_tex,0);clear_binded_framebuffer(subscene);var bundles=subscene.bundles;for(var j=0;j<bundles.length;j++)bundles[j].do_render=bundles[j].do_render_cube[i];draw_subs(subscene)}}function draw_subs(subscene){var camera=
subscene.camera;var bundles=subscene.bundles;for(var i=0;i<bundles.length;i++){var bundle=bundles[i];if(bundle.do_render){var obj_render=bundle.obj_render;var batch=bundle.batch;draw_bundle(subscene,camera,obj_render,batch)}}}exports.clear=function(subscene){var camera=subscene.camera;_gl.bindFramebuffer(_gl.FRAMEBUFFER,camera.framebuffer);clear_binded_framebuffer(subscene)};function prepare_subscene(subscene){var camera=subscene.camera;_gl.bindFramebuffer(_gl.FRAMEBUFFER,camera.framebuffer);if(subscene.assign_texture){var tex=
camera.color_attachment;_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,tex.w_target,tex.w_texture,0)}_gl.viewport(0,0,camera.width,camera.height);if(subscene.type!="MAIN_CUBE_REFLECT")clear_binded_framebuffer(subscene);if(subscene.blend)_gl.enable(_gl.BLEND);else _gl.disable(_gl.BLEND);if(subscene.depth_test)_gl.enable(_gl.DEPTH_TEST);else _gl.disable(_gl.DEPTH_TEST);if(subscene.need_perm_uniforms_update){update_subs_permanent_uniforms(subscene);subscene.need_perm_uniforms_update=
false}switch(subscene.type){case "DEPTH":if(cfg_def.ios_depth_hack){_gl.enable(_gl.POLYGON_OFFSET_FILL);_gl.polygonOffset(5,5)}else _gl.disable(_gl.POLYGON_OFFSET_FILL);_gl.cullFace(_gl.BACK);break;case "SHADOW_CAST":_gl.enable(_gl.POLYGON_OFFSET_FILL);_gl.polygonOffset(subscene.self_shadow_polygon_offset,subscene.self_shadow_polygon_offset);_gl.cullFace(_gl.BACK);break;case "MAIN_PLANE_REFLECT":_gl.disable(_gl.POLYGON_OFFSET_FILL);_gl.cullFace(_gl.FRONT);break;default:_gl.disable(_gl.POLYGON_OFFSET_FILL);
_gl.cullFace(_gl.BACK)}}function clear_binded_framebuffer(subscene){if(subscene){var bitfield=(subscene.clear_color?_gl.COLOR_BUFFER_BIT:0)|(subscene.clear_depth?_gl.DEPTH_BUFFER_BIT:0);if(!bitfield)return;switch(subscene.type){case "MAIN_GLOW":var bc=BLACK_BG_COLOR;break;case "SHADOW_CAST":var bc=SHADOW_BG_COLOR;break;case "DEPTH":var bc=DEPTH_BG_COLOR;break;case "COLOR_PICKING":case "COLOR_PICKING_XRAY":case "ANCHOR_VISIBILITY":var bc=COLOR_PICKING_BG_COLOR;break;case "OUTLINE_MASK":case "SMAA_BLENDING_WEIGHT_CALCULATION":case "SMAA_EDGE_DETECTION":var bc=
BLACK_BG_COLOR;break;default:var bc=cfg_def.background_color;break}}else{var bitfield=_gl.COLOR_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT;var bc=cfg_def.background_color}_gl.colorMask(true,true,true,true);_gl.depthMask(true);_gl.clearColor(bc[0],bc[1],bc[2],bc[3]);_gl.clear(bitfield)}function setup_smaa_jitter(subscene){var jitter=JITTER[_subpixel_index];var camera=subscene.camera;subscene.jitter_projection_space[0]=jitter[0]*2/camera.width;subscene.jitter_projection_space[1]=jitter[1]*2/camera.height;if(subscene.type==
"SMAA_BLENDING_WEIGHT_CALCULATION")subscene.jitter_subsample_ind=SUBSAMPLE_IND[_subpixel_index]}function draw_bundle(subscene,camera,obj_render,batch){var shader=batch.shader;_gl.useProgram(shader.program);var bufs_data=batch.bufs_data;var attribute_setters=batch.attribute_setters;var transient_uniform_setters=shader.transient_uniform_setters;var i=transient_uniform_setters.length;while(i--){var setter=transient_uniform_setters[i];setter.fun(_gl,setter.loc,subscene,obj_render,batch,camera)}var cm=
batch.color_mask;_gl.colorMask(cm,cm,cm,cm);_gl.depthMask(batch.depth_mask);if(USE_BACKFACE_CULLING)if(batch.use_backface_culling)_gl.enable(_gl.CULL_FACE);else _gl.disable(_gl.CULL_FACE);setup_textures(batch.textures);if(subscene.type=="SKY"){draw_sky_buffers(subscene,bufs_data,shader,obj_render,attribute_setters);subscene.debug_render_calls+=6}else{draw_buffers(bufs_data,attribute_setters,obj_render.va_frame);subscene.debug_render_calls++}}function draw_sky_buffers(subscene,bufs_data,shader,obj_render,
attribute_setters){var camera=subscene.camera;var uniforms=shader.uniforms;var color_attachment=camera.color_attachment;var w_tex=color_attachment.w_texture;var v_matrs=subscene.cube_view_matrices;for(var i=0;i<6;i++){var w_target=get_cube_target_by_id(i);if(cfg_def.clear_procedural_sky_hack){var w_target_cube=_gl.TEXTURE_CUBE_MAP;_gl.bindTexture(w_target_cube,w_tex);_gl.texImage2D(w_target,0,_gl.RGBA,1,1,0,_gl.RGBA,_gl.UNSIGNED_BYTE,SKY_HACK_COLOR)}else{_gl.uniformMatrix4fv(uniforms["u_cube_view_matrix"],
false,v_matrs[i]);_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,w_target,w_tex,0);draw_buffers(bufs_data,attribute_setters,obj_render.va_frame)}if(subscene.need_fog_update&&i!=CUBEMAP_BOTTOM_SIDE)update_subs_sky_fog(subscene,i)}}function update_subs_sky_fog(subscene,cubemap_side_ind){var col=_ivec4_tmp;if(cfg_def.clear_procedural_sky_hack)col.set(SKY_HACK_COLOR);else{_gl.readPixels(191,191,1,1,_gl.RGBA,_gl.UNSIGNED_BYTE,col);if(col[0]==255||col[1]==255||col[2]==255)_gl.readPixels(191,
220,1,1,_gl.RGBA,_gl.UNSIGNED_BYTE,col)}var res_r=col[0];var res_g=col[1];var res_b=col[2];res_r/=255;res_g/=255;res_b/=255;if(cubemap_side_ind===CUBEMAP_UPPER_SIDE){subscene.cube_fog[3]=res_r;subscene.cube_fog[7]=res_g;subscene.cube_fog[11]=res_b}else if(cubemap_side_ind<2){subscene.cube_fog[4*cubemap_side_ind]=res_r;subscene.cube_fog[4*cubemap_side_ind+1]=res_g;subscene.cube_fog[4*cubemap_side_ind+2]=res_b}else{subscene.cube_fog[4*(cubemap_side_ind-2)]=res_r;subscene.cube_fog[4*(cubemap_side_ind-
2)+1]=res_g;subscene.cube_fog[4*(cubemap_side_ind-2)+2]=res_b}}function setup_float_attribute(attributes,name,value){var attribute_loc=attributes[name];if(attribute_loc==undefined)return;_gl.vertexAttrib1f(attribute_loc,value)}function setup_vec2_attribute(attributes,name,value){var attribute_loc=attributes[name];if(attribute_loc==undefined)return;_gl.vertexAttrib2fv(attribute_loc,value)}function setup_vec3_attribute(attributes,name,value){var attribute_loc=attributes[name];if(attribute_loc==undefined)return;
_gl.vertexAttrib3fv(attribute_loc,value)}function setup_vec4_attribute(attributes,name,value){var attribute_loc=attributes[name];if(attribute_loc==undefined)return;_gl.vertexAttrib4fv(attribute_loc,value)}function draw_buffers(bufs_data,attribute_setters,frame,aaa){_gl.bindBuffer(_gl.ARRAY_BUFFER,bufs_data.vbo);for(var i=0;i<attribute_setters.length;i++){var setter=attribute_setters[i];_gl.enableVertexAttribArray(setter.loc);var offset=setter.base_offset+setter.frame_length*frame;_gl.vertexAttribPointer(setter.loc,
setter.num_comp,_gl.FLOAT,false,0,offset)}if(bufs_data.ibo){_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,bufs_data.ibo);_gl.drawElements(bufs_data.mode,bufs_data.count,bufs_data.ibo_type,0)}else _gl.drawArrays(bufs_data.mode,0,bufs_data.count);for(var i=0;i<attribute_setters.length;i++){var setter=attribute_setters[i];_gl.disableVertexAttribArray(setter.loc)}}function get_cube_target_by_id(id){switch(id){case 0:return _gl.TEXTURE_CUBE_MAP_POSITIVE_X;case 1:return _gl.TEXTURE_CUBE_MAP_NEGATIVE_X;case 2:return _gl.TEXTURE_CUBE_MAP_POSITIVE_Y;
case 3:return _gl.TEXTURE_CUBE_MAP_NEGATIVE_Y;case 4:return _gl.TEXTURE_CUBE_MAP_POSITIVE_Z;case 5:return _gl.TEXTURE_CUBE_MAP_NEGATIVE_Z}}exports.assign_attribute_setters=function(batch){var attr_setters=batch.attribute_setters;attr_setters.length=0;var bufs_data=batch.bufs_data;var shader=batch.shader;if(!bufs_data||!shader)m_util.panic("Incomplete batch");var pointers=bufs_data.pointers;var attributes=shader.attributes;for(var name in attributes){var p=pointers[name];var setter={loc:attributes[name],
base_offset:p.offset*FLOAT_BYTE_SIZE,frame_length:p.frames>1?p.length*FLOAT_BYTE_SIZE:0,num_comp:p.num_comp};attr_setters.push(setter)}};exports.assign_uniform_setters=assign_uniform_setters;function assign_uniform_setters(shader){var uniforms=shader.uniforms;var transient_uniform_setters=[];var permanent_uniform_setters=[];var permanent_uniform_setters_table={};for(var uni in uniforms){var transient_uni=false;switch(uni){case "u_proj_matrix":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,
false,camera.proj_matrix)};transient_uni=true;break;case "u_view_matrix":case "u_view_matrix_frag":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,camera.view_matrix)};transient_uni=true;break;case "u_shadow_cast_billboard_view_matrix":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,camera.shadow_cast_billboard_view_matrix)};transient_uni=true;break;case "u_view_proj_prev":var fun=function(gl,loc,subscene,obj_render,batch,
camera){gl.uniformMatrix4fv(loc,false,camera.prev_view_proj_matrix)};transient_uni=true;break;case "u_view_proj_inverse":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,camera.view_proj_inv_matrix)};transient_uni=true;break;case "u_sky_vp_inverse":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,camera.sky_vp_inv_matrix)};transient_uni=true;break;case "u_camera_eye":case "u_camera_eye_frag":var fun=function(gl,loc,subscene,
obj_render,batch,camera){gl.uniform3fv(loc,camera.eye)};transient_uni=true;break;case "u_camera_eye_last":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,camera.eye_last)};transient_uni=true;break;case "u_camera_quat":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,camera.quat)};transient_uni=true;break;case "u_view_max_depth":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,camera.far)};transient_uni=true;break;case "u_camera_range":var fun=
function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2f(loc,camera.near,camera.far)};break;case "u_csm_center_dists":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,camera.csm_center_dists)};break;case "u_cam_water_depth":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.cam_water_depth)};transient_uni=true;break;case "u_waves_height":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.water_waves_height)};
break;case "u_waves_length":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.water_waves_length)};break;case "u_fog_color_density":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,subscene.fog_color_density)};break;case "u_fog_params":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,subscene.fog_params)};break;case "u_underwater_fog_color_density":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,
subscene.water_fog_color_density)};break;case "u_bloom_key":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.bloom_key)};break;case "u_bloom_edge_lum":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.bloom_edge_lum)};break;case "u_time":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.time)};transient_uni=true;break;case "u_wind":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,
subscene.wind)};transient_uni=true;break;case "u_sky_tex_dvar":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.sky_tex_default_value)};break;case "u_sky_tex_fac":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,subscene.sky_tex_fac)};break;case "u_sky_tex_color":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.sky_tex_color)};break;case "u_horizon_color":var fun=function(gl,loc,subscene,obj_render,batch,
camera){gl.uniform3fv(loc,subscene.horizon_color)};break;case "u_zenith_color":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.zenith_color)};break;case "u_environment_energy":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.environment_energy)};break;case "u_sky_color":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.sky_color)};break;case "u_rayleigh_brightness":var fun=function(gl,loc,subscene,
obj_render,batch,camera){gl.uniform1f(loc,subscene.rayleigh_brightness)};break;case "u_mie_brightness":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.mie_brightness)};break;case "u_spot_brightness":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.spot_brightness)};break;case "u_scatter_strength":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.scatter_strength)};break;case "u_rayleigh_strength":var fun=
function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.rayleigh_strength)};break;case "u_mie_strength":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.mie_strength)};break;case "u_rayleigh_collection_power":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.rayleigh_collection_power)};break;case "u_mie_collection_power":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.mie_collection_power)};
break;case "u_mie_distribution":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.mie_distribution)};break;case "u_light_positions":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.light_positions)};break;case "u_light_directions":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.light_directions)};break;case "u_light_color_intensities":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,
subscene.light_color_intensities)};break;case "u_light_factors":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,subscene.light_factors)};break;case "u_sun_quaternion":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,subscene.sun_quaternion)};break;case "u_sun_intensity":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.sun_intensity)};break;case "u_sun_direction":var fun=function(gl,loc,subscene,obj_render,batch,
camera){gl.uniform3fv(loc,subscene.sun_direction)};break;case "u_height":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,camera.height)};transient_uni=true;break;case "u_model_matrix":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,obj_render.world_matrix)};transient_uni=true;break;case "u_transb":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,obj_render.trans_before)};transient_uni=true;break;case "u_transa":var fun=
function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,obj_render.trans_after)};transient_uni=true;break;case "u_arm_rel_trans":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,obj_render.arm_rel_trans)};transient_uni=true;break;case "u_arm_rel_quat":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,obj_render.arm_rel_quat)};transient_uni=true;break;case "u_quat":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,
obj_render.quat)};transient_uni=true;break;case "u_quatsb":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,obj_render.quats_before)};transient_uni=true;break;case "u_quatsa":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,obj_render.quats_after)};transient_uni=true;break;case "u_frame_factor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,obj_render.frame_factor)};transient_uni=true;break;case "au_center_pos":var fun=
function(gl,loc,subscene,obj_render,batch,camera){};transient_uni=true;break;case "au_wind_bending_amp":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,obj_render.wind_bending_amp)};transient_uni=true;break;case "au_wind_bending_freq":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,obj_render.wind_bending_freq)};transient_uni=true;break;case "au_detail_bending_freq":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,obj_render.detail_bending_freq)};
transient_uni=true;break;case "au_detail_bending_amp":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,obj_render.detail_bending_amp)};transient_uni=true;break;case "au_branch_bending_amp":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,obj_render.branch_bending_amp)};transient_uni=true;break;case "u_node_values":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1fv(loc,obj_render.mats_values)};transient_uni=true;break;case "u_node_rgbs":var fun=
function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,obj_render.mats_rgbs)};transient_uni=true;break;case "u_diffuse_color":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,batch.diffuse_color)};transient_uni=true;break;case "u_diffuse_intensity":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.diffuse_intensity)};transient_uni=true;break;case "u_diffuse_params":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,
batch.diffuse_params)};transient_uni=true;break;case "u_emit":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.emit)};transient_uni=true;break;case "u_ambient":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.ambient)};transient_uni=true;break;case "u_specular_color":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.specular_color)};transient_uni=true;break;case "u_specular_alpha":var fun=function(gl,loc,
subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.specular_alpha)};transient_uni=true;break;case "u_specular_params":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.specular_params)};transient_uni=true;break;case "u_reflect_factor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.reflect_factor)};transient_uni=true;break;case "u_mirror_factor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.mirror_factor)};
transient_uni=true;break;case "u_grass_map_dim":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.grass_map_dim)};transient_uni=true;break;case "u_grass_size":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.grass_size)};transient_uni=true;break;case "u_scale_threshold":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.grass_scale_threshold)};transient_uni=true;break;case "u_cube_fog":var fun=function(gl,
loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,batch.cube_fog)};break;case "u_jitter_amp":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.jitter_amp)};transient_uni=true;break;case "u_jitter_freq":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.jitter_freq)};transient_uni=true;break;case "u_wireframe_mode":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1i(loc,batch.wireframe_mode)};break;case "u_wireframe_edge_color":var fun=
function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.wireframe_edge_color)};break;case "u_subpixel_jitter":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,subscene.jitter_projection_space)};transient_uni=true;break;case "u_subsample_indices":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,subscene.jitter_subsample_ind)};transient_uni=true;break;case "u_refr_bump":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,
batch.refr_bump)};transient_uni=true;break;case "u_lamp_light_positions":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.lamp_light_positions)};break;case "u_lamp_light_directions":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.lamp_light_directions)};break;case "u_lamp_light_color_intensities":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.lamp_light_color_intensities)};break;case "u_lamp_light_factors":var fun=
function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,batch.lamp_light_factors)};break;case "u_halo_size":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.halo_size)};transient_uni=true;break;case "u_halo_hardness":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.halo_hardness)};transient_uni=true;break;case "u_halo_rings_color":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.halo_rings_color)};
transient_uni=true;break;case "u_halo_lines_color":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.halo_lines_color)};transient_uni=true;break;case "u_halo_stars_blend":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.halo_stars_blend)};transient_uni=true;break;case "u_halo_stars_height":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.halo_stars_height)};transient_uni=true;break;case "u_fresnel_params":var fun=
function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,batch.fresnel_params)};transient_uni=true;break;case "u_texture_scale":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.texture_scale)};transient_uni=true;break;case "u_parallax_scale":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.parallax_scale)};transient_uni=true;break;case "u_color_id":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,
obj_render.color_id)};transient_uni=true;break;case "u_line_points":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.line_points)};transient_uni=true;break;case "u_diffuse_color_factor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.diffuse_color_factor)};transient_uni=true;break;case "u_alpha_factor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.alpha_factor)};transient_uni=true;break;case "u_specular_color_factor":var fun=
function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.specular_color_factor)};transient_uni=true;break;case "u_normal_factor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.normal_factor)};transient_uni=true;break;case "u_normalmap0_scale":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.normalmap_scales[0])};transient_uni=true;break;case "u_normalmap1_scale":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,
batch.normalmap_scales[1])};transient_uni=true;break;case "u_normalmap2_scale":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.normalmap_scales[2])};transient_uni=true;break;case "u_normalmap3_scale":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.normalmap_scales[3])};transient_uni=true;break;case "u_foam_factor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.foam_factor)};transient_uni=true;break;
case "u_foam_uv_freq":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.foam_uv_freq)};transient_uni=true;break;case "u_foam_mag":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.foam_mag)};transient_uni=true;break;case "u_foam_scale":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.foam_scale)};transient_uni=true;break;case "u_water_norm_uv_velocity":var fun=function(gl,loc,subscene,obj_render,batch,
camera){gl.uniform1f(loc,batch.water_norm_uv_velocity)};transient_uni=true;break;case "u_shallow_water_col":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.shallow_water_col)};transient_uni=true;break;case "u_shore_water_col":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.shore_water_col)};transient_uni=true;break;case "u_water_shallow_col_fac":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.shallow_water_col_fac)};
transient_uni=true;break;case "u_water_shore_col_fac":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.shore_water_col_fac)};transient_uni=true;break;case "u_p_length":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.particles_data.time_length)};transient_uni=true;break;case "u_p_cyclic":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1i(loc,batch.particles_data.cyclic)};transient_uni=true;break;case "u_p_max_lifetime":var fun=
function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.particles_data.lifetime)};transient_uni=true;break;case "u_p_fade_in":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.particles_data.fade_in)};transient_uni=true;break;case "u_p_fade_out":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.particles_data.fade_out)};transient_uni=true;break;case "u_p_size":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,
batch.particles_data.size)};transient_uni=true;break;case "u_p_alpha_start":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.particles_data.alpha_start)};transient_uni=true;break;case "u_p_alpha_end":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.particles_data.alpha_end)};transient_uni=true;break;case "u_p_nfactor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.particles_data.nfactor)};transient_uni=
true;break;case "u_p_gravity":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.particles_data.gravity)};transient_uni=true;break;case "u_p_mass":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.particles_data.mass)};transient_uni=true;break;case "u_p_size_ramp":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.particles_data.size_ramp)};transient_uni=true;break;case "u_p_color_ramp":var fun=function(gl,
loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,batch.particles_data.color_ramp)};transient_uni=true;break;case "u_p_wind_fac":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.particles_data.wind_factor)};transient_uni=true;break;case "u_texel_size":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,subscene.texel_size)};transient_uni=true;break;case "u_p_time":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,
batch.particles_data.time)};transient_uni=true;break;case "u_position":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.positions)};transient_uni=true;break;case "u_va_frame_factor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,obj_render.va_frame_factor)};transient_uni=true;break;case "u_perspective_cast_far_bound":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.perspective_cast_far_bound)};break;case "u_normal_offset":var fun=
function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.self_shadow_normal_offset)};break;case "u_pcf_blur_radii":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,camera.pcf_blur_radii)};break;case "u_v_light_matrix":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,subscene.v_light_matrix)};transient_uni=true;break;case "u_b_light_matrix":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,
false,subscene.b_light_matrix)};break;case "u_p_light_matrix0":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,subscene.p_light_matrix[0])};transient_uni=true;break;case "u_p_light_matrix1":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,subscene.p_light_matrix[1])};transient_uni=true;break;case "u_p_light_matrix2":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,subscene.p_light_matrix[2])};
transient_uni=true;break;case "u_p_light_matrix3":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,subscene.p_light_matrix[3])};transient_uni=true;break;case "u_motion_blur_exp":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.motion_blur_exp)};transient_uni=true;break;case "u_motion_blur_decay_threshold":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.mb_decay_threshold)};transient_uni=true;
break;case "u_refl_plane":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,obj_render.reflection_plane)};transient_uni=true;break;case "u_radial_blur_step":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.radial_blur_step)};break;case "u_god_rays_intensity":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.god_rays_intensity)};break;case "u_ssao_radius_increase":var fun=function(gl,loc,subscene,obj_render,
batch,camera){gl.uniform1f(loc,subscene.ssao_radius_increase)};break;case "u_ssao_blur_discard_value":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.ssao_blur_discard_value)};transient_uni=true;break;case "u_ssao_influence":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.ssao_influence)};break;case "u_ssao_dist_factor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.ssao_dist_factor)};break;
case "u_dof_dist":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,camera.dof_distance)};transient_uni=true;break;case "u_dof_front":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,camera.dof_front)};transient_uni=true;break;case "u_dof_rear":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,camera.dof_rear)};transient_uni=true;break;case "u_outline_intensity":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,
obj_render.outline_intensity)};transient_uni=true;break;case "u_outline_color":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.outline_color)};break;case "u_draw_outline":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.draw_outline_flag)};transient_uni=true;break;case "u_glow_mask_small_coeff":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.small_glow_mask_coeff)};transient_uni=true;break;
case "u_glow_mask_large_coeff":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.large_glow_mask_coeff)};transient_uni=true;break;case "u_brightness":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.brightness)};break;case "u_contrast":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.contrast)};break;case "u_exposure":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.exposure)};
break;case "u_saturation":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.saturation)};break;default:var fun=null;break}if(fun){var setter={name:uni,fun:fun,loc:uniforms[uni]};if(transient_uni)transient_uniform_setters.push(setter);else{permanent_uniform_setters.push(setter);permanent_uniform_setters_table[uni]=setter}}}shader.transient_uniform_setters=transient_uniform_setters;shader.permanent_uniform_setters=permanent_uniform_setters;shader.permanent_uniform_setters_table=
permanent_uniform_setters_table}exports.assign_texture_uniforms=function(batch){var shader=batch.shader;var textures=batch.textures;var names=batch.texture_names;_gl.useProgram(shader.program);for(var i=0;i<textures.length;i++){var tex=textures[i];var name=names[i];_gl.uniform1i(shader.uniforms[name],i)}};function setup_textures(textures){for(var i=0;i<textures.length;i++){var tex=textures[i];_gl.activeTexture(_gl.TEXTURE0+i);_gl.bindTexture(tex.w_target,tex.w_texture)}}exports.read_pixels=read_pixels;
function read_pixels(framebuffer,x,y,width,height,storage){if(!width)var width=1;if(!height)var height=1;if(!storage)var storage=new Uint8Array(4*width*height);if(storage.length!=4*width*height)m_util.panic("read_pixels(): Wrong storage");_gl.bindFramebuffer(_gl.FRAMEBUFFER,framebuffer);_gl.readPixels(x,y,width,height,_gl.RGBA,_gl.UNSIGNED_BYTE,storage);_gl.bindFramebuffer(_gl.FRAMEBUFFER,null);return storage}function update_subs_permanent_uniforms(subscene){var camera=subscene.camera;var bundles=
subscene.bundles;for(var i=0;i<bundles.length;i++){var bundle=bundles[i];var batch=bundle.batch;var shader=batch.shader;_gl.useProgram(shader.program);var obj_render=bundle.obj_render;var uniforms=shader.uniforms;if(!shader.permanent_uniform_setters.length)assign_uniform_setters(shader);var permanent_uniform_setters=shader.permanent_uniform_setters;var j=permanent_uniform_setters.length;while(j--){var setter=permanent_uniform_setters[j];setter.fun(_gl,setter.loc,subscene,obj_render,batch,camera)}}}
exports.update_batch_permanent_uniform=function(batch,uni_name){var shader=batch.shader;_gl.useProgram(shader.program);if(!shader.permanent_uniform_setters.length)assign_uniform_setters(shader);var setter=shader.permanent_uniform_setters_table[uni_name];setter.fun(_gl,setter.loc,null,null,batch,null)};exports.render_target_create=function(color_attachment,depth_attachment){var framebuffer=_gl.createFramebuffer();_gl.bindFramebuffer(_gl.FRAMEBUFFER,framebuffer);if(color_attachment){var texture=color_attachment;
var w_tex=texture.w_texture;var w_target=texture.w_target==_gl.TEXTURE_CUBE_MAP?_gl.TEXTURE_CUBE_MAP_NEGATIVE_Z:texture.w_target;_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,w_target,w_tex,0)}if(m_textures.is_renderbuffer(depth_attachment)){var renderbuffer=depth_attachment.w_renderbuffer;_gl.framebufferRenderbuffer(_gl.FRAMEBUFFER,_gl.DEPTH_ATTACHMENT,_gl.RENDERBUFFER,renderbuffer)}else if(m_textures.is_texture(depth_attachment)){var texture=depth_attachment;var w_tex=texture.w_texture;
var w_target=texture.w_target;_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.DEPTH_ATTACHMENT,w_target,w_tex,0)}m_debug.check_bound_fb();_gl.bindFramebuffer(_gl.FRAMEBUFFER,null);return framebuffer};exports.render_target_cleanup=function(framebuffer,color_attachment,depth_attachment,width,height){if(framebuffer==null){_gl.bindFramebuffer(_gl.FRAMEBUFFER,framebuffer);_gl.viewport(0,0,width,height);_gl.clear(_gl.COLOR_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT);return}if(m_textures.is_texture(color_attachment))_gl.deleteTexture(color_attachment.w_texture);
if(m_textures.is_renderbuffer(depth_attachment))_gl.deleteRenderbuffer(depth_attachment.w_renderbuffer);else if(m_textures.is_texture(depth_attachment))_gl.deleteTexture(depth_attachment.w_texture);_gl.deleteFramebuffer(framebuffer)};exports.increment_subpixel_index=function(){_subpixel_index=(_subpixel_index+1)%2};exports.cleanup=function(){_subpixel_index=0}};b4w.module["__shaders"]=function(exports,require){var m_assets=require("__assets");var m_cfg=require("__config");var m_debug=require("__debug");var m_print=require("__print");var m_util=require("__util");var cfg_pth=m_cfg.paths;var _compiled_shaders={};var _shader_ast_cache={};var _shader_texts=null;var SHADERS=["anchors.glslf","anchors.glslv","color_id.glslf","color_id.glslv","depth.glslf","depth.glslv","grass_map.glslf","grass_map.glslv","halo.glslf","halo.glslv","main.glslf","main.glslv","main_stack.glslf",
"main_stack.glslv","particles_color.glslf","particles_color.glslv","particles_texture.glslf","particles_texture.glslv","procedural_skydome.glslf","procedural_skydome.glslv","special_lens_flares.glslf","special_lens_flares.glslv","special_skydome.glslf","special_skydome.glslv","special_water.glslf","special_water.glslv","wireframe.glslf","wireframe.glslv","postprocessing/anaglyph.glslf","postprocessing/antialiasing.glslf","postprocessing/bloom_combine.glslf","postprocessing/compositing.glslf","postprocessing/depth_pack.glslf",
"postprocessing/dof.glslf","postprocessing/glow.glslf","postprocessing/bloom_blur.glslf","postprocessing/god_rays.glslf","postprocessing/god_rays.glslv","postprocessing/god_rays_combine.glslf","postprocessing/luminance.glslf","postprocessing/luminance_av.glslf","postprocessing/luminance_trunced.glslf","postprocessing/luminance_trunced.glslv","postprocessing/motion_blur.glslf","postprocessing/outline.glslf","postprocessing/postprocessing.glslf","postprocessing/postprocessing.glslv","postprocessing/smaa.glslf",
"postprocessing/smaa.glslv","postprocessing/ssao.glslf","postprocessing/ssao_blur.glslf","include/blending.glslf","include/caustics.glslf","include/depth_fetch.glslf","include/dynamic_grass.glslv","include/environment.glslf","include/fog.glslf","include/gamma.glslf","include/lighting_nodes.glslf","include/math.glslv","include/mirror.glslf","include/nodes.glslf","include/nodes.glslv","include/pack.glslf","include/particles.glslv","include/precision_statement.glslf","include/procedural.glslf","include/refraction.glslf",
"include/scale_texcoord.glslv","include/shadow.glslf","include/shadow.glslv","include/skin.glslv","include/std_enums.glsl","include/to_world.glslv","include/wind_bending.glslv"];var DEBUG_COMPILATION_UNIQUENESS=false;var _debug_hash_codes=[];var _gl=null;var _shaders_loaded=false;exports.setup_context=function(gl){_gl=gl};exports.set_directive=set_directive;function set_directive(shaders_info,name,value){var dirs=shaders_info.directives;if(typeof value=="string"){var dir=get_directive(shaders_info,
value);if(dir)var value=dir[1]}for(var i=0;i<dirs.length;i++)if(dirs[i][0]==name){dirs[i][1]=value;return}dirs.push([name,value])}exports.get_directive=get_directive;function get_directive(shaders_info,name){var dirs=shaders_info.directives;for(var i=0;i<dirs.length;i++)if(dirs[i][0]==name)return dirs[i];return false}exports.is_enabled=function(shaders_info,name){var dirs=shaders_info.directives;for(var i=0;i<dirs.length;i++)if(dirs[i][0]==name&&dirs[i][1]==1)return true;return false};exports.set_default_directives=
function(sinfo){sinfo.directives=[];var dir_names=["ALPHA","ALPHA_CLIP","BEND_CENTER_ONLY","BILLBOARD_PRES_GLOB_ORIENTATION","CAUSTICS","CSM_BLEND_BETWEEEN_CASCADES","CSM_FADE_LAST_CASCADE","CSM_SECTION0","CSM_SECTION1","CSM_SECTION2","CSM_SECTION3","DEBUG_SPHERE","DEBUG_SPHERE_DYNAMIC","DEPTH_RGBA","DISABLE_FOG","DOUBLE_SIDED_LIGHTING","DYNAMIC","DYNAMIC_GRASS","DYNAMIC_GRASS_COLOR","DYNAMIC_GRASS_SIZE","FOAM","FRAMES_BLENDING","BILLBOARD_JITTERED","BILLBOARD_SPHERICAL","HAIR_BILLBOARD","SHADOW_TEX_RES",
"MAIN_BEND_COL","MAX_BONES","NODES_GLOW","NUM_NORMALMAPS","PARALLAX","PARALLAX_STEPS","PERSPECTIVE_SHADOW_CAST","PROCEDURAL_FOG","PROCEDURAL_SKYDOME","REFLECTION","REFLECTION_PASS","REFLECTION_TYPE","REFRACTIVE","USE_REFRACTION","USE_REFRACTION_CORRECTION","SHORE_SMOOTHING","SKINNED","SKY_COLOR","SKY_TEXTURE","SSAO_HEMISPHERE","SSAO_BLUR_DEPTH","SSAO_ONLY","SSAO_WHITE","STATIC_BATCH","TEXTURE_COLOR","TEXTURE_NORM","TEXTURE_SPEC","TEXTURE_STENCIL_ALPHA_MASK","VERTEX_ANIM","VERTEX_ANIM_MIX_NORMALS_FACTOR",
"VERTEX_COLOR","WATER_EFFECTS","WIND_BEND","DETAIL_BEND","SHORE_PARAMS","ALPHA_AS_SPEC","DEPTH_RGBA","MTEX_NEGATIVE","MTEX_RGBTOINT","NUM_LIGHTS","NUM_LFACTORS","NUM_LAMP_LIGHTS","MAX_STEPS","BILLBOARD_ALIGN","SHADOW_USAGE","POST_EFFECT","SSAO_QUALITY","TEXTURE_BLEND_TYPE","TEXTURE_COORDS","AA_METHOD","AU_QUALIFIER","BILLBOARD","BILLBOARD_RANDOM","PRECISION","EPSILON","USE_ENVIRONMENT_LIGHT","USE_FOG","WO_SKYBLEND","WO_SKYPAPER","WO_SKYREAL","WO_SKYTEX","WOMAP_BLEND","WOMAP_HORIZ","WOMAP_ZENUP","WOMAP_ZENDOWN",
"WIREFRAME_QUALITY","SIZE_RAMP_LENGTH","COLOR_RAMP_LENGTH","PARTICLES_SHADELESS"];for(var i=0;i<dir_names.length;i++){var name=dir_names[i];var val;switch(name){case "ALPHA":case "ALPHA_CLIP":case "BILLBOARD_PRES_GLOB_ORIENTATION":case "CAUSTICS":case "CSM_SECTION0":case "CSM_SECTION1":case "CSM_SECTION2":case "CSM_SECTION3":case "DEBUG_SPHERE":case "DEBUG_SPHERE_DYNAMIC":case "DEPTH_RGBA":case "DISABLE_FOG":case "DOUBLE_SIDED_LIGHTING":case "DYNAMIC":case "DYNAMIC_GRASS":case "DYNAMIC_GRASS_COLOR":case "DYNAMIC_GRASS_SIZE":case "FOAM":case "FRAMES_BLENDING":case "BILLBOARD_JITTERED":case "MAIN_BEND_COL":case "MAX_BONES":case "MTEX_NEGATIVE":case "MTEX_RGBTOINT":case "NODES_GLOW":case "NUM_LIGHTS":case "NUM_LFACTORS":case "NUM_NORMALMAPS":case "PARALLAX":case "PARALLAX_STEPS":case "PERSPECTIVE_SHADOW_CAST":case "PROCEDURAL_FOG":case "PROCEDURAL_SKYDOME":case "REFLECTION":case "REFLECTION_PASS":case "REFLECTION_TYPE":case "REFRACTIVE":case "USE_REFRACTION":case "USE_REFRACTION_CORRECTION":case "SHORE_SMOOTHING":case "SKINNED":case "SKY_COLOR":case "SKY_TEXTURE":case "SSAO_HEMISPHERE":case "SSAO_BLUR_DEPTH":case "SSAO_ONLY":case "SSAO_WHITE":case "STATIC_BATCH":case "TEXTURE_COLOR":case "TEXTURE_NORM":case "TEXTURE_SPEC":case "TEXTURE_STENCIL_ALPHA_MASK":case "VERTEX_ANIM":case "VERTEX_COLOR":case "WATER_EFFECTS":case "WIND_BEND":case "DETAIL_BEND":case "SHORE_PARAMS":case "BILLBOARD":case "BILLBOARD_RANDOM":case "HAIR_BILLBOARD":case "USE_ENVIRONMENT_LIGHT":case "USE_FOG":case "WO_SKYBLEND":case "WO_SKYPAPER":case "WO_SKYREAL":case "WO_SKYTEX":case "WOMAP_BLEND":case "WOMAP_HORIZ":case "WOMAP_ZENUP":case "WOMAP_ZENDOWN":case "WIREFRAME_QUALITY":case "SIZE_RAMP_LENGTH":case "COLOR_RAMP_LENGTH":case "PARTICLES_SHADELESS":case "SMAA_JITTER":val=
0;break;case "ALPHA_AS_SPEC":case "BEND_CENTER_ONLY":case "CSM_BLEND_BETWEEEN_CASCADES":case "CSM_FADE_LAST_CASCADE":case "DEPTH_RGBA":case "BILLBOARD_SPHERICAL":case "NUM_LAMP_LIGHTS":case "MAX_STEPS":val=1;break;case "SHADOW_TEX_RES":val=glsl_value(2048);break;case "AA_METHOD":val="AA_METHOD_FXAA_QUALITY";break;case "AU_QUALIFIER":val="NOT_ASSIGNED";break;case "BILLBOARD_ALIGN":val="BILLBOARD_ALIGN_VIEW";break;case "POST_EFFECT":val="POST_EFFECT_NONE";break;case "SHADOW_USAGE":val="NO_SHADOWS";
break;case "SSAO_QUALITY":val="SSAO_QUALITY_32";break;case "TEXTURE_BLEND_TYPE":val="TEXTURE_BLEND_TYPE_MIX";break;case "TEXTURE_COORDS":val="TEXTURE_COORDS_UV_ORCO";break;case "PRECISION":val=m_cfg.defaults.precision;break;case "EPSILON":if(m_cfg.defaults.precision=="highp")val=1E-6;else val=1E-4;break;case "VERTEX_ANIM_MIX_NORMALS_FACTOR":val="u_va_frame_factor";break;default:m_print.error("Unknown directive ("+sinfo.vert+", "+sinfo.frag+"): "+name);break}set_directive(sinfo,name,val)}};exports.get_vname=
function(sinfo){return sinfo.vert};exports.get_fname=function(sinfo){return sinfo.frag};exports.inherit_directives=function(sinfo_to,sinfo_from){var dirs=sinfo_from.directives;for(var i=0;i<dirs.length;i++){var name=dirs[i][0];var value=dirs[i][1];if(get_directive(sinfo_to,name))set_directive(sinfo_to,name,value)}};exports.get_compiled_shader=get_compiled_shader;function get_compiled_shader(shaders_info){var shader_id=JSON.stringify(shaders_info);var compiled_shader=_compiled_shaders[shader_id];if(compiled_shader)return compiled_shader;
var vshader=shaders_info.vert;var fshader=shaders_info.frag;var vshader_ast=get_shader_ast(cfg_pth.shaders_dir,vshader);var fshader_ast=get_shader_ast(cfg_pth.shaders_dir,fshader);if(!vshader_ast||!fshader_ast)return null;var vshader_text=preprocess_shader("vert",vshader_ast,shaders_info);var fshader_text=preprocess_shader("frag",fshader_ast,shaders_info);_compiled_shaders[shader_id]=compiled_shader=init_shader(_gl,vshader_text,fshader_text,shader_id,shaders_info);return compiled_shader}function get_shader_ast(dir,
filename){var cache_id=dir+filename;if(_shader_ast_cache[cache_id])return _shader_ast_cache[cache_id];if(!_shader_texts){var ast=require("shader_texts")[filename];if(!ast)return null}else{var main_text=_shader_texts[filename];if(!main_text)return null;var ast=require("__gpp_parser").parser.parse(main_text)}_shader_ast_cache[cache_id]=ast;return ast}function set_shader_texts(shader_name,shadet_text){if(!_shader_texts)_shader_texts={};_shader_texts[shader_name]=shadet_text}exports.load_shaders=function(){_shaders_loaded=
false;if(!b4w.module_check("shader_texts")){var shader_assets=[];var asset_type=m_assets.AT_TEXT;for(var i=0;i<SHADERS.length;i++){var shader_path=m_util.normpath_preserve_protocol(cfg_pth.shaders_dir+SHADERS[i]);shader_assets.push([SHADERS[i],asset_type,shader_path])}var asset_cb=function(shader_text,shader_name,type,path){set_shader_texts(shader_name,shader_text)};var pack_cb=function(){_shaders_loaded=true};if(shader_assets.length)m_assets.enqueue(shader_assets,asset_cb,pack_cb);else m_print.error("Shaders have not been found.")}else _shaders_loaded=
true};exports.check_shaders_loaded=function(){return _shaders_loaded};function preprocess_shader(type,ast,shaders_info){var node_elements=shaders_info.node_elements;var dirs_arr=shaders_info.directives||[];var lines=[];var dirs={};for(var i=0;i<dirs_arr.length;i++)dirs[dirs_arr[i][0]]=[dirs_arr[i][1]];for(var i=0;i<node_elements.length;i++)dirs["USE_NODE_"+node_elements[i].id]=[1];var fdirs={};var shader_nodes={};var usage_inputs=[];for(var i in node_elements)for(var j in node_elements[i].inputs)usage_inputs.push(node_elements[i].inputs[j]);
process_group(ast);var text=lines.join("\n");var input_index=0;var output_index=0;var param_index=0;return text;function process_group(elem){var parts=elem.parts;for(var i=0;i<parts.length;i++){var pelem=parts[i];switch(pelem.type){case "condition":process_condition(pelem);break;case "include":process_include(pelem);break;case "var":case "export":case "import":break;case "define":process_define(pelem);break;case "error":process_error(pelem);break;case "line":break;case "pragma":process_pragma(pelem);
break;case "undef":process_undef(pelem);break;case "warning":process_warning(pelem);break;case "extension":process_extension(pelem);break;case "#":break;case "node":process_node(pelem);break;case "nodes_global":process_nodes_global(node_elements);break;case "nodes_main":process_nodes_main(node_elements);break;case "textline":process_textline(pelem);break;default:throw"Unknown element type: "+pelem.type;break}}}function process_condition(elem){var parts=elem.parts;for(var i=0;i<parts.length;i++){var pelem=
parts[i];switch(pelem.type){case "if":case "elif":var expression=pelem.expression;var result=expression_result(expression);if(result){process_group(pelem.group);return}break;case "else":process_group(pelem.group);return;case "ifdef":if(pelem.name in dirs)process_group(pelem.group);break;case "ifndef":if(!(pelem.name in dirs))process_group(pelem.group);break}}}function expression_result(expression,node_dirs){var expr_list=expand_macro(expression,dirs,fdirs,true,node_dirs);return eval_expression(expr_list)}
function eval_expression(expr_list){var operand_stack=[];for(var i=0;i<expr_list.length;i++)if(!(expr_list[i]instanceof Object)){var operand=expr_list[i];var expr_identifier=/^[a-zA-Z_$][a-zA-Z_$0-9]*$/;if(expr_identifier.test(operand))operand_stack.push(0);else operand_stack.push(parseFloat(expr_list[i]))}else switch(expr_list[i].type){case "conditional_expr":var falseExpression=operand_stack.pop();var trueExpression=operand_stack.pop();var condition=operand_stack.pop();if(condition)operand_stack.push(trueExpression);
else operand_stack.push(falseExpression);break;case "logical_or_expr":var result=operand_stack.pop();for(var j=0;j<expr_list[i].places-1;j++){var operand=operand_stack.pop();result=result||operand}operand_stack.push(result);break;case "logical_and_expr":var result=operand_stack.pop();for(var j=0;j<expr_list[i].places-1;j++){var operand=operand_stack.pop();result=result&&operand}operand_stack.push(result);break;case "logical_bitor_expr":var result=operand_stack.pop();for(var j=0;j<expr_list[i].places-
1;j++)result|=operand_stack.pop();operand_stack.push(result);break;case "logical_bitxor_expr":var result=operand_stack.pop();for(var j=0;j<expr_list[i].places-1;j++)result^=operand_stack.pop();operand_stack.push(result);break;case "logical_bitand_expr":var result=operand_stack.pop();for(var j=0;j<expr_list[i].places-1;j++)result&=operand_stack.pop();operand_stack.push(result);break;case "equal_expr":var operand2=operand_stack.pop();var operand1=operand_stack.pop();operand_stack.push(operand1==operand2);
break;case "non_equal_expr":var operand2=operand_stack.pop();var operand1=operand_stack.pop();operand_stack.push(operand1!=operand2);break;case "le_expr":var operand2=operand_stack.pop();var operand1=operand_stack.pop();operand_stack.push(operand1<=operand2);break;case "ge_expr":var operand2=operand_stack.pop();var operand1=operand_stack.pop();operand_stack.push(operand1>=operand2);break;case "l_expr":var operand2=operand_stack.pop();var operand1=operand_stack.pop();operand_stack.push(operand1<operand2);
break;case "g_expr":var operand2=operand_stack.pop();var operand1=operand_stack.pop();operand_stack.push(operand1>operand2);break;case "left_shift_expr":var operand1=operand_stack.pop();var operand2=operand_stack.pop();operand_stack.push(operand1<<operand2);break;case "right_shift_expr":var operand1=operand_stack.pop();var operand2=operand_stack.pop();operand_stack.push(operand1>>operand2);break;case "add_expr":var operand1=operand_stack.pop();var operand2=operand_stack.pop();operand_stack.push(operand1+
operand2);break;case "sub_expr":var operand1=operand_stack.pop();var operand2=operand_stack.pop();operand_stack.push(operand1-operand2);break;case "mul_expr":var operand1=operand_stack.pop();var operand2=operand_stack.pop();operand_stack.push(operand1*operand2);break;case "div_expr":var operand1=operand_stack.pop();var operand2=operand_stack.pop();operand_stack.push(operand1/operand2);break;case "mod_expr":var operand1=operand_stack.pop();var operand2=operand_stack.pop();operand_stack.push(operand1%
operand2);break;case "pre_inc_expr":case "post_inc_expr":var operand=operand_stack.pop();operand_stack.push(++operand);break;case "pre_dec_expr":case "post_dec_expr":var operand=operand_stack.pop();operand_stack.push(--operand);break;case "positive_expr":var operand=operand_stack.pop();operand_stack.push(+operand);break;case "negative_expr":var operand=operand_stack.pop();operand_stack.push(-operand);break;case "one_compl_expr":var operand=operand_stack.pop();operand_stack.push(~operand);break;case "logic_negative_expr":var operand=
operand_stack.pop();operand_stack.push(!operand);break;default:m_util.panic("Unknown operation type: "+expr_list[i].type);break}if(operand_stack.length==1)return operand_stack[0];else m_util.panic("Incorrect expression: "+expr_list.join(" "))}function process_include(elem){var file=elem.file;var ast_inc=get_shader_ast(cfg_pth.shaders_dir,cfg_pth.shaders_include_dir+file);process_group(ast_inc)}function process_define(elem){var name=elem.name;var tokens=elem.tokens;dirs[name]=tokens;if(elem.params)fdirs[name]=
elem.params}function process_error(elem){var tokens=elem.tokens;throw"Shader error: #error "+tokens.join(" ");}function process_pragma(elem){var name=elem.name;var tokens=elem.tokens;lines.push("#pragma "+name+" "+tokens.join(" "))}function process_undef(elem){var name=elem.name;delete dirs[name];delete fdirs[name]}function process_warning(elem){var tokens=elem.tokens;m_print.warn("Shader warning: #warning "+tokens.join(" "))}function process_extension(elem){var tokens=elem.tokens;var token_list=
expand_macro(tokens,dirs,fdirs,false);lines.push("#extension "+token_list.join(" "))}function process_node(elem){shader_nodes[elem.name]=elem}function process_nodes_global(node_elements){for(var i=0;i<node_elements.length;i++){var nelem=node_elements[i];var node_parts=shader_nodes[nelem.id];if(!node_parts)continue;var param_index=0;for(var j=0;j<node_parts.declarations.length;j++){var part=node_parts.declarations[j];if(part.type=="node_param"){var glob_var_line=part.qualifier.join(" ")+" ";if(type==
"vert")glob_var_line+=nelem.vparams[param_index];else if(type=="frag"){glob_var_line+=nelem.params[param_index];if(nelem.param_values[param_index]!==null)glob_var_line+=" = "+nelem.param_values[param_index]}glob_var_line+=";";lines.push(glob_var_line);param_index++}}}}function process_nodes_main(nodes){for(var i=0;i<nodes.length;i++){var nelem=nodes[i];var node_parts=shader_nodes[nelem.id];if(!node_parts)continue;var replaces={};var node_dirs={};for(var j=0;j<nelem.dirs.length;j++)node_dirs[nelem.dirs[j][0]]=
[nelem.dirs[j][1]];input_index=0;output_index=0;param_index=0;process_node_declaration(nelem,node_parts.declarations,replaces,node_dirs);lines.push("{");process_node_statements(nelem,node_parts.statements,replaces,node_dirs);lines.push("}")}}function process_node_declaration(nelem,declarations,replaces,node_dirs){for(var j=0;j<declarations.length;j++){var decl=declarations[j];switch(decl.type){case "node_in":var new_name=nelem.inputs[input_index];if(nelem.input_values[input_index]!==null){if((nelem.id==
"MATERIAL_BEGIN"&&input_index===3||!node_dirs["MATERIAL_EXT"]&&(nelem.id=="MATERIAL_BEGIN"&&input_index===4||nelem.id=="MATERIAL_END"&&input_index===3||nelem.id=="MATERIAL_END"&&input_index===4||nelem.id=="MATERIAL_END"&&input_index===5)||nelem.id=="TEXTURE_COLOR"||nelem.id=="TEXTURE_NORMAL")&&decl.is_optional){replaces[decl.name]=nelem.input_values[input_index];input_index++;continue}var main_var_line=decl.qualifier.join(" ")+" ";main_var_line+=new_name;main_var_line+=" = "+nelem.input_values[input_index];
main_var_line+=";";lines.push(main_var_line)}replaces[decl.name]=new_name;input_index++;break;case "node_out":var new_name=nelem.outputs[output_index];if(!decl.is_optional||usage_inputs.indexOf(new_name)>-1){var main_var_line=decl.qualifier.join(" ")+" ";main_var_line+=new_name;main_var_line+=";";lines.push(main_var_line);replaces[decl.name]=new_name}if(usage_inputs.indexOf(new_name)>-1)node_dirs["USE_OUT_"+decl.name]=[1];output_index++;break;case "node_param":if(type=="vert")var new_name=nelem.vparams[param_index];
else if(type=="frag")var new_name=nelem.params[param_index];replaces[decl.name]=new_name;param_index++;break}}return replaces}function process_node_statements(nelem,statements,replaces,node_dirs){for(var i=0;i<statements.length;i++){var part=statements[i];switch(part.type){case "node_condition":process_node_condition(nelem,part.parts,replaces,node_dirs);break;case "textline":var tokens=[];for(var k=0;k<part.tokens.length;k++){var tok=part.tokens[k];if(tok in replaces)tokens.push(replaces[tok]);else tokens.push(tok)}var token_list=
expand_macro(tokens,dirs,fdirs,true,node_dirs);lines.push(token_list.join(" "));break}}}function process_node_condition(nelem,node_if_elements,replaces,node_dirs){for(var i=0;i<node_if_elements.length;i++){var nielem=node_if_elements[i];switch(nielem.type){case "node_if":case "node_elif":var expression=nielem.expression;var result=expression_result(expression,node_dirs);if(result){process_node_statements(nelem,nielem.statements,replaces,node_dirs);return}break;case "node_else":process_node_statements(nelem,
nielem.statements,replaces,node_dirs);return;case "node_ifdef":if(nielem.name in dirs||nielem.name in node_dirs)process_node_statements(nelem,nielem.statements,replaces,node_dirs);break;case "node_ifndef":if(!(nielem.name in dirs)&&!(nielem.name in node_dirs))process_node_statements(nelem,nielem.statements,replaces,node_dirs);break}}}function process_textline(elem){var tokens=elem.tokens;var token_list=expand_macro(tokens,dirs,fdirs,false);lines.push(token_list.join(" "))}}function expand_macro(tokens,
dirs,fdirs,empty_as_zero,node_dirs){var result=[];expand_macro_iter(tokens,dirs,fdirs,empty_as_zero,result,node_dirs);return result}function expand_macro_iter(tokens,dirs,fdirs,empty_as_zero,result,node_dirs){for(var i=0;i<tokens.length;i++){var token=tokens[i];if(token in dirs||node_dirs&&token in node_dirs){var new_tokens=node_dirs&&node_dirs[token]||dirs[token];if(new_tokens.length==0&&empty_as_zero)result.push(0);else expand_macro_iter(new_tokens,dirs,fdirs,empty_as_zero,result,node_dirs)}else result.push(token)}}
function init_shader(gl,vshader_text,fshader_text,shader_id,shaders_info){var vshader=compile_shader(gl,shader_id,vshader_text,gl.VERTEX_SHADER,shaders_info);var fshader=compile_shader(gl,shader_id,fshader_text,gl.FRAGMENT_SHADER,shaders_info);var program=gl.createProgram();gl.attachShader(program,vshader);gl.attachShader(program,fshader);gl.linkProgram(program);gl.validateProgram(program);if(gl.getProgramParameter(program,gl.VALIDATE_STATUS)==gl.FALSE)m_print.error("shader program is not valid",
shader_id);m_debug.check_shader_linking(program,shader_id,vshader,fshader,vshader_text,fshader_text);var compiled_shader={vshader:vshader,fshader:fshader,program:program,attributes:{},uniforms:{},permanent_uniform_setters:[],permanent_uniform_setters_table:{},transient_uniform_setters:[],shaders_info:shaders_info};var att_count=gl.getProgramParameter(program,gl.ACTIVE_ATTRIBUTES);for(var i=0;i<att_count;i++){var att=gl.getActiveAttrib(program,i);var att_name=att.name;var att_loc=gl.getAttribLocation(program,
att_name);compiled_shader.attributes[att_name]=att_loc}var uni_count=gl.getProgramParameter(program,gl.ACTIVE_UNIFORMS);for(var i=0;i<uni_count;i++){var uni=gl.getActiveUniform(program,i);var uni_name=uni.name.split("[0]").join("");var uni_loc=gl.getUniformLocation(program,uni_name);compiled_shader.uniforms[uni_name]=uni_loc}return compiled_shader}exports.debug_get_compilation_stats=function(){return _debug_hash_codes};function debug_compilation_uniqueness(shader_id,shader_text,shader_type,shaders_info){if(shader_type==
_gl.VERTEX_SHADER)var shader_filename=shaders_info.vert;else var shader_filename=shaders_info.frag;var hc=m_util.hash_code_string(shader_text,0);var info=_debug_hash_codes[hc];if(info)info.count++;else{info={count:1,shader_filename:shader_filename,hc:hc};_debug_hash_codes[hc]=info}}function compile_shader(gl,shader_id,shader_text,shader_type,shaders_info){if(DEBUG_COMPILATION_UNIQUENESS)debug_compilation_uniqueness(shader_id,shader_text,shader_type,shaders_info);var shader=gl.createShader(shader_type);
gl.shaderSource(shader,shader_text);gl.compileShader(shader);m_debug.check_shader_compiling(shader,shader_id,shader_text);return shader}exports.get_compiled_shaders=function(){return _compiled_shaders};exports.cleanup=cleanup;function cleanup(){for(var shader_id in _compiled_shaders){var shader=_compiled_shaders[shader_id];_gl.deleteProgram(shader.program);_gl.deleteShader(shader.vshader);_gl.deleteShader(shader.fshader);delete _compiled_shaders[shader_id]}for(var id in _shader_ast_cache)delete _shader_ast_cache[id];
for(var hc in _debug_hash_codes)delete _debug_hash_codes[hc]}exports.debug_shaders_info=function(shaders_info){var dirs=shaders_info.directives;m_print.log("Shader: "+shaders_info.vert+" "+shaders_info.frag+", "+String(dirs.length)+" directives: ");for(var i=0;i<dirs.length;i++)m_print.log("  "+dirs[i][0],dirs[i][1])};exports.glsl_value=glsl_value;function glsl_value(value,dim){if(!dim&&value.length)dim=value.length;else if(!dim)dim=1;switch(dim){case 1:return glsl_float(value);break;case 2:return"vec2("+
glsl_float(value[0])+","+glsl_float(value[1])+")";break;case 3:return"vec3("+glsl_float(value[0])+","+glsl_float(value[1])+","+glsl_float(value[2])+")";break;case 4:return"vec4("+glsl_float(value[0])+","+glsl_float(value[1])+","+glsl_float(value[2])+","+glsl_float(value[3])+")";break;case 9:return"mat3("+glsl_float(value[0])+","+glsl_float(value[1])+","+glsl_float(value[2])+","+glsl_float(value[3])+","+glsl_float(value[4])+","+glsl_float(value[5])+","+glsl_float(value[6])+","+glsl_float(value[7])+
","+glsl_float(value[8])+")";break;case 16:return"mat4("+glsl_float(value[0])+","+glsl_float(value[1])+","+glsl_float(value[2])+","+glsl_float(value[3])+","+glsl_float(value[4])+","+glsl_float(value[5])+","+glsl_float(value[6])+","+glsl_float(value[7])+","+glsl_float(value[8])+","+glsl_float(value[9])+","+glsl_float(value[10])+","+glsl_float(value[11])+","+glsl_float(value[12])+","+glsl_float(value[13])+","+glsl_float(value[14])+","+glsl_float(value[15])+")";break;default:throw"Wrong glsl value dimension";
break}}function glsl_float(value){return value%1?String(value):String(value)+".0"}exports.check_uniform=function(shader,name){if(name in shader.uniforms)return true;else return false};exports.get_varyings_count=function(shader){return(_gl.getShaderSource(shader).match(/(?:^|\s)varying(?=\s)/g)||[]).length}};b4w.module["__geometry"]=function(exports,require){var m_ext=require("__extensions");var m_print=require("__print");var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("__vec3");var _vec3_tmp=new Float32Array(3);var _vec3_tmp2=new Float32Array(3);var _vec3_tmp3=new Float32Array(3);var MAX_SUBMESH_LENGTH=256*256;var BINARY_FLOAT_SIZE=4;var COMB_SORT_JUMP_COEFF=1.247330950103979;var POS_NUM_COMP=3;var NOR_NUM_COMP=3;var TAN_NUM_COMP=4;var COL_NUM_COMP=3;var INFLUENCE_NUM_COMP=
4;exports.ZSORT_DISABLED=10;exports.ZSORT_BACK_TO_FRONT=20;exports.ZSORT_FRONT_TO_BACK=30;exports.DM_TRIANGLES=10;exports.DM_POINTS=20;exports.DM_DYNAMIC_TRIANGLES=30;exports.DM_DYNAMIC_POINTS=40;exports.DM_LINES=50;exports.SORT_NUMERIC=0;exports.SORT_STRING=1;exports.DM_DEFAULT=exports.DM_TRIANGLES;var _gl=null;exports.setup_context=function(gl){_gl=gl};exports.delete_buffers=function(geometry_id){var buffers=_buffers[geometry_id];_gl.deleteBuffer(buffers.ibo);_gl.deleteBuffer(buffers.vbo);delete _buffers[geometry_id]};
exports.submesh_to_bufs_data=function(submesh,zsort_type,draw_mode,vc_usage){if(is_long_submesh(submesh))submesh_drop_indices(submesh);var indices=submesh.indices;var base_length=submesh.base_length;var va_frames=submesh.va_frames;var va_common={};for(var attr_name in submesh.va_common)if(!(attr_name in vc_usage)||vc_usage[attr_name].generate_buffer)va_common[attr_name]=submesh.va_common[attr_name];var bufs_data=init_bufs_data();if(submesh.shape_keys.length>0)submesh_init_shape_keys(submesh,va_frames[0]);
generate_bufs_data_arrays(bufs_data,indices,va_frames,va_common,base_length);update_draw_mode(bufs_data,draw_mode);update_gl_buffers(bufs_data);if(zsort_type!=exports.ZSORT_DISABLED&&is_indexed(submesh)){var positions=va_frames[0]["a_position"];bufs_data.info_for_z_sort_updates={median_cache:new Float32Array(indices.length),median_world_cache:new Float32Array(indices.length),dist_cache:new Float32Array(indices.length/3),type:zsort_type}}bufs_data.shape_keys=submesh.shape_keys;return bufs_data};function submesh_init_shape_keys(submesh,
frame){for(var i=1;i<submesh.shape_keys.length;i++){var geometry=submesh.shape_keys[i].geometry;var a_pos=geometry["a_position"];var a_nor=geometry["a_normal"];var f_a_pos=frame["a_position"];var f_a_nor=frame["a_normal"];var pos_nor_length=a_pos.length;var value=submesh.shape_keys[i].init_value;for(var j=0;j<pos_nor_length;j++){f_a_pos[j]+=value*a_pos[j];f_a_nor[j]+=value*a_nor[j]}var a_tan=geometry["a_tangent"];var f_a_tan=frame["a_tangent"];var tan_length=a_tan.length;for(var j=0;j<tan_length;j++)f_a_tan[j]+=
value*a_tan[j]}}exports.is_long_submesh=is_long_submesh;function is_long_submesh(submesh){var base_length=submesh.base_length;if(base_length>MAX_SUBMESH_LENGTH){if(m_ext.get_elem_index_uint())return false;return true}return false}exports.is_indexed=is_indexed;function is_indexed(submesh){if(submesh.indices.length>0)return true;else return false}exports.submesh_drop_indices=submesh_drop_indices;function submesh_drop_indices(submesh,count,is_manually_dropped){if(!is_indexed(submesh))return submesh;
count=count||1;if(!is_manually_dropped)m_print.log('%cDEBUG max vertices exceeded for indexed submesh "'+submesh.name+'": '+submesh.base_length*count+", will use drawArrays","color: #aa0");var indices=submesh.indices;var base_length=submesh.base_length;var va_common=submesh.va_common;var va_frames=submesh.va_frames;for(var name in va_common){var arr=va_common[name];var nc=num_comp(arr,base_length);va_common[name]=expand_vertex_array_i(indices,arr,nc)}for(var i=0;i<va_frames.length;i++){var va_frame=
va_frames[i];for(var name in va_frame){var arr=va_frame[name];var nc=num_comp(arr,base_length);va_frame[name]=expand_vertex_array_i(indices,arr,nc)}}for(var i=0;i<submesh.shape_keys.length;i++){var geometry=submesh.shape_keys[i].geometry;for(var att_name in geometry){var arr=geometry[att_name];var nc=num_comp(arr,base_length);geometry[att_name]=expand_vertex_array_i(indices,arr,nc)}}submesh.base_length=indices.length;submesh.indices=new Uint16Array(0);return submesh}function expand_vertex_array_i(indices,
vertex_array,num_comp){if(vertex_array.length==0)return new Float32Array(0);var len=indices.length*num_comp;var new_vertex_array=new Float32Array(len);for(var i=0;i<indices.length;i++){var index=indices[i];for(var j=0;j<num_comp;j++)new_vertex_array[num_comp*i+j]=vertex_array[num_comp*index+j]}return new_vertex_array}exports.update_bufs_data_index_array=function(bufs_data,draw_mode,indices){update_draw_mode(bufs_data,draw_mode);bufs_data.count=indices.length;bufs_data.ibo_array=indices;if(indices instanceof
Uint16Array)bufs_data.ibo_type=_gl.UNSIGNED_SHORT;else bufs_data.ibo_type=_gl.UNSIGNED_INT;return bufs_data};function init_bufs_data(){return{ibo_array:null,vbo_array:null,ibo_type:0,count:0,pointers:{},mode:0,usage:0,debug_ibo_bytes:0,debug_vbo_bytes:0,vbo:null,ibo:null,info_for_z_sort_updates:null,shape_keys:null}}exports.update_bufs_data_array=function(bufs_data,attrib_name,num_comp,array){var vbo_array=bufs_data.vbo_array;var pointers=bufs_data.pointers;var pointer=pointers[attrib_name];if(pointer){if(num_comp&&
pointer.num_comp!=num_comp)m_util.panic('invalid num_comp for "'+attrib_name+'"');vbo_array.set(array,pointer.offset)}else{var len=vbo_array.length;var vbo_array_new=new Float32Array(len+array.length);vbo_array_new.set(bufs_data.vbo_array);vbo_array_new.set(array,len);bufs_data.vbo_array=vbo_array_new;pointers[attrib_name]={num_comp:num_comp,offset:len}}update_gl_buffers(bufs_data);return bufs_data};exports.extract_array=extract_array;function extract_array(bufs_data,name){var vbo_array=bufs_data.vbo_array;
var pointers=bufs_data.pointers;var pointer=pointers[name];if(pointer)return vbo_array.subarray(pointer.offset,pointer.offset+pointer.length);else throw"extract_array() failed; invalid name: "+name;}function update_draw_mode(bufs_data,draw_mode){var mode;var usage;switch(draw_mode){case exports.DM_DEFAULT:case exports.DM_TRIANGLES:mode=_gl.TRIANGLES;usage=_gl.STATIC_DRAW;break;case exports.DM_POINTS:mode=_gl.POINTS;usage=_gl.STATIC_DRAW;break;case exports.DM_DYNAMIC_TRIANGLES:mode=_gl.TRIANGLES;usage=
_gl.DYNAMIC_DRAW;break;case exports.DM_DYNAMIC_POINTS:mode=_gl.POINTS;usage=_gl.DYNAMIC_DRAW;break;case exports.DM_LINES:mode=_gl.LINES;usage=_gl.STATIC_DRAW;break;default:throw"Wrong draw_mode";}bufs_data.mode=mode;bufs_data.usage=usage}exports.make_static=function(bufs_data){bufs_data.usage=_gl.STATIC_DRAW};exports.make_dynamic=function(bufs_data){bufs_data.usage=_gl.DYNAMIC_DRAW};function generate_bufs_data_arrays(bufs_data,indices,va_frames,va_common,base_length){if(indices.length){var count=
indices.length;if(base_length<=MAX_SUBMESH_LENGTH){var ibo_array=new Uint16Array(indices);var ibo_type=_gl.UNSIGNED_SHORT}else{var ibo_array=new Uint32Array(indices);var ibo_type=_gl.UNSIGNED_INT}}else{var count=base_length;var ibo_array=null}var vbo_array_length=calc_vbo_length(va_frames,va_common);var vbo_array=new Float32Array(vbo_array_length);var offset=0;var pointers={};for(var name in va_common){var arr=va_common[name];var len=arr.length;if(!len)continue;vbo_array.set(arr,offset);pointers[name]=
{attribute_name:name,num_comp:num_comp(arr,base_length),offset:offset,frames:1,length:len};offset+=len}var frames_count=va_frames.length;for(var name in va_frames[0]){var arr0=va_frames[0][name];var len=arr0.length;var ncomp=num_comp(arr0,base_length);if(!len)continue;pointers[name]={num_comp:ncomp,offset:offset,frames:frames_count,length:len};if(frames_count>1)pointers[name+"_next"]={num_comp:ncomp,offset:offset+len,frames:frames_count,length:len};for(var i=0;i<frames_count;i++){var va_frame=va_frames[i];
var arr=va_frame[name];vbo_array.set(arr,offset);offset+=len}}bufs_data.count=count;bufs_data.ibo_array=ibo_array;bufs_data.vbo_array=vbo_array;bufs_data.ibo_type=ibo_type;bufs_data.pointers=pointers}function calc_vbo_length(va_frames,va_common){var len=0;var frames_count=va_frames.length;for(var name in va_frames[0]){var arr=va_frames[0][name];len+=arr.length*frames_count}for(var name in va_common){var arr=va_common[name];len+=arr.length}return len}exports.update_gl_buffers=update_gl_buffers;function update_gl_buffers(bufs_data){if(bufs_data.ibo_array){if(!bufs_data.ibo)bufs_data.ibo=
_gl.createBuffer();_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,bufs_data.ibo);_gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,bufs_data.ibo_array,bufs_data.usage);bufs_data.debug_ibo_bytes=bufs_data.ibo_array.byteLength}else bufs_data.debug_ibo_bytes=0;if(!bufs_data.vbo)bufs_data.vbo=_gl.createBuffer();_gl.bindBuffer(_gl.ARRAY_BUFFER,bufs_data.vbo);_gl.bufferData(_gl.ARRAY_BUFFER,bufs_data.vbo_array,bufs_data.usage);bufs_data.debug_vbo_bytes=bufs_data.vbo_array.byteLength}exports.cleanup_bufs_data=function(bufs_data){if(bufs_data.ibo)_gl.deleteBuffer(bufs_data.ibo);
if(bufs_data.vbo)_gl.deleteBuffer(bufs_data.vbo)};exports.has_empty_submesh=function(mesh,index){var bsub=mesh["submeshes"][index];if(bsub["base_length"])return false;else return true};exports.submesh_apply_transform=submesh_apply_transform;function submesh_apply_transform(submesh,transform){var base_length=submesh.base_length;for(var f=0;f<submesh.va_frames.length;f++){var positions=submesh.va_frames[f]["a_position"];m_tsr.transform_vectors(positions,transform,positions,0);var normals=submesh.va_frames[f]["a_normal"];
if(normals.length>0)m_tsr.transform_dir_vectors(normals,transform,normals,0);var tangents=submesh.va_frames[f]["a_tangent"];if(tangents.length>0)m_tsr.transform_tangents(tangents,transform,tangents,0)}var au_center_pos=submesh.va_common["au_center_pos"];if(au_center_pos&&au_center_pos.length)m_tsr.transform_vectors(au_center_pos,transform,au_center_pos,0);return submesh}exports.submesh_apply_particle_transform=submesh_apply_particle_transform;function submesh_apply_particle_transform(submesh,transform){var au_center_pos=
submesh.va_common["au_center_pos"];if(au_center_pos&&au_center_pos.length){var cen_pos_transformed=new Float32Array(au_center_pos);m_tsr.transform_vectors(cen_pos_transformed,transform,cen_pos_transformed,0);for(var i=0;i<submesh.va_frames.length;i++)for(var j=0;j<cen_pos_transformed.length;j++)submesh.va_frames[i]["a_position"][j]+=cen_pos_transformed[j]-au_center_pos[j];au_center_pos.set(cen_pos_transformed)}else throw'Attribute "au_center_pos" is missing in particle submesh';return submesh}exports.submesh_apply_params=
submesh_apply_params;function submesh_apply_params(submesh,params){var base_length=submesh.base_length;for(var param in params){var param_len=params[param].length;var len=params[param].length*base_length;submesh.va_common[param]=new Float32Array(param_len*base_length);for(var i=0;i<base_length;i++)for(var j=0;j<param_len;j++)submesh.va_common[param][i*param_len+j]=params[param][j]}return submesh}function gen_buf_clone_source(source,n){var len=source.length;var new_buf=new Float32Array(len*n);for(var i=
0;i<n;i++)for(var j=0;j<len;j++)new_buf[i*len+j]=source[j];return new_buf}exports.submesh_list_join=submesh_list_join;function submesh_list_join(submeshes){var submesh0=submeshes[0];var new_submesh=submesh_list_join_prepare_dest(submeshes);var i_offset=0;var v_ind_offset=0;var keys={};for(var i=0;i<submeshes.length;i++){var submesh=submeshes[i];var indices=submesh.indices;var base_length=submesh.base_length;var va_common=submesh.va_common;var va_frames=submesh.va_frames;for(var j=0;j<indices.length;j++){var ind=
indices[j];new_submesh.indices[i_offset+j]=ind+v_ind_offset}i_offset+=indices.length;for(var param_name in va_common){var arr=va_common[param_name];var offset=v_ind_offset*num_comp(arr,base_length);new_submesh.va_common[param_name].set(arr,offset)}for(var j=0;j<submesh.va_frames.length;j++){var va_frame=submesh.va_frames[j];var new_va_frame=new_submesh.va_frames[j];for(var param_name in va_frame){var arr=va_frame[param_name];var offset=v_ind_offset*num_comp(arr,base_length);new_va_frame[param_name].set(arr,
offset)}}v_ind_offset+=base_length}if(new_submesh.shape_keys.length>0)for(var i=0;i<new_submesh.shape_keys.length;i++){var geometry=new_submesh.shape_keys[i].geometry;var a_pos_offset=0;var a_nor_offset=0;var a_tan_offset=0;for(var j=0;j<submeshes.length;j++){var cur_key_geom=submeshes[j].shape_keys[i].geometry;geometry["a_position"].set(cur_key_geom["a_position"],a_pos_offset);geometry["a_normal"].set(cur_key_geom["a_normal"],a_nor_offset);geometry["a_tangent"].set(cur_key_geom["a_tangent"],a_tan_offset);
a_pos_offset+=cur_key_geom["a_position"].length;a_nor_offset+=cur_key_geom["a_normal"].length;a_tan_offset+=cur_key_geom["a_tangent"].length}}return new_submesh}function submesh_list_join_prepare_dest(submeshes){var new_submesh=m_util.create_empty_submesh("JOIN_"+submeshes.length+"_SUBMESHES");var len=0;for(var i=0;i<submeshes.length;i++)len+=submeshes[i].indices.length;new_submesh.indices=new Uint32Array(len);var pos_len=0;var nor_len=0;var tan_len=0;if(submeshes[0].shape_keys.length>0)for(var j=
0;j<submeshes[0].shape_keys.length;j++){for(var i=0;i<submeshes.length;i++){pos_len+=submeshes[i].shape_keys[j].geometry["a_position"].length;nor_len+=submeshes[i].shape_keys[j].geometry["a_normal"].length;tan_len+=submeshes[i].shape_keys[j].geometry["a_tangent"].length}var geometry={"a_position":new Float32Array(pos_len),"a_normal":new Float32Array(nor_len),"a_tangent":new Float32Array(tan_len)};var key={init_value:submeshes[0].shape_keys[j].init_value,geometry:geometry};new_submesh.shape_keys.push(key)}len=
0;for(var i=0;i<submeshes.length;i++)len+=submeshes[i].base_length;new_submesh.base_length=len;var submesh0=submeshes[0];for(var param_name in submesh0.va_common){len=0;for(var i=0;i<submeshes.length;i++)len+=submeshes[i].va_common[param_name].length;new_submesh.va_common[param_name]=new Float32Array(len)}for(var param_name in submesh0.va_frames[0]){len=0;for(var i=0;i<submeshes.length;i++)len+=submeshes[i].va_frames[0][param_name].length;for(var i=0;i<submesh0.va_frames.length;i++){new_submesh.va_frames[i]=
new_submesh.va_frames[i]||{};new_submesh.va_frames[i][param_name]=new Float32Array(len)}}return new_submesh}exports.make_clone_submesh=function(src_submesh,params,transforms){if(!src_submesh.base_length)return m_util.create_empty_submesh("EMPTY");var count=transforms.length;if(src_submesh.base_length*count>MAX_SUBMESH_LENGTH&&!m_ext.get_elem_index_uint())submesh_drop_indices(src_submesh,count);var indices=src_submesh.indices;var base_length=src_submesh.base_length;var va_common=src_submesh.va_common;
var va_frames=src_submesh.va_frames;for(var param in params){var param_len=params[param].length;var len=param_len*base_length;va_common[param]=new Float32Array(len);for(var i=0;i<base_length;i++)for(var j=0;j<param_len;j++)va_common[param][i*param_len+j]=params[param][j]}var new_submesh=m_util.create_empty_submesh("CLONE_"+count+"_SUBMESHES");new_submesh.base_length=base_length*count;new_submesh.indices=new Uint32Array(indices.length*count);for(var i=0;i<count;i++){var i_offset=indices.length*i;var v_offset=
base_length*i;for(var j=0;j<indices.length;j++){var ind=indices[j];new_submesh.indices[i_offset+j]=ind+v_offset}}for(var param_name in va_common){var arr=va_common[param_name];var len=arr.length*count;var ncomp=num_comp(arr,base_length);new_submesh.va_common[param_name]=new Float32Array(len);for(var i=0;i<count;i++){var v_offset=base_length*ncomp*i;new_submesh.va_common[param_name].set(arr,v_offset)}}for(var param_name in va_frames[0])for(var i=0;i<va_frames.length;i++){var arr=va_frames[i][param_name];
var len=arr.length*count;var ncomp=num_comp(arr,base_length);new_submesh.va_frames[i]=new_submesh.va_frames[i]||{};new_submesh.va_frames[i][param_name]=new Float32Array(len);for(var j=0;j<count;j++){var transform=transforms[j];var v_offset=base_length*ncomp*j;switch(param_name){case "a_position":m_tsr.transform_vectors(arr,transform,new_submesh.va_frames[i][param_name],v_offset);break;case "a_normal":m_tsr.transform_dir_vectors(arr,transform,new_submesh.va_frames[i][param_name],v_offset);break;case "a_tangent":m_tsr.transform_tangents(arr,
transform,new_submesh.va_frames[i][param_name],v_offset);break;default:throw"Wrong attribute name: "+param_name;break}}}return new_submesh};exports.extract_submesh=extract_submesh;function extract_submesh(mesh,material_index,attr_names,bone_skinning_info,vertex_colors_usage,uv_maps_usage){var submesh=m_util.create_empty_submesh("SUBMESH_"+mesh["name"]+"_"+material_index);var bsub=mesh["submeshes"][material_index];var base_length=bsub["base_length"];var mat=mesh["materials"][material_index];submesh.base_length=
base_length;var use_shape_keys=false;if(has_attr(attr_names,"a_texcoord"))var texcoords=extract_texcoords(mesh,material_index);else var texcoords=new Float32Array(0);if(has_attr(attr_names,"a_orco_tex_coord"))var local_coord=extract_orco_texcoords_nodes(mesh,bsub);else var local_coord=new Float32Array(0);var influences=extract_influences(attr_names,base_length,bone_skinning_info,bsub["group"]);if(vertex_colors_usage)var submesh_vc_usage=m_util.clone_object_r(vertex_colors_usage);else var submesh_vc_usage=
{};submesh_vc_usage["a_color"]={generate_buffer:true};if(has_attr(attr_names,"a_color")&&mesh["active_vcol_name"])submesh_vc_usage["a_color"].src=[{name:mesh["active_vcol_name"],mask:7}];else submesh_vc_usage["a_color"].src=[];var va_common={"a_texcoord":texcoords,"a_influence":influences,"a_orco_tex_coord":local_coord};extract_vcols(va_common,submesh_vc_usage,bsub["vertex_colors"],bsub["color"],base_length,mesh["name"]);assign_node_uv_maps(mesh["uv_textures"],bsub["texcoord"],bsub["texcoord2"],uv_maps_usage,
base_length,va_common,mesh["name"]);submesh.va_common=va_common;submesh.indices=new Uint32Array(bsub["indices"]);var frames=bsub["position"].length/base_length/POS_NUM_COMP;if(has_attr(attr_names,"a_normal")&&bsub["normal"].length)var use_normal=true;else var use_normal=false;if(use_normal&&has_attr(attr_names,"a_tangent")&&bsub["tangent"].length)var use_tangent=true;else var use_tangent=false;var texslot=mat["texture_slots"][0];if(use_normal&&mat["texture_slots"].length&&has_attr(attr_names,"a_tangent")&&
texslot["texture_coords"]=="ORCO"&&texslot["use_map_normal"])var use_orco_nmap_coords=true;else var use_orco_nmap_coords=false;if(mesh["b4w_shape_keys"].length>0)use_shape_keys=true;for(var i=0;i<frames;i++){var va_frame=create_frame(submesh,bsub,attr_names,base_length,use_normal,use_tangent,use_orco_nmap_coords,i,mesh["name"]);if(use_shape_keys){var sk_frame={};sk_frame.name=mesh["b4w_shape_keys"][i]["name"];submesh.shape_keys.push(sk_frame);if(i!=0){sk_frame.geometry=va_frame;sk_frame.init_value=
mesh["b4w_shape_keys"][i]["value"];continue}else{sk_frame.geometry=create_frame(submesh,bsub,attr_names,base_length,use_normal,use_tangent,use_orco_nmap_coords,i,mesh["name"]);sk_frame.init_value=1}}submesh.va_frames.push(va_frame)}if(frames>1&&!use_shape_keys){var va_frame0=submesh.va_frames[0];var va_frame={};for(var prop in va_frame0)va_frame[prop]=new Float32Array(va_frame0[prop]);submesh.va_frames.push(va_frame)}if(has_attr(attr_names,"a_polyindex")){submesh_drop_indices(submesh,1,true);submesh.va_common["a_polyindex"]=
extract_polyindices(submesh)}return submesh}function create_frame(submesh,bsub,attr_names,base_length,use_normal,use_tangent,use_orco_nmap_coords,frame_index,mesh_name){var va_frame={};var pos_arr=new Float32Array(base_length*POS_NUM_COMP);var nor_arr=new Float32Array(use_normal?base_length*NOR_NUM_COMP:0);var tan_arr=new Float32Array(use_tangent||use_orco_nmap_coords?base_length*TAN_NUM_COMP:0);var from_index=frame_index*base_length*POS_NUM_COMP;var to_index=from_index+base_length*POS_NUM_COMP;pos_arr.set(bsub["position"].subarray(from_index,
to_index),0);if(use_normal){var from_index=frame_index*base_length*NOR_NUM_COMP;var to_index=from_index+base_length*NOR_NUM_COMP;nor_arr.set(bsub["normal"].subarray(from_index,to_index),0)}if(use_tangent){var from_index=frame_index*base_length*TAN_NUM_COMP;var to_index=from_index+base_length*TAN_NUM_COMP;tan_arr.set(bsub["tangent"].subarray(from_index,to_index),0)}else if(use_orco_nmap_coords)generate_orco_tangents(nor_arr,tan_arr,base_length,mesh_name);else if(use_normal&&has_attr(attr_names,"a_tangent")){var tan_arr=
new Float32Array(base_length*TAN_NUM_COMP);for(var i=0;i<tan_arr.length;i++)tan_arr[i]=1}va_frame["a_position"]=pos_arr;va_frame["a_normal"]=nor_arr;va_frame["a_tangent"]=tan_arr;return va_frame}function extract_texcoords(mesh,material_index){var texcoords=null;var material=mesh["materials"][material_index];var submesh=mesh["submeshes"][material_index];if(material["texture_slots"].length){var slot=material["texture_slots"][0];switch(slot["texture_coords"]){case "UV":var index=mesh["uv_textures"].indexOf(slot["uv_layer"]);
if(index==0)texcoords=new Float32Array(submesh["texcoord"]);else if(index==1)texcoords=new Float32Array(submesh["texcoord2"]);break;case "ORCO":texcoords=generate_orco_texcoords(mesh["b4w_bounding_box_source"],submesh);break}}if(texcoords===null)texcoords=new Float32Array(submesh["base_length"]*2);return texcoords}function extract_orco_texcoords_nodes(mesh,submesh){var bb=mesh["b4w_bounding_box_source"];var local_coords=new Float32Array(submesh["base_length"]*3);var pos=submesh["position"];var size_x=
bb["max_x"]-bb["min_x"];var size_y=bb["max_y"]-bb["min_y"];var size_z=bb["max_z"]-bb["min_z"];var localco_index=0;for(var i=0;i<submesh["position"].length;i+=3){if(size_x==0)local_coords[localco_index++]=.5;else local_coords[localco_index++]=m_util.clamp(parseFloat(((submesh["position"][i]-bb.min_x)/size_x).toFixed(5)),0,1);if(size_z==0)local_coords[localco_index++]=.5;else local_coords[localco_index++]=m_util.clamp(parseFloat(((bb.max_z-submesh["position"][i+2])/size_z).toFixed(5)),0,1);if(size_y==
0)local_coords[localco_index++]=.5;else local_coords[localco_index++]=m_util.clamp(parseFloat(((submesh["position"][i+1]-bb.min_y)/size_y).toFixed(5)),0,1)}return local_coords}function generate_orco_texcoords(bb,submesh){var texcoords=new Float32Array(submesh["base_length"]*2);var pos=submesh["position"];var center_x=(bb["max_x"]+bb["min_x"])/2;var center_z=(bb["max_z"]+bb["min_z"])/2;var size_x=bb["max_x"]-bb["min_x"];var size_z=bb["max_z"]-bb["min_z"];var texco_index=0;for(var i=0;i<submesh["position"].length;i+=
3){texcoords[texco_index++]=(submesh["position"][i]-center_x)/size_x+.5;texcoords[texco_index++]=(center_z-submesh["position"][i+2])/size_z+.5}return texcoords}function generate_orco_tangents(nor_arr,tan_arr,base_length,mesh_name){m_print.warn("Not precise tangents calculation for normalmap "+'using GENERATED texture coordinates in mesh: "'+mesh_name+'". Please add a UV-map.');for(var i=0;i<base_length;i++){var nor=_vec3_tmp;var tan=_vec3_tmp2;nor[0]=nor_arr[NOR_NUM_COMP*i];nor[1]=nor_arr[NOR_NUM_COMP*
i+1];nor[2]=nor_arr[NOR_NUM_COMP*i+2];m_vec3.cross(nor,m_util.AXIS_Z,tan);if(m_vec3.length(tan)==0)m_vec3.cross(nor,m_util.AXIS_X,tan);m_vec3.normalize(tan,tan);tan_arr[TAN_NUM_COMP*i]=tan[0];tan_arr[TAN_NUM_COMP*i+1]=tan[1];tan_arr[TAN_NUM_COMP*i+2]=tan[2];tan_arr[TAN_NUM_COMP*i+3]=1}}function extract_vcols(va_common,vc_usage,submesh_vc,bsub_color,base_length,mesh_name){var submesh_vc_names=submesh_vc_get_names(submesh_vc);for(var attr_name in vc_usage){var colors_data=vc_usage[attr_name].src;if(colors_data.length){var dst_channels_count=
0;for(var i=0;i<colors_data.length;i++)dst_channels_count+=m_util.rgb_mask_get_channels_count(colors_data[i].mask);va_common[attr_name]=new Float32Array(dst_channels_count*base_length);var dst_channel_index_offset=0;for(var i=0;i<colors_data.length;i++){var color_name=colors_data[i].name;var color_mask=colors_data[i].mask;var channels_presence=m_util.rgb_mask_get_channels_presence(color_mask);var color_name_index=submesh_vc_names.indexOf(color_name);if(color_name_index==-1)m_util.panic('vertex color "'+
color_name+'" for mesh "'+mesh_name+'" not found.');var mask_exported=submesh_vc[color_name_index]["mask"];var exported_channels_count=m_util.rgb_mask_get_channels_count(mask_exported);if((color_mask&mask_exported)!==color_mask)m_print.error("Wrong color extraction from "+color_name+" to "+attr_name+".");var exported_colors_offset=submesh_vc_get_offset(submesh_vc,color_name_index,base_length);for(var j=0;j<base_length;j++)for(var k=0;k<COL_NUM_COMP;k++)if(channels_presence[k]){var dst_channel_index=
dst_channel_index_offset+m_util.rgb_mask_get_channel_presence_index(color_mask,k);var exported_channel_index=m_util.rgb_mask_get_channel_presence_index(mask_exported,k);va_common[attr_name][j*dst_channels_count+dst_channel_index]=bsub_color[exported_colors_offset+j*exported_channels_count+exported_channel_index]}dst_channel_index_offset+=exported_channels_count}}else va_common[attr_name]=new Float32Array(0)}}function submesh_vc_get_names(submesh_vc){var submesh_vc_names=[];for(var i=0;i<submesh_vc.length;i++)submesh_vc_names.push(submesh_vc[i]["name"]);
return submesh_vc_names}function submesh_vc_get_offset(submesh_vc,vc_index,base_length){var offset=0;for(var i=0;i<vc_index;i++)offset+=m_util.rgb_mask_get_channels_count(submesh_vc[i]["mask"]);return offset*base_length}function assign_node_uv_maps(mesh_uvs,bsub_texcoord,bsub_texcoord2,uv_maps_usage,base_length,va_common,mesh_name){if(!uv_maps_usage)return;for(var uv_name in uv_maps_usage){var uv_map_index=mesh_uvs.indexOf(uv_name);if(uv_map_index==0)var uv_node_arr=new Float32Array(bsub_texcoord);
else if(uv_map_index==1)var uv_node_arr=new Float32Array(bsub_texcoord2);va_common[uv_maps_usage[uv_name]]=uv_node_arr}}exports.extract_halo_submesh=function(submesh){var base_length=submesh.base_length;var position_in=submesh.va_frames[0]["a_position"];var pos_arr=new Float32Array(12*base_length);var bb_vert_arr=new Float32Array(8*base_length);var indices_out=new Uint16Array(4*submesh.indices.length);for(var i=0;i<base_length;i++){pos_arr[12*i]=position_in[3*i];pos_arr[12*i+1]=position_in[3*i+1];
pos_arr[12*i+2]=position_in[3*i+2];pos_arr[12*i+3]=position_in[3*i];pos_arr[12*i+4]=position_in[3*i+1];pos_arr[12*i+5]=position_in[3*i+2];pos_arr[12*i+6]=position_in[3*i];pos_arr[12*i+7]=position_in[3*i+1];pos_arr[12*i+8]=position_in[3*i+2];pos_arr[12*i+9]=position_in[3*i];pos_arr[12*i+10]=position_in[3*i+1];pos_arr[12*i+11]=position_in[3*i+2];bb_vert_arr[8*i]=-.5;bb_vert_arr[8*i+1]=-.5;bb_vert_arr[8*i+2]=-.5;bb_vert_arr[8*i+3]=.5;bb_vert_arr[8*i+4]=.5;bb_vert_arr[8*i+5]=.5;bb_vert_arr[8*i+6]=.5;
bb_vert_arr[8*i+7]=-.5;indices_out[6*i]=4*i+2;indices_out[6*i+1]=4*i+1;indices_out[6*i+2]=4*i;indices_out[6*i+3]=4*i+2;indices_out[6*i+4]=4*i;indices_out[6*i+5]=4*i+3}var halo_submesh=m_util.create_empty_submesh("HALO");halo_submesh.va_frames=[];halo_submesh.va_frames[0]={};halo_submesh.base_length=4*base_length;halo_submesh.va_frames[0]["a_position"]=pos_arr;halo_submesh.va_common["a_halo_bb_vertex"]=bb_vert_arr;halo_submesh.indices=indices_out;return halo_submesh};exports.has_attr=has_attr;function has_attr(attr_names,
name){if(attr_names.indexOf(name)>-1)return true;else return false}exports.extract_submesh_all_mats=function(mesh,attr_names,common_vc_usage){var submeshes=[];for(var i=0;i<mesh["submeshes"].length;i++){var submesh=extract_submesh(mesh,i,attr_names,null,common_vc_usage,null);if(submesh.base_length)submeshes.push(submesh)}if(submeshes.length==0)var submesh_all=m_util.create_empty_submesh("EMPTY");else if(submeshes.length==1)var submesh_all=submeshes[0];else var submesh_all=submesh_list_join(submeshes);
return submesh_all};function extract_influences(attr_names,base_length,bone_skinning_info,groups){if(has_attr(attr_names,"a_influence")&&bone_skinning_info){var influences=new Float32Array(base_length*INFLUENCE_NUM_COMP);var groups_num=groups.length/base_length;var deform_bone_indices=get_deform_bone_indices(bone_skinning_info,groups_num);var buf_length=groups_num>3?groups_num:4;var weights_buf=new Float32Array(buf_length);var bones_buf=new Uint32Array(buf_length);var res_buf=new Float32Array(INFLUENCE_NUM_COMP);
var zero_weights=new Float32Array(buf_length);var zero_bones=new Uint32Array(buf_length);var zero_res=new Float32Array(INFLUENCE_NUM_COMP);for(var i=0;i<base_length;i++){weights_buf.set(zero_weights);bones_buf.set(zero_bones);res_buf.set(zero_res);influences.set(get_vertex_influences(groups,groups_num,i,base_length,deform_bone_indices,weights_buf,bones_buf,res_buf),i*INFLUENCE_NUM_COMP)}}else var influences=new Float32Array(0);return influences}function get_deform_bone_indices(bone_skinning_info,
groups_num){var deform_bone_indices=new Float32Array(groups_num);for(var i=0;i<groups_num;i++){deform_bone_indices[i]=-1;for(var j in bone_skinning_info){var bone_sk_info=bone_skinning_info[j];if(bone_sk_info.vgroup_index===i){deform_bone_indices[i]=bone_sk_info.deform_bone_index;break}}}return deform_bone_indices}function get_vertex_influences(vertex_groups,groups_num,vert_index,base_length,deform_bone_indices,weights_buf,bones_buf,res_buf){var precision=.01;var no_weights=true;for(var i=0;i<groups_num;i++){var weight=
vertex_groups[i*base_length+vert_index];if(weight!==-1){var bone_index=deform_bone_indices[i];if(bone_index!==-1){weights_buf[i]=weight;bones_buf[i]=bone_index;no_weights=false}}}if(no_weights)return res_buf;sort_two_arrays(weights_buf,bones_buf,exports.SORT_NUMERIC,false);var sum_weights=0;for(var i=0;i<INFLUENCE_NUM_COMP;i++)sum_weights+=weights_buf[i];if(sum_weights<precision)return res_buf;for(var i=0;i<INFLUENCE_NUM_COMP;i++)weights_buf[i]/=sum_weights;if(Math.abs(weights_buf[0]-1)<precision)res_buf[0]=
bones_buf[0]+1;else for(var i=0;i<INFLUENCE_NUM_COMP;i++)res_buf[i]=bones_buf[i]+weights_buf[i];return res_buf}function num_comp(array,base_length){if(base_length==0)return 0;var array_length=array.length;var factor=array_length/base_length;if(factor!=Math.floor(factor))throw"Array size mismatch during geometry calculation: array length="+array_length+", base length="+base_length;return factor}exports.update_buffers_movable=function(bufs_data,world_matrix,eye){var indices=bufs_data.ibo_array;var positions=
extract_array(bufs_data,"a_position");var zinfo=bufs_data.info_for_z_sort_updates;var median_cache=zinfo.median_cache;var median_world_cache=zinfo.median_world_cache;var dist_cache=zinfo.dist_cache;var sort_back_to_front=zinfo.sort_back_to_front;compute_triangle_medians(indices,positions,median_cache);m_util.positions_multiply_matrix(median_cache,world_matrix,median_world_cache);compute_triangle_dists(median_world_cache,eye,dist_cache);var indices=sort_triangles(dist_cache,indices);_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,
bufs_data.ibo);_gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,indices,_gl.DYNAMIC_DRAW)};function compute_triangle_medians(indices,positions,medians){var num_faces=indices.length/3;for(var i=0;i<num_faces;i++){var index0=indices[3*i];var index1=indices[3*i+1];var index2=indices[3*i+2];var pos00=positions[3*index0];var pos01=positions[3*index0+1];var pos02=positions[3*index0+2];var pos10=positions[3*index1];var pos11=positions[3*index1+1];var pos12=positions[3*index1+2];var pos20=positions[3*index2];var pos21=
positions[3*index2+1];var pos22=positions[3*index2+2];medians[3*i]=(pos00+pos10+pos20)/3;medians[3*i+1]=(pos01+pos11+pos21)/3;medians[3*i+2]=(pos02+pos12+pos22)/3}return medians}function compute_triangle_dists(medians,eye,dists){var len=medians.length/3;for(var i=0;i<len;i++){var dx=medians[3*i]-eye[0];var dy=medians[3*i+1]-eye[1];var dz=medians[3*i+2]-eye[2];dists[i]=dx*dx+dy*dy+dz*dz}return dists}function sort_triangles(dists,indices){var dlen=dists.length;if(dlen<2)return indices;var gap=dlen;
var swapped=false;var t;while(gap>1||swapped){if(gap>1)gap=Math.floor(gap/COMB_SORT_JUMP_COEFF);swapped=false;for(var i=0;gap+i<dlen;i++)if(dists[i]-dists[i+gap]<0){t=dists[i];dists[i]=dists[i+gap];dists[i+gap]=t;swap_indices(indices,i,i+gap);swapped=true}}return indices}exports.sort_two_arrays=sort_two_arrays;function sort_two_arrays(main_arr,extra_arr,type,ascending){var arr_length=main_arr.length;var gap=arr_length;var swapped=false;var tmp;var order_factor=ascending?-1:1;while(gap>1||swapped){if(gap>
1)gap=Math.floor(gap/COMB_SORT_JUMP_COEFF);swapped=false;for(var i=0;gap+i<arr_length;i++){if(type==exports.SORT_NUMERIC)var condition=order_factor*(main_arr[i]-main_arr[i+gap])<0;else var condition=main_arr[i]<main_arr[i+gap]&&ascending;if(condition){tmp=main_arr[i];main_arr[i]=main_arr[i+gap];main_arr[i+gap]=tmp;tmp=extra_arr[i];extra_arr[i]=extra_arr[i+gap];extra_arr[i+gap]=tmp;swapped=true}}}}function swap_indices(indices,pos1,pos2){var t0=indices[3*pos1];var t1=indices[3*pos1+1];var t2=indices[3*
pos1+2];indices[3*pos1]=indices[3*pos2];indices[3*pos1+1]=indices[3*pos2+1];indices[3*pos1+2]=indices[3*pos2+2];indices[3*pos2]=t0;indices[3*pos2+1]=t1;indices[3*pos2+2]=t2}exports.calc_normals=function(indices,positions,shared_indices){var num_vertices=positions.length/POS_NUM_COMP;var num_faces=indices.length/3;var normals=[];var pos0=new Array(3);var pos1=new Array(3);var pos2=new Array(3);for(var i=0;i<num_faces;i++){var index0=indices[3*i];var index1=indices[3*i+1];var index2=indices[3*i+2];
for(var j=0;j<POS_NUM_COMP;j++){pos0[j]=positions[POS_NUM_COMP*index0+j];pos1[j]=positions[POS_NUM_COMP*index1+j];pos2[j]=positions[POS_NUM_COMP*index2+j]}if(shared_indices){var angle0=angle(pos0,pos1,pos2);var angle1=angle(pos1,pos2,pos0);var angle2=Math.PI-angle0-angle1}else{var angle0=1;var angle1=1;var angle2=1}calc_normal_for_face(index0,index1,index2,pos0,pos1,pos2,angle0,angle1,angle2,normals)}if(shared_indices)smooth_normals(shared_indices,normals);for(var i=0;i<num_vertices;i++)normalize_normal(i,
normals);return normals};function angle(pos,pos1,pos2){var vec1=[];var vec2=[];m_vec3.subtract(pos1,pos,vec1);m_vec3.subtract(pos2,pos,vec2);m_vec3.normalize(vec1,vec1);m_vec3.normalize(vec2,vec2);return Math.acos(m_vec3.dot(vec1,vec2))}function calc_normal_for_face(index0,index1,index2,pos0,pos1,pos2,angle0,angle1,angle2,dest){var normal=calc_normal_by_pos(pos0,pos1,pos2);for(var i=0;i<NOR_NUM_COMP;i++){var i0=NOR_NUM_COMP*index0+i;var i1=NOR_NUM_COMP*index1+i;var i2=NOR_NUM_COMP*index2+i;dest[i0]=
angle0*normal[i];dest[i1]=angle1*normal[i];dest[i2]=angle2*normal[i]}}function calc_normal_by_pos(pos0,pos1,pos2){var vec1=[],vec2=[],normal=[];m_vec3.subtract(pos1,pos0,vec1);m_vec3.subtract(pos2,pos0,vec2);m_vec3.cross(vec1,vec2,normal);m_vec3.normalize(normal,normal);return normal}function smooth_normals(shared_indices,normals){for(var i in shared_indices){var indices=shared_indices[i];for(var j=0;j<NOR_NUM_COMP;j++){var offset0=NOR_NUM_COMP*indices[0]+j;for(var k=1;k<indices.length;k++){var offset=
NOR_NUM_COMP*indices[k]+j;normals[offset0]+=normals[offset]}for(var k=1;k<indices.length;k++){var offset=NOR_NUM_COMP*indices[k]+j;normals[offset]=normals[offset0]}}}}function normalize_normal(i,normals){var normal=new Float32Array(NOR_NUM_COMP);for(var j=0;j<NOR_NUM_COMP;j++){var index=NOR_NUM_COMP*i+j;normal[j]=normals[index]}m_vec3.normalize(normal,normal);for(var j=0;j<NOR_NUM_COMP;j++){var index=NOR_NUM_COMP*i+j;normals[index]=normal[j]}}exports.calc_shared_indices=calc_shared_indices;function calc_shared_indices(indices,
shared_locations,locations){var sh_loc_set={};var len=shared_locations.length/3;for(var i=0;i<len;i++){var key=String(shared_locations[3*i])+String(shared_locations[3*i+1])+String(shared_locations[3*i+2]);sh_loc_set[key]=[]}var len=indices.length;for(var i=0;i<len;i++){var index=indices[i];var key=String(locations[3*index])+String(locations[3*index+1])+String(locations[3*index+2]);if(key in sh_loc_set)sh_loc_set[key].push(index)}return sh_loc_set}exports.geometry_random_points=function(submesh,n,
process_normals,seed){var triangles=extract_triangles(submesh,null,false);if(process_normals)var triangles_n=extract_triangles(submesh,null,true);var tnum=triangles.length;var areas=new Float32Array(tnum);var A=_vec3_tmp;var B=_vec3_tmp2;var C=_vec3_tmp3;for(var i=0;i<tnum;i++){var tri=triangles[i];A.set(tri.subarray(0,3));B.set(tri.subarray(3,6));C.set(tri.subarray(6));areas[i]=triangle_area(A,B,C)}var cumulative_areas=new Float32Array(tnum);cumulative_areas[0]=areas[0];for(var i=1;i<tnum;i++)cumulative_areas[i]=
cumulative_areas[i-1]+areas[i];var geom_area=cumulative_areas[areas.length-1];var points=[];for(var i=0;i<n;i++){var area=geom_area*m_util.rand_r(seed);var tri_index=m_util.binary_search_max(cumulative_areas,area,0,cumulative_areas.length-1);if(process_normals)var tri=triangles_n[tri_index];else var tri=triangles[tri_index];points[i]=triangle_random_point(tri,seed)}return points};exports.extract_triangles=extract_triangles;function extract_triangles(submesh,dest,process_normals){if(!dest)var dest=
[];if(process_normals)var positions=submesh.va_frames[0]["a_normal"];else var positions=submesh.va_frames[0]["a_position"];if(is_indexed(submesh)){var indices=submesh.indices;var tnum=indices.length/3;for(var i=0;i<tnum;i++){var tri=new Float32Array(9);var i0=indices[3*i];tri[0]=positions[3*i0];tri[1]=positions[3*i0+1];tri[2]=positions[3*i0+2];var i1=indices[3*i+1];tri[3]=positions[3*i1];tri[4]=positions[3*i1+1];tri[5]=positions[3*i1+2];var i2=indices[3*i+2];tri[6]=positions[3*i2];tri[7]=positions[3*
i2+1];tri[8]=positions[3*i2+2];dest[i]=tri}}else{var tnum=positions.length/9;for(var i=0;i<positions.length;i++){var tri=new Float32Array(9);tri[0]=positions[9*i];tri[1]=positions[9*i+1];tri[2]=positions[9*i+2];tri[3]=positions[9*i+3];tri[4]=positions[9*i+4];tri[5]=positions[9*i+5];tri[6]=positions[9*i+6];tri[7]=positions[9*i+7];tri[8]=positions[9*i+8];dest[i]=tri}}return dest}exports.extract_polyindices=extract_polyindices;function extract_polyindices(submesh){var polyindices=new Float32Array(submesh.base_length);
for(var i=0;i<submesh.base_length;i++)polyindices[i]=i%3;return polyindices}function triangle_area(A,B,C){return Math.sqrt(triangle_area_squared(A,B,C))}exports.triangle_area_squared=triangle_area_squared;function triangle_area_squared(A,B,C){var a=m_vec3.dist(A,B);var b=m_vec3.dist(A,C);var c=m_vec3.dist(B,C);var p=(a+b+c)/2;return p*(p-a)*(p-b)*(p-c)}function triangle_random_point(triangle,seed,dest){if(!dest)var dest=new Float32Array(3);var x0=triangle[0];var y0=triangle[1];var z0=triangle[2];
var x1=triangle[3];var y1=triangle[4];var z1=triangle[5];var x2=triangle[6];var y2=triangle[7];var z2=triangle[8];var w1=m_util.rand_r(seed);var w2=m_util.rand_r(seed);if(w1+w2>1){w1=1-w1;w2=1-w2}var w0=1-w1-w2;var x=w0*x0+w1*x1+w2*x2;var y=w0*y0+w1*y1+w2*y2;var z=w0*z0+w1*z1+w2*z2;dest[0]=x;dest[1]=y;dest[2]=z;return dest}exports.scale_submesh_xyz=function(submesh,scale,center){var positions=submesh.va_frames[0]["a_position"];for(var i=0;i<positions.length;i+=3){positions[i]=(positions[i]-center[0])*
scale[0]+center[0];positions[i+1]=(positions[i+1]-center[1])*scale[1]+center[1];positions[i+2]=(positions[i+2]-center[2])*scale[2]+center[2]}};exports.apply_shape_key=function(obj,key_name,new_value){var batches=obj.scenes_data[0].batches;var sk_data=obj.render.shape_keys_values;for(var i=1;i<sk_data.length;i++)if(sk_data[i]["name"]==key_name)sk_data[i]["value"]=new_value;for(var i=0;i<batches.length;i++){if(batches[i].forked_batch||!batches[i].use_shape_keys||batches[i].debug_sphere)continue;var pointers=
batches[i].bufs_data.pointers;var vbo_array=batches[i].bufs_data.vbo_array;var vbo=batches[i].bufs_data.vbo;_gl.bindBuffer(_gl.ARRAY_BUFFER,vbo);apply_shape_key_pos(pointers["a_position"],batches[i],vbo_array,sk_data);apply_shape_key_nor(pointers["a_normal"],batches[i],vbo_array,sk_data);apply_shape_key_tan(pointers["a_tangent"],batches[i],vbo_array,sk_data)}};function apply_shape_key_pos(pos_pointer,batch,vbo_array,sk_data){if(pos_pointer){var pos_offset=pos_pointer.offset;var pos_length=pos_pointer.length+
pos_offset;var pos=batch.bufs_data.shape_keys[0].geometry["a_position"];for(var i=pos_offset;i<pos_length;i++)vbo_array[i]=pos[i-pos_offset];for(var i=1;i<batch.bufs_data.shape_keys.length;i++){var positions=batch.bufs_data.shape_keys[i].geometry["a_position"];var value=sk_data[i]["value"];if(!value)continue;for(var j=pos_offset;j<pos_length;j++)vbo_array[j]+=value*positions[j-pos_offset]}_gl.bufferSubData(_gl.ARRAY_BUFFER,BINARY_FLOAT_SIZE*pos_offset,vbo_array.subarray(pos_offset))}}function apply_shape_key_nor(nor_pointer,
batch,vbo_array,sk_data){if(nor_pointer){var nor_offset=nor_pointer.offset;var nor_length=nor_pointer.length+nor_offset;var nor=batch.bufs_data.shape_keys[0].geometry["a_normal"];for(var i=nor_offset;i<nor_length;i++)vbo_array[i]=nor[i-nor_offset];for(var i=1;i<batch.bufs_data.shape_keys.length;i++){var normals=batch.bufs_data.shape_keys[i].geometry["a_normal"];var value=sk_data[i]["value"];if(!value)continue;for(var j=nor_offset;j<nor_length;j++)vbo_array[j]+=value*normals[j-nor_offset]}normalize_buffer(vbo_array,
nor_offset,nor_length,3,2);_gl.bufferSubData(_gl.ARRAY_BUFFER,BINARY_FLOAT_SIZE*nor_offset,vbo_array.subarray(nor_offset))}}function apply_shape_key_tan(tan_pointer,batch,vbo_array,sk_data){if(tan_pointer){var tan_offset=tan_pointer.offset;var tan_length=tan_pointer.length+tan_offset;var tan=batch.bufs_data.shape_keys[0].geometry["a_tangent"];for(var i=tan_offset;i<tan_length;i++)vbo_array[i]=tan[i-tan_offset];for(var i=1;i<batch.bufs_data.shape_keys.length;i++){var tangents=batch.bufs_data.shape_keys[i].geometry["a_tangent"];
var value=sk_data[i]["value"];if(!value)continue;for(var j=tan_offset;j<tan_length;j++)vbo_array[j]+=value*tangents[j-tan_offset]}normalize_buffer(vbo_array,tan_offset,tan_length,4,3);_gl.bufferSubData(_gl.ARRAY_BUFFER,BINARY_FLOAT_SIZE*tan_offset,vbo_array.subarray(tan_offset))}}function normalize_buffer(buffer,offset,buf_len,vec_len,rest){var len=buf_len-offset;for(var i=0;i<len;i=i+vec_len)if(i%vec_len==rest)vec3.normalize(buffer.subarray(i+offset-rest,i+offset+1),buffer.subarray(i+offset-rest,
i+offset+1))}exports.check_shape_keys=function(obj){return obj.render.use_shape_keys};exports.get_shape_keys_names=function(obj){var shape_keys_names=[];if(obj.render)for(var i=1;i<obj.render.shape_keys_values.length;i++)shape_keys_names.push(obj.render.shape_keys_values[i]["name"]);return shape_keys_names};exports.get_shape_key_value=function(obj,key_name){if(obj.render)for(var i=1;i<obj.render.shape_keys_values.length;i++)if(key_name==obj.render.shape_keys_values[i]["name"])return obj.render.shape_keys_values[i]["value"];
return 0};exports.has_shape_key=function(obj,key_name){var shape_keys=obj.render.shape_keys_values;if(shape_keys)for(var i=1;i<shape_keys.length;i++)if(shape_keys[i]["name"]==key_name)return true;return false};exports.has_dyn_geom=function(obj){if(obj&&obj.render&&obj.render.dynamic_geometry)return true;else return false}};b4w.module["__objects"]=function(exports,require){var m_anim=require("__animation");var m_batch=require("__batch");var m_bounds=require("__boundings");var m_cam=require("__camera");var m_cfg=require("__config");var m_cons=require("__constraints");var m_geom=require("__geometry");var m_lights=require("__lights");var m_nla=require("__nla");var m_obj_util=require("__obj_util");var m_particles=require("__particles");var m_phy=require("__physics");var m_print=require("__print");var m_primitives=require("__primitives");
var m_quat=require("__quat");var m_scenes=require("__scenes");var m_sfx=require("__sfx");var m_trans=require("__transform");var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("__vec3");var m_armat=require("__armature");var cfg_def=m_cfg.defaults;var cfg_out=m_cfg.outlining;var DEBUG_DISABLE_STATIC_OBJS=false;var _all_objects={"ALL":[]};var _color_id_counter=0;var _cube_refl_counter=0;var _refl_plane_objs=[];var _outline_anim_objs=[];var _vec3_tmp=new Float32Array(3);var _quat4_tmp=
new Float32Array(4);var COLOR_ID_THRESHOLD=3;var DATA_ID_ALL=-1;exports.GET_OBJECT_BY_NAME=0;exports.GET_OBJECT_BY_DUPLI_NAME=1;exports.GET_OBJECT_BY_DUPLI_NAME_LIST=2;exports.DATA_ID_ALL=DATA_ID_ALL;exports.update=function(timeline,elapsed){var objects=_all_objects["ALL"];var armatures=_all_objects["ARMATURE"];for(var i=0;i<objects.length;i++){var obj=objects[i];var scenes_data=obj.scenes_data;for(var j=0;j<scenes_data.length;j++){var scene=scenes_data[j].scene;var render=scene._render;if(render.outline){if(_outline_anim_objs.indexOf(obj)!=
-1)update_obj_outline_intensity(obj,timeline);if(obj.render.outline_intensity)m_scenes.request_outline(scene)}}}if(!armatures)return;for(var i=0;i<armatures.length;i++){var armobj=armatures[i];if(armobj.need_update_transform){m_trans.update_transform(armobj);armobj.need_update_transform=false}}};exports.apply_outline_anim=function(obj,tau,T,N){var oa=obj.outline_animation;oa.time_start=0;oa.outline_time=tau;oa.period=T;oa.relapses=N;var ind=_outline_anim_objs.indexOf(obj);if(ind==-1)_outline_anim_objs.push(obj)};
exports.clear_outline_anim=clear_outline_anim;function clear_outline_anim(obj){obj.render.outline_intensity=0;var ind=_outline_anim_objs.indexOf(obj);if(ind!=-1)_outline_anim_objs.splice(ind,1)}exports.update_object=function(bpy_obj,obj){prepare_default_actions(bpy_obj,obj);bpy_obj._is_dynamic=obj.is_dynamic=calc_is_dynamic(bpy_obj,obj);bpy_obj._is_updated=true;prepare_physics_settings(bpy_obj,obj);if(obj.type==="MESH")var render_type=obj.is_dynamic?"DYNAMIC":"STATIC";else var render_type=obj.type;
var render=obj.render=m_obj_util.create_render(render_type);prepare_parenting_props(bpy_obj,obj);var pos=bpy_obj["location"];var scale=bpy_obj["scale"][0];var rot=_quat4_tmp;m_util.quat_bpy_b4w(bpy_obj["rotation_quaternion"],rot);m_trans.set_translation(obj,pos);m_trans.set_rotation(obj,rot);m_trans.set_scale(obj,scale);obj.use_default_animation=bpy_obj["b4w_use_default_animation"];obj.anim_behavior_def=m_anim.anim_behavior_bpy_b4w(bpy_obj["b4w_anim_behavior"]);if(bpy_obj["b4w_object_tags"])obj.metatags=
{title:bpy_obj["b4w_object_tags"]["title"],description:bpy_obj["b4w_object_tags"]["description"],category:bpy_obj["b4w_object_tags"]["category"]};switch(bpy_obj["type"]){case "ARMATURE":m_armat.update_object(bpy_obj,obj);var bone_pointers=render.bone_pointers;var pose_data=m_anim.calc_pose_data(bone_pointers);if(bpy_obj["b4w_animation_mixing"]){var length=pose_data.quats.length;render.quats_before=new Float32Array(pose_data.quats);render.quats_after=new Float32Array(pose_data.quats);render.trans_before=
new Float32Array(pose_data.trans);render.trans_after=new Float32Array(pose_data.trans)}else{render.quats_before=pose_data.quats;render.quats_after=pose_data.quats;render.trans_before=pose_data.trans;render.trans_after=pose_data.trans}for(var bone_name in bone_pointers){var bpointer=bone_pointers[bone_name];if(bpointer.chain.length==1)m_armat.update_bone_tsr_r(bpointer,true,pose_data.trans,pose_data.quats)}render.pose_data=pose_data;render.frame_factor=0;render.anim_mixing=bpy_obj["b4w_animation_mixing"];
break;case "MESH":render.do_not_render=bpy_obj["b4w_do_not_render"];render.bb_original=m_batch.bb_bpy_to_b4w(bpy_obj["data"]["b4w_bounding_box"]);render.selectable=cfg_out.outlining_overview_mode||bpy_obj["b4w_selectable"];render.origin_selectable=bpy_obj["b4w_selectable"];render.outlining=cfg_out.outlining_overview_mode||bpy_obj["b4w_outlining"];render.origin_outlining=bpy_obj["b4w_outlining"];render.outline_on_select=cfg_out.outlining_overview_mode||bpy_obj["b4w_outline_on_select"];render.billboard=
bpy_obj["b4w_billboard"];render.billboard_pres_glob_orientation=bpy_obj["b4w_pres_glob_orientation"];render.billboard_type="BASIC";render.billboard_spherical=bpy_obj["b4w_billboard_geometry"]=="SPHERICAL";var oa_set=render.outline_anim_settings_default;oa_set.outline_duration=bpy_obj["b4w_outline_settings"]["outline_duration"],oa_set.outline_period=bpy_obj["b4w_outline_settings"]["outline_period"],oa_set.outline_relapses=bpy_obj["b4w_outline_settings"]["outline_relapses"];if(render.selectable){render.color_id=
m_util.gen_color_id(_color_id_counter);_color_id_counter++}prepare_vertex_anim(bpy_obj,obj);prepare_shape_keys(bpy_obj,obj);var bpy_armobj=m_anim.get_bpy_armobj(bpy_obj);if(bpy_armobj){var armobj=bpy_armobj._object;var amr_pose_data=armobj.render.pose_data;prepare_skinning_info(bpy_obj,obj,armobj);var pose_data=m_anim.extract_skinned_pose_data(amr_pose_data.trans,amr_pose_data.quats,render.bone_skinning_info);if(bpy_armobj["b4w_animation_mixing"]){render.quats_before=new Float32Array(pose_data.quats);
render.quats_after=new Float32Array(pose_data.quats);render.trans_before=new Float32Array(pose_data.trans);render.trans_after=new Float32Array(pose_data.trans)}else{render.quats_before=pose_data.quats;render.quats_after=pose_data.quats;render.trans_before=pose_data.trans;render.trans_after=pose_data.trans}render.arm_rel_trans=new Float32Array(4);render.arm_rel_quat=m_quat.create();render.pose_data=pose_data;render.frame_factor=0}prepare_nodemats_containers(bpy_obj,obj);render.shadow_cast=bpy_obj["b4w_shadow_cast"];
render.shadow_receive=bpy_obj["b4w_shadow_receive"];render.shadow_cast_only=bpy_obj["b4w_shadow_cast_only"]&&render.shadow_cast;render.reflexible=bpy_obj["b4w_reflexible"];render.reflexible_only=bpy_obj["b4w_reflexible_only"]&&render.reflexible;render.reflective=bpy_obj["b4w_reflective"];render.reflection_type=bpy_obj["b4w_reflection_type"];render.caustics=bpy_obj["b4w_caustics"];render.wind_bending=bpy_obj["b4w_wind_bending"];render.wind_bending_angle=bpy_obj["b4w_wind_bending_angle"];var amp=m_batch.wb_angle_to_amp(bpy_obj["b4w_wind_bending_angle"],
render.bb_original,bpy_obj["scale"][0]);render.wind_bending_amp=amp;render.wind_bending_freq=bpy_obj["b4w_wind_bending_freq"];render.detail_bending_freq=bpy_obj["b4w_detail_bending_freq"];render.detail_bending_amp=bpy_obj["b4w_detail_bending_amp"];render.branch_bending_amp=bpy_obj["b4w_branch_bending_amp"];render.hide=false;render.main_bend_col=bpy_obj["b4w_main_bend_stiffness_col"];var bnd_st=bpy_obj["b4w_detail_bend_colors"];render.detail_bend_col={};render.detail_bend_col.leaves_stiffness=bnd_st["leaves_stiffness_col"];
render.detail_bend_col.leaves_phase=bnd_st["leaves_phase_col"];render.detail_bend_col.overall_stiffness=bnd_st["overall_stiffness_col"];render.do_not_cull=bpy_obj["b4w_do_not_cull"];render.disable_fogging=bpy_obj["b4w_disable_fogging"];render.dynamic_geometry=bpy_obj["b4w_dynamic_geometry"];var first_mat=first_mesh_material(bpy_obj);render.friction=first_mat["physics"]["friction"];render.elasticity=first_mat["physics"]["elasticity"];render.lod_dist_min=0;render.lod_dist_max=1E4;render.lod_transition_ratio=
bpy_obj["b4w_lod_transition"];render.last_lod=true;break;case "CAMERA":m_cam.camera_object_to_camera(bpy_obj,obj);m_cam.assign_boundings(obj);break;case "LAMP":m_lights.lamp_to_light(bpy_obj,obj);break;case "SPEAKER":obj.sfx=m_sfx.create_sfx();var is_enabled=false;for(var i=0;i<obj.scenes_data.length;i++)if(obj.scenes_data[i].scene["b4w_enable_audio"]){var is_enabled=true;break}if(is_enabled)m_sfx.update_object(bpy_obj,obj);break;case "EMPTY":var bb=m_bounds.zero_bounding_box();render.bb_local=bb;
var bs=m_bounds.zero_bounding_sphere();render.bs_local=bs;if(bpy_obj["field"])obj.field={type:bpy_obj["field"]["type"],strength:bpy_obj["field"]["strength"]};if(bpy_obj["b4w_anchor"])obj.anchor={type:bpy_obj["b4w_anchor"]["type"],detect_visibility:bpy_obj["b4w_anchor"]["detect_visibility"],element_id:bpy_obj["b4w_anchor"]["element_id"],max_width:bpy_obj["b4w_anchor"]["max_width"]};break;default:break}objects_storage_add(obj)};exports.update_object_relations=function(obj){var render=obj.render;if(obj.parent){var trans=
render.trans;var quat=render.quat;var scale=render.scale;if(!obj.parent_is_dupli&&obj.physics_settings.use_collision_compound&&obj.parent.physics_settings.use_collision_compound)obj.use_obj_physics=false;if(has_dynamic_physics(obj)){if(obj.parent_is_dupli)var offset=m_tsr.create_sep(trans,scale,quat);else var offset=render.tsr;m_tsr.multiply(obj.parent.render.tsr,offset,render.tsr);m_trans.set_translation(obj,m_tsr.get_trans_view(render.tsr));m_trans.set_scale(obj,m_tsr.get_scale(render.tsr));m_trans.set_rotation(obj,
m_tsr.get_quat_view(render.tsr))}else if(obj.parent_is_dupli||!obj.parent_bone){var offset=m_tsr.create_sep(trans,scale,quat);m_cons.append_child_of(obj,obj.parent,offset)}else{var offset=m_tsr.create_sep(trans,scale,quat);m_cons.append_child_of_bone(obj,obj.parent,obj.parent_bone,offset)}}if(obj.type=="ARMATURE"){var bpy_obj=obj.temp_bpy_obj;var pose_bones=bpy_obj["pose"]["bones"];for(var i=0;i<pose_bones.length;i++){var pose_bone=pose_bones[i];var constraints=pose_bone["constraints"];if(constraints)for(var j=
0;j<constraints.length;j++){var cons=constraints[j];if(cons["type"]!="COPY_TRANSFORMS"||cons["subtarget"]||cons["mute"])continue;var target_obj=cons["target"]._object;m_cons.append_stiff_bone_to_obj(obj,target_obj,pose_bone["name"],m_util.VEC3_IDENT,m_util.QUAT4_IDENT,1)}}}if(obj.type=="MESH"&&render.reflective)attach_reflection_data(obj)};function has_dynamic_physics(obj){var render=obj.render;var phy_set=obj.physics_settings;return obj.is_vehicle||obj.is_floating||m_phy.is_character(obj)||obj.use_obj_physics&&
!phy_set.use_ghost&&phy_set.mass>0&&(phy_set.physics_type=="DYNAMIC"||phy_set.physics_type=="RIGID_BODY")}exports.update_force=update_force;function update_force(obj){if(obj.field){var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var scene=scenes_data[i].scene;m_scenes.update_force_scene(scene,obj)}}}function attach_reflection_data(obj){var render=obj.render;if(render.reflection_type=="CUBE")render.cube_reflection_id=_cube_refl_counter++;else if(render.reflection_type=="PLANE"){var refl_plane_obj=
get_reflection_plane_obj(obj);if(!refl_plane_obj)refl_plane_obj=create_default_refl_plane(obj);var refl_plane_id=null;for(var i=0;i<_refl_plane_objs.length;i++){var rp=_refl_plane_objs[i];if(rp==refl_plane_obj){refl_plane_id=i;break}}if(refl_plane_id==null){refl_plane_id=_refl_plane_objs.length;_refl_plane_objs.push(refl_plane_obj)}refl_plane_obj.render.plane_reflection_id=refl_plane_id;render.plane_reflection_id=refl_plane_id;refl_plane_obj.reflective_objs.push(obj)}}function create_default_refl_plane(obj){var unique_name=
m_util.unique_name("%reflection%");var reflection_plane=m_obj_util.create_object(unique_name,"EMPTY");var render=m_obj_util.create_render("EMPTY");reflection_plane.render=render;copy_scene_data(obj,reflection_plane);m_cons.append_stiff_obj(reflection_plane,obj,[0,0,0],null,1);objects_storage_add(reflection_plane);return reflection_plane}function get_reflection_plane_obj(obj){var bpy_obj=obj.temp_bpy_obj;var constraints=bpy_obj["constraints"];for(var i=0;i<constraints.length;i++){var cons=constraints[i];
if(cons["type"]=="LOCKED_TRACK"&&cons.name=="REFLECTION PLANE")return cons["target"]._object}return null}exports.copy_scene_data=copy_scene_data;function copy_scene_data(from_obj,to_obj){var from_data=from_obj.scenes_data;var to_data=to_obj.scenes_data;for(var i=0;i<from_data.length;i++){var is_already_attached=false;for(var j=0;j<to_data.length;j++)if(from_data[i].scene==to_data[j].scene){is_already_attached=true;break}if(!is_already_attached)if(check_bpy_obj_scene_compatibility(to_obj,from_data[i].scene))m_obj_util.append_scene_data(to_obj,
from_data[i].scene)}}exports.check_bpy_obj_scene_compatibility=check_bpy_obj_scene_compatibility;function check_bpy_obj_scene_compatibility(bpy_obj,bpy_scene){if(!bpy_scene._is_main&&bpy_obj["type"]=="SPEAKER")return false;if(!bpy_scene._is_primary_thread&&(bpy_obj["type"]=="LAMP"||bpy_obj["type"]=="CAMERA"))return false;return true}exports.update_objects_dynamics=function(objects){for(var i=0;i<objects.length;i++){var obj=objects[i];if(obj.render&&(obj.render.type=="DYNAMIC"||obj.render.type=="CAMERA"))m_trans.update_transform(obj);
if(obj.use_default_animation&&m_anim.obj_is_animatable(obj)){m_anim.apply_def(obj);if(obj.anim_slots.length)m_anim.play(obj,null,m_anim.SLOT_ALL)}}};function calc_is_dynamic(bpy_obj,obj){if(bpy_obj["dg_parent"]&&bpy_obj["dg_parent"]._is_dynamic)return true;if(bpy_obj["parent"]&&bpy_obj["parent"]._is_dynamic)return true;switch(bpy_obj["type"]){case "MESH":return calc_mesh_is_dynamic(bpy_obj,obj);break;case "EMPTY":return calc_empty_is_dynamic(bpy_obj,obj);break;default:return true;break}}function calc_empty_is_dynamic(bpy_obj,
obj){var is_animated=m_anim.bpy_obj_is_animatable(bpy_obj,obj);var has_nla=m_nla.bpy_obj_has_nla(bpy_obj);var has_do_not_batch=bpy_obj["b4w_do_not_batch"];return is_animated||has_nla||has_do_not_batch}function calc_mesh_is_dynamic(bpy_obj,obj){var is_animated=m_anim.bpy_obj_is_animatable(bpy_obj,obj);var has_do_not_batch=bpy_obj["b4w_do_not_batch"];var is_collision=bpy_obj["b4w_collision"];var is_vehicle_part=bpy_obj["b4w_vehicle"];var is_floater_part=bpy_obj["b4w_floating"];var is_character=bpy_obj["b4w_character"];
var dyn_grass_emitter=m_particles.has_dynamic_grass_particles(bpy_obj);var has_nla=m_nla.bpy_obj_has_nla(bpy_obj);var has_shape_keys=bpy_obj["data"]["b4w_shape_keys"].length>0;var has_dynamic_geometry=bpy_obj["b4w_dynamic_geometry"];return DEBUG_DISABLE_STATIC_OBJS||is_animated||has_do_not_batch||is_collision||is_vehicle_part||has_shape_keys||is_floater_part||has_lens_flares_mat(bpy_obj)||dyn_grass_emitter||is_character||has_nla||has_dynamic_geometry}function has_lens_flares_mat(bpy_obj){var mesh=
bpy_obj["data"];for(var i=0;i<mesh["materials"].length;i++)if(mesh["materials"][i]["name"]==="LENS_FLARES")return true;return false}function prepare_skinning_info(bpy_obj,obj,armobj){var render=obj.render;var mesh=bpy_obj["data"];obj.armobj=armobj;var vertex_groups=mesh["vertex_groups"];if(!vertex_groups.length)return;var arm_bone_pointers=armobj.render.bone_pointers;var deform_bone_index=0;var bone_skinning_info={};for(var bone_name in arm_bone_pointers){var vgroup=m_util.keysearch("name",bone_name,
vertex_groups);if(!vgroup)continue;var arm_bpointer=arm_bone_pointers[bone_name];bone_skinning_info[bone_name]={vgroup_index:vgroup["index"],bone_index:arm_bpointer.bone_index,deform_bone_index:deform_bone_index++}}render.bone_skinning_info=bone_skinning_info;var num_bones=deform_bone_index;var max_bones=m_anim.get_max_bones();render.max_bones=num_bones;if(num_bones>2*max_bones){render.is_skinning=false;m_print.error('too many bones for "'+bpy_obj["name"]+'" / '+render.max_bones+" bones (max "+max_bones+
" with blending, "+2*max_bones+" without blending)."+" Skinning will be disabled.")}else render.is_skinning=true}function prepare_shape_keys(bpy_obj,obj){if(bpy_obj["type"]!="MESH")throw"Wrong object type: "+bpy_obj["name"];var render=obj.render;if(bpy_obj["data"]["b4w_shape_keys"].length){render.use_shape_keys=true;for(var i=0;i<bpy_obj["data"]["b4w_shape_keys"].length;i++){var key={};key["value"]=bpy_obj["data"]["b4w_shape_keys"][i]["value"];key["name"]=bpy_obj["data"]["b4w_shape_keys"][i]["name"];
render.shape_keys_values.push(key)}}else render.use_shape_keys=false}function first_mesh_material(bpy_obj){if(bpy_obj["type"]!=="MESH")throw"Wrong object";return bpy_obj["data"]["materials"][0]}function prepare_nodemats_containers(bpy_obj,obj){var render=obj.render;var materials=bpy_obj["data"]["materials"];var mats_values=[];var mats_value_inds=[];var mats_anim_inds=[];var mats_rgbs=[];var mats_rgb_inds=[];var mats_rgb_anim_inds=[];for(var i=0;i<materials.length;i++){var mat=materials[i];var node_tree=
mat["node_tree"];if(!node_tree)continue;var anim_data=node_tree["animation_data"];process_ntree_r(node_tree,mat["name"],anim_data,mats_values,mats_value_inds,mats_anim_inds,mats_rgbs,mats_rgb_inds,mats_rgb_anim_inds)}render.mats_values=mats_values;render.mats_value_inds=mats_value_inds;render.mats_anim_inds=mats_anim_inds;render.mats_rgbs=mats_rgbs;render.mats_rgb_inds=mats_rgb_inds;render.mats_rgb_anim_inds=mats_rgb_anim_inds}function process_ntree_r(node_tree,names_str,anim_data,mats_values,value_inds,
val_anim_inds,mats_rgbs,rgb_inds,rgb_anim_inds){for(var i=0;i<node_tree["nodes"].length;i++){var node=node_tree["nodes"][i];if(node["type"]=="VALUE"){var param_name=join_name(names_str,node["name"]);mats_values.push(node["outputs"][0]["default_value"]);value_inds.push(param_name,value_inds.length/2)}else if(node["type"]=="RGB"){var param_name=join_name(names_str,node["name"]);var def_value=node["outputs"][0]["default_value"].slice(0,3);mats_rgbs.push(def_value[0],def_value[1],def_value[2]);rgb_inds.push(param_name,
rgb_inds.length/2)}else if(node["type"]=="GROUP"){var gr_node_tree=node["node_group"]["node_tree"];var ntree_anim_data=gr_node_tree["animation_data"];var new_names_str=join_name(names_str,node["name"]);process_ntree_r(gr_node_tree,new_names_str,ntree_anim_data,mats_values,value_inds,val_anim_inds,mats_rgbs,rgb_inds,rgb_anim_inds)}}if(anim_data)process_ntree_anim_data(anim_data,names_str,val_anim_inds,value_inds,rgb_inds,rgb_anim_inds)}function process_ntree_anim_data(anim_data,names_str,val_anim_inds,
value_inds,rgb_inds,rgb_anim_inds){var action=anim_data["action"];if(action&&action._render.type==m_anim.AT_MATERIAL)extract_nodemat_action_params(action,names_str,val_anim_inds,value_inds,rgb_anim_inds,rgb_inds);var nla_tracks=anim_data["nla_tracks"];for(var j=0;j<nla_tracks.length;j++){var nla_strips=nla_tracks[j]["strips"];for(var k=0;k<nla_tracks[j]["strips"].length;k++){var strip=nla_strips[k];var action=strip["action"];if(action&&action._render.type==m_anim.AT_MATERIAL)extract_nodemat_action_params(action,
names_str,val_anim_inds,value_inds,rgb_anim_inds,rgb_inds)}}}function extract_nodemat_action_params(action,names_str,val_anim_inds,value_inds,rgb_anim_inds,rgb_inds){var params=action._render.params;for(var param in params){var full_node_path=join_name(names_str,node_name_from_param_name(param));var ind=node_ind_by_full_path(value_inds,full_node_path);if(ind!=null){var param_name=join_name(action["name"],param);val_anim_inds.push(param_name,ind)}else{var ind=node_ind_by_full_path(rgb_inds,full_node_path);
if(ind!=null){var param_name=join_name(action["name"],param);rgb_anim_inds.push(param_name,ind)}}}}function join_name(name1,name2){return name1+"%join%"+name2}function node_name_from_param_name(param_name){return param_name.match(/"(.*?)"/)[1]}function node_ind_by_full_path(inds,path){for(var i=0;i<inds.length;i+=2){var name=inds[i];if(name==path)return inds[i+1]}return null}exports.get_meta_tags=function(obj){return m_util.clone_object_r(obj.metatags)};exports.cleanup=function(){_color_id_counter=
0;_cube_refl_counter=0;_refl_plane_objs=[];_outline_anim_objs.length=0;_all_objects={"ALL":[]}};exports.copy=function(obj,name,deep_copy){var new_obj=copy_object(obj,name,deep_copy);new_obj.render.is_copied=true;new_obj.render.color_id=m_util.gen_color_id(_color_id_counter);_color_id_counter++;return new_obj};function copy_object(obj,new_name,deep_copy){var origin_name=new_name;var dg_parent=m_obj_util.get_dg_parent(obj);var name=dg_parent?m_obj_util.gen_dupli_name(dg_parent.name,new_name):new_name;
if(get_object_by_name(name,_all_objects["ALL"],false,DATA_ID_ALL)){var i=1;var num;while(true){num="."+(String(i).length<3?("000"+String(i)).slice(-3):String(i));if(!get_object_by_name(name+num,_all_objects["ALL"],false,DATA_ID_ALL))break;i++}m_print.error('Object "'+name+'" already exists. '+'Name was replaced by "'+name+num+'".');origin_name+=num;name+=num}var new_obj=m_obj_util.create_object(name,obj.type,origin_name);new_obj.is_dynamic=obj.is_dynamic;new_obj.is_hair_dupli=obj.is_hair_dupli;new_obj.use_default_animation=
obj.use_default_animation;new_obj.render=m_obj_util.copy_object_props_by_value(obj.render);new_obj.metatags=m_obj_util.copy_object_props_by_value(obj.metatags);copy_scene_data(obj,new_obj);new_obj.action_anim_cache=m_obj_util.copy_bpy_object_props_by_link(obj.action_anim_cache);new_obj.parent=m_obj_util.copy_bpy_object_props_by_link(obj.parent);new_obj.parent_is_dupli=obj.parent_is_dupli;new_obj.parent_bone=obj.parent_bone;new_obj.temp_bpy_obj=obj.temp_bpy_obj;if(obj.physics&&!(obj.is_vehicle||obj.is_character||
obj.is_floating)){new_obj.use_obj_physics=obj.use_obj_physics;new_obj.physics=m_obj_util.copy_object_props_by_value(obj.physics)}new_obj.physics_settings=m_obj_util.copy_object_props_by_value(obj.physics_settings);copy_batches(obj,new_obj,deep_copy);m_obj_util.scene_data_set_active(new_obj,false);objects_storage_add(new_obj);return new_obj}function copy_batches(obj,new_obj,deep_copy){var bpy_bufs_data=[];var uuid=m_util.gen_uuid();for(var i=0;i<obj.scenes_data.length;i++){var sc_data=obj.scenes_data[i];
var new_sc_data=new_obj.scenes_data[i];var batches=sc_data.batches;if(deep_copy){var new_batches=new_sc_data.batches;for(var j=0;j<batches.length;j++)if(!batches[j].forked_batch){new_batches.push(m_obj_util.copy_object_props_by_value(batches[j]));bpy_bufs_data.push(batches[j].bufs_data)}for(var j=0;j<batches.length;j++)if(batches[j].forked_batch){var new_forked_batch=m_obj_util.copy_object_props_by_value(batches[j]);new_batches.push(new_forked_batch);for(var k=0;k<bpy_bufs_data.length;k++)if(bpy_bufs_data[k]==
batches[j].bufs_data)new_forked_batch.bufs_data=new_batches[k].bufs_data}for(var j=0;j<new_batches.length;j++){if(new_batches[j].bufs_data)m_geom.update_gl_buffers(new_batches[j].bufs_data);new_batches[j].odd_id_prop=uuid;m_batch.update_batch_id(new_batches[j],m_batch.calculate_render_id(new_obj.render))}}else new_sc_data.batches=m_obj_util.copy_bpy_object_props_by_link(batches)}}exports.get_value_node_ind_by_id=get_value_node_ind_by_id;function get_value_node_ind_by_id(obj,id){var value_inds=obj.render.mats_value_inds;
for(var i=0;i<value_inds.length;i+=2)if(value_inds[i]==id)return value_inds[i+1];return null}exports.get_rgb_node_ind_by_id=get_rgb_node_ind_by_id;function get_rgb_node_ind_by_id(obj,id){var rgb_inds=obj.render.mats_rgb_inds;for(var i=0;i<rgb_inds.length;i+=2)if(rgb_inds[i]==id)return rgb_inds[i+1];return null}function prepare_physics_settings(bpy_obj,obj){obj.is_vehicle=bpy_obj["b4w_vehicle"];obj.is_character=bpy_obj["b4w_character"];obj.is_floating=bpy_obj["b4w_floating"];obj.use_obj_physics=bpy_obj["b4w_collision"];
var game=bpy_obj["game"];obj.physics_settings={physics_type:game["physics_type"],use_ghost:game["use_ghost"],use_sleep:game["use_sleep"],mass:game["mass"],velocity_min:game["velocity_min"],velocity_max:game["velocity_max"],damping:game["damping"],rotation_damping:game["rotation_damping"],lock_location_x:game["lock_location_x"],lock_location_y:game["lock_location_y"],lock_location_z:game["lock_location_z"],lock_rotation_x:game["lock_rotation_x"],lock_rotation_y:game["lock_rotation_y"],lock_rotation_z:game["lock_rotation_z"],
collision_margin:game["collision_margin"],collision_group:game["collision_group"],collision_mask:game["collision_mask"],use_collision_bounds:game["use_collision_bounds"],collision_bounds_type:game["collision_bounds_type"],use_collision_compound:game["use_collision_compound"]};var vs=bpy_obj["b4w_vehicle_settings"];if(vs)obj.vehicle_settings={name:vs["name"],part:vs["part"],suspension_rest_length:vs["suspension_rest_length"],suspension_compression:vs["suspension_compression"],suspension_stiffness:vs["suspension_stiffness"],
suspension_damping:vs["suspension_damping"],wheel_friction:vs["wheel_friction"],roll_influence:vs["roll_influence"],max_suspension_travel_cm:vs["max_suspension_travel_cm"],force_max:vs["force_max"],brake_max:vs["brake_max"],steering_max:vs["steering_max"],max_speed_angle:vs["max_speed_angle"],delta_tach_angle:vs["delta_tach_angle"],speed_ratio:vs["speed_ratio"],steering_ratio:vs["steering_ratio"],inverse_control:vs["inverse_control"],floating_factor:vs["floating_factor"],water_lin_damp:vs["water_lin_damp"],
water_rot_damp:vs["water_rot_damp"],synchronize_position:vs["synchronize_position"]};var fs=bpy_obj["b4w_floating_settings"];if(fs)obj.floating_settings={name:fs["name"],part:fs["part"],floating_factor:fs["floating_factor"],water_lin_damp:fs["water_lin_damp"],water_rot_damp:fs["water_rot_damp"],synchronize_position:fs["synchronize_position"]};var cs=bpy_obj["b4w_character_settings"];if(cs)obj.character_settings={walk_speed:cs["walk_speed"],run_speed:cs["run_speed"],step_height:cs["step_height"],jump_strength:cs["jump_strength"],
waterline:cs["waterline"]};for(var i=0;i<bpy_obj["constraints"].length;i++){var cons=bpy_obj["constraints"][i];if(cons["type"]!="RIGID_BODY_JOINT")continue;obj.physics_constraints.push({target:cons["target"]._object,pivot_type:cons["pivot_type"],pivot_x:cons["pivot_x"],pivot_y:cons["pivot_y"],pivot_z:cons["pivot_z"],axis_x:cons["axis_x"],axis_y:cons["axis_y"],axis_z:cons["axis_z"],use_limit_x:cons["use_limit_x"],use_limit_y:cons["use_limit_y"],use_limit_z:cons["use_limit_z"],use_angular_limit_x:cons["use_angular_limit_x"],
use_angular_limit_y:cons["use_angular_limit_y"],use_angular_limit_z:cons["use_angular_limit_z"],limit_max_x:cons["limit_max_x"],limit_max_y:cons["limit_max_y"],limit_max_z:cons["limit_max_z"],limit_min_x:cons["limit_min_x"],limit_min_y:cons["limit_min_y"],limit_min_z:cons["limit_min_z"],limit_angle_max_x:cons["limit_angle_max_x"],limit_angle_max_y:cons["limit_angle_max_y"],limit_angle_max_z:cons["limit_angle_max_z"],limit_angle_min_x:cons["limit_angle_min_x"],limit_angle_min_y:cons["limit_angle_min_y"],
limit_angle_min_z:cons["limit_angle_min_z"]})}}function prepare_default_actions(bpy_obj,obj){var anim_data=bpy_obj["animation_data"];var speak_anim_data=bpy_obj["data"]["animation_data"];if(anim_data&&anim_data["action"]){var action=anim_data["action"];if(action._render.type==m_anim.AT_OBJECT||action._render.type==m_anim.AT_ARMATURE&&obj.type=="ARMATURE")obj.actions.push(action)}if(speak_anim_data&&speak_anim_data["action"]&&obj.type=="SPEAKER")obj.actions.push(speak_anim_data["action"]);if(obj.type==
"MESH")obj.actions.push.apply(obj.actions,m_anim.get_bpy_material_actions(bpy_obj))}function prepare_vertex_anim(bpy_obj,obj){for(var i=0;i<bpy_obj["data"]["b4w_vertex_anim"].length;i++){var va=bpy_obj["data"]["b4w_vertex_anim"][i];obj.vertex_anim.push({name:va["name"],frame_start:va["frame_start"],frame_end:va["frame_end"],averaging:va["averaging"],averaging_interval:va["averaging_interval"],allow_nla:va["allow_nla"]})}obj.render.vertex_anim=obj.vertex_anim.length?true:false}function prepare_parenting_props(bpy_obj,
obj){if(bpy_obj["parent"]){obj.parent=bpy_obj["parent"]._object;if(bpy_obj["parent_type"]=="BONE"&&bpy_obj["parent"]["type"]=="ARMATURE")obj.parent_bone=bpy_obj["parent_bone"]}else if(bpy_obj["dg_parent"]){obj.parent=bpy_obj["dg_parent"]._object;obj.parent_is_dupli=true}}exports.update_boundings=function(obj){var render=obj.render;var batches=obj.scenes_data[0].batches;var max_x,max_y,max_z,min_x,min_y,min_z;for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.type!="MAIN")continue;var vbo_array=
batch.bufs_data.vbo_array;var pointers=batches[i].bufs_data.pointers;var pos_offset=pointers["a_position"].offset;var pos_length=pointers["a_position"].length+pos_offset;max_x=min_x=vbo_array[pos_offset];max_y=min_y=vbo_array[pos_offset+1];max_z=min_z=vbo_array[pos_offset+2];for(var j=pos_offset;j<pos_length;j=j+3){var x=vbo_array[j];var y=vbo_array[j+1];var z=vbo_array[j+2];max_x=Math.max(x,max_x);max_y=Math.max(y,max_y);max_z=Math.max(z,max_z);min_x=Math.min(x,min_x);min_y=Math.min(y,min_y);min_z=
Math.min(z,min_z)}}var bb_local={max_x:parseFloat(max_x.toFixed(3)),max_y:parseFloat(max_y.toFixed(3)),max_z:parseFloat(max_z.toFixed(3)),min_x:parseFloat(min_x.toFixed(3)),min_y:parseFloat(min_y.toFixed(3)),min_z:parseFloat(min_z.toFixed(3))};var x_width=max_x-min_x;var y_width=max_y-min_y;var z_width=max_z-min_z;var s_cen_x=.5*(max_x+min_x);var s_cen_y=.5*(max_y+min_y);var s_cen_z=.5*(max_z+min_z);var c_cen_x=s_cen_x;var c_cen_y=s_cen_y;var c_cen_z=s_cen_z;var s_rad=Math.max(x_width,Math.max(y_width,
z_width))/2;var c_rad=Math.max(x_width,z_width)/2;var tmp_s_cen=[s_cen_x/(x_width?x_width:1),s_cen_y/(y_width?y_width:1),s_cen_z/(z_width?z_width:1)];var tmp_rad=.5;if(render.billboard){var x=Math.max(Math.abs(bb_local.max_x),Math.abs(bb_local.min_x));var y=Math.max(Math.abs(bb_local.max_y),Math.abs(bb_local.min_y));var z=Math.max(Math.abs(bb_local.max_z),Math.abs(bb_local.min_z));var sphere_radius=Math.sqrt(x*x+y*y+z*z);var cylinder_radius=Math.sqrt(x*x+y*y);bb_local.max_x=bb_local.max_y=bb_local.max_z=
sphere_radius;bb_local.min_x=bb_local.min_y=bb_local.min_z=-sphere_radius;c_rad=cylinder_radius;s_rad=sphere_radius;var bs_center=new Float32Array([0,0,0]);var be_axes=new Float32Array([s_rad,s_rad,s_rad]);var be_center=new Float32Array([0,0,0])}else{for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.type!="MAIN")continue;var vbo_array=batch.bufs_data.vbo_array;var pointers=batches[i].bufs_data.pointers;var pos_offset=pointers["a_position"].offset;var pos_length=pointers["a_position"].length+
pos_offset;for(var j=pos_offset;j<pos_length;j=j+3){var x=vbo_array[j];var y=vbo_array[j+1];var z=vbo_array[j+2];var s_cen_dist=Math.sqrt((s_cen_x-x)*(s_cen_x-x)+(s_cen_y-y)*(s_cen_y-y)+(s_cen_z-z)*(s_cen_z-z));if(s_cen_dist>s_rad){var g_x=s_cen_x-s_rad*(x-s_cen_x)/s_cen_dist;var g_y=s_cen_y-s_rad*(y-s_cen_y)/s_cen_dist;var g_z=s_cen_z-s_rad*(z-s_cen_z)/s_cen_dist;s_cen_x=(g_x+x)/2;s_cen_y=(g_y+y)/2;s_cen_z=(g_z+z)/2;s_rad=Math.sqrt((s_cen_x-x)*(s_cen_x-x)+(s_cen_y-y)*(s_cen_y-y)+(s_cen_z-z)*(s_cen_z-
z))}var c_cen_dist=Math.sqrt((c_cen_x-x)*(c_cen_x-x)+(c_cen_z-z)*(c_cen_z-z));if(c_cen_dist>c_rad){var g_x=c_cen_x-c_rad*(x-c_cen_x)/c_cen_dist;var g_z=c_cen_z-c_rad*(z-c_cen_z)/c_cen_dist;c_cen_x=(g_x+x)/2;c_cen_z=(g_z+z)/2;c_rad=Math.sqrt((c_cen_x-x)*(c_cen_x-x)+(c_cen_z-z)*(c_cen_z-z))}x/=x_width?x_width:1;y/=y_width?y_width:1;z/=z_width?z_width:1;var s_cen_tmp=Math.sqrt((tmp_s_cen[0]-x)*(tmp_s_cen[0]-x)+(tmp_s_cen[1]-y)*(tmp_s_cen[1]-y)+(tmp_s_cen[2]-z)*(tmp_s_cen[2]-z));if(s_cen_tmp>tmp_rad){var g_x=
tmp_s_cen[0]-tmp_rad*(x-tmp_s_cen[0])/s_cen_tmp;var g_y=tmp_s_cen[1]-tmp_rad*(y-tmp_s_cen[1])/s_cen_tmp;var g_z=tmp_s_cen[2]-tmp_rad*(z-tmp_s_cen[2])/s_cen_tmp;tmp_s_cen[0]=(g_x+x)/2;tmp_s_cen[1]=(g_y+y)/2;tmp_s_cen[2]=(g_z+z)/2;tmp_rad=Math.sqrt((tmp_s_cen[0]-x)*(tmp_s_cen[0]-x)+(tmp_s_cen[1]-y)*(tmp_s_cen[1]-y)+(tmp_s_cen[2]-z)*(tmp_s_cen[2]-z))}}}var e_cen_x=x_width?x_width*tmp_s_cen[0]:max_x;var e_cen_y=y_width?y_width*tmp_s_cen[1]:max_y;var e_cen_z=z_width?z_width*tmp_s_cen[2]:max_z;var e_axis_x=
tmp_rad*x_width;var e_axis_y=tmp_rad*y_width;var e_axis_z=tmp_rad*z_width;var bs_center=new Float32Array([s_cen_x,s_cen_y,s_cen_z]);var be_axes=new Float32Array([e_axis_x,e_axis_y,e_axis_z]);var be_center=new Float32Array([e_cen_x,e_cen_y,e_cen_z]);c_rad=parseFloat(c_rad.toFixed(3))}render.bb_local=bb_local;m_batch.set_local_cylinder_capsule(render,c_rad,c_rad,bb_local);var bs_local=m_bounds.create_bounding_sphere(s_rad,bs_center);render.bs_local=bs_local;var be_local=m_bounds.create_bounding_ellipsoid([be_axes[0],
0,0],[0,be_axes[1],0],[0,0,be_axes[2]],be_center);render.be_local=be_local;m_trans.update_transform(obj);if(cfg_def.wireframe_debug)for(var i=0;i<batches.length;i++)if(batches[i].type==="WIREFRAME"&&batches[i].debug_sphere){var submesh=m_primitives.generate_uv_sphere(16,8,1,be_local.center,false,false);var scale=[be_local.axis_x[0],be_local.axis_y[1],be_local.axis_z[2]];m_geom.scale_submesh_xyz(submesh,scale,be_local.center);m_geom.submesh_drop_indices(submesh,1,true);submesh.va_common["a_polyindex"]=
m_geom.extract_polyindices(submesh);m_batch.update_batch_geometry(batches[i],submesh);break}};exports.get_scene_objs=get_scene_objs;function get_scene_objs(scene,type,data_id){var objs_by_type=_all_objects[type]||[];var objs=[];for(var i=0;i<objs_by_type.length;i++){var obj=objs_by_type[i];if(obj.render.data_id!=data_id&&data_id!=DATA_ID_ALL)continue;var scenes_data=obj.scenes_data;for(var j=0;j<scenes_data.length;j++){var sc_data=scenes_data[j];if(sc_data.scene==scene)objs.push(obj)}}return objs}
exports.get_scene_objs_derived=function(scene,type,data_id){var objs_by_type=_all_objects[type]||[];var objs=[];for(var i=0;i<objs_by_type.length;i++){var obj=objs_by_type[i];if(obj.render.data_id!=data_id&&data_id!=DATA_ID_ALL||!obj.temp_bpy_obj)continue;var scenes_data=obj.scenes_data;for(var j=0;j<scenes_data.length;j++){var sc_data=scenes_data[j];if(sc_data.scene==scene)objs.push(obj)}}return objs};exports.get_all_objects=function(data_id){var all_objs=_all_objects["ALL"];if(data_id==DATA_ID_ALL)return all_objs;
var objs=[];for(var i=0;i<all_objs.length;i++){var obj=all_objs[i];if(obj.render.data_id==data_id)objs.push(obj)}return objs};function sort_func(l1,l2){if(l2.use_diffuse&&l2.use_specular&&!(l1.use_diffuse&&l1.use_specular))return true;if(!l1.use_diffuse)if(l2.use_diffuse||!l1.use_specular&&l2.use_specular)return true;return false}exports.sort_lamps=function(scene){var lamps=get_scene_objs(scene,"LAMP",DATA_ID_ALL);if(lamps.length!=scene._render.num_lamps_added)return;var lamp_indexes=[];for(var i=
0;i<lamps.length;i++){var lamp=lamps[i];var scene_data=m_obj_util.get_scene_data(lamp,scene);lamp_indexes[scene_data.light_index]=i}for(var i=0;i<lamp_indexes.length-1;i++)for(var j=i+1;j<lamp_indexes.length;j++)if(sort_func(lamps[lamp_indexes[i]].light,lamps[lamp_indexes[j]].light)){var tmp=lamp_indexes[i];lamp_indexes[i]=lamp_indexes[j];lamp_indexes[j]=tmp}for(var i=0;i<lamp_indexes.length;i++){var lamp=lamps[lamp_indexes[i]];var lamp_sc_data=m_obj_util.get_scene_data(lamp,scene);lamp_sc_data.light_index=
i;m_scenes.update_lamp_scene(lamps[lamp_indexes[i]],scene)}};exports.update_all_mesh_shaders=function(scene){var lamps=get_scene_objs(scene,"LAMP",DATA_ID_ALL);var objs=get_scene_objs(scene,"MESH",DATA_ID_ALL);for(var i=0;i<objs.length;i++){var sc_data=m_obj_util.get_scene_data(objs[i],scene);var batches=sc_data.batches;for(var j=0;j<batches.length;j++){var batch=batches[j];if(batch.type!="MAIN")continue;m_batch.update_batch_lights(batch,lamps,scene);m_batch.update_shader(batch)}}};exports.get_selectable_objects=
function(scene){var sel_objects=[];var objects=_all_objects["MESH"];for(var i=0;i<objects.length;i++){var obj=objects[i];if(obj.render.selectable)sel_objects.push(obj)}return sel_objects};exports.get_object=function(){var obj_found=null;var obj_name="";var objs=_all_objects["ALL"];switch(arguments[0]){case exports.GET_OBJECT_BY_NAME:obj_name=arguments[1];obj_found=get_object_by_name(arguments[1],objs,true,arguments[2]);break;case exports.GET_OBJECT_BY_DUPLI_NAME:obj_name=arguments[2];obj_found=get_object_by_dupli_name(arguments[1],
arguments[2],objs,arguments[3]);break;case exports.GET_OBJECT_BY_DUPLI_NAME_LIST:obj_name=arguments[1][arguments[1].length-1];obj_found=get_object_by_dupli_name_list(arguments[1],objs,arguments[2]);break;default:break}return obj_found};function get_object_by_name(name,objects,use_origin_name,data_id){var obj_found=null;for(var i=0;i<objects.length;i++){var obj=objects[i];var obj_name=use_origin_name?obj.origin_name:obj.name;if(obj_name==name&&(obj.render.data_id==data_id||data_id==DATA_ID_ALL)){obj_found=
obj;if(!m_obj_util.get_dg_parent(obj_found))break}}return obj_found}function get_object_by_dupli_name(empty_name,dupli_name,objects,data_id){for(var i=0;i<objects.length;i++){var obj=objects[i];if(obj.origin_name==dupli_name&&(obj.render.data_id==data_id||data_id==DATA_ID_ALL)){var dg_parent=m_obj_util.get_dg_parent(obj);if(dg_parent&&dg_parent.origin_name==empty_name)return obj}}return null}function get_object_by_dupli_name_list(name_list,objects,data_id){for(var i=0;i<objects.length;i++){var obj=
objects[i];var j=name_list.length-1;var curr_obj=obj;var is_valid=true;while(j>=0&&is_valid){is_valid=curr_obj&&(curr_obj.origin_name==name_list[j]&&(curr_obj.render.data_id==data_id||data_id==DATA_ID_ALL));if(curr_obj)curr_obj=m_obj_util.get_dg_parent(curr_obj);j--}if(is_valid&&!curr_obj)return obj}return null}function update_obj_outline_intensity(obj,timeline){var outline_intensity=0;var oa=obj.outline_animation;if(oa.time_start==0)oa.time_start=timeline;var dt=timeline-oa.time_start;if(oa.relapses&&
dt/oa.period>=oa.relapses){clear_outline_anim(obj);return}var periodic_time=dt%oa.period;if(periodic_time<oa.outline_time){var outline_time=periodic_time/(oa.outline_time/5);var stage=Math.floor(outline_time);switch(stage){case 0:outline_intensity=(outline_time-stage)/2;break;case 1:outline_intensity=(outline_time-stage)/2+.5;break;case 2:outline_intensity=1;break;case 3:outline_intensity=1-(outline_time-stage)/2;break;case 4:outline_intensity=.5-(outline_time-stage)/2;break}}obj.render.outline_intensity=
outline_intensity}exports.pick_object=function(canvas_x,canvas_y){var main_scene=m_scenes.get_main();if(!main_scene){m_print.error("No active scene");return null}var color=m_scenes.pick_color(main_scene,canvas_x,canvas_y);if(!color)return null;var sobjs=get_scene_objs(main_scene,"MESH",DATA_ID_ALL);for(var i=0;i<sobjs.length;i++){var render=sobjs[i].render;var color_id=render.color_id;if(color_id)if(Math.abs(255*color_id[0]-color[0])<COLOR_ID_THRESHOLD&&Math.abs(255*color_id[1]-color[1])<COLOR_ID_THRESHOLD&&
Math.abs(255*color_id[2]-color[2])<COLOR_ID_THRESHOLD){if(render.outlining&&render.outline_on_select)if(cfg_out.outlining_overview_mode)exports.apply_outline_anim(sobjs[i],cfg_out.outline_duration,cfg_out.outline_period,cfg_out.outline_relapses);else{var oa_set=render.outline_anim_settings_default;exports.apply_outline_anim(sobjs[i],oa_set.outline_duration,oa_set.outline_period,oa_set.outline_relapses)}return sobjs[i]}}return null};exports.set_wind_params=function(scene,wind_params){var objs=get_scene_objs(scene,
"EMPTY",DATA_ID_ALL);for(var i=0;i<objs.length;i++){var obj=objs[i];if(obj.field&&obj.field.type==="WIND")var wind_obj=obj}if(!wind_obj){m_print.error("There is no wind on the scene");return 0}if(typeof wind_params.wind_dir=="number"){var angle=wind_params.wind_dir/180*Math.PI;m_vec3.set(-Math.PI/2,angle,0,_vec3_tmp);m_util.euler_to_quat(_vec3_tmp,_quat4_tmp);m_trans.set_rotation(wind_obj,_quat4_tmp);update_force(wind_obj)}if(typeof wind_params.wind_strength=="number"){wind_obj.field.strength=wind_params.wind_strength;
update_force(wind_obj)}m_scenes.update_scene_permanent_uniforms(scene)};exports.remove_object=function(obj){if(m_cons.check_constraint(obj))m_cons.remove(obj);objects_storage_remove(obj)};exports.objects_storage_add=objects_storage_add;function objects_storage_add(obj){_all_objects["ALL"].push(obj);if(!_all_objects[obj.type])_all_objects[obj.type]=[];_all_objects[obj.type].push(obj);var plane_refl_id=obj.render.plane_reflection_id;if(plane_refl_id!=null)for(var i=0;i<_refl_plane_objs.length;i++){var refl_plane=
_refl_plane_objs[i];if(refl_plane.render.plane_reflection_id==plane_refl_id)refl_plane.reflective_objs.push(obj)}}function objects_storage_remove(obj){var all_objs=_all_objects["ALL"];var typed_objs=_all_objects[obj.type];var ind_all=all_objs.indexOf(obj);var ind_typed=typed_objs.indexOf(obj);if(ind_all!=-1)all_objs.splice(ind_all,1);if(ind_typed!=-1)typed_objs.splice(ind_typed,1)}exports.objects_storage_check=function(obj){return _all_objects[obj.type]&&_all_objects[obj.type].indexOf(obj)>-1};exports.set_nodemat_rgb=
function(obj,name_list,r,g,b){var node_id=name_list.join("%join%");var ind=get_rgb_node_ind_by_id(obj,node_id);if(ind!=null){obj.render.mats_rgbs[3*ind]=r;obj.render.mats_rgbs[3*ind+1]=g;obj.render.mats_rgbs[3*ind+2]=b}else m_print.error('The RGB node "'+node_id+'" was not found in the object "'+obj.name+'".')};exports.set_nodemat_value=function(obj,name_list,value){var node_id=name_list.join("%join%");var ind=get_value_node_ind_by_id(obj,node_id);if(ind!=null)obj.render.mats_values[ind]=value;else m_print.error('The Value node "'+
node_id+'" was not found in the object "'+obj.name+'".')}};b4w.module["__obj_util"]=function(exports,require){var m_mat4=require("__mat4");var m_print=require("__print");var m_quat=require("__quat");var m_tsr=require("__tsr");var m_vec4=require("__vec4");var _vec4_tmp=new Float32Array(4);var _quat4_tmp=new Float32Array(4);var _quat4_tmp2=new Float32Array(4);var _tsr8_tmp=new Float32Array(8);var _tsr8_tmp2=new Float32Array(8);var DEBUG_DISABLE_STATIC_OBJS=false;exports.create_render=create_render;function create_render(type){var render={type:type,data_id:0,
scale:0,grid_id:[0,0],trans:new Float32Array(3),quat:new Float32Array(4),tsr:new Float32Array(8),world_matrix:new Float32Array(16),inv_world_matrix:new Float32Array(16),pivot:new Float32Array(3),hover_pivot:new Float32Array(3),init_dist:0,init_top:0,is_copied:false,color_id:null,outline_intensity:0,target_cam_upside_down:false,use_panning:false,move_style:0,velocity_trans:1,velocity_rot:1,velocity_zoom:1,dof_distance:0,dof_front:0,dof_rear:0,dof_power:0,dof_object:null,underwater:false,distance_min:0,
distance_max:0,use_distance_limits:false,horizontal_limits:null,vertical_limits:null,hover_angle_limits:null,enable_hover_hor_rotation:true,cameras:null,outline_anim_settings_default:{outline_duration:1,outline_period:1,outline_relapses:0},cube_reflection_id:null,plane_reflection_id:null,reflection_plane:new Float32Array(4),friction:0,elasticity:0,lod_dist_max:0,lod_dist_min:0,lod_transition_ratio:0,do_not_render:false,shadow_cast:false,shadow_receive:false,shadow_cast_only:false,reflexible:false,
reflexible_only:false,reflective:false,reflection_type:"",caustics:false,wind_bending:false,disable_fogging:false,dynamic_geometry:false,dynamic_grass:false,do_not_cull:false,hide:false,last_lod:false,selectable:false,origin_selectable:false,outlining:false,origin_outlining:false,outline_on_select:false,is_hair_particles:false,is_visible:false,force_zsort:false,wind_bending_angle:0,wind_bending_amp:0,wind_bending_freq:0,detail_bending_freq:0,detail_bending_amp:0,branch_bending_amp:0,main_bend_col:"",
detail_bend_col:null,bend_center_only:false,billboard:false,billboard_pres_glob_orientation:false,billboard_type:"",billboard_spherical:false,frame_factor:0,time:0,va_frame:0,va_frame_factor:0,max_bones:0,frames_blending:false,vertex_anim:false,use_shape_keys:false,shape_keys_values:[],is_skinning:false,anim_mixing:false,anim_mix_factor:1,anim_mix_factor_change_speed:0,anim_destination_mix_factor:1,two_last_skeletal_slots:new Int8Array([-1,-1]),skinned_renders:[],mesh_to_arm_bone_maps:[],skinning_data_cache:[],
quats_before:null,quats_after:null,trans_before:null,trans_after:null,bone_pointers:null,bone_skinning_info:null,pose_data:null,arm_rel_trans:null,arm_rel_quat:null,mats_values:null,mats_value_inds:null,mats_anim_inds:null,mats_rgbs:null,mats_rgb_inds:null,mats_rgb_anim_inds:null,bb_original:null,bb_local:null,bcyl_local:null,bcap_local:null,bcon_local:null,bb_world:null,bs_local:null,bs_world:null,be_local:null,be_world:null};render.scale=1;render.lod_dist_max=1E4;m_quat.identity(render.quat);m_tsr.identity(render.tsr);
m_mat4.identity(render.world_matrix);m_mat4.identity(render.inv_world_matrix);return render}exports.create_object=create_object;function create_object(name,type,origin_name){if(!origin_name)origin_name=name;var obj={name:name,origin_name:origin_name,type:type,is_meta:false,is_dynamic:false,is_hair_dupli:false,use_default_animation:false,render:null,constraint:null,sfx:null,light:null,armobj:null,anchor:null,field:null,metatags:null,scenes_data:[],vertex_anim:[],cons_descends:[],cons_armat_bone_descends:[],
anim_slots:[],reflective_objs:[],nla_events:[],action_anim_cache:[],sensor_manifolds:null,sensor_manifolds_arr:[],parent:null,parent_is_dupli:false,parent_bone:"",use_obj_physics:false,is_vehicle:false,is_character:false,is_floating:false,physics:null,vehicle:null,floater:null,vehicle_settings:null,floating_settings:null,character_settings:null,physics_constraints:[],physics_settings:{physics_type:"NO_COLLISION",use_ghost:false,use_sleep:false,mass:0,velocity_min:0,velocity_max:0,damping:0,rotation_damping:0,
lock_location_x:false,lock_location_y:false,lock_location_z:false,lock_rotation_x:false,lock_rotation_y:false,lock_rotation_z:false,collision_margin:0,collision_group:0,collision_mask:0,use_collision_bounds:false,collision_bounds_type:"BOX",use_collision_compound:false},outline_animation:{time_start:0,outline_time:0,period:0,relapses:0},anim_behavior_def:0,actions:[],need_update_transform:false,temp_bpy_obj:null};return obj}exports.create_meta_object=function(name,type){var obj=create_object(name,
type);obj.is_meta=true;return obj};exports.copy_bpy_object_props_by_link=function(obj){if(obj instanceof Array)return obj.slice();else return obj};exports.copy_object_props_by_value=copy_object_props_by_value;function copy_object_props_by_value(obj){if(!(obj instanceof Object))return obj;var textures=null;var texture_names=null;var shape_keys=null;if(obj.textures){textures=obj.textures;obj.textures=null}if(obj.texture_names){texture_names=obj.texture_names;obj.texture_names=null}if(obj.shape_keys){shape_keys=
obj.shape_keys;obj.shape_keys=null}var obj_clone;var Constructor=obj.constructor;switch(Constructor){case Float32Array:case Uint32Array:case Uint16Array:obj_clone=new Constructor(obj);break;case Array:obj_clone=new Constructor(obj.length);for(var i=0;i<obj.length;i++)obj_clone[i]=copy_object_props_by_value(obj[i]);break;case WebGLUniformLocation:case WebGLProgram:case WebGLShader:obj_clone=obj;break;case WebGLFramebuffer:case WebGLTexture:case WebGLBuffer:obj_clone=null;break;case Function:obj_clone=
obj;break;default:obj_clone=new Constructor;for(var prop in obj)obj_clone[prop]=copy_object_props_by_value(obj[prop]);break}if(textures){obj_clone.textures=textures;obj.textures=textures}if(texture_names){obj_clone.texture_names=texture_names;obj.texture_names=texture_names}if(shape_keys){obj_clone.shape_keys=shape_keys;obj.shape_keys=shape_keys}return obj_clone}exports.is_dynamic=function(obj){return obj.is_dynamic};exports.is_dynamic_mesh=function(obj){return obj.type=="MESH"&&obj.is_dynamic};exports.append_scene_data=
function(obj,scene){var sc_data=init_scene_data(scene);obj.scenes_data.push(sc_data)};exports.append_batch=function(obj,scene,batch){var sc_data=get_scene_data(obj,scene);sc_data.batches.push(batch)};exports.remove_scene_data=function(obj,scene){var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var sc_data=scenes_data[i];if(sc_data.scene==scene){scenes_data.splice(i,1);break}}};exports.get_scene_data=get_scene_data;function get_scene_data(obj,scene){var scenes_data=obj.scenes_data;
for(var i=0;i<scenes_data.length;i++){var sc_data=scenes_data[i];if(sc_data.scene==scene)return sc_data}return null}exports.update_refl_objects=function(objects,reflection_plane){for(var i=0;i<objects.length;i++)m_vec4.copy(reflection_plane,objects[i].render.reflection_plane)};function init_scene_data(scene){var sc_data={scene:scene,is_active:false,batches:[],plane_refl_subs:null,cube_refl_subs:null,shadow_subscenes:[],light_index:0,obj_has_nla_on_scene:false};return sc_data}exports.scene_data_set_active=
function(obj,flag,scene){for(var i=0;i<obj.scenes_data.length;i++){var sc_data=obj.scenes_data[i];if(!scene||sc_data.scene==scene)sc_data.is_active=flag}};exports.get_first_lamp_with_shadows=function(lamps){for(var i=0;i<lamps.length;i++){var lamp=lamps[i];if(lamp.light.generate_shadows)return lamp}return null};exports.gen_dupli_name=function(dg_parent_name,name){return dg_parent_name+"*"+name};exports.get_parent=function(obj){return!obj.parent_is_dupli?obj.parent:null};exports.get_dg_parent=get_dg_parent;
function get_dg_parent(obj){if(obj.parent_is_dupli)return obj.parent;else if(obj.parent)return get_dg_parent(obj.parent);else return null}exports.get_dg_objects=function(dg_parent,objects){var dg_objs=[];for(var i=0;i<objects.length;i++){var obj=objects[i];if(get_dg_parent(obj)==dg_parent)dg_objs.push(obj)}return dg_objs};exports.is_mesh=function(obj){return obj.type==="MESH"};exports.is_armature=function(obj){return obj.type==="ARMATURE"};exports.is_speaker=function(obj){return obj.type==="SPEAKER"};
exports.is_camera=function(obj){return obj.type==="CAMERA"};exports.is_lamp=function(obj){return obj.type==="LAMP"};exports.is_empty=function(obj){return obj.type==="EMPTY"}};b4w.module["__particles"]=function(exports,require){var m_cfg=require("__config");var m_geom=require("__geometry");var m_scenes=require("__scenes");var m_time=require("__time");var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("__vec3");var STDGRAVITY=9.81;var DELAYRANDFACTOR=10;var tsr_tmp=new Float32Array(8);var vec3_tmp=new Float32Array(3);function create_particles_data(name,type){var pdata={name:name,p_type:type,time:0,prev_time:-1,use_world_space:false,frame_start:0,
frame_end:0,time_length:0,lifetime_frames:0,lifetime:0,cyclic:false,mass:0,nfactor:0,gravity:0,fade_in:0,fade_out:0,wind_factor:0,size:0,alpha_start:0,alpha_end:0,size_ramp_length:0,color_ramp_length:0,size_ramp:new Float32Array(8),color_ramp:new Float32Array(16),positions:null,positions_cache:null,normals:null,normals_cache:null,delay_attrs:null,delay_attrs_masked:null,emitter_tsr_snapshots:null};return pdata}var _rand=function(){throw"_rand() undefined";};exports.obj_has_particles=function(obj){var scenes_data=
obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var batches=scenes_data[i].batches;for(var j=0;j<batches.length;j++)if(batches[j].particles_data)return true}return false};exports.obj_has_anim_particles=function(obj){var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var batches=scenes_data[i].batches;for(var j=0;j<batches.length;j++){var pdata=batches[j].particles_data;if(pdata&&pdata.p_type=="EMITTER")return true}}return false};exports.bpy_obj_has_particles=function(bpy_obj){return bpy_obj["particle_systems"].length>
0};exports.bpy_obj_has_anim_particles=function(bpy_obj){for(var i=0;i<bpy_obj["particle_systems"].length;i++){var psettings=bpy_obj["particle_systems"][i]["settings"];if(psettings["type"]=="EMITTER")return true}return false};exports.has_dynamic_grass_particles=function(bpy_obj){for(var i=0;i<bpy_obj["particle_systems"].length;i++){var psettings=bpy_obj["particle_systems"][i]["settings"];if(psettings["type"]=="HAIR"&&psettings["b4w_dynamic_grass"])return true}return false};exports.init_particles_data=
function(batch,psystem,pmaterial){var pdata=batch.particles_data=create_particles_data(psystem["name"],psystem["settings"]["type"]);pdata.frame_start=psystem["settings"]["frame_start"];pdata.frame_end=psystem["settings"]["frame_end"];pdata.time_length=(pdata.frame_end-pdata.frame_start)/m_time.get_framerate();pdata.lifetime_frames=psystem["settings"]["lifetime"];pdata.lifetime=pdata.lifetime_frames/m_time.get_framerate();pdata.cyclic=psystem["settings"]["b4w_cyclic"]?1:0;pdata.mass=psystem["settings"]["mass"];
pdata.nfactor=psystem["settings"]["normal_factor"];pdata.gravity=psystem["settings"]["effector_weights"]["gravity"]*STDGRAVITY;pdata.fade_in=psystem["settings"]["b4w_fade_in"]/m_time.get_framerate();pdata.fade_out=psystem["settings"]["b4w_fade_out"]/m_time.get_framerate();pdata.wind_factor=psystem["settings"]["effector_weights"]["wind"];pdata.use_world_space=psystem["settings"]["b4w_coordinate_system"]=="WORLD"?true:false;var size;var alpha_start;var alpha_end;if(batch.halo_particles){size=pmaterial["halo"]["size"];
var hardness=pmaterial["halo"]["hardness"];if(hardness<30){var alpha_start=.5;var alpha_end=.9}else if(hardness<40){var alpha_start=.1;var alpha_end=1}else if(hardness<50){var alpha_start=0;var alpha_end=.8}else{var alpha_start=0;var alpha_end=.5}}else{size=psystem["settings"]["particle_size"];alpha_start=1;alpha_end=1}pdata.size=size;pdata.alpha_start=alpha_start;pdata.alpha_end=alpha_end;var tex_slot=psystem["settings"]["texture_slots"];var sramp_varr=[-1,0,-1,0,-1,0,-1,0];if(tex_slot[0]&&tex_slot[0]["use_map_size"]&&
tex_slot[0]["texture"]&&tex_slot[0]["texture"]["type"]=="BLEND"&&tex_slot[0]["texture"]["use_color_ramp"]){var color_ramp_elems=tex_slot[0]["texture"]["color_ramp"]["elements"];var rlen=Math.min(color_ramp_elems.length*2,sramp_varr.length);for(var i=0;i<rlen;i+=2){var rel=color_ramp_elems[i/2];sramp_varr[i]=rel["position"];var intensity=(rel["color"][0]+rel["color"][1]+rel["color"][2])/3;sramp_varr[i+1]=intensity}pdata.size_ramp_length=color_ramp_elems.length}pdata.size_ramp.set(sramp_varr);var m_tex_slot=
pmaterial["texture_slots"];var cramp_varr=[-1,0,0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0];if(m_tex_slot[0]&&m_tex_slot[0]["texture_coords"]=="STRAND"&&m_tex_slot[0]["texture"]&&m_tex_slot[0]["texture"]["type"]=="BLEND"&&m_tex_slot[0]["texture"]["use_color_ramp"]){var color_ramp_elems=m_tex_slot[0]["texture"]["color_ramp"]["elements"];var rlen=Math.min(color_ramp_elems.length*4,cramp_varr.length);for(var i=0;i<rlen;i+=4){var rel=color_ramp_elems[i/4];cramp_varr[i]=rel["position"];cramp_varr[i+1]=rel["color"][0];
cramp_varr[i+2]=rel["color"][1];cramp_varr[i+3]=rel["color"][2]}pdata.color_ramp_length=color_ramp_elems.length}pdata.color_ramp.set(cramp_varr)};exports.generate_emitter_particles_submesh=function(batch,emitter_mesh,psystem,tsr){var pdata=batch.particles_data;var pcount=psystem["settings"]["count"];var time_start=psystem["settings"]["frame_start"]/m_time.get_framerate();var time_end=psystem["settings"]["frame_end"]/m_time.get_framerate();var lifetime=psystem["settings"]["lifetime"]/m_time.get_framerate();
var lifetime_random=psystem["settings"]["lifetime_random"];var emit_from=psystem["settings"]["emit_from"];var vel_factor_rand=psystem["settings"]["factor_random"];var ang_vel_mode=psystem["settings"]["angular_velocity_mode"];var ang_vel_factor=psystem["settings"]["angular_velocity_factor"];var is_rand_delay=psystem["settings"]["b4w_randomize_emission"];var cyclic=psystem["settings"]["b4w_cyclic"];var is_billboard=!batch.halo_particles;init_particle_rand(psystem["seed"]);var emitter_submesh=m_geom.extract_submesh_all_mats(emitter_mesh,
["a_position","a_normal"],null);var pos_norm=distribute_positions_normals(pcount,emit_from,emitter_submesh,is_billboard);var positions=pos_norm[0];var normals=pos_norm[1];pdata.positions=new Float32Array(positions);pdata.normals=new Float32Array(normals);pdata.positions_cache=new Float32Array(positions.length);pdata.normals_cache=new Float32Array(normals.length);var delay_attrs=gen_delay_attrs(pcount,time_start,time_end,is_rand_delay,is_billboard,cyclic);pdata.delay_attrs=new Float32Array(delay_attrs);
pdata.delay_attrs_masked=new Float32Array(delay_attrs);pdata.emitter_tsr_snapshots=new Float32Array(delay_attrs.length*8);for(var i=0;i<delay_attrs.length*8;i++)for(var j=0;j<8;j++)pdata.emitter_tsr_snapshots[8*i+j]=tsr[j];if(pdata.use_world_space)pose_emitter_world(pdata,is_billboard,positions,normals,tsr,positions,normals);var submesh=m_util.create_empty_submesh("EMITTER_PARTICLES");var va_frame=m_util.create_empty_va_frame();va_frame["a_position"]=positions;va_frame["a_normal"]=normals;submesh.va_frames[0]=
va_frame;if(is_billboard){batch.draw_mode=m_geom.DM_DYNAMIC_TRIANGLES;submesh.indices=gen_bb_indices(pcount);submesh.va_common["a_p_bb_vertex"]=gen_bb_vertices(pcount)}else{batch.draw_mode=m_geom.DM_DYNAMIC_POINTS;submesh.indices=new Uint16Array(0)}submesh.base_length=positions.length/3;submesh.va_common["a_p_delay"]=delay_attrs;submesh.va_common["a_p_lifetime"]=gen_lifetimes(pcount,lifetime,lifetime_random,is_billboard);submesh.va_common["a_p_vels"]=gen_velocities(pcount,vel_factor_rand,ang_vel_mode,
ang_vel_factor,is_billboard);return submesh};function pose_emitter_world(pdata,is_billboard,positions,normals,tsr,positions_new,normals_new){var delay_attrs=pdata.delay_attrs;var em_snapshots=pdata.emitter_tsr_snapshots;var time=pdata.time;var prev_time=pdata.prev_time;var step=is_billboard?4:1;for(var j=0;j<delay_attrs.length;j+=step){var delay=delay_attrs[j];var need_emitter_pos=time>prev_time&&time>=delay&&delay>prev_time||time<prev_time&&(delay>prev_time||time>=delay);if(need_emitter_pos)for(var k=
0;k<8;k++)em_snapshots[8*j+k]=tsr[k];for(var k=0;k<8;k++)tsr_tmp[k]=em_snapshots[8*j+k];var pos=vec3_tmp;pos[0]=positions[3*j];pos[1]=positions[3*j+1];pos[2]=positions[3*j+2];m_tsr.transform_vec3(pos,tsr_tmp,pos);positions_new[3*j]=pos[0];positions_new[3*j+1]=pos[1];positions_new[3*j+2]=pos[2];var norm=vec3_tmp;norm[0]=normals[3*j];norm[1]=normals[3*j+1];norm[2]=normals[3*j+2];m_tsr.transform_dir_vec3(norm,tsr_tmp,norm);normals_new[3*j]=norm[0];normals_new[3*j+1]=norm[1];normals_new[3*j+2]=norm[2];
if(is_billboard)for(var k=1;k<4;k++){positions_new[3*(j+k)]=positions_new[3*j];positions_new[3*(j+k)+1]=positions_new[3*j+1];positions_new[3*(j+k)+2]=positions_new[3*j+2];normals_new[3*(j+k)]=norm[0];normals_new[3*(j+k)+1]=norm[1];normals_new[3*(j+k)+2]=norm[2]}}}exports.update_emitter_transform=function(obj,batches){for(var i=0;i<batches.length;i++){var batch=batches[i];var pdata=batches[i].particles_data;if(!pdata)continue;var pbuf=batch.bufs_data;if(!pdata.use_world_space)return;var pcache=pdata.positions_cache;
var ncache=pdata.normals_cache;var positions=pdata.positions;var normals=pdata.normals;var is_billboard=!batch.halo_particles;pose_emitter_world(pdata,is_billboard,positions,normals,obj.render.tsr,pcache,ncache);m_geom.make_dynamic(pbuf);m_geom.update_bufs_data_array(pbuf,"a_position",3,pcache);m_geom.update_bufs_data_array(pbuf,"a_normal",3,ncache)}};function init_particle_rand(seed){if(seed){m_util.srand(seed);_rand=function(){return m_util.rand()}}else _rand=function(){return Math.random()}}function gen_bb_vertices(pcount){var bbv=
[];for(var i=0;i<pcount;i++)bbv.push(-.5,-.5,-.5,.5,.5,.5,.5,-.5);var bb_vertices=new Float32Array(bbv);return bb_vertices}function gen_bb_indices(pcount){var bbi=[];for(var i=0;i<pcount;i++)bbi.push(4*i,4*i+2,4*i+1,4*i,4*i+3,4*i+2);var bb_indices=new Uint16Array(bbi);return bb_indices}function distribute_positions_normals(pcount,emit_from,emitter_submesh,is_billboard){switch(emit_from){case "VERT":var ecoords=emitter_submesh.va_frames[0]["a_position"];var encoords=emitter_submesh.va_frames[0]["a_normal"];
var pindices=gen_pindices(pcount,ecoords,is_billboard);var positions=gen_positions(pindices,ecoords);var normals=gen_normals(pindices,encoords);break;case "FACE":var positions=[];var normals=[];var seed=[];m_util.init_rand_r_seed(0,seed);var rand_pos=m_geom.geometry_random_points(emitter_submesh,pcount,false,seed);m_util.init_rand_r_seed(0,seed);var rand_norm=m_geom.geometry_random_points(emitter_submesh,pcount,true,seed);for(var i=0;i<rand_pos.length;i++){positions.push(rand_pos[i][0],rand_pos[i][1],
rand_pos[i][2]);if(is_billboard){positions.push(rand_pos[i][0],rand_pos[i][1],rand_pos[i][2]);positions.push(rand_pos[i][0],rand_pos[i][1],rand_pos[i][2]);positions.push(rand_pos[i][0],rand_pos[i][1],rand_pos[i][2])}normals.push(rand_norm[i][0],rand_norm[i][1],rand_norm[i][2]);if(is_billboard){normals.push(rand_norm[i][0],rand_norm[i][1],rand_norm[i][2]);normals.push(rand_norm[i][0],rand_norm[i][1],rand_norm[i][2]);normals.push(rand_norm[i][0],rand_norm[i][1],rand_norm[i][2])}}var positions=new Float32Array(positions);
var normals=new Float32Array(normals);break;case "VOLUME":throw"Particle emission from volume is not supported";break;default:throw"Wrong emit from option";break}return[positions,normals]}function gen_pindices(pcount,ecoords,is_billboard){var vcount=ecoords.length/3;var indices=[];for(var i=0;i<pcount;i++){var vrand=Math.round((vcount-1)*_rand());indices.push(vrand);if(is_billboard){indices.push(vrand);indices.push(vrand);indices.push(vrand)}}return indices}function gen_positions(indices,ecoords){var parr=
[];for(var i=0;i<indices.length;i++){parr.push(ecoords[3*indices[i]]);parr.push(ecoords[3*indices[i]+1]);parr.push(ecoords[3*indices[i]+2])}var positions=new Float32Array(parr);return positions}function gen_normals(indices,encoords){var narr=[];for(var i=0;i<indices.length;i++){narr.push(encoords[3*indices[i]]);narr.push(encoords[3*indices[i]+1]);narr.push(encoords[3*indices[i]+2])}var normals=new Float32Array(narr);return normals}function gen_delay_attrs(pcount,mindelay,maxdelay,random,is_billboard,
cyclic){var darr=[];var delayint=(maxdelay-mindelay)/pcount;for(var i=0;i<pcount;i++){var delay;if(random)delay=delayint*i+DELAYRANDFACTOR*delayint*(.5-_rand());else delay=delayint*i;if(!cyclic)delay+=mindelay;darr.push(delay);if(is_billboard){darr.push(delay);darr.push(delay);darr.push(delay)}}var delay_attrs=new Float32Array(darr);return delay_attrs}function gen_lifetimes(pcount,lifetime,lifetime_random,is_billboard){var larr=[];var delta=lifetime*lifetime_random;for(var i=0;i<pcount;i++){var delta_rand=
delta*_rand();larr.push(lifetime-delta_rand);if(is_billboard){larr.push(lifetime-delta_rand);larr.push(lifetime-delta_rand);larr.push(lifetime-delta_rand)}}var lifetimes=new Float32Array(larr);return lifetimes}function gen_velocities(pcount,vel_factor_rand,ang_vel_mode,ang_vel_factor,is_billboard){var varr=[];for(var i=0;i<pcount;i++){var vvec=[_rand()-.5,_rand()-.5,_rand()-.5];m_vec3.normalize(vvec,vvec);varr.push(vel_factor_rand*vvec[0]);varr.push(vel_factor_rand*vvec[1]);varr.push(vel_factor_rand*
vvec[2]);switch(ang_vel_mode){case "NONE":varr.push(0);break;case "SPIN":case "VELOCITY":varr.push(ang_vel_factor);break;case "RAND":varr.push(ang_vel_factor*2*(_rand()-.5));break;default:throw"Undefined velocity factor";}if(is_billboard){var last=varr.slice(-4);for(var j=0;j<12;j++)varr.push(last[j%4])}}var vels=new Float32Array(varr);return vels}exports.set_time=function(obj,psys_name,time){var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var batches=scenes_data[i].batches;
for(var j=0;j<batches.length;j++){var pdata=batches[j].particles_data;if(!pdata||pdata.name!=psys_name)continue;pdata.prev_time=pdata.time;pdata.time=time}}};exports.prepare_lens_flares=function(submesh){var base_length=submesh.base_length;var sub_pos=submesh.va_frames[0]["a_position"];var sub_tco=submesh.va_common["a_texcoord"];var bb_dist_arr=[];var bb_vert_arr=[];for(var i=0;i<base_length;i++){bb_vert_arr.push(sub_pos[3*i]);bb_vert_arr.push(sub_pos[3*i+1]);bb_dist_arr.push(sub_pos[3*i+2])}var bb_dist_arr=
new Float32Array(bb_dist_arr);var bb_vert_arr=new Float32Array(bb_vert_arr);submesh.va_common["a_lf_dist"]=bb_dist_arr;submesh.va_common["a_lf_bb_vertex"]=bb_vert_arr;submesh.va_common["a_texcoord"]=sub_tco;return submesh};exports.set_size=function(obj,psys_name,size){var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var batches=scenes_data[i].batches;for(var j=0;j<batches.length;j++){var pdata=batches[j].particles_data;if(!pdata||pdata.name!=psys_name)continue;pdata.size=size}}};
exports.set_normal_factor=function(obj,psys_name,nfactor){var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var batches=scenes_data[i].batches;for(var j=0;j<batches.length;j++){var pdata=batches[j].particles_data;if(!pdata||pdata.name!=psys_name)continue;pdata.nfactor=nfactor}}};exports.set_factor=function(obj,psys_name,factor){var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var batches=scenes_data[i].batches;for(var j=0;j<batches.length;j++){var batch=batches[j];
var pdata=batch.particles_data;if(!pdata||pdata.name!=psys_name)continue;var delay_attrs=pdata.delay_attrs;if(factor==1)var delay_attrs_masked=delay_attrs;else if(factor==0){var is_billboard=!batch.halo_particles;var inc=is_billboard?4:1;var delay_attrs_masked=pdata.delay_attrs_masked;for(var k=0;k<delay_attrs_masked.length;k+=inc){delay_attrs_masked[k]=1E4;if(is_billboard){delay_attrs_masked[k+1]=delay_attrs_masked[k];delay_attrs_masked[k+2]=delay_attrs_masked[k];delay_attrs_masked[k+3]=delay_attrs_masked[k]}}}else{var step=
1/factor;var delay_attrs_masked=pdata.delay_attrs_masked;var is_billboard=!batch.halo_particles;var inc=is_billboard?4:1;var ind=0;for(var k=0;k<delay_attrs_masked.length;k+=inc){if(k>=ind){delay_attrs_masked[k]=delay_attrs[k];ind+=step}else delay_attrs_masked[k]=1E4;if(is_billboard){delay_attrs_masked[k+1]=delay_attrs_masked[k];delay_attrs_masked[k+2]=delay_attrs_masked[k];delay_attrs_masked[k+3]=delay_attrs_masked[k]}}}var pbuf=batch.bufs_data;m_geom.update_bufs_data_array(pbuf,"a_p_delay",1,delay_attrs_masked)}}};
exports.update_start_pos=function(obj,trans,quats){var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var batches=scenes_data[i].batches;for(var j=0;j<batches.length;j++){var pdata=batches[j].particles_data;if(!pdata)continue;for(var k=0;k<pdata.delay_attrs.length*8;k++){pdata.emitter_tsr_snapshots[8*k]=trans[0];pdata.emitter_tsr_snapshots[8*k+1]=trans[1];pdata.emitter_tsr_snapshots[8*k+2]=trans[2];pdata.emitter_tsr_snapshots[8*k+3]=trans[3];pdata.emitter_tsr_snapshots[8*k+4]=quats[0];
pdata.emitter_tsr_snapshots[8*k+5]=quats[1];pdata.emitter_tsr_snapshots[8*k+6]=quats[2];pdata.emitter_tsr_snapshots[8*k+7]=quats[3]}}}}};b4w.module["__primitives"]=function(exports,require){var m_cfg=require("__config");var m_geom=require("__geometry");var m_print=require("__print");var m_util=require("__util");var cfg_def=m_cfg.defaults;exports.generate_lines=function(num){var submesh=m_util.create_empty_submesh("LINE");var points=[];for(var i=0;i<num*2;i++)points.push(i);var va_frame=m_util.create_empty_va_frame();va_frame["a_point"]=new Float32Array(points);submesh.va_frames[0]=va_frame;submesh.indices=new Uint32Array(points);submesh.base_length=
num*2;return submesh};exports.generate_plane=function(x_size,z_size){var grid_submesh=generate_grid(2,2,x_size,z_size);grid_submesh.name="PLANE";return grid_submesh};exports.generate_grid=generate_grid;function generate_grid(x_subdiv,z_subdiv,x_size,z_size){var indices=[];var positions=[];var normals=[];var texcoords=[];var delta_x=2*x_size/(x_subdiv-1);var delta_z=2*z_size/(z_subdiv-1);for(var i=0;i<x_subdiv;i++){var x=-x_size+i*delta_x;for(var j=0;j<z_subdiv;j++){var z=-z_size+j*delta_z;positions.push(x,
0,z);normals.push(0,1,0);texcoords.push(i/(x_subdiv-1),j/(z_subdiv-1));if(i&&j){var idx0=i*z_subdiv+j;var idx1=idx0-1;var idx2=(i-1)*z_subdiv+j;var idx3=idx2-1;indices.push(idx0,idx1,idx2);indices.push(idx1,idx3,idx2)}}}var va_frame=m_util.create_empty_va_frame();va_frame["a_position"]=new Float32Array(positions);va_frame["a_normal"]=new Float32Array(normals);var submesh=m_util.create_empty_submesh("GRID_PLANE");submesh.va_frames[0]=va_frame;submesh.va_common["a_texcoord"]=new Float32Array(texcoords);
submesh.indices=new Uint32Array(indices);submesh.base_length=positions.length/3;return submesh}exports.generate_multigrid=function(num_cascads,subdivs,detailed_dist){var min_casc_size=detailed_dist/Math.pow(2,num_cascads-1);var x_size=min_casc_size;var z_size=min_casc_size;var x_subdiv=subdivs+1;var z_subdiv=subdivs+1;var indices=[];var positions=[];var prev_x=0;var prev_z=0;var last_added_ind=-1;function is_merged_vertex(i,j){if(i%2==1&&(j==0||j==z_subdiv-1)||j%2==1&&(i==0||i==x_subdiv-1))return true;
else return false}var prev_utmost_verts=[];for(var c=0;c<num_cascads;c++){var delta_x=2*x_size/(x_subdiv-1);var delta_z=2*z_size/(z_subdiv-1);var cur_utmost_verts=[];var casc_indices=[];var all_skipped=0;for(var i=0;i<x_subdiv;i++){var x=-x_size+i*delta_x;var indices_in_row=[];for(var j=0;j<z_subdiv;j++){var z=-z_size+j*delta_z;if(!(x>-prev_x&&x<prev_x&&z>-prev_z&&z<prev_z)){var coinciding_ind=null;for(var k=0;k<prev_utmost_verts.length;k+=3)if(x==prev_utmost_verts[k]&&z==prev_utmost_verts[k+1]){coinciding_ind=
prev_utmost_verts[k+2];break}if(coinciding_ind!==null)var idx0=coinciding_ind;else var idx0=last_added_ind+1;if(!is_merged_vertex(i,j)){if(coinciding_ind==null){if(j==0||j==z_subdiv-1||i==0||i==x_subdiv-1){if(c==num_cascads-1)var cascad_step=delta_x;else var cascad_step=2*delta_x;cur_utmost_verts.push(x,z,idx0)}else var cascad_step=delta_x;positions.push(x,cascad_step,z);last_added_ind++}indices_in_row.push(idx0)}else{indices_in_row.push(-2);all_skipped++}if(i&&j)if(i==1)if(is_merged_vertex(i-1,j))if(j>
1){var idx1=idx0-1;var idx2=casc_indices[i-1][j+1];var idx3=idx2-1;indices.push(idx0,idx1,idx3);indices.push(idx0,idx3,idx2)}else{var idx2=casc_indices[i-1][j+1];var idx3=idx2-1;indices.push(idx0,idx3,idx2)}else{if(!is_merged_vertex(i,j)){var idx1=idx0-1;var idx2=casc_indices[i-1][j];indices.push(idx0,idx1,idx2)}}else if(i==x_subdiv-1){if(!is_merged_vertex(i,j))if(j==z_subdiv-1){var idx1=idx0-1;var idx2=casc_indices[i-1][j-1];var idx3=casc_indices[i-2][j];indices.push(idx0,idx1,idx2);indices.push(idx0,
idx2,idx3)}else{var idx1=idx0-1;var idx2=casc_indices[i-1][j];var idx3=idx2-1;var idx4=idx2+1;indices.push(idx0,idx1,idx3);indices.push(idx0,idx3,idx2);indices.push(idx0,idx2,idx4);if(j==2){idx4=casc_indices[i-2][j-2];indices.push(idx1,idx4,idx3)}}}else if(j==1)if(!is_merged_vertex(i,j-1)){var idx1=indices_in_row[j-1];var idx2=casc_indices[i-1][j];var idx3=casc_indices[i-2][j-1];indices.push(idx0,idx1,idx2);indices.push(idx1,idx3,idx2)}else{var idx1=casc_indices[i-1][j];var idx2=casc_indices[i-1][j-
1];indices.push(idx0,idx2,idx1)}else if(j==z_subdiv-1){if(!is_merged_vertex(i,j)){var idx1=indices_in_row[j-1];var idx2=casc_indices[i-1][j-1];var idx3=casc_indices[i-2][j];indices.push(idx0,idx1,idx2);indices.push(idx0,idx2,idx3)}}else if(casc_indices[i-1][j]!=-1&&casc_indices[i-1][j-1]!=-1&&indices_in_row[j-1]!=-1){var idx1=indices_in_row[j-1];var idx2=casc_indices[i-1][j];var idx3=casc_indices[i-1][j-1];indices.push(idx0,idx1,idx2);indices.push(idx1,idx3,idx2);if(j==z_subdiv-2&&is_merged_vertex(i,
j+1)){var idx4=casc_indices[i-1][j+1];indices.push(idx0,idx2,idx4)}}else if(j==z_subdiv-2&&is_merged_vertex(i,j+1)){var idx2=casc_indices[i-1][j];var idx4=casc_indices[i-1][j+1];indices.push(idx0,idx2,idx4)}}else{indices_in_row.push(-1);all_skipped++}}casc_indices.push(indices_in_row)}prev_utmost_verts=cur_utmost_verts;prev_x=x_size;prev_z=z_size;x_size*=2;z_size*=2}var required_mesh_size=2E4;if(prev_x<required_mesh_size){var casc_step=-(2*prev_x)/(x_subdiv-1);positions.push(-required_mesh_size,casc_step,
-required_mesh_size);positions.push(-required_mesh_size,casc_step,required_mesh_size);positions.push(-prev_x,casc_step,-prev_z);positions.push(-prev_x,casc_step,prev_z);positions.push(required_mesh_size,casc_step,-required_mesh_size);positions.push(required_mesh_size,casc_step,required_mesh_size);positions.push(prev_x,casc_step,-prev_z);positions.push(prev_x,casc_step,prev_z);var idx0=last_added_ind+1;indices.push(idx0+3,idx0+2,idx0+1,idx0+2,idx0+0,idx0+1,idx0+6,idx0+4,idx0+2,idx0+4,idx0+0,idx0+2,
idx0+5,idx0+7,idx0+1,idx0+7,idx0+3,idx0+1,idx0+5,idx0+4,idx0+7,idx0+7,idx0+4,idx0+6)}var va_frame=m_util.create_empty_va_frame();va_frame["a_position"]=new Float32Array(positions);var submesh=m_util.create_empty_submesh("multigrid_plane");submesh.va_frames[0]=va_frame;submesh.indices=new Uint32Array(indices);submesh.base_length=positions.length/3;if(cfg_def.water_wireframe_debug){m_geom.submesh_drop_indices(submesh,1,true);va_frame["a_polyindex"]=m_geom.extract_polyindices(submesh)}return submesh};
exports.generate_from_triangles=function(verts){var len=verts.length;if(len%3)throw"Wrong array";var indices=[];var positions=[];for(var i=0;i<len;i+=3){var v1=verts[i];var v2=verts[i+1];var v3=verts[i+2];add_vec3_to_array(v1,positions);add_vec3_to_array(v2,positions);add_vec3_to_array(v3,positions);indices.push(i,i+1,i+2)}var va_frame=m_util.create_empty_va_frame();va_frame["a_position"]=new Float32Array(positions);var submesh=m_util.create_empty_submesh("FROM_TRIANGLES");submesh.va_frames[0]=va_frame;
submesh.indices=new Uint32Array(indices);submesh.base_length=positions.length/3;return submesh};exports.generate_from_quads=generate_from_quads;function generate_from_quads(verts){var len=verts.length;if(len%4)throw"Wrong array";var indices=[];var positions=[];for(var i=0;i<len;i+=4){var v1=verts[i];var v2=verts[i+1];var v3=verts[i+2];var v4=verts[i+3];add_vec3_to_array(v1,positions);add_vec3_to_array(v2,positions);add_vec3_to_array(v3,positions);add_vec3_to_array(v4,positions);indices.push(i,i+1,
i+2);indices.push(i,i+2,i+3)}var va_frame=m_util.create_empty_va_frame();va_frame["a_position"]=new Float32Array(positions);var submesh=m_util.create_empty_submesh("FROM_QUADS");submesh.va_frames[0]=va_frame;submesh.indices=new Uint32Array(indices);submesh.base_length=positions.length/3;return submesh}exports.generate_frustum=function(corners){var corners=m_util.vectorize(corners,[]);var quads=[];quads.push(corners[0],corners[1],corners[2],corners[3]);quads.push(corners[0],corners[3],corners[5],corners[4]);
quads.push(corners[3],corners[2],corners[6],corners[5]);quads.push(corners[1],corners[7],corners[6],corners[2]);quads.push(corners[0],corners[4],corners[7],corners[1]);quads.push(corners[4],corners[5],corners[6],corners[7]);var submesh=generate_from_quads(quads);submesh.name="FRUSTUM";return submesh};exports.generate_fullscreen_tri=function(){var submesh=m_util.create_empty_submesh("FULLSCREEN_TRI");var va_frame=m_util.create_empty_va_frame();va_frame["a_position"]=new Float32Array([0,0,1,0,0,1]);
submesh.va_frames[0]=va_frame;submesh.indices=new Uint32Array([0,1,2]);submesh.base_length=3;return submesh};exports.generate_fullscreen_quad=function(){var submesh=m_util.create_empty_submesh("FULLSCREEN_QUAD");var va_frame=m_util.create_empty_va_frame();va_frame["a_position"]=new Float32Array([-1,1,1,1,-1,-1,1,-1]);submesh.va_frames[0]=va_frame;submesh.indices=new Uint32Array([0,2,1,1,2,3]);submesh.base_length=4;return submesh};exports.generate_billboard=function(){var submesh=m_util.create_empty_submesh("BILLBOARD");
var va_frame=m_util.create_empty_va_frame();va_frame["a_bb_vertex"]=new Float32Array([-.5,-.5,-.5,.5,.5,.5,.5,-.5]);submesh.va_frames[0]=va_frame;submesh.indices=new Uint32Array([0,2,1,0,3,2]);submesh.base_length=4;return submesh};exports.generate_cube=function(){var submesh=m_util.create_empty_submesh("CUBEMAP_BOARD");var va_frame=m_util.create_empty_va_frame();va_frame["a_position"]=new Float32Array([-1,-1,-1,1,1,1,1,-1]);submesh.va_frames[0]=va_frame;submesh.indices=new Uint32Array([0,2,1,0,3,
2]);submesh.base_length=4;return submesh};exports.generate_uv_sphere=function(segments,rings,size,center,use_smooth,use_wireframe){var submesh=m_util.create_empty_submesh("UV_SPHERE");var x,y;var positions=[];var grid_positions=[];var indices=[];for(y=0;y<=rings;y++)for(x=0;x<=segments;x++){var u=x/segments;var v=y/rings;var xpos=-size*Math.cos(u*2*Math.PI)*Math.sin(v*Math.PI);var ypos=size*Math.cos(v*Math.PI);var zpos=size*Math.sin(u*2*Math.PI)*Math.sin(v*Math.PI);if(use_smooth){var edge=1E-5;xpos=
Math.abs(xpos)<edge?0:xpos;ypos=Math.abs(ypos)<edge?0:ypos;zpos=Math.abs(zpos)<edge?0:zpos}grid_positions.push(xpos+center[0],ypos+center[1],zpos+center[2])}var v_index=0;for(y=0;y<rings;y++)for(x=0;x<segments;x++){var v1=extract_vec3(grid_positions,(segments+1)*y+x+1);var v2=extract_vec3(grid_positions,(segments+1)*y+x);var v3=extract_vec3(grid_positions,(segments+1)*(y+1)+x);var v4=extract_vec3(grid_positions,(segments+1)*(y+1)+x+1);if(Math.abs(v1[1])==size+center[1]){add_vec3_to_array(v1,positions);
add_vec3_to_array(v3,positions);add_vec3_to_array(v4,positions);if(use_wireframe)indices.push(v_index,v_index+1,v_index+1,v_index+2,v_index+2,v_index);else indices.push(v_index,v_index+1,v_index+2);v_index+=3}else if(Math.abs(v3[1])==size+center[1]){add_vec3_to_array(v1,positions);add_vec3_to_array(v2,positions);add_vec3_to_array(v3,positions);if(use_wireframe)indices.push(v_index,v_index+1,v_index+1,v_index+2,v_index+2,v_index);else indices.push(v_index,v_index+1,v_index+2);v_index+=3}else{add_vec3_to_array(v1,
positions);add_vec3_to_array(v2,positions);add_vec3_to_array(v3,positions);add_vec3_to_array(v4,positions);if(use_wireframe){indices.push(v_index,v_index+1);indices.push(v_index+1,v_index+2);indices.push(v_index+2,v_index+3);indices.push(v_index+3,v_index)}else{indices.push(v_index,v_index+1,v_index+2);indices.push(v_index,v_index+2,v_index+3)}v_index+=4}}var va_frame={};va_frame["a_position"]=positions;if(use_wireframe)va_frame["a_normal"]=[];else{var shared_indices=m_geom.calc_shared_indices(indices,
grid_positions,positions);va_frame["a_normal"]=m_geom.calc_normals(indices,positions,shared_indices)}va_frame["a_tangent"]=[];submesh.va_common["a_influence"]=[];submesh.va_common["a_color"]=[];submesh.va_common["a_texcoord"]=[];submesh.va_frames[0]=va_frame;submesh.indices=indices;submesh.base_length=positions.length/3;return submesh};function extract_vec3(array,position){var offset=position*3;var x=array[offset];var y=array[offset+1];var z=array[offset+2];return[x,y,z]}function add_vec3_to_array(vec,
array){array.push(vec[0],vec[1],vec[2])}exports.generate_index=function(num){var submesh=m_util.create_empty_submesh("INDEX");var va_frame=m_util.create_empty_va_frame();va_frame["a_index"]=new Float32Array(num);for(var i=0;i<num;i++)va_frame["a_index"][i]=i;submesh.va_frames[0]=va_frame;submesh.indices=new Uint16Array(0);submesh.base_length=num;return submesh}};b4w.module["__prerender"]=function(exports,require){var m_cfg=require("__config");var m_debug=require("__debug");var m_geom=require("__geometry");var m_render=require("__renderer");var m_util=require("__util");var m_vec3=require("__vec3");var cfg_def=m_cfg.defaults;var USE_FRUSTUM_CULLING=true;var SUBS_UPDATE_DO_RENDER=["MAIN_OPAQUE","MAIN_BLEND","MAIN_PLANE_REFLECT","MAIN_CUBE_REFLECT","MAIN_GLOW","SHADOW_CAST","DEPTH","OUTLINE_MASK","WIREFRAME","COLOR_PICKING","MAIN_XRAY","COLOR_PICKING_XRAY"];
exports.prerender_subs=function(subs){if(SUBS_UPDATE_DO_RENDER.indexOf(subs.type)>-1){var has_render_bundles=false;var bundles=subs.bundles;for(var i=0;i<bundles.length;i++){var bundle=bundles[i];if(subs.type=="MAIN_CUBE_REFLECT")for(var j=0;j<6;j++){subs.camera.frustum_planes=subs.cube_cam_frustums[j];bundle.do_render_cube[j]=prerender_bundle(bundle,subs);if(bundle.do_render_cube[j])has_render_bundles=true}else{bundle.do_render=prerender_bundle(bundle,subs);if(bundle.do_render)has_render_bundles=
true}}var cam=subs.camera;switch(subs.type){case "WIREFRAME":break;default:if(subs.type==="MAIN_OPAQUE"||subs.type==="DEPTH"||has_render_bundles)subs.do_render=true;else{if(subs.do_render)m_render.clear(subs);subs.do_render=false}break}}if(subs.type=="MAIN_BLEND")zsort(subs)};function zsort(subs){if(!cfg_def.alpha_sort||!subs.bundles)return;var eye=subs.camera.eye;var cam_updated=m_vec3.dist(eye,subs.zsort_eye_last)>cfg_def.alpha_sort_threshold;for(var i=0;i<subs.bundles.length;i++){var bundle=subs.bundles[i];
var obj_render=bundle.obj_render;if(!obj_render.force_zsort&&!cam_updated)continue;var batch=bundle.batch;if(batch&&batch.blend&&batch.zsort_type!=m_geom.ZSORT_DISABLED){var bufs_data=batch.bufs_data;if(!bufs_data||!bundle.do_render)continue;var info=bufs_data.info_for_z_sort_updates;if(info&&info.type==m_geom.ZSORT_BACK_TO_FRONT){var world_matrix=obj_render.world_matrix;m_geom.update_buffers_movable(bufs_data,world_matrix,eye)}}obj_render.force_zsort=false}if(cam_updated)m_vec3.copy(eye,subs.zsort_eye_last)}
function prerender_bundle(bundle,subs){var obj_render=bundle.obj_render;var cam=subs.camera;obj_render.is_visible=false;if(!obj_render)return false;if(obj_render.hide)return false;if(!is_lod_visible(obj_render,cam))return false;obj_render.is_visible=true;if(subs.type=="OUTLINE_MASK"&&!Boolean(obj_render.outline_intensity))return false;if(USE_FRUSTUM_CULLING&&is_out_of_frustum(obj_render,cam.frustum_planes))return false;if(subs.type=="WIREFRAME")if(bundle.batch.wireframe_mode==m_debug.WM_DEBUG_SPHERES)return bundle.batch.debug_sphere;
else return!bundle.batch.debug_sphere;return true}function is_out_of_frustum(obj_render,planes){if(obj_render.do_not_cull)return false;if(obj_render.type==="STATIC"){var bs=obj_render.bs_world;var pt=bs.center;var radius=bs.radius;var is_out=m_util.sphere_is_out_of_frustum(pt,planes,radius)}else{var be=obj_render.be_world;var pt=be.center;var axis_x=be.axis_x;var axis_y=be.axis_y;var axis_z=be.axis_z;var is_out=m_util.ellipsoid_is_out_of_frustum(pt,planes,axis_x,axis_y,axis_z)}return is_out}function is_lod_visible(obj_render,
camera){var eye=camera.eye;var center=obj_render.bs_world.center;var dist_min=obj_render.lod_dist_min;var dist_max=obj_render.lod_dist_max;var dist=Math.sqrt((center[0]-eye[0])*(center[0]-eye[0])+(center[1]-eye[1])*(center[1]-eye[1])+(center[2]-eye[2])*(center[2]-eye[2]));var tr_int=obj_render.lod_transition_ratio*obj_render.bs_world.radius;if(dist>=dist_min&&dist<dist_max+tr_int)return true;else return false}};b4w.module["__print"]=function(exports,require){var _verbose=false;var _error_count=0;var _warning_count=0;exports.set_verbose=function(v){_verbose=v};exports.log_raw=function(){console.log.apply(console,arguments)};exports.log=function(){if(_verbose){var args=compose_args_prefix(arguments,"B4W LOG");console.log.apply(console,args)}};function compose_args_prefix(args_in,prefix){var args_out=[];if(args_in[0].indexOf("%c")>-1)args_out.push(args_in[0].replace("%c","%c"+prefix+": "));else args_out.push(prefix+
": "+args_in[0]);for(var i=1;i<args_in.length;i++)args_out.push(args_in[i]);return args_out}exports.error=function(){_error_count++;var args=compose_args_prefix(arguments,"B4W ERROR");console.error.apply(console,args)};exports.warn=function(){_warning_count++;var args=compose_args_prefix(arguments,"B4W WARN");console.warn.apply(console,args)};exports.info=function(){var args=compose_args_prefix(arguments,"B4W INFO");console.info.apply(console,args)};exports.export_error=function(){_error_count++;
var args=compose_args_prefix(arguments,"B4W EXPORT ERROR");console.error.apply(console,args)};exports.export_warn=function(){_warning_count++;var args=compose_args_prefix(arguments,"B4W EXPORT WARNING");console.warn.apply(console,args)};exports.time=function(){if(_verbose)console.time.apply(console,arguments)};exports.timeEnd=function(){if(_verbose)console.timeEnd.apply(console,arguments)};exports.group=function(){if(_verbose)console.group.apply(console,arguments)};exports.groupCollapsed=function(){if(_verbose)console.groupCollapsed.apply(console,
arguments)};exports.groupEnd=function(){if(_verbose)console.groupEnd.apply(console,arguments)};exports.clear=function(){if(typeof console.clear=="function")console.clear.apply(console,arguments)};exports.get_warning_count=function(){return _warning_count};exports.get_error_count=function(){return _error_count};exports.clear_errors_warnings=function(){_warning_count=0;_error_count=0}};b4w.module["print"]=b4w.module["__print"];b4w.module["__reformer"]=function(exports,require){var m_bounds=require("__boundings");var m_curve=require("__curve");var m_mat4=require("__mat4");var m_print=require("__print");var m_quat=require("__quat");var m_util=require("__util");var m_vec3=require("__vec3");var m_vec4=require("__vec4");var REPORT_COMPATIBILITY_ISSUES=true;var REQUIRED_FOR_PART_SYS_BIN_FORMAT=[5,4];var _unreported_compat_issues=false;var _params_reported={};function reform_node(node){switch(node["type"]){case "MAPPING":if(!node["vector_type"]){node["vector_type"]=
"POINT";report("node Mapping",node,"vector_type")}break;case "MATERIAL":case "MATERIAL_EXT":if(!("alpha"in node)){node["alpha"]=1;report("node material",node,"alpha")}if(!("darkness"in node)){node["darkness"]=1;report("node material",node,"darkness")}if(!("diffuse_toon_size"in node)){node["diffuse_toon_size"]=.5;report("node material",node,"diffuse_toon_size")}if(!("diffuse_toon_smooth"in node)){node["diffuse_toon_smooth"]=.1;report("node material",node,"diffuse_toon_smooth")}if(!("diffuse_intensity"in
node)){node["diffuse_intensity"]=1;report("node material",node,"diffuse_intensity")}if(!("specular_shader"in node)){node["specular_shader"]="COOKTORR";report("node material",node,"specular_shader")}if(!("specular_ior"in node)){node["specular_ior"]=4;report("node material",node,"specular_ior")}if(!("specular_hardness"in node)){node["specular_hardness"]=50;report("node material",node,"specular_hardness")}if(!("specular_slope"in node)){node["specular_slope"]=.1;report("node material",node,"specular_slope")}if(!("specular_toon_size"in
node)){node["specular_toon_size"]=.5;report("node material",node,"specular_toon_size")}if(!("specular_toon_smooth"in node)){node["specular_toon_smooth"]=.1;report("node material",node,"specular_toon_smooth")}if(!("specular_intensity"in node)){node["specular_intensity"]=.5;report("node material",node,"specular_intensity")}if(!("diffuse_shader"in node)){node["diffuse_shader"]="LAMBERT";report("node material",node,"diffuse_shader")}if(!("roughness"in node)){node["roughness"]=.5;report("node material",
node,"roughness")}if(!("diffuse_fresnel"in node)){node["diffuse_fresnel"]=.1;report("node material",node,"diffuse_fresnel")}if(!("diffuse_fresnel_factor"in node)){node["diffuse_fresnel_factor"]=.5;report("node material",node,"diffuse_fresnel_factor")}break;case "MATH":case "MIX_RGB":if(!("use_clamp"in node)){node["use_clamp"]=false;report("node "+node["type"],node,"use_clamp")}break;case "GROUP":node["node_tree_name"]=node["node_tree_name"].replace(/\.[0-9]{3,}$/g,"");switch(node["node_tree_name"]){case "CLAMP":case "LEVELS_OF_QUALITY":case "LINEAR_TO_SRGB":case "NORMAL_VIEW":case "PARALLAX":case "REFLECT":case "REFRACTION":case "REPLACE":case "SMOOTHSTEP":case "SRGB_TO_LINEAR":case "TIME":case "TRANSLUCENCY":case "VECTOR_VIEW":node["node_tree_name"]=
"B4W_"+node["node_tree_name"];break;default:break}break}}exports.check_particles_bin_format=function(loaded_data_version){return m_util.version_cmp(loaded_data_version,REQUIRED_FOR_PART_SYS_BIN_FORMAT)!=-1};exports.check_bpy_data=function(bpy_data){_params_reported={};var check_modifier=function(mod,bpy_obj){switch(mod["type"]){case "ARRAY":if(!("fit_type"in mod)){report_modifier(mod["type"],bpy_obj,bpy_data["b4w_filepath_blend"]);return false}break;default:break}return true};var worlds=bpy_data["worlds"];
if(worlds.length==0){report_missing_datablock("world",bpy_data["b4w_filepath_blend"]);var world={"name":"DEFAULT","horizon_color":new Float32Array([0,0,0]),"zenith_color":new Float32Array([0,0,0]),"light_settings":{"use_environment_light":false,"environment_energy":1,"environment_color":"PLAIN"},"fog_settings":{"use_fog":false,"intensity":0,"depth":25,"start":5,"height":0,"falloff":"INVERSE_QUADRATIC","use_custom_color":true,"color":[.5,.5,.5]},"use_sky_paper":false,"use_sky_blend":false,"use_sky_real":false,
"texture_slots":[]};worlds.push(world)}var worlds=bpy_data["worlds"];for(var i=0;i<worlds.length;i++){var world=worlds[i];if(!("use_sky_blend"in world)){report("world",world,"use_sky_blend");world["use_sky_blend"]=false}if(!("use_sky_paper"in world)){report("world",world,"use_sky_paper");world["use_sky_paper"]=false}if(!("use_sky_real"in world)){report("world",world,"use_sky_real");world["use_sky_real"]=false}if(!("b4w_sky_settings"in world)||!("rayleigh_brightness"in world["b4w_sky_settings"])){report("world",
world,"rayleigh_brightness");world["b4w_sky_settings"]={"render_sky":false,"procedural_skydome":false,"use_as_enviroment_map":false,"color":[.24,.43,.75],"rayleigh_brightness":3.3,"mie_brightness":.1,"spot_brightness":10,"scatter_strength":.2,"rayleigh_strength":.2,"mie_strength":.006,"rayleigh_collection_power":.5,"mie_collection_power":.5,"mie_distribution":.4}}if(!("fog_settings"in world)){report("world",world,"fog_settings");world["fog_settings"]={"use_fog":false,"intensity":0,"depth":25,"start":0,
"height":0,"falloff":"QUADRATIC","use_custom_color":true,"color":[.5,.5,.5]};if("b4w_fog_color"in world){world["fog_settings"]["use_custom_color"]=true;world["fog_settings"]["color"]=world["b4w_fog_color"]}if("b4w_fog_density"in world)if(world["b4w_fog_density"]>0)world["fog_settings"]["depth"]=1/world["b4w_fog_density"]}if(!("render_sky"in world["b4w_sky_settings"])){report("world",world,"render_sky");world["b4w_sky_settings"]["render_sky"]=false}var texture_slots=world["texture_slots"];for(var j=
0;j<texture_slots.length;j++){var slot=texture_slots[j];if(!("blend_type"in slot)){slot["blend_type"]="MIX";report("world_texture_slot",slot,"blend_type")}if(!("use_map_blend"in slot)){slot["use_map_blend"]=false;report("world_texture_slot",slot,"use_map_blend")}if(!("use_map_horizon"in slot)){slot["use_map_horizon"]=true;report("world_texture_slot",slot,"use_map_horizon")}if(!("use_map_zenith_up"in slot)){slot["use_map_zenith_up"]=false;report("world_texture_slot",slot,"use_map_zenith_up")}if(!("use_rgb_to_intensity"in
slot)){slot["use_rgb_to_intensity"]=false;report("world_texture_slot",slot,"use_rgb_to_intensity")}if(!("invert"in slot)){slot["invert"]=false;report("world_texture_slot",slot,"invert")}if(!("color"in slot)){slot["color"]=[1,0,1];report("world_texture_slot",slot,"color")}if(!("blend_factor"in slot)){slot["blend_factor"]=0;report("world_texture_slot",slot,"blend_factor")}if(!("horizon_factor"in slot)){slot["horizon_factor"]=1;report("world_texture_slot",slot,"horizon_factor")}if(!("zenith_up_factor"in
slot)){slot["zenith_up_factor"]=0;report("world_texture_slot",slot,"zenith_up_factor")}if(!("zenith_down_factor"in slot)){slot["zenith_down_factor"]=0;report("world_texture_slot",slot,"zenith_down_factor")}if(!("default_value"in slot)){slot["default_value"]=1;report("world_texture_slot",slot,"default_value")}}}var scenes=bpy_data["scenes"];for(var i=0;i<scenes.length;i++){var scene=scenes[i];var sc_world=scene["world"];if(!("timeline_markers"in scene)){scene["timeline_markers"]=null;report("scene",
scene,"timeline_markers")}if(!("b4w_reflection_quality"in scene)){scene["b4w_reflection_quality"]="MEDIUM";report("scene",scene,"b4w_reflection_quality")}if(!("b4w_use_nla"in scene)){scene["b4w_use_nla"]=false;report("scene",scene,"b4w_use_nla")}if(!("fps"in scene)){scene["fps"]=24;report("scene",scene,"fps")}if(!("b4w_nla_cyclic"in scene)){scene["b4w_nla_cyclic"]=false;report("scene",scene,"b4w_nla_cyclic")}if(!("b4w_logic_nodes"in scene)){scene["b4w_logic_nodes"]=[];report("scene",scene,"b4w_logic_nodes")}if("b4w_detect_collisions"in
scene){report_deprecated("scene",scene,"b4w_detect_collisions");delete scene["b4w_detect_collisions"]}if(!("audio_doppler_speed"in scene))scene["audio_doppler_speed"]=343.3;if(!("audio_doppler_factor"in scene))scene["audio_doppler_factor"]=1;if(!("b4w_dynamic_compressor_settings"in scene)){scene["b4w_dynamic_compressor_settings"]={"threshold":-24,"knee":30,"ratio":12,"attack":.003,"release":.25};report("scene",scene,"b4w_dynamic_compressor_settings")}if(!("b4w_enable_convolution_engine"in scene))scene["b4w_enable_convolution_engine"]=
false;if(!("b4w_enable_bloom"in scene)){scene["b4w_enable_bloom"]=false;report("scene",scene,"b4w_enable_bloom")}if(!("b4w_enable_motion_blur"in scene)){scene["b4w_enable_motion_blur"]=false;report("scene",scene,"b4w_enable_motion_blur")}if(!("b4w_enable_color_correction"in scene)){scene["b4w_enable_color_correction"]=false;report("scene",scene,"b4w_enable_color_correction")}if(!("b4w_enable_antialiasing"in scene)){scene["b4w_enable_antialiasing"]=true;report("scene",scene,"b4w_enable_antialiasing")}if(!("b4w_tags"in
scene)){scene["b4w_tags"]={"title":"","description":""};report("scene",scene,"b4w_tags")}if(!("b4w_enable_object_selection"in scene)){scene["b4w_enable_object_selection"]="AUTO";report("scene",scene,"b4w_enable_object_selection")}if(!("b4w_enable_outlining"in scene)){scene["b4w_enable_outlining"]="AUTO";report("scene",scene,"b4w_enable_outlining")}if(!("b4w_enable_glow_materials"in scene)){scene["b4w_enable_glow_materials"]="AUTO";report("scene",scene,"b4w_enable_glow_materials")}if(!("b4w_enable_anchors_visibility"in
scene)){scene["b4w_enable_anchors_visibility"]="AUTO";report("scene",scene,"b4w_enable_anchors_visibility")}if(!("b4w_outline_color"in scene)){scene["b4w_outline_color"]=[1,1,1];report("scene",scene,"b4w_outline_color")}if(!("b4w_outline_factor"in scene)){if("b4w_glow_factor"in scene)scene["b4w_outline_factor"]=scene["b4w_glow_factor"];else scene["b4w_outline_factor"]=1;report("scene",scene,"b4w_outline_factor")}if(!("b4w_shadow_settings"in scene)){report("scene",scene,"b4w_shadow_settings");var w_shadows=
sc_world["b4w_shadow_settings"];if(w_shadows)scene["b4w_shadow_settings"]=w_shadows;else scene["b4w_shadow_settings"]={"csm_resolution":2048,"self_shadow_polygon_offset":1,"b4w_enable_csm":false,"csm_num":1,"csm_first_cascade_border":10,"first_cascade_blur_radius":3,"csm_last_cascade_border":100,"last_cascade_blur_radius":1.5,"fade_last_cascade":true,"blend_between_cascades":true}}var shadows=scene["b4w_shadow_settings"];if(!("csm_resolution"in shadows)){report("scene",scene,"b4w_shadow_settings.csm_resolution");
shadows["csm_resolution"]=2048}if(!("self_shadow_polygon_offset"in shadows)){report("scene",scene,"b4w_shadow_settings.self_shadow_polygon_offset");shadows["self_shadow_polygon_offset"]=1}if(!("self_shadow_normal_offset"in shadows)){report("scene",scene,"b4w_shadow_settings.self_shadow_normal_offset");shadows["self_shadow_normal_offset"]=.01}if(!("b4w_enable_csm"in shadows)){report("scene",scene,"b4w_shadow_settings.b4w_enable_csm");shadows["b4w_enable_csm"]=false}if(!("csm_num"in shadows)){report("scene",
scene,"b4w_shadow_settings.csm_num");shadows["csm_num"]=1}if(!("csm_first_cascade_border"in shadows)){report("scene",scene,"b4w_shadow_settings.csm_first_cascade_border");shadows["csm_first_cascade_border"]=10}if(!("first_cascade_blur_radius"in shadows)){report("scene",scene,"b4w_shadow_settings.first_cascade_blur_radius");shadows["first_cascade_blur_radius"]=3}if(!("csm_last_cascade_border"in shadows)){report("scene",scene,"b4w_shadow_settings.csm_last_cascade_border");shadows["csm_last_cascade_border"]=
100}if(!("last_cascade_blur_radius"in shadows)){report("scene",scene,"b4w_shadow_settings.last_cascade_blur_radius");shadows["last_cascade_blur_radius"]=1.5}if(!("fade_last_cascade"in shadows)){report("scene",scene,"b4w_shadow_settings.fade_last_cascade");shadows["fade_last_cascade"]=true}if(!("blend_between_cascades"in shadows)){report("scene",scene,"b4w_shadow_settings.blend_between_cascades");shadows["blend_between_cascades"]=true}if(!("b4w_ssao_settings"in scene)){report("scene",scene,"b4w_ssao_settings");
var w_ssao=sc_world["b4w_ssao_settings"];if(w_ssao)scene["b4w_ssao_settings"]=w_ssao;else scene["b4w_ssao_settings"]={"dist_factor":0,"samples":16,"hemisphere":false,"blur_depth":false,"blur_discard_value":1}}var ssao=scene["b4w_ssao_settings"];if(!("dist_factor"in ssao)){report("scene",scene,"b4w_ssao_settings.dist_factor");ssao["dist_factor"]=0}if(!("samples"in ssao)){report("scene",scene,"b4w_ssao_settings.samples");ssao["samples"]=16}if(!("hemisphere"in ssao)){report("scene",scene,"b4w_ssao_settings.hemisphere");
ssao["hemisphere"]=false}if(!("blur_depth"in ssao)){report("scene",scene,"b4w_ssao_settings.blur_depth");ssao["blur_depth"]=false}if(!("blur_discard_value"in ssao)){report("scene",scene,"b4w_ssao_settings.blur_discard_value");ssao["blur_discard_value"]=1}if(!("b4w_bloom_settings"in scene)){report("scene",scene,"b4w_bloom_settings");var w_bloom=sc_world["b4w_bloom_settings"];if(w_bloom)scene["b4w_bloom_settings"]=w_bloom;else scene["b4w_bloom_settings"]={"key":.2,"blur":4,"edge_lum":1}}if(!("key"in
scene["b4w_bloom_settings"])){report("scene",scene,"b4w_bloom_settings.key");scene["b4w_bloom_settings"]["key"]=.2}if(!("blur"in scene["b4w_bloom_settings"])){report("scene",scene,"b4w_bloom_settings.blur");scene["b4w_bloom_settings"]["blur"]=4}if(!("edge_lum"in scene["b4w_bloom_settings"])){report("scene",scene,"b4w_bloom_settings.edge_lum");scene["b4w_bloom_settings"]["edge_lum"]=1}if(!("b4w_motion_blur_settings"in scene)){report("scene",scene,"b4w_motion_blur_settings");var w_motion_blur=sc_world["b4w_motion_blur_settings"];
if(w_motion_blur)scene["b4w_motion_blur_settings"]=w_motion_blur;else scene["b4w_motion_blur_settings"]={"motion_blur_factor":.01,"motion_blur_decay_threshold":.01}}if(!("motion_blur_factor"in scene["b4w_motion_blur_settings"])){report("scene",scene,"b4w_motion_blur_settings.motion_blur_factor");scene["b4w_motion_blur_settings"]["motion_blur_factor"]=.01}if(!("motion_blur_decay_threshold"in scene["b4w_motion_blur_settings"])){report("scene",scene,"b4w_motion_blur_settings.motion_blur_decay_threshold");
scene["b4w_motion_blur_settings"]["motion_blur_decay_threshold"]=.01}if(!("b4w_color_correction_settings"in scene)){report("scene",scene,"b4w_color_correction_settings");var w_color_correction=sc_world["b4w_color_correction_settings"];if(w_color_correction)scene["b4w_color_correction_settings"]=w_color_correction;else scene["b4w_color_correction_settings"]={"brightness":0,"contrast":0,"exposure":1,"saturation":1}}if(!("b4w_god_rays_settings"in scene)){report("scene",scene,"b4w_god_rays_settings");
var w_god_rays=sc_world["b4w_god_rays_settings"];if(w_god_rays)scene["b4w_god_rays_settings"]=w_god_rays;else scene["b4w_god_rays_settings"]={"intensity":.7,"max_ray_length":1,"steps_per_pass":10}}if(!("steps_per_pass"in scene["b4w_god_rays_settings"])){report("scene",scene,"b4w_god_rays_settings.steps_per_pass");scene["b4w_god_rays_settings"]["steps_per_pass"]=10}if(!("b4w_glow_settings"in scene)){report("scene",scene,"b4w_glow_settings");scene["b4w_glow_settings"]={"render_glow_over_blend":false,
"small_glow_mask_coeff":2,"large_glow_mask_coeff":2,"small_glow_mask_width":2,"large_glow_mask_width":6};var glow_set=scene["b4w_glow_settings"];if("b4w_render_glow_over_blend"in sc_world)glow_set["render_glow_over_blend"]=sc_world["b4w_render_glow_over_blend"];if("b4w_small_glow_mask_coeff"in sc_world)glow_set["small_glow_mask_coeff"]=sc_world["b4w_small_glow_mask_coeff"];if("b4w_large_glow_mask_coeff"in sc_world)glow_set["large_glow_mask_coeff"]=sc_world["b4w_large_glow_mask_coeff"];if("b4w_small_glow_mask_width"in
sc_world)glow_set["small_glow_mask_width"]=sc_world["b4w_small_glow_mask_width"];if("b4w_large_glow_mask_width"in sc_world)glow_set["large_glow_mask_width"]=sc_world["b4w_large_glow_mask_width"]}var r_shadows=scene["b4w_render_shadows"];if(r_shadows!="AUTO"&&r_shadows!="OFF"&&r_shadows!="ON")if(r_shadows)scene["b4w_render_shadows"]="ON";else scene["b4w_render_shadows"]="OFF";var r_refl=scene["b4w_render_reflections"];if(r_refl!="OFF"&&r_refl!="ON")if(r_refl)scene["b4w_render_reflections"]="ON";else scene["b4w_render_reflections"]=
"OFF";var r_refr=scene["b4w_render_refractions"];if(r_refr!="AUTO"&&r_refr!="OFF"&&r_refr!="ON")if(r_refr)scene["b4w_render_refractions"]="ON";else scene["b4w_render_refractions"]="OFF";if(scene["b4w_nla_script"])report_deprecated("scene",scene,"b4w_nla_script")}var meshes=bpy_data["meshes"];for(var i=0;i<meshes.length;i++){var mesh=meshes[i];if(!mesh["b4w_bounding_box"]){report("mesh",mesh,"b4w_bounding_box");mesh["b4w_bounding_box"]={"max_x":0,"max_y":0,"max_z":0,"min_x":0,"min_y":0,"min_z":0}}if(!mesh["b4w_bounding_box_source"]){report("mesh",
mesh,"b4w_bounding_box_source");mesh["b4w_bounding_box_source"]=mesh["b4w_bounding_box"]}if(!mesh["uv_textures"]){report("mesh",mesh,"uv_textures");mesh["uv_textures"]=[]}if(!mesh["b4w_bounding_sphere_center"])mesh["b4w_bounding_sphere_center"]=[0,0,0];if(!mesh["b4w_bounding_cylinder_center"])mesh["b4w_bounding_cylinder_center"]=[0,0,0];if(!mesh["b4w_bounding_ellipsoid_center"])mesh["b4w_bounding_ellipsoid_center"]=[0,0,0];if(!mesh["b4w_bounding_ellipsoid_axes"]){var bb=mesh["b4w_bounding_box"];mesh["b4w_bounding_ellipsoid_axes"]=
[(bb["max_x"]-bb["min_x"])/2,(bb["max_y"]-bb["min_y"])/2,(bb["max_z"]-bb["min_z"])/2]}if(!("b4w_shape_keys"in mesh)){mesh["b4w_shape_keys"]=[];report("mesh",mesh,"b4w_shape_keys")}check_export_props(mesh);for(var j=0;j<mesh["b4w_vertex_anim"].length;j++){var va=mesh["b4w_vertex_anim"][j];if(!("allow_nla"in va)){report('mesh["b4w_vertex_anim"]',mesh,"allow_nla");va["allow_nla"]=true}}}var cameras=bpy_data["cameras"];for(var i=0;i<cameras.length;i++){var camera=cameras[i];if(!camera["type"]){camera["type"]=
"PERSP";report("camera",camera,"type")}if("b4w_eye_target_dist"in camera){delete camera["b4w_eye_target_dist"];report_deprecated("camera",camera,"b4w_eye_target_dist")}if(!("b4w_hover_zero_level"in camera)){camera["b4w_hover_zero_level"]=0;report("camera",camera,"b4w_hover_zero_level")}if(!("b4w_trans_velocity"in camera)){camera["b4w_trans_velocity"]=1;report("camera",camera,"b4w_trans_velocity")}if(!("b4w_rot_velocity"in camera)){camera["b4w_rot_velocity"]=1;report("camera",camera,"b4w_rot_velocity")}if(!("b4w_zoom_velocity"in
camera)){camera["b4w_zoom_velocity"]=.1;report("camera",camera,"b4w_zoom_velocity")}if(!("b4w_use_distance_limits"in camera)){camera["b4w_use_distance_limits"]=false;report("camera",camera,"b4w_use_distance_limits")}if(!("b4w_distance_min"in camera)){camera["b4w_distance_min"]=1;report("camera",camera,"b4w_distance_min")}if(!("b4w_distance_max"in camera)){camera["b4w_distance_max"]=100;report("camera",camera,"b4w_distance_max")}if(!("b4w_horizontal_translation_min"in camera)){camera["b4w_horizontal_translation_min"]=
-100;report("camera",camera,"b4w_horizontal_translation_min")}if(!("b4w_horizontal_translation_max"in camera)){camera["b4w_horizontal_translation_max"]=100;report("camera",camera,"b4w_horizontal_translation_max")}if(!("b4w_vertical_translation_min"in camera)){camera["b4w_vertical_translation_min"]=-100;report("camera",camera,"b4w_vertical_translation_min")}if(!("b4w_vertical_translation_max"in camera)){camera["b4w_vertical_translation_max"]=100;report("camera",camera,"b4w_vertical_translation_max")}if(!("b4w_use_horizontal_clamping"in
camera)){camera["b4w_use_horizontal_clamping"]=false;report("camera",camera,"b4w_use_horizontal_clamping")}if(!("b4w_rotation_left_limit"in camera)){camera["b4w_rotation_left_limit"]=-Math.PI;report("camera",camera,"b4w_rotation_left_limit")}if(!("b4w_rotation_right_limit"in camera)){camera["b4w_rotation_right_limit"]=Math.PI;report("camera",camera,"b4w_rotation_right_limit")}if(!("b4w_horizontal_clamping_type"in camera)){camera["b4w_horizontal_clamping_type"]="LOCAL";report("camera",camera,"b4w_horizontal_clamping_type")}if(!("b4w_use_vertical_clamping"in
camera)){camera["b4w_use_vertical_clamping"]=false;report("camera",camera,"b4w_use_vertical_clamping")}if(!("b4w_rotation_down_limit"in camera)){camera["b4w_rotation_down_limit"]=-Math.PI/2;report("camera",camera,"b4w_rotation_down_limit")}if(!("b4w_rotation_up_limit"in camera)){camera["b4w_rotation_up_limit"]=Math.PI/2;report("camera",camera,"b4w_rotation_up_limit")}if(!("b4w_vertical_clamping_type"in camera)){camera["b4w_vertical_clamping_type"]="LOCAL";report("camera",camera,"b4w_vertical_clamping_type")}if(!("b4w_hover_angle_min"in
camera)){camera["b4w_hover_angle_min"]=Math.PI/6;report("camera",camera,"b4w_hover_angle_min")}if(!("b4w_hover_angle_max"in camera)){camera["b4w_hover_angle_max"]=Math.PI/6;report("camera",camera,"b4w_hover_angle_max")}if(!("b4w_enable_hover_hor_rotation"in camera)){camera["b4w_enable_hover_hor_rotation"]=true;report("camera",camera,"b4w_enable_hover_hor_rotation")}if(!("b4w_use_panning"in camera)){camera["b4w_use_panning"]=true;report("camera",camera,"b4w_use_panning")}}var lamps=bpy_data["lamps"];
for(var i=0;i<lamps.length;i++){var lamp=lamps[i];if(!("b4w_generate_shadows"in lamp)){lamp["b4w_generate_shadows"]=false;report("lamp",lamp,"b4w_generate_shadows")}if(!("b4w_dynamic_intensity"in lamp)){lamp["b4w_dynamic_intensity"]=false;report("lamp",lamp,"b4w_dynamic_intensity")}if(!("use_diffuse"in lamp)){lamp["use_diffuse"]=true;report("lamp",lamp,"use_diffuse")}if(!("use_specular"in lamp)){lamp["use_specular"]=true;report("lamp",lamp,"use_specular")}}var speakers=bpy_data["speakers"];for(var i=
0;i<speakers.length;i++){var speaker=speakers[i];if(!("b4w_behavior"in speaker))if(speaker["b4w_background_music"])speaker["b4w_behavior"]="BACKGROUND_SOUND";else speaker["b4w_behavior"]="POSITIONAL";if(!("b4w_disable_doppler"in speaker))speaker["b4w_disable_doppler"]=false;if(!("b4w_delay"in speaker))speaker["b4w_delay"]=0;if(!("b4w_delay_random"in speaker))speaker["b4w_delay_random"]=0;if(!("b4w_volume_random"in speaker))speaker["b4w_volume_random"]=0;if(!("b4w_pitch_random"in speaker))speaker["b4w_pitch_random"]=
0;if(!("b4w_fade_in"in speaker))speaker["b4w_fade_in"]=0;if(!("b4w_fade_out"in speaker))speaker["b4w_fade_out"]=0;if(!("b4w_loop"in speaker))speaker["b4w_loop"]=false;if(!("b4w_loop_count"in speaker))speaker["b4w_loop_count"]=0;if(!("b4w_loop_count_random"in speaker))speaker["b4w_loop_count_random"]=0;if(!("b4w_playlist_id"in speaker))speaker["b4w_playlist_id"]="";if(speaker["animation_data"])check_strip_props(speaker["animation_data"])}var textures=bpy_data["textures"];for(var i=0;i<textures.length;i++){var texture=
textures[i];if(!("b4w_anisotropic_filtering"in texture)){texture["b4w_anisotropic_filtering"]="OFF";report("texture",texture,"b4w_anisotropic_filtering")}if(!("b4w_water_foam"in texture)){texture["b4w_water_foam"]=false;report("texture",texture,"b4w_water_foam")}if(!("b4w_foam_uv_freq"in texture)){texture["b4w_foam_uv_freq"]=[1,1];report("texture",texture,"b4w_foam_uv_freq")}if(!("b4w_foam_uv_magnitude"in texture)){texture["b4w_foam_uv_magnitude"]=[1,1];report("texture",texture,"b4w_foam_uv_magnitude")}if(!("b4w_parallax_steps"in
texture)){texture["b4w_parallax_steps"]=5;report("material",texture,"b4w_parallax_steps")}if(!("b4w_parallax_lod_dist"in texture)){texture["b4w_parallax_lod_dist"]=10;report("material",texture,"b4w_parallax_lod_dist")}if(!("b4w_shore_dist_map"in texture)){texture["b4w_shore_dist_map"]=false;report("texture",texture,"b4w_shore_dist_map")}if(!("b4w_shore_boundings"in texture)){texture["b4w_shore_boundings"]=new Float32Array(4);texture["b4w_shore_boundings"]=[1E3,-1E3,1E3,-1E3];report("texture",texture,
"b4w_shore_boundings")}if(!("b4w_max_shore_dist"in texture)){texture["b4w_max_shore_dist"]=100;report("texture",texture,"b4w_max_shore_dist")}if(!("b4w_disable_compression"in texture)){texture["b4w_disable_compression"]=false;report("texture",texture,"b4w_disable_compression")}if(!("b4w_source_type"in texture)){texture["b4w_source_type"]="";report("texture",texture,"b4w_source_type")}if(!("b4w_source_id"in texture)){texture["b4w_source_id"]="";report("texture",texture,"b4w_source_id")}if(!("b4w_source_size"in
texture)){texture["b4w_source_size"]=1024;report("texture",texture,"b4w_source_size")}if(!("b4w_enable_canvas_mipmapping"in texture)){texture["b4w_enable_canvas_mipmapping"]=true;report("texture",texture,"b4w_enable_canvas_mipmapping")}if(!("b4w_nla_video"in texture)){texture["b4w_nla_video"]=false;report("texture",texture,"b4w_nla_video")}}var materials=bpy_data["materials"];for(var i=0;i<materials.length;i++){var mat=materials[i];if("b4w_node_mat_type"in mat)report_deprecated("material",mat,"b4w_node_mat_type");
if("b4w_skydome"in mat)report_deprecated("material",mat,"b4w_skydome");if("b4w_procedural_skydome"in mat)report_deprecated("material",mat,"b4w_procedural_skydome");if(mat["b4w_water"]){if(!("b4w_water_shore_smoothing"in mat)){mat["b4w_water_shore_smoothing"]=false;report("material",mat,"b4w_water_shore_smoothing")}if(!("b4w_water_dynamic"in mat)){mat["b4w_water_dynamic"]=false;report("material",mat,"b4w_water_dynamic")}if(!("b4w_waves_height"in mat)){mat["b4w_waves_height"]=1;report("material",mat,
"b4w_waves_height")}if(!("b4w_waves_length"in mat)){mat["b4w_waves_length"]=1;report("material",mat,"b4w_waves_length")}if(!("b4w_water_dst_noise_scale0"in mat)){mat["b4w_water_dst_noise_scale0"]=.05;report("material",mat,"b4w_water_dst_noise_scale0")}if(!("b4w_water_dst_noise_scale1"in mat)){mat["b4w_water_dst_noise_scale1"]=.03;report("material",mat,"b4w_water_dst_noise_scale1")}if(!("b4w_water_dst_noise_freq0"in mat)){mat["b4w_water_dst_noise_freq0"]=1.3;report("material",mat,"b4w_water_dst_noise_freq0")}if(!("b4w_water_dst_noise_freq1"in
mat)){mat["b4w_water_dst_noise_freq1"]=1;report("material",mat,"b4w_water_dst_noise_freq1")}if(!("b4w_water_dir_min_shore_fac"in mat)){mat["b4w_water_dir_min_shore_fac"]=.4;report("material",mat,"b4w_water_dir_min_shore_fac")}if(!("b4w_water_dir_freq"in mat)){mat["b4w_water_dir_freq"]=.5;report("material",mat,"b4w_water_dir_freq")}if(!("b4w_water_dir_noise_scale"in mat)){mat["b4w_water_dir_noise_scale"]=.05;report("material",mat,"b4w_water_dir_noise_scale")}if(!("b4w_water_dir_noise_freq"in mat)){mat["b4w_water_dir_noise_freq"]=
.07;report("material",mat,"b4w_water_dir_noise_freq")}if(!("b4w_water_dir_min_noise_fac"in mat)){mat["b4w_water_dir_min_noise_fac"]=.5;report("material",mat,"b4w_water_dir_min_noise_fac")}if(!("b4w_water_dst_min_fac"in mat)){mat["b4w_water_dst_min_fac"]=.2;report("material",mat,"b4w_water_dst_min_fac")}if(!("b4w_water_waves_hor_fac"in mat)){mat["b4w_water_waves_hor_fac"]=5;report("material",mat,"b4w_water_waves_hor_fac")}if(!("b4w_water_absorb_factor"in mat)){mat["b4w_water_absorb_factor"]=6;report("material",
mat,"b4w_water_absorb_factor")}if(!("b4w_water_fog_color"in mat)){mat["b4w_water_fog_color"]=new Float32Array(3);mat["b4w_water_fog_color"]=[.5,.7,.7];report("material",mat,"b4w_water_fog_color")}if(!("b4w_foam_factor"in mat)){mat["b4w_foam_factor"]=5;report("material",mat,"b4w_foam_factor")}if(!("b4w_generated_mesh"in mat)){mat["b4w_generated_mesh"]=false;report("material",mat,"b4w_generated_mesh")}if(!("b4w_water_num_cascads"in mat)){mat["b4w_water_num_cascads"]=5;report("material",mat,"b4w_water_num_cascads")}if(!("b4w_water_subdivs"in
mat)){mat["b4w_water_subdivs"]=64;report("material",mat,"b4w_water_subdivs")}if(!("b4w_water_detailed_dist"in mat)){mat["b4w_water_detailed_dist"]=1E3;report("material",mat,"b4w_water_detailed_dist")}if(!("b4w_water_enable_caust"in mat)){mat["b4w_water_enable_caust"]=false;report("material",mat,"b4w_water_enable_caust")}if(!("b4w_water_caust_scale"in mat)){mat["b4w_water_caust_scale"]=.25;report("material",mat,"b4w_water_caust_scale")}if(!("b4w_water_caust_brightness"in mat)){mat["b4w_water_caust_brightness"]=
.5;report("material",mat,"b4w_water_caust_brightness")}}if(!("b4w_dynamic_grass_size"in mat))mat["b4w_dynamic_grass_size"]="";if(!("b4w_dynamic_grass_color"in mat))mat["b4w_dynamic_grass_color"]="";if(!("diffuse_intensity"in mat)){mat["diffuse_intensity"]=1;report("material",mat,"diffuse_intensity")}if(!("b4w_use_ghost"in mat))mat["b4w_use_ghost"]=false;if(!("b4w_collision_margin"in mat)){mat["b4w_collision_margin"]=.04;report("material",mat,"b4w_collision_margin")}if(!("b4w_collision_group"in mat)){mat["b4w_collision_group"]=
128;report("material",mat,"b4w_collision_group")}if(!("b4w_collision_mask"in mat)){mat["b4w_collision_mask"]=127;report("material",mat,"b4w_collision_mask")}if(!("b4w_do_not_render"in mat)){mat["b4w_do_not_render"]=false;report("material",mat,"b4w_do_not_render")}if(mat.type=="HALO"&&!("b4w_halo_sky_stars"in mat)){mat["b4w_halo_sky_stars"]=false;report("material",mat,"b4w_halo_sky_stars")}if(mat.type=="HALO"&&!("b4w_halo_stars_blend_height"in mat)){mat["b4w_halo_stars_blend_height"]=10;report("material",
mat,"b4w_halo_stars_blend_height")}if(mat.type=="HALO"&&!("b4w_halo_stars_min_height"in mat)){mat["b4w_halo_stars_min_height"]=0;report("material",mat,"b4w_halo_stars_min_height")}if(!("specular_shader"in mat)){mat["specular_shader"]="COOKTORR";report("material",mat,"specular_shader")}if(!("diffuse_shader"in mat)){mat["diffuse_shader"]="LAMBERT";report("material",mat,"diffuse_shader")}if(!("roughness"in mat)){mat["roughness"]=.5;report("material",mat,"roughness")}if(!("diffuse_fresnel"in mat)){mat["diffuse_fresnel"]=
.1;report("material",mat,"diffuse_fresnel")}if(!("diffuse_fresnel_factor"in mat)){mat["diffuse_fresnel_factor"]=.5;report("material",mat,"diffuse_fresnel_factor")}if(!("specular_slope"in mat)){mat["specular_slope"]=.2;report("material",mat,"specular_slope")}if(!("specular_toon_size"in mat)){mat["specular_toon_size"]=.5;report("material",mat,"specular_toon_size")}if(!("specular_toon_smooth"in mat)){mat["specular_toon_smooth"]=.1;report("material",mat,"specular_toon_smooth")}if(!("specular_alpha"in
mat)){mat["specular_alpha"]=1;report("material",mat,"specular_alpha")}if(!("b4w_wettable"in mat)){mat["b4w_wettable"]=false;report("material",mat,"b4w_wettable")}if(!("b4w_refractive"in mat)){mat["b4w_refractive"]=false;report("material",mat,"b4w_refractive")}if(!("b4w_refr_bump"in mat)){mat["b4w_refr_bump"]=0;report("material",mat,"b4w_refr_bump")}if(!("b4w_shallow_water_col"in mat)){mat["b4w_shallow_water_col"]=[0,.8,.3];report("material",mat,"b4w_shallow_water_col")}if(!("b4w_shore_water_col"in
mat)){mat["b4w_shore_water_col"]=[0,.9,.2];report("material",mat,"b4w_shore_water_col")}if(!("b4w_shallow_water_col_fac"in mat)){mat["b4w_shallow_water_col_fac"]=1;report("material",mat,"b4w_shallow_water_col_fac")}if(!("b4w_shore_water_col_fac"in mat)){mat["b4w_shore_water_col_fac"]=.5;report("material",mat,"b4w_shore_water_col_fac")}if(!("b4w_water_sss_strength"in mat)){mat["b4w_water_sss_strength"]=5.9;report("material",mat,"b4w_water_sss_strength")}if(!("b4w_water_sss_width"in mat)){mat["b4w_water_sss_width"]=
.45;report("material",mat,"b4w_water_sss_width")}if(!("b4w_render_above_all"in mat)){mat["b4w_render_above_all"]=false;report("material",mat,"b4w_render_above_all")}if(!("b4w_water_norm_uv_velocity"in mat)){mat["b4w_water_norm_uv_velocity"]=.05;report("material",mat,"b4w_water_norm_uv_velocity")}if(!("specular_ior"in mat)){mat["specular_ior"]=1;report("material",mat,"specular_ior")}if(!("darkness"in mat)){mat["darkness"]=0;report("material",mat,"darkness")}if(!("diffuse_toon_size"in mat)){mat["diffuse_toon_size"]=
0;report("material",mat,"diffuse_toon_size")}if(!("diffuse_toon_smooth"in mat)){mat["diffuse_toon_smooth"]=0;report("material",mat,"diffuse_toon_smooth")}var texture_slots=mat["texture_slots"];for(var j=0;j<texture_slots.length;j++){var slot=texture_slots[j];if(!("blend_type"in slot)){slot["blend_type"]="MIX";report("texture_slot",slot,"blend_type")}}if(mat["node_tree"]){var nodes=mat["node_tree"]["nodes"];for(var j=0;j<nodes.length;j++)reform_node(nodes[j]);if(mat["node_tree"]["animation_data"])check_strip_props(mat["node_tree"]["animation_data"])}}var node_groups=
bpy_data["node_groups"];for(var i=0;i<node_groups.length;i++){var nodes=node_groups[i]["node_tree"]["nodes"];for(var j=0;j<nodes.length;j++)reform_node(nodes[j])}var objects=bpy_data["objects"];for(var i=0;i<objects.length;i++){var bpy_obj=objects[i];switch(bpy_obj["type"]){case "MESH":if(!("b4w_dynamic_geometry"in bpy_obj))bpy_obj["b4w_dynamic_geometry"]=false;if(!("b4w_reflexible"in bpy_obj))bpy_obj["b4w_reflexible"]=false;if(!("b4w_reflexible_only"in bpy_obj))bpy_obj["b4w_reflexible_only"]=false;
if(!("b4w_reflective"in bpy_obj))bpy_obj["b4w_reflective"]=false;if(!("b4w_reflection_type"in bpy_obj)){bpy_obj["b4w_reflection_type"]="PLANE";report("object",bpy_obj,"b4w_reflection_type")}if(!("b4w_wind_bending"in bpy_obj)){bpy_obj["b4w_wind_bending"]=false;report("object",bpy_obj,"b4w_wind_bending")}if(!("b4w_wind_bending_angle"in bpy_obj)){bpy_obj["b4w_wind_bending_angle"]=10;bpy_obj["b4w_wind_bending_freq"]=.25;report("object",bpy_obj,"wind bending params")}if(!("b4w_detail_bending_amp"in bpy_obj)){bpy_obj["b4w_detail_bending_amp"]=
.1;bpy_obj["b4w_branch_bending_amp"]=.3;report("object",bpy_obj,"detail bending params")}if(!("b4w_detail_bending_freq"in bpy_obj)){bpy_obj["b4w_detail_bending_freq"]=1;report("object",bpy_obj,"b4w_detail_bending_freq")}if(!("b4w_main_bend_stiffness_col"in bpy_obj)){bpy_obj["b4w_main_bend_stiffness_col"]="";report("object",bpy_obj,"b4w_main_bend_stiffness_col")}if(!("b4w_detail_bend_colors"in bpy_obj)){bpy_obj["b4w_detail_bend_colors"]={"leaves_stiffness_col":"","leaves_phase_col":"","overall_stiffness_col":""};
report("object",bpy_obj,"b4w_detail_bend_colors")}if(!("b4w_caustics"in bpy_obj))bpy_obj["b4w_caustics"]=false;if("vertex_groups"in bpy_obj&&bpy_obj["vertex_groups"].length&&bpy_obj["data"]&&bpy_obj["data"]["vertex_groups"].length==0){bpy_obj["data"]["vertex_groups"]=bpy_obj["vertex_groups"];delete bpy_obj["vertex_groups"];report("object",bpy_obj,"vertex_groups")}if("b4w_vertex_anim"in bpy_obj&&bpy_obj["b4w_vertex_anim"].length&&bpy_obj["data"]&&bpy_obj["data"]["b4w_vertex_anim"].length==0){bpy_obj["data"]["b4w_vertex_anim"]=
bpy_obj["b4w_vertex_anim"];delete bpy_obj["b4w_vertex_anim"];report("object",bpy_obj,"b4w_vertex_anim")}if(!("b4w_do_not_render"in bpy_obj))bpy_obj["b4w_do_not_render"]=false;if(!("use_ghost"in bpy_obj["game"]))bpy_obj["game"]["use_ghost"]=false;if(!("use_sleep"in bpy_obj["game"]))bpy_obj["game"]["use_sleep"]=false;if(!("velocity_min"in bpy_obj["game"]))bpy_obj["game"]["velocity_min"]=0;if(!("velocity_max"in bpy_obj["game"]))bpy_obj["game"]["velocity_max"]=0;if(!("collision_group"in bpy_obj["game"]))bpy_obj["game"]["collision_group"]=
1;if(!("collision_mask"in bpy_obj["game"]))bpy_obj["game"]["collision_mask"]=255;if("b4w_vehicle_settings"in bpy_obj){if(bpy_obj["b4w_vehicle_settings"]){if(!("steering_ratio"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["steering_ratio"]=10;if(!("steering_max"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["steering_max"]=1;if(!("inverse_control"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["inverse_control"]=false;if(!("force_max"in
bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["force_max"]=1500;if(!("brake_max"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["brake_max"]=100;if(!("speed_ratio"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["speed_ratio"]=.027;if(!("max_speed_angle"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["max_speed_angle"]=Math.PI;if(!("delta_tach_angle"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["delta_tach_angle"]=
4.43;if(!("suspension_compression"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["suspension_compression"]=4.4;if(!("suspension_stiffness"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["suspension_stiffness"]=20;if(!("suspension_damping"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["suspension_damping"]=2.3;if(!("wheel_friction"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["wheel_friction"]=1E3;if(!("roll_influence"in
bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["roll_influence"]=.1;if(!("max_suspension_travel_cm"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["max_suspension_travel_cm"]=30;if(!("floating_factor"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["floating_factor"]=3;if(!("floating_factor"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["floating_factor"]=3;if(!("water_lin_damp"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["water_lin_damp"]=
.9;if(!("water_rot_damp"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["water_rot_damp"]=.9}}else{bpy_obj["b4w_vehicle_settings"]=null;report("object",bpy_obj,"b4w_vehicle_settings")}if("b4w_floating_settings"in bpy_obj){if(bpy_obj["b4w_floating_settings"]){if(!("floating_factor"in bpy_obj["b4w_floating_settings"]))bpy_obj["b4w_floating_settings"]["floating_factor"]=3;if(!("water_lin_damp"in bpy_obj["b4w_floating_settings"]))bpy_obj["b4w_floating_settings"]["water_lin_damp"]=
.8;if(!("water_rot_damp"in bpy_obj["b4w_floating_settings"]))bpy_obj["b4w_floating_settings"]["water_rot_damp"]=.8}}else{bpy_obj["b4w_floating_settings"]=null;report("object",bpy_obj,"b4w_floating_settings")}if("b4w_character_settings"in bpy_obj){if(bpy_obj["b4w_character_settings"]){if(!("walk_speed"in bpy_obj["b4w_character_settings"]))bpy_obj["b4w_character_settings"]["walk_speed"]=4;if(!("run_speed"in bpy_obj["b4w_character_settings"]))bpy_obj["b4w_character_settings"]["run_speed"]=8;if(!("step_height"in
bpy_obj["b4w_character_settings"]))bpy_obj["b4w_character_settings"]["step_height"]=.25;if(!("jump_strength"in bpy_obj["b4w_character_settings"]))bpy_obj["b4w_character_settings"]["jump_strength"]=5;if(!("waterline"in bpy_obj["b4w_character_settings"]))bpy_obj["b4w_character_settings"]["waterline"]=0}}else{bpy_obj["b4w_character_settings"]=null;report("object",bpy_obj,"b4w_character_settings")}if(!("b4w_selectable"in bpy_obj)){bpy_obj["b4w_selectable"]=false;report("object",bpy_obj,"b4w_selectable")}if(!("b4w_outlining"in
bpy_obj)){bpy_obj["b4w_outlining"]=false;report("object",bpy_obj,"b4w_outlining")}if(!("b4w_outline_on_select"in bpy_obj)){bpy_obj["b4w_outline_on_select"]=false;report("object",bpy_obj,"b4w_outline_on_select")}if(!("b4w_billboard"in bpy_obj)){bpy_obj["b4w_billboard"]=false;report("object",bpy_obj,"b4w_billboard")}if(!("b4w_billboard_geometry"in bpy_obj)){bpy_obj["b4w_billboard_geometry"]="SPHERICAL";report("object",bpy_obj,"b4w_billboard_geometry")}if(!("b4w_pres_glob_orientation"in bpy_obj)){bpy_obj["b4w_pres_glob_orientation"]=
false;report("object",bpy_obj,"b4w_pres_glob_orientation")}if(!("b4w_outline_settings"in bpy_obj)){if("b4w_glow_settings"in bpy_obj)bpy_obj["b4w_outline_settings"]=bpy_obj["b4w_glow_settings"];else{bpy_obj["b4w_outline_settings"]={};bpy_obj["b4w_outline_settings"]["outline_duration"]=1;bpy_obj["b4w_outline_settings"]["outline_period"]=1;bpy_obj["b4w_outline_settings"]["outline_relapses"]=0}report("object",bpy_obj,"b4w_outline_settings")}if(!("b4w_lod_transition"in bpy_obj)){bpy_obj["b4w_lod_transition"]=
.01;report("object",bpy_obj,"b4w_lod_transition")}if(!("lod_levels"in bpy_obj)){bpy_obj["lod_levels"]=[];report("object",bpy_obj,"lod_levels")}if(!("b4w_animation_mixing"in bpy_obj)){bpy_obj["b4w_animation_mixing"]=false;report("object",bpy_obj,"b4w_animation_mixing")}break;case "EMPTY":if(!("b4w_anchor"in bpy_obj)){bpy_obj["b4w_anchor"]=null;report("object",bpy_obj,"b4w_anchor")}if(bpy_obj["b4w_anchor"]&&!("max_width"in bpy_obj["b4w_anchor"]))bpy_obj["b4w_anchor"]["max_width"]=250;break;default:break}if(!("collision_margin"in
bpy_obj["game"])){bpy_obj["game"]["collision_margin"]=.04;report("object",bpy_obj,"collision_margin")}if(!("b4w_anim_behavior"in bpy_obj)){bpy_obj["b4w_anim_behavior"]=bpy_obj["b4w_cyclic_animation"]?"CYCLIC":"FINISH_STOP";report("object",bpy_obj,"b4w_anim_behavior")}if(!("rotation_quaternion"in bpy_obj)){var quat=[0,0,0,1];m_util.euler_to_quat(bpy_obj["rotation_euler"],quat);quat_b4w_bpy(quat,quat);bpy_obj["rotation_quaternion"]=quat;report("object",bpy_obj,"rotation_quaternion")}if("webgl_do_not_batch"in
bpy_obj){bpy_obj["b4w_do_not_batch"]=bpy_obj["webgl_do_not_batch"];if(bpy_obj["webgl_do_not_batch"])report_deprecated("object",bpy_obj,"webgl_do_not_batch")}if(!("b4w_shadow_cast_only"in bpy_obj)){bpy_obj["b4w_shadow_cast_only"]=false;report("object",bpy_obj,"b4w_shadow_cast_only")}if(!("b4w_correct_bounding_offset"in bpy_obj)){bpy_obj["b4w_correct_bounding_offset"]="AUTO";report("object",bpy_obj,"b4w_correct_bounding_offset")}var psystems=bpy_obj["particle_systems"];for(var j=0;j<psystems.length;j++){var psys=
psystems[j];var pset=psys["settings"];if(!("use_rotation_dupli"in pset)){pset["use_rotation_dupli"]=false;report("object",pset,"use_rotation_dupli")}if(!("use_whole_group"in pset)){pset["use_whole_group"]=false;report("object",pset,"use_whole_group")}if(!psys["transforms"]){psys["transforms"]=new Float32Array;report("particle_system",psys,"transforms")}if(!("b4w_billboard_align"in pset)){pset["b4w_billboard_align"]="VIEW";report("particle_settings",pset,"b4w_billboard_align")}if(!("b4w_dynamic_grass"in
pset)){pset["b4w_dynamic_grass"]=false;report("object",pset,"b4w_dynamic_grass")}if(!("b4w_dynamic_grass_scale_threshold"in pset)){pset["b4w_dynamic_grass_scale_threshold"]=.01;report("object",pset,"b4w_dynamic_grass_scale_threshold")}if(!("b4w_initial_rand_rotation"in pset)){pset["b4w_initial_rand_rotation"]=false;report("particle_settings",pset,"b4w_initial_rand_rotation")}if(!("b4w_rotation_type"in pset)){pset["b4w_rotation_type"]="Z";report("particle_settings",pset,"b4w_rotation_type")}if(!("b4w_rand_rotation_strength"in
pset)){pset["b4w_rand_rotation_strength"]=1;report("particle_settings",pset,"b4w_rand_rotation_strength")}if(!("b4w_hair_billboard"in pset)){pset["b4w_hair_billboard"]=false;report("particle_settings",pset,"b4w_hair_billboard")}if(!("b4w_hair_billboard_type"in pset)){pset["b4w_hair_billboard_type"]="BASIC";report("particle_settings",pset,"b4w_hair_billboard_type")}if(!("b4w_hair_billboard_jitter_amp"in pset)){pset["b4w_hair_billboard_jitter_amp"]=0;report("particle_settings",pset,"b4w_hair_billboard_jitter_amp")}if(!("b4w_hair_billboard_jitter_freq"in
pset)){pset["b4w_hair_billboard_jitter_freq"]=0;report("particle_settings",pset,"b4w_hair_billboard_jitter_freq")}if(!("b4w_hair_billboard_geometry"in pset)){pset["b4w_hair_billboard_geometry"]="SPHERICAL";report("particle_settings",pset,"b4w_hair_billboard_geometry")}if(!("b4w_wind_bend_inheritance"in pset)){pset["b4w_wind_bend_inheritance"]="PARENT";report("particle_settings",pset,"b4w_wind_bend_inheritance")}if(!("b4w_shadow_inheritance"in pset)){pset["b4w_shadow_inheritance"]="PARENT";report("particle_settings",
pset,"b4w_shadow_inheritance")}if(!("b4w_reflection_inheritance"in pset)){pset["b4w_reflection_inheritance"]="PARENT";report("particle_settings",pset,"b4w_reflection_inheritance")}if(!("b4w_vcol_from_name"in pset)){pset["b4w_vcol_from_name"]="";report("particle_settings",pset,"b4w_vcol_from_name")}if(!("b4w_vcol_to_name"in pset)){pset["b4w_vcol_to_name"]="";report("particle_settings",pset,"b4w_vcol_to_name")}if(!("b4w_coordinate_system"in pset)){pset["b4w_coordinate_system"]="LOCAL";report("particle_settings",
pset,"b4w_coordinate_system")}if(!("b4w_allow_nla"in pset)){pset["b4w_allow_nla"]=true;report("particle_settings",pset,"b4w_allow_nla")}if(!("b4w_enable_soft_particles"in pset)){pset["b4w_enable_soft_particles"]=false;report("particle_settings",pset,"b4w_enable_soft_particles")}if(!("b4w_particles_softness"in pset)){pset["b4w_particles_softness"]=1;report("particle_settings",pset,"b4w_particles_softness")}}if(!("constraints"in bpy_obj)){bpy_obj["constraints"]=[];report("object",bpy_obj,"constraints")}var mods=
bpy_obj["modifiers"];for(var j=0;j<mods.length;j++)if(!check_modifier(mods[j],bpy_obj)){mods.splice(j,1);j--}if(!("animation_data"in bpy_obj)){bpy_obj["animation_data"]={"action":null,"nla_tracks":[]};report("object",bpy_obj,"animation_data")}if(bpy_obj["animation_data"]){if(!("action"in bpy_obj["animation_data"])){bpy_obj["animation_data"]["action"]=null;report_raw("no action in animation data "+bpy_obj["name"])}if(!("nla_tracks"in bpy_obj["animation_data"])){bpy_obj["animation_data"]["nla_tracks"]=
[];report_raw("no NLA in animation data "+bpy_obj["name"])}check_strip_props(bpy_obj["animation_data"])}if(!("b4w_collision_id"in bpy_obj)){bpy_obj["b4w_collision_id"]="";report("material",bpy_obj,"b4w_collision_id")}if(check_negative_scale(bpy_obj)){report_raw("negative scale for object "+bpy_obj["name"]+", using positive scale instead");bpy_obj["scale"][0]=Math.abs(bpy_obj["scale"][0]);bpy_obj["scale"][1]=Math.abs(bpy_obj["scale"][1]);bpy_obj["scale"][2]=Math.abs(bpy_obj["scale"][2])}if(!check_uniform_scale(bpy_obj))report_raw("non-uniform scale for object "+
bpy_obj["name"])}if(_unreported_compat_issues)m_print.error("Compatibility issues detected");for(var param in _params_reported){var param_data=_params_reported[param];var param_name=param.match(/.*?(?=>>|$)/i)[0];m_print.warn('Property "'+String(param_name)+'" is '+param_data.report_type+' for "'+param_data.type+'". To fix this, reexport '+bpy_data["b4w_filepath_blend"])}};function check_strip_props(animation_data){var nla_tracks=animation_data["nla_tracks"];if(nla_tracks)for(var j=0;j<nla_tracks.length;j++){var track=
nla_tracks[j];for(var k=0;k<track["strips"].length;k++){var strip=track["strips"][k];if(!("action"in strip)){strip["action"]=null;report("strip",strip,"action")}if(!("action_frame_start"in strip)){strip["action_frame_start"]=0;report("strip",strip,"action_frame_start")}if(!("action_frame_end"in strip)){strip["action_frame_end"]=strip["frame_end"]-strip["frame_start"];report("strip",strip,"action_frame_end")}if(!("repeat"in strip)){strip["repeat"]=1;report("strip",strip,"repeat")}if(!("use_reverse"in
strip)){strip["use_reverse"]=false;report("strip",strip,"use_reverse")}if(!("scale"in strip)){strip["scale"]=1;report("strip",strip,"scale")}}}}function check_export_props(bpy_obj){var export_props=["b4w_apply_scale","b4w_apply_modifiers","b4w_export_edited_normals","b4w_loc_export_vertex_anim","b4w_shape_keys"];var prop_found=null;for(var i=0;i<export_props.length;i++)if(bpy_obj[export_props[i]])if(!prop_found)prop_found=export_props[i];else{bpy_obj[export_props[i]]=false;m_print.warn('WARNING property "'+
export_props[i]+'" of object "'+bpy_obj["name"]+'" has been set to "false". Foreground property "'+prop_found+'" already exists.')}}function quat_b4w_bpy(quat,dest){var x=quat[0];var y=quat[1];var z=quat[2];var w=quat[3];dest[0]=w;dest[1]=x;dest[2]=y;dest[3]=z;return dest}function report(type,bpy_datablock,missing_param){if(!REPORT_COMPATIBILITY_ISSUES){_unreported_compat_issues=true;return}var param_id=missing_param+">>"+type;if(!(param_id in _params_reported))_params_reported[param_id]={storage:[],
report_type:"undefined",type:type};_params_reported[param_id].storage.push(bpy_datablock["name"])}function report_missing_datablock(type,file_path_blend){if(!REPORT_COMPATIBILITY_ISSUES){_unreported_compat_issues=true;return}m_print.warn("WARNING "+"Datablock "+type+' is missing, reexport "'+file_path_blend+'" scene')}function report_deprecated(type,bpy_datablock,deprecated_param){if(!REPORT_COMPATIBILITY_ISSUES){_unreported_compat_issues=true;return}var param_id=deprecated_param+">>"+type;if(!(param_id in
_params_reported))_params_reported[param_id]={storage:[],report_type:"deprecated",type:type};_params_reported[param_id].storage.push(bpy_datablock["name"])}function report_modifier(type,bpy_obj,file_path_blend){if(!REPORT_COMPATIBILITY_ISSUES){_unreported_compat_issues=true;return}m_print.error("WARNING "+"Incomplete modifier "+String(type)+" for "+'"'+bpy_obj["name"]+'"'+', reexport "'+file_path_blend+'" scene')}function report_raw(msg){if(!REPORT_COMPATIBILITY_ISSUES){_unreported_compat_issues=
true;return}m_print.warn(msg)}function check_uniform_scale(bpy_obj){var scale=bpy_obj["scale"];var eps=.005;if(scale[0]==0&&scale[1]==0&&scale[2]==0)return true;var delta1=Math.abs((scale[0]-scale[1])/scale[0]);var delta2=Math.abs((scale[1]-scale[2])/scale[1]);return delta1<eps&&delta2<eps}function check_negative_scale(bpy_obj){return bpy_obj["scale"][0]<0||bpy_obj["scale"][1]<0||bpy_obj["scale"][2]<0}exports.check_anim_fcurve_completeness=function(fcurve,action){if(!("num_channels"in fcurve)){fcurve["num_channels"]=
1;report_raw('B4W Warning: no channels number in animation fcurve for "'+action["name"]+'" action, reexport scene')}};exports.apply_mesh_modifiers=function(bpy_obj){if(!has_modifiers(bpy_obj))return null;var mesh=mesh_copy(bpy_obj["data"],bpy_obj["data"]["name"]+"_MOD");var modifiers=bpy_obj["modifiers"];for(var i=0;i<modifiers.length;i++){var mod=modifiers[i];switch(mod["type"]){case "ARRAY":apply_array_modifier(mesh,mod);break;case "CURVE":apply_curve_modifier(mesh,mod);break;default:break}m_bounds.recalculate_mesh_boundings(mesh)}return mesh};
function has_modifiers(bpy_obj){var modifiers=bpy_obj["modifiers"];for(var i=0;i<modifiers.length;i++){var mod=modifiers[i];var type=mod["type"];if(type=="ARRAY"||type=="CURVE")return true}return false}function apply_array_modifier(mesh,mod){var dx=0;var dy=0;var dz=0;var trans_matrix=new Float32Array(16);var new_meshes=[];for(var i=1;i<mod["count"];i++){if(mod["use_constant_offset"]){dx+=mod["constant_offset_displace"][0];dy+=mod["constant_offset_displace"][1];dz+=mod["constant_offset_displace"][2]}if(mod["use_relative_offset"]){var bb=
mesh["b4w_bounding_box"];dx+=(bb["max_x"]-bb["min_x"])*mod["relative_offset_displace"][0];dy+=(bb["max_y"]-bb["min_y"])*mod["relative_offset_displace"][1];dz+=(bb["max_z"]-bb["min_z"])*mod["relative_offset_displace"][2]}m_util.trans_matrix(dx,dy,dz,trans_matrix);var mc=mesh_copy(mesh);mesh_transform_locations(mc,trans_matrix);new_meshes.push(mc)}for(var i=0;i<new_meshes.length;i++)mesh_join(mesh,new_meshes[i])}function apply_curve_modifier(mesh,mod){var bpy_obj=mod["object"];var spline=m_curve.create_spline(bpy_obj);
var matrix=new Float32Array(16);var ncoords=spline.is_3d?4:3;var point=new Float32Array(ncoords);var deriv=new Float32Array(ncoords);var trans=new Float32Array(3);var quat=new Float32Array(4);var qtilt=new Float32Array(4);var tangent_a=new Float32Array(3);var tangent_b=new Float32Array(3);var loc=new Float32Array(3);var nor=new Float32Array(4);var tan=new Float32Array(4);for(var i=0;i<mesh["submeshes"].length;i++){var submesh=mesh["submeshes"][i];var position=submesh["position"];var normal=submesh["normal"];
var tangent=submesh["tangent"];var deform_index=deform_axis_index(mod["deform_axis"]);tangent_a[0]=0;tangent_a[1]=0;tangent_a[2]=0;tangent_a[deform_index]=1;var slen=m_curve.spline_length(spline);for(var j=0;j<position.length/3;j++){loc[0]=position[3*j];loc[1]=position[3*j+1];loc[2]=position[3*j+2];var loc_spline_len=loc[deform_index];var t=m_curve.spline_len_to_t(spline,loc_spline_len);m_curve.spline_point(spline,t,point);trans[0]=point[0];trans[1]=point[1];trans[2]=point[2];m_curve.spline_derivative(spline,
t,deriv);tangent_b[0]=deriv[0];tangent_b[1]=0;tangent_b[2]=deriv[2];m_vec3.normalize(tangent_b,tangent_b);m_quat.rotationTo(tangent_a,tangent_b,quat);if(loc_spline_len<0){point[0]=tangent_b[0];point[1]=tangent_b[1];point[2]=tangent_b[2];m_vec3.scale(point,loc_spline_len,point);m_vec3.add(trans,point,trans)}else if(loc_spline_len>slen){point[0]=tangent_b[0];point[1]=tangent_b[1];point[2]=tangent_b[2];m_vec3.scale(point,loc_spline_len-slen,point);m_vec3.add(trans,point,trans)}m_mat4.fromRotationTranslation(quat,
trans,matrix);if(spline.is_3d){var tilt=point[3];m_quat.setAxisAngle(tangent_a,tilt,qtilt);m_vec3.transformQuat(loc,qtilt,loc)}loc[deform_index]=0;m_vec3.transformMat4(loc,matrix,loc);position[3*j]=loc[0];position[3*j+1]=loc[1];position[3*j+2]=loc[2];if(normal.length){nor[0]=normal[3*j];nor[1]=normal[3*j+1];nor[2]=normal[3*j+2];nor[3]=0;m_vec4.transformMat4(nor,matrix,nor);normal[3*j]=nor[0];normal[3*j+1]=nor[1];normal[3*j+2]=nor[2]}if(tangent.length){tan[0]=tangent[3*j];tan[1]=tangent[3*j+1];tan[2]=
tangent[3*j+2];tan[3]=0;m_vec4.transformMat4(tan,matrix,tan);tangent[3*j]=tan[0];tangent[3*j+1]=tan[1];tangent[3*j+2]=tan[2]}}}}function deform_axis_index(deform_axis){switch(deform_axis){case "POS_X":case "NEG_X":return 0;case "POS_Y":case "NEG_Y":return 1;case "POS_Z":case "NEG_Z":return 2;default:throw"Wrong deform axis value "+deform_axis;}}function modify_mesh_points_interval(mesh,x_min,x_max,y_min,y_max,z_min,z_max,matrix){var locations=mesh["vertices"]["locations"];var loc=new Float32Array(3);
for(var i=0;i<locations.length/3;i++){var x=locations[3*i];var y=locations[3*i+1];var z=locations[3*i+2];if((x_max-x_min==0||x>=x_min&&x<x_max)&&(y_max-y_min==0||y>=y_min&&y<y_max)&&(z_max-z_min==0||z>=z_min&&z<z_max)){loc[0]=x;loc[1]=y;loc[2]=z;m_vec3.transformMat4(loc,matrix,loc);locations[3*i]=loc[0];locations[3*i+1]=loc[1];locations[3*i+2]=loc[2]}}}exports.create_material=function(name){var mat={"name":name,"use_nodes":false,"diffuse_shader":"LAMBERT","diffuse_color":[.8,.8,.8],"diffuse_intensity":1,
"alpha":1,"raytrace_transparency":{"fresnel":0,"fresnel_factor":1.25},"raytrace_mirror":{"reflect_factor":0,"fresnel":0,"fresnel_factor":1.25},"specular_color":[1,1,1],"specular_intensity":.5,"specular_shader":"COOKTORR","specular_hardness":50,"specular_slope":.2,"emit":0,"ambient":1,"use_vertex_color_paint":false,"b4w_water":false,"b4w_water_shore_smoothing":false,"b4w_water_dynamic":false,"b4w_generated_mesh":false,"b4w_waves_height":1,"b4w_water_fog_color":[.5,.5,.5],"b4w_water_fog_density":.06,
"b4w_water_num_cascads":5,"b4w_water_subdivs":64,"b4w_water_detailed_dist":1E3,"b4w_terrain":false,"b4w_collision":false,"b4w_collision_id":"","b4w_double_sided_lighting":false,"b4w_water_enable_caust":false,"b4w_water_caust_scale":.25,"b4w_water_caust_brightness":.5,"physics":{"friction":.5,"elasticity":0},"type":"SURFACE","use_transparency":false,"use_shadeless":false,"offset_z":0,"b4w_render_above_all":false,"game_settings":{"alpha_blend":"OPAQUE","use_backface_culling":true},"halo":{"size":.5,
"hardness":50,"b4w_halo_rings_color":[1,1,1],"b4w_halo_lines_color":[1,1,1],"b4w_halo_stars_blend_height":10,"b4w_halo_stars_min_height":0},"node_tree":null,"texture_slots":[]};return mat};function mesh_copy(mesh,new_name){if(!new_name)var new_name=mesh["name"]+"_COPY";var materials=mesh["materials"];var submeshes=mesh["submeshes"];mesh["materials"]=null;mesh["submeshes"]=null;var mesh_new=m_util.clone_object_json(mesh);mesh["materials"]=materials;mesh["submeshes"]=submeshes;mesh_new["name"]=new_name;
mesh_new["materials"]=mesh["materials"].slice(0);mesh_new["submeshes"]=[];for(var i=0;i<submeshes.length;i++){var submesh=submeshes[i];var submesh_new=m_util.clone_object_nr(submesh);mesh_new["submeshes"].push(submesh_new)}return mesh_new}function mesh_join(mesh,mesh2){for(var i=0;i<mesh["submeshes"].length;i++){var submesh=mesh["submeshes"][i];var submesh2=mesh2["submeshes"][i];var base_length=submesh["base_length"];var index_length=submesh["indices"].length;submesh["base_length"]+=submesh2["base_length"];
for(var prop in submesh){if(prop=="base_length")continue;if(prop=="indices"){submesh[prop]=m_util.uint32_concat(submesh[prop],submesh2[prop]);for(var j=index_length;j<submesh["indices"].length;j++)submesh["indices"][j]+=base_length}else if(prop=="vertex_colors");else submesh[prop]=m_util.float32_concat(submesh[prop],submesh2[prop])}}return mesh}function mesh_transform_locations(mesh,matrix){for(var i=0;i<mesh["submeshes"].length;i++){var submesh=mesh["submeshes"][i];m_util.positions_multiply_matrix(submesh["position"],
matrix,submesh["position"],0);m_util.vectors_multiply_matrix(submesh["normal"],matrix,submesh["normal"],0);m_util.tangents_multiply_matrix(submesh["tangent"],matrix,submesh["tangent"],0)}}exports.assign_logic_nodes_object_params=function(bpy_objects,scene){var script=scene["b4w_logic_nodes"];for(var i=0;i<script.length;i++){var subtree=script[i];for(var j=0;j<subtree.length;j++){var snode=subtree[j];var rename={"register1":"variable1","register2":"variable2","registerd":"variabled"};for(var key in rename)if(key in
snode)snode[rename[key]]=snode[key];switch(snode["type"]){case "SELECT":for(var k=0;k<bpy_objects.length;k++){var bpy_obj=bpy_objects[k];if(bpy_obj["name"]==snode["object"])bpy_obj["b4w_selectable"]=true}if(!snode["bools"])snode["bools"]={};if(!snode["bools"]["not_wait"])snode["bools"]["not_wait"]=false;break;case "SELECT_PLAY":report_raw('Logic nodes type "SELECT_PLAY" is deprecated, '+'node will be muted. To fix this, reexport scene "'+scene.name+'"');snode["object"].mute=true;break;case "SHOW":case "HIDE":case "PLAY_ANIM":case "SET_SHADER_NODE_PARAM":for(var k=
0;k<bpy_objects.length;k++){var bpy_obj=bpy_objects[k];if(bpy_obj["name"]==snode["object"])bpy_obj["b4w_do_not_batch"]=true}break}}}}};b4w.module["__scenegraph"]=function(exports,require){var m_cam=require("__camera");var m_cfg=require("__config");var m_debug=require("__debug");var m_graph=require("__graph");var m_obj_util=require("__obj_util");var m_render=require("__renderer");var m_tex=require("__textures");var m_util=require("__util");var cfg_dbg=m_cfg.debug_subs;var cfg_def=m_cfg.defaults;var cfg_out=m_cfg.outlining;var cfg_scs=m_cfg.scenes;var DEBUG_DISABLE_TEX_REUSE=false;function cam_copy(cam){var cam_new=m_obj_util.copy_object_props_by_value(cam);
cam_new.framebuffer=null;cam_new.color_attachment=null;cam_new.depth_attachment=null;return cam_new}function enforce_graph_consistency(graph,depth_tex){var slinks=[];m_graph.traverse_edges(graph,function(node1,node2,attr){var slink=attr;if(slinks.indexOf(slink)>-1)m_graph.replace_edge_attr(graph,node1,node2,slink,clone_slink(slink));else slinks.push(slink)});m_graph.traverse(graph,function(id,attr){var subs=attr;for(var i=0;i<subs.slinks_internal.length;i++){var slink=subs.slinks_internal[i];if(!depth_tex&&
(subs.type=="MAIN_PLANE_REFLECT"||subs.type=="MAIN_CUBE_REFLECT"||subs.type=="MAIN_XRAY"))slink.use_renderbuffer=true;if(slinks.indexOf(slink)>-1)subs.slinks_internal[i]=clone_slink(slink);else slinks.push(slink)}if(subs.type=="ANTIALIASING")m_graph.traverse_inputs(graph,id,function(id_in,attr_in,attr_edge){var subs_in=attr_in;if(subs_in.type=="MOTION_BLUR")for(var i=0;i<subs_in.slinks_internal.length;i++){var slink_mb_int=subs_in.slinks_internal[i];slink_mb_int.min_filter=m_tex.TF_LINEAR;slink_mb_int.mag_filter=
m_tex.TF_LINEAR}});if(!depth_tex)m_graph.traverse_inputs(graph,id,function(id_in,attr_in,attr_edge){var subs=attr_in;var slink=attr_edge;if(slink.from=="DEPTH")slink.use_renderbuffer=true})});m_graph.traverse(graph,function(id,attr){var subs=attr;var dest={};combine_same_slinks(graph,id,dest);for(var i in dest){var slinks=dest[i];var min_filt_slink=slinks[0];for(var j=0;j<slinks.length;j++)if(slinks[j].min_filter==m_tex.TF_LINEAR){min_filt_slink=slinks[j];break}var mag_filt_slink=slinks[0];for(var j=
0;j<slinks.length;j++)if(slinks[j].mag_filter==m_tex.TF_LINEAR){mag_filt_slink=slinks[j];break}var not_rb_slink=slinks[0];for(var j=0;j<slinks.length;j++)if(!slinks[j].use_renderbuffer){not_rb_slink=slinks[j];break}for(var j=0;j<slinks.length;j++){slinks[j].min_filter=min_filt_slink.min_filter;slinks[j].mag_filter=mag_filt_slink.mag_filter;slinks[j].use_renderbuffer=not_rb_slink.use_renderbuffer}}})}function combine_same_slinks(graph,id,dest){m_graph.traverse_inputs(graph,id,function(id_in,attr_in,
attr_edge){var slink=attr_edge;if(!slink.active)return;if(slink.from==slink.to){dest[slink.from]=dest[slink.from]||[];if(dest[slink.from].indexOf(slink)==-1)dest[slink.from].push(slink);combine_same_slinks(graph,id_in,dest)}});m_graph.traverse_outputs(graph,id,function(id_out,attr_out,attr_edge){var slink=attr_edge;if(!slink.active)return;dest[slink.from]=dest[slink.from]||[];if(dest[slink.from].indexOf(slink)==-1)dest[slink.from].push(slink)});var subs=m_graph.get_node_attr(graph,id);if(subs.type==
"MOTION_BLUR")for(var i=0;i<subs.slinks_internal.length;i++){var slink=subs.slinks_internal[i];dest[slink.from].push(slink)}}exports.check_slink_tex_conn=function(slink){switch(slink.to){case "COLOR":case "CUBEMAP":case "DEPTH":case "SCREEN":case "OFFSCREEN":case "NONE":return false;default:return true}};function clone_slink(slink){if(slink.texture)throw"Failed to clone slink with attached texture";return m_util.clone_object_json(slink)}function process_subscene_links(graph){var graph_sorted=m_graph.topsort(graph);
var tex_storage_all=[];m_graph.traverse(graph_sorted,function(id,attr){var subs=attr;switch(subs.type){case "MOTION_BLUR":case "SMAA_RESOLVE":case "SMAA_NEIGHBORHOOD_BLENDING":case "MAIN_PLANE_REFLECT":var tex_storage=[];break;default:var tex_storage=tex_storage_all;break}for(var i=0;i<subs.slinks_internal.length;i++){var slink=subs.slinks_internal[i];var tex=tex_aquire(tex_storage,slink,calc_slink_id(slink));slink.texture=tex;subs.textures_internal[i]=tex}for(var i=0;i<subs.textures_internal.length;i++){var tex=
subs.textures_internal[i];tex_dec_ref(tex_storage,tex)}switch(subs.type){case "MOTION_BLUR":case "SMAA_RESOLVE":case "SMAA_NEIGHBORHOOD_BLENDING":case "MAIN_PLANE_REFLECT":var tex_storage=[];break;default:break}m_graph.traverse_outputs(graph_sorted,id,function(id_out,attr_out,attr_edge){var slink=attr_edge;if(slink.texture)return;var tex=find_nearest_tex(graph_sorted,id,slink.from);if(tex&&slink.active&&!slink.texture){tex_inc_ref(tex_storage,tex);slink.texture=tex;return}var tex=tex_aquire(tex_storage,
slink,calc_slink_id(slink));slink.texture=tex});m_graph.traverse_inputs(graph_sorted,id,function(id_in,attr_in,attr_edge){var slink=attr_edge;var subs_in=attr_in;tex_dec_ref(tex_storage,slink.texture)});m_graph.traverse_outputs(graph_sorted,id,function(id_out,attr_out,attr_edge){var slink=attr_edge;if(slink.texture&&slink.to=="NONE")tex_dec_ref(tex_storage,slink.texture)})})}function apply_resolution_factor(graph){traverse_slinks(graph,function(slink,internal,subs1,subs2){if(slink.update_dim&&(has_lower_subs(graph,
subs1,"SMAA_NEIGHBORHOOD_BLENDING")&&subs1.type!="SMAA_NEIGHBORHOOD_BLENDING"||has_lower_subs(graph,subs1,"ANTIALIASING")||subs1.type=="ANCHOR_VISIBILITY"))slink.size_mult*=cfg_def.render_resolution_factor})}function calc_slink_id(slink){var id_obj=m_util.clone_object_json(slink);delete id_obj.to;delete id_obj.active;delete id_obj.texture;return JSON.stringify(id_obj)}function find_nearest_tex(graph,id,type){var tex=null;m_graph.traverse_inputs(graph,id,function(id_in,attr_in,attr_edge){var slink=
attr_edge;if(slink.active&&slink.from==slink.to&&slink.from==type&&slink.texture){tex=slink.texture;return true}});m_graph.traverse_outputs(graph,id,function(id_out,attr_out,attr_edge){var slink=attr_edge;if(slink.active&&slink.from==type&&slink.texture){tex=slink.texture;return true}});return tex}function tex_inc_ref(storage,tex){for(var i=0;i<storage.length;i++){var item=storage[i];if(item.tex===tex)item.ref++}}function tex_dec_ref(storage,tex){for(var i=0;i<storage.length;i++){var item=storage[i];
if(item.tex===tex&&item.ref)item.ref--}}function tex_aquire(storage,slink,slink_id){var storage_item_free=null;for(var i=0;i<storage.length;i++){var item=storage[i];if(item.id==slink_id&&item.ref===0){storage_item_free=item;break}}if(storage_item_free&&!(DEBUG_DISABLE_TEX_REUSE||cfg_def.macos_tex_reuse_hack)){storage_item_free.ref++;return storage_item_free.tex}else{var tex=tex_create_for_slink(slink);storage.push({id:slink_id,ref:1,tex:tex});return tex}}function tex_create_for_slink(slink){var size=
slink.size_mult*slink.size;switch(slink.from){case "COLOR":var tex=m_tex.create_texture("COLOR",m_tex.TT_RGBA_INT);m_tex.resize(tex,size,size);m_tex.set_filters(tex,slink.min_filter,slink.mag_filter);return tex;case "DEPTH":if(slink.use_renderbuffer){var tex=m_tex.create_texture("DEPTH_RBUF",m_tex.TT_RENDERBUFFER);m_tex.resize(tex,size,size)}else{var tex=m_tex.create_texture("DEPTH_TEX",m_tex.TT_DEPTH);m_tex.resize(tex,size,size);m_tex.set_filters(tex,slink.min_filter,slink.mag_filter)}return tex;
case "CUBEMAP":var tex=m_tex.create_cubemap_texture("CUBEMAP",size);return tex;case "SCREEN":return null;default:throw"Wrong slink param: "+slink.from;}}exports.traverse_slinks=traverse_slinks;function traverse_slinks(graph,callback){var exit=false;m_graph.traverse_edges(graph,function(node1,node2,attr){var slink=attr;if(!slink)return;var subs1=m_graph.get_node_attr(graph,node1);var subs2=m_graph.get_node_attr(graph,node2);if(callback(slink,false,subs1,subs2)){exit=true;return true}});if(exit)return;
m_graph.traverse(graph,function(node,attr){var subs=attr;for(var i=0;i<subs.slinks_internal.length;i++){var slink=subs.slinks_internal[i];if(callback(slink,true,subs,null))return true}})}function assign_render_targets(graph){m_graph.traverse(graph,function(id,attr){var subs=attr;if(subs.type=="SINK")return;var cam=subs.camera;m_graph.traverse_outputs(graph,id,function(id_out,attr_out,attr_edge){var slink=attr_edge;if(slink.active&&slink.texture){m_cam.set_attachment(cam,slink.from,slink.texture);
if(slink.from==slink.to&&attr_out.camera)m_cam.set_attachment(attr_out.camera,slink.from,slink.texture)}});for(var i=0;i<subs.slinks_internal.length;i++){var slink=subs.slinks_internal[i];if(slink.active&&slink.from==slink.to){var tex=subs.textures_internal[i];m_cam.set_attachment(cam,slink.from,tex)}}if((cam.color_attachment||cam.depth_attachment)&&!cam.framebuffer)cam.framebuffer=m_render.render_target_create(cam.color_attachment,cam.depth_attachment)})}exports.create_rendering_graph=function(sc_render,
cam_render,render_to_textures){var graph=m_graph.create();var prev_level=[];var curr_level=[];var glow_combine_subscenes=[];var slinks_main_color_o=[];var slinks_main_depth_o=[];var reflect_subscenes=[];var reflect_links=[];var refract_subscenes=[];var refract_links=[];var shadow_subscenes=[];var shadow_links=[];var cube_refl_subscenes=[];var cube_reflect_links=[];var num_lights=sc_render.lamps_number;var water_params=sc_render.water_params;var shore_smoothing=sc_render.shore_smoothing;var soft_particles=
sc_render.soft_particles;var ssao=sc_render.ssao;var god_rays=sc_render.god_rays;var mat_params=sc_render.materials_params;var refl_params=sc_render.reflection_params;var bloom_params=sc_render.bloom_params;var motion_blur=sc_render.motion_blur;var compositing=sc_render.compositing;var antialiasing=sc_render.antialiasing;var wls_params=sc_render.world_light_set;var wfs_params=sc_render.world_fog_set;var shadow_params=sc_render.shadow_params;var mb_params=sc_render.mb_params;var cc_params=sc_render.cc_params;
var gr_params=sc_render.god_rays_params;var outline_params=sc_render.outline_params;var dof=sc_render.dof;var depth_tex=sc_render.depth_tex;var refractions=sc_render.refractions;var rtt=Boolean(render_to_textures.length);var main_cams=[];if(sc_render.anaglyph_use&&!rtt){var cam_left=cam_render.cameras[0];var cam_right=cam_copy(cam_left);m_cam.make_stereo(cam_left,m_cam.TYPE_STEREO_LEFT);m_cam.make_stereo(cam_right,m_cam.TYPE_STEREO_RIGHT);main_cams.push(cam_left,cam_right);cam_render.cameras.push(cam_right)}else{var cam=
cam_render.cameras[0];main_cams.push(cam)}if(shadow_params){m_cam.update_camera_shadows(main_cams[0],shadow_params);var csm_num=shadow_params.csm_num;for(var i=0;i<csm_num;i++){var subs_shadow=create_subs_shadow_cast(i,shadow_params,num_lights);m_graph.append_node_attr(graph,subs_shadow);shadow_subscenes.push(subs_shadow);var tex_size=shadow_params.csm_resolution;var cam=subs_shadow.camera;cam.width=tex_size;cam.height=tex_size;subs_shadow.clear_color=false;shadow_links.push(create_slink("DEPTH",
"u_shadow_map"+i,tex_size,1,false));if(m_debug.check_depth_only_issue()||cfg_def.firefox_shadows_slink_hack)subs_shadow.slinks_internal.push(create_slink("COLOR","COLOR",tex_size,1,false))}}if(refl_params&&refl_params.num_cube_refl&&!rtt)for(var i=0;i<refl_params.num_cube_refl;i++){var cam=m_cam.create_camera(m_cam.TYPE_PERSP);cam.width=sc_render.cubemap_refl_size;cam.height=sc_render.cubemap_refl_size;m_cam.set_frustum(cam,90,.1,100);m_cam.set_projection(cam,cam.aspect);var subs_main=create_subs_main("CUBE_REFLECT",
cam,false,water_params,num_lights,wfs_params,wls_params,null,sc_render.sun_exist);subs_main.cube_view_matrices=m_util.generate_inv_cubemap_matrices();for(var j=0;j<6;j++)subs_main.cube_cam_frustums.push(m_cam.create_frustum_planes());m_graph.append_node_attr(graph,subs_main);var slink_refl_c=create_slink("CUBEMAP","u_cube_reflection",sc_render.cubemap_refl_size,1,false);slink_refl_c.min_filter=m_tex.TF_LINEAR;slink_refl_c.mag_filter=m_tex.TF_LINEAR;var slink_refl_d=create_slink("DEPTH","DEPTH",sc_render.cubemap_refl_size,
1,false);cube_reflect_links.push(slink_refl_c);subs_main.slinks_internal.push(slink_refl_d);cube_refl_subscenes.push(subs_main);refl_params.cube_refl_subs.push(subs_main)}if(refl_params&&refl_params.refl_plane_objs.length>0&&!rtt)for(var i=0;i<main_cams.length;i++)for(var j=0;j<refl_params.refl_plane_objs.length;j++){var cam=cam_copy(main_cams[i]);var refl_plane_obj=refl_params.refl_plane_objs[j];var trans=refl_plane_obj.render.trans;var quat=refl_plane_obj.render.quat;cam.reflection_plane=new Float32Array(4);
cam_render.cameras.push(cam);var subs_main=create_subs_main("PLANE_REFLECT",cam,false,water_params,num_lights,wfs_params,wls_params,null,sc_render.sun_exist);m_graph.append_node_attr(graph,subs_main);var slink_refl_c=create_slink("COLOR","u_plane_reflection",1,sc_render.plane_refl_size,true);slink_refl_c.min_filter=m_tex.TF_LINEAR;slink_refl_c.mag_filter=m_tex.TF_LINEAR;var slink_refl_d=create_slink("DEPTH","DEPTH",1,sc_render.plane_refl_size,true);reflect_links.push(slink_refl_c);subs_main.slinks_internal.push(slink_refl_d);
reflect_subscenes.push(subs_main);refl_params.plane_refl_subs.push(subs_main)}prev_level=[];curr_level=[];if(sc_render.dynamic_grass){var subs_grass_map=create_subs_grass_map();m_graph.append_node_attr(graph,subs_grass_map);var tex_size=cfg_scs.grass_tex_size;subs_grass_map.camera.width=tex_size;subs_grass_map.camera.height=tex_size;var slink_grass_map_d=create_slink("DEPTH","u_grass_map_depth",tex_size,1,false);slink_grass_map_d.min_filter=m_tex.TF_LINEAR;slink_grass_map_d.mag_filter=m_tex.TF_LINEAR;
var slink_grass_map_c=create_slink("COLOR","u_grass_map_color",tex_size,1,false);slink_grass_map_c.min_filter=m_tex.TF_LINEAR;slink_grass_map_c.mag_filter=m_tex.TF_LINEAR}else{var subs_grass_map=null;var slink_grass_map_d=null;var slink_grass_map_c=null}var blend_subscenes=[];var opaque_subscenes=[];var depth_subscenes=[];var xray_subscenes=[];for(var i=0;i<main_cams.length;i++){var cam=main_cams[i];var subs_depth={};var slink_depth_o=create_slink("DEPTH","DEPTH",1,1,true);slinks_main_depth_o.push(slink_depth_o);
if(depth_tex){var cam_depth=cam_copy(cam);cam_render.cameras.push(cam_depth);subs_depth=create_subs_depth_shadow(graph,cam_depth,num_lights);depth_subscenes.push(subs_depth);m_graph.append_node_attr(graph,subs_depth);if(shadow_params){subs_depth.self_shadow_normal_offset=shadow_params.self_shadow_normal_offset;for(var j=0;j<shadow_subscenes.length;j++){var subs_shadow=shadow_subscenes[j];var slink_shadow=shadow_links[j];m_graph.append_edge_attr(graph,subs_shadow,subs_depth,slink_shadow)}var slink_depth_c=
create_slink("COLOR","u_color",1,1,true);var slink_depth_d=create_slink("DEPTH","u_depth",1,1,true);if(ssao){var cam_ssao=cam_copy(cam);cam_render.cameras.push(cam_ssao);var ssao_params=sc_render.ssao_params;var subs_ssao=create_subs_ssao(cam_ssao,wfs_params,ssao_params);m_graph.append_node_attr(graph,subs_ssao);var slink_ssao=create_slink("COLOR","u_ssao_mask",1,1,true);m_graph.append_edge_attr(graph,subs_depth,subs_ssao,slink_depth_c);m_graph.append_edge_attr(graph,subs_depth,subs_ssao,slink_depth_d);
var cam_ssao_blur=cam_copy(cam);cam_render.cameras.push(cam_ssao_blur);var subs_ssao_blur=create_subs_ssao_blur(cam_ssao_blur,ssao_params);m_graph.append_node_attr(graph,subs_ssao_blur);var slink_ssao_blur=create_slink("COLOR","u_shadow_mask",1,1,true);m_graph.append_edge_attr(graph,subs_ssao,subs_ssao_blur,slink_ssao);m_graph.append_edge_attr(graph,subs_depth,subs_ssao_blur,slink_depth_d)}}else if(m_debug.check_depth_only_issue())subs_depth.slinks_internal.push(create_slink("COLOR","COLOR",1,1,true));
if(subs_grass_map){m_graph.append_edge_attr(graph,subs_grass_map,subs_depth,slink_grass_map_d);m_graph.append_edge_attr(graph,subs_grass_map,subs_depth,slink_grass_map_c)}}var subs_main=create_subs_main("OPAQUE",cam,!depth_tex,water_params,num_lights,wfs_params,wls_params,null,sc_render.sun_exist);m_graph.append_node_attr(graph,subs_main);curr_level.push(subs_main);opaque_subscenes.push(subs_main);if(depth_tex){m_graph.append_edge_attr(graph,subs_depth,subs_main,slinks_main_depth_o[i]);if(slink_ssao)m_graph.append_edge_attr(graph,
subs_ssao_blur,subs_main,slink_ssao_blur);else if(shadow_params)m_graph.append_edge_attr(graph,subs_depth,subs_main,create_slink("COLOR","u_shadow_mask",1,1,true))}var slink_main_c=create_slink("COLOR","u_color",1,1,true);var slink_main_o=create_slink("COLOR","COLOR",1,1,true);slinks_main_color_o.push(slink_main_o);if(subs_grass_map){m_graph.append_edge_attr(graph,subs_grass_map,subs_main,slink_grass_map_d);m_graph.append_edge_attr(graph,subs_grass_map,subs_main,slink_grass_map_c)}if(reflect_subscenes.length){var num_refl_subs=
reflect_subscenes.length/main_cams.length;for(var j=0;j<num_refl_subs;j++){var subs_id=num_refl_subs*i+j;m_graph.append_edge_attr(graph,reflect_subscenes[subs_id],subs_main,reflect_links[subs_id])}}if(cube_refl_subscenes.length)for(var j=0;j<cube_refl_subscenes.length;j++)m_graph.append_edge_attr(graph,cube_refl_subscenes[j],subs_main,cube_reflect_links[j])}prev_level=curr_level;curr_level=[];if(!rtt&&sc_render.color_picking){var cam=cam_copy(prev_level[0].camera);cam_render.cameras.push(cam);var subs_color_picking=
create_subs_color_picking(cam,false,num_lights);m_graph.append_node_attr(graph,subs_color_picking);if(sc_render.xray){var cam=cam_copy(prev_level[0].camera);cam_render.cameras.push(cam);var subs_color_picking_xray=create_subs_color_picking(cam,true,num_lights);m_graph.append_node_attr(graph,subs_color_picking_xray);var cp_slink_c=create_slink("COLOR","COLOR",1,1,true);m_graph.append_edge_attr(graph,subs_color_picking,subs_color_picking_xray,cp_slink_c);var cp_slink_d=create_slink("DEPTH","DEPTH",
1,1,true);m_graph.append_edge_attr(graph,subs_color_picking,subs_color_picking_xray,cp_slink_d)}}else var subs_color_picking=null;if(mat_params.refractions&&!rtt)for(var i=0;i<main_cams.length;i++){var subs_refr=create_subs_refract();m_graph.append_node_attr(graph,subs_refr);m_graph.append_edge_attr(graph,prev_level[i],subs_refr,slink_main_c);refract_subscenes.push(subs_refr);refract_links.push(create_slink("COLOR","u_refractmap",1,1,true))}var create_custom_sub_main=function(type,i){var cam=cam_copy(main_cams[i]);
cam_render.cameras.push(cam);var subs_main=create_subs_main(type,cam,false,water_params,num_lights,wfs_params,wls_params,shadow_params,sc_render.sun_exist);curr_level.push(subs_main);m_graph.append_node_attr(graph,subs_main);m_graph.append_edge_attr(graph,prev_level[i],subs_main,slinks_main_color_o[i]);if(type=="XRAY"){var slink_refl_d=create_slink("DEPTH","DEPTH",1,1,true);subs_main.slinks_internal.push(slink_refl_d)}else m_graph.append_edge_attr(graph,prev_level[i],subs_main,slinks_main_depth_o[i]);
if(subs_grass_map){m_graph.append_edge_attr(graph,subs_grass_map,subs_main,slink_grass_map_d);m_graph.append_edge_attr(graph,subs_grass_map,subs_main,slink_grass_map_c)}if(depth_tex){for(var j=0;j<shadow_subscenes.length;j++){var subs_shadow=shadow_subscenes[j];var slink_shadow=shadow_links[j];m_graph.append_edge_attr(graph,subs_shadow,subs_main,slink_shadow)}if(mat_params.refractions&&refractions||shore_smoothing||soft_particles){var subs_depth=depth_subscenes[i];var cam_depth_pack=cam_copy(subs_depth.camera);
cam_render.cameras.push(cam_depth_pack);var subs_depth_pack=create_subs_depth_pack(cam_depth_pack);m_graph.append_node_attr(graph,subs_depth_pack);var slink_depth_pack_in=create_slink("DEPTH","u_depth",1,1,true);var slink_depth_pack_out=create_slink("COLOR","u_scene_depth",1,1,true);slink_depth_pack_out.min_filter=m_tex.TF_NEAREST;slink_depth_pack_out.mag_filter=m_tex.TF_NEAREST;m_graph.append_edge_attr(graph,subs_depth,subs_depth_pack,slink_depth_pack_in);m_graph.append_edge_attr(graph,subs_depth_pack,
subs_main,slink_depth_pack_out)}}if(reflect_subscenes.length){var num_refl_subs=reflect_subscenes.length/main_cams.length;for(var j=0;j<num_refl_subs;j++){var subs_id=num_refl_subs*i+j;m_graph.append_edge_attr(graph,reflect_subscenes[subs_id],subs_main,reflect_links[subs_id])}}if(cube_refl_subscenes.length)for(var j=0;j<cube_refl_subscenes.length;j++)m_graph.append_edge_attr(graph,cube_refl_subscenes[j],subs_main,cube_reflect_links[j]);if(refract_subscenes.length)m_graph.append_edge_attr(graph,refract_subscenes[i],
subs_main,refract_links[i]);return subs_main};if(sc_render.glow_over_blend){for(var i=0;i<main_cams.length;i++){var subs_main=create_custom_sub_main("BLEND",i);blend_subscenes.push(subs_main)}prev_level=curr_level;curr_level=[]}if(sc_render.glow_materials){for(var i=0;i<main_cams.length;i++){var cam_glow=cam_copy(main_cams[i]);cam_render.cameras.push(cam_glow);var subs_main_glow=create_subs_main("GLOW",cam_glow,false,water_params,num_lights,wfs_params,wls_params);m_graph.append_node_attr(graph,subs_main_glow);
m_graph.append_edge_attr(graph,opaque_subscenes[i],subs_main_glow,slinks_main_depth_o[i]);var blur_x=create_subs_postprocessing("X_GLOW_BLUR");blur_x.subtype="GLOW_MASK_SMALL";set_texel_size_mult(blur_x,sc_render.glow_params.small_glow_mask_width);var slink_blur_x=create_slink("COLOR","u_color",1,1,true);slink_blur_x.min_filter=m_tex.TF_LINEAR;slink_blur_x.mag_filter=m_tex.TF_LINEAR;m_graph.append_node_attr(graph,blur_x);m_graph.append_edge_attr(graph,subs_main_glow,blur_x,slink_blur_x);var blur_y=
create_subs_postprocessing("Y_GLOW_BLUR");blur_y.subtype="GLOW_MASK_SMALL";set_texel_size_mult(blur_y,sc_render.glow_params.small_glow_mask_width);var slink_blur_y=create_slink("COLOR","u_color",1,.5,true);slink_blur_y.min_filter=m_tex.TF_LINEAR;slink_blur_y.mag_filter=m_tex.TF_LINEAR;m_graph.append_node_attr(graph,blur_y);m_graph.append_edge_attr(graph,blur_x,blur_y,slink_blur_y);var blur_x2=create_subs_postprocessing("X_GLOW_BLUR");blur_x2.subtype="GLOW_MASK_LARGE";set_texel_size_mult(blur_x2,sc_render.glow_params.large_glow_mask_width);
var slink_blur_x2=create_slink("COLOR","u_color",1,.5,true);slink_blur_x2.min_filter=m_tex.TF_LINEAR;slink_blur_x2.mag_filter=m_tex.TF_LINEAR;m_graph.append_node_attr(graph,blur_x2);m_graph.append_edge_attr(graph,blur_y,blur_x2,slink_blur_x2);var blur_y2=create_subs_postprocessing("Y_GLOW_BLUR");blur_y2.subtype="GLOW_MASK_LARGE";set_texel_size_mult(blur_y2,sc_render.glow_params.large_glow_mask_width);var slink_blur_y2=create_slink("COLOR","u_color",1,.25,true);slink_blur_y2.min_filter=m_tex.TF_LINEAR;
slink_blur_y2.mag_filter=m_tex.TF_LINEAR;m_graph.append_node_attr(graph,blur_y2);m_graph.append_edge_attr(graph,blur_x2,blur_y2,slink_blur_y2);var cam_glow_combine=cam_copy(main_cams[i]);cam_render.cameras.push(cam_glow_combine);var subs_glow_combine=create_subs_glow_combine(cam_glow_combine,sc_render);m_graph.append_node_attr(graph,subs_glow_combine);if(!sc_render.glow_over_blend)m_graph.append_edge_attr(graph,opaque_subscenes[i],subs_glow_combine,create_slink("COLOR","u_src_color",1,1,true));else m_graph.append_edge_attr(graph,
blend_subscenes[i],subs_glow_combine,create_slink("COLOR","u_src_color",1,1,true));var slink_c_y=create_slink("COLOR","u_glow_mask_small",1,.5,true);slink_c_y.min_filter=m_tex.TF_LINEAR;slink_c_y.mag_filter=m_tex.TF_LINEAR;m_graph.append_edge_attr(graph,blur_y,subs_glow_combine,slink_c_y);var slink_c_y2=create_slink("COLOR","u_glow_mask_large",1,.25,true);slink_c_y2.min_filter=m_tex.TF_LINEAR;slink_c_y2.mag_filter=m_tex.TF_LINEAR;m_graph.append_edge_attr(graph,blur_y2,subs_glow_combine,slink_c_y2);
glow_combine_subscenes.push(subs_glow_combine)}prev_level=glow_combine_subscenes;curr_level=[]}if(!sc_render.glow_over_blend){for(var i=0;i<main_cams.length;i++){var subs_main=create_custom_sub_main("BLEND",i);blend_subscenes.push(subs_main)}prev_level=curr_level;curr_level=[]}if(sc_render.xray){for(var i=0;i<main_cams.length;i++){var subs_xray=create_custom_sub_main("XRAY",i);xray_subscenes.push(subs_xray)}prev_level=curr_level;curr_level=[]}if(cfg_def.wireframe_debug){for(var i=0;i<main_cams.length;i++){var cam=
cam_copy(main_cams[i]);cam_render.cameras.push(cam);var subs_wireframe=create_subs_wireframe(cam);curr_level.push(subs_wireframe);m_graph.append_node_attr(graph,subs_wireframe);m_graph.append_edge_attr(graph,prev_level[i],subs_wireframe,slinks_main_color_o[i]);m_graph.append_edge_attr(graph,prev_level[i],subs_wireframe,slinks_main_depth_o[i]);if(subs_grass_map){m_graph.append_edge_attr(graph,subs_grass_map,subs_wireframe,slink_grass_map_d);m_graph.append_edge_attr(graph,subs_grass_map,subs_wireframe,
slink_grass_map_c)}}prev_level=curr_level;curr_level=[]}if(!rtt&&sc_render.anchor_visibility){var cam=cam_copy(main_cams[0]);cam_render.cameras.push(cam);var subs_anchor=create_subs_anchor_visibility(cam);m_graph.append_node_attr(graph,subs_anchor);m_graph.append_edge_attr(graph,prev_level[0],subs_anchor,slinks_main_depth_o[0])}if(god_rays&&depth_tex&&!rtt){for(var i=0;i<main_cams.length;i++){var max_ray_length=gr_params.max_ray_length;var intensity=gr_params.intensity;var steps_per_pass=gr_params.steps_per_pass;
var subs_prev=prev_level[i];var water=water_params?1:0;var slink_gr_d=create_slink("DEPTH","u_input",1,1,true);slink_gr_d.min_filter=m_tex.TF_LINEAR;slink_gr_d.mag_filter=m_tex.TF_LINEAR;var slink_gr_c=create_slink("COLOR","u_input",1,.25,true);slink_gr_c.min_filter=m_tex.TF_LINEAR;slink_gr_c.mag_filter=m_tex.TF_LINEAR;var step=max_ray_length/steps_per_pass;var cam_god_rays=cam_copy(main_cams[i]);cam_render.cameras.push(cam_god_rays);var subs_god_rays=create_subs_god_rays(cam_god_rays,water,max_ray_length,
true,step,num_lights,steps_per_pass);m_graph.append_node_attr(graph,subs_god_rays);m_graph.append_edge_attr(graph,subs_prev,subs_god_rays,slink_gr_d);step=max_ray_length/steps_per_pass*.5;var cam_blur1=cam_copy(main_cams[i]);cam_render.cameras.push(cam_blur1);var subs_gr_blur1=create_subs_god_rays(cam_blur1,water,max_ray_length,false,step,num_lights,steps_per_pass);m_graph.append_node_attr(graph,subs_gr_blur1);m_graph.append_edge_attr(graph,subs_god_rays,subs_gr_blur1,slink_gr_c);step=max_ray_length/
steps_per_pass*.25;var cam_blur2=cam_copy(main_cams[i]);cam_render.cameras.push(cam_blur2);var subs_gr_blur2=create_subs_god_rays(cam_blur2,water,max_ray_length,false,step,num_lights,steps_per_pass);m_graph.append_node_attr(graph,subs_gr_blur2);m_graph.append_edge_attr(graph,subs_gr_blur1,subs_gr_blur2,slink_gr_c);var subs_god_rays_comb=create_subs_god_rays_comb(intensity,num_lights);curr_level.push(subs_god_rays_comb);m_graph.append_node_attr(graph,subs_god_rays_comb);m_graph.append_edge_attr(graph,
subs_prev,subs_god_rays_comb,create_slink("COLOR","u_main",1,1,true));m_graph.append_edge_attr(graph,subs_gr_blur2,subs_god_rays_comb,create_slink("COLOR","u_god_rays",1,1,true))}prev_level=curr_level;curr_level=[]}if(bloom_params&&!rtt){for(var i=0;i<main_cams.length;i++){var subs_prev=prev_level[i];var subs_luminance=create_subs_luminance();m_graph.append_node_attr(graph,subs_luminance);m_graph.append_edge_attr(graph,subs_prev,subs_luminance,create_slink("COLOR","u_input",1,1,true));var subs_av_luminance=
create_subs_av_luminance();m_graph.append_node_attr(graph,subs_av_luminance);subs_av_luminance.camera.width=cfg_def.edge_min_tex_size_hack?2:1;subs_av_luminance.camera.height=cfg_def.edge_min_tex_size_hack?2:1;var slink_luminance_av=create_slink("COLOR","u_input",1,.25,true);slink_luminance_av.min_filter=m_tex.TF_LINEAR;slink_luminance_av.mag_filter=m_tex.TF_LINEAR;var slink_luminance_tr=create_slink("COLOR","u_luminance",1,.25,true);slink_luminance_tr.min_filter=m_tex.TF_LINEAR;slink_luminance_tr.mag_filter=
m_tex.TF_LINEAR;m_graph.append_edge_attr(graph,subs_luminance,subs_av_luminance,slink_luminance_av);var bloom_key=bloom_params.key;var edge_lum=bloom_params.edge_lum;var cam_luminance=cam_copy(main_cams[i]);cam_render.cameras.push(cam_luminance);var subs_lum_trunced=create_subs_luminance_trunced(bloom_key,edge_lum,num_lights,cam_luminance);m_graph.append_node_attr(graph,subs_lum_trunced);m_graph.append_edge_attr(graph,subs_prev,subs_lum_trunced,create_slink("COLOR","u_main",1,1,true));m_graph.append_edge_attr(graph,
subs_luminance,subs_lum_trunced,slink_luminance_tr);m_graph.append_edge_attr(graph,subs_av_luminance,subs_lum_trunced,create_slink("COLOR","u_average_lum",1,1,false));var slink_blur_in=create_slink("COLOR","u_color",1,.25,true);slink_blur_in.min_filter=m_tex.TF_LINEAR;slink_blur_in.mag_filter=m_tex.TF_LINEAR;var blur_x=create_subs_bloom_blur(graph,subs_luminance,"X_BLUR",true);m_graph.append_node_attr(graph,blur_x);m_graph.append_edge_attr(graph,subs_lum_trunced,blur_x,slink_blur_in);var blur_y=create_subs_bloom_blur(graph,
blur_x,"Y_BLUR",true);m_graph.append_node_attr(graph,blur_y);m_graph.append_edge_attr(graph,blur_x,blur_y,slink_blur_in);var bloom_blur=bloom_params.blur;var subs_bloom_combine=create_subs_bloom_combine(bloom_blur);m_graph.append_node_attr(graph,subs_bloom_combine);var slink_bloom=create_slink("COLOR","u_bloom",1,.25,true);slink_bloom.min_filter=m_tex.TF_LINEAR;slink_bloom.mag_filter=m_tex.TF_LINEAR;m_graph.append_edge_attr(graph,blur_y,subs_bloom_combine,slink_bloom);m_graph.append_edge_attr(graph,
subs_prev,subs_bloom_combine,create_slink("COLOR","u_main",1,1,true));curr_level.push(subs_bloom_combine)}prev_level=curr_level;curr_level=[]}if(motion_blur&&!rtt){for(var i=0;i<prev_level.length;i++){var subs_to_blur=prev_level[i];var subs_mb=create_subs_motion_blur(mb_params.mb_decay_threshold,mb_params.mb_factor);curr_level.push(subs_mb);m_graph.append_node_attr(graph,subs_mb);var slink_mb_in=create_slink("COLOR","u_mb_tex_curr",1,1,true);m_graph.append_edge_attr(graph,subs_to_blur,subs_mb,slink_mb_in);
var slink_mb_accum=create_slink("COLOR","u_mb_tex_accum",1,1,true);subs_mb.slinks_internal.push(slink_mb_accum)}prev_level=curr_level;curr_level=[]}if(dof&&depth_tex&&!rtt){for(var i=0;i<prev_level.length;i++){var subs_prev=prev_level[i];var cam_dof=cam_copy(main_cams[i]);cam_render.cameras.push(cam_dof);var slink_blur_in=create_slink("COLOR","u_color",1,1,true);slink_blur_in.min_filter=m_tex.TF_LINEAR;slink_blur_in.mag_filter=m_tex.TF_LINEAR;var pp_x=create_subs_postprocessing("X_BLUR");m_graph.append_node_attr(graph,
pp_x);m_graph.append_edge_attr(graph,subs_prev,pp_x,slink_blur_in);var pp_y=create_subs_postprocessing("Y_BLUR");m_graph.append_node_attr(graph,pp_y);m_graph.append_edge_attr(graph,pp_x,pp_y,slink_blur_in);var subs_depth=blend_subscenes[i];var subs_dof=create_subs_dof(cam_dof);cam_dof.dof_distance=cam_render.dof_distance;cam_dof.dof_object=cam_render.dof_object;cam_dof.dof_front=cam_render.dof_front;cam_dof.dof_rear=cam_render.dof_rear;cam_dof.dof_power=cam_render.dof_power;cam_dof.dof_on=1;curr_level.push(subs_dof);
m_graph.append_node_attr(graph,subs_dof);m_graph.append_edge_attr(graph,subs_prev,subs_dof,create_slink("COLOR","u_sharp",1,1,true));m_graph.append_edge_attr(graph,pp_y,subs_dof,create_slink("COLOR","u_blurred",1,1,true));m_graph.append_edge_attr(graph,subs_depth,subs_dof,create_slink("DEPTH","u_depth",1,1,true))}prev_level=curr_level;curr_level=[]}if(!rtt&&sc_render.outline){for(var i=0;i<main_cams.length;i++){var subs_prev=prev_level[i];var cam_outline=cam_copy(main_cams[i]);cam_render.cameras.push(cam_outline);
var subs_outline_mask=create_subs_outline_mask(cam_outline,num_lights);m_graph.append_node_attr(graph,subs_outline_mask);var pp_x_ext=create_subs_postprocessing("X_EXTEND");var slink_mask_pp=create_slink("COLOR","u_color",1,1,true);var slink_mask_gl=create_slink("COLOR","u_outline_mask",1,1,true);pp_x_ext.is_for_outline=true;m_graph.append_node_attr(graph,pp_x_ext);m_graph.append_edge_attr(graph,subs_outline_mask,pp_x_ext,slink_mask_pp);var slink_ext=create_slink("COLOR","u_color",1,.5,true);slink_ext.min_filter=
m_tex.TF_LINEAR;slink_ext.mag_filter=m_tex.TF_LINEAR;var pp_y_ext=create_subs_postprocessing("Y_EXTEND");pp_y_ext.is_for_outline=true;m_graph.append_node_attr(graph,pp_y_ext);m_graph.append_edge_attr(graph,pp_x_ext,pp_y_ext,slink_ext);var pp_x=create_subs_postprocessing("X_BLUR");pp_x.is_for_outline=true;m_graph.append_node_attr(graph,pp_x);m_graph.append_edge_attr(graph,pp_y_ext,pp_x,slink_ext);var slink_blur_blur=create_slink("COLOR","u_color",1,.25,true);slink_blur_blur.min_filter=m_tex.TF_LINEAR;
slink_blur_blur.mag_filter=m_tex.TF_LINEAR;var slink_blur_outline=create_slink("COLOR","u_outline_mask_blurred",1,.25,true);slink_blur_outline.min_filter=m_tex.TF_LINEAR;slink_blur_outline.mag_filter=m_tex.TF_LINEAR;var pp_y=create_subs_postprocessing("Y_BLUR");pp_y.is_for_outline=true;m_graph.append_node_attr(graph,pp_y);m_graph.append_edge_attr(graph,pp_x,pp_y,slink_blur_blur);var subs_outline=create_subs_outline(outline_params);m_graph.append_node_attr(graph,subs_outline);m_graph.append_edge_attr(graph,
subs_prev,subs_outline,create_slink("COLOR","u_outline_src",1,1,true));m_graph.append_edge_attr(graph,subs_outline_mask,subs_outline,slink_mask_gl);m_graph.append_edge_attr(graph,pp_y,subs_outline,slink_blur_outline);curr_level.push(subs_outline)}prev_level=curr_level;curr_level=[]}if(compositing&&!rtt){for(var i=0;i<prev_level.length;i++){var subs_prev=prev_level[i];var brightness=cc_params.brightness;var contrast=cc_params.contrast;var exposure=cc_params.exposure;var saturation=cc_params.saturation;
var subs_compositing=create_subs_compositing(brightness,contrast,exposure,saturation);m_graph.append_node_attr(graph,subs_compositing);m_graph.append_edge_attr(graph,subs_prev,subs_compositing,create_slink("COLOR","u_color",1,1,true));curr_level.push(subs_compositing)}prev_level=curr_level;curr_level=[]}if(antialiasing){for(var i=0;i<prev_level.length;i++){var subs_prev=prev_level[i];if(cfg_def.smaa){var slink_smaa_in=create_slink("COLOR","u_color",1,1,true);slink_smaa_in.min_filter=m_tex.TF_LINEAR;
slink_smaa_in.mag_filter=m_tex.TF_LINEAR;var subs_smaa_1=create_subs_smaa("SMAA_EDGE_DETECTION");m_graph.append_node_attr(graph,subs_smaa_1);m_graph.append_edge_attr(graph,subs_prev,subs_smaa_1,slink_smaa_in);var subs_smaa_2=create_subs_smaa("SMAA_BLENDING_WEIGHT_CALCULATION");m_graph.append_node_attr(graph,subs_smaa_2);m_graph.append_edge_attr(graph,subs_smaa_1,subs_smaa_2,slink_smaa_in);var slink_search_tex=create_slink("COLOR","u_search_tex",1,1,false);var slink_area_tex=create_slink("COLOR","u_area_tex",
1,1,false);slink_search_tex.min_filter=m_tex.TF_LINEAR;slink_search_tex.mag_filter=m_tex.TF_LINEAR;slink_area_tex.min_filter=m_tex.TF_LINEAR;slink_area_tex.mag_filter=m_tex.TF_LINEAR;subs_smaa_2.slinks_internal.push(slink_search_tex);subs_smaa_2.slinks_internal.push(slink_area_tex);var subs_smaa_3=create_subs_smaa("SMAA_NEIGHBORHOOD_BLENDING");m_graph.append_node_attr(graph,subs_smaa_3);m_graph.append_edge_attr(graph,subs_prev,subs_smaa_3,slink_smaa_in);var slink_smaa_blend=create_slink("COLOR","u_blend",
1,1,true);slink_smaa_blend.min_filter=m_tex.TF_LINEAR;slink_smaa_blend.mag_filter=m_tex.TF_LINEAR;m_graph.append_edge_attr(graph,subs_smaa_2,subs_smaa_3,slink_smaa_blend);curr_level.push(subs_smaa_3)}else{var subs_aa=create_subs_aa();m_graph.append_node_attr(graph,subs_aa);var slink_aa_in=create_slink("COLOR","u_color",1,1,true);slink_aa_in.min_filter=m_tex.TF_LINEAR;slink_aa_in.mag_filter=m_tex.TF_LINEAR;m_graph.append_edge_attr(graph,subs_prev,subs_aa,slink_aa_in);if(cfg_def.render_resolution_factor>
1){var subs_rescale=create_subs_postprocessing("NONE");m_graph.append_node_attr(graph,subs_rescale);m_graph.append_edge_attr(graph,subs_aa,subs_rescale,slink_aa_in);curr_level.push(subs_rescale)}else curr_level.push(subs_aa)}}prev_level=curr_level;curr_level=[]}if(sc_render.anaglyph_use&&!rtt){var subs_anaglyph=create_subs_anaglyph();m_graph.append_node_attr(graph,subs_anaglyph);m_graph.append_edge_attr(graph,prev_level[0],subs_anaglyph,create_slink("COLOR","u_sampler_left",1,1,true));m_graph.append_edge_attr(graph,
prev_level[1],subs_anaglyph,create_slink("COLOR","u_sampler_right",1,1,true));curr_level.push(subs_anaglyph)}else curr_level.push(prev_level[0]);var prev_id=m_graph.node_by_attr(graph,prev_level[0]);if(prev_level[0].type=="MOTION_BLUR")var need_subs_copy=true;else{var need_subs_copy=false;m_graph.traverse_inputs(graph,prev_id,function(id_in,attr_in,attr_edge){var slink_in=attr_edge;if(slink_in.from==slink_in.to){need_subs_copy=true;return true}})}if(need_subs_copy){var subs_copy=create_subs_copy();
m_graph.append_node_attr(graph,subs_copy);m_graph.append_edge_attr(graph,prev_level[0],subs_copy,create_slink("COLOR","u_color",1,1,true));prev_level=curr_level;curr_level=[];curr_level.push(subs_copy)}if(subs_color_picking)if(subs_color_picking_xray)curr_level.push(subs_color_picking_xray);else curr_level.push(subs_color_picking);if(subs_anchor)curr_level.push(subs_anchor);if(!rtt&&sc_render.sky_params.procedural_skydome){var sky_params=sc_render.sky_params;var subs_sky=create_subs_sky(num_lights,
sky_params);m_graph.append_node_attr(graph,subs_sky);curr_level.push(subs_sky)}var subs_sink=create_subs_sink();m_graph.append_node_attr(graph,subs_sink);for(var i=0;i<curr_level.length;i++){var subs=curr_level[i];switch(subs.type){case "COLOR_PICKING":case "COLOR_PICKING_XRAY":m_graph.append_edge_attr(graph,subs,subs_sink,create_slink("COLOR","NONE",1,1,true));m_graph.append_edge_attr(graph,subs,subs_sink,create_slink("DEPTH","NONE",1,1,true));break;case "SKY":var slink_sky=create_slink("CUBEMAP",
"u_sky",cfg_scs.cubemap_tex_size,1,false);m_graph.append_edge_attr(graph,subs,subs_sink,slink_sky);break;case "ANCHOR_VISIBILITY":var slink_anchor_color=create_slink("COLOR","NONE",1,1,true);m_graph.append_edge_attr(graph,subs,subs_sink,slink_anchor_color);break;default:if(rtt){var tex0=render_to_textures[0]._render;var slink_rtt=create_slink("COLOR","OFFSCREEN",1,1,true);slink_rtt.texture=tex0;m_graph.append_edge_attr(graph,curr_level[i],subs_sink,slink_rtt);for(var j=1;j<render_to_textures.length;j++){var tex=
render_to_textures[j]._render;var subs_copy=create_subs_copy();m_graph.append_node_attr(graph,subs_copy);var slink_to_rtt=create_slink("COLOR","u_color",1,1,true);m_graph.append_edge_attr(graph,curr_level[i],subs_copy,slink_to_rtt);var size_mult=tex.source_size/tex0.source_size;var slink_rtt=create_slink("COLOR","OFFSCREEN",1,size_mult,true);slink_rtt.texture=tex;m_graph.append_edge_attr(graph,subs_copy,subs_sink,slink_rtt)}}else m_graph.append_edge_attr(graph,curr_level[i],subs_sink,create_slink("SCREEN",
"NONE",1,1,true));break}}if(cfg_dbg.enabled){var subs_from=find_debug_subs(graph);if(subs_from)assign_debug_subscene(graph,subs_from)}enforce_graph_consistency(graph,depth_tex);if(cfg_def.render_resolution_factor>1)apply_resolution_factor(graph);process_subscene_links(graph);assign_render_targets(graph);if(shadow_params){for(var i=0;i<depth_subscenes.length;i++)prepare_shadow_receive_subs(graph,depth_subscenes[i]);for(var i=0;i<blend_subscenes.length;i++)prepare_shadow_receive_subs(graph,blend_subscenes[i]);
for(var i=0;i<xray_subscenes.length;i++)prepare_shadow_receive_subs(graph,xray_subscenes[i])}return graph};function find_debug_subs(graph){var subs_dbg=null;var subs_num=0;m_graph.traverse(graph,function(id,attr){if(attr.type==cfg_dbg.subs_type)if(subs_num==cfg_dbg.subs_number){subs_dbg=attr;return true}else subs_num++});return subs_dbg}function assign_debug_subscene(graph,subs_to_debug){var node_to_debug=m_graph.node_by_attr(graph,subs_to_debug);var subs_debug_view=create_subs_postprocessing("NONE");
var node_debug_view=m_graph.append_node_attr(graph,subs_debug_view);var node_sink=m_graph.get_sink_nodes(graph)[0];m_graph.traverse_edges(graph,function(edge_from,edge_to,edge_attr){if(edge_to==node_sink)m_graph.reconnect_edges(graph,edge_from,node_sink,edge_from,node_debug_view)});m_graph.traverse_edges(graph,function(edge_from,edge_to,edge_attr){if(edge_from==node_to_debug){m_graph.append_edge_attr(graph,subs_to_debug,subs_debug_view,create_slink(cfg_dbg.slink_type,"u_color",edge_attr.size,edge_attr.size_mult,
edge_attr.update_dim));return true}});m_graph.append_edge(graph,node_debug_view,node_sink,create_slink("SCREEN","NONE",.5,.5,true))}function add_light_attributes(subs,num_lights){subs.num_lights=num_lights;subs.light_directions=new Float32Array(num_lights*3);subs.light_positions=new Float32Array(num_lights*3);subs.light_color_intensities=new Float32Array(num_lights*3);var num_lfac=num_lights%2==0?num_lights*2:num_lights*2+2;subs.light_factors=new Float32Array(num_lfac)}function create_subs_shadow_cast(csm_index,
shadow_params,num_lights){var subs=init_subs("SHADOW_CAST");subs.csm_index=csm_index;subs.self_shadow_polygon_offset=shadow_params.self_shadow_polygon_offset;switch(shadow_params.lamp_type){case "SPOT":case "POINT":subs.camera=m_cam.create_camera(m_cam.TYPE_PERSP);var fov=shadow_params.spot_size*180/Math.PI;var near=.1;var far=2*shadow_params.distance;m_cam.set_frustum(subs.camera,fov,near,far);break;default:subs.camera=m_cam.create_camera(m_cam.TYPE_ORTHO_ASYMMETRIC)}add_light_attributes(subs,num_lights);
return subs}exports.init_subs=init_subs;function init_subs(type){var subs={type:type,subtype:"",do_render:false,enqueue:false,clear_color:false,clear_depth:false,depth_test:false,blend:false,pack:false,assign_texture:false,need_fog_update:false,need_perm_uniforms_update:false,debug_render_calls:0,time:0,camera:null,cube_view_matrices:null,cube_cam_frustums:[],bundles:[],slinks_internal:[],textures_internal:[],wind:new Float32Array(3),zsort_eye_last:new Float32Array(3),grass_map_dim:new Float32Array(3),
fog_color_density:new Float32Array(4),fog_params:new Float32Array(4),cube_fog:new Float32Array(16),sky_tex_default_value:0,environment_energy:0,num_lights:0,light_directions:null,light_positions:null,light_color_intensities:null,light_factors:null,horizon_color:new Float32Array(3),zenith_color:new Float32Array(3),sky_tex_fac:new Float32Array(4),sun_intensity:new Float32Array([0,0,0]),sun_direction:new Float32Array(3),sun_quaternion:new Float32Array(4),sky_tex_color:new Float32Array(3),outline_factor:0,
draw_outline_flag:0,is_for_outline:false,outline_color:new Float32Array(3),water:0,water_params:null,use_shoremap:false,shoremap_center:new Float32Array(2),shoremap_size:new Float32Array(2),shoremap_tex_size:0,max_shore_dist:0,cam_water_depth:0,water_fog_color_density:null,water_waves_height:0,water_waves_length:0,water_level:0,caustics:false,caust_scale:0,caust_speed:new Float32Array(2),caust_brightness:0,procedural_skydome:false,use_as_environment_lighting:false,mie_brightness:0,rayleigh_brightness:0,
spot_brightness:0,mie_strength:0,rayleigh_strength:0,scatter_strength:0,mie_collection_power:0,rayleigh_collection_power:0,mie_distribution:0,sky_color:new Float32Array(3),ssao_hemisphere:0,ssao_blur_depth:0,ssao_blur_discard_value:0,ssao_radius_increase:0,ssao_influence:0,ssao_dist_factor:0,ssao_samples:0,ssao_only:0,ssao_white:0,brightness:0,contrast:0,exposure:0,saturation:0,god_rays_intensity:0,max_ray_length:0,radial_blur_step:0,steps_per_pass:0,csm_index:0,self_shadow_polygon_offset:0,self_shadow_normal_offset:0,
v_light_matrix:null,b_light_matrix:null,p_light_matrix:null,bloom_key:0,bloom_blur:0,bloom_edge_lum:0,blur_texel_size_mult:0,ext_texel_size_mult:0,mb_decay_threshold:0,mb_factor:0,motion_blur_exp:0,pp_effect:"",jitter_projection_space:new Float32Array(2),small_glow_mask_width:0,large_glow_mask_width:0,small_glow_mask_coeff:0,large_glow_mask_coeff:0,texel_size_multiplier:0,texel_size:new Float32Array(2),texel_mask:new Float32Array(2)};subs.do_render=true;subs.enqueue=true;subs.clear_color=true;subs.clear_depth=
true;subs.depth_test=true;subs.need_perm_uniforms_update=true;subs.texel_size_multiplier=1;subs.texel_mask[0]=1;subs.texel_mask[1]=1;return subs}exports.set_texel_size=set_texel_size;function set_texel_size(subs,size_x,size_y){var mult=subs.texel_size_multiplier;subs.texel_size[0]=size_x*subs.texel_mask[0]*mult;subs.texel_size[1]=size_y*subs.texel_mask[1]*mult}exports.set_texel_size_mult=set_texel_size_mult;function set_texel_size_mult(subs,mult){subs.texel_size_multiplier=mult}function create_slink(from,
to,size,size_mult,update_dim){var slink={from:from,to:to,size:size,size_mult:size_mult,update_dim:update_dim,active:true,texture:null,use_renderbuffer:false,min_filter:m_tex.TF_NEAREST,mag_filter:m_tex.TF_NEAREST};return slink}function prepare_shadow_receive_subs(graph,subs){var csm_index=0;var subs_inputs=get_inputs(graph,subs);for(var i=0;i<subs_inputs.length;i++){var input=subs_inputs[i];if(input.type=="SHADOW_CAST"){var cam_cast=input.camera;subs.perspective_cast_far_bound=cam_cast.far/(cam_cast.far-
cam_cast.near);subs.v_light_matrix=cam_cast.view_matrix;subs.b_light_matrix=new Float32Array([.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1]);subs.p_light_matrix=subs.p_light_matrix||new Array;subs.p_light_matrix[csm_index]=cam_cast.proj_matrix;csm_index++}}}function create_subs_grass_map(){var subs=init_subs("GRASS_MAP");subs.camera=m_cam.create_camera(m_cam.TYPE_ORTHO_ASPECT);return subs}function create_subs_postprocessing(pp_effect){var pp_subs=init_subs("POSTPROCESSING");pp_subs.clear_color=false;pp_subs.clear_depth=
false;pp_subs.depth_test=false;pp_subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);pp_subs.pp_effect=pp_effect;switch(pp_effect){case "NONE":pp_subs.texel_mask[0]=1;pp_subs.texel_mask[1]=1;break;case "GRAYSCALE":pp_subs.texel_mask[0]=1;pp_subs.texel_mask[1]=1;break;case "X_BLUR":pp_subs.texel_mask[0]=1;pp_subs.texel_mask[1]=0;break;case "Y_BLUR":pp_subs.texel_mask[0]=0;pp_subs.texel_mask[1]=1;break;case "X_GLOW_BLUR":pp_subs.texel_mask[0]=1;pp_subs.texel_mask[1]=0;break;case "Y_GLOW_BLUR":pp_subs.texel_mask[0]=
0;pp_subs.texel_mask[1]=1;break;case "X_EXTEND":pp_subs.texel_mask[0]=1;pp_subs.texel_mask[1]=0;break;case "Y_EXTEND":pp_subs.texel_mask[0]=0;pp_subs.texel_mask[1]=1;break;default:throw"Wrong postprocessing effect: "+pp_effect;break}return pp_subs}function create_subs_bloom_blur(graph,subs_input,pp_effect){var subs=init_subs("BLOOM_BLUR");subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);subs.pp_effect=pp_effect;switch(pp_effect){case "X_BLUR":subs.texel_mask[0]=
1;subs.texel_mask[1]=0;break;case "Y_BLUR":subs.texel_mask[0]=0;subs.texel_mask[1]=1;break;default:throw"Wrong postprocessing effect for bloom blur: "+pp_effect;break}return subs}function create_subs_glow_combine(cam,sc_render){var subs=init_subs("GLOW_COMBINE");subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;subs.small_glow_mask_coeff=sc_render.glow_params.small_glow_mask_coeff;subs.large_glow_mask_coeff=sc_render.glow_params.large_glow_mask_coeff;subs.small_glow_mask_width=sc_render.glow_params.small_glow_mask_width;
subs.large_glow_mask_width=sc_render.glow_params.large_glow_mask_width;subs.camera=cam;return subs}function create_subs_main(main_type,cam,opaque_do_clear_depth,water_params,num_lights,wfs_params,wls_params,shadow_params,sun_exist){var subs=init_subs("MAIN_"+main_type);if(main_type==="OPAQUE"){subs.clear_color=true;subs.clear_depth=opaque_do_clear_depth;subs.blend=false}else if(main_type==="BLEND"){subs.clear_color=false;subs.clear_depth=false;subs.blend=true}else if(main_type==="XRAY"){subs.clear_color=
false;subs.clear_depth=true;subs.blend=true}else if(main_type==="PLANE_REFLECT"||main_type==="CUBE_REFLECT"){subs.clear_color=true;subs.clear_depth=true;subs.blend=false}else if(main_type==="GLOW"){subs.clear_color=true;subs.clear_depth=false;subs.blend=false}else throw"wrong main subscene type";if(subs.blend&&shadow_params)subs.self_shadow_normal_offset=shadow_params.self_shadow_normal_offset;subs.camera=cam;var sts=wls_params.sky_texture_param;if(sts){subs.sky_tex_fac.set([sts.blend_factor,sts.horizon_factor,
sts.zenith_up_factor,sts.zenith_down_factor]);subs.sky_tex_color.set(sts.color);subs.sky_tex_default_value=sts.default_value}subs.horizon_color.set(wls_params.horizon_color);subs.zenith_color.set(wls_params.zenith_color);subs.environment_energy=wls_params.environment_energy;subs.fog_color_density=wfs_params.fog_color_density;subs.fog_params=wfs_params.fog_params;if(water_params)assign_water_params(subs,water_params,sun_exist);add_light_attributes(subs,num_lights);return subs}function assign_water_params(subs,
water_params,sun_exist){subs.water_params=water_params;var wp=water_params;if(wp.fog_color_density)subs.water_fog_color_density=new Float32Array(wp.fog_color_density);subs.water_waves_height=wp.waves_height;subs.water_waves_length=wp.waves_length;subs.water_level=wp.water_level;if(wp.caustics&&sun_exist){subs.caustics=true;subs.caust_scale=wp.caustic_scale;subs.caust_speed.set(wp.caustic_speed);subs.caust_brightness=wp.caustic_brightness}if(wp.shoremap_image){subs.use_shoremap=true;var shore_boundings=
wp.shore_boundings;subs.shoremap_center[0]=(shore_boundings[0]+shore_boundings[1])/2;subs.shoremap_center[1]=(shore_boundings[2]+shore_boundings[3])/2;subs.shoremap_size[0]=shore_boundings[0]-shore_boundings[1];subs.shoremap_size[1]=shore_boundings[2]-shore_boundings[3];subs.shoremap_tex_size=wp.shoremap_tex_size;subs.max_shore_dist=wp.max_shore_dist}}function assign_inputs(graph,subs,inputs){for(var i=0;i<inputs.length;i++)m_graph.append_edge_attr(graph,inputs[i],subs)}function create_subs_color_picking(cam,
xray,num_lights){var subs=init_subs("COLOR_PICKING");if(xray){subs.type+="_XRAY";subs.clear_color=false;subs.clear_depth=true}subs.enqueue=false;subs.camera=cam;add_light_attributes(subs,num_lights);return subs}function create_subs_wireframe(cam){var subs=init_subs("WIREFRAME");subs.do_render=false;subs.clear_color=false;subs.clear_depth=false;subs.camera=cam;return subs}function create_subs_anchor_visibility(cam){var subs=init_subs("ANCHOR_VISIBILITY");subs.clear_color=true;subs.clear_depth=false;
subs.camera=cam;return subs}function create_subs_depth_shadow(graph,cam,num_lights){var subs=init_subs("DEPTH");subs.camera=cam;add_light_attributes(subs,num_lights);return subs}function create_subs_depth_pack(cam){var subs=init_subs("DEPTH_PACK");subs.clear_color=false;subs.clear_depth=false;subs.camera=cam;return subs}function create_subs_ssao(cam,wfs_params,ssao_params){var subs=init_subs("SSAO");subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;subs.camera=cam;subs.fog_color_density=
wfs_params.fog_color_density;subs.water_fog_color_density=new Float32Array(wfs_params.fog_color_density);subs.ssao_radius_increase=ssao_params.radius_increase;subs.ssao_hemisphere=ssao_params.hemisphere;subs.ssao_influence=ssao_params.influence;subs.ssao_dist_factor=ssao_params.dist_factor;subs.ssao_samples=ssao_params.samples;return subs}function create_subs_ssao_blur(cam,ssao_params){var subs=init_subs("SSAO_BLUR");subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;subs.camera=
cam;subs.ssao_blur_depth=ssao_params.blur_depth;subs.ssao_blur_discard_value=ssao_params.blur_discard_value;return subs}function create_subs_aa(){var subs=init_subs("ANTIALIASING");subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;subs.texel_size_multiplier=1/cfg_def.render_resolution_factor;subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);return subs}function create_subs_smaa(pass){var subs=init_subs(pass);if(pass=="SMAA_BLENDING_WEIGHT_CALCULATION"||pass=="SMAA_EDGE_DETECTION")subs.clear_color=
true;else subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;subs.texel_size_multiplier=1/cfg_def.render_resolution_factor;subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);if(pass=="SMAA_BLENDING_WEIGHT_CALCULATION")subs.jitter_subsample_ind=new Float32Array(4);return subs}function create_subs_compositing(brightness,contrast,exposure,saturation){var subs=init_subs("COMPOSITING");subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);
subs.brightness=brightness;subs.contrast=contrast;subs.exposure=exposure;subs.saturation=saturation;return subs}function create_subs_motion_blur(mb_decay_threshold,mb_factor){var mb_subs=init_subs("MOTION_BLUR");mb_subs.clear_color=false;mb_subs.clear_depth=false;mb_subs.depth_test=false;mb_subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);mb_subs.assign_texture=true;mb_subs.mb_decay_threshold=mb_decay_threshold;mb_subs.mb_factor=mb_factor;return mb_subs}function create_subs_dof(cam){var subs=init_subs("DOF");
subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;subs.camera=cam;subs.texel_size_multiplier=subs.camera.dof_power;return subs}function create_subs_outline_mask(cam,num_lights){var subs=init_subs("OUTLINE_MASK");subs.depth_test=false;subs.camera=cam;add_light_attributes(subs,num_lights);return subs}function create_subs_outline(outline_params){var subs=init_subs("OUTLINE");if(cfg_out.outlining_overview_mode)subs.outline_color.set(cfg_out.outline_color);else subs.outline_color.set(outline_params.outline_color);
subs.outline_factor=outline_params.outline_factor;subs.ext_texel_size_mult=5;subs.blur_texel_size_mult=3;subs.depth_test=false;subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);return subs}function create_subs_refract(){var subs=init_subs("REFRACT");subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);return subs}function create_subs_god_rays(cam,water,ray_length,pack,step,num_lights,steps_per_pass){var subs=init_subs("GOD_RAYS");subs.clear_color=
false;subs.clear_depth=false;subs.depth_test=false;subs.horizon_color=new Float32Array([1,1,1]);subs.zenith_color=new Float32Array([1,1,1]);subs.environment_energy=1;subs.pack=pack;subs.water=water;subs.radial_blur_step=step;subs.max_ray_length=ray_length;subs.steps_per_pass=steps_per_pass;subs.camera=cam;add_light_attributes(subs,num_lights);return subs}function create_subs_god_rays_comb(intensity,num_lights){var subs=init_subs("GOD_RAYS_COMBINE");subs.clear_color=false;subs.clear_depth=false;subs.depth_test=
false;subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);subs.god_rays_intensity=intensity;add_light_attributes(subs,num_lights);return subs}function create_subs_sky(num_lights,sky_params){var subs=init_subs("SKY");subs.enqueue=false;subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;var cam=m_cam.create_camera(m_cam.TYPE_NONE);cam.width=cfg_scs.cubemap_tex_size;cam.height=cfg_scs.cubemap_tex_size;subs.camera=cam;subs.cube_view_matrices=m_util.generate_cubemap_matrices();add_light_attributes(subs,
num_lights);subs.horizon_color=new Float32Array([1,1,1]);subs.zenith_color=new Float32Array([1,1,1]);subs.environment_energy=1;subs.sky_color.set(sky_params.sky_color);subs.procedural_skydome=sky_params.procedural_skydome;subs.use_as_environment_lighting=sky_params.use_as_environment_lighting;subs.rayleigh_brightness=sky_params.rayleigh_brightness;subs.mie_brightness=sky_params.mie_brightness;subs.spot_brightness=sky_params.spot_brightness;subs.scatter_strength=sky_params.scatter_strength;subs.rayleigh_strength=
sky_params.rayleigh_strength;subs.mie_strength=sky_params.mie_strength;subs.rayleigh_collection_power=sky_params.rayleigh_collection_power;subs.mie_collection_power=sky_params.mie_collection_power;subs.mie_distribution=sky_params.mie_distribution;return subs}function create_subs_copy(){var subs=init_subs("COPY");subs.clear_color=false;subs.clear_depth=false;subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);return subs}function create_subs_anaglyph(){var subs=init_subs("ANAGLYPH");subs.clear_color=
false;subs.clear_depth=false;subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);return subs}function create_subs_luminance(){var subs=init_subs("LUMINANCE");subs.clear_color=false;subs.clear_depth=false;subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);return subs}function create_subs_av_luminance(){var subs=init_subs("AVERAGE_LUMINANCE");subs.clear_color=false;subs.clear_depth=false;subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);return subs}function create_subs_luminance_trunced(bloom_key,edge_lum,
num_lights,cam){var subs=init_subs("LUMINANCE_TRUNCED");subs.clear_color=false;subs.clear_depth=false;subs.bloom_key=bloom_key;subs.bloom_edge_lum=edge_lum;subs.camera=cam;add_light_attributes(subs,num_lights);return subs}function create_subs_bloom_combine(blur){var subs=init_subs("BLOOM");subs.clear_color=false;subs.clear_depth=false;subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);subs.bloom_blur=blur;return subs}function create_subs_veloctity(cam){var subs=init_subs("VELOCITY");subs.clear_color=
false;subs.clear_depth=false;subs.camera=cam;return subs}function create_subs_sink(){var subs_sink=init_subs("SINK");subs_sink.enqueue=false;return subs_sink}exports.find_on_screen=function(graph){var subs=null;m_graph.traverse(graph,function(node,attr){if(attr.camera&&attr.camera.framebuffer===null){subs=attr;return true}return false});return subs};exports.find_input=function(graph,subs,type){var inputs=get_inputs(graph,subs);for(var i=0;i<inputs.length;i++)if(inputs[i].type===type)return inputs[i];
return null};exports.has_lower_subs=has_lower_subs;function has_lower_subs(graph,subs,type){if(subs.type===type)return true;var outputs=get_outputs(graph,subs);for(var i=0;i<outputs.length;i++)if(has_lower_subs(graph,outputs[i],type))return true;return false}exports.has_upper_subs=has_upper_subs;function has_upper_subs(graph,subs,type){if(subs.type===type)return true;var inputs=get_inputs(graph,subs);for(var i=0;i<inputs.length;i++)if(has_upper_subs(graph,inputs[i],type))return true;return false}
function find_upper_subs(graph,subs,type){if(subs.type===type)return subs;var inputs=get_inputs(graph,subs);for(var i=0;i<inputs.length;i++){var upper=find_upper_subs(graph,inputs[i],type);if(upper)return upper}return null}exports.get_inputs=get_inputs;function get_inputs(graph,subs){var node=m_graph.node_by_attr(graph,subs);if(node==m_graph.NULL_NODE)throw"Subscene not in graph";var inputs=[];var in_edge_count=m_graph.in_edge_count(graph,node);for(var i=0;i<in_edge_count;i++){var node_input=m_graph.get_in_edge(graph,
node,i);if(node_input!=node)inputs.push(m_graph.get_node_attr(graph,node_input))}return inputs}exports.get_outputs=get_outputs;function get_outputs(graph,subs){var node=m_graph.node_by_attr(graph,subs);if(node==m_graph.NULL_NODE)throw"Subscene not in graph";var outputs=[];var out_edge_count=m_graph.out_edge_count(graph,node);for(var i=0;i<out_edge_count;i++){var node_output=m_graph.get_out_edge(graph,node,i);if(node_output!=node)outputs.push(m_graph.get_node_attr(graph,node_output))}return outputs}
exports.find_subs=function(graph,type){var subs=null;m_graph.traverse(graph,function(node,attr){if(attr.type==type){subs=attr;return true}return false});return subs};exports.debug_convert_to_dot=function(graph){var PAPER_SIZE="11.7,16.5";var dot_str="digraph scenegraph {\n";dot_str+="    ";dot_str+='size="'+PAPER_SIZE+'";\n';dot_str+="    ";dot_str+='ratio="fill";\n';dot_str+="    ";dot_str+='node [shape=box margin="0.25,0.055"];\n';var tex_ids=debug_calc_tex_ids(graph);m_graph.traverse(graph,function(node,
attr){dot_str+="    ";dot_str+=dot_format_node(node,attr,tex_ids)});m_graph.traverse_edges(graph,function(node1,node2,attr){dot_str+="    ";dot_str+=dot_format_edge(node1,node2,attr,tex_ids)});dot_str+="}";return dot_str};function debug_calc_tex_ids(graph){var index_buf=[];var ids=[];traverse_slinks(graph,function(slink,internal,subs1,subs2){if(slink.texture){var num=index_buf.indexOf(slink.texture);if(num==-1){index_buf.push(slink.texture);ids.push(slink.texture,index_buf.length-1)}}});return ids}
function dot_format_node(node,subs,tex_ids){var cam=subs.camera;var label="";var label=subs.type.replace(/_/g," ");if(subs.type=="POSTPROCESSING")label+=" ("+subs.pp_effect.replace(/_/g," ")+")";if(subs.camera){label+="\\n";for(var i=0;i<tex_ids.length;i+=2)if(tex_ids[i]==subs.camera.color_attachment)label+="C"+tex_ids[i+1]+" ";for(var i=0;i<tex_ids.length;i+=2)if(tex_ids[i]==subs.camera.depth_attachment)label+="D"+tex_ids[i+1]}if(subs.slinks_internal.length)label+="\\n-----\\n";for(var i=0;i<subs.slinks_internal.length;i++)label+=
dot_format_edge_label(subs.slinks_internal[i],node,null,tex_ids);var color="black";if(subs.type=="SINK")var style="dotted";else if(subs.enqueue)var style="solid";else var style="dashed";style+=",bold";return String(node)+' [label="'+label+'" '+'color="'+color+'" '+'style="'+style+'"'+"];\n"}function dot_format_edge(node1,node2,slink,tex_ids){var label=dot_format_edge_label(slink,node1,node2,tex_ids);if(slink.active)var style="solid";else var style="dotted";return String(node1)+" -> "+String(node2)+
' [label="'+label+'" '+'style="'+style+'"];\n'}function dot_format_edge_label(slink,node1,node2,tex_ids){function filters_to_string(filters){var string="";if(filters.min==m_tex.TF_LINEAR)string+="L";else if(filters.min==m_tex.TF_NEAREST)string+="N";if(filters.mag==m_tex.TF_LINEAR)string+="L";else if(filters.mag==m_tex.TF_NEAREST)string+="N";return string}var label="";label+=slink.from+"\\n";label+=slink.to!="NONE"?slink.to+"\\n":"";label+="(";if(slink.update_dim){var size_mult=slink.size_mult;if(Math.round(size_mult)!=
size_mult)size_mult=size_mult.toFixed(2);var size=(size_mult==1?"":size_mult)+"S";label+=size+"x"+size}else label+=slink.size+"x"+slink.size;if(slink.from!="SCREEN"){label+=" ";if(slink.use_renderbuffer)label+="RR";else label+=filters_to_string({min:slink.min_filter,mag:slink.mag_filter});for(var i=0;i<tex_ids.length;i+=2)if(tex_ids[i]==slink.texture)label+=" "+tex_ids[i+1]}label+=")"+"\\n";return label}exports.create_rendering_queue=function(graph){var subscenes=m_graph.topsort_attr(graph);var queue=
[];for(var i=0;i<subscenes.length;i++){var subs=subscenes[i];if(subs.enqueue)queue.push(subs)}return queue}};b4w.module["__textures"]=function(exports,require){var m_cfg=require("__config");var m_dds=require("__dds");var m_ext=require("__extensions");var m_print=require("__print");var m_time=require("__time");var m_util=require("__util");var cfg_def=m_cfg.defaults;var cfg_sfx=m_cfg.sfx;exports.TF_NEAREST=0;exports.TF_LINEAR=0;exports.TF_NEAREST_MIPMAP_NEAREST=0;exports.TF_LINEAR_MIPMAP_NEAREST=0;exports.TF_NEAREST_MIPMAP_LINEAR=0;exports.TF_LINEAR_MIPMAP_LINEAR=0;exports.TT_RGBA_INT=10;exports.TT_RGB_INT=
20;exports.TT_RGBA_FLOAT=30;exports.TT_RGB_FLOAT=40;exports.TT_DEPTH=50;exports.TT_RENDERBUFFER=60;var _canvas_textures_cache={};var _video_textures_cache={};var CHANNEL_SIZE_BYTES_INT=4;var CHANNEL_SIZE_BYTES_FLOAT=16;var CHANNEL_SIZE_BYTES_DEPTH=3;var CHANNEL_SIZE_BYTES_RENDERBUFFER=2;var PLAYBACK_RATE=2;var _gl=null;var LEVELS;exports.setup_context=function(gl){LEVELS=[gl.NEAREST_MIPMAP_NEAREST,gl.NEAREST_MIPMAP_LINEAR,gl.LINEAR_MIPMAP_NEAREST,gl.LINEAR_MIPMAP_LINEAR];exports.TF_NEAREST=gl.NEAREST;
exports.TF_LINEAR=gl.LINEAR;exports.TF_NEAREST_MIPMAP_NEAREST=gl.NEAREST_MIPMAP_NEAREST;exports.TF_LINEAR_MIPMAP_NEAREST=gl.LINEAR_MIPMAP_NEAREST;exports.TF_NEAREST_MIPMAP_LINEAR=gl.NEAREST_MIPMAP_LINEAR;exports.TF_LINEAR_MIPMAP_LINEAR=gl.LINEAR_MIPMAP_LINEAR;_gl=gl};exports.get_canvas_context=function(id,data_id){if(data_id in _canvas_textures_cache&&id in _canvas_textures_cache[data_id])return _canvas_textures_cache[data_id][id].canvas_context;else return null};exports.update_canvas_context=function(id,
data_id){if(data_id in _canvas_textures_cache&&id in _canvas_textures_cache[data_id]){update_texture_canvas(_canvas_textures_cache[data_id][id]);return true}else return false};function init_texture(){return{name:"",type:0,source:"",source_id:"",width:0,height:0,compress_ratio:1,allow_node_dds:true,source_size:1024,enable_canvas_mipmapping:false,canvas_context:null,w_target:0,w_texture:null,w_renderbuffer:null,_nla_tex_event:null,is_movie:false,vtex_data_id:-1,video_file:null,movie_length:0,fps:0,
frame_start:0,frame_offset:0,frame_duration:0,seq_video:null,seq_movie_length:0,seq_fps:0,seq_cur_frame:-1,seq_video_played:false,seq_last_discrete_mark:-1,video_was_stopped:false,use_auto_refresh:false,use_cyclic:false,use_nla:false}}exports.create_texture=function(name,type){var texture=init_texture();texture.name=name;texture.type=type;texture.source="NONE";if(type==exports.TT_RENDERBUFFER)texture.w_renderbuffer=_gl.createRenderbuffer();else{var w_target=_gl.TEXTURE_2D;var w_texture=_gl.createTexture();
_gl.bindTexture(w_target,w_texture);_gl.texParameteri(w_target,_gl.TEXTURE_MAG_FILTER,_gl.LINEAR);_gl.texParameteri(w_target,_gl.TEXTURE_MIN_FILTER,_gl.LINEAR);_gl.texParameteri(w_target,_gl.TEXTURE_WRAP_S,_gl.CLAMP_TO_EDGE);_gl.texParameteri(w_target,_gl.TEXTURE_WRAP_T,_gl.CLAMP_TO_EDGE);_gl.bindTexture(w_target,null);texture.w_target=w_target;texture.w_texture=w_texture}return texture};exports.create_cubemap_texture=function(name,size){var w_texture=_gl.createTexture();var w_target=_gl.TEXTURE_CUBE_MAP;
_gl.bindTexture(w_target,w_texture);_gl.texParameteri(w_target,_gl.TEXTURE_MAG_FILTER,_gl.LINEAR);_gl.texParameteri(w_target,_gl.TEXTURE_MIN_FILTER,_gl.LINEAR);_gl.texParameteri(w_target,_gl.TEXTURE_WRAP_S,_gl.CLAMP_TO_EDGE);_gl.texParameteri(w_target,_gl.TEXTURE_WRAP_T,_gl.CLAMP_TO_EDGE);var infos=["TEXTURE_CUBE_MAP_POSITIVE_X","TEXTURE_CUBE_MAP_NEGATIVE_X","TEXTURE_CUBE_MAP_POSITIVE_Y","TEXTURE_CUBE_MAP_NEGATIVE_Y","TEXTURE_CUBE_MAP_POSITIVE_Z","TEXTURE_CUBE_MAP_NEGATIVE_Z"];for(var i=0;i<6;i++){var info=
infos[i];_gl.texImage2D(_gl[info],0,_gl.RGBA,size,size,0,_gl.RGBA,_gl.UNSIGNED_BYTE,null)}_gl.bindTexture(w_target,null);var texture=init_texture();texture.name=name;texture.type=exports.TT_RGBA_INT;texture.source="NONE";texture.width=3*size;texture.height=2*size;texture.compress_ratio=1;texture.w_texture=w_texture;texture.w_target=_gl.TEXTURE_CUBE_MAP;return texture};exports.set_filters=function(texture,min_filter,mag_filter){if(texture.type==exports.TT_RENDERBUFFER)return;var w_target=texture.w_target;
var w_texture=texture.w_texture;_gl.bindTexture(w_target,w_texture);if(min_filter)_gl.texParameteri(w_target,_gl.TEXTURE_MIN_FILTER,min_filter);if(mag_filter)_gl.texParameteri(w_target,_gl.TEXTURE_MAG_FILTER,mag_filter);_gl.bindTexture(w_target,null)};exports.get_filters=function(texture){if(texture.type==exports.TT_RENDERBUFFER)return{min:exports.TF_NEAREST,mag:exports.TF_NEAREST};var w_target=texture.w_target;var w_texture=texture.w_texture;_gl.bindTexture(w_target,w_texture);var min=_gl.getTexParameter(w_target,
_gl.TEXTURE_MIN_FILTER);var mag=_gl.getTexParameter(w_target,_gl.TEXTURE_MAG_FILTER);_gl.bindTexture(w_target,null);return{min:min,mag:mag}};exports.resize=function(texture,width,height){var width=Math.max(width,cfg_def.edge_min_tex_size_hack?2:1);var height=Math.max(height,cfg_def.edge_min_tex_size_hack?2:1);if(texture.width==width&&texture.height==height)return;if(texture.type==exports.TT_RENDERBUFFER){_gl.bindRenderbuffer(_gl.RENDERBUFFER,texture.w_renderbuffer);_gl.renderbufferStorage(_gl.RENDERBUFFER,
_gl.DEPTH_COMPONENT16,width,height);_gl.bindRenderbuffer(_gl.RENDERBUFFER,null)}else{var w_tex=texture.w_texture;var w_target=texture.w_target;_gl.bindTexture(w_target,w_tex);var format=get_image2d_format(texture);var type=get_image2d_type(texture);_gl.texImage2D(w_target,0,format,width,height,0,format,type,null);_gl.bindTexture(w_target,null)}if(check_texture_size(width,height)){m_print.error('Slink texture "'+texture.name+'" has unsupported size: '+width+"x"+height+". Max available: "+cfg_def.max_texture_size+
"x"+cfg_def.max_texture_size+".");return}texture.width=width;texture.height=height};exports.create_texture_bpy=create_texture_bpy;function create_texture_bpy(bpy_texture,global_af,bpy_scenes,thread_id){var tex_type=bpy_texture["type"];var image_data=new Uint8Array([.8*255,.8*255,.8*255,1*255]);var texture=init_texture();switch(tex_type){case "DATA_TEX2D":case "IMAGE":var w_texture=_gl.createTexture();var w_target=_gl.TEXTURE_2D;_gl.bindTexture(w_target,w_texture);_gl.texImage2D(w_target,0,_gl.RGBA,
1,1,0,_gl.RGBA,_gl.UNSIGNED_BYTE,image_data);if(bpy_texture["image"]&&bpy_texture["image"]["source"]=="MOVIE"){texture.is_movie=true;texture.frame_start=bpy_texture["frame_start"];texture.frame_offset=bpy_texture["frame_offset"];texture.frame_duration=bpy_texture["frame_duration"];texture.use_auto_refresh=bpy_texture["use_auto_refresh"];texture.use_cyclic=bpy_texture["use_cyclic"];texture.movie_length=bpy_texture["movie_length"];texture.use_nla=bpy_texture["b4w_nla_video"];if(texture.frame_offset!=
0)m_print.warn('Frame offset for texture "'+bpy_texture["name"]+'" has a nonzero value. Can lead to undefined behaviour'+" for mobile devices.")}break;case "NONE":var w_texture=_gl.createTexture();var w_target=_gl.TEXTURE_2D;_gl.bindTexture(w_target,w_texture);if(bpy_texture["b4w_source_type"]=="NONE")return null;else if(bpy_texture["b4w_source_type"]=="SCENE"){if(!bpy_texture["b4w_source_id"])return null;var name=bpy_texture["b4w_source_id"];var scene=m_util.keysearch("name",name,bpy_scenes);if(scene){texture.source_size=
bpy_texture["b4w_source_size"];scene._render_to_textures=scene._render_to_textures||[];scene._render_to_textures.push(bpy_texture);_gl.texImage2D(w_target,0,_gl.RGBA,1,1,0,_gl.RGBA,_gl.UNSIGNED_BYTE,image_data)}else return null}break;case "ENVIRONMENT_MAP":var w_texture=_gl.createTexture();var w_target=_gl.TEXTURE_CUBE_MAP;_gl.bindTexture(w_target,w_texture);var targets=["POSITIVE_X","NEGATIVE_X","POSITIVE_Y","NEGATIVE_Y","POSITIVE_Z","NEGATIVE_Z"];for(var i=0;i<6;i++)_gl.texImage2D(_gl["TEXTURE_CUBE_MAP_"+
targets[i]],0,_gl.RGBA,1,1,0,_gl.RGBA,_gl.UNSIGNED_BYTE,image_data);break;case "BLEND":return null;default:m_print.error('texture "'+bpy_texture["name"]+'" has unsupported type "'+tex_type+'"');return null}if(tex_type=="NONE"&&!(bpy_texture["b4w_enable_canvas_mipmapping"]&&bpy_texture["b4w_source_type"]=="CANVAS")||tex_type=="DATA_TEX2D"||tex_type=="IMAGE"&&bpy_texture["image"]["source"]=="MOVIE")_gl.texParameteri(w_target,_gl.TEXTURE_MIN_FILTER,_gl.LINEAR);else _gl.texParameteri(w_target,_gl.TEXTURE_MIN_FILTER,
LEVELS[cfg_def.texture_min_filter]);_gl.texParameteri(w_target,_gl.TEXTURE_MAG_FILTER,_gl.LINEAR);setup_anisotropic_filtering(bpy_texture,global_af,w_target);var tex_extension=bpy_texture["extension"];if(tex_extension=="REPEAT"&&!bpy_texture["b4w_shore_dist_map"]){_gl.texParameteri(w_target,_gl.TEXTURE_WRAP_S,_gl.REPEAT);_gl.texParameteri(w_target,_gl.TEXTURE_WRAP_T,_gl.REPEAT)}else{_gl.texParameteri(w_target,_gl.TEXTURE_WRAP_S,_gl.CLAMP_TO_EDGE);_gl.texParameteri(w_target,_gl.TEXTURE_WRAP_T,_gl.CLAMP_TO_EDGE)}texture.type=
exports.TT_RGBA_INT;texture.width=1;texture.height=1;texture.w_texture=w_texture;texture.w_target=w_target;if(bpy_texture["b4w_source_type"]=="CANVAS"&&tex_type=="NONE"){var id=bpy_texture["b4w_source_id"];var size=bpy_texture["b4w_source_size"];texture.enable_canvas_mipmapping=bpy_texture["b4w_enable_canvas_mipmapping"];texture.source_id=id;texture.source="CANVAS";update_canvas_props(id,size,texture);if(!(thread_id in _canvas_textures_cache))_canvas_textures_cache[thread_id]={};_canvas_textures_cache[thread_id][id]=
texture;update_texture_canvas(texture)}else if(bpy_texture["b4w_source_type"]=="SCENE"&&tex_type=="NONE"){texture.source_id=bpy_texture["b4w_source_id"];texture.source="SCENE"}else{texture.source=tex_type;_gl.generateMipmap(w_target);_gl.bindTexture(w_target,null)}texture.name=bpy_texture["name"];bpy_texture._render=texture;return texture}function setup_anisotropic_filtering(bpy_texture,global_af,w_target){var af=bpy_texture["b4w_anisotropic_filtering"];if(af==="DEFAULT")af=global_af;if(af!=="OFF"&&
cfg_def.anisotropic_filtering){var ext_aniso=m_ext.get_aniso();if(ext_aniso){af=parseFloat(af.split("x")[0]);_gl.texParameterf(w_target,ext_aniso.TEXTURE_MAX_ANISOTROPY_EXT,af)}}}function update_canvas_props(name,size,texture){var canvas=document.createElement("canvas");canvas.width=size;canvas.height=size;texture.canvas_context=canvas.getContext("2d")}function update_texture_canvas(texture){if(texture.source!="CANVAS")throw"Wrong texture";var w_texture=texture.w_texture;var w_target=texture.w_target;
_gl.bindTexture(w_target,w_texture);var w_format=get_image2d_format(texture);var w_type=get_image2d_type(texture);var canvas=texture.canvas_context.canvas;_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,true);_gl.texImage2D(w_target,0,w_format,w_format,w_type,canvas);_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,false);if(texture.enable_canvas_mipmapping)_gl.generateMipmap(w_target);_gl.bindTexture(w_target,null);texture.width=canvas.width;texture.height=canvas.height}exports.update_video_texture=function(texture){var w_texture=
texture.w_texture;var w_target=texture.w_target;_gl.bindTexture(w_target,w_texture);_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,true);if(texture.video_file.length!=4)_gl.texImage2D(w_target,0,_gl.RGBA,_gl.RGBA,_gl.UNSIGNED_BYTE,texture.video_file);else _gl.texImage2D(w_target,0,_gl.RGBA,1,1,0,_gl.RGBA,_gl.UNSIGNED_BYTE,texture.video_file);_gl.bindTexture(w_target,null)};exports.update_seq_video_texture=update_seq_video_texture;function update_seq_video_texture(texture){var w_texture=texture.w_texture;
var w_target=texture.w_target;_gl.bindTexture(w_target,w_texture);_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,true);_gl.texImage2D(w_target,0,_gl.RGBA,_gl.RGBA,_gl.UNSIGNED_BYTE,texture.seq_video[texture.seq_cur_frame]);_gl.bindTexture(w_target,null)}exports.update_texture=function(texture,image_data,is_dds,filepath,thread_id){var tex_type=texture.source;var w_texture=texture.w_texture;var w_target=texture.w_target;_gl.bindTexture(w_target,w_texture);if(image_data.length==4){var update_color=true;var image_data=
new Uint8Array([image_data[0]*255,image_data[1]*255,image_data[2]*255,image_data[3]*255])}if(tex_type=="IMAGE")if(update_color){_gl.texImage2D(w_target,0,_gl.RGBA,1,1,0,_gl.RGBA,_gl.UNSIGNED_BYTE,image_data);texture.width=1;texture.height=1}else if(is_dds){var dds_wh=m_dds.get_width_height(image_data);if(check_texture_size(dds_wh.width,dds_wh.height)){m_print.error('Texture "'+filepath+'" has unsupported size: '+dds_wh.width+"x"+dds_wh.height+". Max available: "+cfg_def.max_texture_size+"x"+cfg_def.max_texture_size+
".");return}m_dds.upload_dds_levels(_gl,m_ext.get_s3tc(),image_data,true);if(is_non_power_of_two(dds_wh.width,dds_wh.height)){if(!texture.auxilary_texture)m_print.warn("using NPOT texture",filepath);prepare_npot_texture(w_target)}texture.width=dds_wh.width;texture.height=dds_wh.height;texture.compress_ratio=m_dds.get_compress_ratio(image_data)}else{_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,true);if(check_texture_size(image_data.width,image_data.height)){m_print.error('Texture "'+filepath+'" has unsupported size: '+
image_data.width+"x"+image_data.height+". Max available: "+cfg_def.max_texture_size+"x"+cfg_def.max_texture_size+".");return}if(texture.is_movie)if(!cfg_def.seq_video_fallback){if(image_data){if(!(thread_id in _video_textures_cache))_video_textures_cache[thread_id]={};_video_textures_cache[thread_id][texture.name]=texture}texture.video_file=image_data;texture.video_file.loop=texture.use_cyclic;texture.fps=image_data.duration?texture.movie_length/image_data.duration:m_time.get_framerate();if(!cfg_sfx.disable_playback_rate_hack){image_data.playbackRate=
m_time.get_framerate()/texture.fps;if(cfg_sfx.clamp_playback_rate_hack&&image_data.playbackRate>PLAYBACK_RATE)image_data.playbackRate=PLAYBACK_RATE}_gl.texImage2D(w_target,0,_gl.RGBA,_gl.RGBA,_gl.UNSIGNED_BYTE,texture.video_file)}else{if(image_data){if(!(thread_id in _video_textures_cache))_video_textures_cache[thread_id]={};_video_textures_cache[thread_id][texture.name]=texture;texture.seq_video=image_data;texture.seq_movie_length=image_data.length;texture.fps=texture.seq_fps*texture.movie_length/
image_data.length;_gl.texImage2D(w_target,0,_gl.RGBA,_gl.RGBA,_gl.UNSIGNED_BYTE,texture.seq_video[0])}}else _gl.texImage2D(w_target,0,_gl.RGBA,_gl.RGBA,_gl.UNSIGNED_BYTE,image_data);if(texture.is_movie)if(cfg_def.seq_video_fallback){texture.width=image_data[0].width;texture.height=image_data[0].height}else{texture.width=image_data.videoWidth;texture.height=image_data.videoHeight}else{texture.width=image_data.width;texture.height=image_data.height}if(is_non_power_of_two(texture.width,texture.height)){if(!texture.auxilary_texture)if(texture.is_movie)m_print.warn("using NPOT video texture",
filepath);else m_print.warn("using NPOT texture",filepath);prepare_npot_texture(w_target)}else if(!texture.is_movie)_gl.generateMipmap(w_target)}else if(tex_type=="ENVIRONMENT_MAP"){var infos=[["POSITIVE_X",2,0],["NEGATIVE_X",0,0],["POSITIVE_Y",1,1],["NEGATIVE_Y",0,1],["POSITIVE_Z",1,0],["NEGATIVE_Z",2,1]];if(update_color){for(var i=0;i<6;i++){var info=infos[i];_gl.texImage2D(_gl["TEXTURE_CUBE_MAP_"+info[0]],0,_gl.RGBA,1,1,0,_gl.RGBA,_gl.UNSIGNED_BYTE,image_data)}texture.width=3;texture.height=2}else{_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,
false);var img_dim=image_data.width/3;if(check_cube_map_size(img_dim)){m_print.warn('Cubemap texture "'+filepath+'" has unsupported size: '+image_data.width+"x"+image_data.height+". Max available: "+cfg_def.max_cube_map_size*3+"x"+cfg_def.max_cube_map_size*2+". "+"Reduced image size will be used.");var scale_fac=cfg_def.max_cube_map_size/img_dim;var tex_dim=img_dim*scale_fac}else var tex_dim=img_dim;for(var i=0;i<6;i++){var info=infos[i];var tmpcanvas=document.createElement("canvas");tmpcanvas.width=
tex_dim;tmpcanvas.height=tex_dim;var ctx=tmpcanvas.getContext("2d");if(info[0]=="POSITIVE_Y"||info[0]=="NEGATIVE_Y"){ctx.translate(0,tex_dim);ctx.scale(1,-1)}else{ctx.translate(tex_dim,0);ctx.scale(-1,1)}ctx.drawImage(image_data,info[1]*img_dim,info[2]*img_dim,img_dim,img_dim,0,0,tex_dim,tex_dim);_gl.texImage2D(_gl["TEXTURE_CUBE_MAP_"+info[0]],0,_gl.RGBA,_gl.RGBA,_gl.UNSIGNED_BYTE,tmpcanvas)}texture.width=3*tex_dim;texture.height=2*tex_dim;if(is_non_power_of_two(image_data.width/3,image_data.height/
2)){m_print.warn("using NPOT cube map texture",filepath);prepare_npot_texture(w_target)}else _gl.generateMipmap(w_target)}}else if(tex_type=="DATA_TEX2D"){_gl.texImage2D(w_target,0,_gl.RGBA,image_data.width,image_data.height,0,_gl.RGBA,_gl.UNSIGNED_BYTE,image_data.data);texture.width=image_data.width;texture.height=image_data.height}_gl.bindTexture(w_target,null)};function prepare_npot_texture(tex_target){_gl.texParameteri(tex_target,_gl.TEXTURE_WRAP_S,_gl.CLAMP_TO_EDGE);_gl.texParameteri(tex_target,
_gl.TEXTURE_WRAP_T,_gl.CLAMP_TO_EDGE);_gl.texParameteri(tex_target,_gl.TEXTURE_MAG_FILTER,_gl.LINEAR);_gl.texParameteri(tex_target,_gl.TEXTURE_MIN_FILTER,_gl.LINEAR)}function is_non_power_of_two(width,height){var dims=[1,2,4,8,16,32,64,128,256,512,1024,2048,4096,8192,16384];return dims.indexOf(width)==-1||dims.indexOf(height)==-1}function get_image2d_format(texture){var format;switch(texture.type){case exports.TT_RGBA_INT:format=_gl.RGBA;break;case exports.TT_RGB_INT:format=_gl.RGB;break;case exports.TT_RGBA_FLOAT:format=
_gl.RGBA;break;case exports.TT_RGB_FLOAT:format=_gl.RGB;break;case exports.TT_DEPTH:format=_gl.DEPTH_COMPONENT;break;default:throw"Wrong texture type";break}return format}function get_image2d_type(texture){var type;switch(texture.type){case exports.TT_RGBA_INT:type=_gl.UNSIGNED_BYTE;break;case exports.TT_RGB_INT:type=_gl.UNSIGNED_BYTE;break;case exports.TT_RGBA_FLOAT:type=_gl.FLOAT;break;case exports.TT_RGB_FLOAT:type=_gl.FLOAT;break;case exports.TT_DEPTH:type=_gl.UNSIGNED_INT;break;default:throw"Wrong texture type";
break}return type}exports.delete_texture=function(texture){_gl.deleteTexture(texture)};exports.is_texture=function(tex){if(tex&&tex.name&&(tex.w_texture||tex.w_renderbuffer))return true;else return false};exports.is_renderbuffer=function(tex){if(tex&&tex.name&&tex.w_renderbuffer)return true;else return false};exports.is_float=function(tex){if(tex.type==exports.TT_RGBA_FLOAT||tex.type==exports.TT_RGB_FLOAT)return true;else return false};exports.get_texture_channel_size=function(tex){var size=0;switch(tex.type){case exports.TT_RGBA_INT:case exports.TT_RGB_INT:size=
CHANNEL_SIZE_BYTES_INT;break;case exports.TT_RGBA_FLOAT:case exports.TT_RGB_FLOAT:size=CHANNEL_SIZE_BYTES_FLOAT;break;case exports.TT_DEPTH:size=CHANNEL_SIZE_BYTES_DEPTH;break;case exports.TT_RENDERBUFFER:size=CHANNEL_SIZE_BYTES_RENDERBUFFER;break}return size};function check_texture_size(width,height){return width>cfg_def.max_texture_size||height>cfg_def.max_texture_size}function check_cube_map_size(size){return size>cfg_def.max_cube_map_size}exports.generate_texture=function(type,subs){var texture=
null;switch(type){case "SSAO_TEXTURE":texture={"name":"special_ssao_texture","type":"DATA_TEX2D","extension":"REPEAT","b4w_anisotropic_filtering":"OFF"};create_texture_bpy(texture,null,subs,0);texture["image"]={"filepath":null};break;default:break}return texture};exports.cleanup=function(){if(!cfg_def.seq_video_fallback)for(var data_id in _video_textures_cache)for(var tex in _video_textures_cache[data_id]){_video_textures_cache[data_id][tex].video_file.pause();_video_textures_cache[data_id][tex].video_file.src=
"";_video_textures_cache[data_id][tex].video_file.load()}_canvas_textures_cache={};_video_textures_cache={}};exports.pause=function(){for(var data_id in _video_textures_cache)for(var vtex_name in _video_textures_cache[data_id]){var vtex=_video_textures_cache[data_id][vtex_name];if(!video_is_played(vtex))continue;pause_video(vtex_name,data_id);vtex.video_was_stopped=true}};exports.reset=function(){for(var data_id in _video_textures_cache)for(var vtex_name in _video_textures_cache[data_id]){reset_video(vtex_name,
data_id);_video_textures_cache[data_id][vtex_name].video_was_stopped=false}};exports.play=function(resume_stopped_only){for(var data_id in _video_textures_cache)for(var vtex_name in _video_textures_cache[data_id]){var vtex=_video_textures_cache[data_id][vtex_name];if(resume_stopped_only&&!vtex.video_was_stopped)continue;play_video(vtex_name,data_id);vtex.video_was_stopped=false}};exports.play_video=play_video;function play_video(vtex_name,data_id){if(data_id in _video_textures_cache&&vtex_name in
_video_textures_cache[data_id]){var vtex=_video_textures_cache[data_id][vtex_name];if(vtex.video_file)vtex.video_file.play();else if(vtex.seq_video)vtex.seq_video_played=true;return true}else return false}exports.pause_video=pause_video;function pause_video(vtex_name,data_id){if(data_id in _video_textures_cache&&vtex_name in _video_textures_cache[data_id]){var vtex=_video_textures_cache[data_id][vtex_name];if(vtex.video_file)vtex.video_file.pause();else if(vtex.seq_video)vtex.seq_video_played=false;
return true}else return false}exports.reset_video=reset_video;function reset_video(vtex_name,data_id){if(data_id in _video_textures_cache&&vtex_name in _video_textures_cache[data_id]){var vtex=_video_textures_cache[data_id][vtex_name];if(vtex.video_file)vtex.video_file.currentTime=vtex.frame_offset/vtex.fps;else if(vtex.seq_video)vtex.seq_cur_frame=video_frame_to_seq_frame(vtex,vtex.frame_offset);return true}else return false}exports.set_frame_video=function(vtex_name,frame,data_id){if(data_id in
_video_textures_cache&&vtex_name in _video_textures_cache[data_id]){var vtex=_video_textures_cache[data_id][vtex_name];if(vtex.video_file)vtex.video_file.currentTime=frame/vtex.fps;else if(vtex.seq_video)vtex.seq_cur_frame=frame;return true}else return false};exports.video_is_played=video_is_played;function video_is_played(vtex){if(vtex.video_file)return!vtex.video_file.paused;else if(vtex.seq_video)return vtex.seq_video_played;else return false}exports.video_update_is_available=function(vtex){if(!vtex.video_file&&
!vtex.seq_video)return 0;if(vtex.video_file)return vtex.video_file.readyState>=2;else return true};exports.video_get_current_frame=function(vtex){if(!vtex.video_file&&!vtex.seq_video)return 0;if(vtex.video_file)return Math.round(vtex.video_file.currentTime*vtex.fps);else return vtex.seq_cur_frame};exports.video_get_start_frame=function(vtex){if(!vtex.video_file&&!vtex.seq_video)return 0;if(vtex.video_file)return vtex.frame_offset;else return video_frame_to_seq_frame(vtex,vtex.frame_offset)};exports.video_get_end_frame=
function(vtex){if(!vtex.video_file&&!vtex.seq_video)return 0;var duration=Math.min(vtex.frame_duration,vtex.movie_length-vtex.frame_offset);if(vtex.video_file)return vtex.frame_offset+duration;else return video_frame_to_seq_frame(vtex,vtex.frame_offset+duration)};exports.seq_video_get_discrete_timemark=function(vtex,time){return Math.round(time*vtex.seq_fps*(m_time.get_framerate()/vtex.fps))};exports.video_get_duration=function(vtex){return Math.min(vtex.frame_duration,vtex.movie_length-vtex.frame_offset)};
exports.video_frame_to_seq_frame=video_frame_to_seq_frame;function video_frame_to_seq_frame(vtex,frame){return Math.round(frame*vtex.seq_movie_length/vtex.movie_length)}};b4w.module["__assets"]=function(exports,require){var m_cfg=require("__config");var m_compat=require("__compat");var m_print=require("__print");var m_sfg=require("__sfx");var m_util=require("__util");var m_version=require("__version");var cfg_def=m_cfg.defaults;var cfg_ldr=m_cfg.assets;exports.AT_ARRAYBUFFER=10;exports.AT_JSON=20;exports.AT_TEXT=30;exports.AT_AUDIOBUFFER=40;exports.AT_IMAGE_ELEMENT=50;exports.AT_AUDIO_ELEMENT=60;exports.AT_VIDEO_ELEMENT=70;exports.AT_SEQ_VIDEO_ELEMENT=80;var ASTATE_ENQUEUED=
10;var ASTATE_REQUESTED=20;var ASTATE_RECEIVED=30;var ASTATE_HALTED=40;var _assets_queue=[];var _assets_pack_index=0;var _loaded_assets={};function get_built_in_data(){if(m_cfg.is_built_in_data())return require(m_cfg.paths.built_in_data_module)["data"];else return null}function FakeHttpRequest(){var req={_source_url:null,_parse_response:function(source){switch(req.responseType){case "json":case "text":return source;case "arraybuffer":var bin_str=atob(source);var len=bin_str.length;var arr_buffer=
new Int8Array(len);for(var i=0;i<len;i++)arr_buffer[i]=bin_str.charCodeAt(i);return arr_buffer.buffer;default:return source}},status:0,readyState:0,response:"",responseType:"",onreadystatechange:null,overrideMimeType:function(){},addEventListener:function(){},open:function(method,url,async){req._source_url=url;req.readyState=1},send:function(){req.status=404;req.readyState=4;var bd=get_built_in_data();if(bd&&req._source_url in bd){req.status=200;if(bd[req._source_url])req.response=req._parse_response(bd[req._source_url])}var get_type=
{};if(get_type.toString.call(req.onreadystatechange)==="[object Function]")req.onreadystatechange()}};return req}exports.split_extension=function(path){var dot_split=path.split(".");var head_ext=Array(2);head_ext[0]=dot_split.slice(0,-1).join(".");head_ext[1]=String(dot_split.slice(-1));return head_ext};exports.get_text_sync=function(asset_uri){if(_loaded_assets[asset_uri])return _loaded_assets[asset_uri];if(cfg_ldr.prevent_caching)var filepath=asset_uri+m_version.timestamp();else var filepath=asset_uri;
var req=new XMLHttpRequest;req.overrideMimeType("text/plain");req.open("GET",filepath,false);req.send(null);if(req.status==200||req.status==0){var resp_text=req.responseText;if(resp_text.length){_loaded_assets[asset_uri]=resp_text;return resp_text}else m_util.panic("Error XHR: responce is empty, GET "+asset_uri)}else m_util.panic("Error XHR: "+req.status+", GET "+asset_uri)};exports.cleanup=function(){for(var i=0;i<_assets_queue.length;i++)_assets_queue[i].state=ASTATE_HALTED;_assets_queue=[];_assets_pack_index=
0;_loaded_assets={}};exports.enqueue=function(assets_pack,asset_cb,pack_cb,progress_cb){for(var i=0;i<assets_pack.length;i++){var pack_elem=assets_pack[i];var asset={uri:pack_elem[0],type:pack_elem[1],filepath:pack_elem[2],opt_param:pack_elem[3],state:ASTATE_ENQUEUED,asset_cb:asset_cb||function(){},pack_cb:pack_cb||function(){},progress_cb:progress_cb||function(){},pack_index:_assets_pack_index};if(cfg_ldr.prevent_caching){var bd=get_built_in_data();if(!(bd&&asset.filepath in bd))asset.filepath+=
m_version.timestamp()}_assets_queue.push(asset)}request_assets(_assets_queue);_assets_pack_index++};exports.update=function(){request_assets(_assets_queue);handle_packs(_assets_queue)};function request_assets(queue){var req_cnt=0;for(var i=0;i<queue.length;i++){var asset=queue[i];if(asset.state===ASTATE_REQUESTED)req_cnt++;if(req_cnt>=cfg_ldr.max_requests)break;if(asset.state!==ASTATE_ENQUEUED)continue;asset.state=ASTATE_REQUESTED;req_cnt++;switch(asset.type){case exports.AT_ARRAYBUFFER:request_arraybuffer(asset,
"arraybuffer");break;case exports.AT_JSON:request_arraybuffer(asset,"json");break;case exports.AT_TEXT:request_arraybuffer(asset,"text");break;case exports.AT_AUDIOBUFFER:request_audiobuffer(asset);break;case exports.AT_IMAGE_ELEMENT:request_image(asset);break;case exports.AT_AUDIO_ELEMENT:request_audio(asset);break;case exports.AT_VIDEO_ELEMENT:request_video(asset);break;case exports.AT_SEQ_VIDEO_ELEMENT:request_seq_video(asset);break;default:m_util.panic("Wrong asset type: "+asset.type);break}}}
function request_arraybuffer(asset,response_type){var bd=get_built_in_data();if(bd&&asset.filepath in bd)var req=new FakeHttpRequest;else var req=new XMLHttpRequest;req.open("GET",asset.filepath,true);if(response_type=="text"){req.overrideMimeType("text/plain");req.responseType="text"}else if(response_type=="json"){req.overrideMimeType("application/json");req.responseType="text"}else req.responseType=response_type;req.onreadystatechange=function(){if(asset.state!=ASTATE_HALTED)if(req.readyState==
4){if(req.status==200||req.status==0){var response=req.response;if(response){if(response_type=="json"&&typeof response=="string")try{response=JSON.parse(response)}catch(e){m_print.error(e+" (parsing JSON "+asset.filepath+")");asset.asset_cb(null,asset.uri,asset.type,asset.filepath,asset.opt_param);return}asset.asset_cb(response,asset.uri,asset.type,asset.filepath,asset.opt_param)}else{m_print.error("empty responce when trying to get "+asset.filepath);asset.asset_cb(null,asset.uri,asset.type,asset.filepath,
asset.opt_param)}}else{m_print.error(req.status+" when trying to get "+asset.filepath);asset.asset_cb(null,asset.uri,asset.type,asset.filepath,asset.opt_param)}asset.state=ASTATE_RECEIVED}};req.addEventListener("progress",function(e){if(e.lengthComputable)asset.progress_cb(e.loaded/e.total)},false);req.send(null)}function request_audiobuffer(asset){var bd=get_built_in_data();if(bd&&asset.filepath in bd)var req=new FakeHttpRequest;else var req=new XMLHttpRequest;req.open("GET",asset.filepath,true);
req.responseType="arraybuffer";req.onreadystatechange=function(){if(asset.state!=ASTATE_HALTED)if(req.readyState==4)if(req.status==200||req.status==0){var response=req.response;if(response){var decode_cb=function(audio_buffer){asset.asset_cb(audio_buffer,asset.uri,asset.type,asset.filepath,asset.opt_param);asset.state=ASTATE_RECEIVED};var fail_cb=function(){asset.asset_cb(null,asset.uri,asset.type,asset.filepath,asset.opt_param);m_print.error("failed to decode "+asset.filepath);asset.state=ASTATE_RECEIVED};
m_sfg.decode_audio_data(response,decode_cb,fail_cb)}else{asset.asset_cb(null,asset.uri,asset.type,asset.filepath,asset.opt_param);m_print.error("empty responce when trying to get "+asset.filepath);asset.state=ASTATE_RECEIVED}}else{asset.asset_cb(null,asset.uri,asset.type,asset.filepath,asset.opt_param);m_print.error(req.status+" when trying to get "+asset.filepath);asset.state=ASTATE_RECEIVED}};req.send(null)}function request_image(asset){var image=document.createElement("img");if(cfg_def.allow_cors)image.crossOrigin=
"Anonymous";image.onload=function(){if(asset.state!=ASTATE_HALTED){asset.asset_cb(image,asset.uri,asset.type,asset.filepath,asset.opt_param);asset.state=ASTATE_RECEIVED}};image.addEventListener("error",function(){if(asset.state!=ASTATE_HALTED){asset.asset_cb(null,asset.uri,asset.type,asset.filepath,asset.opt_param);m_print.error("could not load image: "+asset.filepath);asset.state=ASTATE_RECEIVED}},false);var bd=get_built_in_data();if(bd&&asset.filepath in bd)if(bd[asset.filepath]){var img_mime_type=
get_image_mime_type(asset.filepath);image.src="data:"+img_mime_type+";base64,"+bd[asset.filepath]}else{if(m_compat.is_ie11()){var e=document.createEvent("CustomEvent");e.initCustomEvent("error",false,false,null)}else var e=new CustomEvent("error");image.dispatchEvent(e)}else image.src=asset.filepath}function request_audio(asset){var audio=document.createElement("audio");if(cfg_def.allow_cors||cfg_def.cors_chrome_hack)audio.crossOrigin="Anonymous";audio.addEventListener("loadeddata",function(){if(asset.state!=
ASTATE_HALTED){asset.asset_cb(audio,asset.uri,asset.type,asset.filepath,asset.opt_param);asset.state=ASTATE_RECEIVED}},false);audio.addEventListener("error",function(){if(asset.state!=ASTATE_HALTED){asset.asset_cb(null,asset.uri,asset.type,asset.filepath,asset.opt_param);m_print.error("could not load sound: "+asset.filepath);asset.state=ASTATE_RECEIVED}},false);var bd=get_built_in_data();if(bd&&asset.filepath in bd)if(bd[asset.filepath]){var snd_mime_type=get_sound_mime_type(asset.filepath);audio.src=
"data:"+snd_mime_type+";base64,"+bd[asset.filepath];if(asset.state!=ASTATE_HALTED){asset.asset_cb(audio,asset.uri,asset.type,asset.filepath,asset.opt_param);asset.state=ASTATE_RECEIVED}}else{if(m_compat.is_ie11()){var e=document.createEvent("CustomEvent");e.initCustomEvent("error",false,false,null)}else var e=new CustomEvent("error");audio.dispatchEvent(e)}else{audio.src=asset.filepath;if(cfg_def.is_mobile_device)audio.load()}if(cfg_def.mobile_firefox_media_hack){audio.autoplay=true;audio.pause()}setTimeout(function(){audio.some_prop_to_prevent_gc=
1},5E3)}function request_video(asset){var video=document.createElement("video");video.muted=true;if(cfg_def.allow_cors||cfg_def.is_mobile_device)video.crossOrigin="Anonymous";video.addEventListener("loadeddata",function(){video.removeEventListener("error",video_error_event,false);if(asset.state!=ASTATE_HALTED){asset.asset_cb(video,asset.uri,asset.type,asset.filepath,asset.opt_param);asset.state=ASTATE_RECEIVED}},false);function video_error_event(e){if(asset.state!=ASTATE_HALTED){asset.asset_cb(null,
asset.uri,asset.type,asset.filepath);m_print.error("could not load video: "+asset.filepath,asset.opt_param);asset.state=ASTATE_RECEIVED}}video.addEventListener("error",video_error_event,false);var bd=get_built_in_data();if(bd&&asset.filepath in bd)if(bd[asset.filepath]){var vid_mime_type=get_video_mime_type(asset.filepath);video.src="data:"+vid_mime_type+";base64,"+bd[asset.filepath];if(asset.state!=ASTATE_HALTED)video.addEventListener("loadeddata",function(){asset.asset_cb(video,asset.uri,asset.type,
asset.filepath,asset.opt_param);asset.state=ASTATE_RECEIVED},false)}else{if(m_compat.is_ie11()){var e=document.createEvent("CustomEvent");e.initCustomEvent("error",false,false,null)}else var e=new CustomEvent("error");video.dispatchEvent(e)}else{video.src=asset.filepath;if(cfg_def.is_mobile_device)video.load()}if(cfg_def.mobile_firefox_media_hack){video.autoplay=true;video.pause()}setTimeout(function(){video.some_prop_to_prevent_gc=1},1E4)}function request_seq_video(asset){var bd=get_built_in_data();
if(bd&&asset.filepath in bd)var req=new FakeHttpRequest;else var req=new XMLHttpRequest;req.open("GET",asset.filepath,true);req.responseType="arraybuffer";function load_cb(images){asset.asset_cb(images,asset.uri,asset.type,asset.filepath,asset.opt_param)}req.onreadystatechange=function(){if(asset.state!=ASTATE_HALTED)if(req.readyState==4){if(req.status==200||req.status==0){var response=req.response;if(response)parse_seq_video_file(response,load_cb);else{asset.asset_cb(null,asset.uri,asset.type,asset.filepath,
asset.opt_param);m_print.error("empty responce when trying to get "+asset.filepath)}}else{asset.asset_cb(null,asset.uri,asset.type,asset.filepath,asset.opt_param);m_print.error(req.status+" when trying to get "+asset.filepath)}asset.state=ASTATE_RECEIVED}};req.addEventListener("progress",function(e){if(e.lengthComputable)asset.progress_cb(e.loaded/e.total)},false);req.send(null)}function parse_seq_video_file(response,callback){var buffer=new Int32Array(response);var seq_image_data=new Int8Array(response);
var number=buffer[3];var data={images:[],blobs:[],fps:buffer[4]};var offset=20;for(var j=0;j<number;j++){var size=buffer[offset/4];var frame=seq_image_data.subarray(offset+4,offset+4+size);var blob=new Blob([frame],{type:"image/jpg"});var image=document.createElement("img");image.src=window.URL.createObjectURL(blob);data.images.push(image);data.blobs.push(blob);offset+=size+8-size%4}image.onload=function(){for(var i=0;i<data.images.length;i++)window.URL.revokeObjectURL(data.images[i].src);delete data.blobs;
callback(data)}}function get_image_mime_type(file_path){var ext=m_util.get_file_extension(file_path);var mime_type="image";switch(ext.toLowerCase()){case "jpeg":case "jpg":mime_type+="/jpeg";break;case "png":mime_type+="/png";break}return mime_type}function get_sound_mime_type(file_path){var ext=m_util.get_file_extension(file_path);var mime_type="audio";switch(ext.toLowerCase()){case "ogv":case "ogg":mime_type+="/ogg";break;case "mp3":mime_type+="/mpeg";break;case "m4v":case "mp4":mime_type+="/mp4";
break;case "webm":mime_type+="/webm";break}return mime_type}function get_video_mime_type(file_path){var ext=m_util.get_file_extension(file_path);var mime_type="video";switch(ext.toLowerCase()){case "ogv":mime_type+="/ogg";break;case "webm":mime_type+="/webm";break;case "m4v":mime_type+="/mp4";break}return mime_type}function handle_packs(queue){var pack_first_index=0;var pack_cb_exec=true;for(var i=0;i<queue.length;i++){var asset=queue[i];var asset_pack_first=queue[pack_first_index];if(asset.pack_index===
asset_pack_first.pack_index){if(asset.state!==ASTATE_RECEIVED)pack_cb_exec=false}else{if(pack_cb_exec){queue[i-1].pack_cb();var spliced_count=i-pack_first_index;queue.splice(pack_first_index,spliced_count);i-=spliced_count}pack_first_index=i;pack_cb_exec=queue[i].state===ASTATE_RECEIVED?true:false}if(i===queue.length-1&&pack_cb_exec){queue[i].pack_cb();queue.splice(pack_first_index)}}}function debug_queue(queue,opt_log_prefix){var state_str="[";for(var i=0;i<queue.length;i++)state_str+=String(queue[i].state/
10);state_str+="]";if(opt_log_prefix||opt_log_prefix===0)m_print.log(opt_log_prefix,state_str);else m_print.log(state_str)}};b4w.module["__loader"]=function(exports,require){var m_graph=require("__graph");var m_print=require("__print");var m_util=require("__util");var THREAD_IDLE=0;var THREAD_LOADING=1;var THREAD_FINISHED_NO_RESOURCES=2;var THREAD_FINISHED=3;var THREAD_ABORTED=4;var THREAD_STAGE_BEFORE=0;var THREAD_STAGE_LOOP=1;var THREAD_STAGE_AFTER=2;var THREAD_STAGE_IDLE=3;var DEBUG_MODE=false;var DEBUG_COLOR="color: #f0f;";var MAX_LOAD_TIME_MS=16;exports.SYNC_PRIORITY=0;exports.ASYNC_PRIORITY=1;exports.FINISH_PRIORITY=
2;var _scheduler=null;exports.get_scheduler=get_scheduler;function get_scheduler(){return _scheduler}function set_scheduler(scheduler){_scheduler=scheduler}exports.create_scheduler=function(){var scheduler={threads:[],current_thread_index:0,active_threads:0,start_secondary_threads:false,make_idle_iteration:false};set_scheduler(scheduler);return scheduler};exports.create_thread=function(stages,path,loaded_callback,stageload_cb,complete_load_cb,wait_complete_loading,do_not_load_resources,load_hidden){var scheduler=
get_scheduler();var thread={id:scheduler.threads.length,status:THREAD_IDLE,filepath:path,binary_name:"",loaded_cb:loaded_callback||function(){},load_hidden:load_hidden||false,wait_complete_loading:wait_complete_loading,time_load_start:0,curr_percents:0,stages_size_total:0,reset_time_cycle:false,stageload_cb:stageload_cb||function(){},complete_load_cb:complete_load_cb||function(){},stage_graph:null,stages_queue:null,has_video_textures:false,has_background_music:false,init_wa_context:false};var graph=
create_loading_graph(thread.id===0,stages,wait_complete_loading,do_not_load_resources);thread.stage_graph=graph;var stages_queue=[];var init_nodes=m_graph.get_source_nodes(graph);for(var i=0;i<init_nodes.length;i++)stages_queue.push(init_nodes[i]);thread.stages_queue=stages_queue;m_graph.traverse(graph,function(id,attr){if(attr.cb_before||attr.cb_loop||attr.cb_after)if(stage_need_calc(thread,attr))thread.stages_size_total+=attr.relative_size});scheduler.threads.push(thread);scheduler.active_threads++;
return thread.id};function create_loading_graph(is_primary,stages,wait_complete_loading,do_not_load_resources){var scheduler=get_scheduler();var graph=m_graph.create();for(var stage_name in stages){var stage=init_stage(stages[stage_name]);if(do_not_load_resources&&stage.is_resource||!is_primary&&stage.primary_only)skip_stage(stage);m_graph.append_node_attr(graph,stage)}for(var stage_name in stages){var stage=stages[stage_name];stage.name=stage_name;for(var i=0;i<stage.inputs.length;i++)m_graph.append_edge_attr(graph,
stages[stage.inputs[i]],stage,null)}var loaded_cb_wrapper=function(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){if(thread.id===0)scheduler.start_secondary_threads=true;if(!thread_is_finished(thread))thread.status=THREAD_FINISHED_NO_RESOURCES;thread.loaded_cb(thread.id,true);cb_finish(thread,stage);m_print.log("%cTHREAD "+thread.id+": LOADED CALLBACK",DEBUG_COLOR)};var finish_node=init_stage({name:"out",priority:exports.FINISH_PRIORITY,cb_before:loaded_cb_wrapper,relative_size:5});var prefinish_nodes=
[];if(wait_complete_loading){var ids=m_graph.get_sink_nodes(graph);for(var i=0;i<ids.length;i++)prefinish_nodes.push(m_graph.get_node_attr(graph,ids[i]))}else m_graph.traverse(graph,function(id,attr){if(!attr.background_loading)prefinish_nodes.push(attr)});m_graph.append_node_attr(graph,finish_node);for(var i=0;i<prefinish_nodes.length;i++){finish_node.inputs.push(prefinish_nodes[i].name);m_graph.append_edge_attr(graph,prefinish_nodes[i],finish_node,null)}return graph}function init_stage(stage){stage.background_loading=
stage.background_loading||false;if(!(stage.priority||stage.priority===0))stage.priority=stage.SYNC_PRIORITY;stage.inputs=stage.inputs||[];stage.is_finished=stage.is_finished||false;stage.skip=stage.skip||false;stage.relative_size=stage.relative_size||0;stage.is_resource=stage.is_resource||false;stage.primary_only=stage.primary_only||false;stage.status=THREAD_STAGE_BEFORE;stage.loop_index=0;stage.load_rate=0;stage.cb_param=stage.cb_param||null;return stage}exports.update_scheduler=function(bpy_data_array){var scheduler=
get_scheduler();if(!scheduler||is_finished(scheduler))return;if(scheduler.make_idle_iteration){scheduler.make_idle_iteration=false;return}var time_start=performance.now();do{var thread=scheduler.threads[scheduler.current_thread_index];var bpy_data=bpy_data_array[thread.id];if(!thread_is_finished(thread)){if(thread.status==THREAD_IDLE){thread.status=THREAD_LOADING;thread.time_load_start=performance.now();thread.stageload_cb(0,0);if(DEBUG_MODE)m_print.log("%cTHREAD "+thread.id+": 0% LOADING START 0ms",
DEBUG_COLOR)}if(update_stages_queue(thread))process_stages_queue(thread,bpy_data);else finish_thread(scheduler,thread,bpy_data)}if(scheduler.start_secondary_threads)scheduler.current_thread_index=(scheduler.current_thread_index+1)%scheduler.threads.length;if(thread.reset_time_cycle){thread.reset_time_cycle=false;return}}while(performance.now()-time_start<MAX_LOAD_TIME_MS)};exports.abort_thread=function(thread){var scheduler=get_scheduler();finish_thread(scheduler,thread,null);thread.status=THREAD_ABORTED;
if(thread.id===0)scheduler.start_secondary_threads=true;thread.loaded_cb(thread.id,false)};function finish_thread(scheduler,thread,bpy_data){thread.complete_load_cb(bpy_data,thread);thread.status=THREAD_FINISHED;scheduler.active_threads--;if(DEBUG_MODE){var ms=Math.round(performance.now()-thread.time_load_start);m_print.log("%cTHREAD "+thread.id+": 100% LOADING END "+ms+"ms",DEBUG_COLOR)}release_thread(thread)}function process_stages_queue(thread,bpy_data){var iter_counter=thread.stages_queue.length;
do{var stage_index=thread.stages_queue[0];var stage=m_graph.get_node_attr(thread.stage_graph,stage_index);var is_processed=process_stage(thread,stage,bpy_data);if(stage.priority==exports.ASYNC_PRIORITY)thread.reset_time_cycle=true;var first=thread.stages_queue.shift();thread.stages_queue.push(first);iter_counter--}while(!(is_processed||iter_counter==0))}function propagate_stages(thread,stage_indices){var next_indices=[];var stages_to_remove=[];for(var i=0;i<stage_indices.length;i++){var stage_index=
stage_indices[i];var stage=m_graph.get_node_attr(thread.stage_graph,stage_index);if(stage.is_finished){m_graph.traverse_outputs(thread.stage_graph,stage_index,function(id_out,attr_out,edge_attr_out){var can_execute=true;m_graph.traverse_inputs(thread.stage_graph,id_out,function(id_in,attr_in,edge_attr_in){if(!attr_in.is_finished){can_execute=false;return 1}});if(can_execute&&next_indices.indexOf(id_out)==-1&&stage_indices.indexOf(id_out)==-1)next_indices.push(id_out)});stages_to_remove.push(i)}}for(var i=
stages_to_remove.length-1;i>=0;i--)stage_indices.splice(stages_to_remove[i],1);return next_indices}function update_stages_queue(thread){var result_indices=[];var prev_indices=thread.stages_queue;var new_added=false;do{var next_indices=propagate_stages(thread,prev_indices);result_indices.push.apply(result_indices,prev_indices);if(next_indices.length>0)new_added=true;prev_indices=next_indices}while(next_indices.length>0);var priority_stage_sort=function(a,b){var stage_a=m_graph.get_node_attr(thread.stage_graph,
a);var stage_b=m_graph.get_node_attr(thread.stage_graph,b);var result=stage_b.priority-stage_a.priority;if(result==0)result=stage_a.background_loading-stage_b.background_loading;return result};if(new_added)result_indices.sort(priority_stage_sort);thread.stages_queue=result_indices;return thread.stages_queue.length}function process_stage(thread,stage,bpy_data){if(stage.skip){stage.is_finished=true;if(DEBUG_MODE)m_print.log("%cTHREAD "+thread.id+": SKIP STAGE "+stage.name,DEBUG_COLOR);stage_finish_cb(thread,
stage);return false}if(DEBUG_MODE&&stage.status==THREAD_STAGE_BEFORE){var percents=get_load_percents(thread);var message="LOADING START "+stage.name;var ms=Math.round(performance.now()-thread.time_load_start);m_print.log("%cTHREAD "+thread.id+": "+percents+"% "+message+" "+ms+"ms ",DEBUG_COLOR)}if(!stage.cb_before&&!stage.cb_loop&&!stage.cb_after){stage_finish_cb(thread,stage);return false}if(stage.status==THREAD_STAGE_BEFORE){stage.status++;if(stage.cb_before){stage.cb_before(bpy_data,thread,stage,
stage.cb_param,stage_finish_cb,stage_part_finish_cb);return true}}if(stage.status==THREAD_STAGE_LOOP)if(stage.cb_loop){stage.cb_loop(bpy_data,thread,stage,stage.cb_param,stage_finish_cb,stage_part_finish_cb);return true}else stage.status++;if(stage.status==THREAD_STAGE_AFTER){stage.status++;if(stage.cb_after){stage.cb_after(bpy_data,thread,stage,stage.cb_param,stage_finish_cb,stage_part_finish_cb);return true}}return false}function get_load_percents(thread){if(thread.stages_size_total==0)return 100;
var loaded=0;m_graph.traverse(thread.stage_graph,function(id,attr){if(stage_need_calc(thread,attr))loaded+=attr.load_rate*attr.relative_size});return m_util.trunc(loaded*100/thread.stages_size_total)}function stage_need_calc(thread,stage){return!(thread.do_not_load_resources&&stage.is_resource)}function stage_finish_cb(thread,stage){stage.is_finished=true;stage.status=THREAD_STAGE_IDLE;stage_loading_action(thread,stage,1);if(DEBUG_MODE){var percents=get_load_percents(thread);var message="LOADING END "+
stage.name;var ms=Math.round(performance.now()-thread.time_load_start);m_print.log("%cTHREAD "+thread.id+": "+percents+"% "+message+" "+ms+"ms ",DEBUG_COLOR)}}exports.stage_part_finish_cb=stage_part_finish_cb;function stage_part_finish_cb(thread,stage,rate){if(rate<1)stage_loading_action(thread,stage,rate);else stage.status++}function stage_loading_action(thread,stage,rate){var scheduler=get_scheduler();if(stage.cb_before||stage.cb_loop||stage.cb_after){stage.load_rate=rate;var percents=get_load_percents(thread);
if(thread.curr_percents!=percents||rate==1){thread.stageload_cb(percents,performance.now()-thread.time_load_start);thread.curr_percents=percents;scheduler.make_idle_iteration=true}}}exports.skip_stage_by_name=function(thread,name){var stage=get_stage_by_name(thread,name);if(stage!==null)skip_stage(stage)};function get_stage_by_name(thread,name){var stage=null;m_graph.traverse(thread.stage_graph,function(id,attr){if(attr.name==name){stage=attr;return 1}});return stage}function skip_stage(stage){stage.skip=
true;stage.load_rate=1}function release_thread(thread){thread.stageload_cb=null;thread.complete_load_cb=null;thread.stage_graph=null;thread.stages_queue=null}function is_finished(){var scheduler=get_scheduler();return scheduler.active_threads==0}exports.thread_is_finished=thread_is_finished;function thread_is_finished(thread){return thread&&(thread.status==THREAD_FINISHED||thread.status==THREAD_ABORTED)}exports.is_primary_loaded=function(data_id){var scheduler=get_scheduler();if(!scheduler)return false;
data_id=data_id|0;return scheduler.threads[data_id]&&(scheduler.threads[data_id].status==THREAD_FINISHED||scheduler.threads[data_id].status==THREAD_FINISHED_NO_RESOURCES)};exports.cleanup=function(){set_scheduler(null)}};b4w.module["__logic_nodes"]=function(exports,require){var m_obj=require("__objects");var m_scs=require("__scenes");var m_print=require("__print");var m_nla=require("__nla");var m_cfg=require("__config");var m_ctl=require("__controls");var m_util=require("__util");var m_anim=require("__animation");var m_assets=require("__assets");var m_batch=require("__batch");var m_geom=require("__geometry");var m_time=require("__time");var _logic_arr=[];var UNINITIALIZED=0;var INITIALIZATION=1;var RUNNING=2;var STOPPED=
3;var PAUSED=4;var _nodes_handlers={"ENTRYPOINT":entrypoint_handler,"HIDE":hide_object_handler,"SHOW":show_object_handler,"PAGEPARAM":pageparam_handler,"SELECT":select_handler,"PLAY":play_handler,"REDIRECT":redirect_handler,"MATH":math_handler,"CONDJUMP":conditional_jump_handler,"REGSTORE":regstore_handler,"PLAY_ANIM":play_anim_handler,"SELECT_PLAY":do_nothing_handler,"SEND_REQ":send_req_handler,"INHERIT_MAT":inherit_mat_handler,"SET_SHADER_NODE_PARAM":set_shader_node_param_handler,"DELAY":delay_handler,
"APPLY_SHAPE_KEY":apply_shape_key_handler,"OUTLINE":outline_handler};function do_nothing_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case INITIALIZATION:break;case RUNNING:thread_state.curr_node=node.slot_idx_order;break}}function unknown_node_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case INITIALIZATION:m_print.error("Unknown node type: "+node.type);break;case RUNNING:thread_state.curr_node=node.slot_idx_order;break}}exports.init_logic=
function(scene,data_id){var logic={data_id:data_id,scene_name:scene["name"],state:UNINITIALIZED,nla_in_play:false,no_nla_control:true,nla_thread:null,scene:scene,curr_thread:null,logic_threads:[]};scene._logic=logic;prepare_logic(scene,logic)};exports.update=function(timeline,elapsed){var start_time=m_nla.get_start_time();if(start_time<=0)return;for(var i=0;i<_logic_arr.length;i++)process_logic(i,timeline,elapsed,start_time)};function reset_play(thread){var script=thread.nodes;for(var i=0;i<script.length;i++){var node=
script[i];node.in_play=false}}function process_logic(index,timeline,elapsed,start_time){var logic=_logic_arr[index];for(var k=0;k<_logic_arr[index].logic_threads.length;k++){logic.curr_thread=_logic_arr[index].logic_threads[k];process_logic_thread(_logic_arr[index].logic_threads[k],logic,timeline,elapsed,start_time)}if(!logic.nla_in_play&&!logic.no_nla_control){var frame_offset=m_nla.get_frame_offset(logic.scene)-m_time.get_framerate()*elapsed;m_nla.set_frame_offset(logic.scene,frame_offset)}}function get_url_param(name){var url=
location.href.toString();if(url.indexOf("?")==-1)return 0;var params=url.split("?")[1].split("&");for(var i=0;i<params.length;i++){var param=params[i].split("=");if(param.length>1&&param[0]==name)return Number(param[1])}return 0}function get_object(node){return m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME_LIST,node.dupli_name_list,0)}function entrypoint_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case RUNNING:thread_state.curr_node=node.slot_idx_order;break}}
function hide_object_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case INITIALIZATION:node.obj=get_object(node);break;case RUNNING:m_scs.hide_object(node.obj);thread_state.curr_node=node.slot_idx_order;break}}function show_object_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case INITIALIZATION:node.obj=get_object(node);break;case RUNNING:m_scs.show_object(node.obj);thread_state.curr_node=node.slot_idx_order;break}}function pageparam_handler(node,
logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case RUNNING:thread_state.variables[node.vard]=get_url_param(node.param_name);thread_state.curr_node=node.slot_idx_order;break}}var gen_cb=function(){return function(obj,id,pulse,param){var node=param[0];var logic=param[1];var thread=param[2];for(var i=0;i<node.sel_objs_len;i++)if(m_ctl.get_sensor_value(obj,id,i)&&i==node.sel_obj_idx){if(logic.nla_in_play&&logic.nla_thread==node.thread)node.state=-1;else if(!(thread.thread_state.block_sel&&
!node.bools["no_wait"]))node.state=1;return}node.state=0}};function create_select_sensor(node,logic,thread){var obj=get_object(node);var sel_objs=m_obj.get_selectable_objects(logic.scene);var obj_idx=sel_objs.indexOf(obj);if(obj_idx==-1){m_print.error("logic script error: non-selectable object:",node["dupli_name_list"][node["dupli_name_list"].length-1]);return-1}node.state=-1;node.sel_objs_len=sel_objs.length;node.sel_obj_idx=obj_idx;var sel_sensors=[];for(var j=0;j<sel_objs.length;j++)sel_sensors.push(m_ctl.create_selection_sensor(sel_objs[j],
true));var select_cb=gen_cb();m_ctl.create_sensor_manifold(obj,"LOGIC_NODES_SELECT_"+node.label,m_ctl.CT_SHOT,sel_sensors,m_ctl.default_OR_logic_fun,select_cb,[node,logic,thread])}function select_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case INITIALIZATION:create_select_sensor(node,logic,logic.logic_threads[thread_state.thread_index]);break;case RUNNING:if(node.state>-1){thread_state.curr_node=node.state?node.slot_idx_jump:node.slot_idx_order;node.state=-1;
break}if(node.bools["not_wait"]){thread_state.curr_node=node.slot_idx_order;break}break}}function play_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case INITIALIZATION:logic.no_nla_control=false;break;case RUNNING:if(logic.nla_in_play&&!node.in_play){if(logic.curr_thread==logic.nla_thread)break;logic.nla_in_play=false;for(var i=0;i<logic.logic_threads.length;i++){var thread=logic.logic_threads[i];if(thread==logic.nla_thread)thread.thread_state.curr_node=thread.nodes[thread.thread_state.curr_node].slot_idx_order}reset_play(logic.nla_thread)}var cf=
m_nla.calc_curr_frame_scene(logic.scene._nla,timeline,false,start_time);if(!node.in_play){var frame_offset=m_nla.get_frame_offset(logic.scene)+(node.frame_start-cf);m_nla.set_frame_offset(logic.scene,frame_offset);node.in_play=true;logic.nla_thread=logic.curr_thread;logic.nla_in_play=true}else if(cf>=node.frame_end){node.in_play=false;logic.nla_in_play=false;logic.nla_thread=null;thread_state.curr_node=node.slot_idx_order}break}}function redirect_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case RUNNING:window.location.href=
node.url;logic.state=STOPPED;break}}function send_req_handler(node,logic,thread_state,timeline,elapsed,start_time){function asset_cb(loaded_data,uri,type,path,param){for(var prop in loaded_data)for(var ind in param[0].parse_resp_list)if(prop==param[0].parse_resp_list[ind])param[1][prop]=loaded_data[prop];param[0].state=1}switch(logic.state){case RUNNING:switch(node.state){case -1:node.state=0;m_assets.enqueue([[node.url,m_assets.AT_JSON,node.url,[node,thread_state.variables]]],asset_cb,null,null);
break;case 0:break;case 1:node.state=-1;thread_state.curr_node=node.slot_idx_order;break}break}}function inherit_mat_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case INITIALIZATION:for(var i=0;i<2;i++)node.objects["id"+i]=m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME_LIST,node.objects_paths["id"+i],0);break;case RUNNING:m_batch.inherit_material(node.objects["id0"],node.materials_names["id0"],node.objects["id1"],node.materials_names["id1"]);thread_state.curr_node=
node.slot_idx_order;break}}function delay_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case INITIALIZATION:break;case RUNNING:if(node.state==-1){node.state=0;node.timer=0;return}else if(node.state==0){node.timer+=elapsed;if(node.floats["dl"]<node.timer){node.state=-1;thread_state.curr_node=node.slot_idx_order}}break}}function apply_shape_key_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case INITIALIZATION:var obj=node.objects["id0"]=
m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME_LIST,node.objects_paths["id0"],0);var key=node.common_usage_names["sk"];if(!m_geom.check_shape_keys(obj)){m_print.error("No shape keys in object:",obj.name);node.mute=true}else if(!m_geom.has_shape_key(obj,key)){m_print.error("Wrong key name:",key);node.mute=true}break;case RUNNING:m_geom.apply_shape_key(node.objects["id0"],node.common_usage_names["sk"],node.bools["skv"]?thread_state.variables[node.vars["skv"]]:node.floats["skv"]);thread_state.curr_node=
node.slot_idx_order;break}}function outline_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case INITIALIZATION:var obj=node.objects["id0"]=m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME_LIST,node.objects_paths["id0"],0);if(!(obj&&obj.render&&obj.render.outlining)){m_print.error("Can't evaluate 'Outline' logic node: wrong object");node.mute=true}break;case RUNNING:var obj=node.objects["id0"];switch(node.common_usage_names["outline_operation"]){case "PLAY":var oa_set=
obj.render.outline_anim_settings_default;m_obj.apply_outline_anim(obj,oa_set.outline_duration,oa_set.outline_period,oa_set.outline_relapses);break;case "STOP":m_obj.clear_outline_anim(obj);break;case "INTENSITY":obj.render.outline_intensity=node.bools["in"]?thread_state.variables[node.vars["in"]]:node.floats["in"];break}thread_state.curr_node=node.slot_idx_order;break}}function set_shader_node_param_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case INITIALIZATION:if(node.objects_paths["id0"]){node.objects["id0"]=
m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME_LIST,node.objects_paths["id0"],0);node.nodes_paths["id0"].unshift(node.materials_names["id0"])}break;case RUNNING:if(node.shader_nd_type=="ShaderNodeRGB")m_obj.set_nodemat_rgb(node.objects["id0"],node.nodes_paths["id0"],node.bools["id0"]?thread_state.variables[node.vars["id0"]]:node.floats["id0"],node.bools["id1"]?thread_state.variables[node.vars["id1"]]:node.floats["id1"],node.bools["id2"]?thread_state.variables[node.vars["id2"]]:node.floats["id2"]);
if(node.shader_nd_type=="ShaderNodeValue")m_obj.set_nodemat_value(node.objects["id0"],node.nodes_paths["id0"],node.bools["id0"]?thread_state.variables[node.vars["id0"]]:node.floats["id0"]);thread_state.curr_node=node.slot_idx_order;break}}function math_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case RUNNING:var val1=node.var1==-1?node.num1:thread_state.variables[node.var1];var val2=node.var2==-1?node.num2:thread_state.variables[node.var2];switch(node.op){case "ADD":thread_state.variables[node.vard]=
val1+val2;break;case "MUL":thread_state.variables[node.vard]=val1*val2;break;case "SUB":thread_state.variables[node.vard]=val1-val2;break;case "DIV":if(val2==0)m_util.panic("Division by zero in Logic script");thread_state.variables[node.vard]=val1/val2;break}thread_state.curr_node=node.slot_idx_order;break}}function conditional_jump_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case RUNNING:var val1=node.var1==-1?node.num1:thread_state.variables[node.var1];var val2=
node.var2==-1?node.num2:thread_state.variables[node.var2];var cond_result=false;switch(node.cond){case "EQUAL":if(val1==val2)cond_result=true;break;case "NOTEQUAL":if(val1!=val2)cond_result=true;break;case "LESS":if(val1<val2)cond_result=true;break;case "GREATER":if(val1>val2)cond_result=true;break;case "LEQUAL":if(val1<=val2)cond_result=true;break;case "GEQUAL":if(val1>=val2)cond_result=true;break}if(cond_result)thread_state.curr_node=node.slot_idx_jump;else thread_state.curr_node=node.slot_idx_order;
break}}function regstore_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case RUNNING:thread_state.variables[node.vard]=node.num1;thread_state.curr_node=node.slot_idx_order;break}}function play_anim_handler(node,logic,thread_state,timeline,elapsed,start_time){var slot=m_anim.SLOT_ALL;if(!node.anim_name=="")slot=m_anim.SLOT_0;switch(logic.state){case INITIALIZATION:node.obj=get_object(node);break;case RUNNING:if(!m_anim.is_play(node.obj,slot))if(node.state==0)node.state=
1;switch(node.state){case -1:if(node.anim_name=="")m_anim.apply_def(node.obj);else m_anim.apply(node.obj,node.anim_name,slot);if(!node.bools["not_wait"])thread_state.block_sel=true;m_anim.set_behavior(node.obj,m_anim.AB_FINISH_STOP,slot);m_anim.set_first_frame(node.obj,slot);m_anim.play(node.obj,null,slot);node.state=0;break;case 0:if(node.bools["not_wait"]){thread_state.curr_node=node.slot_idx_order;node.state=-1}break;case 1:if(!node.bools["not_wait"])thread_state.block_sel=false;thread_state.curr_node=
node.slot_idx_order;node.state=-1;break;default:node.state=-1;break}break}}function process_logic_thread(thread,logic,timeline,elapsed,start_time){var script=thread.nodes;if(!script.length)return;for(var i=0;i<script.length;i++)script[i].processed=false;for(var i=0;i<script.length;i++){if(thread.thread_state.curr_node>=0)var node=script[thread.thread_state.curr_node];else return;if(node.processed)return;if(!node.mute){node.process_node(node,logic,thread.thread_state,timeline,elapsed,start_time);node.processed=
true}else if(node.type=="ENTRYPOINT")return;else{thread.thread_state.curr_node=node.slot_idx_order;node.processed=true;continue}}}function prepare_logic(scene,logic){var bpy_logic_threads=scene["b4w_logic_nodes"];var logic_threads=logic.logic_threads;logic.state=INITIALIZATION;for(var k=0;k<bpy_logic_threads.length;k++){var thread={nodes:[],thread_state:{scene:scene,curr_node:0,block_sel:false,thread_index:k,variables:{"R1":0,"R2":0,"R3":0,"R4":0,"R5":0,"R6":0,"R7":0,"R8":0}}};logic_threads.push(thread);
var logic_script=logic_threads[logic_threads.length-1];var subtree=bpy_logic_threads[k];for(var i=0;i<subtree.length;i++){var snode=subtree[i];var node={type:snode["type"],label:snode["label"],slot_idx_order:snode["slot_idx_order"],slot_idx_jump:snode["slot_idx_jump"],frame_start:snode["frame_range"][0],frame_end:snode["frame_range"][1],in_play:false,state:-1,sel_objs_len:-1,sel_obj_idx:-1,cond:snode["condition"],var1:snode["variable1"],var2:snode["variable2"],num1:snode["number1"],num2:snode["number2"],
vard:snode["variabled"],url:snode["url"],param_name:snode["param_name"],op:snode["operation"],mute:snode["mute"],dupli_name_list:snode["object"],obj:null,objects:{},anim_name:snode["anim_name"],parse_resp_list:snode["parse_resp_list"],objects_paths:snode["objects_paths"],nodes_paths:snode["nodes_paths"],floats:snode["floats"],bools:snode["bools"],vars:snode["variables"],materials_names:snode["materials_names"],shader_nd_type:snode["shader_nd_type"],common_usage_names:snode["common_usage_names"],thread:logic_script,
process_node:_nodes_handlers[snode.type]?_nodes_handlers[snode.type]:unknown_node_handler,processed:false,timer:0};logic_script.nodes.push(node)}for(var l=0;l<logic_script.nodes.length;l++){node=logic_script.nodes[l];node.process_node(node,logic,thread.thread_state,0,0)}}logic.state=RUNNING;_logic_arr.push(logic)}exports.cleanup=function(){_logic_arr=[]}};b4w.module["__nla"]=function(exports,require){var m_anim=require("__animation");var m_cam=require("__camera");var m_ctl=require("__controls");var m_cfg=require("__config");var m_lights=require("__lights");var m_loader=require("__loader");var m_obj=require("__objects");var m_obj_util=require("__obj_util");var m_print=require("__print");var m_scs=require("__scenes");var m_sfx=require("__sfx");var m_tex=require("__textures");var m_time=require("__time");var m_util=require("__util");var cfg_def=m_cfg.defaults;
var _nla_arr=[];var _start_time=-1;var CF_FREEZE_EPSILON=1E-6;exports.update_object=function(bpy_obj,obj){var sd=find_scene_data_for_nla(obj);if(sd){sd.obj_has_nla_on_scene=true;var slot_num=0;var adata=bpy_obj["animation_data"];if(adata&&adata["nla_tracks"].length){var nla_tracks=adata["nla_tracks"];if(m_obj_util.is_armature(obj)||m_obj_util.is_camera(obj)||m_obj_util.is_mesh(obj)||m_obj_util.is_empty(obj)||m_obj_util.is_lamp(obj)||m_obj_util.is_speaker(obj)){var nla_events=get_nla_events(nla_tracks,
slot_num);if(nla_events.length){obj.nla_events=obj.nla_events.concat(nla_events);slot_num++}}}if(bpy_obj_has_spk_param_nla(bpy_obj)){var nla_tracks=bpy_obj["data"]["animation_data"]["nla_tracks"];var nla_events=get_nla_events(nla_tracks,slot_num);if(nla_events.length){obj.nla_events=obj.nla_events.concat(nla_events);slot_num++}}if(m_obj_util.is_mesh(obj)){var materials=bpy_obj["data"]["materials"];for(var j=0;j<materials.length;j++){var mat=materials[j];if(mat["use_nodes"]&&mat["node_tree"]){var nla_tracks=
[];get_nodetree_nla_tracks_r(mat["node_tree"],nla_tracks);var nla_events=get_nla_events(nla_tracks,slot_num);if(nla_events.length){slot_num+=assign_anim_slots(nla_events,slot_num);obj.nla_events=obj.nla_events.concat(nla_events)}}}}for(var j=0;j<bpy_obj["particle_systems"].length;j++){var psys=bpy_obj["particle_systems"][j];var pset=psys["settings"];if(pset["type"]=="EMITTER"&&pset["b4w_allow_nla"]){var ev=init_event();ev.type="CLIP";ev.frame_start=sd.scene["frame_start"];ev.frame_end=sd.scene["frame_end"]+
1;ev.anim_name=psys["name"];ev.anim_slot=slot_num;ev.action_frame_start=ev.frame_start;ev.action_frame_end=ev.frame_end;obj.nla_events.push(ev);slot_num++}}var slot_num_va=slot_num+1;for(var j=0;j<obj.vertex_anim.length;j++){var va=obj.vertex_anim[j];if(va.allow_nla){slot_num=slot_num_va;var ev=init_event();ev.type="CLIP";ev.frame_start=sd.scene["frame_start"];ev.frame_end=sd.scene["frame_end"]+1;ev.anim_name=va.name;ev.anim_slot=slot_num;ev.action_frame_start=ev.frame_start;ev.action_frame_end=ev.frame_end;
obj.nla_events.push(ev)}}}};function find_scene_data_for_nla(obj){var scene_data=null;for(var i=obj.scenes_data.length-1;i>=0;i--){var sd=obj.scenes_data[i];if(scene_use_nla(sd.scene)){scene_data=sd;if(sd.scene._is_main)break}}return scene_data}exports.update_scene=function(scene,is_cyclic,data_id){if(!scene._nla)scene._nla={frame_start:scene["frame_start"],frame_end:scene["frame_end"],frame_offset:0,last_frame:-1,range_end:scene["frame_end"],range_start:scene["frame_start"],user_callback:null,cyclic:is_cyclic,
objects:[],textures:[],scene_name:scene["name"],is_stopped:false,force_update:false,rewinded_to_start:true};var nla=scene._nla;var objs=m_obj.get_scene_objs_derived(scene,"ALL",data_id);for(var i=0;i<objs.length;i++){var obj=objs[i];if(obj.nla_events.length){for(var j=0;j<obj.scenes_data.length;j++){var sd=obj.scenes_data[j];if(sd.scene==scene&&sd.obj_has_nla_on_scene)nla.objects.push(obj)}enforce_nla_consistency(obj.nla_events,nla,obj.name);calc_nla_extents(obj.nla_events,nla)}}var textures=scene._render.video_textures;
for(var i=0;i<textures.length;i++){var texture=textures[i]._render;if(texture.use_nla&&(texture.video_file||texture.seq_video)&&texture.vtex_data_id==data_id){var ev=init_event();ev.type="VIDEO";if(texture.use_cyclic){ev.frame_start=0;ev.frame_end=nla.frame_end}else{ev.frame_start=m_util.clamp(texture.frame_start,0,nla.frame_end);ev.frame_end=m_util.clamp(texture.frame_start+texture.frame_duration,0,nla.frame_end)}ev.anim_name=textures[i].name;texture._nla_tex_event=ev;nla.textures.push(texture);
if(texture.video_file)texture.video_file.oncanplay=function(){m_tex.update_video_texture(texture)}}}_nla_arr.push(nla)};function enforce_nla_consistency(nla_events,nla,name){for(var i=0;i<nla_events.length;i++){var ev=nla_events[i];var strip_str=name+" ["+ev.frame_start+":"+ev.frame_end+"]";var event_frame_start=Math.max(nla.frame_start,ev.frame_start);ev.action_frame_start+=event_frame_start-ev.frame_start;ev.frame_start=event_frame_start;ev.frame_end=Math.min(nla.frame_end+1,ev.frame_end);if(ev.frame_start>
ev.frame_end){m_print.warn("NLA: out of scene range: "+strip_str);nla_events.splice(i,1);i--;continue}if(!ev.anim_name&&ev.type=="CLIP"){m_print.warn('NLA: no action in strip for object "'+name+'".');nla_events.splice(i,1);i--}}}function calc_nla_extents(nla_events,nla){for(var i=0;i<nla_events.length;i++){var ev=nla_events[i];var ext_frame_start=nla.frame_start;var ext_frame_end=nla.frame_end+1;for(var k=0;k<nla_events.length;k++){var ev_k=nla_events[k];if(ev.anim_slot!=ev_k.anim_slot)continue;if(ev_k.frame_end<=
ev.frame_start)ext_frame_start=ev.frame_start;if(ev_k.frame_start>=ev.frame_end)ext_frame_end=Math.min(ext_frame_end,ev_k.frame_start)}ev.ext_frame_start=ext_frame_start;ev.ext_frame_end=ext_frame_end}}function assign_anim_slots(nla_events,start_slot){var actions=m_anim.get_all_actions();var fc_usage=[];var num_assigned_slots=0;for(var i=0;i<nla_events.length;i++){var ev=nla_events[i];if(ev.anim_uuid!="")var action=m_util.keysearch("uuid",ev.anim_uuid,actions);else{var name=ev.anim_name;var action=
m_util.keysearch("name",name,actions)||m_util.keysearch("name",name+"_B4W_BAKED",actions)}if(!action)continue;var fcurves=action["fcurves"];var cur_fcurves_names=[];for(var fcurve in fcurves)cur_fcurves_names.push(fcurve);fc_usage.push(cur_fcurves_names)}for(var i=0;i<fc_usage.length;i++){var have_common_fc=false;for(var k=0;k<i;k++)if(m_util.arrays_have_common(fc_usage[i],fc_usage[k])){nla_events[i].anim_slot=nla_events[k].anim_slot;have_common_fc=true;break}if(!have_common_fc)nla_events[i].anim_slot=
start_slot+num_assigned_slots++}return num_assigned_slots}function init_event(){var ev={type:"CLIP",frame_start:0,frame_end:0,scheduled:false,paused:false,anim_name:"",anim_uuid:"",anim_slot:0,action_frame_start:0,action_frame_end:0,ext_frame_start:0,ext_frame_end:0,use_reverse:false,scale:1,repeat:1};return ev}function get_nodetree_nla_tracks_r(node_tree,container){if(node_tree["animation_data"]){var anim_data=node_tree["animation_data"];var nla_tracks=anim_data["nla_tracks"];if(nla_tracks)for(var i=
0;i<nla_tracks.length;i++)container.push(nla_tracks[i])}var nodes=node_tree["nodes"];for(var i=0;i<nodes.length;i++){var node=nodes[i];if(node["node_group"]){var g_node_tree=node["node_group"]["node_tree"];if(g_node_tree)get_nodetree_nla_tracks_r(g_node_tree,container)}}}exports.start=function(){_start_time=0};exports.get_start_time=function(){return _start_time};exports.get_frame_offset=function(scene){if(scene._nla)return scene._nla.frame_offset;return null};exports.set_frame_offset=function(scene,
frame_offset){if(scene._nla){scene._nla.frame_offset=frame_offset;return true}return false};exports.update=function(timeline,elapsed){if(_start_time<0)return;else if(_start_time==0)_start_time=timeline;for(var i=0;i<_nla_arr.length;i++){var nla=_nla_arr[i];if(nla.is_stopped)nla.frame_offset-=m_time.get_framerate()*elapsed;var cf=calc_curr_frame_scene(nla,timeline,true,_start_time);if((!nla.is_stopped||nla.force_update)&&cf>=nla.range_end)if(nla.cyclic)cf=nla_range_end_rewind(nla,timeline);else nla_range_end_stop(nla,
cf);if(!nla.is_stopped||nla.force_update){process_nla_objects(nla,cf,elapsed);process_nla_video_textures(timeline,nla,cf);nla.last_frame=cf}nla.force_update=false;nla.rewinded_to_start=false}};function nla_range_end_stop(nla,curr_frame){nla.is_stopped=true;nla.frame_offset-=curr_frame-nla.range_end;if(nla.user_callback)nla.user_callback()}function nla_range_end_rewind(nla,timeline){if(nla.user_callback)nla.user_callback();set_frame(nla.range_start,timeline);nla.rewinded_to_start=true;return calc_curr_frame_scene(nla,
timeline,true,_start_time)}function process_nla_objects(nla,curr_frame,elapsed){for(var i=0;i<nla.objects.length;i++){var obj=nla.objects[i];var nla_events=obj.nla_events;for(var j=0;j<nla_events.length;j++){var ev=nla_events[j];if(ev.type=="SOUND"&&curr_frame<nla.last_frame-CF_FREEZE_EPSILON)ev.scheduled=false}for(var j=0;j<nla_events.length;j++){var ev=nla_events[j];switch(ev.type){case "CLIP":if(ev.ext_frame_start<=curr_frame&&curr_frame<ev.ext_frame_end)if(!ev.scheduled){process_clip_event_start(obj,
ev,curr_frame,elapsed);for(var k=0;k<nla_events.length;k++)if(nla_events[k]!=ev&&nla_events[k].anim_slot==ev.anim_slot)nla_events[k].scheduled=false;ev.scheduled=true}if(ev.scheduled)process_clip_event(obj,ev,curr_frame,elapsed);break;case "SOUND":if((curr_frame<nla.last_frame-CF_FREEZE_EPSILON||nla.last_frame<ev.frame_start)&&ev.frame_start<=curr_frame&&curr_frame<ev.frame_end)if(!ev.scheduled){process_sound_event(obj,ev,curr_frame);ev.scheduled=true}if(nla.last_frame<ev.frame_end&&ev.frame_end<=
curr_frame)if(ev.scheduled)ev.scheduled=false;break;default:break}}}}function process_nla_video_textures(timeline,nla,nla_frame){for(var i=0;i<nla.textures.length;i++){var tex=nla.textures[i];var ev=tex._nla_tex_event;if(!tex.video_file&&!tex.seq_video)continue;var need_update=false;var video_frame=get_video_frame_clamped(nla_frame,tex);var seq_video_frame=m_tex.video_frame_to_seq_frame(tex,video_frame);if(seq_video_frame==tex.seq_movie_length)seq_video_frame--;if(nla.force_update||nla.rewinded_to_start){if(tex.video_file)m_tex.set_frame_video(tex.name,
video_frame,tex.vtex_data_id);else m_tex.set_frame_video(tex.name,seq_video_frame,tex.vtex_data_id);need_update=true}if(!nla.is_stopped){if(tex.use_cyclic)if(tex.video_file){if(video_frame==tex.frame_offset){m_tex.set_frame_video(tex.name,tex.frame_offset,tex.vtex_data_id);need_update=true}}else{var seq_frame_offset=m_tex.video_frame_to_seq_frame(tex,tex.frame_offset);if(seq_video_frame==seq_frame_offset){m_tex.set_frame_video(tex.name,seq_video_frame,tex.vtex_data_id);need_update=true}}var need_play=
frame_need_play_video(nla_frame,tex);var is_played=m_tex.video_is_played(tex);if(need_play&&!is_played){m_tex.play_video(tex.name,tex.vtex_data_id);if(tex.seq_video)need_update=true}else if(is_played&&!need_play)if(tex.video_file){var native_frame=Math.round(tex.video_file.currentTime*tex.fps);if(native_frame<video_frame)need_update=true;else m_tex.pause_video(tex.name,tex.vtex_data_id)}else m_tex.pause_video(tex.name,tex.vtex_data_id);else if(is_played&&need_play)need_update=true}if(m_tex.video_update_is_available(tex)&&
need_update)if(tex.video_file)m_tex.update_video_texture(tex);else{var mark=m_tex.seq_video_get_discrete_timemark(tex,timeline);if(mark!=tex.seq_last_discrete_mark){tex.seq_cur_frame=seq_video_frame;m_tex.update_seq_video_texture(tex)}tex.seq_last_discrete_mark=mark}}}function get_video_frame_clamped(nla_frame,vtex){var ev=vtex._nla_tex_event;var video_frame=nla_frame_to_video_frame(nla_frame,vtex);return m_util.clamp(video_frame,vtex.frame_offset,vtex.frame_offset+m_tex.video_get_duration(vtex)-
1)}function nla_frame_to_video_frame(nla_frame,vtex){var frame_delta=Math.round(nla_frame)-vtex.frame_start;if(vtex.use_cyclic){frame_delta=frame_delta%vtex.frame_duration;if(frame_delta<0)frame_delta+=vtex.frame_duration}return vtex.frame_offset+frame_delta}function frame_need_play_video(cf,vtex){var ev=vtex._nla_tex_event;var frame=nla_frame_to_video_frame(cf,vtex);return vtex.frame_offset<=frame&&frame<=vtex.frame_offset+m_tex.video_get_duration(vtex)}function pause_scheduled_objects(objects){for(var i=
0;i<objects.length;i++){var obj=objects[i];var nla_events=obj.nla_events;for(var j=0;j<nla_events.length;j++){var ev=nla_events[j];if(ev.scheduled&&!ev.paused){process_event_pause(obj);ev.paused=true}}}}function resume_scheduled_objects(objects){for(var i=0;i<objects.length;i++){var obj=objects[i];var nla_events=obj.nla_events;for(var j=0;j<nla_events.length;j++){var ev=nla_events[j];if(ev.paused){process_event_resume(obj);ev.paused=false}}}}function calc_curr_frame_scene(nla,timeline,allow_repeat,
start_time){var cf=(timeline-start_time)*m_time.get_framerate()+nla.frame_offset;if(cf>nla.frame_start){cf-=nla.frame_start;if(nla.cyclic&&allow_repeat){var stride=nla.frame_end-nla.frame_start+1;cf%=stride}cf+=nla.frame_start}return cf}exports.calc_curr_frame_scene=calc_curr_frame_scene;function process_clip_event_start(obj,ev,frame,elapsed){if(ev.anim_uuid!="")m_anim.apply_by_uuid(obj,ev.anim_uuid,ev.anim_slot);else m_anim.apply(obj,ev.anim_name,ev.anim_slot);m_anim.set_behavior(obj,m_anim.AB_FINISH_STOP,
ev.anim_slot);var action_frame=get_curr_frame_strip(ev.frame_start,ev);m_anim.set_frame(obj,action_frame,ev.anim_slot)}function process_clip_event(obj,ev,frame,elapsed){var new_anim_frame=get_curr_frame_strip(frame,ev);var curr_anim_frame=m_anim.get_current_frame_float(obj,ev.anim_slot);if(Math.abs(new_anim_frame-curr_anim_frame)>CF_FREEZE_EPSILON)m_anim.set_frame(obj,new_anim_frame,ev.anim_slot)}function get_curr_frame_strip(frame,ev){frame=m_util.clamp(frame,ev.frame_start,ev.frame_end);var track_frame=
frame-ev.frame_start;var track_len=(ev.frame_end-ev.frame_start)/ev.repeat;var action_cur_frame=track_frame%track_len;if(track_frame/track_len&&track_frame%track_len==0)var action_frame=ev.action_frame_end;else var action_frame=ev.action_frame_start+action_cur_frame/ev.scale;if(ev.use_reverse)action_frame=ev.action_frame_end-action_frame+ev.action_frame_start;return action_frame}function process_sound_event(obj,ev,frame){var when=(ev.frame_start-frame)/m_time.get_framerate();var duration=(ev.frame_end-
ev.frame_start)/m_time.get_framerate();m_sfx.play(obj,when,duration)}exports.cleanup=function(){_nla_arr.length=0;_start_time=-1};function get_nla_events(nla_tracks,anim_slot_num){var nla_events=[];for(var i=0;i<nla_tracks.length;i++){var track=nla_tracks[i];var strips=track["strips"];if(!strips)continue;for(var j=0;j<strips.length;j++){var strip=strips[j];var ev=init_event();ev.type=strip["type"];ev.frame_start=strip["frame_start"];ev.frame_end=strip["frame_end"];ev.anim_slot=anim_slot_num;ev.action_frame_start=
strip["action_frame_start"];ev.action_frame_end=strip["action_frame_end"];ev.use_reverse=strip["use_reverse"];ev.scale=strip["scale"];ev.repeat=strip["repeat"];if(strip["action"]){ev.anim_name=strip["action"]["name"];ev.anim_uuid=strip["action"]["uuid"]}nla_events.push(ev)}}return nla_events}exports.bpy_obj_has_nla=function(bpy_obj){var adata=bpy_obj["animation_data"];if(adata&&adata["nla_tracks"].length||bpy_obj_has_spk_param_nla(bpy_obj)||bpy_obj_has_nodemats_nla(bpy_obj))return true;else return false};
function bpy_obj_has_spk_param_nla(bpy_obj){if(bpy_obj["type"]=="SPEAKER"&&bpy_obj["data"]["animation_data"]&&bpy_obj["data"]["animation_data"]["nla_tracks"].length)return true;else return false}function bpy_obj_has_nodemats_nla(bpy_obj){if(bpy_obj["type"]!="MESH"||!bpy_obj["data"])return false;var materials=bpy_obj["data"]["materials"];if(!materials)return false;for(var j=0;j<materials.length;j++){var mat=materials[j];var node_tree=mat["node_tree"];if(mat["use_nodes"]&&node_tree)if(check_nodetree_nla_tracks_r(node_tree))return true}return false}
function check_nodetree_nla_tracks_r(node_tree,container){if(node_tree["animation_data"]){var anim_data=node_tree["animation_data"];var nla_tracks=anim_data["nla_tracks"];if(nla_tracks&&nla_tracks.length)return true}var nodes=node_tree["nodes"];for(var i=0;i<nodes.length;i++){var node=nodes[i];if(node["node_group"]){var g_node_tree=node["node_group"]["node_tree"];if(g_node_tree)check_nodetree_nla_tracks_r(g_node_tree,container)}}return false}exports.scene_use_nla=scene_use_nla;function scene_use_nla(bpy_scene){return bpy_scene["b4w_use_nla"]||
bpy_scene["b4w_use_logic_editor"]}exports.set_frame=set_frame;function set_frame(frame,timeline){var active_scene=m_scs.get_active();if(active_scene._nla){var cf=calc_curr_frame_scene(active_scene._nla,timeline,true,_start_time);active_scene._nla.frame_offset-=cf-frame;active_scene._nla.force_update=true}}exports.get_frame=get_frame;function get_frame(timeline){var active_scene=m_scs.get_active();if(active_scene._nla)return calc_curr_frame_scene(active_scene._nla,timeline,true,_start_time);else return-1}
exports.stop_nla=stop_nla;function stop_nla(){var active_scene=m_scs.get_active();if(active_scene._nla)active_scene._nla.is_stopped=true;var vtexs=active_scene._nla.textures;for(var i=0;i<vtexs.length;i++){var vtex=vtexs[i];m_tex.pause_video(vtex.name,vtex.vtex_data_id)}}exports.play_nla=play_nla;function play_nla(callback){var active_scene=m_scs.get_active();if(active_scene._nla){active_scene._nla.is_stopped=false;if(callback)active_scene._nla.user_callback=callback;else active_scene._nla.user_callback=
null}}exports.get_frame_start=function(){var active_scene=m_scs.get_active();if(active_scene._nla)return active_scene._nla.frame_start;else return-1};exports.get_frame_end=function(){var active_scene=m_scs.get_active();if(active_scene._nla)return active_scene._nla.frame_end;else return-1};exports.is_play=function(){var active_scene=m_scs.get_active();if(active_scene._nla)return!active_scene._nla.is_stopped;else return false};exports.check_nla=function(){var active_scene=m_scs.get_active();if(active_scene._nla)return active_scene["b4w_use_nla"];
else return false};exports.check_logic_nodes=function(){var active_scene=m_scs.get_active();if(active_scene._nla)return active_scene["b4w_logic_nodes"].length>0;else return false};exports.set_range=function(start_frame,end_frame){var active_scene=m_scs.get_active();if(active_scene._nla){active_scene._nla.range_start=start_frame;active_scene._nla.range_end=end_frame}else return false};exports.reset_range=reset_range;function reset_range(){var active_scene=m_scs.get_active();if(active_scene._nla){var nla=
active_scene._nla;nla.range_start=nla.frame_start;nla.range_end=nla.frame_end}else return false}exports.set_cyclic=function(is_cyclic){var active_scene=m_scs.get_active();if(active_scene._nla)active_scene._nla.cyclic=is_cyclic;else return false};exports.clear_callback=function(){var active_scene=m_scs.get_active();if(active_scene._nla)active_scene._nla.user_callback=null}};b4w.module["__camera"]=function(exports,require){var m_bounds=require("__boundings");var m_cfg=require("__config");var m_cons=require("__constraints");var m_cont=require("__container");var m_mat3=require("__mat3");var m_mat4=require("__mat4");var m_obj_util=require("__obj_util");var m_print=require("__print");var m_quat=require("__quat");var m_scenes=require("__scenes");var m_trans=require("__transform");var m_util=require("__util");var m_vec3=require("__vec3");var m_vec4=require("__vec4");var cfg_ctl=
m_cfg.controls;var cfg_def=m_cfg.defaults;exports.TYPE_NONE=10;exports.TYPE_PERSP=20;exports.TYPE_ORTHO=30;exports.TYPE_PERSP_ASPECT=40;exports.TYPE_ORTHO_ASPECT=50;exports.TYPE_ORTHO_ASYMMETRIC=60;exports.TYPE_STEREO_LEFT=70;exports.TYPE_STEREO_RIGHT=80;exports.MS_STATIC=0;exports.MS_TARGET_CONTROLS=2;exports.MS_EYE_CONTROLS=3;exports.MS_HOVER_CONTROLS=4;var STEREO_CONV_DIST=3*2;var STEREO_EYE_DIST=.065;var DEF_WATER_PLANE_Y=-.05;var DEF_ORTHO_SCALE=2.5;var DEF_PERSP_FOV=40;var DEF_PERSP_NEAR=.1;
var DEF_PERSP_FAR=1E3;var MAX_HOVER_INIT_ANGLE=Math.PI/180/2;var _vec2_tmp=new Float32Array(2);var _vec2_tmp2=new Float32Array(2);var _vec3_tmp=new Float32Array(3);var _vec3_tmp2=new Float32Array(3);var _vec3_tmp3=new Float32Array(3);var _quat4_tmp=new Float32Array(4);var _quat4_tmp2=new Float32Array(4);var _vec4_tmp=new Float32Array(4);var _vec4_tmp2=new Float32Array(4);var _mat3_tmp=new Float32Array(16);var _mat4_tmp=new Float32Array(16);var _frustum_corners_tmp=new Float32Array(24);exports.camera_object_to_camera=
function(bpy_camobj,camobj){var render=camobj.render;var camobj_data=bpy_camobj["data"];switch(camobj_data["type"]){case "PERSP":var cam=create_camera(exports.TYPE_PERSP);if(camobj_data["angle_y"])var fov=camobj_data["angle_y"]/Math.PI*180;set_frustum(cam,fov,camobj_data["clip_start"],camobj_data["clip_end"]);break;case "ORTHO":var cam=create_camera(exports.TYPE_ORTHO);var top_bound=camobj_data["ortho_scale"]/2;set_frustum(cam,top_bound,camobj_data["clip_start"],camobj_data["clip_end"]);break}cam.name=
camobj.name;render.underwater=false;render.move_style=move_style_bpy_to_b4w(camobj_data["b4w_move_style"]);render.dof_distance=camobj_data["dof_distance"];var dof_obj=camobj_data["dof_object"];render.dof_object=dof_obj?dof_obj._object:null;render.dof_front=camobj_data["b4w_dof_front"];render.dof_rear=camobj_data["b4w_dof_rear"];render.dof_power=camobj_data["b4w_dof_power"];render.enable_hover_hor_rotation=camobj_data["b4w_enable_hover_hor_rotation"];render.cameras=[cam];render.velocity_trans=camobj_data["b4w_trans_velocity"];
render.velocity_rot=camobj_data["b4w_rot_velocity"];render.velocity_zoom=camobj_data["b4w_zoom_velocity"];if(render.move_style==exports.MS_TARGET_CONTROLS){render.pivot.set(camobj_data["b4w_target"]);update_camera_upside_down(camobj)}prepare_clamping_limits(camobj);if(render.move_style===exports.MS_HOVER_CONTROLS)init_hover_camera(camobj);if(cam.type==exports.TYPE_ORTHO)init_ortho_props(camobj)};function init_hover_camera(camobj){var render=camobj.render;if(render.use_distance_limits){init_hover_pivot(camobj);
var angles=get_camera_angles(camobj,_vec2_tmp);var ret_angle=m_util.calc_returning_angle(angles[1],render.hover_angle_limits.up,render.hover_angle_limits.down);if(angles[1]>0)m_print.warn("Active hover camera has wrong orientation");if(ret_angle)rotate_hover_camera(camobj,0,ret_angle);else hover_camera_update_distance(camobj)}else render.enable_hover_hor_rotation=false}function init_hover_pivot(camobj){var bpy_camobj=camobj.temp_bpy_obj;var render=camobj.render;var view_vector=m_util.quat_to_dir(render.quat,
m_util.AXIS_MY,_vec3_tmp);var normal_plane_oxy=_vec4_tmp;normal_plane_oxy.set(m_util.AXIS_Y);normal_plane_oxy[3]=0;var res=m_util.line_plane_intersect(normal_plane_oxy,-bpy_camobj["data"]["b4w_hover_zero_level"],render.trans,view_vector,render.hover_pivot);var theta=get_camera_angles(camobj,_vec2_tmp)[1];if(!res||Math.abs(theta)<MAX_HOVER_INIT_ANGLE){m_print.warn("Active hover camera view vector and the supporting plane "+"are parallel to each other. Set hover pivot based on the "+"camera position.");
render.hover_pivot[0]=render.trans[0];render.hover_pivot[1]=0;render.hover_pivot[2]=render.trans[2]}}exports.init_ortho_props=init_ortho_props;function init_ortho_props(camobj){var render=camobj.render;switch(render.move_style){case exports.MS_TARGET_CONTROLS:render.init_dist=m_vec3.dist(render.trans,render.pivot);render.init_top=render.cameras[0].top;break;case exports.MS_HOVER_CONTROLS:if(render.use_distance_limits){render.init_dist=m_vec3.dist(render.trans,render.hover_pivot);render.init_top=render.cameras[0].top}break}}
function init_camera(type){var cam={type:type,name:"",size_mult:1,width:0,height:0,framebuffer:null,color_attachment:null,depth_attachment:null,aspect:0,fov:0,near:0,far:0,left:0,right:0,top:0,bottom:0,eye:new Float32Array(3),eye_last:new Float32Array(3),quat:new Float32Array(4),view_matrix:new Float32Array(16),billboard_view_matrix:new Float32Array(16),proj_matrix:new Float32Array(16),view_proj_inv_matrix:new Float32Array(16),prev_view_proj_matrix:new Float32Array(16),sky_vp_inv_matrix:new Float32Array(16),
shadow_cast_billboard_view_matrix:new Float32Array(16),view_proj_matrix:new Float32Array(16),dof_distance:0,dof_front:0,dof_rear:0,dof_power:0,dof_object:null,dof_on:0,frustum_planes:create_frustum_planes(),stereo_conv_dist:0,stereo_eye_dist:0,reflection_plane:null,csm_centers:null,csm_radii:null,csm_center_dists:new Float32Array(4),pcf_blur_radii:new Float32Array(4)};return cam}exports.create_frustum_planes=create_frustum_planes;function create_frustum_planes(){var frustum_planes={left:new Float32Array([0,
0,0,0]),right:new Float32Array([0,0,0,0]),top:new Float32Array([0,0,0,0]),bottom:new Float32Array([0,0,0,0]),near:new Float32Array([0,0,0,0]),far:new Float32Array([0,0,0,0])};return frustum_planes}function move_style_bpy_to_b4w(bpy_move_style){switch(bpy_move_style){case "STATIC":return exports.MS_STATIC;break;case "TARGET":return exports.MS_TARGET_CONTROLS;break;case "EYE":return exports.MS_EYE_CONTROLS;break;case "HOVER":return exports.MS_HOVER_CONTROLS;break;default:throw"Unknown move style";}}
exports.create_camera=create_camera;function create_camera(type){var cam=init_camera(type);if(type==exports.TYPE_NONE)return cam;switch(type){case exports.TYPE_PERSP:set_frustum(cam,DEF_PERSP_FOV,DEF_PERSP_NEAR,DEF_PERSP_FAR);break;case exports.TYPE_ORTHO:set_frustum(cam,DEF_ORTHO_SCALE,DEF_PERSP_NEAR,DEF_PERSP_FAR);break;case exports.TYPE_PERSP_ASPECT:break;case exports.TYPE_ORTHO_ASPECT:break;case exports.TYPE_ORTHO_ASYMMETRIC:break;case exports.TYPE_STEREO_LEFT:case exports.TYPE_STEREO_RIGHT:throw"Stereo camera may only be created from perspective one";
break;default:throw"Unknown camera type";break}return cam}exports.check_attachment=function(cam,type){switch(type){case "COLOR":case "CUBEMAP":return Boolean(cam.color_attachment);case "DEPTH":return Boolean(cam.depth_attachment);case "SCREEN":return!Boolean(cam.color_attachment)&&!Boolean(cam.depth_attachment);default:throw"Wrong attachment type: "+type;break}};exports.set_attachment=function(cam,type,tex){switch(type){case "COLOR":case "CUBEMAP":cam.color_attachment=tex;break;case "DEPTH":cam.depth_attachment=
tex;break;case "SCREEN":cam.color_attachment=null;cam.depth_attachment=null;break;default:throw"Wrong attachment type: "+type;break}};exports.get_attachment=function(cam,type){switch(type){case "COLOR":case "CUBEMAP":return cam.color_attachment;case "DEPTH":return cam.depth_attachment;case "SCREEN":return null;default:throw"Wrong attachment type: "+type;break}};exports.make_stereo=function(cam,type){if(!(cam.type==exports.TYPE_PERSP&&(type==exports.TYPE_STEREO_LEFT||type==exports.TYPE_STEREO_RIGHT)))throw"make_stereo(): wrong camera type";
cam.type=type;set_stereo_params(cam,STEREO_CONV_DIST,STEREO_EYE_DIST)};exports.set_stereo_params=set_stereo_params;function set_stereo_params(cam,conv_dist,eye_dist){if(!(cam.type==exports.TYPE_STEREO_LEFT||cam.type==exports.TYPE_STEREO_RIGHT))throw"set_stereo_params(): wrong camera type";cam.stereo_conv_dist=conv_dist;cam.stereo_eye_dist=eye_dist;set_projection(cam,cam.aspect);if(m_scenes.check_active()){var active_scene=m_scenes.get_active();var sh_params=active_scene._render.shadow_params;if(sh_params){var upd_cameras=
m_scenes.get_camera(active_scene).render.cameras;for(var i=0;i<upd_cameras.length;i++)update_camera_shadows(upd_cameras[i],sh_params)}}}exports.get_camera_angles=get_camera_angles;function get_camera_angles(cam,dest){return get_camera_angles_from_quat(cam.render.quat,dest)}exports.get_camera_angles_from_quat=get_camera_angles_from_quat;function get_camera_angles_from_quat(quat,dest){var y_world_cam=m_util.quat_to_dir(quat,m_util.AXIS_Y,_vec3_tmp);var z_world_cam=m_util.quat_to_dir(quat,m_util.AXIS_Z,
_vec3_tmp2);var base_theta=-Math.asin(y_world_cam[1]/m_vec3.length(y_world_cam));if(Math.abs(base_theta)>Math.PI/4)var phi_dir=m_vec3.scale(z_world_cam,-m_util.sign(base_theta),_vec3_tmp3);else var phi_dir=m_vec3.scale(y_world_cam,-m_util.sign(z_world_cam[1]),_vec3_tmp3);var base_phi=Math.atan(Math.abs(phi_dir[0]/phi_dir[2]));var theta=base_theta;if(z_world_cam[1]>0)theta=m_util.sign(theta)*Math.PI-theta;var phi=base_phi;if(phi_dir[2]<0)phi=Math.PI-phi;if(phi_dir[0]<0)phi=2*Math.PI-phi;dest[0]=phi;
dest[1]=theta;return dest}exports.get_camera_angles_char=function(cam,dest){get_camera_angles(cam,dest);dest[0]=m_util.angle_wrap_0_2pi(dest[0]+Math.PI);dest[1]*=-1;return dest};exports.get_angles=get_angles;function get_angles(cam,dest){var render=cam.render;var y_world_cam=m_util.quat_to_dir(render.quat,m_util.AXIS_MY,_vec3_tmp);var theta=Math.asin(y_world_cam[1]/m_vec3.length(y_world_cam));if(y_world_cam[0]==0&&y_world_cam[2]==0)var phi=0;else if(Math.abs(theta)>Math.PI/4){if(theta<=0)var z_world_cam=
m_util.quat_to_dir(render.quat,m_util.AXIS_MZ,_vec3_tmp2);else var z_world_cam=m_util.quat_to_dir(render.quat,m_util.AXIS_Z,_vec3_tmp2);var phi=Math.atan(Math.abs(z_world_cam[0]/z_world_cam[2]));if(z_world_cam[2]>0)phi=Math.PI-phi;if(z_world_cam[0]>0)phi=2*Math.PI-phi}else{var phi=Math.atan(Math.abs(y_world_cam[0]/y_world_cam[2]));if(y_world_cam[2]>0)phi=Math.PI-phi;if(y_world_cam[0]>0)phi=2*Math.PI-phi}dest[0]=phi;dest[1]=theta;return dest}exports.set_frustum=set_frustum;function set_frustum(cam,
v_fov_or_top,near,far,h_fov_or_right){switch(cam.type){case exports.TYPE_PERSP:case exports.TYPE_STEREO_LEFT:case exports.TYPE_STEREO_RIGHT:cam.fov=v_fov_or_top;cam.aspect=1;break;case exports.TYPE_ORTHO:cam.top=v_fov_or_top;cam.aspect=1;break;case exports.TYPE_PERSP_ASPECT:delete cam.fov;cam.fov=v_fov_or_top;cam.aspect=h_fov_or_right/v_fov_or_top;break;case exports.TYPE_ORTHO_ASPECT:cam.top=v_fov_or_top;cam.aspect=h_fov_or_right/v_fov_or_top;break;default:m_print.error("set_frustum(): Unsupported camera type: "+
cam.type);break}cam.near=near;cam.far=far}exports.set_frustum_asymmetric=set_frustum_asymmetric;function set_frustum_asymmetric(cam,left,right,bottom,top,near,far){switch(cam.type){case exports.TYPE_ORTHO_ASYMMETRIC:cam.left=left;cam.right=right;cam.bottom=bottom;cam.top=top;cam.near=near;cam.far=far;break;default:m_print.error("set_frustum_asymmetric(): "+"Unsupported camera type: "+cam.type);break}}exports.get_move_style=get_move_style;function get_move_style(camobj){return camobj.render.move_style}
exports.set_view=set_view;function set_view(cam,camobj){var trans=camobj.render.trans;var quat=camobj.render.quat;var wm=_mat4_tmp;m_mat4.rotateX(camobj.render.world_matrix,-Math.PI/2,wm);m_mat4.invert(wm,cam.view_matrix);if(cam.reflection_plane){reflect_view_matrix(cam);reflect_proj_matrix(cam)}var x=cam.view_matrix[12];var y=cam.view_matrix[13];var z=cam.view_matrix[14];if(cam.type==exports.TYPE_STEREO_LEFT)cam.view_matrix[12]+=cam.stereo_eye_dist/2;else if(cam.type==exports.TYPE_STEREO_RIGHT)cam.view_matrix[12]-=
cam.stereo_eye_dist/2;m_mat4.multiply(cam.proj_matrix,cam.view_matrix,cam.view_proj_matrix);calc_view_proj_inverse(cam);calc_sky_vp_inverse(cam);m_vec3.copy(cam.eye,cam.eye_last);m_vec3.copy(trans,cam.eye);m_quat.copy(quat,cam.quat)}function reflect_view_matrix(cam){var Nx=cam.reflection_plane[0];var Ny=cam.reflection_plane[1];var Nz=cam.reflection_plane[2];var D=cam.reflection_plane[3];var refl_mat=_mat4_tmp;refl_mat[0]=1-2*Nx*Nx;refl_mat[1]=-2*Nx*Ny;refl_mat[2]=-2*Nx*Nz;refl_mat[3]=0;refl_mat[4]=
-2*Nx*Ny;refl_mat[5]=1-2*Ny*Ny;refl_mat[6]=-2*Ny*Nz;refl_mat[7]=0;refl_mat[8]=-2*Nx*Nz;refl_mat[9]=-2*Ny*Nz;refl_mat[10]=1-2*Nz*Nz;refl_mat[11]=0;refl_mat[12]=-2*Nx*D;refl_mat[13]=-2*Ny*D;refl_mat[14]=-2*Nz*D;refl_mat[15]=1;m_mat4.multiply(cam.view_matrix,refl_mat,cam.view_matrix)}function reflect_proj_matrix(cam){set_projection(cam,cam.aspect,true);var plane=_vec4_tmp;var view_inv_transp_matrix=_mat4_tmp;m_mat4.invert(cam.view_matrix,view_inv_transp_matrix);m_mat4.transpose(view_inv_transp_matrix,
view_inv_transp_matrix);m_vec4.transformMat4(cam.reflection_plane,view_inv_transp_matrix,plane);var corner_point=_vec4_tmp2;corner_point[0]=(m_util.sign(plane[0])+cam.proj_matrix[8])/cam.proj_matrix[0];corner_point[1]=(m_util.sign(plane[1])+cam.proj_matrix[9])/cam.proj_matrix[5];corner_point[2]=-1;corner_point[3]=(1+cam.proj_matrix[10])/cam.proj_matrix[14];var dot=plane[0]*corner_point[0]+plane[1]*corner_point[1]+plane[2]*corner_point[2]+plane[3]*corner_point[3];m_vec4.scale(plane,2/dot,plane);cam.proj_matrix[2]=
plane[0];cam.proj_matrix[6]=plane[1];cam.proj_matrix[10]=plane[2]+1;cam.proj_matrix[14]=plane[3]}exports.set_view_eye_target_up=set_view_eye_target_up;function set_view_eye_target_up(cam,eye,target,up){m_mat4.lookAt(eye,target,up,cam.view_matrix);if(cam.type==exports.TYPE_STEREO_LEFT)cam.view_matrix[12]+=cam.stereo_eye_dist/2;else if(cam.type==exports.TYPE_STEREO_RIGHT)cam.view_matrix[12]-=cam.stereo_eye_dist/2;m_mat4.multiply(cam.proj_matrix,cam.view_matrix,cam.view_proj_matrix);calc_view_proj_inverse(cam);
calc_sky_vp_inverse(cam);m_vec3.copy(eye,cam.eye)}exports.set_view_trans_quat=function(cam,trans,quat){var target=_vec3_tmp;target[0]=0;target[1]=-1;target[2]=0;m_vec3.transformQuat(target,quat,target);target[0]+=trans[0];target[1]+=trans[1];target[2]+=trans[2];var up=_vec3_tmp2;up[0]=0;up[1]=0;up[2]=-1;m_vec3.transformQuat(up,quat,up);set_view_eye_target_up(cam,trans,target,up)};exports.eye_target_up_to_trans_quat=function(eye,target,up,trans,quat){trans[0]=eye[0];trans[1]=eye[1];trans[2]=eye[2];
m_mat4.lookAt(eye,target,up,_mat4_tmp);m_mat4.invert(_mat4_tmp,_mat4_tmp);m_mat4.rotateX(_mat4_tmp,Math.PI/2,_mat4_tmp);var rot_matrix=_mat3_tmp;m_mat3.fromMat4(_mat4_tmp,rot_matrix);m_quat.fromMat3(rot_matrix,quat)};exports.update_camera_transform=update_camera_transform;function update_camera_transform(obj){var cameras=obj.render.cameras;if(!cameras)throw"Wrong object";var render=obj.render;for(var i=0;i<cameras.length;i++){var cam=cameras[i];set_view(cam,obj);m_util.extract_frustum_planes(cam.view_proj_matrix,
cam.frustum_planes);if(cam.dof_object)if(cam.dof_on){var cam_loc=render.trans;var obj_loc=m_trans.get_translation(cam.dof_object,_vec3_tmp);var dof_dist=m_vec3.dist(cam_loc,obj_loc);cam.dof_distance=dof_dist}else cam.dof_distance=0}}exports.update_camera=function(obj){var render=obj.render;clamp_limits(obj);update_ortho_scale(obj);switch(render.move_style){case exports.MS_TARGET_CONTROLS:m_cons.rotate_to(render.trans,render.quat,render.pivot);m_cons.correct_up(obj,m_util.AXIS_Y);break;case exports.MS_EYE_CONTROLS:if(!obj.constraint)m_cons.correct_up(obj,
m_util.AXIS_Y);break}update_camera_upside_down(obj)};exports.update_camera_upside_down=update_camera_upside_down;function update_camera_upside_down(obj){var render=obj.render;if(render.move_style==exports.MS_TARGET_CONTROLS){var z_world_cam=m_util.quat_to_dir(render.quat,m_util.AXIS_Z,_vec3_tmp);render.target_cam_upside_down=z_world_cam[1]>0}}function prepare_clamping_limits(obj){var bpy_obj=obj.temp_bpy_obj;var render=obj.render;var ms=render.move_style;if(ms!==exports.MS_TARGET_CONTROLS&&ms!==exports.MS_EYE_CONTROLS&&
ms!==exports.MS_HOVER_CONTROLS)return;var data=bpy_obj["data"];var horizontal_limits=null;var vertical_limits=null;var hover_angle_limits=null;if(ms===exports.MS_TARGET_CONTROLS||ms===exports.MS_EYE_CONTROLS){if(data["b4w_use_panning"])render.use_panning=data["b4w_use_panning"];if(data["b4w_use_horizontal_clamping"])horizontal_limits={left:data["b4w_rotation_left_limit"],right:data["b4w_rotation_right_limit"]};if(data["b4w_use_vertical_clamping"])vertical_limits={down:data["b4w_rotation_down_limit"],
up:data["b4w_rotation_up_limit"]};if(ms===exports.MS_TARGET_CONTROLS){render.use_distance_limits=data["b4w_use_distance_limits"]&&data["b4w_distance_min"]<=data["b4w_distance_max"];if(render.use_distance_limits){render.distance_min=data["b4w_distance_min"];render.distance_max=data["b4w_distance_max"]}}}else if(ms===exports.MS_HOVER_CONTROLS){if(data["b4w_use_horizontal_clamping"]&&data["b4w_horizontal_translation_min"]<=data["b4w_horizontal_translation_max"])horizontal_limits={left:data["b4w_horizontal_translation_min"],
right:data["b4w_horizontal_translation_max"]};if(data["b4w_use_vertical_clamping"]&&data["b4w_vertical_translation_min"]<=data["b4w_vertical_translation_max"])vertical_limits={down:data["b4w_vertical_translation_min"],up:data["b4w_vertical_translation_max"]};render.use_distance_limits=data["b4w_use_distance_limits"]&&data["b4w_hover_angle_min"]<=data["b4w_hover_angle_max"]&&data["b4w_distance_min"]<=data["b4w_distance_max"];if(render.use_distance_limits){hover_angle_limits={down:data["b4w_hover_angle_min"],
up:data["b4w_hover_angle_max"]};render.distance_min=data["b4w_distance_min"];render.distance_max=data["b4w_distance_max"]}}horizontal_limits_bpy_to_b4w(horizontal_limits,ms);vertical_limits_bpy_to_b4w(vertical_limits,ms);hover_angle_limits_bpy_to_b4w(hover_angle_limits,ms);render.horizontal_limits=horizontal_limits;render.vertical_limits=vertical_limits;render.hover_angle_limits=hover_angle_limits;prepare_horizontal_limits(obj,data["b4w_horizontal_clamping_type"]=="LOCAL");prepare_vertical_limits(obj,
data["b4w_vertical_clamping_type"]=="LOCAL")}function horizontal_limits_bpy_to_b4w(limits,move_style){if(limits&&move_style==exports.MS_EYE_CONTROLS){limits.left*=-1;limits.right*=-1}}exports.prepare_horizontal_limits=prepare_horizontal_limits;function prepare_horizontal_limits(camobj,is_local){var render=camobj.render;var limits=render.horizontal_limits;if(limits&&(render.move_style==exports.MS_EYE_CONTROLS||render.move_style==exports.MS_TARGET_CONTROLS)){if(is_local){var angles=get_camera_angles(camobj,
_vec2_tmp);limits.left+=angles[0];limits.right+=angles[0]}limits.left=m_util.angle_wrap_0_2pi(limits.left);limits.right=m_util.angle_wrap_0_2pi(limits.right)}}function vertical_limits_bpy_to_b4w(limits,move_style){if(limits)switch(move_style){case exports.MS_TARGET_CONTROLS:limits.down*=-1;limits.up*=-1;break;case exports.MS_HOVER_CONTROLS:var up_z=-limits.down;var down_z=-limits.up;limits.down=down_z;limits.up=up_z;break}}exports.prepare_vertical_limits=prepare_vertical_limits;function prepare_vertical_limits(camobj,
is_local){var render=camobj.render;var limits=render.vertical_limits;if(limits&&(render.move_style==exports.MS_EYE_CONTROLS||render.move_style==exports.MS_TARGET_CONTROLS)){if(is_local){var angles=get_camera_angles(camobj,_vec2_tmp);limits.up+=angles[1];limits.down+=angles[1]}limits.up=m_util.angle_wrap_periodic(limits.up,-Math.PI,Math.PI);limits.down=m_util.angle_wrap_periodic(limits.down,-Math.PI,Math.PI)}}function hover_angle_limits_bpy_to_b4w(limits,move_style){if(limits&&move_style==exports.MS_HOVER_CONTROLS){limits.down*=
-1;limits.up*=-1}}exports.update_ortho_scale=update_ortho_scale;function update_ortho_scale(obj){var render=obj.render;if(!m_obj_util.is_camera(obj))return;var cams=render.cameras;if(cams[0].type===exports.TYPE_ORTHO){if(render.move_style===exports.MS_TARGET_CONTROLS){var dir_dist=m_vec3.dist(render.trans,render.pivot);var new_scale=dir_dist/render.init_dist*render.init_top}else if(render.use_distance_limits&&render.move_style===exports.MS_HOVER_CONTROLS){var dir_dist=m_vec3.distance(render.trans,
render.hover_pivot);var new_scale=dir_dist/render.init_dist*render.init_top}else var new_scale=cams[0].top;for(var i=0;i<cams.length;i++){var cam=cams[i];cam.top=new_scale;set_projection(cam,cam.aspect)}update_camera_transform(obj)}}function clamp_limits(obj){var render=obj.render;if(render.move_style===exports.MS_TARGET_CONTROLS||render.move_style===exports.MS_EYE_CONTROLS){if(render.horizontal_limits){var left=render.horizontal_limits.left;var right=render.horizontal_limits.right;var angles=get_camera_angles(obj,
_vec2_tmp);if(render.move_style==exports.MS_TARGET_CONTROLS)var ret_angle=m_util.calc_returning_angle(angles[0],left,right);else var ret_angle=m_util.calc_returning_angle(angles[0],right,left);if(ret_angle)if(render.move_style==exports.MS_TARGET_CONTROLS)rotate_target_camera(obj,ret_angle,0);else rotate_eye_camera(obj,ret_angle,0)}if(render.vertical_limits){var down=render.vertical_limits.down;var up=render.vertical_limits.up;var angles=get_camera_angles(obj,_vec2_tmp);if(render.move_style==exports.MS_TARGET_CONTROLS)var ret_angle=
m_util.calc_returning_angle(angles[1],up,down);else var ret_angle=m_util.calc_returning_angle(angles[1],down,up);if(ret_angle)if(render.move_style==exports.MS_TARGET_CONTROLS)rotate_target_camera(obj,0,ret_angle);else rotate_eye_camera(obj,0,ret_angle)}if(render.move_style===exports.MS_TARGET_CONTROLS)if(render.use_distance_limits)target_cam_clamp_distance(obj)}if(render.move_style===exports.MS_HOVER_CONTROLS){hover_cam_clamp_axis_limits(obj);hover_cam_clamp_rotation(obj)}}exports.rotate_eye_camera=
rotate_eye_camera;function rotate_eye_camera(obj,phi,theta,phi_is_abs,theta_is_abs){var render=obj.render;var d_phi=phi;var d_theta=theta;if(phi_is_abs||theta_is_abs){var curr_angles=get_camera_angles(obj,_vec2_tmp2);if(phi_is_abs)d_phi=phi-curr_angles[0];if(theta_is_abs)d_theta=theta-curr_angles[1]}if(d_phi||d_theta){var rot_quat=m_quat.identity(_quat4_tmp);if(d_phi){var quat_phi=m_quat.setAxisAngle(m_util.AXIS_Y,d_phi,_quat4_tmp2);m_quat.multiply(rot_quat,quat_phi,rot_quat)}if(d_theta){var x_world_cam=
m_util.quat_to_dir(render.quat,m_util.AXIS_X,_vec3_tmp);var quat_theta=m_quat.setAxisAngle(x_world_cam,d_theta,_quat4_tmp2);m_quat.normalize(quat_theta,quat_theta);m_quat.multiply(rot_quat,quat_theta,rot_quat)}m_quat.multiply(rot_quat,render.quat,render.quat)}}exports.rotate_target_camera=rotate_target_camera;function rotate_target_camera(obj,phi,theta,phi_is_abs,theta_is_abs){var render=obj.render;var d_phi=phi;var d_theta=theta;if(phi_is_abs||theta_is_abs){var curr_angles=get_camera_angles(obj,
_vec2_tmp2);if(phi_is_abs)d_phi=phi-curr_angles[0];if(theta_is_abs)d_theta=theta-curr_angles[1]}camera_rotate_point_pivot(obj,obj.render.pivot,d_phi,d_theta);var angles=get_camera_angles(obj,_vec2_tmp2);var dest_theta=m_util.angle_wrap_periodic(angles[1],-Math.PI,Math.PI);render.target_cam_upside_down=Math.abs(dest_theta)>Math.PI/2}exports.rotate_hover_camera=rotate_hover_camera;function rotate_hover_camera(obj,phi,theta,phi_is_abs,theta_is_abs){var render=obj.render;var d_phi=phi;var d_theta=theta;
if(phi_is_abs||theta_is_abs){var curr_angles=get_camera_angles(obj,_vec2_tmp2);if(phi_is_abs)d_phi=phi-curr_angles[0];if(theta_is_abs)d_theta=theta-curr_angles[1]}if(!render.enable_hover_hor_rotation)d_phi=0;camera_rotate_point_pivot(obj,render.hover_pivot,d_phi,d_theta);if(d_theta)hover_camera_update_distance(obj)}function camera_rotate_point_pivot(obj,pivot,d_phi,d_theta){var render=obj.render;if(d_phi||d_theta){var rot_quat=m_quat.identity(_quat4_tmp);if(d_phi){var quat_phi=m_quat.setAxisAngle(m_util.AXIS_Y,
d_phi,_quat4_tmp2);m_quat.multiply(rot_quat,quat_phi,rot_quat)}var is_hover=is_hover_camera(obj);if(d_theta&&(!is_hover||is_hover&&render.use_distance_limits)){var x_world_cam=m_util.quat_to_dir(render.quat,m_util.AXIS_X,_vec3_tmp);var quat_theta=m_quat.setAxisAngle(x_world_cam,d_theta,_quat4_tmp2);m_quat.normalize(quat_theta,quat_theta);m_quat.multiply(rot_quat,quat_theta,rot_quat)}m_util.rotate_point_pivot(render.trans,pivot,rot_quat,render.trans);m_quat.multiply(rot_quat,render.quat,render.quat)}}
exports.hover_camera_update_distance=hover_camera_update_distance;function hover_camera_update_distance(obj){var render=obj.render;if(render.use_distance_limits){var hover_angle=get_camera_angles(obj,_vec2_tmp)[1];var dist=hover_cam_calc_distance_for_angle(obj,hover_angle);var view_vector=m_util.quat_to_dir(render.quat,m_util.AXIS_MY,_vec3_tmp);m_vec3.normalize(view_vector,view_vector);m_vec3.scale(view_vector,dist,view_vector);m_vec3.subtract(render.hover_pivot,view_vector,render.trans)}}function hover_cam_calc_distance_for_angle(obj,
hover_angle){var render=obj.render;if(render.hover_angle_limits.down-render.hover_angle_limits.up){var rot_factor=(render.hover_angle_limits.down-hover_angle)/(render.hover_angle_limits.down-render.hover_angle_limits.up);rot_factor=Math.max(rot_factor,0)}else var rot_factor=0;return rot_factor*(render.distance_max-render.distance_min)+render.distance_min}function target_cam_clamp_distance(obj){var render=obj.render;var dist_vector=m_vec3.subtract(render.trans,render.pivot,_vec3_tmp);var len=m_vec3.length(dist_vector);
if(len>render.distance_max){var scale=render.distance_max/len;m_vec3.scale(dist_vector,scale,dist_vector);m_vec3.add(render.pivot,dist_vector,render.trans)}else if(len<render.distance_min){var cam_view=m_util.quat_to_dir(render.quat,m_util.AXIS_MY,_vec3_tmp2);m_vec3.scale(cam_view,100*render.distance_min,cam_view);m_vec3.add(dist_vector,cam_view,dist_vector);m_vec3.scale(dist_vector,-render.distance_min/m_vec3.length(dist_vector),dist_vector);m_vec3.add(render.pivot,dist_vector,render.trans)}}function hover_cam_clamp_axis_limits(obj){var render=
obj.render;if(render.use_distance_limits)var clamping_target=render.hover_pivot;else var clamping_target=render.trans;if(render.horizontal_limits){var horiz_delta=m_util.clamp(clamping_target[0],render.horizontal_limits.left,render.horizontal_limits.right)-clamping_target[0];clamping_target[0]+=horiz_delta;if(render.use_distance_limits)render.trans[0]+=horiz_delta}if(render.vertical_limits){var vert_delta=m_util.clamp(clamping_target[2],render.vertical_limits.down,render.vertical_limits.up)-clamping_target[2];
clamping_target[2]+=vert_delta;if(render.use_distance_limits)render.trans[2]+=vert_delta}}function hover_cam_clamp_rotation(obj){var render=obj.render;if(render.use_distance_limits&&render.hover_angle_limits){var curr_angle=get_camera_angles(obj,_vec2_tmp)[1];var ret_angle=m_util.calc_returning_angle(curr_angle,render.hover_angle_limits.up,render.hover_angle_limits.down);var view_vector=m_util.quat_to_dir(render.quat,m_util.AXIS_MY,_vec3_tmp);if(ret_angle)rotate_hover_camera(obj,0,ret_angle)}}exports.is_float_aspect=
function(cam){switch(cam.type){case exports.TYPE_PERSP:case exports.TYPE_ORTHO:case exports.TYPE_STEREO_LEFT:case exports.TYPE_STEREO_RIGHT:return true;default:return false}};exports.get_angular_diameter=function(camobj){var cam=camobj.render.cameras[0];switch(cam.type){case exports.TYPE_PERSP:case exports.TYPE_PERSP_ASPECT:case exports.TYPE_STEREO_LEFT:case exports.TYPE_STEREO_RIGHT:return Math.PI*cam.fov/180;default:m_print.error("get_min_fov(): Unsupported camera type: "+cam.type);return 0}};exports.set_projection=
set_projection;function set_projection(cam,aspect,keep_proj_view){switch(cam.type){case exports.TYPE_PERSP:if(!aspect)throw"No aspect ratio";cam.aspect=aspect;case exports.TYPE_PERSP_ASPECT:m_mat4.perspective(m_util.rad(cam.fov),cam.aspect,cam.near,cam.far,cam.proj_matrix);break;case exports.TYPE_ORTHO:if(!aspect)throw"No aspect ratio";cam.aspect=aspect;case exports.TYPE_ORTHO_ASPECT:var right=cam.top*cam.aspect;m_mat4.ortho(-right,right,-cam.top,cam.top,cam.near,cam.far,cam.proj_matrix);break;case exports.TYPE_ORTHO_ASYMMETRIC:m_mat4.ortho(cam.left,
cam.right,cam.bottom,cam.top,cam.near,cam.far,cam.proj_matrix);break;case exports.TYPE_STEREO_LEFT:case exports.TYPE_STEREO_RIGHT:if(!aspect)throw"No aspect ratio";cam.aspect=aspect;set_projection_stereo(cam);break;case exports.TYPE_NONE:return;default:throw"Wrong camera type: "+cam.type;}if(!keep_proj_view){m_mat4.multiply(cam.proj_matrix,cam.view_matrix,cam.view_proj_matrix);calc_view_proj_inverse(cam);calc_sky_vp_inverse(cam)}}function set_projection_stereo(cam){var fov_tan=Math.tan(cam.fov*Math.PI/
360);var top=cam.near*fov_tan;var bottom=-top;var a=cam.aspect*cam.stereo_conv_dist*fov_tan;if(cam.type==exports.TYPE_STEREO_LEFT){var b=a-cam.stereo_eye_dist/2;var c=a+cam.stereo_eye_dist/2}else{var b=a+cam.stereo_eye_dist/2;var c=a-cam.stereo_eye_dist/2}var left=-(cam.near/cam.stereo_conv_dist*b);var right=cam.near/cam.stereo_conv_dist*c;m_mat4.frustum(left,right,bottom,top,cam.near,cam.far,cam.proj_matrix);cam.left=left;cam.right=right}exports.calc_sky_vp_inverse=calc_sky_vp_inverse;function calc_sky_vp_inverse(cam){m_mat4.copy(cam.view_matrix,
cam.sky_vp_inv_matrix);cam.sky_vp_inv_matrix[12]=0;cam.sky_vp_inv_matrix[13]=0;cam.sky_vp_inv_matrix[14]=0;cam.sky_vp_inv_matrix[15]=1;m_mat4.multiply(cam.proj_matrix,cam.sky_vp_inv_matrix,cam.sky_vp_inv_matrix);m_mat4.invert(cam.sky_vp_inv_matrix,cam.sky_vp_inv_matrix)}exports.calc_view_proj_inverse=calc_view_proj_inverse;function calc_view_proj_inverse(cam){m_mat4.copy(cam.view_matrix,cam.view_proj_inv_matrix);m_mat4.multiply(cam.proj_matrix,cam.view_proj_inv_matrix,cam.view_proj_inv_matrix);m_mat4.invert(cam.view_proj_inv_matrix,
cam.view_proj_inv_matrix)}exports.extract_frustum_corners=extract_frustum_corners;function extract_frustum_corners(cam,near,far,corners,is_world_space){if(!corners)var corners=new Float32Array(24);if(!near)var near=cam.near;if(!far)var far=cam.far;var top_near,right_near,left_near,bottom_near;var top_far,right_far,left_far,bottom_far;switch(cam.type){case exports.TYPE_NONE:throw"Extraction from NONE camera is not possible";break;case exports.TYPE_PERSP:case exports.TYPE_PERSP_ASPECT:top_near=near*
Math.tan(cam.fov*Math.PI/360);bottom_near=-top_near;right_near=top_near*cam.aspect;left_near=-right_near;var coeff=far/near;top_far=top_near*coeff;bottom_far=-top_far;right_far=top_far*cam.aspect;left_far=-right_far;break;case exports.TYPE_ORTHO:case exports.TYPE_ORTHO_ASPECT:var right=cam.top*cam.aspect;top_near=top_far=cam.top;right_near=right_far=right;bottom_near=bottom_far=-cam.top;left_near=left_far=-right;break;case exports.TYPE_ORTHO_ASYMMETRIC:top_near=top_far=cam.top;right_near=right_far=
cam.right;bottom_near=bottom_far=cam.bottom;left_near=left_far=cam.left;break;case exports.TYPE_STEREO_LEFT:case exports.TYPE_STEREO_RIGHT:var coeff_near=near/cam.near;top_near=near*Math.tan(cam.fov*Math.PI/360);bottom_near=-top_near;right_near=cam.right*coeff_near;left_near=cam.left*coeff_near;var coeff_far=far/near;top_far=top_near*coeff_far;bottom_far=-top_far;right_far=right_near*coeff_far;left_far=left_near*coeff_far;break;default:throw"Wrong camera type: "+cam.type;}corners[0]=left_near;corners[1]=
bottom_near;corners[2]=-near;corners[3]=right_near;corners[4]=bottom_near;corners[5]=-near;corners[6]=right_near;corners[7]=top_near;corners[8]=-near;corners[9]=left_near;corners[10]=top_near;corners[11]=-near;corners[12]=left_far;corners[13]=bottom_far;corners[14]=-far;corners[15]=left_far;corners[16]=top_far;corners[17]=-far;corners[18]=right_far;corners[19]=top_far;corners[20]=-far;corners[21]=right_far;corners[22]=bottom_far;corners[23]=-far;if(is_world_space){var view_inv=_mat4_tmp;m_mat4.invert(cam.view_matrix,
view_inv);m_util.positions_multiply_matrix(corners,view_inv,corners,0)}return corners}exports.assign_boundings=function(camobj){var render=camobj.render;var bb=m_bounds.zero_bounding_box();bb.min_x=-1;bb.max_x=1;bb.min_y=-1;bb.max_y=1;bb.min_z=-1;bb.max_z=1;render.bb_local=bb;var bs=m_bounds.create_bounding_sphere(1,[0,0,0]);render.bs_local=bs;render.bcap_local=m_bounds.create_bounding_capsule(1,bb);render.bcyl_local=m_bounds.create_bounding_cylinder(1,bb);render.bcon_local=m_bounds.create_bounding_cone(1,
bb)};exports.is_target_camera=function(obj){if(m_obj_util.is_camera(obj)&&obj.render&&obj.render.move_style==exports.MS_TARGET_CONTROLS)return true;else return false};exports.is_eye_camera=function(obj){if(m_obj_util.is_camera(obj)&&obj.render&&obj.render.move_style==exports.MS_EYE_CONTROLS)return true;else return false};exports.is_hover_camera=is_hover_camera;function is_hover_camera(obj){if(m_obj_util.is_camera(obj)&&obj.render&&obj.render.move_style==exports.MS_HOVER_CONTROLS)return true;else return false}
exports.update_camera_shadows=update_camera_shadows;function update_camera_shadows(cam,shadow_params){if(shadow_params.enable_csm)update_camera_csm(cam,shadow_params);else cam.pcf_blur_radii[0]=shadow_params.first_cascade_blur_radius}function update_camera_csm(cam,shadow_params){var N=shadow_params.csm_num;if(!cam.csm_centers)init_camera_csm(cam,shadow_params);for(var i=0;i<N;i++){var near=i==0?cam.near:csm_far_plane(shadow_params,cam,i-1);var far=csm_far_plane(shadow_params,cam,i);var corners=extract_frustum_corners(cam,
near,far,_frustum_corners_tmp);var mec=m_bounds.get_frustum_mec(corners);cam.csm_centers[i].set(mec.center);cam.csm_radii[i]=mec.radius;cam.csm_center_dists[i]=m_vec3.length(mec.center);var blur_rad_first=shadow_params.first_cascade_blur_radius;var blur_rad_last=shadow_params.last_cascade_blur_radius;cam.pcf_blur_radii[i]=get_cascade_interpolation(blur_rad_first,blur_rad_last,N,i)}}function init_camera_csm(cam,shadow_params){var csm_num=shadow_params.csm_num;cam.csm_centers=new Array(csm_num);for(var i=
0;i<csm_num;i++)cam.csm_centers[i]=new Float32Array(3);cam.csm_radii=new Float32Array(csm_num)}exports.csm_far_plane=csm_far_plane;function csm_far_plane(shadow_params,cam,csm_index){var N=shadow_params.csm_num;var border_first=m_util.clamp(shadow_params.csm_first_cascade_border,cam.near,cam.far);var border_last=m_util.clamp(shadow_params.csm_last_cascade_border,cam.near,cam.far);var far=get_cascade_interpolation(border_first,border_last,N,csm_index);return m_util.clamp(far,cam.near,cam.far)}function get_cascade_interpolation(val_first,
val_last,casc_count,casc_index){switch(casc_index){case 0:var val=val_first;break;case casc_count-1:var val=val_last;break;default:var val=val_first==0?0:val_first*Math.pow(val_last/val_first,casc_index/(casc_count-1));break}return val}exports.project_point=function(camobj,point,dest){var cam=camobj.render.cameras[0];switch(cam.type){case exports.TYPE_PERSP:case exports.TYPE_PERSP_ASPECT:case exports.TYPE_ORTHO:case exports.TYPE_ORTHO_ASPECT:case exports.TYPE_STEREO_LEFT:case exports.TYPE_STEREO_RIGHT:var dir=
_vec4_tmp;dir.set(point);dir[3]=1;var vp=cam.view_proj_matrix;m_vec4.transformMat4(dir,vp,dir);var x=dir[0]/dir[3];var y=-dir[1]/dir[3];dest[0]=(x+1)/2*cam.width;dest[1]=(y+1)/2*cam.height;m_cont.viewport_to_canvas_coords(dest[0],dest[1],dest,cam);if(dest.length>2)dest[2]=(dir[2]/Math.abs(dir[3])+1)/2;return dest;default:m_print.error("Non-compatible camera");return dest}};exports.get_first_cam=function(camobj){return camobj.render.cameras[0]};exports.get_edge=function(cam,edge_type){switch(cam.type){case exports.TYPE_PERSP:case exports.TYPE_PERSP_ASPECT:case exports.TYPE_STEREO_LEFT:case exports.TYPE_STEREO_RIGHT:var top_1m=
Math.tan(m_util.rad(cam.fov)/2);switch(edge_type){case "LEFT":return-top_1m*cam.aspect;case "RIGHT":return top_1m*cam.aspect;case "TOP":return top_1m;case "BOTTOM":return-top_1m}break;case exports.TYPE_ORTHO:case exports.TYPE_ORTHO_ASPECT:switch(edge_type){case "LEFT":return-cam.top*cam.aspect;case "RIGHT":return cam.top*cam.aspect;case "TOP":return cam.top;case "BOTTOM":return-cam.top}break;case exports.TYPE_ORTHO_ASYMMETRIC:switch(edge_type){case "LEFT":return cam.left;case "RIGHT":return cam.right;
case "TOP":return cam.top;case "BOTTOM":return cam.bottom}break;default:m_util.panic("Unknown camera type");break}};exports.is_ortho=function(cam){switch(cam.type){case exports.TYPE_ORTHO:case exports.TYPE_ORTHO_ASPECT:case exports.TYPE_ORTHO_ASYMMETRIC:return true;default:return false}};exports.get_fov=function(cam,is_horizontal){switch(cam.type){case exports.TYPE_PERSP:case exports.TYPE_PERSP_ASPECT:case exports.TYPE_STEREO_LEFT:case exports.TYPE_STEREO_RIGHT:var vfov=m_util.rad(cam.fov);if(is_horizontal)return vfov*
cam.aspect;else return vfov;default:return 0}}};b4w.module["__lights"]=function(exports,require){var m_print=require("__print");var m_util=require("__util");var m_vec3=require("__vec3");var _vec3_tmp=new Float32Array(3);function init_light(type){var light={name:"",type:type,use_diffuse:false,use_specular:false,prev_direction:new Float32Array(3),direction:new Float32Array(3),color:new Float32Array(3),color_intensity:new Float32Array(3),energy:0,default_energy:0,distance:0,spot_size:0,spot_blend:0,falloff_type:"",generate_shadows:false,need_sun_fog_update:false,
dynamic_intensity:false};light.use_diffuse=true;light.use_specular=true;light.energy=1;light.distance=25;light.falloff_type="INVERSE_SQUARE";return light}exports.lamp_to_light=function(bpy_obj,obj){var data=bpy_obj["data"];var light=obj.light=init_light(data["type"]);light.name=obj.name;light.use_diffuse=data["use_diffuse"];light.use_specular=data["use_specular"];var dir=m_util.quat_to_dir(obj.render.quat,m_util.AXIS_Y,_vec3_tmp);m_vec3.normalize(dir,dir);light.direction.set(dir);light.color[0]=data["color"][0];
light.color[1]=data["color"][1];light.color[2]=data["color"][2];light.energy=light.default_energy=data["energy"];update_color_intensity(light);light.distance=data["distance"];if(light.type==="POINT"||light.type==="SPOT")light.distance=data["distance"];if(light.type==="SPOT"){light.spot_blend=data["spot_blend"];light.spot_size=data["spot_size"]}else if(light.type==="POINT")light.spot_size=Math.PI/2;light.generate_shadows=data["b4w_generate_shadows"];light.dynamic_intensity=data["b4w_dynamic_intensity"]};
exports.set_light_color=function(light,color){light.color[0]=color[0];light.color[1]=color[1];light.color[2]=color[2];update_color_intensity(light)};exports.set_light_spot_blend=function(light,spot_blend){light.spot_blend=spot_blend};exports.set_light_distance=function(light,distance){light.distance=distance};exports.set_light_spot_size=function(light,spot_size){light.spot_size=spot_size};exports.set_light_energy=function(light,energy){light.energy=energy;update_color_intensity(light)};function update_color_intensity(light){m_vec3.scale(light.color,
light.energy,light.color_intensity)}exports.update_light_transform=update_light_transform;function update_light_transform(obj){if(obj.type!="LAMP")throw"Wrong light object";var light=obj.light;if(!light)return;m_util.quat_to_dir(obj.render.quat,m_util.AXIS_Y,light.direction);m_vec3.normalize(light.direction,light.direction);if(light.type=="SUN"){var prev_angle=Math.acos(m_vec3.dot(light.prev_direction,m_util.VEC3_UNIT));var new_angle=Math.acos(m_vec3.dot(light.direction,m_util.VEC3_UNIT));var floor_prev=
Math.floor(prev_angle/.025);var floor_new=Math.floor(new_angle/.025);if(floor_prev!=floor_new)light.need_sun_fog_update=true;else light.need_sun_fog_update=false}m_vec3.copy(light.direction,light.prev_direction)}};b4w.module["__scenes"]=function(exports,require){var m_batch=require("__batch");var m_bounds=require("__boundings");var m_cam=require("__camera");var m_cfg=require("__config");var m_cont=require("__container");var m_cstr=require("__constraints");var m_debug=require("__debug");var m_geom=require("__geometry");var m_graph=require("__graph");var m_hud=require("__hud");var m_mat4=require("__mat4");var m_nodemat=require("__nodemat");var m_obj_util=require("__obj_util");var m_phy=require("__physics");var m_prerender=
require("__prerender");var m_primitives=require("__primitives");var m_print=require("__print");var m_render=require("__renderer");var m_scgraph=require("__scenegraph");var m_sfx=require("__sfx");var m_shaders=require("__shaders");var m_tex=require("__textures");var m_util=require("__util");var m_vec3=require("__vec3");var cfg_ani=m_cfg.animation;var cfg_def=m_cfg.defaults;var cfg_out=m_cfg.outlining;var cfg_scs=m_cfg.scenes;var FRAME_EPS=5;var VALID_OBJ_TYPES=["ARMATURE","CAMERA","EMPTY","LAMP","MESH",
"SPEAKER"];var VALID_OBJ_TYPES_SECONDARY=["ARMATURE","EMPTY","MESH","SPEAKER"];var OBJECT_SUBSCENE_TYPES=["GRASS_MAP","SHADOW_CAST","MAIN_OPAQUE","MAIN_BLEND","MAIN_XRAY","MAIN_GLOW","MAIN_PLANE_REFLECT","MAIN_CUBE_REFLECT","COLOR_PICKING","COLOR_PICKING_XRAY","DEPTH","OUTLINE_MASK","WIREFRAME"];exports.OBJECT_SUBSCENE_TYPES=OBJECT_SUBSCENE_TYPES;var LIGHT_SUBSCENE_TYPES=["MAIN_OPAQUE","MAIN_BLEND","MAIN_XRAY","MAIN_GLOW","MAIN_PLANE_REFLECT","MAIN_CUBE_REFLECT","GOD_RAYS","GOD_RAYS_COMBINE","SKY",
"LUMINANCE_TRUNCED","DEPTH","SHADOW_CAST","COLOR_PICKING","COLOR_PICKING_XRAY","OUTLINE_MASK"];var FOG_SUBSCENE_TYPES=["MAIN_OPAQUE","SSAO","MAIN_BLEND","MAIN_XRAY","MAIN_GLOW","MAIN_PLANE_REFLECT","MAIN_CUBE_REFLECT"];var TIME_SUBSCENE_TYPES=["SHADOW_CAST","MAIN_OPAQUE","MAIN_BLEND","MAIN_XRAY","MAIN_GLOW","MAIN_PLANE_REFLECT","MAIN_CUBE_REFLECT","COLOR_PICKING","COLOR_PICKING_XRAY","DEPTH","GOD_RAYS","OUTLINE_MASK","WIREFRAME"];var MAIN_SUBSCENE_TYPES=["MAIN_OPAQUE","MAIN_BLEND","MAIN_XRAY","MAIN_GLOW",
"MAIN_PLANE_REFLECT","MAIN_CUBE_REFLECT"];var SHORE_DIST_COMPAT=100;var MAX_BATCH_TEXTURES=8;var _main_scene=null;var _active_scene=null;var _scenes=[];var _scenes_graph=null;var MAX_SHADER_VARYING_COUNT=10;var GRASS_MAP_MARGIN=1E-4;var MAX_SHADOW_CAST_BB_PROPORTION=2;var MAX_OPTIMAL_BB_ANGLE=Math.PI/2;var OPTIMAL_BB_COUNT=10;var SHADOW_MAP_EPSILON_XY=.005;var SHADOW_MAP_EPSILON_Z=.005;var _vec2_tmp=new Float32Array(2);var _vec3_tmp=new Float32Array(3);var _quat4_tmp=new Float32Array(4);var _mat4_tmp=
new Float32Array(16);var _corners_cache=new Float32Array(24);var _corners_cache2=new Float32Array(24);var _bb_tmp=m_bounds.zero_bounding_box();var _bb_tmp2=m_bounds.zero_bounding_box();var _shadow_cast_min_z=0;var _shadow_cast_max_z=-Infinity;exports.create_scene_render=function(){var render={};return render};exports.set_active=function(scene){_active_scene=scene;m_sfx.set_active_scene(scene)};exports.prepare_rendering=function(scene,scene_main){var render=scene._render;var queue=m_scgraph.create_rendering_queue(render.graph);
if(scene==scene_main){setup_scene_dim(scene,m_cont.get_viewport_width(),m_cont.get_viewport_height());for(var i=0;i<queue.length;i++)scene._render.queue.push(queue[i])}else{var tex0=scene._render_to_textures[0];var width=tex0._render.source_size;var height=tex0._render.source_size;setup_scene_dim(scene,width,height);for(var i=0;i<queue.length;i++)scene_main._render.queue.push(queue[i])}var subs_arr=subs_array(scene,TIME_SUBSCENE_TYPES);for(var j=0;j<subs_arr.length;j++)subs_arr[j].wind.set(render.wind);
for(var i=0;i<render.queue.length;i++)if(render.queue[i].type=="SHADOW_CAST")m_render.draw(render.queue[i])};exports.get_main=get_main;function get_main(){if(!_main_scene)_main_scene=find_main_scene(_scenes);return _main_scene}exports.find_main_scene=find_main_scene;function find_main_scene(scenes){for(var i=0;i<scenes.length;i++){var scene=scenes[i];if(!scene._render_to_textures||!scene._render_to_textures.length)return scene}return null}exports.get_active=get_active;function get_active(){if(!_active_scene)throw"No active scene available";
return _active_scene}exports.check_active=check_active;function check_active(){if(_active_scene)return true;else return false}exports.get_camera=function(scene){return scene._camera};exports.get_all_scenes=get_all_scenes;function get_all_scenes(){return _scenes}exports.get_rendered_scenes=function(){if(_scenes.length==1)return _scenes;for(var i=0;i<_scenes.length;i++){var graph=_scenes[i]._render.graph;m_graph.traverse(graph,function(node,attr){var subs=attr;for(var j=0;j<subs.bundles.length;j++){var textures=
subs.bundles[j].batch.textures;var batch=null;for(var k=0;k<textures.length;k++)if(textures[k].source=="SCENE"&&textures[k].source_id==_scenes[i]["name"]&&subs.type!="COPY"){m_print.error("Texture-scene loop detected. A scene is "+'rendered to texture "'+textures[k].name+'" yet this texture belongs '+"to the same scene.");var scene_node=m_graph.node_by_attr(_scenes_graph,_scenes[i]);batch=subs.bundles[j].batch;break}if(batch){batch.textures=[];batch.texture_names=[];m_batch.update_batch_material_debug(batch,
null);m_batch.update_shader(batch)}}})}var scenes=[];for(var i=0;i<_scenes.length;i++){var scene=_scenes[i];if(scene._render_to_textures.length)continue;var node=m_graph.node_by_attr(_scenes_graph,scene);m_graph.enforce_acyclic(_scenes_graph,node);var graph=m_graph.subgraph_node_conn(_scenes_graph,node,m_graph.BACKWARD_DIR);graph=m_graph.topsort(graph);m_graph.traverse(graph,function(node,attr){scenes.push(attr)});break}return scenes};exports.append_scene=append_scene;function append_scene(bpy_scene,
all_objs,lamps,mesh_objs,empty_objs){bpy_scene._render_to_textures=bpy_scene._render_to_textures||[];bpy_scene._nla=null;var render=bpy_scene._render;var cam_render=bpy_scene._camera.render;render.video_textures=[];var world=bpy_scene["world"];render.lamps_number=lamps.length;render.sun_exist=check_scenes_sun(lamps);render.sky_params=extract_sky_params(world,render.sun_exist);render.world_light_set=get_world_light_set(world,render.sky_params);render.world_fog_set=get_world_fog_set(world);render.anchor_visibility=
check_anchor_visibility_objects(bpy_scene,empty_objs);render.anaglyph_use=check_anaglyph_use(cam_render);render.reflection_params=extract_reflections_params(bpy_scene,all_objs);render.bloom_params=extract_bloom_params(bpy_scene);render.mb_params=extract_mb_params(bpy_scene);render.cc_params=extract_cc_params(bpy_scene);render.god_rays_params=extract_god_rays_params(bpy_scene);render.outline_params=extract_outline_params(bpy_scene);render.glow_params=extract_glow_params(bpy_scene);render.dof=cfg_def.dof&&
(cam_render.dof_distance>0||cam_render.dof_object);render.motion_blur=cfg_def.motion_blur&&bpy_scene["b4w_enable_motion_blur"];render.compositing=cfg_def.compositing&&bpy_scene["b4w_enable_color_correction"];render.antialiasing=cfg_def.antialiasing&&bpy_scene["b4w_enable_antialiasing"];render.ssao=cfg_def.ssao&&bpy_scene["b4w_enable_ssao"];render.god_rays=cfg_def.god_rays&&bpy_scene["b4w_enable_god_rays"]&&render.sun_exist;render.depth_tex=cfg_def.depth_tex_available;render.glow_over_blend=bpy_scene["world"]["b4w_render_glow_over_blend"];
render.ssao_params=extract_ssao_params(bpy_scene);var materials_params=get_material_params(mesh_objs);render.materials_params=materials_params;render.refractions=check_refraction(bpy_scene,materials_params);render.shadow_params=extract_shadow_params(bpy_scene,lamps,mesh_objs);render.water_params=get_water_params(mesh_objs);render.xray=check_xray_materials(mesh_objs);render.soft_particles=check_soft_particles(mesh_objs);render.shore_smoothing=check_shore_smoothing(mesh_objs);render.dynamic_grass=check_dynamic_grass(mesh_objs);
render.color_picking=check_selectable_objects(bpy_scene,mesh_objs);render.outline=check_outlining_objects(bpy_scene,mesh_objs);render.glow_materials=check_glow_materials(bpy_scene,mesh_objs);switch(bpy_scene["b4w_reflection_quality"]){case "LOW":render.cubemap_refl_size=cfg_scs.cube_reflect_low;render.plane_refl_size=cfg_scs.plane_reflect_low;break;case "MEDIUM":render.cubemap_refl_size=cfg_scs.cube_reflect_medium;render.plane_refl_size=cfg_scs.plane_reflect_medium;break;case "HIGH":render.cubemap_refl_size=
cfg_scs.cube_reflect_high;render.plane_refl_size=cfg_scs.plane_reflect_high;break;default:render.cubemap_refl_size=cfg_scs.cube_reflect_low;render.plane_refl_size=cfg_scs.plane_reflect_low;break}var rtt_sort_fun=function(bpy_tex1,bpy_tex2){return bpy_tex2._render.source_size-bpy_tex1._render.source_size};var rtt_sorted=bpy_scene._render_to_textures.sort(rtt_sort_fun);render.graph=m_scgraph.create_rendering_graph(render,cam_render,rtt_sorted);render.queue=[];render.need_shadow_update=false;render.need_grass_map_update=
false;render.need_outline=false;render.wind=new Float32Array(3);_scenes.push(bpy_scene);if(!_scenes_graph)_scenes_graph=m_graph.create();m_graph.append_node_attr(_scenes_graph,bpy_scene);for(var i=0;i<all_objs.length;i++)m_obj_util.scene_data_set_active(all_objs[i],true,bpy_scene)}exports.append_scene_vtex=function(scene,textures,data_id){for(var i=0;i<textures.length;i++)if(textures[i]._render&&textures[i]._render.is_movie){textures[i]._render.vtex_data_id=data_id;scene._render.video_textures.push(textures[i])}};
exports.combine_scene_bpy_objects=combine_scene_bpy_objects;function combine_scene_bpy_objects(bpy_scene,type){if(!type)type="ALL";var scene_objs_arr=[];combine_scene_bpy_objects_iter(bpy_scene["objects"],type,scene_objs_arr);return scene_objs_arr}function combine_scene_bpy_objects_iter(bpy_objects,type,dest){for(var i=0;i<bpy_objects.length;i++){var bpy_obj=bpy_objects[i];if(type=="ALL"||type==bpy_obj["type"])dest.push(bpy_obj);var dupli_group=bpy_obj["dupli_group"];if(dupli_group){var dg_objects=
dupli_group["objects"];combine_scene_bpy_objects_iter(dg_objects,type,dest)}}}function extract_shadow_params(bpy_scene,lamps,mesh_objs){if(!(cfg_def.depth_tex_available&&check_render_shadows(bpy_scene,lamps,mesh_objs)))return null;var shs=bpy_scene["b4w_shadow_settings"];var rshs={};if(shs["csm_resolution"]>cfg_def.max_texture_size){rshs.csm_resolution=cfg_def.max_texture_size;m_print.error("Shadow map texture has unsupported size. Changed to "+cfg_def.max_texture_size+".")}else rshs.csm_resolution=
shs["csm_resolution"];rshs.self_shadow_polygon_offset=shs["self_shadow_polygon_offset"];rshs.self_shadow_normal_offset=shs["self_shadow_normal_offset"];rshs.enable_csm=shs["b4w_enable_csm"];var shadow_lamp=m_obj_util.get_first_lamp_with_shadows(lamps)||lamps[0];if(shadow_lamp){rshs.lamp_type=shadow_lamp.light.type;rshs.spot_size=shadow_lamp.light.spot_size;rshs.distance=shadow_lamp.light.distance;if((rshs.lamp_type=="SPOT"||rshs.lamp_type=="POINT")&&rshs.enable_csm){m_print.warn("Generating shadows for SPOT "+
"or POINT light. Disabling Cascaded Shadow Maps");rshs.enable_csm=false}}if(rshs.enable_csm){rshs.csm_num=shs["csm_num"];rshs.csm_first_cascade_border=shs["csm_first_cascade_border"];rshs.first_cascade_blur_radius=shs["first_cascade_blur_radius"];rshs.csm_last_cascade_border=shs["csm_last_cascade_border"];rshs.last_cascade_blur_radius=shs["last_cascade_blur_radius"];rshs.fade_last_cascade=shs["fade_last_cascade"];rshs.blend_between_cascades=shs["blend_between_cascades"]}else{rshs.csm_num=1;rshs.csm_first_cascade_border=
shs["csm_first_cascade_border"];rshs.first_cascade_blur_radius=shs["first_cascade_blur_radius"];rshs.csm_last_cascade_border=shs["csm_last_cascade_border"];rshs.last_cascade_blur_radius=shs["last_cascade_blur_radius"];rshs.fade_last_cascade=false;rshs.blend_between_cascades=false}return rshs}function check_render_shadows(bpy_scene,lamps,mesh_objects){if(cfg_def.shadows)switch(bpy_scene["b4w_render_shadows"]){case "OFF":return false;case "ON":return true;case "AUTO":}else return false;var has_casters=
false;var has_receivers=false;var use_ssao=cfg_def.ssao&&bpy_scene["b4w_enable_ssao"];if(lamps.length==0&&!use_ssao)return false;for(var i=0;i<mesh_objects.length;i++){var obj=mesh_objects[i];var bpy_obj=obj.temp_bpy_obj;if(bpy_obj["b4w_shadow_cast"])has_casters=true;if(bpy_obj["b4w_shadow_receive"])has_receivers=true;if((use_ssao||has_casters)&&has_receivers)return true}return false}function check_scenes_sun(lamps){for(var i=0;i<lamps.length;i++)if(lamps[i].light.type=="SUN")return true;return false}
function check_shore_smoothing(objects){if(!cfg_def.shore_smoothing)return false;var mats=get_objs_materials(objects);for(var i=0;i<mats.length;i++){var mat=mats[i];if(mat["b4w_water"]&&mat["b4w_water_shore_smoothing"])return true}return false}function check_soft_particles(objects){for(var i=0;i<objects.length;i++){var obj=objects[i];var bpy_obj=obj.temp_bpy_obj;var psystems=bpy_obj["particle_systems"];for(var j=0;j<psystems.length;j++){var pset=psystems[j]["settings"];if(pset["b4w_enable_soft_particles"]&&
pset["b4w_particles_softness"]>0)return true}}return false}function get_water_params(objects){var mats=get_objs_materials(objects);var water_params=[];for(var i=0;i<mats.length;i++){var mat=mats[i];if(mat["b4w_water"]){var wp={};for(var j=0;j<objects.length;j++){var obj=objects[j];var bpy_obj=obj.temp_bpy_obj;var mesh=bpy_obj["data"];var mesh_mats=mesh["materials"];for(var k=0;k<mesh_mats.length;k++){var mesh_mat=mesh_mats[k];if(mesh_mat==mat)wp.water_level=bpy_obj["location"][1]}}wp.fog_color_density=
mat["b4w_water_fog_color"].slice(0);wp.fog_color_density.push(mat["b4w_water_fog_density"]);if(mat["b4w_water_dynamic"]){wp.dynamic=true;wp.waves_height=mat["b4w_waves_height"];wp.waves_length=mat["b4w_waves_length"];wp.dst_noise_scale0=mat["b4w_water_dst_noise_scale0"];wp.dst_noise_scale1=mat["b4w_water_dst_noise_scale1"];wp.dst_noise_freq0=mat["b4w_water_dst_noise_freq0"];wp.dst_noise_freq1=mat["b4w_water_dst_noise_freq1"];wp.dir_min_shore_fac=mat["b4w_water_dir_min_shore_fac"];wp.dir_freq=mat["b4w_water_dir_freq"];
wp.dir_noise_scale=mat["b4w_water_dir_noise_scale"];wp.dir_noise_freq=mat["b4w_water_dir_noise_freq"];wp.dir_min_noise_fac=mat["b4w_water_dir_min_noise_fac"];wp.dst_min_fac=mat["b4w_water_dst_min_fac"];wp.waves_hor_fac=mat["b4w_water_waves_hor_fac"]}else{wp.dynamic=false;wp.waves_height=0;wp.waves_length=0}wp.caustics=mat["b4w_water_enable_caust"];wp.caustic_scale=mat["b4w_water_caust_scale"];wp.caustic_brightness=mat["b4w_water_caust_brightness"];wp.caustic_speed=new Float32Array([.3,.7]);wp.shoremap_image=
null;var texture_slots=mat["texture_slots"];for(var j=0;j<texture_slots.length;j++){var texture=texture_slots[j]["texture"];if(texture["b4w_shore_dist_map"]===true){wp.shoremap_image=texture["image"];wp.shoremap_tex_size=texture["image"]["size"][0];wp.shore_boundings=texture["b4w_shore_boundings"];wp.max_shore_dist=texture["b4w_max_shore_dist"]}}water_params.push(wp)}}if(water_params.length>0){var wp=water_params[0];if(!wp.dynamic)for(var i=0;i<water_params.length;i++)if(water_params[i].dynamic)wp=
water_params[i];return wp}else return null}function get_material_params(objects){var materials_properties_existance={refractions:false};var materials=get_objs_materials(objects);var get_nodes_properties=function(node_tree){if(!node_tree)return;var nodes=node_tree["nodes"];for(var j=0;j<nodes.length;j++){var node=nodes[j];if(node["type"]=="GROUP"&&node["node_group"])get_nodes_properties(node["node_group"]["node_tree"]);if(node["type"]=="GROUP"&&node["node_tree_name"]=="B4W_REFRACTION")materials_properties_existance.refractions=
true}};for(var i=0;i<materials.length;i++){var material=materials[i];if(material["b4w_refractive"])materials_properties_existance.refractions=true;if(material["node_tree"])get_nodes_properties(material["node_tree"])}return materials_properties_existance}function check_anaglyph_use(cam_render){if(cam_render.cameras[0].type!=m_cam.TYPE_PERSP&&cfg_def.anaglyph_use){m_print.warn("Anaglyph stereo is disabled for the non-perspective camera");return false}else return cfg_def.anaglyph_use}function extract_reflections_params(bpy_scene,
scene_objs){if(cfg_def.reflections)switch(bpy_scene["b4w_render_reflections"]){case "OFF":return false;case "ON":}else return false;var refl_plane_objs=[];var num_cube_refl=0;for(var i=0;i<scene_objs.length;i++){var obj=scene_objs[i];if(obj.render.reflective&&obj.render.reflection_type=="CUBE")num_cube_refl++;if(obj.reflective_objs.length){var refl_plane_id=null;for(var j=0;j<refl_plane_objs.length;j++){var rp=refl_plane_objs[j];if(rp==obj){refl_plane_id=j;break}}if(refl_plane_id==null)refl_plane_objs.push(obj)}}return{refl_plane_objs:refl_plane_objs,
num_cube_refl:num_cube_refl,cube_refl_subs:[],plane_refl_subs:[]}}function extract_sky_params(world,sun_exist){var sky_settings=world["b4w_sky_settings"];var sky_params={};sky_params.render_sky=sky_settings["render_sky"];sky_params.procedural_skydome=sky_settings["procedural_skydome"]&&sun_exist;sky_params.use_as_environment_lighting=sky_settings["use_as_environment_lighting"];sky_params.sky_color=sky_settings["color"];sky_params.rayleigh_brightness=sky_settings["rayleigh_brightness"];sky_params.mie_brightness=
sky_settings["mie_brightness"];sky_params.spot_brightness=sky_settings["spot_brightness"];sky_params.scatter_strength=sky_settings["scatter_strength"];sky_params.rayleigh_strength=sky_settings["rayleigh_strength"];sky_params.mie_strength=sky_settings["mie_strength"];sky_params.rayleigh_collection_power=sky_settings["rayleigh_collection_power"];sky_params.mie_collection_power=sky_settings["mie_collection_power"];sky_params.mie_distribution=sky_settings["mie_distribution"];sky_params.reflexible=sky_settings["reflexible"];
sky_params.reflexible_only=sky_settings["reflexible_only"];if(!sun_exist&&sky_settings["procedural_skydome"])m_print.warn("There is no sun on the scene. "+"Procedural sky won't be rendered");return sky_params}function extract_ssao_params(bpy_scene){var ssao_params={};var ssao_settings=bpy_scene["b4w_ssao_settings"];ssao_params.radius_increase=ssao_settings["radius_increase"];ssao_params.hemisphere=ssao_settings["hemisphere"];ssao_params.blur_depth=ssao_settings["blur_depth"];ssao_params.blur_discard_value=
ssao_settings["blur_discard_value"];ssao_params.influence=ssao_settings["influence"];ssao_params.dist_factor=ssao_settings["dist_factor"];ssao_params.samples=ssao_settings["samples"];return ssao_params}function extract_bloom_params(bpy_scene){if(!(cfg_def.bloom&&bpy_scene["b4w_enable_bloom"]&&bpy_scene._render.sun_exist))return null;var bloom_params={};var bloom_settings=bpy_scene["b4w_bloom_settings"];bloom_params.blur=bloom_settings["blur"];bloom_params.edge_lum=bloom_settings["edge_lum"];bloom_params.key=
bloom_settings["key"];return bloom_params}function extract_mb_params(bpy_scene){var mb_params={};var mb_settings=bpy_scene["b4w_motion_blur_settings"];mb_params.mb_decay_threshold=mb_settings["motion_blur_decay_threshold"];mb_params.mb_factor=mb_settings["motion_blur_factor"];return mb_params}function extract_cc_params(bpy_scene){var cc_params={};var cc_settings=bpy_scene["b4w_color_correction_settings"];cc_params.brightness=cc_settings["brightness"];cc_params.contrast=cc_settings["contrast"];cc_params.exposure=
cc_settings["exposure"];cc_params.saturation=cc_settings["saturation"];return cc_params}function extract_god_rays_params(bpy_scene){var god_rays_params={};var god_rays_settings=bpy_scene["b4w_god_rays_settings"];god_rays_params.intensity=god_rays_settings["intensity"];god_rays_params.max_ray_length=god_rays_settings["max_ray_length"];god_rays_params.steps_per_pass=god_rays_settings["steps_per_pass"];return god_rays_params}function extract_outline_params(bpy_scene){var outline_params={};outline_params.outline_color=
bpy_scene["b4w_outline_color"];outline_params.outline_factor=bpy_scene["b4w_outline_factor"];return outline_params}function extract_glow_params(bpy_scene){var glow_params={};var glow_settings=bpy_scene["b4w_glow_settings"];glow_params.small_glow_mask_coeff=glow_settings["small_glow_mask_coeff"];glow_params.large_glow_mask_coeff=glow_settings["large_glow_mask_coeff"];glow_params.small_glow_mask_width=glow_settings["small_glow_mask_width"];glow_params.large_glow_mask_width=glow_settings["large_glow_mask_width"];
return glow_params}function get_world_light_set(world,sky_params){var wls=world["light_settings"];var wls_params={};wls_params.environment_energy=wls["environment_energy"];wls_params.use_environment_light=wls["use_environment_light"];wls_params.environment_color=wls["environment_color"];wls_params.horizon_color=world["horizon_color"].slice(0);wls_params.zenith_color=world["zenith_color"].slice(0);wls_params.use_sky_paper=world["use_sky_paper"];wls_params.use_sky_blend=world["use_sky_blend"];wls_params.use_sky_real=
world["use_sky_real"];wls_params.sky_texture_slot=null;wls_params.sky_texture_param=null;wls_params.environment_texture_slot=null;if(wls_params.use_environment_light&&wls_params.environment_color=="SKY_TEXTURE"&&!(sky_params.procedural_skydome&&sky_params.use_as_environment_lighting)){var tex_slot=null;for(var i=0;i<world["texture_slots"].length;i++)if(world["texture_slots"][i]["texture"]["b4w_use_as_environment_lighting"]){tex_slot=world["texture_slots"][i];break}if(!tex_slot){m_print.warn("environment lighting is set to 'Sky Texture'"+
", but there is no world texture with 'Sky Texture Usage' property set to 'ENVIRONMENT_LIGHTING'");wls_params.use_environment_light=false}else wls_params.environment_texture_slot=tex_slot}for(var i=0;i<world["texture_slots"].length;i++)if(world["texture_slots"][i]["texture"]["b4w_use_as_skydome"]){var sts=world["texture_slots"][i];wls_params.sky_texture_slot=sts;wls_params.sky_texture_param={blend_factor:sts["blend_factor"],horizon_factor:sts["horizon_factor"],zenith_up_factor:sts["zenith_up_factor"],
zenith_down_factor:sts["zenith_down_factor"],color:sts["color"],default_value:sts["default_value"],invert:sts["invert"],use_rgb_to_intensity:sts["use_rgb_to_intensity"],blend_type:sts["blend_type"],use_map_blend:sts["use_map_blend"],use_map_horizon:sts["use_map_horizon"],use_map_zenith_up:sts["use_map_zenith_up"],use_map_zenith_down:sts["use_map_zenith_down"]};break}return wls_params}function get_world_fog_set(world){var wfs=world["fog_settings"];var wfs_params={};wfs_params.use_fog=wfs["use_fog"];
wfs_params.intensity=wfs["intensity"];wfs_params.depth=wfs["depth"];wfs_params.start=wfs["start"];wfs_params.height=wfs["height"];wfs_params.falloff=wfs["falloff"];if(wfs["use_custom_color"])wfs_params.color=wfs["color"].slice(0);else wfs_params.color=world["horizon_color"].slice(0);var fog_color=wfs_params.color;var fog_dens=1/wfs_params.depth;wfs_params.fog_color_density=new Float32Array([fog_color[0],fog_color[1],fog_color[2],fog_dens]);wfs_params.fog_params=new Float32Array([wfs_params.intensity,
wfs_params.depth,wfs_params.start,wfs_params.height]);return wfs_params}function check_dynamic_grass(objects){if(!cfg_def.dynamic_grass)return false;var has_terrain=false;var has_dyn_grass=false;for(var i=0;i<objects.length;i++){var obj=objects[i];var bpy_obj=obj.temp_bpy_obj;var materials=bpy_obj["data"]["materials"];for(var j=0;j<materials.length;j++){var mat=materials[j];if(mat["b4w_terrain"])has_terrain=true}var psystems=bpy_obj["particle_systems"];for(var j=0;j<psystems.length;j++){var pset=
psystems[j]["settings"];if(pset["type"]=="HAIR"&&pset["b4w_dynamic_grass"])has_dyn_grass=true}if(has_terrain&&has_dyn_grass)return true}return false}function check_selectable_objects(bpy_scene,objects){if(cfg_out.outlining_overview_mode)return true;if(cfg_def.enable_selectable)switch(bpy_scene["b4w_enable_object_selection"]){case "OFF":return false;case "ON":return true;case "AUTO":for(var i=0;i<objects.length;i++){var obj=objects[i];if(obj.render.selectable)return true}return false}else return false}
function check_outlining_objects(bpy_scene,objects){if(cfg_out.outlining_overview_mode)return true;if(cfg_def.enable_outlining)switch(bpy_scene["b4w_enable_outlining"]){case "OFF":return false;case "ON":return true;case "AUTO":for(var i=0;i<objects.length;i++){var obj=objects[i];if(obj.render.outlining)return true}return false}else return false}function check_glow_materials(bpy_scene,objects){if(cfg_def.glow_materials)switch(bpy_scene["b4w_enable_glow_materials"]){case "OFF":return false;case "ON":return true;
case "AUTO":for(var i=0;i<objects.length;i++){var obj=objects[i];var bpy_obj=obj.temp_bpy_obj;var mesh=bpy_obj["data"];var materials=mesh["materials"];for(var j=0;j<materials.length;j++)if(m_nodemat.check_material_glow_output(materials[j]))return true}return false}else return false}function check_refraction(bpy_scene,mat_params){if(cfg_def.refractions)switch(bpy_scene["b4w_render_refractions"]){case "OFF":return false;case "ON":return true;case "AUTO":return mat_params.refractions}else return false}
function check_xray_materials(objects){for(var i=0;i<objects.length;i++){var obj=objects[i];var bpy_obj=obj.temp_bpy_obj;var materials=bpy_obj["data"]["materials"];for(var j=0;j<materials.length;j++){var mat=materials[j];var gs=mat["game_settings"];var alpha_blend=gs["alpha_blend"];if(mat["b4w_render_above_all"]&&alpha_blend!="OPAQUE"&&alpha_blend!="CLIP")return true}}return false}function check_anchor_visibility_objects(bpy_scene,empty_objs){switch(bpy_scene["b4w_enable_anchors_visibility"]){case "OFF":return false;
case "ON":return true;case "AUTO":}for(var i=0;i<empty_objs.length;i++){var obj=empty_objs[i];if(obj.anchor&&obj.anchor.detect_visibility)return true}return false}exports.get_graph=function(scene){return scene._render.graph};exports.generate_auxiliary_batches=function(graph){m_graph.traverse(graph,function(node,attr){var subs=attr;var batch=null;switch(subs.type){case "POSTPROCESSING":batch=m_batch.create_postprocessing_batch(subs.pp_effect);break;case "SSAO":batch=m_batch.create_ssao_batch(subs);
break;case "SSAO_BLUR":batch=m_batch.create_ssao_blur_batch(subs);break;case "DEPTH_PACK":batch=m_batch.create_depth_pack_batch();break;case "REFRACT":case "COPY":batch=m_batch.create_postprocessing_batch("NONE");break;case "GOD_RAYS":var subs_input=m_scgraph.find_input(graph,subs,"WIREFRAME")||m_scgraph.find_input(graph,subs,"MAIN_BLEND")||m_scgraph.find_input(graph,subs,"GOD_RAYS");var tex_input=subs_input.camera.color_attachment;var water=subs.water;var steps=subs.steps_per_pass;batch=m_batch.create_god_rays_batch(tex_input,
subs.pack,water,steps);break;case "GOD_RAYS_COMBINE":var subs_input=m_scgraph.find_input(graph,subs,"WIREFRAME")||m_scgraph.find_input(graph,subs,"MAIN_BLEND");var subs_god_rays=m_scgraph.find_input(graph,subs,"GOD_RAYS");var tex_main=subs_input.camera.color_attachment;var tex_god_rays=subs_god_rays.camera.color_attachment;batch=m_batch.create_god_rays_combine_batch(tex_main,tex_god_rays);break;case "MOTION_BLUR":batch=m_batch.create_motion_blur_batch(subs.mb_decay_threshold);break;case "DOF":batch=
m_batch.create_dof_batch();var subs_pp1=m_scgraph.find_input(graph,subs,"POSTPROCESSING");var subs_pp2=m_scgraph.find_input(graph,subs_pp1,"POSTPROCESSING");m_scgraph.set_texel_size_mult(subs_pp1,subs.camera.dof_power);m_scgraph.set_texel_size_mult(subs_pp2,subs.camera.dof_power);break;case "OUTLINE":batch=m_batch.create_outline_batch();var subs_outline_blur_y=m_scgraph.find_input(graph,subs,"POSTPROCESSING");var subs_outline_blur_x=m_scgraph.find_input(graph,subs_outline_blur_y,"POSTPROCESSING");
var subs_outline_extend_y=m_scgraph.find_input(graph,subs_outline_blur_x,"POSTPROCESSING");var subs_outline_extend_x=m_scgraph.find_input(graph,subs_outline_extend_y,"POSTPROCESSING");m_scgraph.set_texel_size_mult(subs_outline_blur_x,subs.blur_texel_size_mult);m_scgraph.set_texel_size_mult(subs_outline_blur_y,subs.blur_texel_size_mult);m_scgraph.set_texel_size_mult(subs_outline_extend_x,subs.ext_texel_size_mult*subs.outline_factor);m_scgraph.set_texel_size_mult(subs_outline_extend_y,subs.ext_texel_size_mult*
subs.outline_factor);break;case "GLOW_COMBINE":batch=m_batch.create_glow_combine_batch();break;case "COMPOSITING":batch=m_batch.create_compositing_batch();break;case "ANTIALIASING":batch=m_batch.create_antialiasing_batch();break;case "SMAA_RESOLVE":case "SMAA_EDGE_DETECTION":case "SMAA_BLENDING_WEIGHT_CALCULATION":case "SMAA_NEIGHBORHOOD_BLENDING":batch=m_batch.create_smaa_batch(subs.type);break;case "ANAGLYPH":batch=m_batch.create_anaglyph_batch();break;case "SKY":batch=m_batch.create_procedural_sky_batch();
break;case "LUMINANCE":batch=m_batch.create_luminance_batch();break;case "AVERAGE_LUMINANCE":batch=m_batch.create_average_luminance_batch();break;case "LUMINANCE_TRUNCED":batch=m_batch.create_luminance_trunced_batch();break;case "BLOOM_BLUR":batch=m_batch.create_bloom_blur_batch();break;case "BLOOM":var subs_blur_y=m_scgraph.find_input(graph,subs,"BLOOM_BLUR");var subs_blur_x=m_scgraph.find_input(graph,subs_blur_y,"BLOOM_BLUR");m_scgraph.set_texel_size_mult(subs_blur_y,subs.bloom_blur);m_scgraph.set_texel_size_mult(subs_blur_x,
subs.bloom_blur);batch=m_batch.create_bloom_combine_batch();break;case "VELOCITY":batch=m_batch.create_velocity_batch();break;case "ANCHOR_VISIBILITY":batch=m_batch.create_anchor_visibility_batch();break}if(batch){var rb=init_bundle(m_obj_util.create_render("NONE"),batch);validate_batch(batch);subs.bundles.push(rb);connect_textures(graph,subs,batch);check_batch_textures_number(batch)}})};function connect_textures(graph,subs,batch){var id=m_graph.node_by_attr(graph,subs);m_graph.traverse_inputs(graph,
id,function(id_in,attr_in,attr_edge){var slink=attr_edge;var subs_in=attr_in;if(!slink.active)return;switch(slink.from){case "COLOR":case "CUBEMAP":var tex=subs_in.camera.color_attachment;break;case "DEPTH":var tex=subs_in.camera.depth_attachment;break;case "SCREEN":var tex=null;break;case "MAIN_CUBE_REFLECT":return;default:throw"Wrong slink";}switch(slink.to){case "COLOR":case "CUBEMAP":case "DEPTH":case "NONE":case "SCREEN":case "OFFSCREEN":case "u_cube_reflection":case "u_plane_reflection":break;
default:if(!tex)throw"Connection of SCREEN is forbidden";if(tex.w_renderbuffer)throw"Batch texture can't use renderbuffer";if(m_shaders.check_uniform(batch.shader,slink.to))m_batch.append_texture(batch,tex,slink.to);break}});for(var i=0;i<subs.slinks_internal.length;i++){var slink=subs.slinks_internal[i];var tex=subs.textures_internal[i];switch(slink.to){case "COLOR":case "CUBEMAP":case "DEPTH":case "NONE":case "SCREEN":case "OFFSCREEN":break;default:if(tex.w_renderbuffer)throw"Batch texture can't use renderbuffer";
if(m_shaders.check_uniform(batch.shader,slink.to))m_batch.append_texture(batch,tex,slink.to);break}}}exports.append_object=function(scene,obj,copy){var type=obj.type;switch(type){case "MESH":var graph=scene._render.graph;var obj_render=obj.render;if(!m_scgraph.find_subs(graph,"SHADOW_CAST")&&obj_render.shadow_receive)obj_render.shadow_receive=false;var subs_arr=subs_array(scene,OBJECT_SUBSCENE_TYPES);if(copy&&m_phy.obj_has_physics(obj))m_phy.append_object(obj,scene);for(var i=0;i<subs_arr.length;i++){var subs=
subs_arr[i];add_object_sub(subs,obj,graph,scene,copy)}break;case "LAMP":update_lamp_scene(obj,scene);break;default:break}m_obj_util.scene_data_set_active(obj,true,scene)};function init_bundle(render,batch){return{do_render:true,do_render_cube:[true,true,true,true,true,true],obj_render:render,batch:batch}}function add_object_sub(subs,obj,graph,bpy_scene,copy){switch(subs.type){case "MAIN_OPAQUE":add_object_subs_main(subs,obj,graph,"OPAQUE",bpy_scene,copy);break;case "MAIN_BLEND":add_object_subs_main(subs,
obj,graph,"BLEND",bpy_scene,copy);break;case "MAIN_XRAY":add_object_subs_main(subs,obj,graph,"XRAY",bpy_scene,copy);break;case "MAIN_GLOW":add_object_subs_main(subs,obj,graph,"GLOW",bpy_scene,copy);break;case "MAIN_PLANE_REFLECT":case "MAIN_CUBE_REFLECT":add_object_subs_reflect(subs,obj,graph,bpy_scene,copy);break;case "DEPTH":add_object_subs_depth(subs,obj,graph,bpy_scene,copy);break;case "SHADOW_CAST":add_object_subs_shadow(subs,obj,graph,bpy_scene,copy);break;case "COLOR_PICKING":add_object_subs_color_picking(subs,
obj,graph,bpy_scene,copy);break;case "COLOR_PICKING_XRAY":add_object_subs_color_picking(subs,obj,graph,bpy_scene,copy);break;case "OUTLINE_MASK":add_object_subs_outline_mask(subs,obj,graph,bpy_scene,copy);break;case "GRASS_MAP":add_object_subs_grass_map(subs,obj,bpy_scene,copy);break;case "WIREFRAME":add_object_subs_wireframe(subs,obj,graph,bpy_scene,copy);break;default:break}}function add_object_subs_main(subs,obj,graph,main_type,scene,copy){var obj_render=obj.render;var sc_data=m_obj_util.get_scene_data(obj,
scene);var batches=sc_data.batches;for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.shadow_cast_only||batch.reflexible_only)continue;if(batch.type!="MAIN"&&batch.type!="NODES_GLOW"&&batch.type!="PARTICLES")continue;if(!(batch.subtype=="OPAQUE"&&main_type=="OPAQUE"||batch.subtype=="BLEND"&&main_type=="BLEND"||batch.subtype=="XRAY"&&main_type=="XRAY"||batch.type=="NODES_GLOW"&&main_type=="GLOW"))continue;if(!copy){update_batch_subs(batch,subs,obj,graph,main_type,scene);m_batch.update_shader(batch);
validate_batch(batch)}var rb=init_bundle(obj_render,batch);subs.bundles.push(rb);connect_textures(graph,subs,batch);check_batch_textures_number(batch)}var sort_fun=function(a,b){if(a==b)return 0;return a>b?1:-1};var sort_fun_double=function(a,b){if(a.batch&&b.batch)return-sort_fun(a.batch.blend,b.batch.blend)||-sort_fun(a.batch.alpha_clip,b.batch.alpha_clip)||sort_fun(a.batch.offset_z,b.batch.offset_z);else return 0};subs.bundles.sort(sort_fun_double)}function update_batch_subs(batch,subs,obj,graph,
main_type,bpy_scene){var obj_render=obj.render;var scene_data=m_obj_util.get_scene_data(obj,bpy_scene);var shadow_usage="NO_SHADOWS";var subs_cast=m_scgraph.find_subs(graph,"SHADOW_CAST");if(subs_cast&&batch.shadow_receive){switch(main_type){case "OPAQUE":shadow_usage="SHADOW_MAPPING_OPAQUE";break;case "BLEND":case "XRAY":shadow_usage="SHADOW_MAPPING_BLEND";break;case "COLOR_ID":case "REFLECT":case "GLOW":shadow_usage="NO_SHADOWS";break;case "DEPTH":shadow_usage="SHADOW_MASK_GENERATION";break;default:throw"Wrong subscene type";
}m_batch.assign_shadow_receive_dirs(batch,bpy_scene._render.shadow_params,subs_cast)}var shaders_info=batch.shaders_info;m_shaders.set_directive(shaders_info,"SHADOW_USAGE",shadow_usage);if(batch.dynamic_grass){var subs_grass_map=m_scgraph.find_subs(graph,"GRASS_MAP");if(subs_grass_map)prepare_dynamic_grass_batch(batch,subs_grass_map,obj_render)}if((batch.type=="DEPTH"||main_type=="COLOR_ID")&&!batch.has_nodes)return;var num_lights=subs.num_lights;m_shaders.set_directive(shaders_info,"NUM_LIGHTS",
num_lights);var num_lfac=num_lights%2==0?num_lights/2:Math.floor(num_lights/2)+1;m_shaders.set_directive(shaders_info,"NUM_LFACTORS",num_lfac);if(m_shaders.get_fname(shaders_info)=="special_skydome.glslf")m_shaders.set_directive(shaders_info,"REFLECTION_PASS",0);m_shaders.set_directive(shaders_info,"SSAO_ONLY",0);if(subs.water_params&&subs.water_fog_color_density)m_shaders.set_directive(shaders_info,"WATER_EFFECTS",1);else m_shaders.set_directive(shaders_info,"WATER_EFFECTS",0);if(subs.water_params&&
subs.caustics&&obj_render.caustics){m_shaders.set_directive(shaders_info,"CAUSTICS",1);m_shaders.set_directive(shaders_info,"CAUST_SCALE",m_shaders.glsl_value(subs.caust_scale));m_shaders.set_directive(shaders_info,"CAUST_SPEED",m_shaders.glsl_value(subs.caust_speed,2));m_shaders.set_directive(shaders_info,"CAUST_BRIGHT",m_shaders.glsl_value(subs.caust_brightness))}else m_shaders.set_directive(shaders_info,"CAUSTICS",0);if(subs.water_params){m_shaders.set_directive(shaders_info,"WAVES_HEIGHT",m_shaders.glsl_value(subs.water_waves_height));
m_shaders.set_directive(shaders_info,"WAVES_LENGTH",m_shaders.glsl_value(subs.water_waves_length));m_shaders.set_directive(shaders_info,"WATER_LEVEL",m_shaders.glsl_value(subs.water_level))}var subs_cube_refl=scene_data.cube_refl_subs;var subs_plane_refl=scene_data.plane_refl_subs;if(batch.texture_names.indexOf("u_mirrormap")!==-1)m_shaders.set_directive(shaders_info,"REFLECTION_TYPE","REFL_MIRRORMAP");else if(batch.reflective&&subs_cube_refl){var tex=subs_cube_refl.camera.color_attachment;m_batch.append_texture(batch,
tex,"u_cube_reflection");m_shaders.set_directive(shaders_info,"REFLECTION_TYPE","REFL_CUBE")}else if(batch.reflective&&subs_plane_refl){var tex=subs_plane_refl.camera.color_attachment;m_batch.append_texture(batch,tex,"u_plane_reflection");m_shaders.set_directive(shaders_info,"REFLECTION_TYPE","REFL_PLANE")}else m_shaders.set_directive(shaders_info,"REFLECTION_TYPE","REFL_NONE");var subs_sky=m_scgraph.find_subs(graph,"SKY");if(subs_sky)if(batch.procedural_sky){var tex=subs_sky.camera.color_attachment;
m_batch.append_texture(batch,tex,"u_sky")}else if(cfg_def.procedural_fog){batch.cube_fog=subs_sky.cube_fog;m_shaders.set_directive(shaders_info,"PROCEDURAL_FOG",1)}else m_shaders.set_directive(shaders_info,"PROCEDURAL_FOG",0);else m_shaders.set_directive(shaders_info,"PROCEDURAL_FOG",0);var wls=bpy_scene._render.world_light_set;if(wls.use_environment_light){m_shaders.set_directive(shaders_info,"USE_ENVIRONMENT_LIGHT",1);if(wls.environment_color=="SKY_TEXTURE"){var tex=null;if(wls.environment_texture_slot)tex=
m_batch.get_batch_texture(wls.environment_texture_slot,false);else tex=subs_sky.camera.color_attachment;m_shaders.set_directive(shaders_info,"SKY_TEXTURE",1);m_batch.append_texture(batch,tex,"u_sky_texture")}else if(wls.environment_color=="SKY_COLOR")m_shaders.set_directive(shaders_info,"SKY_COLOR",1)}var wfs=bpy_scene._render.world_fog_set;if(wfs.use_fog){m_shaders.set_directive(shaders_info,"USE_FOG",1);m_shaders.set_directive(shaders_info,"FOG_TYPE",wfs.falloff)}if(batch.refractive){if(cfg_def.depth_tex_available)m_shaders.set_directive(shaders_info,
"USE_REFRACTION_CORRECTION",1);if(batch.type=="MAIN"&&batch.has_nodes||batch.type=="NODES_GLOW"){m_shaders.set_directive(shaders_info,"REFRACTIVE",1);if(bpy_scene._render.refractions)m_shaders.set_directive(shaders_info,"USE_REFRACTION",1);else m_shaders.set_directive(shaders_info,"USE_REFRACTION",0)}else if(bpy_scene._render.refractions)m_shaders.set_directive(shaders_info,"REFRACTIVE",1);else m_shaders.set_directive(shaders_info,"REFRACTIVE",0)}else{m_shaders.set_directive(shaders_info,"REFRACTIVE",
0);m_shaders.set_directive(shaders_info,"USE_REFRACTION",0);m_shaders.set_directive(shaders_info,"USE_REFRACTION_CORRECTION",0)}if(batch.water){if(cfg_def.shore_smoothing&&batch.water_shore_smoothing&&m_scgraph.find_subs(graph,"DEPTH"))m_shaders.set_directive(shaders_info,"SHORE_SMOOTHING",1);else m_shaders.set_directive(shaders_info,"SHORE_SMOOTHING",0);if(batch.water_dynamic&&subs.water_params&&subs.water_waves_height)m_shaders.set_directive(shaders_info,"DYNAMIC",1);else m_shaders.set_directive(shaders_info,
"DYNAMIC",0)}if(batch.type=="PARTICLES"){m_shaders.set_directive(shaders_info,"SIZE_RAMP_LENGTH",batch.particles_data.size_ramp_length);m_shaders.set_directive(shaders_info,"COLOR_RAMP_LENGTH",batch.particles_data.color_ramp_length)}if(!batch.forked_batch){var textures=batch.textures;for(var j=0;j<textures.length;j++){var tex=textures[j];if(tex.source=="SCENE")for(var k=0;k<_scenes.length;k++){var scene_k=_scenes[k];var rtt=_scenes[k]._render_to_textures;for(var l=0;l<rtt.length;l++)if(rtt[l]._render==
tex)m_graph.append_edge_attr(_scenes_graph,scene_k,bpy_scene,null)}}}}function validate_batch(batch){var shader=batch.shader;var attributes=shader.attributes;var pointers=batch.bufs_data.pointers;for(var attr in attributes){var p=pointers[attr];if(!p)m_util.panic('missing data for "'+attr+'" attribute')}validate_batch_varyings(batch)}function validate_batch_varyings(batch){if(batch.type=="MAIN"||batch.type=="NODES_GLOW"){var vcount=m_shaders.get_varyings_count(batch.shader.vshader);if(vcount>MAX_SHADER_VARYING_COUNT){if(batch.type==
"MAIN")m_print.warn("Varying limit exceeded for main shader - "+vcount+', materials: "'+batch.material_names.join(", ")+'"');if(batch.type=="MAIN"&&batch.has_nodes||batch.type=="NODES_GLOW"){var used_uv=0;var used_vc=0;if(batch.uv_maps_usage)used_uv=m_util.get_dict_length(batch.uv_maps_usage);if(batch.vertex_colors_usage)used_vc=m_util.get_dict_length(batch.vertex_colors_usage);m_print.warn("Varying limit exceeded for node shader - "+vcount+", uv: "+used_uv+", vc: "+used_vc+', materials: "'+batch.material_names.join(", ")+
'"')}}}}function check_batch_textures_number(batch){if(batch.textures.length>MAX_BATCH_TEXTURES)m_print.warn(batch.type,"too many textures used - "+batch.textures.length+" (max "+MAX_BATCH_TEXTURES+'), materials "'+batch.material_names.join(", ")+'"')}function prepare_dynamic_grass_batch(batch,subs_grass_map,obj_render){batch.grass_map_dim=subs_grass_map.grass_map_dim;var low=subs_grass_map.grass_map_dim[0];var high=subs_grass_map.grass_map_dim[1];var size=subs_grass_map.grass_map_dim[2];var bb=obj_render.bb_local;
var bb_max_size=Math.max(bb.max_x-bb.min_x,bb.max_z-bb.min_z);if(size==0)size=bb_max_size;else size=Math.max(size,bb_max_size);subs_grass_map.grass_map_dim[2]=size;var cam=subs_grass_map.camera;m_cam.set_frustum(cam,size/2,-high,-low,size/2);m_cam.set_projection(cam);var bsize=batch.grass_size||0;if(bsize==0)bsize=bb_max_size;else bsize=Math.max(bsize,bb_max_size);batch.grass_size=bsize}function has_batch(subscene,batch){var sbundles=subscene.bundles;for(var i=0;i<sbundles.length;i++){var sbundle=
sbundles[i];var sbatch=sbundle.batch;if(sbatch&&sbatch.id==batch.id)return true}return false}function debug_report_order(bundles){var names=[];for(var i=0;i<bundles.length;i++){var batch=bundles[i].batch;if(batch)names.push(batch.name.split("*")[2]);else names.push("NULL")}m_print.log(names)}function add_object_subs_depth(subs,obj,graph,scene,copy){var sc_data=m_obj_util.get_scene_data(obj,scene);var batches=sc_data.batches;for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.type!="DEPTH"||
batch.shadow_cast_only)continue;if(batch.subtype!="DEPTH"&&batch.subtype!="NODES")continue;if(!copy){update_batch_subs(batch,subs,obj,graph,"DEPTH",scene);m_batch.update_shader(batch);validate_batch(batch)}var rb=init_bundle(obj.render,batch);subs.bundles.push(rb);connect_textures(graph,subs,batch);check_batch_textures_number(batch)}}function add_object_subs_shadow(subs,obj,graph,scene,copy){var update_needed=false;var obj_render=obj.render;var sc_data=m_obj_util.get_scene_data(obj,scene);var batches=
sc_data.batches;var subs_grass_map=m_scgraph.find_subs(graph,"GRASS_MAP");for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.type!="DEPTH")continue;if(batch.subtype!="SHADOW_CAST")continue;update_needed=true;if(!copy){var num_lights=subs.num_lights;m_batch.set_batch_directive(batch,"NUM_LIGHTS",num_lights);var num_lfac=num_lights%2==0?num_lights/2:Math.floor(num_lights/2)+1;m_batch.set_batch_directive(batch,"NUM_LFACTORS",num_lfac);m_shaders.set_directive(batch.shaders_info,"SHADOW_USAGE",
"SHADOW_CASTING");if(batch.dynamic_grass&&subs_grass_map)prepare_dynamic_grass_batch(batch,subs_grass_map,obj_render);m_batch.set_batch_directive(batch,"SHADOW_TEX_RES",m_shaders.glsl_value(scene._render.shadow_params.csm_resolution));m_batch.update_shader(batch);validate_batch(batch)}var rb=init_bundle(obj_render,batch);subs.bundles.push(rb)}if(update_needed){var sh_params=scene._render.shadow_params;var subs_main=m_scgraph.find_subs(graph,"MAIN_OPAQUE");update_subs_shadow(subs,subs_main.camera,
subs.bundles,sh_params,true)}}function add_object_subs_reflect(subs,obj,graph,scene,copy){var obj_render=obj.render;var sc_data=m_obj_util.get_scene_data(obj,scene);var batches=sc_data.batches;for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.type!="MAIN"&&batch.type!="PARTICLES")continue;if(batch.subtype!="REFLECT")continue;if(subs.type=="MAIN_PLANE_REFLECT"){var refl_id=get_plane_refl_id_by_subs(scene,subs);if(refl_id==obj_render.plane_reflection_id)continue}else{var refl_id=get_cube_refl_id_by_subs(scene,
subs);if(refl_id==obj_render.cube_reflection_id)continue}if(!copy){update_batch_subs(batch,subs,obj,graph,"REFLECT",scene);var shaders_info=batch.shaders_info;m_shaders.set_directive(shaders_info,"DISABLE_FOG",0);m_shaders.set_directive(shaders_info,"WATER_EFFECTS",0);if(m_shaders.get_fname(shaders_info)=="special_skydome.glslf")m_shaders.set_directive(shaders_info,"REFLECTION_PASS",1);m_shaders.set_directive(shaders_info,"TEXTURE_NORM",0);m_batch.update_shader(batch);validate_batch(batch)}var rb=
init_bundle(obj_render,batch);subs.bundles.push(rb)}}exports.schedule_shadow_update=schedule_shadow_update;function schedule_shadow_update(bpy_scene){bpy_scene._render.need_shadow_update=true}function update_shadow_subscenes(bpy_scene){var subs_main=get_subs(bpy_scene,"MAIN_OPAQUE");var graph=bpy_scene._render.graph;var recalc_z_bounds=true;var sh_params=bpy_scene._render.shadow_params;m_graph.traverse(graph,function(node,attr){var subs=attr;if(subs.type==="SHADOW_CAST"){update_subs_shadow(subs,subs_main.camera,
subs.bundles,sh_params,recalc_z_bounds);recalc_z_bounds=false}})}function enable_outline_draw(scene){var graph=scene._render.graph;m_graph.traverse(graph,function(node,subs){if(subs.type==="OUTLINE")subs.draw_outline_flag=1})}function update_subs_shadow(subs,cam_main,cast_bundles,sh_params,recalc_z_bounds){if(cast_bundles.length==0)return;var cam=subs.camera;m_vec3.copy(cam_main.eye,cam.eye);m_mat4.copy(cam_main.view_matrix,cam.shadow_cast_billboard_view_matrix);if(sh_params.lamp_type==="SUN"||sh_params.lamp_type===
"HEMI"){var bb_world=get_shadow_casters_bb(cast_bundles,_bb_tmp);var bb_corners=m_bounds.extract_bb_corners(bb_world,_corners_cache);m_util.positions_multiply_matrix(bb_corners,cam.view_matrix,bb_corners);if(sh_params.enable_csm){var center=m_vec3.copy(cam_main.csm_centers[subs.csm_index],_vec3_tmp);var main_view_inv=m_mat4.invert(cam_main.view_matrix,_mat4_tmp);m_util.positions_multiply_matrix(center,main_view_inv,center);m_util.positions_multiply_matrix(center,cam.view_matrix,center);var radius=
cam_main.csm_radii[subs.csm_index];if(recalc_z_bounds){_shadow_cast_min_z=0;_shadow_cast_max_z=-Infinity;for(var i=2;i<bb_corners.length;i+=3){_shadow_cast_min_z=Math.min(_shadow_cast_min_z,bb_corners[i]);_shadow_cast_max_z=Math.max(_shadow_cast_max_z,bb_corners[i])}}var bb_view=_bb_tmp;bb_view.max_x=center[0]+radius;bb_view.max_y=center[1]+radius;bb_view.max_z=_shadow_cast_max_z;bb_view.min_x=center[0]-radius;bb_view.min_y=center[1]-radius;bb_view.min_z=_shadow_cast_min_z}else{var bb_view=_bb_tmp;
var optimal_angle=get_optimal_bb_and_angle(bb_corners,bb_view);if(optimal_angle>0){var rot_mat=m_mat4.identity(_mat4_tmp);m_mat4.rotate(rot_mat,optimal_angle,m_util.AXIS_MZ,rot_mat);m_mat4.multiply(rot_mat,cam.view_matrix,cam.view_matrix)}bb_view=correct_bb_proportions(bb_view)}m_cam.set_frustum_asymmetric(cam,bb_view.min_x,bb_view.max_x,bb_view.min_y,bb_view.max_y,-bb_view.max_z,-bb_view.min_z);m_cam.set_projection(cam);m_util.extract_frustum_planes(cam.view_proj_matrix,cam.frustum_planes)}else if(sh_params.lamp_type===
"SPOT"||sh_params.lamp_type==="POINT")m_cam.set_projection(cam,cam.aspect)}function get_optimal_bb_and_angle(bb_corners,bb_dest){var rot_corners=_corners_cache2;rot_corners.set(bb_corners);var angle_delta=MAX_OPTIMAL_BB_ANGLE/(OPTIMAL_BB_COUNT-1);var rot_mat=m_mat4.identity(_mat4_tmp);m_mat4.rotate(rot_mat,angle_delta,m_util.AXIS_MZ,rot_mat);var min=-1;var min_index=-1;for(var i=0;i<OPTIMAL_BB_COUNT;i++){var bb_all=m_bounds.bb_from_coords(rot_corners,_bb_tmp2);var S=(bb_all.max_x-bb_all.min_x)*(bb_all.max_y-
bb_all.min_y);if(min==-1||S<min){min=S;min_index=i;m_bounds.copy_bb(bb_all,bb_dest)}m_util.positions_multiply_matrix(rot_corners,rot_mat,rot_corners)}return min_index*angle_delta}function correct_bb_proportions(bb){var x=bb.max_x-bb.min_x;var y=bb.max_y-bb.min_y;if(x&&y){var diff=Math.abs(x-y)/2;if(x/y>MAX_SHADOW_CAST_BB_PROPORTION){bb.max_y+=diff;bb.min_y-=diff}else if(y/x>MAX_SHADOW_CAST_BB_PROPORTION){bb.max_x+=diff;bb.min_x-=diff}}bb.max_x+=SHADOW_MAP_EPSILON_XY;bb.max_y+=SHADOW_MAP_EPSILON_XY;
bb.max_z+=SHADOW_MAP_EPSILON_Z;bb.min_x-=SHADOW_MAP_EPSILON_XY;bb.min_y-=SHADOW_MAP_EPSILON_XY;bb.min_z-=SHADOW_MAP_EPSILON_Z;return bb}function get_shadow_casters_bb(cast_bundles,dest){m_bounds.zero_bounding_box(dest);for(var i=0;i<cast_bundles.length;i++){var render=cast_bundles[i].obj_render;if(i==0)m_bounds.copy_bb(render.bb_world,dest);else m_bounds.expand_bounding_box(dest,render.bb_world)}return dest}exports.get_csm_borders=get_csm_borders;function get_csm_borders(scene,cam){var shs=scene._render.shadow_params;
var rslt=new Float32Array(shs.csm_num);for(var i=0;i<shs.csm_num;i++)rslt[i]=m_cam.csm_far_plane(shs,cam,i);return rslt}function add_object_subs_color_picking(subs,obj,graph,scene,copy){var obj_render=obj.render;var sc_data=m_obj_util.get_scene_data(obj,scene);var batches=sc_data.batches;for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.type!="COLOR_ID")continue;if(!copy){update_batch_subs(batch,subs,obj,graph,"COLOR_ID",scene);m_batch.update_shader(batch);validate_batch(batch)}if(!(subs.type==
"COLOR_PICKING"&&batch.subtype=="COLOR_ID"||subs.type=="COLOR_PICKING_XRAY"&&batch.subtype=="COLOR_ID_XRAY"))continue;if(!copy){m_batch.set_batch_directive(batch,"USE_OUTLINE",0);m_batch.update_shader(batch);validate_batch(batch)}var rb=init_bundle(obj_render,batch);subs.bundles.push(rb)}}function add_object_subs_wireframe(subs,obj,graph,scene,copy){var obj_render=obj.render;var sc_data=m_obj_util.get_scene_data(obj,scene);var batches=sc_data.batches;for(var i=0;i<batches.length;i++){var batch=batches[i];
if(batch.type!="WIREFRAME")continue;append_wireframe_batch(subs,obj_render,graph,copy,batch)}}exports.append_wireframe_batch=append_wireframe_batch;function append_wireframe_batch(subs,obj_render,graph,copy,batch){if(!copy){if(batch.dynamic_grass){var subs_grass_map=m_scgraph.find_subs(graph,"GRASS_MAP");if(subs_grass_map)prepare_dynamic_grass_batch(batch,subs_grass_map,obj_render)}m_batch.update_shader(batch);validate_batch(batch)}var rb=init_bundle(obj_render,batch);subs.bundles.push(rb);connect_textures(graph,
subs,batch);check_batch_textures_number(batch)}function add_object_subs_grass_map(subs,obj,scene,copy){var obj_render=obj.render;var sc_data=m_obj_util.get_scene_data(obj,scene);var batches=sc_data.batches;for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.type!="GRASS_MAP")continue;if(!copy){m_batch.update_shader(batch);validate_batch(batch)}var rb=init_bundle(obj_render,batch);subs.bundles.push(rb);var cam=subs.camera;var bb=obj_render.bb_world;var low=subs.grass_map_dim[0];var high=
subs.grass_map_dim[1];var size=subs.grass_map_dim[2];if(low==0&&high==0){low=bb.min_y;high=bb.max_y}else{low=Math.min(low,bb.min_y);high=Math.max(high,bb.max_y)}var map_margin=(high-low)*GRASS_MAP_MARGIN;subs.grass_map_dim[0]=low-map_margin;subs.grass_map_dim[1]=high+map_margin;m_cam.set_frustum(cam,size/2,-high,-low,size/2);m_cam.set_projection(cam)}}function add_object_subs_outline_mask(subs,obj,graph,scene,copy){var obj_render=obj.render;var sc_data=m_obj_util.get_scene_data(obj,scene);var batches=
sc_data.batches;for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.type!="COLOR_ID")continue;if(batch.subtype!="OUTLINE")continue;if(!copy){m_batch.set_batch_directive(batch,"USE_OUTLINE",1);m_batch.update_shader(batch);validate_batch(batch)}var rb=init_bundle(obj_render,batch);subs.bundles.push(rb)}}exports.hide_object=function(obj){obj.render.hide=true};exports.show_object=function(obj){obj.render.hide=false};exports.is_hidden=function(obj){return obj.render.hide};exports.remove_object_bundles=
function(scene,obj,clean_buffs){var render=obj.render;var subscenes=subs_array(scene,OBJECT_SUBSCENE_TYPES);for(var i=0;i<subscenes.length;i++){var bundles=subscenes[i].bundles;for(var j=bundles.length-1;j>=0;j--){var bundle=bundles[j];if(bundle.obj_render==render){if(bundle.batch&&clean_buffs)m_geom.cleanup_bufs_data(bundle.batch.bufs_data);bundles.splice(j,1)}}}};function add_bundle(subscene,render,batch){var rb=init_bundle(render,batch);subscene.bundles.push(rb)}function remove_bundle(subscene,
render){var bundles=subscene.bundles;for(var i=0;i<bundles.length;i++){var bundle=bundles[i];if(bundle.obj_render==render){bundles.splice(i,1);i--}}}exports.update_lamp_scene=update_lamp_scene;function update_lamp_scene(lamp,scene){var subs_arr=subs_array(scene,LIGHT_SUBSCENE_TYPES);var light=lamp.light;var lamp_render=lamp.render;var sc_data=m_obj_util.get_scene_data(lamp,scene);var ind=sc_data.light_index;for(var i=0;i<subs_arr.length;i++){var subs=subs_arr[i];subs.light_positions.set(lamp_render.trans,
ind*3);subs.light_directions.set(light.direction,ind*3);subs.light_color_intensities.set(light.color_intensity,ind*3);switch(light.type){case "SUN":subs.sun_quaternion.set(lamp_render.quat);subs.sun_intensity=light.color_intensity;if(subs.type==="SKY"){subs.need_fog_update=light.need_sun_fog_update;m_vec3.copy(light.direction,subs.sun_direction);update_sky(scene,subs)}else m_vec3.copy(light.direction,subs.sun_direction);break;case "HEMI":case "POINT":case "SPOT":break;default:m_print.error("Unknown light type: "+
light.type+'".');break}var light_factor=_vec2_tmp;light_factor[0]=light.use_diffuse?1:0;light_factor[1]=light.use_specular?1:0;subs.light_factors.set(light_factor,ind*2);subs.need_perm_uniforms_update=true;for(var j=0;j<subs.bundles.length;j++){var batch=subs.bundles[j].batch;if(batch.lamp_uuid_indexes)m_batch.set_lamp_data(batch,lamp)}}var subs_main=get_subs(scene,"MAIN_OPAQUE");var cam_main=subs_main.camera;var shadow_subscenes=sc_data.shadow_subscenes;var sh_params=scene._render.shadow_params;
for(var i=0;i<shadow_subscenes.length;i++){var subs=shadow_subscenes[i];var cam=subs.camera;m_cam.set_view_trans_quat(cam,lamp_render.trans,lamp_render.quat);update_subs_shadow(subs,cam_main,subs.bundles,sh_params,true)}}function update_sky(scene,subs){m_render.draw(subs);if(subs.need_fog_update){var main_subs=subs_array(scene,["MAIN_OPAQUE","MAIN_BLEND","MAIN_XRAY","MAIN_GLOW"]);for(var i=0;i<main_subs.length;i++){var m_subs=main_subs[i];var bundles=m_subs.bundles;for(var j=0;j<bundles.length;j++){var bundle=
bundles[j];if(bundle.do_render){var batch=bundle.batch;if(m_batch.check_batch_perm_uniform(batch,"u_cube_fog"))m_render.update_batch_permanent_uniform(batch,"u_cube_fog")}}}}}exports.cleanup=function(){for(var i=0;i<_scenes.length;i++){var scene=_scenes[i];var graph=scene._render.graph;m_graph.traverse(graph,function(node,attr){if(!(attr.type=="SINK"))clear_subscene(attr)});scene._render.graph=[];scene._render.queue=[]}_main_scene=null;_active_scene=null;_scenes.length=0;_scenes_graph=null};function clear_subscene(subs){var cam=
subs.camera;m_render.render_target_cleanup(cam.framebuffer,cam.color_attachment,cam.depth_attachment,cam.width,cam.height);var bundles=subs.bundles;for(var i=0;i<bundles.length;i++){var batch=bundles[i].batch;if(batch)m_batch.clear_batch(batch)}}exports.make_frustum_shot=function(cam,subscene,color){var corners=m_cam.extract_frustum_corners(cam,cam.near,cam.far,null,true);var submesh=m_primitives.generate_frustum(corners);var render=m_obj_util.create_render("DYNAMIC");render.bb_world=render.bb_local=
m_bounds.big_bounding_box();render.bs_world=render.bs_local=m_bounds.big_bounding_sphere();var radius=render.bs_world.radius;render.be_world=render.be_local=m_bounds.create_bounding_ellipsoid([radius,0,0],[0,radius,0],[0,0,radius],render.bs_world.center);var batch=m_batch.create_shadeless_batch(submesh,color,.5);add_bundle(subscene,render,batch)};function get_objs_materials(objs){var mats=[];for(var i=0;i<objs.length;i++){var obj=objs[i];var bpy_obj=obj.temp_bpy_obj;var mesh=bpy_obj["data"];for(var j=
0;j<mesh["materials"].length;j++){var mat=mesh["materials"][j];if(mats.indexOf(mat)==-1)mats.push(mat)}}return mats}exports.get_scene_timeline=function(scene){var start=scene["frame_start"];var end=scene["frame_end"];return[start,end]};exports.setup_dim=function(width,height,scale){m_cont.setup_viewport_dim(width,height,scale);if(_active_scene)setup_scene_dim(_active_scene,width,height)};function setup_scene_dim(scene,width,height){var sc_render=scene._render;var upd_cameras=scene._camera.render.cameras;
for(var i=0;i<upd_cameras.length;i++){var cam=upd_cameras[i];m_cam.set_projection(cam,width/height);if(sc_render.shadow_params)m_cam.update_camera_shadows(cam,sc_render.shadow_params)}if(sc_render.shadow_params){sc_render.need_shadow_update=true;get_subs(scene,"DEPTH").need_perm_uniforms_update=true;get_subs(scene,"MAIN_BLEND").need_perm_uniforms_update=true}var graph=sc_render.graph;m_scgraph.traverse_slinks(graph,function(slink,internal,subs1,subs2){if(!slink.update_dim)return;var tex_width=slink.size_mult*
width;var tex_height=slink.size_mult*height;if(internal)for(var i=0;i<subs1.slinks_internal.length;i++){var slink_i=subs1.slinks_internal[i];if(slink_i==slink){var tex=subs1.textures_internal[i];m_tex.resize(slink.texture,tex_width,tex_height)}}else{if(m_tex.is_texture(slink.texture))m_tex.resize(slink.texture,tex_width,tex_height);var cam=subs1.camera;cam.width=tex_width;cam.height=tex_height;switch(subs1.type){case "DOF":set_dof_params(scene,{"dof_power":subs1.camera.dof_power,"dof_on":subs1.camera.dof_on});
break;case "GLOW_COMBINE":set_glow_material_params(scene,{"small_glow_mask_width":subs1.small_glow_mask_width,"large_glow_mask_width":subs1.large_glow_mask_width});break;case "BLOOM":set_bloom_params(scene,{"bloom_blur":subs1.bloom_blur});break;case "OUTLINE":var subs_outline_blur_y=m_scgraph.find_input(graph,subs1,"POSTPROCESSING");var subs_outline_blur_x=m_scgraph.find_input(graph,subs_outline_blur_y,"POSTPROCESSING");var subs_outline_extend_y=m_scgraph.find_input(graph,subs_outline_blur_x,"POSTPROCESSING");
var subs_outline_extend_x=m_scgraph.find_input(graph,subs_outline_extend_y,"POSTPROCESSING");m_scgraph.set_texel_size(subs_outline_blur_y,1/width,1/height);m_scgraph.set_texel_size(subs_outline_blur_x,1/width,1/height);m_scgraph.set_texel_size(subs_outline_extend_y,1/width,1/height);m_scgraph.set_texel_size(subs_outline_extend_x,1/width,1/height);break;default:m_scgraph.set_texel_size(subs1,1/width,1/height);break}}})}exports.subs_array=subs_array;function subs_array(scene,types){var subscenes=[];
var scene_subscenes=scene._render.graph;for(var i=0;i<types.length;i++){var type=types[i];m_graph.traverse(scene._render.graph,function(node,attr){var subs=attr;if(subs.type==type)subscenes.push(subs)})}return subscenes}exports.get_subs=get_subs;function get_subs(scene,type){var graph=scene._render.graph;return m_scgraph.find_subs(graph,type)}exports.get_environment_colors=function(scene){var subs=subs_array(scene,LIGHT_SUBSCENE_TYPES)[0];var hor=subs.horizon_color;var zen=subs.zenith_color;var hor_dest=
[];var zen_dest=[];hor_dest[0]=hor[0];hor_dest[1]=hor[1];hor_dest[2]=hor[2];zen_dest[0]=zen[0];zen_dest[1]=zen[1];zen_dest[2]=zen[2];return[subs.environment_energy,hor_dest,zen_dest]};exports.set_environment_colors=set_environment_colors;function set_environment_colors(scene,opt_environment_energy,opt_horizon_color,opt_zenith_color){var subscenes=subs_array(scene,LIGHT_SUBSCENE_TYPES);for(var i=0;i<subscenes.length;i++){var subs=subscenes[i];if(!isNaN(opt_environment_energy))subs.environment_energy=
opt_environment_energy;if(opt_horizon_color)subs.horizon_color.set(opt_horizon_color);if(opt_zenith_color)subs.zenith_color.set(opt_zenith_color);subs.need_perm_uniforms_update=true}}exports.get_sky_params=function(scene){var subs=get_subs(scene,"SKY");if(subs){var sky_params={};sky_params.color=new Array(3);m_vec3.copy(subs.sky_color,sky_params.color);sky_params.procedural_skydome=subs.procedural_skydome;sky_params.use_as_environment_lighting=subs.use_as_environment_lighting;sky_params.rayleigh_brightness=
subs.rayleigh_brightness;sky_params.mie_brightness=subs.mie_brightness;sky_params.spot_brightness=subs.spot_brightness;sky_params.scatter_strength=subs.scatter_strength;sky_params.rayleigh_strength=subs.rayleigh_strength;sky_params.mie_strength=subs.mie_strength;sky_params.rayleigh_collection_power=subs.rayleigh_collection_power;sky_params.mie_collection_power=subs.mie_collection_power;sky_params.mie_distribution=subs.mie_distribution;return sky_params}else return null};exports.set_sky_params=function(scene,
sky_params){var subs=get_subs(scene,"SKY");if(subs){if(typeof sky_params.procedural_skydome=="number")subs.procedural_skydome=sky_params.procedural_skydome;if(typeof sky_params.use_as_environment_lighting=="number")subs.use_as_environment_lighting=sky_params.use_as_environment_lighting;if(typeof sky_params.color=="object")subs.sky_color.set(sky_params.color);if(typeof sky_params.rayleigh_brightness=="number")subs.rayleigh_brightness=sky_params.rayleigh_brightness;if(typeof sky_params.mie_brightness==
"number")subs.mie_brightness=sky_params.mie_brightness;if(typeof sky_params.spot_brightness=="number")subs.spot_brightness=sky_params.spot_brightness;if(typeof sky_params.scatter_strength=="number")subs.scatter_strength=sky_params.scatter_strength;if(typeof sky_params.rayleigh_strength=="number")subs.rayleigh_strength=sky_params.rayleigh_strength;if(typeof sky_params.mie_strength=="number")subs.mie_strength=sky_params.mie_strength;if(typeof sky_params.rayleigh_collection_power=="number")subs.rayleigh_collection_power=
sky_params.rayleigh_collection_power;if(typeof sky_params.mie_collection_power=="number")subs.mie_collection_power=sky_params.mie_collection_power;if(typeof sky_params.mie_distribution=="number")subs.mie_distribution=sky_params.mie_distribution;subs.need_perm_uniforms_update=true;subs.need_fog_update=true;update_sky(scene,subs)}};exports.get_fog_color_density=function(scene,opt_dest){var dest=opt_dest||[];var subs=subs_array(scene,FOG_SUBSCENE_TYPES)[0];var fcd=subs.fog_color_density;dest[0]=fcd[0];
dest[1]=fcd[1];dest[2]=fcd[2];dest[3]=fcd[3];return dest};exports.set_fog_color_density=function(scene,val){var subscenes=subs_array(scene,FOG_SUBSCENE_TYPES);for(var i=0;i<subscenes.length;i++){var subs=subscenes[i];subs.fog_color_density.set(val);subs.need_perm_uniforms_update=true}};exports.get_ssao_params=function(scene){var subs=get_subs(scene,"SSAO");var subs_blur=get_subs(scene,"SSAO_BLUR");if(!subs)return null;var batch=subs.bundles[0].batch;var ssao_params={};ssao_params.ssao_quality=m_batch.get_batch_directive(batch,
"SSAO_QUALITY")[1];ssao_params.ssao_hemisphere=subs.ssao_hemisphere;ssao_params.ssao_blur_depth=subs_blur.ssao_blur_depth;ssao_params.blur_discard_value=subs_blur.ssao_blur_discard_value;ssao_params.radius_increase=subs.ssao_radius_increase;ssao_params.influence=subs.ssao_influence;ssao_params.dist_factor=subs.ssao_dist_factor;ssao_params.ssao_only=subs.ssao_only;ssao_params.ssao_white=m_batch.get_batch_directive(batch,"SSAO_WHITE")[1];return ssao_params};exports.set_ssao_params=function(scene,ssao_params){var subs=
get_subs(scene,"SSAO");var subs_blur=get_subs(scene,"SSAO_BLUR");if(!subs){m_print.error("SSAO is not enabled on the scene");return 0}if(typeof ssao_params.ssao_quality=="string"){var batch=subs.bundles[0].batch;m_batch.set_batch_directive(batch,"SSAO_QUALITY",ssao_params.ssao_quality);m_batch.update_shader(batch,true)}if(typeof ssao_params.ssao_hemisphere=="number"){var batch=subs.bundles[0].batch;m_batch.set_batch_directive(batch,"SSAO_HEMISPHERE",ssao_params.ssao_hemisphere);m_batch.update_shader(batch,
true)}if(typeof ssao_params.ssao_blur_depth=="number"){var batch=subs_blur.bundles[0].batch;m_batch.set_batch_directive(batch,"SSAO_BLUR_DEPTH",ssao_params.ssao_blur_depth);m_batch.update_shader(batch,true)}if(typeof ssao_params.ssao_blur_discard_value=="number")subs_blur.ssao_blur_discard_value=ssao_params.ssao_blur_discard_value;if(typeof ssao_params.ssao_radius_increase=="number")subs.ssao_radius_increase=ssao_params.ssao_radius_increase;if(typeof ssao_params.ssao_influence=="number")subs.ssao_influence=
ssao_params.ssao_influence;if(typeof ssao_params.ssao_dist_factor=="number")subs.ssao_dist_factor=ssao_params.ssao_dist_factor;if(typeof ssao_params.ssao_only=="number"){var subs=get_subs(scene,"MAIN_OPAQUE");subs.ssao_only=ssao_params.ssao_only;for(var i=0;i<subs.bundles.length;i++){var batch=subs.bundles[i].batch;m_batch.set_batch_directive(batch,"SSAO_ONLY",ssao_params.ssao_only);m_batch.update_shader(batch,true)}}if(typeof ssao_params.ssao_white=="number"){var batch=subs.bundles[0].batch;m_batch.set_batch_directive(batch,
"SSAO_WHITE",ssao_params.ssao_white);m_batch.update_shader(batch,true)}subs.need_perm_uniforms_update=true;subs_blur.need_perm_uniforms_update=true};exports.get_dof_params=function(scene){var subs=get_subs(scene,"DOF");if(!subs)return null;var dof_params={};dof_params.dof_distance=subs.camera.dof_distance;dof_params.dof_front=subs.camera.dof_front;dof_params.dof_rear=subs.camera.dof_rear;dof_params.dof_power=subs.camera.dof_power;dof_params.dof_object=subs.camera.dof_object;return dof_params};exports.set_dof_params=
set_dof_params;function set_dof_params(scene,dof_params){var subs=get_subs(scene,"DOF");if(!subs){m_print.error("DOF is not enabled on the scene. Check camera settings");return 0}var graph=scene._render.graph;if(typeof dof_params.dof_on=="boolean")subs.camera.dof_on=parseFloat(dof_params.dof_on);if(typeof dof_params.dof_distance=="number")subs.camera.dof_distance=dof_params.dof_distance;if(typeof dof_params.dof_front=="number")subs.camera.dof_front=dof_params.dof_front;if(typeof dof_params.dof_rear==
"number")subs.camera.dof_rear=dof_params.dof_rear;if(typeof dof_params.dof_power=="number"){subs.camera.dof_power=dof_params.dof_power;var subs_pp1=m_scgraph.find_input(graph,subs,"POSTPROCESSING");var subs_pp2=m_scgraph.find_input(graph,subs_pp1,"POSTPROCESSING");m_scgraph.set_texel_size_mult(subs_pp1,subs.camera.dof_power);m_scgraph.set_texel_size(subs_pp1,1/subs.camera.width,1/subs.camera.height);m_scgraph.set_texel_size_mult(subs_pp2,subs.camera.dof_power);m_scgraph.set_texel_size(subs_pp2,1/
subs.camera.width,1/subs.camera.height)}subs.need_perm_uniforms_update=true}exports.get_god_rays_params=function(scene){var gr_subs=subs_array(scene,["GOD_RAYS"]);var combo_subs=get_subs(scene,"GOD_RAYS_COMBINE");if(!gr_subs||!combo_subs)return null;var god_rays_params={};god_rays_params.god_rays_max_ray_length=gr_subs[0].max_ray_length;god_rays_params.god_rays_intensity=combo_subs.god_rays_intensity;var batch=gr_subs[0].bundles[0].batch;god_rays_params.god_rays_steps=m_batch.get_batch_directive(batch,
"STEPS_PER_PASS")[1];return god_rays_params};exports.set_god_rays_params=function(scene,god_rays_params){var gr_subs=subs_array(scene,["GOD_RAYS"]);var combo_subs=get_subs(scene,"GOD_RAYS_COMBINE");if(!gr_subs||!combo_subs){m_print.error("God Rays are not enabled on the scene");return 0}if(typeof god_rays_params.god_rays_intensity=="number")combo_subs.god_rays_intensity=god_rays_params.god_rays_intensity;if(typeof god_rays_params.god_rays_max_ray_length=="number"){var r_length=god_rays_params.god_rays_max_ray_length;
for(var i=0;i<gr_subs.length;i++){gr_subs[i].max_ray_length=r_length;gr_subs[i].radial_blur_step=r_length/gr_subs[i].steps_per_pass/(i+1);gr_subs[i].need_perm_uniforms_update=true}}if(typeof god_rays_params.god_rays_steps=="number"){var steps=m_shaders.glsl_value(god_rays_params.god_rays_steps,1);var r_length=gr_subs[0].max_ray_length;for(var i=0;i<gr_subs.length;i++){gr_subs[i].steps_per_pass=steps;gr_subs[i].radial_blur_step=r_length/steps/(i+1);gr_subs[i].need_perm_uniforms_update=true;var batch=
gr_subs[i].bundles[0].batch;m_batch.set_batch_directive(batch,"STEPS_PER_PASS",steps);m_batch.update_shader(batch,true)}}combo_subs.need_perm_uniforms_update=true};exports.get_bloom_params=function(scene){var lum_subs=get_subs(scene,"LUMINANCE_TRUNCED");var bloom_subs=get_subs(scene,"BLOOM");if(!lum_subs||!bloom_subs)return null;var bloom_params={};bloom_params.bloom_key=lum_subs.bloom_key;bloom_params.bloom_edge_lum=lum_subs.bloom_edge_lum;bloom_params.bloom_blur=bloom_subs.bloom_blur;return bloom_params};
exports.set_bloom_params=set_bloom_params;function set_bloom_params(scene,bloom_params){var lum_subs=get_subs(scene,"LUMINANCE_TRUNCED");var bloom_subs=get_subs(scene,"BLOOM");if(!lum_subs||!bloom_subs){m_print.error("Bloom is not enabled on the scene");return 0}if(typeof bloom_params.bloom_key=="number"){lum_subs.bloom_key=bloom_params.bloom_key;lum_subs.need_perm_uniforms_update=true}if(typeof bloom_params.bloom_edge_lum=="number"){lum_subs.bloom_edge_lum=bloom_params.bloom_edge_lum;lum_subs.need_perm_uniforms_update=
true}if(typeof bloom_params.bloom_blur=="number"){var graph=scene._render.graph;var subs_blur1=m_scgraph.find_input(graph,bloom_subs,"BLOOM_BLUR");var subs_blur2=m_scgraph.find_input(graph,subs_blur1,"BLOOM_BLUR");bloom_subs.bloom_blur=bloom_params.bloom_blur;m_scgraph.set_texel_size_mult(subs_blur1,bloom_params.bloom_blur);m_scgraph.set_texel_size(subs_blur1,1/bloom_subs.camera.width,1/bloom_subs.camera.height);m_scgraph.set_texel_size_mult(subs_blur2,bloom_params.bloom_blur);m_scgraph.set_texel_size(subs_blur2,
1/bloom_subs.camera.width,1/bloom_subs.camera.height)}}exports.get_glow_material_params=function(scene){var glow_combine_subs=get_subs(scene,"GLOW_COMBINE");if(!glow_combine_subs)return null;var glow_material_params={};glow_material_params.small_glow_mask_coeff=glow_combine_subs.small_glow_mask_coeff;glow_material_params.large_glow_mask_coeff=glow_combine_subs.large_glow_mask_coeff;glow_material_params.small_glow_mask_width=glow_combine_subs.small_glow_mask_width;glow_material_params.large_glow_mask_width=
glow_combine_subs.large_glow_mask_width;return glow_material_params};exports.set_glow_material_params=set_glow_material_params;function set_glow_material_params(scene,glow_material_params){var glow_combine_subs=get_subs(scene,"GLOW_COMBINE");if(!glow_combine_subs){m_print.error("Glow is not enabled on the scene");return null}var graph=scene._render.graph;var subs=m_scgraph.get_inputs(graph,glow_combine_subs);for(var i=0;i<subs.length;++i){var subscene=subs[i];if(subscene.type==="POSTPROCESSING"&&
subscene.subtype==="GLOW_MASK_LARGE")var postproc_y_blur_large_subs=subscene;if(subscene.type==="POSTPROCESSING"&&subscene.subtype==="GLOW_MASK_SMALL")var postproc_y_blur_small_subs=subscene}var postproc_x_blur_large_subs=m_scgraph.find_input(graph,postproc_y_blur_large_subs,"POSTPROCESSING");var postproc_x_blur_small_subs=m_scgraph.find_input(graph,postproc_y_blur_small_subs,"POSTPROCESSING");if(typeof glow_material_params.small_glow_mask_coeff=="number"){glow_combine_subs.small_glow_mask_coeff=
glow_material_params.small_glow_mask_coeff;glow_combine_subs.need_perm_uniforms_update=true}if(typeof glow_material_params.large_glow_mask_coeff=="number"){glow_combine_subs.large_glow_mask_coeff=glow_material_params.large_glow_mask_coeff;glow_combine_subs.need_perm_uniforms_update=true}if(typeof glow_material_params.small_glow_mask_width=="number"){glow_combine_subs.small_glow_mask_width=glow_material_params.small_glow_mask_width;m_scgraph.set_texel_size_mult(postproc_y_blur_small_subs,glow_material_params.small_glow_mask_width);
m_scgraph.set_texel_size(postproc_y_blur_small_subs,1/glow_combine_subs.camera.width,1/glow_combine_subs.camera.height);postproc_y_blur_small_subs.need_perm_uniforms_update=true;m_scgraph.set_texel_size_mult(postproc_x_blur_small_subs,glow_material_params.small_glow_mask_width);m_scgraph.set_texel_size(postproc_x_blur_small_subs,1/glow_combine_subs.camera.width,1/glow_combine_subs.camera.height);postproc_x_blur_small_subs.need_perm_uniforms_update=true}if(typeof glow_material_params.large_glow_mask_width==
"number"){glow_combine_subs.large_glow_mask_width=glow_material_params.large_glow_mask_width;m_scgraph.set_texel_size_mult(postproc_y_blur_large_subs,glow_material_params.large_glow_mask_width);m_scgraph.set_texel_size(postproc_y_blur_large_subs,1/glow_combine_subs.camera.width,1/glow_combine_subs.camera.height);postproc_y_blur_large_subs.need_perm_uniforms_update=true;m_scgraph.set_texel_size_mult(postproc_x_blur_large_subs,glow_material_params.large_glow_mask_width);m_scgraph.set_texel_size(postproc_x_blur_large_subs,
1/glow_combine_subs.camera.width,1/glow_combine_subs.camera.height);postproc_x_blur_large_subs.need_perm_uniforms_update=true}}exports.get_wind_params=function(scene){var wind=get_wind(scene);var length=m_vec3.length(wind);if(length==0)return null;var angle=Math.atan(wind[0]/wind[2])*180/Math.PI;var wind_params={};wind_params.wind_dir=angle;wind_params.wind_strength=length;return wind_params};exports.schedule_grass_map_update=schedule_grass_map_update;function schedule_grass_map_update(bpy_scene){bpy_scene._render.need_grass_map_update=
true}exports.get_water_surface_level=get_water_surface_level;function get_water_surface_level(pos_x,pos_z){var subs=get_subs(_active_scene,"MAIN_OPAQUE");if(!subs||!subs.water_params){m_print.error("get_water_surface_level() - no water parameters on the scene");return 0}var waves_height=subs.water_waves_height;var waves_length=subs.water_waves_length;var water_level=subs.water_level;var wp=subs.water_params;if(!waves_height||!wp.dynamic)return wp.water_level;var wind_str=m_vec3.length(subs.wind);
var time=subs.time;if(wind_str)time*=wind_str;var cellular_coords=_vec2_tmp;cellular_coords[0]=20/waves_length*(pos_x-.25*time);cellular_coords[1]=20/waves_length*(pos_z-.25*time);var cellular1=m_util.cellular2x2(cellular_coords);cellular_coords[0]=17/waves_length*(pos_z+.1*time);cellular_coords[1]=17/waves_length*(pos_x+.1*time);var cellular2=m_util.cellular2x2(cellular_coords);var small_waves=cellular1+cellular2-1;var dst_noise_scale0=wp.dst_noise_scale0;var dst_noise_scale1=wp.dst_noise_scale1;
var dst_noise_freq0=wp.dst_noise_freq0;var dst_noise_freq1=wp.dst_noise_freq1;var noise_coords=_vec2_tmp;noise_coords[0]=dst_noise_scale0*(pos_x+dst_noise_freq0*time);noise_coords[1]=dst_noise_scale0*(pos_z+dst_noise_freq0*time);var noise1=m_util.snoise(noise_coords);noise_coords[0]=dst_noise_scale1*(pos_z-dst_noise_freq1*time);noise_coords[1]=dst_noise_scale1*(pos_x-dst_noise_freq1*time);var noise2=m_util.snoise(noise_coords);var dist_waves=waves_height*noise1*noise2;if(subs.use_shoremap){var size_x=
subs.shoremap_size[0];var size_z=subs.shoremap_size[1];var center_x=subs.shoremap_center[0];var center_z=subs.shoremap_center[1];var x=(pos_x-center_x)/size_x;var z=(center_z+pos_z)/size_z;x+=.5;z+=.5;if(x>1||x<0||z>1||z<0)var wave_height=dist_waves;else{var width=subs.shoremap_tex_size;var array=_active_scene._render.shore_distances;var shore_dist=m_util.get_array_smooth_value(array,width,x,z);var dir_min_shore_fac=wp.dir_min_shore_fac;var dir_freq=wp.dir_freq;var dir_noise_scale=wp.dir_noise_scale;
var dir_noise_freq=wp.dir_noise_freq;var dir_min_noise_fac=wp.dir_min_noise_fac;var dst_min_fac=wp.dst_min_fac;var waves_hor_fac=wp.waves_hor_fac;var max_shore_dist=subs.max_shore_dist;var shore_waves_length=waves_length/max_shore_dist/Math.PI;var waves_coords=[dir_noise_scale/waves_length*(pos_x+dir_noise_freq*time),dir_noise_scale/waves_length*(pos_z+dir_noise_freq*time)];var dist_fact=Math.sqrt(shore_dist);var shore_dir_waves=waves_height*Math.max(shore_dist,dir_min_shore_fac)*Math.sin(dist_fact/
shore_waves_length+dir_freq*time)*Math.max(m_util.snoise(waves_coords),dir_min_noise_fac);var mix_rate=Math.max(dist_fact,dst_min_fac);var wave_height=shore_dir_waves*(1-mix_rate)+dist_waves*mix_rate;small_waves*=shore_dist}}else var wave_height=dist_waves;wave_height+=.05*small_waves;var cur_water_level=water_level+wave_height;return cur_water_level}exports.get_water_mat_params=function(scene,water_params){var subs=get_subs(scene,"MAIN_OPAQUE");if(!subs)return;water_params.waves_height=subs.water_waves_height;
water_params.waves_length=subs.water_waves_length;if(subs.water_fog_color_density){water_params.water_fog_density=subs.water_fog_color_density[3];var wfc=water_params.water_fog_color=[];wfc[0]=subs.water_fog_color_density[0];wfc[1]=subs.water_fog_color_density[1];wfc[2]=subs.water_fog_color_density[2]}};exports.set_water_params=function(scene,water_params){var subs=get_subs(scene,"MAIN_OPAQUE");if(!subs||!subs.water_params){m_print.error("set_water_params() - no water parameters on the scene");return null}var wp=
subs.water_params;if(typeof water_params.dst_noise_scale0=="number")wp.dst_noise_scale0=water_params.dst_noise_scale0;if(typeof water_params.dst_noise_scale1=="number")wp.dst_noise_scale1=water_params.dst_noise_scale1;if(typeof water_params.dst_noise_freq0=="number")wp.dst_noise_freq0=water_params.dst_noise_freq0;if(typeof water_params.dst_noise_freq1=="number")wp.dst_noise_freq1=water_params.dst_noise_freq1;if(typeof water_params.dir_min_shore_fac=="number")wp.dir_min_shore_fac=water_params.dir_min_shore_fac;
if(typeof water_params.dir_freq=="number")wp.dir_freq=water_params.dir_freq;if(typeof water_params.dir_noise_scale=="number")wp.dir_noise_scale=water_params.dir_noise_scale;if(typeof water_params.dir_noise_freq=="number")wp.dir_noise_freq=water_params.dir_noise_freq;if(typeof water_params.dir_min_noise_fac=="number")wp.dir_min_noise_fac=water_params.dir_min_noise_fac;if(typeof water_params.dst_min_fac=="number")wp.dst_min_fac=water_params.dst_min_fac;if(typeof water_params.waves_hor_fac=="number")wp.waves_hor_fac=
water_params.waves_hor_fac;if(typeof water_params.water_dynamic=="number")wp.dynamic=water_params.water_dynamic;var subscenes=subs_array(scene,MAIN_SUBSCENE_TYPES);for(var i=0;i<subscenes.length;i++){var sub=subscenes[i];if(typeof water_params.water_fog_density=="number"&&wp.fog_color_density)sub.water_fog_color_density[3]=water_params.water_fog_density;if(typeof water_params.water_fog_color=="object"&&wp.fog_color_density)sub.water_fog_color_density.set(water_params.water_fog_color);if(typeof water_params.waves_height==
"number")sub.water_waves_height=water_params.waves_height;if(typeof water_params.waves_length=="number")sub.water_waves_length=water_params.waves_length;sub.need_perm_uniforms_update=true}};exports.get_shore_dist=function(trans,v_dist_mult){var subs=get_subs(_active_scene,"MAIN_OPAQUE");if(!subs.use_shoremap)return SHORE_DIST_COMPAT;var size_x=subs.shoremap_size[0];var size_z=subs.shoremap_size[1];var center_x=subs.shoremap_center[0];var center_z=subs.shoremap_center[1];var max_shore_dist=subs.max_shore_dist;
var water_level=subs.water_level;var x=(trans[0]-center_x)/size_x;var z=(center_z+trans[2])/size_z;x+=.5;z+=.5;if(x>1||x<0||z>1||z<0)var shore_dist=1;else{var width=subs.shoremap_tex_size;var array=_active_scene._render.shore_distances;var shore_dist_xz=max_shore_dist*m_util.get_array_smooth_value(array,width,x,z);var shore_dist_y=(water_level-trans[1])*v_dist_mult;var shore_dist=Math.sqrt(shore_dist_xz*shore_dist_xz+shore_dist_y*shore_dist_y);return shore_dist}};exports.update=function(timeline,
elapsed){var active_cam_render=get_active()._camera.render;for(var i=0;i<_scenes.length;i++){var scene=_scenes[i];var graph=scene._render.graph;var render=scene._render;if(render.water_params)var cam_water_depth=active_cam_render.trans[1]-get_water_surface_level(active_cam_render.trans[0],active_cam_render.trans[2]);for(var j=0;j<render.video_textures.length;j++){var vtex=render.video_textures[j]._render;var video=vtex.video_file;var seq_video=vtex.seq_video;if(scene["b4w_use_nla"]&&vtex.use_nla)continue;
if(!video&&!seq_video)continue;if(!m_tex.video_is_played(vtex))continue;var current_frame=m_tex.video_get_current_frame(vtex);var start_frame=m_tex.video_get_start_frame(vtex);if(video&&cfg_def.is_mobile_device)start_frame-=FRAME_EPS;var end_frame=m_tex.video_get_end_frame(vtex);if(!vtex.use_cyclic&&current_frame>=end_frame){m_tex.pause_video(vtex.name,vtex.vtex_data_id);continue}if(seq_video&&current_frame>=end_frame){vtex.seq_cur_frame=0;current_frame=0}if(current_frame<start_frame)m_tex.reset_video(vtex.name,
vtex.vtex_data_id);if(m_tex.video_update_is_available(vtex))if(video)m_tex.update_video_texture(vtex);else{var mark=m_tex.seq_video_get_discrete_timemark(vtex,timeline);if(mark!=vtex.seq_last_discrete_mark){m_tex.update_seq_video_texture(vtex);vtex.seq_cur_frame++}vtex.seq_last_discrete_mark=mark}}m_graph.traverse(graph,function(node,attr){var subs=attr;if(TIME_SUBSCENE_TYPES.indexOf(subs.type)>-1)subs.time=timeline;if(render.water_params)subs.cam_water_depth=cam_water_depth})}for(var i=0;i<_scenes.length;i++){var scene=
_scenes[i];var render=scene._render;var graph=render.graph;var queue=render.queue;if(!queue.length)continue;if(render.need_shadow_update){update_shadow_subscenes(scene);render.need_shadow_update=false}if(render.need_grass_map_update){update_subs_grass_map(scene);render.need_grass_map_update=false}if(render.need_outline){enable_outline_draw(scene);render.need_outline=false}if(render.motion_blur)update_motion_blur_subscenes(graph,elapsed);var outline_mask_subs=m_scgraph.find_subs(graph,"OUTLINE_MASK");
for(var j=0;j<queue.length;j++){var qsubs=queue[j];m_prerender.prerender_subs(qsubs);if(outline_mask_subs)optimize_outline_postprocessing(graph,qsubs,outline_mask_subs);m_render.draw(qsubs)}}if(cfg_def.show_hud_debug_info)m_hud.show_debug_info(_scenes,elapsed)};exports.request_outline=function(scene){scene._render.need_outline=true};function optimize_outline_postprocessing(graph,qsubs,outline_mask_subs){if(qsubs.is_for_outline&&qsubs.type=="POSTPROCESSING")if(outline_mask_subs.do_render!=qsubs.do_render)qsubs.do_render=
outline_mask_subs.do_render;if(!outline_mask_subs.do_render&&qsubs.type=="OUTLINE")qsubs.draw_outline_flag=0}function slink_switch_active(graph,id1,id2,slink,active){if(slink.active==active)return;if(slink.active){replace_attachment(graph,id1,slink.from,null);replace_texture(graph,id2,slink.to,null)}else{replace_attachment(graph,id1,slink.from,slink.texture);replace_texture(graph,id2,slink.to,slink.texture)}slink.active=active}function replace_attachment(graph,id,type,tex){var subs=m_graph.get_node_attr(graph,
id);m_cam.set_attachment(subs.camera,type,tex);subs.assign_texture=true;m_graph.traverse_outputs(graph,id,function(id_out,attr_out,attr_edge){var slink=attr_edge;if(slink.active&&slink.from==type&&m_scgraph.check_slink_tex_conn(slink))replace_texture(graph,id_out,slink.to,tex)});m_graph.traverse_inputs(graph,id,function(id_in,attr_in,attr_edge){var slink=attr_edge;if(slink.active&&slink.from==type&&slink.from==slink.to)replace_attachment(graph,id_in,type,tex)})}function replace_texture(graph,id,name,
tex){var subs=m_graph.get_node_attr(graph,id);var bundles=subs.bundles;for(var i=0;i<bundles.length;i++){var batch=bundles[i].batch;m_batch.replace_texture(batch,tex,name)}}function update_subs_grass_map(bpy_scene){var subs_grass_map=get_subs(bpy_scene,"GRASS_MAP");if(subs_grass_map){var cam=subs_grass_map.camera;var camera_render=bpy_scene._camera.render;var camera_trans=camera_render.trans;var trans=_vec3_tmp;trans[0]=0;trans[1]=-subs_grass_map.grass_map_dim[2]/2;trans[2]=0;m_vec3.transformQuat(trans,
camera_render.quat,trans);trans[0]+=camera_trans[0];trans[1]=0;trans[2]+=camera_trans[2];var quat=_quat4_tmp;quat[0]=0;quat[1]=0;quat[2]=0;quat[3]=1;m_cam.set_view_trans_quat(cam,trans,quat)}}function update_motion_blur_subscenes(graph,elapsed){m_graph.traverse(graph,function(id,attr){var subs=attr;if(subs.type!="MOTION_BLUR")return;if(!subs.slinks_internal[0]||!subs.textures_internal[0])throw"Wrong MOTION_BLUR subscene";var slink=subs.slinks_internal[0];var tex=subs.textures_internal[0];subs.textures_internal[0]=
subs.camera.color_attachment;m_graph.traverse_outputs(graph,id,function(id_out,attr_out,attr_edge){var slink_out=attr_edge;if(slink_out.active)replace_texture(graph,id_out,slink_out.to,tex)});replace_attachment(graph,id,slink.from,tex);replace_texture(graph,id,slink.to,subs.textures_internal[0]);subs.motion_blur_exp=Math.exp(-elapsed/subs.mb_factor)})}function update_smaa_resolve_subscene(graph){m_graph.traverse(graph,function(id,attr){var subs=attr;if(subs.type!="SMAA_RESOLVE")return;if(!subs.slinks_internal[0]||
!subs.textures_internal[0])throw"Wrong SMAA RESOLVE subscene";var tex=subs.textures_internal[0];m_graph.traverse_inputs(graph,id,function(id_in,subs_in,attr_edge){if(subs_in.type!="VELOCITY"){subs.textures_internal[0]=subs_in.camera.color_attachment;replace_attachment(graph,id_in,attr_edge.from,tex)}});replace_texture(graph,id,"u_color",tex);replace_texture(graph,id,"u_color_prev",subs.textures_internal[0])})}exports.get_all_subscenes=function(scene){var graph=scene._render.graph;var subscenes=[];
m_graph.traverse(graph,function(node,attr){subscenes.push(attr)});return subscenes};exports.get_cam_water_depth=function(){var subs=get_subs(_active_scene,"MAIN_BLEND");var scene=_active_scene;if(!subs&&!scene._render.water_params)return null;return subs.cam_water_depth};exports.get_object_data_id=function(obj){return obj.render.data_id};exports.update_scene_permanent_uniforms=update_scene_permanent_uniforms;function update_scene_permanent_uniforms(scene){var graph=scene._render.graph;m_graph.traverse(graph,
function(node,subs){subs.need_perm_uniforms_update=true})}exports.set_wireframe_mode=function(subs_wireframe,mode){subs_wireframe.do_render=mode!=m_debug.WM_NONE;for(var i=0;i<subs_wireframe.bundles.length;i++){var batch=subs_wireframe.bundles[i].batch;batch.wireframe_mode=mode}subs_wireframe.blend=mode==m_debug.WM_TRANSPARENT_WIREFRAME;subs_wireframe.need_perm_uniforms_update=true};exports.set_wireframe_edge_color=function(subs_wireframe,color){for(var i=0;i<subs_wireframe.bundles.length;i++){var batch=
subs_wireframe.bundles[i].batch;batch.wireframe_edge_color=color;subs_wireframe.need_perm_uniforms_update=true}};exports.update_force_scene=function(scene,obj){var field=obj.field;var sc_wind=scene._render.wind;if(field&&field.type=="WIND"&&sc_wind){var render=obj.render;m_util.quat_to_dir(render.quat,m_util.AXIS_Y,sc_wind);m_vec3.normalize(sc_wind,sc_wind);m_vec3.scale(sc_wind,field.strength,sc_wind);var subs_arr=subs_array(scene,TIME_SUBSCENE_TYPES);for(var j=0;j<subs_arr.length;j++)subs_arr[j].wind.set(sc_wind)}};
exports.pick_color=function(scene,canvas_x,canvas_y){var subs_color_pick=get_subs(scene,"COLOR_PICKING");if(subs_color_pick){var viewport_xy=m_cont.canvas_to_viewport_coords(canvas_x,canvas_y,_vec2_tmp,subs_color_pick.camera);m_prerender.prerender_subs(subs_color_pick);m_render.draw(subs_color_pick,subs_color_pick.bundles);var subs_color_pick_xray=get_subs(scene,"COLOR_PICKING_XRAY");if(subs_color_pick_xray){m_prerender.prerender_subs(subs_color_pick_xray);m_render.draw(subs_color_pick_xray,subs_color_pick_xray.bundles);
var cam=subs_color_pick_xray.camera}else var cam=subs_color_pick.camera;viewport_xy[1]=cam.height-viewport_xy[1];var color=m_render.read_pixels(cam.framebuffer,viewport_xy[0],viewport_xy[1]);return color}else m_print.error("Object Selection is not available on the scene");return null};exports.set_outline_color=set_outline_color;function set_outline_color(color){var scene=get_active();var subs=get_subs(scene,"OUTLINE");if(subs){subs.outline_color.set(color);subs.need_perm_uniforms_update=true}}exports.get_wind=
get_wind;function get_wind(scene){return scene._render.wind}exports.get_meta_tags=function(scene){var tags={title:"",description:""};if(scene["b4w_tags"]){tags.title=scene["b4w_tags"]["title"];tags.description=scene["b4w_tags"]["description"]}return tags};exports.update_cube_reflect_subs=function(subs,trans){var vm_trans=_vec3_tmp;m_vec3.negate(trans,vm_trans);for(var i=0;i<6;i++){var vm=subs.cube_view_matrices[i];var frustum=subs.cube_cam_frustums[i];var cam=subs.camera;m_mat4.translate(m_util.INV_CUBE_VIEW_MATRS[i],
vm_trans,vm);m_mat4.multiply(cam.proj_matrix,vm,cam.view_proj_matrix);m_util.extract_frustum_planes(cam.view_proj_matrix,frustum)}};exports.update_plane_reflect_subs=function(subs,trans,quat){var cam=subs.camera;m_util.trans_quat_to_plane(trans,quat,m_util.AXIS_Y,cam.reflection_plane)};exports.assign_scene_data_subs=function(scene,scene_objs,lamps){var shadow_params=scene._render.shadow_params;var reflection_params=scene._render.reflection_params;var shadow_lamp=m_obj_util.get_first_lamp_with_shadows(lamps)||
lamps[0];for(var i=0;i<scene_objs.length;i++){var obj=scene_objs[i];var sc_data=m_obj_util.get_scene_data(obj,scene);if(reflection_params)if(obj.render.plane_reflection_id!=null){var plane_refl_subs=reflection_params.plane_refl_subs;if(plane_refl_subs.length){var refl_id=obj.render.plane_reflection_id;sc_data.plane_refl_subs=plane_refl_subs[refl_id]}}else if(obj.render.cube_reflection_id!=null){var cube_refl_subs=reflection_params.cube_refl_subs;if(cube_refl_subs.length){var refl_id=obj.render.cube_reflection_id;
sc_data.cube_refl_subs=cube_refl_subs[refl_id]}}if(shadow_params&&obj==shadow_lamp)sc_data.shadow_subscenes=subs_array(scene,["SHADOW_CAST"])}};function get_plane_refl_id_by_subs(scene,subs){var refl_subs=scene._render.reflection_params.plane_refl_subs;for(var i=0;i<refl_subs.length;i++)if(refl_subs[i]==subs)return i;return null}function get_cube_refl_id_by_subs(scene,subs){if(!scene._render.reflection_params)return null;var refl_subs=scene._render.reflection_params.cube_refl_subs;for(var i=0;i<refl_subs.length;i++)if(refl_subs[i]==
subs)return i;return null}exports.marker_frame=function(scene,name){return scene["timeline_markers"][name]}};b4w.module["__physics"]=function(exports,require){var m_cfg=require("__config");var m_cons=require("__constraints");var m_debug=require("__debug");var m_ipc=require("__ipc");var m_mat4=require("__mat4");var m_obj_util=require("__obj_util");var m_print=require("__print");var m_quat=require("__quat");var m_render=require("__renderer");var m_scs=require("__scenes");var m_trans=require("__transform");var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("__vec3");var m_version=require("__version");
var cfg_phy=m_cfg.physics;var cfg_def=m_cfg.defaults;var cfg_ldr=m_cfg.assets;var ANY_COL_ID_NUM=0;var RAY_CMP_PRECISION=1E-7;var _phy_fps=0;var _workers=[];var _scenes=[];var _bounding_objects={};var _bounding_objects_arr=[];var _collision_ids=[];var _unique_counter={body:0,constraint:0,ray_test:0};var _vec3_tmp=new Float32Array(3);var _vec4_tmp=new Float32Array(4);var _quat4_tmp=new Float32Array(4);var _mat4_tmp=new Float32Array(16);var _tsr8_tmp=new Float32Array(8);var _tsr8_tmp2=new Float32Array(8);
var VT_CHASSIS=10;var VT_HULL=20;exports.init_scene_physics=function(scene){scene._physics={worker_loaded:false,bundles:[],ray_tests:{},ray_tests_arr:[]};var path=cfg_phy.uranium_path;if(cfg_ldr.prevent_caching)path+=m_version.timestamp();m_print.log("%cLOAD PHYSICS","color: #0a0",cfg_phy.use_workers?"Using Separate Worker Thread,":"Using Same Thread,","Max FPS: "+cfg_phy.max_fps);m_print.log("%cPHYSICS PATH","color: #0a0",path);var worker=m_ipc.create_worker(path,!cfg_phy.use_workers);m_ipc.attach_handler(worker,
process_message);_workers.push(worker);_scenes.push(scene);if(cfg_phy.ping)setInterval(function(){m_ipc.post_msg(worker,m_ipc.OUT_PING,performance.now())},1E3)};exports.check_worker_loaded=function(scene){if(scene._physics)return scene._physics.worker_loaded;else return true};exports.cleanup=function(){for(var i=0;i<_workers.length;i++)m_ipc.terminate(_workers[i]);_workers.length=0;_scenes.length=0;_bounding_objects={};_bounding_objects_arr.length=0;_collision_ids.length=0;for(var cnt in _unique_counter)_unique_counter[cnt]=
0};function add_compound_children(parent,container){var children=parent.cons_descends;for(var i=0;i<children.length;i++){if(children[i].physics_settings.use_collision_compound)container.push(children[i]);add_compound_children(children[i],container)}return null}exports.append_object=function(obj,scene){var render=obj.render;if(!render)throw"No object render: "+obj.name;var phy_set=obj.physics_settings;var worker=find_worker_by_scene(scene);var compound_children=[];if(phy_set.use_collision_compound)add_compound_children(obj,
compound_children);var bundles=scene._physics.bundles;if(is_vehicle_chassis(obj)||is_vehicle_hull(obj)||is_character(obj)||is_floater_main(obj)||obj.use_obj_physics){var phy=init_bounding_physics(obj,compound_children,worker);obj.physics=phy;var pb={batch:null,physics:phy};bundles.push(pb);recalc_collision_tests(scene,worker,phy.collision_id)}else{var sc_data=m_obj_util.get_scene_data(obj,scene);var batches=sc_data.batches;for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.type!="PHYSICS"||
has_batch(scene,batch))continue;if(!batch.submesh.base_length){m_print.error("Object "+obj.name+" has collision material with no assigned vertices");continue}if(batch.water&&scene._render.water_params){init_water_physics(batch,scene,worker);continue}if(batch.use_ghost)var phy=init_ghost_mesh_physics(obj,batch,worker);else var phy=init_static_mesh_physics(obj,batch,worker);var pb={batch:batch,physics:phy};bundles.push(pb);recalc_collision_tests(scene,worker,phy.collision_id)}}if(is_vehicle_chassis(obj)||
is_vehicle_hull(obj)){init_vehicle(obj,worker);update_vehicle_controls(obj,obj.vehicle,worker)}else if(is_character(obj))init_character(obj,worker);else if(is_floater_main(obj))init_floater(obj,worker);for(var i=0;i<_bounding_objects_arr.length;i++){var obj=_bounding_objects_arr[i];if(obj.physics)process_rigid_body_joints(obj)}};function recalc_collision_tests(scene,worker,collision_id){var bundles=scene._physics.bundles;for(var i=0;i<bundles.length;i++){var phy=bundles[i].physics;for(var j=0;j<phy.collision_tests.length;j++){var test=
phy.collision_tests[j];if(test.collision_id=="ANY"||collision_id==test.collision_id)append_collision_pairs(test,scene,worker)}}}function has_batch(scene,batch){var pbundles=scene._physics.bundles;for(var i=0;i<pbundles.length;i++){var pbatch=pbundles[i].batch;if(pbatch&&pbatch.id==batch.id)return true}return false}function process_message(worker,msg_id,msg){if(!m_ipc.is_active(worker))return;switch(msg_id){case m_ipc.IN_LOADED:var scene=find_scene_by_worker(worker);scene._physics.worker_loaded=true;
var fallback_init_time=Date.now()-performance.now();m_ipc.post_msg(worker,m_ipc.OUT_INIT,fallback_init_time,cfg_phy.max_fps,cfg_phy.calc_fps?cfg_def.fps_measurement_interval:0);break;case m_ipc.IN_LOG:m_print.log_raw("URANIUM:",msg.slice(1));break;case m_ipc.IN_ERROR:m_print.error(msg);break;case m_ipc.IN_FBMSG:m_debug.fbmsg.apply(this,msg.slice(1));break;case m_ipc.IN_TRANSFORM:var obj=find_obj_by_body_id(msg.body_id);if(obj)update_interpolation_data(obj,msg.time,msg.trans,msg.quat,msg.linvel,msg.angvel);
break;case m_ipc.IN_PROP_OFFSET:var obj_chassis_hull=find_obj_by_body_id(msg.chassis_hull_body_id);if(obj_chassis_hull)update_prop_offset(obj_chassis_hull,msg.prop_ind,msg.trans,msg.quat);break;case m_ipc.IN_FLOATER_BOB_TRANSFORM:var obj_floater=find_obj_by_body_id(msg[1]);if(obj_floater)update_floater_bob_coords(obj_floater,msg[2],msg[3],msg[4]);break;case m_ipc.IN_VEHICLE_SPEED:var obj=find_obj_by_body_id(msg[1]);if(obj)obj.vehicle.speed=msg[2];break;case m_ipc.IN_COLLISION:var scene=find_scene_by_worker(worker);
traverse_collision_tests(scene,msg.body_id_a,msg.body_id_b,msg.result,null,null,0);break;case m_ipc.IN_COLLISION_POS_NORM:var scene=find_scene_by_worker(worker);traverse_collision_tests(scene,msg.body_id_a,msg.body_id_b,msg.result,msg.coll_point,msg.coll_norm,msg.coll_dist);break;case m_ipc.IN_COLLISION_IMPULSE:var obj=find_obj_by_body_id(msg[1]);if(obj){var phy=obj.physics;if(phy.col_imp_test_cb)phy.col_imp_test_cb(msg[2])}break;case m_ipc.IN_RAY_HIT:case m_ipc.IN_RAY_HIT_POS_NORM:var scene=find_scene_by_worker(worker);
var sphy=scene._physics;var test=sphy.ray_tests[msg.id];if(test){var body_id_hit=msg.body_id_hit;var obj_hit=find_obj_by_body_id(body_id_hit);if(msg_id==m_ipc.IN_RAY_HIT)exec_ray_test_cb(test,msg.hit_fract,obj_hit,msg.hit_time,null,null);else exec_ray_test_cb(test,msg.hit_fract,obj_hit,msg.hit_time,msg.hit_pos,msg.hit_norm)}break;case m_ipc.IN_REMOVE_RAY_TEST:remove_ray_test(id);break;case m_ipc.IN_PING:var idx=_workers.indexOf(worker);var out_time=(msg[2]-msg[1]).toFixed(3);var in_time=(performance.now()-
msg[2]).toFixed(3);var all_time=(performance.now()-msg[1]).toFixed(3);console.log("Physics #"+idx+" Ping: OUT "+out_time+" ms, IN "+in_time+" ms, ALL "+all_time+" ms");break;case m_ipc.IN_FPS:_phy_fps=msg[1];break;case m_ipc.IN_DEBUG_STATS:var idx=_workers.indexOf(worker);console.log("Worker: #"+String(idx));console.log(msg[1]);break;default:m_print.error("Wrong message: "+msg_id);break}}function find_scene_by_worker(worker){for(var i=0;i<_workers.length;i++)if(_workers[i]==worker)return _scenes[i]}
function find_worker_by_scene(scene){for(var i=0;i<_scenes.length;i++)if(_scenes[i]==scene)return _workers[i]}exports.find_obj_by_body_id=find_obj_by_body_id;function find_obj_by_body_id(body_id){return _bounding_objects[body_id]||null}function update_interpolation_data(obj,time,trans,quat,linvel,angvel){var phy=obj.physics;phy.curr_time=time;m_tsr.set_sep(trans,1,quat,phy.curr_tsr);m_vec3.copy(linvel,phy.linvel);m_vec3.copy(angvel,phy.angvel)}function update_prop_offset(obj_chassis_hull,prop_num,
trans,quat){var prop_offset=obj_chassis_hull.vehicle.prop_offsets[prop_num];m_tsr.set_sep(trans,1,quat,prop_offset)}function update_floater_bob_coords(obj_floater,bob_num,trans,quat){var obj_bob=obj_floater.floater.bobs[bob_num];m_trans.set_translation(obj_bob,trans);m_trans.set_rotation(obj_bob,quat);m_trans.update_transform(obj_bob)}function traverse_collision_tests(scene,body_id_a,body_id_b,pair_result,coll_pos,coll_norm,coll_dist){var bundles=scene._physics.bundles;for(var i=0;i<bundles.length;i++){var phy=
bundles[i].physics;for(var j=0;j<phy.collision_tests.length;j++){var test=phy.collision_tests[j];var pairs=test.pairs;var results_changed=false;for(var k=0;k<pairs.length;k++){var pair=pairs[k];if(pair[0]===body_id_a&&pair[1]===body_id_b){test.pair_results[k]=pair_result;results_changed=true;break}}if(results_changed){var pair_results=test.pair_results;var result=calc_coll_result(test);if(coll_pos&&test.body_id_src!=body_id_a)correct_coll_pos_norm(coll_pos,coll_norm,coll_dist);if(!result)var coll_obj=
null;else if(test.body_id_src==body_id_a)var coll_obj=find_obj_by_body_id(body_id_b);else var coll_obj=find_obj_by_body_id(body_id_a);test.callback(result,coll_obj,coll_pos,coll_norm,coll_dist)}}}}function calc_coll_result(test){var pair_results=test.pair_results;var result=false;for(var i=0;i<pair_results.length;i++)result=result||pair_results[i];return result}function correct_coll_pos_norm(pos,norm,dist){pos[0]=pos[0]+norm[0]*dist;pos[1]=pos[1]+norm[1]*dist;pos[2]=pos[2]+norm[2]*dist;norm[0]*=-1;
norm[1]*=-1;norm[2]*=-1}function exec_ray_test_cb(test,hit_fract,obj_hit,hit_time,hit_pos,hit_norm){var collision_id=test.collision_id;var callback=test.callback;if(hit_pos)callback(test.id,hit_fract,obj_hit,hit_time,hit_pos,hit_norm);else callback(test.id,hit_fract,obj_hit,hit_time)}exports.update=function(timeline,delta){for(var i=0;i<_workers.length;i++){update_worker(_workers[i],timeline,delta);var scene=_scenes[i];var subs=m_scs.get_subs(scene,"MAIN_OPAQUE");if(subs.water_params&&subs.water_params.waves_height>
0){var wind=m_vec3.length(subs.wind);m_ipc.post_msg(_workers[i],m_ipc.OUT_SET_WATER_TIME,subs.time*wind)}}};function update_worker(worker,timeline,delta){if(worker&&m_ipc.is_fallback(worker))m_ipc.post_msg(worker,m_ipc.OUT_UPDATE_WORLD,timeline,delta);for(var i=0;i<_bounding_objects_arr.length;i++){var obj=_bounding_objects_arr[i];var phy=obj.physics;if(phy.simulated&&phy.curr_time){if(m_ipc.is_fallback(worker))var d=timeline-phy.curr_time;else var d=performance.now()/1E3-phy.curr_time;d=Math.min(d,
10*1/cfg_phy.max_fps);d-=1/cfg_phy.max_fps;if(cfg_def.no_phy_interp_hack)d=0;var tsr=_tsr8_tmp;m_tsr.integrate(phy.curr_tsr,d,phy.linvel,phy.angvel,_tsr8_tmp);m_trans.set_tsr(obj,tsr);m_trans.update_transform(obj);sync_transform(obj);if(obj.vehicle)update_prop_transforms(obj);if(obj.vehicle&&obj.vehicle.steering_wheel)update_steering_wheel_coords(obj);if(obj.vehicle&&obj.vehicle.speedometer)update_speedometer(obj);if(obj.vehicle&&obj.vehicle.tachometer)update_tachometer(obj)}}m_ipc.post_msg_arr(worker)}
function update_prop_transforms(obj_chassis_hull){var obj_props=obj_chassis_hull.vehicle.props;var chass_hull_tsr=obj_chassis_hull.render.tsr;var prop_tsr=_tsr8_tmp;for(var i=0;i<obj_props.length;i++){var obj_prop=obj_props[i];var prop_offset=obj_chassis_hull.vehicle.prop_offsets[i];m_tsr.multiply(chass_hull_tsr,prop_offset,prop_tsr);m_trans.set_tsr(obj_prop,prop_tsr);m_trans.update_transform(obj_prop)}}exports.get_active_scene=function(){return _scenes[0]};exports.pause=function(){for(var i=0;i<
_workers.length;i++)m_ipc.post_msg(_workers[i],m_ipc.OUT_PAUSE)};exports.resume=function(){for(var i=0;i<_workers.length;i++)m_ipc.post_msg(_workers[i],m_ipc.OUT_RESUME)};function get_unique_body_id(){_unique_counter.body++;return _unique_counter.body}function init_water_physics(batch,scene,worker){var subs=m_scs.get_subs(scene,"MAIN_OPAQUE");var water_level=subs.water_level;m_ipc.post_msg(worker,m_ipc.OUT_APPEND_WATER,water_level);if(subs.water_params&&batch.water_dynamics){var water_dyn_info={};
water_dyn_info["dst_noise_scale0"]=batch.dst_noise_scale0;water_dyn_info["dst_noise_scale1"]=batch.dst_noise_scale1;water_dyn_info["dst_noise_freq0"]=batch.dst_noise_freq0;water_dyn_info["dst_noise_freq1"]=batch.dst_noise_freq1;water_dyn_info["dir_min_shore_fac"]=batch.dir_min_shore_fac;water_dyn_info["dir_freq"]=batch.dir_freq;water_dyn_info["dir_noise_scale"]=batch.dir_noise_scale;water_dyn_info["dir_noise_freq"]=batch.dir_noise_freq;water_dyn_info["dir_min_noise_fac"]=batch.dir_min_noise_fac;water_dyn_info["dst_min_fac"]=
batch.dst_min_fac;water_dyn_info["waves_hor_fac"]=batch.waves_hor_fac;var waves_height=subs.water_waves_height;var waves_length=subs.water_waves_length;if(subs.use_shoremap){var size_x=subs.shoremap_size[0];var size_y=subs.shoremap_size[1];var center_x=subs.shoremap_center[0];var center_y=subs.shoremap_center[1];var max_shore_dist=subs.max_shore_dist;var array_width=subs.shoremap_tex_size;m_ipc.post_msg(worker,m_ipc.OUT_ADD_WATER_WRAPPER,water_dyn_info,size_x,size_y,center_x,center_y,max_shore_dist,
waves_height,waves_length,array_width,scene._render.shore_distances)}else m_ipc.post_msg(worker,m_ipc.OUT_ADD_WATER_WRAPPER,water_dyn_info,0,0,0,0,0,waves_height,waves_length,0,null)}}function init_static_mesh_physics(obj,batch,worker){var body_id=get_unique_body_id();var submesh=batch.submesh;var positions=submesh.va_frames[0]["a_position"];var indices=submesh.indices||null;var trans=obj.render.trans;var friction=batch.friction;var restitution=batch.elasticity;var collision_id=batch.collision_id;
var collision_id_num=col_id_num(collision_id);var collision_margin=batch.collision_margin;var collision_group=batch.collision_group;var collision_mask=batch.collision_mask;m_ipc.post_msg(worker,m_ipc.OUT_APPEND_STATIC_MESH_BODY,body_id,positions,indices,trans,friction,restitution,collision_id_num,collision_margin,collision_group,collision_mask);var phy=init_physics(body_id);phy.collision_id=collision_id;phy.collision_id_num=collision_id_num;return phy}function col_id_num(id){if(id=="ANY")return ANY_COL_ID_NUM;
var num=_collision_ids.indexOf(id);if(num==-1){_collision_ids.push(id);return _collision_ids.length-1}else return num}function col_id_by_num(num){if(num==ANY_COL_ID_NUM)return"ANY";else return _collision_ids[num]}function init_physics(body_id){var phy={body_id:body_id,mass:0,is_ghost:false,simulated:true,is_vehicle:false,is_character:false,is_floater:false,cons_id:null,collision_id:"",collision_id_num:0,collision_callbacks:{},collision_tests:[],col_imp_test_cb:null,curr_time:0,curr_tsr:new Float32Array([0,
0,0,1,0,0,0,1]),linvel:new Float32Array(3),angvel:new Float32Array(3),cached_trans:new Float32Array(3),cached_quat:new Float32Array(4)};return phy}function init_ghost_mesh_physics(obj,batch,worker){var body_id=get_unique_body_id();var submesh=batch.submesh;var positions=submesh.va_frames[0]["a_position"];var indices=submesh.indices||null;var collision_id=batch.collision_id;var collision_id_num=col_id_num(collision_id);var collision_margin=batch.collision_margin;var collision_group=batch.collision_group;
var collision_mask=batch.collision_mask;var trans=obj.render.trans;m_ipc.post_msg(worker,m_ipc.OUT_APPEND_GHOST_MESH_BODY,body_id,positions,indices,trans,collision_id_num,collision_margin,collision_group,collision_mask);var phy=init_physics(body_id);phy.is_ghost=true;phy.collision_id=collision_id;phy.collision_id_num=collision_id_num;return phy}function init_bounding_physics(obj,compound_children,worker){var bpy_obj=obj.temp_bpy_obj;var render=obj.render;var phy_set=obj.physics_settings;var physics_type=
phy_set.physics_type;var bb=render.bb_local;var body_id=get_unique_body_id();if(obj.type=="CAMERA"){var bounding_type=phy_set.use_collision_bounds?phy_set.collision_bounds_type:"BOX";var bounding_object=find_bounding_type(bounding_type,render);var friction=render.friction;var restitution=render.elasticity;var friction=.5;var restitution=0}else if(obj.type=="EMPTY"){var bounding_type="EMPTY";var bounding_object=null;var friction=0;var restitution=0}else{var bounding_type=phy_set.use_collision_bounds?
phy_set.collision_bounds_type:"BOX";var bounding_object=find_bounding_type(bounding_type,render);var friction=render.friction;var restitution=render.elasticity}var trans=render.trans;var quat=render.quat;var is_ghost=phy_set.use_ghost;var disable_sleeping=phy_set.use_sleep;var mass=phy_set.mass;var velocity_min=phy_set.velocity_min;var velocity_max=phy_set.velocity_max;var damping=phy_set.damping;var rotation_damping=phy_set.rotation_damping;var collision_id=bpy_obj["b4w_collision_id"];var collision_id_num=
col_id_num(collision_id);var collision_margin=phy_set.collision_margin;var collision_group=phy_set.collision_group;var collision_mask=phy_set.collision_mask;var size=render.bs_local.radius;var worker_bounding=create_worker_bounding(bounding_object);var correct_bound_offset=bpy_obj["b4w_correct_bounding_offset"];var comp_children_params=get_children_params(render,compound_children,bounding_type,worker_bounding);m_ipc.post_msg(worker,m_ipc.OUT_APPEND_BOUNDING_BODY,body_id,trans,quat,physics_type,is_ghost,
disable_sleeping,mass,velocity_min,velocity_max,damping,rotation_damping,collision_id_num,collision_margin,collision_group,collision_mask,bounding_type,worker_bounding,size,friction,restitution,comp_children_params,correct_bound_offset);_bounding_objects[body_id]=obj;_bounding_objects_arr.push(obj);var phy=init_physics(body_id);phy.type=physics_type;phy.mass=mass;phy.is_ghost=is_ghost;phy.collision_id=collision_id;phy.collision_id_num=collision_id_num;return phy}function get_children_params(render,
children,bt,wb){if(!children.length)return[];var comp_children_params=[];var parent_params={};parent_params["quat"]=new Float32Array([0,0,0,1]);parent_params["trans"]=new Float32Array(3);parent_params["worker_bounding"]=wb;parent_params["bounding_type"]=bt;comp_children_params.push(parent_params);var wm_inv=_mat4_tmp;var quat_inv=_quat4_tmp;m_mat4.invert(render.world_matrix,wm_inv);m_quat.invert(render.quat,quat_inv);for(var i=0;i<children.length;i++){var child_params={};var child=children[i];var child_bt=
child.physics_settings.collision_bounds_type;var loc_quat=new Float32Array(4);var loc_trans=new Float32Array(3);m_vec3.transformMat4(child.render.trans,wm_inv,loc_trans);m_quat.multiply(quat_inv,child.render.quat,loc_quat);child_params["trans"]=loc_trans;child_params["quat"]=loc_quat;child_params["bounding_type"]=child_bt;child_params["worker_bounding"]=create_worker_bounding(find_bounding_type(child_bt,child.render));comp_children_params.push(child_params)}return comp_children_params}function find_bounding_type(bounding_type,
render){switch(bounding_type){case "BOX":var bounding_object=render.bb_local;break;case "CYLINDER":var bounding_object=render.bcyl_local;break;case "CONE":var bounding_object=render.bcon_local;break;case "SPHERE":var bounding_object=render.bs_local;break;case "CAPSULE":var bounding_object=render.bcap_local;break}return bounding_object}function create_worker_bounding(bounding_object){if(!bounding_object)return null;var in_obj=bounding_object;var out_obj={};if(typeof in_obj.min_x==="number")out_obj["min_x"]=
in_obj.min_x;if(typeof in_obj.min_y==="number")out_obj["min_y"]=in_obj.min_y;if(typeof in_obj.min_z==="number")out_obj["min_z"]=in_obj.min_z;if(typeof in_obj.max_x==="number")out_obj["max_x"]=in_obj.max_x;if(typeof in_obj.max_y==="number")out_obj["max_y"]=in_obj.max_y;if(typeof in_obj.max_z==="number")out_obj["max_z"]=in_obj.max_z;if(typeof in_obj.center==="object")out_obj["center"]=in_obj.center;if(typeof in_obj.radius==="number")out_obj["radius"]=in_obj.radius;if(typeof in_obj.height==="number")out_obj["height"]=
in_obj.height;return out_obj}function init_vehicle(obj,worker){var body_id=obj.physics.body_id;if(is_vehicle_chassis(obj)){obj.vehicle.type=VT_CHASSIS;var susp_compress=obj.vehicle.suspension_compression;var susp_stiffness=obj.vehicle.suspension_stiffness;var susp_damping=obj.vehicle.suspension_damping;var wheel_friction=obj.vehicle.wheel_friction;var max_suspension_travel_cm=obj.vehicle.max_suspension_travel_cm;m_ipc.post_msg(worker,m_ipc.OUT_APPEND_CAR,body_id,susp_compress,susp_stiffness,susp_damping,
wheel_friction,max_suspension_travel_cm)}else if(is_vehicle_hull(obj)){obj.vehicle.type=VT_HULL;var floating_factor=obj.vehicle.floating_factor;var water_lin_damp=obj.vehicle.water_lin_damp;var water_rot_damp=obj.vehicle.water_rot_damp;m_ipc.post_msg(worker,m_ipc.OUT_APPEND_BOAT,body_id,floating_factor,water_lin_damp,water_rot_damp)}if(obj.vehicle.props){var props=obj.vehicle.props;switch(obj.vehicle.type){case VT_CHASSIS:add_vehicle_prop(props[1],obj,body_id,true,worker);add_vehicle_prop(props[0],
obj,body_id,true,worker);add_vehicle_prop(props[3],obj,body_id,false,worker);add_vehicle_prop(props[2],obj,body_id,false,worker);break;case VT_HULL:for(var i=0;i<props.length;i++)add_vehicle_prop(props[i],obj,body_id,false,worker);break}}}function add_vehicle_prop(obj_prop,obj_chassis_hull,chassis_body_id,is_front,worker){var prop_trans=obj_prop.render.trans;var chassis_hull_matrix=obj_chassis_hull.render.world_matrix;var chassis_hull_matrix_inv=new Float32Array(16);m_mat4.invert(chassis_hull_matrix,
chassis_hull_matrix_inv);var conn_point=new Float32Array(3);m_vec3.transformMat4(prop_trans,chassis_hull_matrix_inv,conn_point);switch(obj_chassis_hull.vehicle.type){case VT_CHASSIS:var v_set=obj_chassis_hull.vehicle_settings;var suspension_rest_length=v_set.suspension_rest_length;var roll_influence=v_set.roll_influence;var bb=obj_prop.render.bb_local;var radius=(bb.max_y-bb.min_y)/2;m_ipc.post_msg(worker,m_ipc.OUT_ADD_CAR_WHEEL,chassis_body_id,conn_point,suspension_rest_length,roll_influence,radius,
is_front);break;case VT_HULL:m_ipc.post_msg(worker,m_ipc.OUT_ADD_BOAT_BOB,chassis_body_id,conn_point,obj_prop.synchronize_pos);break}}function init_character(obj,worker){var render=obj.render;var phy=obj.physics;var height=render.bb_local.max_y-render.bb_local.min_y;var character_id=phy.body_id;var char_settings=obj.character_settings;var walk_speed=char_settings.walk_speed;var run_speed=char_settings.run_speed;var step_height=char_settings.step_height;var jump_strength=char_settings.jump_strength;
var waterline=char_settings.waterline;var rot_angle=m_util.dir_ground_proj_angle(obj);m_ipc.post_msg(worker,m_ipc.OUT_APPEND_CHARACTER,character_id,rot_angle,height,walk_speed,run_speed,step_height,jump_strength,waterline);phy.is_character=true}function init_floater(obj,worker){var floating_factor=obj.floater.floating_factor;var water_lin_damp=obj.floater.water_lin_damp;var water_rot_damp=obj.floater.water_rot_damp;var body_id=obj.physics.body_id;m_ipc.post_msg(worker,m_ipc.OUT_APPEND_FLOATER,body_id,
floating_factor,water_lin_damp,water_rot_damp);if(obj.floater.bobs){var bob_objs=obj.floater.bobs;for(var i=0;i<bob_objs.length;i++){var obj_bob=bob_objs[i];var bob_trans=obj_bob.render.trans;var wm=obj.render.world_matrix;var wm_inv=new Float32Array(16);m_mat4.invert(wm,wm_inv);var conn_point=new Float32Array(3);m_vec3.transformMat4(bob_trans,wm_inv,conn_point);m_ipc.post_msg(worker,m_ipc.OUT_ADD_FLOATER_BOB,body_id,conn_point,obj_bob.bob_synchronize_pos)}}obj.physics.is_floater=true}exports.enable_simulation=
function(obj){var phy=obj.physics;if(!phy)throw"No object physics";if(phy.simulated)return;var body_id=phy.body_id;var worker=find_worker_by_body_id(body_id);phy.simulated=true;m_ipc.post_msg(worker,m_ipc.OUT_ENABLE_SIMULATION,body_id)};exports.disable_simulation=function(obj){var phy=obj.physics;if(!phy)throw"No object physics";if(!phy.simulated)return;var body_id=phy.body_id;var worker=find_worker_by_body_id(body_id);phy.simulated=false;m_ipc.post_msg(worker,m_ipc.OUT_DISABLE_SIMULATION,body_id)};
exports.scene_has_physics=scene_has_physics;function scene_has_physics(scene){return Boolean(scene._physics)}exports.obj_has_physics=obj_has_physics;function obj_has_physics(obj){return Boolean(obj.physics)}exports.has_dynamic_physics=function(obj){var phy=obj.physics;if(phy&&phy.simulated&&(phy.type=="RIGID_BODY"||phy.type=="DYNAMIC")&&phy.mass>0&&phy.is_ghost==false)return true;else return false};exports.has_simulated_physics=function(obj){var phy=obj.physics;if(phy&&phy.simulated)return true;else return false};
exports.set_gravity=function(obj,gravity){var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,m_ipc.OUT_SET_GRAVITY,body_id,gravity)};function process_rigid_body_joints(obj){if(has_constraint(obj))return;for(var i=0;i<obj.physics_constraints.length;i++){var cons=obj.physics_constraints[i];var targ=cons.target;var pivot_type=cons.pivot_type;if(!targ.physics)continue;var trans=get_rbj_trans(cons);var quat=get_rbj_quat(cons);var local=m_mat4.fromRotationTranslation(quat,
trans,new Float32Array(16));var world_a=m_mat4.multiply(obj.render.world_matrix,local,new Float32Array(16));var world_b_inv=m_mat4.invert(targ.render.world_matrix,new Float32Array(16));var local_b=m_mat4.multiply(world_b_inv,world_a,world_b_inv);var local_b_tra=m_util.matrix_to_trans(local_b);var local_b_qua=m_util.matrix_to_quat(local_b);var limits=prepare_limits(cons);apply_constraint(pivot_type,obj,trans,quat,targ,local_b_tra,local_b_qua,limits,null,null)}}exports.has_constraint=has_constraint;
function has_constraint(obj){return obj.physics&&obj.physics.cons_id}function get_rbj_trans(cons){var trans=new Float32Array([cons.pivot_x,cons.pivot_y,cons.pivot_z]);return trans}function get_rbj_quat(cons){var euler=new Float32Array([cons.axis_x,cons.axis_y,cons.axis_z]);var quat=m_util.euler_to_quat(euler,new Float32Array(4));return quat}function prepare_limits(cons){var limits={};limits["use_limit_x"]=cons.use_limit_x;limits["use_limit_y"]=cons.use_limit_y;limits["use_limit_z"]=cons.use_limit_z;
limits["use_angular_limit_x"]=cons.use_angular_limit_x;limits["use_angular_limit_y"]=cons.use_angular_limit_y;limits["use_angular_limit_z"]=cons.use_angular_limit_z;limits["limit_max_x"]=cons.limit_max_x;limits["limit_min_x"]=cons.limit_min_x;limits["limit_max_y"]=cons.limit_max_y;limits["limit_min_y"]=cons.limit_min_y;limits["limit_max_z"]=cons.limit_max_z;limits["limit_min_z"]=cons.limit_min_z;limits["limit_angle_max_x"]=cons.limit_angle_max_x;limits["limit_angle_min_x"]=cons.limit_angle_min_x;
limits["limit_angle_max_y"]=cons.limit_angle_max_y;limits["limit_angle_min_y"]=cons.limit_angle_min_y;limits["limit_angle_max_z"]=cons.limit_angle_max_z;limits["limit_angle_min_z"]=cons.limit_angle_min_z;return limits}exports.apply_constraint=apply_constraint;function apply_constraint(pivot_type,obj_a,trans_a,quat_a,obj_b,trans_b,quat_b,limits,stiffness,damping){var cons_id=get_unique_constraint_id();var body_a=obj_a.physics.body_id;var body_b=obj_b.physics.body_id;var worker=find_worker_by_body_id(body_a);
m_ipc.post_msg(worker,m_ipc.OUT_APPEND_CONSTRAINT,cons_id,pivot_type,limits,body_a,trans_a,quat_a,body_b,trans_b,quat_b,stiffness,damping);var phy=obj_a.physics;phy.cons_id=cons_id}function find_worker_by_body_id(body_id){for(var i=0;i<_scenes.length;i++){var scene=_scenes[i];var bundles=scene._physics.bundles;for(var j=0;j<bundles.length;j++){var phy=bundles[j].physics;if(phy.body_id==body_id)return _workers[i]}}return null}function get_unique_constraint_id(){_unique_counter.constraint++;return _unique_counter.constraint.toString(16)}
exports.clear_constraint=function(obj_a){var phy=obj_a.physics;var cons_id=phy.cons_id;var worker=find_worker_by_body_id(body_a);m_ipc.post_msg(worker,m_ipc.OUT_REMOVE_CONSTRAINT,cons_id);phy.cons_id=null};exports.pull_to_constraint_pivot=function(obj_a,trans_a,quat_a,obj_b,trans_b,quat_b){var tsr_a=m_tsr.create_sep(trans_a,1,quat_a,_tsr8_tmp);var tsr_b=m_tsr.create_sep(trans_b,1,quat_b,_tsr8_tmp2);m_tsr.invert(tsr_a,tsr_a);m_tsr.multiply(tsr_b,tsr_a,tsr_a);m_trans.get_tsr(obj_b,tsr_b);m_tsr.multiply(tsr_b,
tsr_a,tsr_a);m_trans.set_tsr(obj_a,tsr_a);m_trans.update_transform(obj_a);exports.set_transform(obj_a,obj_a.render.trans,obj_a.render.quat)};exports.set_transform=function(obj,trans,quat){var phy=obj.physics;m_tsr.set_sep(obj.render.trans,1,obj.render.quat,phy.curr_tsr);var msg_cache=m_ipc.get_msg_cache(m_ipc.OUT_SET_TRANSFORM);msg_cache.body_id=phy.body_id;msg_cache.trans=trans;msg_cache.quat=quat;var worker=find_worker_by_body_id(phy.body_id);m_ipc.post_msg(worker,m_ipc.OUT_SET_TRANSFORM)};exports.sync_transform=
sync_transform;function sync_transform(obj){if(allows_transform(obj)&&transform_changed(obj)){var phy=obj.physics;var render=obj.render;m_vec3.copy(render.trans,phy.cached_trans);m_quat.copy(render.quat,phy.cached_quat);var msg_cache=m_ipc.get_msg_cache(m_ipc.OUT_SET_TRANSFORM);msg_cache.body_id=phy.body_id;msg_cache.trans=render.trans;if(phy.type=="DYNAMIC")m_quat.identity(msg_cache.quat);else msg_cache.quat=render.quat;var worker=find_worker_by_body_id(phy.body_id);m_ipc.post_msg(worker,m_ipc.OUT_SET_TRANSFORM)}var cons_descends=
obj.cons_descends;for(var i=0;i<cons_descends.length;i++)sync_transform(cons_descends[i])}function allows_transform(obj){var phy=obj.physics;if(!phy)return false;else if(phy.mass===0)return true;else if(phy.is_ghost===true)return true;else if(phy.simulated===false)return true;else if(phy.type!=="RIGID_BODY"&&phy.type!=="DYNAMIC")return true;else return false}function transform_changed(obj){return obj.render.trans[0]!=obj.physics.cached_trans[0]||obj.render.trans[1]!=obj.physics.cached_trans[1]||obj.render.trans[2]!=
obj.physics.cached_trans[2]||obj.render.quat[0]!=obj.physics.cached_quat[0]||obj.render.quat[1]!=obj.physics.cached_quat[1]||obj.render.quat[2]!=obj.physics.cached_quat[2]}exports.apply_velocity=function(obj,vx_local,vy_local,vz_local){var v_world=_vec3_tmp;vector_to_world(obj,vx_local,vy_local,vz_local,v_world);var body_id=obj.physics.body_id;var vx0=0;var vy0=0;var vz0=0;var vx0a=Math.abs(vx0);var vy0a=Math.abs(vy0);var vz0a=Math.abs(vz0);var vxa=Math.abs(v_world[0]);var vya=Math.abs(v_world[1]);
var vza=Math.abs(v_world[2]);v_world[0]=vxa?v_world[0]/vxa*Math.max(vxa,vx0a):vx0;v_world[1]=vya?v_world[1]/vya*Math.max(vya,vy0a):vy0;v_world[2]=vza?v_world[2]/vza*Math.max(vza,vz0a):vz0;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,m_ipc.OUT_SET_LINEAR_VELOCITY,body_id,v_world[0],v_world[1],v_world[2])};exports.apply_velocity_world=function(obj,vx,vy,vz){var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,m_ipc.OUT_SET_LINEAR_VELOCITY,
body_id,vx,vy,vz)};function vector_to_world(obj,vx_local,vy_local,vz_local,dest){var v=dest||new Float32Array(3);var quat=obj.render.quat;v[0]=vx_local;v[1]=vy_local;v[2]=vz_local;var v_world=m_vec3.transformQuat(v,quat,v);return v_world}exports.apply_force=apply_force;function apply_force(obj,fx_local,fy_local,fz_local){var f_world=_vec3_tmp;vector_to_world(obj,fx_local,fy_local,fz_local,f_world);var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,m_ipc.OUT_APPLY_CENTRAL_FORCE,
body_id,f_world[0],f_world[1],f_world[2])}exports.apply_torque=apply_torque;function apply_torque(obj,tx_local,ty_local,tz_local){var t_world=_vec3_tmp;vector_to_world(obj,tx_local,ty_local,tz_local,t_world);var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,m_ipc.OUT_APPLY_TORQUE,body_id,t_world[0],t_world[1],t_world[2])}exports.set_character_move_dir=function(obj,forw,side){var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,
m_ipc.OUT_SET_CHARACTER_MOVE_DIR,body_id,forw,side)};exports.set_character_move_type=function(obj,type){var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,m_ipc.OUT_SET_CHARACTER_MOVE_TYPE,body_id,type)};exports.set_character_walk_velocity=function(obj,velocity){var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,m_ipc.OUT_SET_CHARACTER_WALK_VELOCITY,body_id,velocity)};exports.set_character_run_velocity=function(obj,
velocity){var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,m_ipc.OUT_SET_CHARACTER_RUN_VELOCITY,body_id,velocity)};exports.set_character_fly_velocity=function(obj,velocity){var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,m_ipc.OUT_SET_CHARACTER_FLY_VELOCITY,body_id,velocity)};exports.character_jump=function(obj){var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,
m_ipc.OUT_CHARACTER_JUMP,body_id)};exports.character_rotation_inc=function(obj,h_angle,v_angle){var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,m_ipc.OUT_CHARACTER_ROTATION_INCREMENT,body_id,h_angle,v_angle)};exports.set_character_rotation=function(obj,angle_h,angle_v){var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,m_ipc.OUT_SET_CHARACTER_ROTATION,body_id,angle_h,angle_v)};exports.set_character_rotation_h=
function(obj,angle){var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,m_ipc.OUT_SET_CHARACTER_HOR_ROTATION,body_id,angle)};exports.set_character_rotation_v=function(obj,angle){var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,m_ipc.OUT_SET_CHARACTER_VERT_ROTATION,body_id,angle)};exports.append_collision_test=function(obj_src,collision_id,callback,calc_pos_norm){var phy=obj_src.physics;var body_id_src=phy.body_id;
var collision_id=collision_id||"ANY";for(var i=0;i<phy.collision_tests.length;i++){var test=phy.collision_tests[i];if(test.collision_id==collision_id&&test.callback==callback)return}var test={body_id_src:body_id_src,calc_pos_norm:calc_pos_norm||false,collision_id:collision_id,callback:callback,pairs:[],pair_results:[]};phy.collision_tests.push(test);var worker=find_worker_by_body_id(body_id_src);var scene=find_scene_by_worker(worker);append_collision_pairs(test,scene,worker)};function append_collision_pairs(test,
scene,worker){var pairs=test.pairs;var pair_results=test.pair_results;var body_id_a=test.body_id_src;var body_id_b_arr=[];collision_id_to_body_ids(test.collision_id,scene,body_id_b_arr,null);for(var i=0;i<body_id_b_arr.length;i++){var body_id_b=body_id_b_arr[i];if(body_id_a<body_id_b&&!has_pair(pairs,body_id_a,body_id_b)){pairs.push([body_id_a,body_id_b]);pair_results.push(false)}else if(body_id_a>body_id_b&&!has_pair(pairs,body_id_b,body_id_a)){pairs.push([body_id_b,body_id_a]);pair_results.push(false)}}m_ipc.post_msg(worker,
m_ipc.OUT_ACTIVATE,body_id_a);m_ipc.post_msg(worker,m_ipc.OUT_APPEND_COLLISION_TEST,pairs,test.calc_pos_norm)}function has_pair(pairs,body_id_a,body_id_b){for(var i=0;i<pairs.length;i++)if(pairs[i][0]==body_id_a&&pairs[i][1]==body_id_b)return true;return false}function gen_collision_body_ids(callbacks,bpy_scene,dest_arr,dest_obj){if("ANY"in callbacks){for(var i=0;i<bpy_scene._physics.bundles.length;i++){var bundle=bpy_scene._physics.bundles[i];var body_id=bundle.physics.body_id;dest_arr.push(body_id);
dest_obj[body_id]=0}return}for(var collision_id in callbacks)for(var i=0;i<bpy_scene._physics.bundles.length;i++){var bundle=bpy_scene._physics.bundles[i];if(bundle.physics.collision_id==collision_id){var body_id=bundle.physics.body_id;if(dest_arr.indexOf(body_id)==-1)dest_arr.push(body_id);dest_obj[body_id]=0}}}exports.remove_collision_test=function(obj,collision_id,callback){var phy=obj.physics;var body_id=phy.body_id;var worker=find_worker_by_body_id(body_id);var scene=find_scene_by_worker(worker);
for(var i=0;i<phy.collision_tests.length;i++){var test=phy.collision_tests[i];if(test.collision_id==collision_id&&test.callback==callback){if(calc_coll_result(test)){var zero=m_vec3.set(0,0,0,_vec3_tmp);test.callback(false,null,zero,zero,0)}phy.collision_tests.splice(i,1);i--;remove_unused_collision_pairs(scene,worker,test.pairs)}}};function remove_unused_collision_pairs(scene,worker,pairs){var bundles=scene._physics.bundles;var unused_pairs=pairs;for(var i=0;i<bundles.length;i++){var phy=bundles[i].physics;
for(var j=0;j<phy.collision_tests.length;j++){var test=phy.collision_tests[j];for(var k=0;k<test.pairs.length;k++){var pair=test.pairs[k];for(var l=0;l<unused_pairs.length;l++){var unused_pair=unused_pairs[l];if(pair[0]==unused_pair[0]&&pair[1]==unused_pair[1]){unused_pairs.splice(l,1);l--}}}}}if(unused_pairs.length)m_ipc.post_msg(worker,m_ipc.OUT_REMOVE_COLLISION_TEST,unused_pairs)}function remove_collision_pairs_by_id(scene,worker,body_id){var bundles=scene._physics.bundles;var removed_pairs=[];
for(var i=0;i<bundles.length;i++){var phy=bundles[i].physics;for(var j=0;j<phy.collision_tests.length;j++){var test=phy.collision_tests[j];for(var k=0;k<test.pairs.length;k++){var pair=test.pairs[k];var pair_result=test.pair_results[k];if(pair[0]==body_id||pair[1]==body_id){test.pairs.splice(k,1);test.pair_results.splice(k,1);k--;if(pair_result&&!calc_coll_result(test)){var zero=m_vec3.set(0,0,0,_vec3_tmp);test.callback(false,null,zero,zero,0)}removed_pairs.push(pair)}}}}if(removed_pairs.length)m_ipc.post_msg(worker,
m_ipc.OUT_REMOVE_COLLISION_TEST,removed_pairs)}exports.apply_collision_impulse_test=function(obj,callback){if(has_collision_impulse_test(obj))clear_collision_impulse_test(obj);var phy=obj.physics;var worker=find_worker_by_body_id(phy.body_id);m_ipc.post_msg(worker,m_ipc.OUT_APPLY_COLLISION_IMPULSE_TEST,phy.body_id);phy.col_imp_test_cb=callback};exports.clear_collision_impulse_test=clear_collision_impulse_test;function clear_collision_impulse_test(obj){if(!has_collision_impulse_test(obj))return;var phy=
obj.physics;var worker=find_worker_by_body_id(phy.body_id);m_ipc.post_msg(worker,m_ipc.OUT_CLEAR_COLLISION_IMPULSE_TEST,phy.body_id);phy.col_imp_test_cb=null}function has_collision_impulse_test(obj){if(obj.physics&&obj.physics.col_imp_test_cb)return true;else return false}exports.append_ray_test=function(obj,from,to,collision_id,callback,autoremove,calc_all_hits,calc_pos_norm,ign_src_rot){var id=get_unique_ray_test_id();var collision_id=collision_id||"ANY";var test={id:id,body_id:obj?obj.physics.body_id:
0,from:new Float32Array(from),to:new Float32Array(to),collision_id:collision_id,collision_id_num:col_id_num(collision_id),autoremove:autoremove,calc_all_hits:calc_all_hits,calc_pos_norm:calc_pos_norm,ign_src_rot:ign_src_rot,callback:callback};var worker=find_worker_by_body_id(test.body_id)||_workers[0];var scene=find_scene_by_worker(worker);var sphy=scene._physics;var id=test.id;sphy.ray_tests[id]=test;sphy.ray_tests_arr.push(test);m_ipc.post_msg(worker,m_ipc.OUT_APPEND_RAY_TEST,test.id,test.body_id,
test.from,test.to,test.collision_id_num,test.autoremove,test.calc_all_hits,test.calc_pos_norm,test.ign_src_rot);return id};function get_unique_ray_test_id(){_unique_counter.ray_test++;return _unique_counter.ray_test}function collision_id_to_body_ids(collision_id,bpy_scene,dest_arr,dest_obj){if(!dest_arr&&!dest_obj)throw"At least one destination required";for(var i=0;i<bpy_scene._physics.bundles.length;i++){var bundle=bpy_scene._physics.bundles[i];if(collision_id=="ANY"||bundle.physics.collision_id==
collision_id){var body_id=bundle.physics.body_id;if(dest_arr&&dest_arr.indexOf(body_id)==-1)dest_arr.push(body_id);if(dest_obj)dest_obj[body_id]=0}}}exports.remove_ray_test=remove_ray_test;function remove_ray_test(id){var scene=find_scene_by_ray_test_id(id);var worker=find_worker_by_ray_test_id(id);var sphy=scene._physics;if(sphy.ray_tests[id]){delete sphy.ray_tests[id];sphy.ray_tests_arr.splice(sphy.ray_tests_arr.indexOf,1);m_ipc.post_msg(worker,m_ipc.OUT_REMOVE_RAY_TEST,id)}}exports.change_ray_test_from_to=
function(id,from,to){var scene=find_scene_by_ray_test_id(id);var worker=find_worker_by_ray_test_id(id);var sphy=scene._physics;var test=sphy.ray_tests[id];if(test&&!test.autoremove){test.from.set(from);test.to.set(to);m_ipc.post_msg(worker,m_ipc.OUT_CHANGE_RAY_TEST_FROM_TO,id,from,to)}};exports.is_ray_test=function(id){var scene=find_scene_by_ray_test_id(id);var sphy=scene._physics;if(sphy.ray_tests[id])return true;else return false};function find_scene_by_ray_test_id(id){for(var i=0;i<_scenes.length;i++){var scene=
_scenes[i];var sphy=scene._physics;if(sphy.ray_tests[id])return scene}return null}function find_worker_by_ray_test_id(id){for(var i=0;i<_scenes.length;i++){var scene=_scenes[i];var sphy=scene._physics;if(sphy.ray_tests[id])return _workers[i]}return null}exports.vehicle_throttle=function(obj,engine_force){var vehicle=obj.vehicle;vehicle.engine_force=engine_force;var worker=find_worker_by_body_id(obj.physics.body_id);update_vehicle_controls(obj,vehicle,worker)};function update_vehicle_controls(obj,
vehicle,worker){if(!vehicle.steering_wheel)return;var body_id=obj.physics.body_id;var engine_force=vehicle.engine_force*vehicle.force_max;var brake_force=vehicle.brake_force*vehicle.brake_max;var steering=-vehicle.steering*vehicle.steering_max*2*Math.PI/vehicle.steering_ratio;if(vehicle.inverse_control)steering*=-1;switch(vehicle.type){case VT_CHASSIS:m_ipc.post_msg(worker,m_ipc.OUT_UPDATE_CAR_CONTROLS,body_id,engine_force,brake_force,steering);break;case VT_HULL:m_ipc.post_msg(worker,m_ipc.OUT_UPDATE_BOAT_CONTROLS,
body_id,engine_force,brake_force,steering);break}}exports.vehicle_steer=function(obj,steering_value){var vehicle=obj.vehicle;vehicle.steering=steering_value;var worker=find_worker_by_body_id(obj.physics.body_id);update_vehicle_controls(obj,vehicle,worker)};exports.vehicle_brake=function(obj,brake_force){var vehicle=obj.vehicle;vehicle.brake_force=brake_force;var worker=find_worker_by_body_id(obj.physics.body_id);update_vehicle_controls(obj,vehicle,worker)};function update_steering_wheel_coords(obj_chassis){var vehicle=
obj_chassis.vehicle;var stw_obj=vehicle.steering_wheel;if(!stw_obj)return;var stw_matrix=obj_chassis.vehicle.steering_wheel_matrix;var stw_axis=obj_chassis.vehicle.steering_wheel_axis;var stw_matrix_world=_mat4_tmp;var chassis_trans=obj_chassis.render.trans;var chassis_quat=obj_chassis.render.quat;m_util.transform_mat4(stw_matrix,1,chassis_quat,chassis_trans,stw_matrix_world);m_util.matrix_to_trans(stw_matrix_world,stw_obj.render.trans);m_util.matrix_to_quat(stw_matrix_world,stw_obj.render.quat);
var stw_axis_world=_vec4_tmp;m_util.transform_vec4(stw_axis,1,chassis_quat,chassis_trans,stw_axis_world);var rotation=_quat4_tmp;m_quat.setAxisAngle(stw_axis_world,-vehicle.steering*vehicle.steering_max*2*Math.PI,rotation);m_quat.multiply(rotation,stw_obj.render.quat,stw_obj.render.quat);m_trans.update_transform(stw_obj)}function update_speedometer(obj_chassis){var vehicle=obj_chassis.vehicle;var sp_obj=vehicle.speedometer;if(!sp_obj)return;var sp_matrix=obj_chassis.vehicle.speedometer_matrix;var sp_axis=
obj_chassis.vehicle.speedometer_axis;var sp_matrix_world=_mat4_tmp;var chassis_trans=obj_chassis.render.trans;var chassis_quat=obj_chassis.render.quat;m_util.transform_mat4(sp_matrix,1,chassis_quat,chassis_trans,sp_matrix_world);m_util.matrix_to_trans(sp_matrix_world,sp_obj.render.trans);m_util.matrix_to_quat(sp_matrix_world,sp_obj.render.quat);var sp_axis_world=_vec4_tmp;m_util.transform_vec4(sp_axis,1,chassis_quat,chassis_trans,sp_axis_world);var rotation=_quat4_tmp;var angle=Math.abs(vehicle.speed)*
vehicle.speed_ratio;if(angle>vehicle.max_speed_angle)angle=vehicle.max_speed_angle;m_quat.setAxisAngle(sp_axis_world,-angle,rotation);m_quat.multiply(rotation,sp_obj.render.quat,sp_obj.render.quat);m_trans.update_transform(sp_obj)}function update_tachometer(obj_chassis){var vehicle=obj_chassis.vehicle;var tach_obj=vehicle.tachometer;if(!tach_obj)return;var tach_matrix=obj_chassis.vehicle.tachometer_matrix;var tach_axis=obj_chassis.vehicle.tachometer_axis;var tach_matrix_world=_mat4_tmp;var chassis_trans=
obj_chassis.render.trans;var chassis_quat=obj_chassis.render.quat;m_util.transform_mat4(tach_matrix,1,chassis_quat,chassis_trans,tach_matrix_world);m_util.matrix_to_trans(tach_matrix_world,tach_obj.render.trans);m_util.matrix_to_quat(tach_matrix_world,tach_obj.render.quat);var tach_axis_world=_vec4_tmp;m_util.transform_vec4(tach_axis,1,chassis_quat,chassis_trans,tach_axis_world);var rotation=_quat4_tmp;m_quat.setAxisAngle(tach_axis_world,-Math.abs(vehicle.engine_force)*vehicle.delta_tach_angle,rotation);
m_quat.multiply(rotation,tach_obj.render.quat,tach_obj.render.quat);m_trans.update_transform(tach_obj)}exports.is_vehicle_chassis=is_vehicle_chassis;function is_vehicle_chassis(obj){return obj.is_vehicle&&obj.vehicle_settings.part=="CHASSIS"}exports.is_vehicle_hull=is_vehicle_hull;function is_vehicle_hull(obj){return obj.is_vehicle&&obj.vehicle_settings.part=="HULL"}exports.is_car_wheel=function(obj){if(!obj.is_vehicle)return false;var part=obj.vehicle_settings.part;if(part=="WHEEL_FRONT_LEFT"||part==
"WHEEL_FRONT_RIGHT"||part=="WHEEL_BACK_LEFT"||part=="WHEEL_BACK_RIGHT")return true;else return false};exports.is_boat_bob=function(obj){if(!obj.is_vehicle)return false;var part=obj.vehicle_settings.part;if(part=="BOB")return true;else return false};exports.is_floater_bob=function(obj){if(!obj.is_floating)return false;var part=obj.floating_settings.part;if(part=="BOB")return true;else return false};exports.is_vehicle_steering_wheel=function(obj){if(obj.is_vehicle&&obj.vehicle_settings.part=="STEERING_WHEEL")return true;
else return false};exports.is_vehicle_speedometer=function(obj){if(obj.is_vehicle&&obj.vehicle_settings.part=="SPEEDOMETER")return true;else return false};exports.is_vehicle_tachometer=function(obj){if(obj.is_vehicle&&obj.vehicle_settings.part=="TACHOMETER")return true;else return false};exports.get_vehicle_speed=function(obj){var vehicle=obj.vehicle;return vehicle.speed};exports.wheel_index=function(vehicle_part){switch(vehicle_part){case "WHEEL_FRONT_LEFT":return 0;case "WHEEL_FRONT_RIGHT":return 1;
case "WHEEL_BACK_LEFT":return 2;case "WHEEL_BACK_RIGHT":return 3}};exports.is_character=is_character;function is_character(obj){return obj.is_character}exports.is_floater_main=is_floater_main;function is_floater_main(obj){return obj.is_floating&&obj.floating_settings.part=="MAIN_BODY"}exports.get_fps=function(){return _phy_fps};exports.debug_workers=function(){for(var i=0;i<_workers.length;i++){var worker=_workers[i];m_ipc.post_msg(worker,m_ipc.OUT_DEBUG)}};exports.remove_bounding_object=function(obj){var ind=
_bounding_objects_arr.indexOf(obj);if(ind==-1)m_print.error("Object "+obj.name+" doesn't have bounding physics");var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);var scene=find_scene_by_worker(worker);remove_collision_pairs_by_id(scene,worker,body_id);if(has_collision_impulse_test(obj))clear_collision_impulse_test(obj);delete _bounding_objects[body_id];_bounding_objects_arr.splice(ind,1);var bundles=scene._physics.bundles;for(var i=0;i<bundles.length;i++){var phy=bundles[i].physics;
if(phy.body_id==body_id){bundles.splice(i,1);i--}}m_ipc.post_msg(worker,m_ipc.OUT_REMOVE_BODY,body_id)}};b4w.module["__data"]=function(exports,require){var m_anchors=require("__anchors");var m_anim=require("__animation");var m_assets=require("__assets");var m_batch=require("__batch");var m_cam=require("__camera");var m_cfg=require("__config");var m_ctl=require("__controls");var m_dds=require("__dds");var m_ext=require("__extensions");var m_lights=require("__lights");var m_loader=require("__loader");var m_mat4=require("__mat4");var m_md5=require("__md5");var m_nla=require("__nla");var m_lnodes=require("__logic_nodes");
var m_nodemat=require("__nodemat");var m_obj=require("__objects");var m_obj_util=require("__obj_util");var m_phy=require("__physics");var m_print=require("__print");var m_reformer=require("__reformer");var m_render=require("__renderer");var m_scenes=require("__scenes");var m_sfx=require("__sfx");var m_shaders=require("__shaders");var m_tex=require("__textures");var m_time=require("__time");var m_trans=require("__transform");var m_util=require("__util");var m_vec4=require("__vec4");var cfg_def=m_cfg.defaults;
var cfg_ldr=m_cfg.assets;var cfg_phy=m_cfg.physics;var cfg_anim=m_cfg.animation;var cfg_sfx=m_cfg.sfx;var DEBUG_BPYDATA=false;var DEBUG_LOD_DIST_NOT_SET=false;var BINARY_INT_SIZE=4;var BINARY_SHORT_SIZE=2;var BINARY_FLOAT_SIZE=4;var _bpy_data_array=null;var _all_objects_cache=null;var _debug_resources_root="";var _primary_data=null;var _dupli_obj_id_overrides={};var PLAY_MEDIA_IMAGE_MOBILE="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALAAAACwCAYAAACvt+ReAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAbrwAAG68BXhqRHAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAABVDSURBVHic7Z15kF1Vncc/v05Ys7JIQJZ0GLaAgCzCQARGFMIwZKTiqCPBAbTEEodBhYKALJKSVWYsCpTBcgCLAdQBHWZACCCyhCElIRiWEMOSBZAkCglJOoTQyW/++J3Xfe95971+273v3fvOp6qr+5573+vT3d8+93vP+Z3fTwjUhKoKsC0wLvKxDTA68rEVMNK9ZDiwpft6PdDvvl4LvA+sBt5zn1cCy4EVwDJgpYhouj9RMZB2d6ATUdWtgD2BXvcxARgPbJ5RFzYAS4BFwGL38YqIvJ/R988NQcCAqm4LHADsA+yLibannX1KYBMm6JeBBcA8EVnZ3i61n64UsKoOAyYCh7iPCeTvd6HA68BcYA6wQEQ2trdL2ZO3P1rDqGoPsD9wNHAkMKqBt1nNoFctfV7j2ldj/rbPXdsvIuvd994S88QAIzCfHPXOHyHurRvt21PALOAFEdnUwHvkjsILWFV7gcnAUcDYWl8GvAEsZNCDLhKR91rfw4RvrjoWuyv0us97ALtS+99rFfAEMFNElqTRx06hkAJ2I94ngRMwXzsUmzCxzsP85csisja9HtaPqo7CbM9EzK/vRW1/vwXATODJ0h2hSBRKwO5hbAom3KFuw2uAZzD/+JyIrEm5ey1FVUcDB2Ee/hPU9vM+ANwnIu+m3L3MKISAVXU3YCrwNwx6zSTWArOBJ7Gn+P4q1+YGVR0OfByzSX+N+exKfAg8DtwtIm9m0L1UybWAVfWjwJcw4Vb6WRT4A3YbnV0U0VZCVTfDRDwZOJDKv5dNwGPAXSLydja9az25FLCqbg9MA44FhlW4bDXwIPYgszyrvnUSqrojJuRqlqof+C1wp4i8k1XfWkWuBKyqmwN/D3wRW7ZN4m3gfzHhfpBV3zoZNyofBXwem81I4gPgHsxabMiqb82SGwGr6lHAV7A50yQWA3cCT4c4gmRcPMeRwCnY0ngSK4BbRGRWZh1rgo4XsJtZOAvzdUm8CfwSeKxbJu+bxQl5EnAqsEuFy+YAPxKRP2fWsQboWAG7X/JJwGkMRnVFWQXcDjwchNsYbnVyMibkMQmXvA/8DLi/U+9qHSlg95B2HvCxhNP9wG+AO0SkL+F8oE7cws9UzCNvlnDJAuA6EVmWacdqoOMErKpHA98keS7zReAGEXkr2151B6q6C3A2sF/C6bWYpXgy215Vp2MErKpbYMI9NuF0H3ArNrPQkbeyouCs2wnA6SQPIo8AN3XKDE9HCFhVdwK+iwWv+DwLXF+k5c88oKrbAecAByecfh24shMsRdsFrKqHYn53pHdqAzYtdk8YdduDG40nA18DtvBOrwP+TURmZ96xCG0VsKp+DrtV+f1YDFwrIkuz7lOgHBeSej6wm38KmzP+deadcrRFwG765kxsmszncexBrXChf3nGzVScg63o+cwEftyOHSGZC9htmLwAONQ71Y/9N/9P1n0K1I6qngycQXkMyjPANVkPPJkKWFVHApcDe3un1mIPBc9n2Z9AY6jqgcBFlM9SLAAuy3J+PjMBu20yM4DdvVPLge+JyBtZ9SXQPC4G+zJsD1+U14BLs9p+lYmAXTzDFZRHQi0EZojIqiz6EWgtqroNcCmWQyPKUuDiLKY+Uxewqo4BrqL8CfZF4PKQrCPfuIe7S7Dg+ShvARekPTilKmBVHYGNvHt4p54FrshT3GmgMm4V9SJsf16URcBFae43TE3Abrbh+5Q/sM0Gri761p5uwwXNTwcO904twOxEKrMTqaRPcvO851Eu3uewqZYg3oIhIh9iVnGOd2ofYLrLhtRy0sr/dSbl/4nzMdvwYUrfM9Bm3MB0JfCCd+pQbFNCy2m5gN3ysL/CthCbWgmrawXHPdfMAF7xTk12iyAtpaUCVtXDsNiGKMuxqbIg3i7BzSzNwPbXRfmqC95qGS0TsKqOA75N/MGwjzDP25W41K+XYausA83AeS58tiW0RMCRucBo7oF+zPMWOrlcoDJudfUqIBrkMxK40KVIaJpWjcBnUR6MfkuIbQiIyDzgNq95d+AbrXj/pgWsqpMo3wb0eIgqC5Rw8cL+Xrrj3P7HpmhKwKr6EeBfvOYlwA3NvG+gkFyPxUhEOcvtQG+YhgXstpucSzykbgO2kyLMOARiOE1ci2XHLDES+I7TUkM0MwJPoTxvw63hoS1QCRFZjCVKiXIAcGKj79mQgJ11+LLX/BxwX6MdCXQN92K7N6Kc1qiVaHQE/ibx7JB9wA/D7uHAUDiN3MhgMRyArWlwqbluAbsskf5qyq0hb0OgVlwe4tu85sPcjFZd1CVgN/l8htf8IrYrNRCohwexAK8oX3OxxTVT7wg8FdghctyPbYEP1iFQF04zNzBYQxpge+Cz9bxPzQJ2qYb+wWu+NyTaCzSKW2q+32v+gttDWRP1jMDTiOfpXYUllg4EmuFOrJ5JiS2xDPI1UZOAXTWgT3vNt4f8vIFmcRq63Wv+jCtQMyS1jsCnEM/E8haWZjO3qOrDqrp/u/sRAGwSIFqzbjjwj7W8cEgBuwQWftDFfxagMvpngLmqerNbmAm0CVci4ude87GquvNQr61lBP6cd90SrCJ6ERiO7d/7o6pe0KoY1UBDPI5lJS3Rg2mvKlUF7J4Gj/Ga7yjgtNk2wNXAC6r6+XZ3phtxmvqF1/wpl/2nIkONwFOI1x7+E/B0/d3LDXsBvwz+uG08hRWqLLEZySl4B6goYLdN6ASv+b8LOPomEfxxG3Be+F6v+cRqq3PVRuCjie9xWwM82nj3ckfwx+3hYeLzwqNITqoNVBfw8d7xg10aqB78cYa46kd+bM3kStcnCtjVRNgn2gQ81Gznck7wx9kxE9NciYluOreMSiOwr/g/iMjbiVd2H8Efp4wr3+XvaPcdAZAgYJeYz/ccIVwyTvDH6ePf8Y9x2oyRNALvD4yNHPdhKVED5QR/nB5PY7XoSmwD7OtflCRgf9n4/0I61CEJ/rjFuCSB/sBZNhsRE7DL4XqEd01Rlo2zIPjj1uJrb5JvI/wReCIwOnK8GpiXQseKTPDHrWMutv5QYix2txvAF7Bf42BOsA8NE/xxkzjtzfWaYxr1BezvNvbTxQfqJ/jj5njWO45pdEDALuqnN3JuE5asJNAagj9ujGeJL2rs4YpmAvER+EDiyakXplkeqUsJ/rhOXMXP16JNRFKaRQU80XtteHhLj+CP68PX4sB8cE9So+Pl1LoTKBH8cW34WowL2BUlHB+5QIE/pt+vgCP44+rMJ+6DJ7h49YEReE/io/Ebwf9mTvDHFRCR1dhO+BLDcOWLS6Lt9V7j1/gKZEfwx8ks9I4nwKCAd/dOLkq9O4GhCP44jp84vRcqj8BBwJ1D8MeGr8legB5Xn8CPdg9lAjqL4I/jOSMAxquq9ADbAtFfyJpQWbNj6Vp/7BKoR3PxbQmM7QHGedcuy6xXgUbpVn+83DselyRg/6JA59Jt/tjX5g5BwPmnm/xx4gjs5576S0adCbSWbvDHK7zj7XqI78AAy7weyC9F9serveNRSQIOS8jFoIj+2Bfw6CDgYlM0f+xrc3QPVnC52kWB/FMUf+yPwCN7sBysUT7IqDOB7Mm7P97gHW+eJOCwC7n45NUff+gdb5YkYP+iQDHJoz9OFPBwrzGMwN1FnvxxooADgRLvt7sD9dJD+Yjrj8iBYrMSmA7sLyL3tbszQ1Bmd4djw/Lm3kX+016gePQDtwAXi8if292ZGqko4ChhBC4+jwDfFpEX292ROqlJwBVLGgVyz0Lg3BxYhUr4MyUbeihfeRtFoGjkyedWoyzsYTgJ68sZdSaQPnn0udVIFHBZhE9GnQmkS159bjV8bb4XBFw88u5zq+Hb27XDMX8UZfuMOhNoLSuBa4AfugIpRWQH7/id4ZTvM9oxo84EWkPRfG41fG0uTxKwr/JA51JEn1sNX5uJAg4jcOdTZJ9bjbId9D3Au8SD2EdFaxAEOoqizOfWjapuC4yINL0PvNcjIgos9a7vzapjgZroB34C7C0i1xT4Ia0aE7zjJSIyUPUwMfNfoCN4BDhIRL7eBQ9p1ej1jhfBYODOYu+kr/ZA9nSrz63EeO94CQwK2B+B90y9O4FKdMN8biPs5R0vhkEBvwJsxGoPAOyqqqNCnYxM6ab53LpQ1dHAzpGmjcCr4DK0i8h64jZCgH0y6l8g+Nyh2Jd4Ec7XnWZjlYkq1uIKpMZCYIqIHNdFixGN4GvxpdIX1QScx8QXeaFr53Mb5EDveECr0e1Dz2PF5EpD9d6qOsbVqg20huBz60RVxxCvoqUkjcAishJ4PXKhAB9Pu4NdRPC5jXEIcf/7SrSGi58XYm7CiwPNEXxuc/ganBM98AU8xzs+TFXDLuXGCD63SZz2fAHHBllfwAuI79AYSbAR9RLiFlrHwcTT/67CKzkbE7CIbASe8t7kk6l0rZgEn9tajvaOZ4nIpmhDUm60Wd7xEarqJ5QIxAk+t8W4bJmHec2+NhMF/DwWI1xiBHB467pWKILPTY8jga0jx+8SmT4rUSZgFx/sK/2ElnYt/wSfmz7HecdPOG3GqJRedaZ3fKCq7tSSbuWf4HNTRlV3BA7wmh9KujZRwCKyBJuRGGgCjm9J7/JL8LnZMZn44sV8EfF3DQGVR2AoH4VPUNUtm+1ZDgk+N0NUdQvKLauvxQGqCfgJ4nnTRgHHNt613BF8bns4jngGnjUkzD6UqChgEfkA+I3XPFVVu6EsQfC5bcBp67Ne831Oi4kMJcb7iecP3hE4orHu5YLgc9vLJCA6WbAB02BFqgpYRN4FHveap6mqJF2fY4LPbTNu9D3Fa340GnmWRC124G4guny3G+VLfHkl+NzO4Rhg18jxRuBXQ71oSAGLyJvAY17zNFUdlnB5nngAOCD43PbjRt8ves2/E5E/DfXaWh/I7iJejuuj5HxeWEROFBF/G1WgPZwI7BI57gd+XssLaxKwiLwN/NZrPlVVRyRdHwjUiqqOBKZ5zQ+LyLJaXl/PlNidwPrI8RjgS3W8PhBIYhrxed/12B2/JmoWsIi8gz3QRTlJVXdJuj4QGApV3Q34W6/5F272qybqXZT4FfF8wsOBbxVwWi2QMk4z/0x8Z/wy4N563qcuAbtpplu95n0I4ZaB+jmR8oQlP613KrPuZWERmQX83ms+XVW3q/e9At2Jqm4PnOY1zxaR2fW+V6NxDTcCfZHjEQQrEaiBiHWI7rZYB/x7I+/XkICdyb7daz4ImNLI+wW6ipOBQ72220TkL428WTORZfcDL3htp6tqbxPvGSgwqro78E9e8zxsVbQhGhaw25/0r8DaSPPmwPldGvgeqIKqbgWcD0R3uK/BEnmX7XWrlaZie92wf4PXvBtwbvDDgRJOC+cQXy4G+HGj1qFE08HpIvIUFgAe5QjKA5MD3ctUyhPkzBSRJ5t941btrriJeGZLgDNU1c/rGugyVPUgyn3vq8DNrXj/lgjYbfn4PvG8asOA74aHuu7FLRVPZ7D2CpjvvapVsdct298mIiuAHxAPft8auERVt2nV9wnkA1dZ83vEq2sqcJ2I+OWNG6alGzRF5DnKl5rHAZe6p9BAF6CqWwOXUV6c+6ci8mwrv1fLdxiLyK8Bf1/ZnsCMML1WfFxeh0uBv/JOPSgidQXq1EJaW+R/Avjr2hOBi13WwUABcQmpLwQ+5p2agz3ot5xUBOxyuF5HPD0VWLLsC0K61uLh/qYXUb5MPB+42uWebjmpLja4LUdXAHt4p54HZpSK1QXyjbMNF2PxMFEWAReKyNryV7WG1FfLXJnQq7EVuigvAZeLyLq0+xBID/dccwnltdzeBKYPldehWVJPEyUiq7H/Tj+74H7AFWGKLb+4qbJrKBfvUuCitMULGYzAJdzu0xmUVx1/BxuJ/ZW8QAfjFim+R/lU2WvApVkVyMw04MZ54sspLyTeB1wpIvOy7E+gMdzy8HTiixRgD2yXi0hf+avSIfOIMeeZLgA+4Z3aiC2C3NtMeF0gPVxU2VQstsHPzPR74NqsH8zbEvLoUgmdCZyUcHo2FiOa2X9xYGjcwPMtksuuPQjclNZUWTXaGrOrqicDX03ox1Lsv3lx5p0KlOF2UpxPeTzvJuA/0lhhq5W2B52r6gHYL2esd+pD4A7gnmAp2oOzDFOAM4jvpACLKvuBiPj1tTOl7QIGUNVx2CqOv34OVhv3epcZKJARbuv7OZQvToDNNFzZyqiyRukIAcNAZcZvUF4fDGyW4mfAA2E0Thc36v4d9qC2dcIlM4GbOyWXcscIuISqTgLOJl7kucR84AYReSPbXnUHbm73bCzwymcNcKPbQtYxdJyAYeD29R3Ki92B5Y69D7grzFS0BrfIdAqW7ml4wiXzsJmhpjZgpkFHChhqupWtxpKrPNSO6Zsi4LLsnwCcSjzFaYl1wG10sHXrWAGXcOvtX8cq2CSxHPgvTMibKlwTiOAGh0nAl4GdK1z2DPCjThx1o3S8gEs4b/wVbItSEkuxxMizOnW0aDduAWkSZhd2rXDZMmxu9+nMOtYEuREwDET8n4jd8pJsBdiIfC82Iod4YwaCzY8CvkD5YkSJ9Vj+57s7ZYahFnIl4BLOVkwDPk3yQwfYU/ODmJDfzqpvnYSq7oQVzp5MsscFeyh+GHsorjkzeqeQSwGXUNUdsTodn6JybLNiO0BmYjloczO6NIKbTz8SqyK1P5X/xhuB32HCbfuCRKPkWsAlXJ2OqZiQq+23W4cFC80C5opIf5Vrc4OzCAdhNuFwKtsrsCX6R7El+iHrsHU6hRBwCbe74yTMJ1e6ZZbow56052JiTn33QCtR1bHAwcAh2EbKoUqercFS4t6Xt5+1GoUScAm3yfAo7Dbq12FIfAmWr+t5bLXvZbcVqmNQ1THYCtm+2Bae3ant7zcfeAh4slrV97xSSAFHccujx2P1nbet9WXAW1j1+iVY4sIlWT3kuHoj44EJQC+WGKaecmbvAk9gGSALvexeeAGXcJP3+2Ej8yTKwzdroQ+bJ12BTdetwFYE10Q+r8PiZPtL03guGHw49qC5NWZvRkc+74DNb5c+GqmAugrz9rOAl7plLrxrBBzFTejvhXnHQ7C8FXn7XSjwCvCs+1jYjSuRefujpYLzl/tj/nIi5i/9PV/tZiNmZV7Gcmq8mNXO304mCDgBd8vfA/OfvZgXHQ9klZxwPbAY89+L3NevhpXFcoKA68BN05V86g7Adgz62NGYd90KG72Hua8B3sdG0H5MnH2YZy755ncY9NTLijTNlTb/Dz+sKh/f1rAbAAAAAElFTkSuQmCC";
var _play_media_btn=null;var _play_media_bkg=null;var _canvas_container_z_index=0;var SECONDARY_LOAD_TYPES_DISABLED=["LAMP","CAMERA"];var ADD_PHY_TYPES=["MESH","CAMERA","EMPTY"];var B4W_INFO="B4WB";var MAJOR_VERSION_EMPTY=5;var MINOR_VERSION_EMPTY=4;var B4W_HEADER_OFFSET=12;var _canvas=null;exports.is_primary_loaded=function(data_id){return m_loader.is_primary_loaded(data_id)};exports.update=function(){m_loader.update_scheduler(_bpy_data_array)};function free_load_data(bpy_data,thread){_bpy_data_array[thread.id]=
null;_all_objects_cache[thread.id]=null}function print_image_info(image_data,image_path,show_path_warning){var w,h;if(image_data instanceof ArrayBuffer){var dds_wh=m_dds.get_width_height(image_data);w=dds_wh.width;h=dds_wh.height}else{w=image_data.width;h=image_data.height}var color;if(w>2048||h>2048)color="a00";else if(w>1024||h>1024)color="aa0";else color="0a0";m_print.log("%cLOAD IMAGE "+w+"x"+h,"color: #"+color,image_path);if(image_path.indexOf(_debug_resources_root)==-1&&show_path_warning)m_print.warn("image",
image_path,"is not from app root.")}function print_video_info(video,image_path,show_path_warning,type){if(type==m_assets.AT_VIDEO_ELEMENT){var w=video.videoWidth;var h=video.videoHeight}else{var w=video.images[0].width;var h=video.images[0].height}var color;if(w>2048||h>2048)color="a00";else if(w>1024||h>1024)color="aa0";else color="0a0";m_print.log("%cLOAD VIDEO "+w+"x"+h,"color: #"+color,image_path);if(image_path.indexOf(_debug_resources_root)==-1&&show_path_warning)m_print.warn("video",image_path,
"is not from app root.")}function load_main(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){var main_path=thread.filepath;if(!main_path)throw"Nothing requested";var asset_cb=function(loaded_bpy_data,uri,type,path){if(!loaded_bpy_data){m_loader.abort_thread(thread);return}m_print.log("%cLOAD METADATA","color: #616",path);check_format_version(loaded_bpy_data);for(var prop in loaded_bpy_data)bpy_data[prop]=loaded_bpy_data[prop];prepare_thread_bpy(thread,bpy_data);show_export_errors(bpy_data);show_export_warnings(bpy_data);
cb_finish(thread,stage)};var progress_cb=function(rate){cb_set_rate(thread,stage,rate)};m_assets.enqueue([[main_path,m_assets.AT_JSON,main_path]],asset_cb,null,progress_cb)}function prepare_thread_bpy(thread,bpy_data){if(thread.id===0)_primary_data=bpy_data;var bin_name=bpy_data["binaries"][0]["binfile"];if(bin_name)thread.binary_name=bin_name;else{m_loader.skip_stage_by_name(thread,"load_binaries");m_loader.skip_stage_by_name(thread,"prepare_bindata")}if(!data_is_primary(bpy_data))m_loader.skip_stage_by_name(thread,
"start_nla")}function show_export_warnings(bpy_data){var is_primary=data_is_primary(bpy_data);if(bpy_data["b4w_export_warnings"])for(var i=0;i<bpy_data["b4w_export_warnings"].length;i++){var warn_data=bpy_data["b4w_export_warnings"][i];if(is_primary&&warn_data["type"]=="PRIMARY"||warn_data["type"]=="ALL")m_print.export_warn(warn_data["text"])}}function show_export_errors(bpy_data){var is_primary=data_is_primary(bpy_data);if(bpy_data["b4w_export_errors"])for(var i=0;i<bpy_data["b4w_export_errors"].length;i++){var err_data=
bpy_data["b4w_export_errors"][i];if(is_primary&&err_data["type"]=="PRIMARY"||err_data["type"]=="ALL")m_print.export_error(err_data["text"])}}function load_binaries(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){var binary_path=dirname(thread.filepath)+thread.binary_name;if(!binary_path)throw"Binary data is missing";var binary_cb=function(bin_data,uri,type,path){if(!bin_data){m_loader.abort_thread(thread);return}m_print.log("%cLOAD BINARY","color: #616",path);bpy_data["bin_data"]=bin_data;check_bin_data_version(bin_data,
bpy_data);cb_finish(thread,stage)};var progress_cb=function(rate){cb_set_rate(thread,stage,rate)};m_assets.enqueue([[binary_path,m_assets.AT_ARRAYBUFFER,binary_path]],binary_cb,null,progress_cb)}function wait_for_shaders(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){if(m_shaders.check_shaders_loaded())cb_finish(thread,stage)}function check_format_version(loaded_bpy_data){var ver_loaded=m_util.str_to_version(loaded_bpy_data["b4w_format_version"]);var cmp=m_util.version_cmp(ver_loaded,cfg_def.min_format_version);
switch(cmp){case -1:if(ver_loaded[0]<cfg_def.min_format_version[0])m_util.panic("JSON version is too old relative to B4W engine: "+m_util.version_to_str(ver_loaded)+", required: "+m_util.version_to_str(cfg_def.min_format_version)+". "+"Reexport scene with the latest B4W addon to fix it.");else m_print.warn("JSON version is a bit old relative to B4W engine: "+ +m_util.version_to_str(ver_loaded)+", required: "+m_util.version_to_str(cfg_def.min_format_version)+". Some compatibility issues can occur. "+
"Reexport scene with the latest B4W addon to fix it.");break;case 1:if(ver_loaded[0]>cfg_def.min_format_version[0])m_util.panic("B4W engine version is too old relative to JSON. "+"Can't load the scene. Update your "+"engine version to fix it.");else m_print.warn("B4W engine version is a bit old relative to JSON. "+"Some compatibility issues can occur. Update "+"your engine version to fix it.");break}cfg_def.loaded_data_version=ver_loaded}function prepare_bindata(bpy_data,thread,stage,cb_param,cb_finish,
cb_set_rate){var bin_data=bpy_data["bin_data"];var bin_offsets=bpy_data["binaries"][0];var objects=bpy_data["objects"];var meshes=bpy_data["meshes"];var actions=bpy_data["actions"];var is_le=m_util.check_endians();var headers=get_header(bin_data);if(headers[0]>=MAJOR_VERSION_EMPTY&&headers[1]>MINOR_VERSION_EMPTY)var b4w_info_offset=B4W_HEADER_OFFSET;else var b4w_info_offset=0;prepare_bindata_submeshes(bin_data,bin_offsets,meshes,is_le,b4w_info_offset);prepare_bindata_psystems(bin_data,bin_offsets,
objects,is_le,b4w_info_offset);prepare_bindata_actions(bin_data,bin_offsets,actions,is_le,b4w_info_offset);cb_finish(thread,stage)}function check_bin_data_version(bin_data,bpy_data){var headers=get_header(bin_data);var ver_loaded=m_util.str_to_version(bpy_data["b4w_format_version"]);if(headers[0]!=ver_loaded[0])m_util.panic("BIN version does not match to JSON version: "+m_util.version_to_str(headers)+", required: "+m_util.version_to_str(cfg_def.min_format_version)+". Couldn't load the scene. "+"Reexport scene to fix it.");
if(headers[1]!=ver_loaded[1])m_print.warn("BIN version does not match to JSON version: "+ +m_util.version_to_str(headers)+", required: "+m_util.version_to_str(cfg_def.min_format_version)+". Some compatibility issues can occur. "+"Reexport scene to fix it.")}function get_header(bin_data){var has_data=new Uint8Array(bin_data,0,4);var major_version=(new Uint32Array(bin_data,4,1))[0];var minor_version=(new Uint32Array(bin_data,8,1))[0];for(var i=0;i<has_data.length;i++)if(B4W_INFO[i]!=String.fromCharCode(has_data[i])){major_version=
MAJOR_VERSION_EMPTY;minor_version=MINOR_VERSION_EMPTY;break}return[major_version,minor_version]}function prepare_bindata_submeshes(bin_data,bin_offsets,meshes,is_le,b4w_offset){var int_props=["indices"];var short_props=["normal","tangent"];var ushort_props=["color","group"];var float_props=["position","texcoord","texcoord2"];for(var i=0;i<meshes.length;i++){var submeshes=meshes[i]["submeshes"];for(var j=0;j<submeshes.length;j++)for(var prop_name in submeshes[j]){var length=submeshes[j][prop_name][1];
if(int_props.indexOf(prop_name)!=-1){var offset=submeshes[j][prop_name][0]*BINARY_INT_SIZE+bin_offsets["int"]+b4w_offset;submeshes[j][prop_name]=extract_bindata_uint(bin_data,offset,length,is_le)}else if(float_props.indexOf(prop_name)!=-1){var offset=submeshes[j][prop_name][0]*BINARY_FLOAT_SIZE+bin_offsets["float"]+b4w_offset;submeshes[j][prop_name]=extract_bindata_float(bin_data,offset,length,is_le)}else if(short_props.indexOf(prop_name)!=-1){var offset=submeshes[j][prop_name][0]*BINARY_SHORT_SIZE+
bin_offsets["short"]+b4w_offset;submeshes[j][prop_name]=extract_bindata_short(bin_data,offset,length)}else if(ushort_props.indexOf(prop_name)!=-1){var offset=submeshes[j][prop_name][0]*BINARY_SHORT_SIZE+bin_offsets["ushort"]+b4w_offset;submeshes[j][prop_name]=extract_bindata_ushort(bin_data,offset,length)}}}}function prepare_bindata_psystems(bin_data,bin_offsets,bpy_objects,is_le,b4w_offset){for(var i=0;i<bpy_objects.length;i++){var psystems=bpy_objects[i]["particle_systems"];for(var j=0;j<psystems.length;j++){var psys=
psystems[j];var offset=psys["transforms"][0]*BINARY_FLOAT_SIZE+bin_offsets["float"]+b4w_offset;var length=psys["transforms"][1];psys["transforms"]=extract_bindata_float(bin_data,offset,length,is_le)}}}function prepare_bindata_actions(bin_data,bin_offsets,actions,is_le,b4w_offset){for(var i=0;i<actions.length;i++){var action=actions[i];var fcurves=action["fcurves"];var frame_range=action["frame_range"];var start=frame_range[0];var end=frame_range[1];var arr_length=m_anim.get_approx_curve_length(start,
end);var bflags=null;if(arr_length<0)arr_length=0;var has_euler_rot=false;var has_quat_rot=false;for(var data_path in fcurves){has_euler_rot|=data_path.indexOf("rotation_euler")>-1;has_quat_rot|=data_path.indexOf("rotation_quaternion")>-1}var paths_to_rename=[];for(var data_path in fcurves){if(has_euler_rot&&has_quat_rot&&data_path.indexOf("rotation_euler")>-1){delete fcurves[data_path];continue}var channels=fcurves[data_path];for(var array_index in channels){var fcurve=channels[array_index];var offset=
bin_offsets["float"]+fcurve["bin_data_pos"][0]*BINARY_FLOAT_SIZE+b4w_offset;var fcurve_bin_data=extract_bindata_float(bin_data,offset,fcurve["bin_data_pos"][1],is_le);var points=new Float32Array(arr_length);if(bflags===null)bflags=new Int8Array(arr_length);m_anim.approximate_curve(fcurve,fcurve_bin_data,points,bflags,start,end);fcurve._pierced_points=points}if(data_path.indexOf("rotation_euler")>-1){m_anim.fcurve_replace_euler_by_quat(fcurves[data_path]);paths_to_rename.push(data_path)}}for(var j=
0;j<paths_to_rename.length;j++){var path_old=paths_to_rename[j];var path_new=path_old.replace("euler","quaternion");fcurves[path_new]=fcurves[path_old];delete fcurves[path_old]}action._bflags=bflags}}function extract_bindata_float(bin_data,offset,length,is_le){if(is_le)var arr=new Float32Array(bin_data,offset,length);else{var arr=new Float32Array(length);var dataview=new DataView(bin_data);for(var i=0;i<length;i++)arr[i]=dataview.getFloat32(offset+i*BINARY_FLOAT_SIZE,true)}return arr}function extract_bindata_uint(bin_data,
offset,length,is_le){if(is_le)var arr=new Uint32Array(bin_data,offset,length);else{var arr=new Uint32Array(length);var dataview=new DataView(bin_data);for(var i=0;i<length;i++)arr[i]=dataview.getUint32(offset+i*BINARY_INT_SIZE,true)}return arr}function extract_bindata_short(bin_data,offset,length){var arr=new Float32Array(length);var dataview=new DataView(bin_data);for(var i=0;i<length;i++)arr[i]=dataview.getInt16(offset+i*BINARY_SHORT_SIZE,true)/32767;return arr}function extract_bindata_ushort(bin_data,
offset,length){var arr=new Float32Array(length);var dataview=new DataView(bin_data);for(var i=0;i<length;i++)arr[i]=dataview.getUint16(offset+i*BINARY_SHORT_SIZE,true)/65535;return arr}function report_empty_submeshes(bpy_data){var already_reported={};var bpy_objects=bpy_data["objects"];for(var i=0;i<bpy_objects.length;i++){var bpy_obj=bpy_objects[i];if(bpy_obj["type"]!=="MESH")continue;if(bpy_obj["particle_systems"].length)continue;var mesh=bpy_obj["data"];var mesh_name=mesh["name"];var submeshes=
mesh["submeshes"];var materials=mesh["materials"];for(var j=0;j<submeshes.length;j++)if(submeshes[j]["base_length"]===0&&!already_reported[mesh_name]){if(materials[j])m_print.warn('material "'+materials[j]["name"]+'" is not assigned to any face (object "'+bpy_obj["name"]+'").');already_reported[mesh_name]=true}}}function report_odd_uvs(meshes){for(var i=0;i<meshes.length;i++){var mesh=meshes[i];var materials=mesh["materials"];var submeshes=mesh["submeshes"];if(!materials.length)if(mesh["uv_textures"].length)m_print.warn('mesh "'+
mesh["name"]+'" has a UV map but has no exported material.')}}function prepare_bpy_data(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){make_bpy_links(bpy_data);m_reformer.check_bpy_data(bpy_data);create_bpy_textures(bpy_data,thread.id);report_empty_submeshes(bpy_data);report_odd_uvs(bpy_data["meshes"]);create_special_materials(bpy_data);assign_default_material(bpy_data);prepare_bpy_actions(bpy_data["actions"],thread.id);prepare_bpy_lods(bpy_data);prepare_bpy_scenes(bpy_data);prepare_bpy_objects(bpy_data,
thread.id);if(DEBUG_BPYDATA)m_print.log("%cDEBUG BPYDATA:","color: #a0a",bpy_data);cb_finish(thread,stage)}function create_bpy_textures(bpy_data,data_id){var textures=bpy_data["textures"];var global_af=get_global_anisotropic_filtering(bpy_data);for(var i=0;i<textures.length;i++){if(!data_is_primary(bpy_data)&&textures[i]["b4w_source_type"]=="SCENE")textures[i]["b4w_source_id"]="";m_tex.create_texture_bpy(textures[i],global_af,bpy_data["scenes"],data_id)}}function prepare_bpy_scenes(bpy_data){var is_primary_thread=
data_is_primary(bpy_data);if(!is_primary_thread&&bpy_data["scenes"].length>1){bpy_data["scenes"]=[m_scenes.find_main_scene(bpy_data["scenes"])];m_print.warn("loading data contains multiple scenes.","Only the first one will be loaded.")}var primary_main_scene=get_primary_main_scene();if(is_primary_thread)var main_scene=primary_main_scene;else var main_scene=m_scenes.find_main_scene(bpy_data["scenes"]);m_time.set_framerate(primary_main_scene["fps"]);if(bpy_data["scenes"].length>1){var index_of_main_scene=
bpy_data["scenes"].indexOf(primary_main_scene);bpy_data["scenes"].splice(index_of_main_scene,1);bpy_data["scenes"].unshift(primary_main_scene)}for(var i=0;i<bpy_data["scenes"].length;i++){var scene=bpy_data["scenes"][i];scene._render=m_scenes.create_scene_render();scene._is_main=scene==main_scene;scene._is_primary_thread=is_primary_thread;if(cfg_phy.enabled&&scene["b4w_enable_physics"]&&(is_primary_thread||!m_phy.scene_has_physics(get_primary_main_scene())&&scene==m_scenes.find_main_scene(bpy_data)))m_phy.init_scene_physics(scene);
if(is_primary_thread){if(scene["b4w_enable_audio"])m_sfx.attach_scene_sfx(scene)}else if(scene["b4w_enable_audio"]&&!primary_main_scene._sfx)m_sfx.attach_scene_sfx(primary_main_scene)}}function prepare_bpy_objects(bpy_data,data_id){var primary_scene=get_primary_main_scene();var is_primary_thread=data_is_primary(bpy_data);for(var i=0;i<bpy_data["scenes"].length;i++){var bpy_scene=bpy_data["scenes"][i];var scene_objs=m_scenes.combine_scene_bpy_objects(bpy_scene,"ALL");if(m_nla.scene_use_nla(bpy_scene))m_reformer.assign_logic_nodes_object_params(scene_objs,
bpy_scene);for(var j=0;j<scene_objs.length;j++){var bpy_obj=scene_objs[j];if(m_obj.check_bpy_obj_scene_compatibility(bpy_obj,bpy_scene,bpy_data)){if(!bpy_obj._scenes)bpy_obj._scenes=[];bpy_obj._scenes.push(is_primary_thread?bpy_scene:primary_scene)}}prepare_hair_dupli_objects(scene_objs)}var bpy_objects=get_bpy_objects_cached(bpy_data,data_id);for(var i=0;i<bpy_objects.length;i++){var bpy_obj=bpy_objects[i];if(!is_primary_thread&&bpy_obj["parent"]&&SECONDARY_LOAD_TYPES_DISABLED.indexOf(bpy_obj["parent"]["type"])>
-1)bpy_obj["parent"]="";if(bpy_obj["type"]=="MESH"){var mesh=m_reformer.apply_mesh_modifiers(bpy_obj);if(mesh){bpy_data["meshes"].push(mesh);bpy_obj["data"]=mesh}}}}function prepare_hair_dupli_objects(bpy_objects){for(var i=0;i<bpy_objects.length;i++){var bpy_obj=bpy_objects[i];if(bpy_obj._scenes){var psystems=bpy_obj["particle_systems"];for(var j=0;j<psystems.length;j++){var pset=psystems[j]["settings"];if(pset["type"]!="HAIR")continue;if(pset["render_type"]=="OBJECT"){var dg_obj=pset["dupli_object"];
if(!dg_obj._scenes)dg_obj._scenes=bpy_obj._scenes.slice()}else if(pset["render_type"]=="GROUP"){var dg=pset["dupli_group"];for(var k=0;k<dg["objects"].length;k++){var dg_obj=dg["objects"][k];if(!dg_obj._scenes)dg_obj._scenes=bpy_obj._scenes.slice()}}}}}}function process_objects(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){var bpy_objects=get_bpy_objects_cached(bpy_data,thread.id);create_objects_from_bpy(bpy_data,bpy_objects,thread.id);var objects=m_obj.get_all_objects(thread.id);for(var i=
0;i<objects.length;i++){var obj=objects[i];var bpy_obj=obj.temp_bpy_obj;m_nla.update_object(bpy_obj,obj)}if(data_is_primary(bpy_data))calc_light_index(bpy_data,thread.id);for(var i=0;i<objects.length;i++){var obj=objects[i];if(!obj.is_hair_dupli){m_obj.update_object_relations(obj);m_trans.update_transform(obj)}}link_skinned_objs(objects);calc_max_bones(objects);prepare_lod_objects(objects);prepare_vehicles(objects);prepare_floaters(objects);cb_finish(thread,stage)}function create_objects_from_bpy(bpy_data,
bpy_objects,data_id){for(var i=0;i<bpy_objects.length;i++){var bpy_obj=bpy_objects[i];if(bpy_obj._scenes){var obj=m_obj_util.create_object(bpy_obj["name"],bpy_obj["type"],bpy_obj["origin_name"]);for(var j=0;j<bpy_obj._scenes.length;j++)m_obj_util.append_scene_data(obj,bpy_obj._scenes[j]);obj.temp_bpy_obj=bpy_obj;bpy_obj._object=obj;m_obj.update_object(bpy_obj,obj);obj.render.data_id=data_id;obj.is_hair_dupli=bpy_obj._is_hair_dupli||false}}}function calc_light_index(bpy_data,data_id){for(var i=0;i<
bpy_data["scenes"].length;i++){var scene=bpy_data["scenes"][i];var lamps_counter=0;var scene_objs=m_obj.get_scene_objs(scene,"LAMP",data_id);for(var j=0;j<scene_objs.length;j++){var obj=scene_objs[j];var sc_data=m_obj_util.get_scene_data(obj,scene);sc_data.light_index=lamps_counter++}}}function process_scenes(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){create_scene_props(bpy_data);var primary_scene=get_primary_main_scene();var is_primary_thread=data_is_primary(bpy_data);for(var i=0;i<bpy_data["scenes"].length;i++){var scene_dst=
is_primary_thread?bpy_data["scenes"][i]:primary_scene;var scene_objs=m_obj.get_scene_objs(scene_dst,"ALL",thread.id);var lamps=is_primary_thread?m_obj.get_scene_objs(scene_dst,"LAMP",thread.id):m_obj.get_scene_objs(scene_dst,"LAMP",0);var mesh_objs=m_obj.get_scene_objs(scene_dst,"MESH",thread.id);var empty_objs=m_obj.get_scene_objs(scene_dst,"EMPTY",thread.id);if(is_primary_thread){m_scenes.append_scene(scene_dst,scene_objs,lamps,mesh_objs,empty_objs);if(scene_dst._render.video_textures.length)thread.has_video_textures=
true}m_scenes.append_scene_vtex(scene_dst,bpy_data["textures"],thread.id);for(var j=0;j<empty_objs.length;j++)m_obj.update_force(empty_objs[j]);var metaobjects=[];m_scenes.set_active(scene_dst);m_batch.generate_main_batches(scene_dst,mesh_objs,lamps,metaobjects);var scene_graph=m_scenes.get_graph(scene_dst);if(is_primary_thread){var sky=scene_dst._render.sky_params;if(sky.render_sky||sky.procedural_skydome){var meta_obj=m_batch.generate_sky_meta_obj(scene_dst,sky);metaobjects.push(meta_obj)}m_scenes.generate_auxiliary_batches(scene_graph)}for(var j=
0;j<mesh_objs.length;j++)m_batch.create_forked_batches(mesh_objs[j],scene_graph,scene_dst);for(var j=0;j<metaobjects.length;j++){m_batch.create_forked_batches(metaobjects[j],scene_graph,scene_dst);m_obj.objects_storage_add(metaobjects[j])}var scene_objs=m_obj.get_scene_objs(scene_dst,"ALL",thread.id);m_scenes.assign_scene_data_subs(scene_dst,scene_objs,lamps)}drop_bpy_data(bpy_data);setup_dds_loading(bpy_data);cb_finish(thread,stage)}function create_scene_props(bpy_data){for(var i=0;i<bpy_data["scenes"].length;i++){var bpy_scene=
bpy_data["scenes"][i];bpy_scene._camera=bpy_scene["camera"]._object}}function drop_bpy_data(bpy_data){for(var i=0;i<bpy_data["scenes"].length;i++){var bpy_scene=bpy_data["scenes"][i];delete bpy_scene["camera"]}}function link_skinned_objs(objects){for(var i=0;i<objects.length;i++){var skinned_obj=objects[i];if(skinned_obj.type!="MESH")continue;var armobj=skinned_obj.armobj;if(armobj){var render=armobj.render;var skinned_render=skinned_obj.render;var bone_skinning_info=skinned_render.bone_skinning_info;
var mesh_bone_map=[];for(var bone_name in bone_skinning_info){var bi=bone_skinning_info[bone_name];var bone_index=bi.bone_index;var deform_bone_index=bi.deform_bone_index;var sk_ind=4*deform_bone_index;var ind=4*bone_index;mesh_bone_map.push(sk_ind,ind)}render.mesh_to_arm_bone_maps.push(mesh_bone_map);render.skinned_renders.push(skinned_obj.render)}}}function data_is_primary(bpy_data){return bpy_data==_primary_data}function get_primary_main_scene(){return m_scenes.find_main_scene(_primary_data["scenes"])}
function setup_dds_loading(bpy_data){var materials=bpy_data["materials"];if(!cfg_ldr.dds_available||!cfg_def.use_dds){unset_images_dds(bpy_data["images"]);return}for(var i=0;i<materials.length;i++){var material=materials[i];var texture_slots=material["texture_slots"];for(var j=0;j<texture_slots.length;j++){var texture_slot=texture_slots[j];var texture=texture_slot["texture"];if(texture["type"]!="IMAGE"&&texture["type"]!="ENVIRONMENT_MAP")continue;var image=texture["image"];if(image._is_dds);else if(image["filepath"].indexOf(".dds")>
-1)image._is_dds=true;else{image._is_dds=!texture["b4w_disable_compression"]&&!texture_slot["use_map_normal"]&&texture["type"]!="ENVIRONMENT_MAP"&&!texture["b4w_shore_dist_map"]&&image["source"]!="MOVIE";if(image._is_dds)image["filepath"]+=".dds"}}var node_tree=material["node_tree"];if(node_tree){var nodes=node_tree["nodes"];for(var j=0;j<nodes.length;j++){var node=nodes[j];if(node["type"]=="TEXTURE"){var tex=node["texture"];if(tex){var image=tex["image"];if(image)if(image._is_dds);else{image._is_dds=
tex._render.allow_node_dds&&!tex["b4w_disable_compression"]&&image["source"]!="MOVIE";if(image._is_dds)image["filepath"]+=".dds"}}}}}}}function unset_images_dds(images){for(var i=0;i<images.length;i++){var image=images[i];var use_dds=Boolean(image["source"]=="FILE"&&image["filepath"].indexOf(".dds")>-1);image._is_dds=use_dds}}function get_global_anisotropic_filtering(bpy_data){if(data_is_primary(bpy_data))return bpy_data["scenes"][0]["b4w_anisotropic_filtering"];else return get_primary_main_scene()["b4w_anisotropic_filtering"]}
function duplicate_objects(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){var groups=bpy_data["groups"];var bpy_objects=bpy_data["objects"];var grp_ids_old={};var obj_ids_old={};var grp_ids={};var obj_ids={};for(var i=0;i<groups.length;i++){var group=groups[i];grp_ids_old[group["uuid"]]=group;grp_ids[group["uuid"]]=group}for(var i=0;i<bpy_objects.length;i++){var bpy_obj=bpy_objects[i];obj_ids_old[bpy_obj["uuid"]]=bpy_obj;obj_ids[bpy_obj["uuid"]]=bpy_obj}var scenes=bpy_data["scenes"];for(var i=
0;i<scenes.length;i++){var scene=scenes[i];duplicate_objects_iter(scene["objects"],null,obj_ids,grp_ids)}for(var id in grp_ids)if(!(id in grp_ids_old))groups.push(grp_ids[id]);for(var id in obj_ids)if(!(id in obj_ids_old))bpy_objects.push(obj_ids[id]);cb_finish(thread,stage)}function duplicate_objects_iter(obj_links,origin_obj,obj_ids,grp_ids){var proxy_source_ids=[];for(var i=0;i<obj_links.length;i++){var obj_link=obj_links[i];var bpy_obj=obj_ids[obj_link["uuid"]];var proxy_link=bpy_obj["proxy"];
if(proxy_link){if(origin_obj&&proxy_source_ids.indexOf(proxy_link["uuid"])==-1)proxy_source_ids.push(proxy_link["uuid"]);var proxy=obj_ids[proxy_link["uuid"]];var consts=proxy["constraints"];for(var j=0;j<consts.length;j++){var new_cons=m_util.clone_object_json(consts[j]);new_cons.name=new_cons.name+"_CLONE";bpy_obj["constraints"].push(new_cons)}if(!("b4w_proxy_inherit_anim"in bpy_obj)||bpy_obj["b4w_proxy_inherit_anim"]){var anim_data=bpy_obj["animation_data"];if(anim_data)proxy["animation_data"]=
m_util.clone_object_json(bpy_obj["animation_data"]);proxy["b4w_use_default_animation"]=bpy_obj["b4w_use_default_animation"];proxy["b4w_auto_skel_anim"]=bpy_obj["b4w_auto_skel_anim"];proxy["b4w_anim_behavior"]=bpy_obj["b4w_anim_behavior"];proxy["b4w_cyclic_animation"]=bpy_obj["b4w_cyclic_animation"]}}}for(var i=0;i<proxy_source_ids.length;i++){var proxy_src_id=proxy_source_ids[i];var obj_index=m_util.get_index_for_key_value(obj_links,"uuid",proxy_src_id);if(obj_index>-1)obj_links.splice(obj_index,
1)}var obj_id_overrides={};if(origin_obj)for(var i=0;i<obj_links.length;i++){var obj_link=obj_links[i];var bpy_obj=obj_ids[obj_link["uuid"]];var bpy_obj_new=m_util.clone_object_json(bpy_obj);var name="origin_name"in bpy_obj?bpy_obj["origin_name"]:bpy_obj["name"];bpy_obj_new["name"]=m_obj_util.gen_dupli_name(origin_obj["name"],name);bpy_obj_new["origin_name"]=name;bpy_obj_new["dg_parent"]={"uuid":origin_obj["uuid"]};assign_bpy_obj_id(bpy_obj_new);obj_ids[bpy_obj_new["uuid"]]=bpy_obj_new;obj_id_overrides[obj_link["uuid"]]=
bpy_obj_new["uuid"];obj_link["uuid"]=bpy_obj_new["uuid"]}for(var i=0;i<obj_links.length;i++){var obj_link=obj_links[i];var bpy_obj=obj_ids[obj_link["uuid"]];if(bpy_obj["dupli_group"]){var grp_link=bpy_obj["dupli_group"];var grp=grp_ids[grp_link["uuid"]];var grp_new=m_util.clone_object_json(grp);grp_new["name"]=m_util.unique_name(grp["name"]+"_CLONE");assign_grp_id(grp_new);grp_ids[grp_new["uuid"]]=grp_new;grp_link["uuid"]=grp_new["uuid"];var dg_obj_links=grp_new["objects"];duplicate_objects_iter(dg_obj_links,
bpy_obj,obj_ids,grp_ids)}}if(origin_obj)for(var i=0;i<obj_links.length;i++){var obj_link=obj_links[i];var bpy_obj=obj_ids[obj_link["uuid"]];if(bpy_obj["parent"]&&bpy_obj["parent"]["uuid"]in obj_id_overrides)bpy_obj["parent"]["uuid"]=obj_id_overrides[bpy_obj["parent"]["uuid"]];else if(bpy_obj["parent"]){m_print.warn("Object's \""+bpy_obj.name+'" parent is not in dupli group. Disabling parenting.');bpy_obj["parent"]=null}var consts=bpy_obj["constraints"];for(var j=0;j<consts.length;j++){var cons=consts[j];
if(cons["target"]&&cons["target"]["uuid"]in obj_id_overrides)cons["target"]["uuid"]=obj_id_overrides[cons["target"]["uuid"]]}var pose=bpy_obj["pose"];if(pose){var pose_bones=pose["bones"];for(var j=0;j<pose_bones.length;j++){var pose_bone=pose_bones[j];var constraints=pose_bone["constraints"];if(constraints)for(var k=0;k<constraints.length;k++){var cons=constraints[k];if(cons["target"]&&cons["target"]["uuid"]in obj_id_overrides)cons["target"]["uuid"]=obj_id_overrides[cons["target"]["uuid"]]}}}var mods=
bpy_obj["modifiers"];for(var j=0;j<mods.length;j++){var mod=mods[j];if(mod["object"]&&mod["object"]["uuid"]in obj_id_overrides)mod["object"]["uuid"]=obj_id_overrides[mod["object"]["uuid"]]}var lods=bpy_obj["lod_levels"];if(lods&&lods.length)for(var j=0;j<lods.length;j++){var lod=lods[j];if(lod["object"]&&lod["object"]["uuid"]in obj_id_overrides)lod["object"]["uuid"]=obj_id_overrides[lod["object"]["uuid"]]}}for(var key in obj_id_overrides)_dupli_obj_id_overrides[key]=obj_id_overrides[key]}function assign_bpy_obj_id(bpy_obj){bpy_obj["uuid"]=
m_md5.hexdigest("Object"+bpy_obj["name"])}function assign_grp_id(grp){grp["uuid"]=m_md5.hexdigest("Group"+grp["name"])}function make_bpy_links(bpy_data){var cameras=bpy_data["cameras"];var groups=bpy_data["groups"];var materials=bpy_data["materials"];var meshes=bpy_data["meshes"];var node_groups=bpy_data["node_groups"];var objects=bpy_data["objects"];var particles=bpy_data["particles"];var scenes=bpy_data["scenes"];var speakers=bpy_data["speakers"];var textures=bpy_data["textures"];var worlds=bpy_data["worlds"];
if(!node_groups){m_print.warn('"node_groups" datablock undefined. reexport main scene.');node_groups=bpy_data["node_groups"]=[]}var storage=gen_datablocks_storage(bpy_data);for(var i=0;i<scenes.length;i++){var scene=scenes[i];var scene_objects=scene["objects"];for(var j=0;j<scene_objects.length;j++)make_link_uuid(scene_objects,j,storage);if(scene["camera"])make_link_uuid(scene,"camera",storage);if(scene["world"])make_link_uuid(scene,"world",storage)}for(var i=0;i<groups.length;i++){var group=groups[i];
var group_objects=group["objects"];for(var j=0;j<group_objects.length;j++)make_link_uuid(group_objects,j,storage)}for(var i=0;i<objects.length;i++){var bpy_obj=objects[i];if(bpy_obj["dupli_group"])make_link_uuid(bpy_obj,"dupli_group",storage);if(bpy_obj["parent"])make_link_uuid(bpy_obj,"parent",storage);if(bpy_obj["dg_parent"])make_link_uuid(bpy_obj,"dg_parent",storage);if(bpy_obj["animation_data"]){var adata=bpy_obj["animation_data"];if(adata["action"])make_link_uuid(adata,"action",storage);if(adata["nla_tracks"])for(var j=
0;j<adata["nla_tracks"].length;j++){var track=adata["nla_tracks"][j];for(var k=0;k<track["strips"].length;k++)if(track["strips"][k]["action"])make_link_uuid(track["strips"][k],"action",storage)}}switch(bpy_obj["type"]){case "MESH":if(!bpy_obj["data"])throw"mesh not found for object "+bpy_obj["name"];make_link_uuid(bpy_obj,"data",storage);var found_armat_mod=false;var modifiers=bpy_obj["modifiers"];for(var j=0;j<modifiers.length;j++){var modifier=modifiers[j];if(modifier["type"]=="ARMATURE"){if(found_armat_mod)m_print.warn('Object "'+
bpy_obj["name"]+'" has more '+"than one armature modifiers. Only the first one will be used.");found_armat_mod=true;make_link_uuid(modifier,"object",storage)}else if(modifier["type"]=="CURVE")make_link_uuid(modifier,"object",storage)}var psystems=bpy_obj["particle_systems"];if(psystems)for(var j=0;j<psystems.length;j++){var psys=psystems[j];make_link_uuid(psys,"settings",storage)}break;case "ARMATURE":make_link_uuid(bpy_obj,"data",storage);var pose=bpy_obj["pose"];var pose_bones=pose["bones"];var armature=
bpy_obj["data"];var armature_bones=armature["bones"];for(var j=0;j<pose_bones.length;j++){var pose_bone=pose_bones[j];var bone_index=pose_bone["bone"];var armature_bone=armature_bones[bone_index];pose_bone["bone"]=armature_bone;var constraints=pose_bone["constraints"];if(constraints)for(var k=0;k<constraints.length;k++){var cons=constraints[k];if(cons["target"])make_link_uuid(cons,"target",storage)}var parent_recursive=pose_bone["parent_recursive"];for(var k=0;k<parent_recursive.length;k++){var parent_index=
parent_recursive[k];parent_recursive[k]=pose_bones[parent_index]}}break;case "LAMP":case "CAMERA":case "SPEAKER":case "CURVE":make_link_uuid(bpy_obj,"data",storage);break;case "EMPTY":default:break}var constraints=bpy_obj["constraints"];if(constraints)for(var j=0;j<constraints.length;j++){var cons=constraints[j];if(cons["target"])make_link_uuid(cons,"target",storage)}var lods=bpy_obj["lod_levels"];if(lods)for(var j=0;j<lods.length;j++){var lod=lods[j];if(lod["object"])make_link_uuid(lod,"object",
storage)}}for(var i=0;i<meshes.length;i++){var mesh=meshes[i];var mesh_materials=mesh["materials"];for(var j=0;j<mesh_materials.length;j++)make_link_uuid(mesh_materials,j,storage)}for(var i=0;i<materials.length;i++){var material=materials[i];var texture_slots=material["texture_slots"];for(var j=0;j<texture_slots.length;j++)make_link_uuid(texture_slots[j],"texture",storage);var node_tree=material["node_tree"];if(!node_tree)continue;process_node_tree(node_tree,storage)}for(var i=0;i<node_groups.length;i++){var node_group=
node_groups[i];var node_tree=node_group["node_tree"];if(!node_tree)continue;process_node_tree(node_tree,storage)}for(var i=0;i<textures.length;i++){var texture=textures[i];var tex_type=texture["type"];if(tex_type=="IMAGE"||tex_type=="ENVIRONMENT_MAP")make_link_uuid(texture,"image",storage)}for(var i=0;i<cameras.length;i++){var camera=cameras[i];if(camera["dof_object"])make_link_uuid(camera,"dof_object",storage)}for(var i=0;i<speakers.length;i++){var speaker=speakers[i];if(speaker["sound"])make_link_uuid(speaker,
"sound",storage);if(speaker["animation_data"]){var adata=speaker["animation_data"];if(adata["action"])make_link_uuid(adata,"action",storage);if(adata["nla_tracks"])for(var j=0;j<adata["nla_tracks"].length;j++){var track=adata["nla_tracks"][j];for(var k=0;k<track["strips"].length;k++)if(track["strips"][k]["action"])make_link_uuid(track["strips"][k],"action",storage)}}}for(var i=0;i<particles.length;i++){var part=particles[i];var texture_slots=part["texture_slots"];for(var j=0;j<texture_slots.length;j++)make_link_uuid(texture_slots[j],
"texture",storage);if(part["dupli_group"])make_link_uuid(part,"dupli_group",storage);if(part["dupli_object"])make_link_uuid(part,"dupli_object",storage)}for(var i=0;i<worlds.length;i++){var world=worlds[i];var texture_slots=world["texture_slots"];if(texture_slots)for(var j=0;j<texture_slots.length;j++)make_link_uuid(texture_slots[j],"texture",storage)}}function process_node_tree(node_tree,storage){var nodes=node_tree["nodes"];for(var j=0;j<nodes.length;j++){var node=nodes[j];if(node["type"]=="TEXTURE"&&
node["texture"])make_link_uuid(node,"texture",storage);if(node["type"]=="LAMP"&&node["lamp"]){if(node["lamp"]["uuid"]in _dupli_obj_id_overrides)node["lamp"]["uuid"]=_dupli_obj_id_overrides[node["lamp"]["uuid"]];if(!storage[node["lamp"]["uuid"]])node["lamp"]=null}if(node["type"]=="GROUP"&&node["node_group"])make_link_uuid(node,"node_group",storage)}var links=node_tree["links"];for(var j=0;j<links.length;j++){var link=links[j];make_link_name(link,"from_node",nodes);make_link_name(link,"to_node",nodes);
make_link_ident(link,"from_socket",link["from_node"]["outputs"]);make_link_ident(link,"to_socket",link["to_node"]["inputs"])}var adata=node_tree["animation_data"];if(adata){if(adata["action"])make_link_uuid(adata,"action",storage);if(adata["nla_tracks"])for(var j=0;j<adata["nla_tracks"].length;j++){var track=adata["nla_tracks"][j];for(var k=0;k<track["strips"].length;k++)if(track["strips"][k]["action"])make_link_uuid(track["strips"][k],"action",storage)}}}function gen_datablocks_storage(bpy_data){var DB_NAMES=
["actions","armatures","cameras","curves","groups","images","lamps","materials","meshes","node_groups","objects","particles","scenes","sounds","speakers","textures","worlds"];var storage={};for(var i=0;i<DB_NAMES.length;i++){var db_arr=bpy_data[DB_NAMES[i]];for(var j=0;j<db_arr.length;j++){var db=db_arr[j];storage[db["uuid"]]=db}}return storage}function make_link_uuid(storage,prop,uuid_storage){var entity_new=uuid_storage[storage[prop]["uuid"]];if(!entity_new)m_print.error("Dangling link found:",
prop,storage);storage[prop]=entity_new}function make_link_name(storage,property,search_here){var entity_old=storage[property];var entity_new=m_util.keysearch("name",entity_old["name"],search_here);storage[property]=entity_new}function make_link_ident(storage,property,search_here){var entity_old=storage[property];var entity_new=m_util.keysearch("identifier",entity_old["identifier"],search_here);storage[property]=entity_new}function copy_link(from,to){for(var prop in from)if(!(prop in to))to[prop]=
from[prop]}function load_textures(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){if(cfg_def.do_not_load_resources)return;var dir_path=dirname(thread.filepath);var images=bpy_data["images"];var img_by_uri={};var image_assets=[];for(var i=0;i<images.length;i++){var image=images[i];var uuid=image["uuid"];if(image["source"]==="FILE"||image["source"]==="MOVIE"){var tex_users=find_image_users(image,bpy_data["textures"]);if(!tex_users.length){m_print.warn("image ",image["name"]," has no users.");
continue}if(tex_users[0]["b4w_shore_dist_map"])continue;var image_path=m_util.normpath_preserve_protocol(dir_path+image["filepath"]);if(image["source"]==="FILE"){if(image._is_dds)var asset_type=m_assets.AT_ARRAYBUFFER;else var asset_type=m_assets.AT_IMAGE_ELEMENT;if(cfg_ldr.min50_available&&cfg_def.use_min50){var head_ext=m_assets.split_extension(image_path);if(head_ext[1]=="dds"){var head_ext_wo_dds=m_assets.split_extension(head_ext[0]);image_path=head_ext_wo_dds[0]+".min50."+head_ext_wo_dds[1]+
".dds"}else image_path=head_ext[0]+".min50."+head_ext[1]}}else if(image["source"]==="MOVIE")if(!cfg_def.seq_video_fallback){var head_ext=m_assets.split_extension(image_path);var ext=m_sfx.detect_video_container(head_ext[1]);if(ext!=head_ext[1])image_path=head_ext[0]+".altconv."+ext;else image_path=head_ext[0]+"."+ext;var asset_type=m_assets.AT_VIDEO_ELEMENT}else{var head_ext=m_assets.split_extension(image_path);image_path=head_ext[0]+".altconv.seq";var asset_type=m_assets.AT_SEQ_VIDEO_ELEMENT}image_assets.push([uuid,
asset_type,image_path]);img_by_uri[uuid]=image}}if(image_assets.length){cb_param.image_counter=0;var asset_cb=function(image_data,uri,type,path){if(image_data){var show_path_warning=true;if(type==m_assets.AT_VIDEO_ELEMENT||type==m_assets.AT_SEQ_VIDEO_ELEMENT)print_video_info(image_data,path,show_path_warning,type);else print_image_info(image_data,path,show_path_warning);var image=img_by_uri[uri];var tex_users=find_image_users(image,bpy_data["textures"]);for(var i=0;i<tex_users.length;i++){var tex_user=
tex_users[i];var filepath=tex_user["image"]["filepath"];if(type==m_assets.AT_SEQ_VIDEO_ELEMENT){tex_user._render.seq_fps=image_data.fps;m_tex.update_texture(tex_user._render,image_data.images,image._is_dds,filepath,thread.id)}else m_tex.update_texture(tex_user._render,image_data,image._is_dds,filepath,thread.id)}}var rate=++cb_param.image_counter/image_assets.length;cb_set_rate(thread,stage,rate)};var pack_cb=function(){m_print.log("%cLOADED ALL IMAGES","color: #0a0");cb_finish(thread,stage)};m_assets.enqueue(image_assets,
asset_cb,pack_cb)}else cb_finish(thread,stage)}function update_scenes_nla(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){var scenes=m_scenes.get_rendered_scenes();for(var i=0;i<scenes.length;i++){var scene=scenes[i];if(m_nla.scene_use_nla(scene))m_nla.update_scene(scene,scene["b4w_nla_cyclic"],thread.id)}cb_finish(thread,stage)}function find_image_users(image,textures){var tex_image_users=[];for(var i=0;i<textures.length;i++){var tex=textures[i];if(tex["image"]===image)tex_image_users.push(tex)}return tex_image_users}
function load_speakers(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){if(cfg_def.do_not_load_resources)return;var dir_path=dirname(thread.filepath);var sound_assets=[];var spks_by_uuid={};var objects=m_obj.get_all_objects(thread.id);for(var i=0;i<objects.length;i++){var obj=objects[i];var bpy_obj=obj.temp_bpy_obj;if(is_loaded_spk(obj)){var sound=bpy_obj["data"]["sound"];var uuid=sound["uuid"];if(m_sfx.get_spk_behavior(obj)=="BACKGROUND_MUSIC"){uuid=m_util.gen_uuid();thread.has_background_music=
true}else if(m_sfx.get_spk_behavior(obj)!="NONE"&&cfg_def.init_wa_context_hack)thread.init_wa_context=true;if(!(uuid in spks_by_uuid)){spks_by_uuid[uuid]=[];var sound_path=m_util.normpath_preserve_protocol(dir_path+sound["filepath"]);switch(m_sfx.source_type(obj)){case m_sfx.AST_ARRAY_BUFFER:var asset_type=m_assets.AT_AUDIOBUFFER;break;case m_sfx.AST_HTML_ELEMENT:var asset_type=m_assets.AT_AUDIO_ELEMENT;break}var head_ext=m_assets.split_extension(sound_path);var ext=m_sfx.detect_audio_container(head_ext[1]);
if(ext!=head_ext[1])sound_path=head_ext[0]+".altconv."+ext;else sound_path=head_ext[0]+"."+ext;sound_assets.push([uuid,asset_type,sound_path])}spks_by_uuid[uuid].push(obj)}}if(sound_assets.length){var asset_cb=function(sound_data,uuid,type,path){if(sound_data){m_print.log("%cLOAD SOUND","color: #0aa",path);if(path.indexOf(_debug_resources_root)==-1)m_print.warn("sound",path,"is not from app root.");var spk_objs=spks_by_uuid[uuid];for(var i=0;i<spk_objs.length;i++)m_sfx.update_spkobj(spk_objs[i],sound_data)}var rate=
++cb_param.sound_counter/sound_assets.length;cb_set_rate(thread,stage,rate)};var pack_cb=function(){m_print.log("%cLOADED ALL SOUNDS","color: #0aa");cb_finish(thread,stage)};m_assets.enqueue(sound_assets,asset_cb,pack_cb)}else cb_finish(thread,stage)}function is_loaded_spk(obj){return m_obj_util.is_speaker(obj)&&m_sfx.source_type(obj)!=m_sfx.AST_NONE}function speakers_play(scene,data_id,force_init){var spk_objs=m_obj.get_scene_objs(scene,"SPEAKER",data_id);for(var i=0;i<spk_objs.length;i++){var sobj=
spk_objs[i];if(!m_obj_util.is_speaker(sobj))continue;if(m_sfx.is_cyclic(sobj)||force_init)m_sfx.play_def(sobj)}}function video_play(scene){var textures=scene._render.video_textures;for(var i=0;i<textures.length;i++){var vtex=textures[i]._render;if(scene["b4w_use_nla"]&&textures[i]["b4w_nla_video"]||!textures[i]["use_auto_refresh"])continue;m_tex.reset_video(vtex.name,vtex.vtex_data_id);m_tex.play_video(vtex.name,vtex.vtex_data_id)}}function start_nla(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){m_nla.start();
m_print.log("%cSTART NLA","color: #0a0");cb_finish(thread,stage)}function create_special_materials(bpy_data){var materials=bpy_data["materials"];var default_material=m_reformer.create_material("DEFAULT");materials.push(default_material)}function assign_default_material(bpy_data){var meshes=bpy_data["meshes"];var def_mat=m_util.keysearch("name","DEFAULT",bpy_data["materials"]);for(var i=0;i<meshes.length;i++){var mesh=meshes[i];if(mesh["materials"].length==0)mesh["materials"].push(def_mat)}}function prepare_bpy_actions(actions,
data_id){for(var i=0;i<actions.length;i++){var action=actions[i];action._data_id=data_id;m_anim.append_action(action)}}function prepare_bpy_lods(bpy_data){var scenes=bpy_data["scenes"];for(var i=0;i<scenes.length;i++){var scene=scenes[i];var added_objs=[];var removed_objs=[];var scene_objs=scenes[i]["objects"];for(var j=0;j<scene_objs.length;j++){var bpy_obj=scene_objs[j];prepare_bpy_obj_lods(scene_objs,bpy_obj,added_objs,removed_objs);var dupli_group=bpy_obj["dupli_group"];if(dupli_group){var dg_objects=
dupli_group["objects"];for(var k=0;k<dg_objects.length;k++){var dg_obj=dg_objects[k];prepare_bpy_obj_lods(dg_objects,dg_obj,added_objs,removed_objs)}}}for(var j=0;j<removed_objs.length;j++)remove_bpy_object(removed_objs[j],[scene]);for(var j=0;j<added_objs.length;j++)m_util.append_unique(added_objs[j][0],added_objs[j][1])}}function prepare_bpy_obj_lods(container,bpy_obj,added_objs,removed_objs){if(!(bpy_obj["lod_levels"]&&bpy_obj["lod_levels"].length))return;var lods_num=bpy_obj["lod_levels"].length;
for(var i=0;i<lods_num;i++){var lod=bpy_obj["lod_levels"][i];var lod_obj=lod["object"];if(!lod_obj)continue;var lod_obj_new=m_util.clone_object_nr(lod_obj);lod_obj_new["name"]=bpy_obj["name"]+"_LOD_"+String(i+1);assign_bpy_obj_id(lod_obj_new);lod_obj_new["lod_levels"]=[];added_objs.push([container,lod_obj_new]);removed_objs.push(lod_obj);lod["object"]=lod_obj_new}}function calc_max_bones(objects){var upper_max_bones=-1;var blending_max_bones=-1;var gl_max_bones=m_anim.get_max_bones();for(var i=0;i<
objects.length;i++){var obj=objects[i];var render=obj.render;if(!(m_obj_util.is_mesh(obj)&&render.is_skinning))continue;var max_bones=render.max_bones;if(max_bones>upper_max_bones)upper_max_bones=max_bones;if(gl_max_bones>=max_bones&&max_bones>blending_max_bones)blending_max_bones=max_bones}for(var i=0;i<objects.length;i++){var obj=objects[i];var render=obj.render;if(!(m_obj_util.is_mesh(obj)&&render.is_skinning))continue;render.frames_blending=true;if(upper_max_bones<gl_max_bones)render.max_bones=
upper_max_bones;else if(render.max_bones<=gl_max_bones)render.max_bones=blending_max_bones;else{m_print.warn('too many bones for "'+obj.name+'" / '+render.max_bones+" bones (max "+gl_max_bones+" with blending, "+2*gl_max_bones+" without blending)."+" Blending between frames will be disabled.");render.max_bones=upper_max_bones;render.frames_blending=false}render.frames_blending=render.frames_blending&&!cfg_anim.frames_blending_hack}}function prepare_lod_objects(objects){for(var i=0;i<objects.length;i++){var obj=
objects[i];var bpy_obj=obj.temp_bpy_obj;if(!m_obj_util.is_mesh(obj))continue;var lods_num=bpy_obj["lod_levels"].length;if(!lods_num)continue;var prev_lod_obj=obj;for(var j=0;j<lods_num;j++){var bpy_lod_obj=bpy_obj["lod_levels"][j]["object"];if(bpy_lod_obj){var lod_obj=bpy_lod_obj._object;lod_obj.render.lod_transition_ratio=obj.render.lod_transition_ratio;prev_lod_obj.render.lod_dist_max=bpy_obj["lod_levels"][j]["distance"];lod_obj.render.lod_dist_min=bpy_obj["lod_levels"][j]["distance"];if(bpy_obj["lod_levels"][j+
1])lod_obj.render.lod_dist_max=bpy_obj["lod_levels"][j+1]["distance"];else{lod_obj.render.last_lod=true;lod_obj.render.lod_dist_max=1E4;break}prev_lod_obj.render.last_lod=false;prev_lod_obj=lod_obj}else{prev_lod_obj.render.last_lod=true;prev_lod_obj.render.lod_dist_max=bpy_obj["lod_levels"][j]["distance"];break}}if(DEBUG_LOD_DIST_NOT_SET&&bpy_obj["lod_levels"][lods_num-1]["distance"]===1E4)m_print.warn('object "'+obj.name+'" has default LOD distance.')}}function prepare_vehicles(objects){for(var i=
0;i<objects.length;i++){var obj_i=objects[i];if(!obj_i.is_vehicle)continue;var vh_set_i=obj_i.vehicle_settings;if(vh_set_i.part=="CHASSIS"){obj_i.vehicle={};obj_i.vehicle.force_max=vh_set_i.force_max;obj_i.vehicle.brake_max=vh_set_i.brake_max;obj_i.vehicle.suspension_compression=vh_set_i.suspension_compression;obj_i.vehicle.suspension_stiffness=vh_set_i.suspension_stiffness;obj_i.vehicle.suspension_damping=vh_set_i.suspension_damping;obj_i.vehicle.wheel_friction=vh_set_i.wheel_friction;obj_i.vehicle.roll_influence=
vh_set_i.roll_influence;obj_i.vehicle.max_suspension_travel_cm=vh_set_i.max_suspension_travel_cm;obj_i.vehicle.engine_force=0;obj_i.vehicle.brake_force=1;obj_i.vehicle.steering=0;obj_i.vehicle.speed=0;obj_i.vehicle.props=[];obj_i.vehicle.prop_offsets=[];obj_i.vehicle.steering_wheel=null;var dg_parent=m_obj_util.get_dg_parent(obj_i);if(dg_parent)var car_objects=m_obj_util.get_dg_objects(dg_parent,objects);else var car_objects=objects;for(var j=0;j<car_objects.length;j++){var obj_j=car_objects[j];if(!obj_j.is_vehicle)continue;
var vh_set_j=obj_j.vehicle_settings;if(m_phy.is_car_wheel(obj_j)&&vh_set_i.name==vh_set_j.name){var w_index=m_phy.wheel_index(obj_j.vehicle_settings.part);obj_i.vehicle.props[w_index]=obj_j;obj_i.vehicle.prop_offsets[w_index]=new Float32Array(8)}else if(m_phy.is_vehicle_steering_wheel(obj_j)&&vh_set_i.name==vh_set_j.name){obj_i.vehicle.steering_wheel=obj_j;obj_i.vehicle.steering_max=vh_set_j.steering_max;obj_i.vehicle.steering_ratio=vh_set_j.steering_ratio;obj_i.vehicle.inverse_control=vh_set_j.inverse_control;
var wm_inv=m_mat4.invert(obj_i.render.world_matrix,new Float32Array(16));var steering_wheel_matrix=m_mat4.multiply(wm_inv,obj_j.render.world_matrix,wm_inv);obj_i.vehicle.steering_wheel_matrix=steering_wheel_matrix;var steering_wheel_axis=new Float32Array([1,0,0,0]);m_vec4.transformMat4(steering_wheel_axis,steering_wheel_matrix,steering_wheel_axis);obj_i.vehicle.steering_wheel_axis=steering_wheel_axis}else if(m_phy.is_vehicle_speedometer(obj_j)&&vh_set_i.name==vh_set_j.name){obj_i.vehicle.speedometer=
obj_j;obj_i.vehicle.speed_ratio=vh_set_j.speed_ratio;obj_i.vehicle.max_speed_angle=vh_set_j.max_speed_angle;var wm_inv=m_mat4.invert(obj_i.render.world_matrix,new Float32Array(16));var speedometer_matrix=m_mat4.multiply(wm_inv,obj_j.render.world_matrix,wm_inv);obj_i.vehicle.speedometer_matrix=speedometer_matrix;var speedometer_axis=new Float32Array([1,0,0,0]);m_vec4.transformMat4(speedometer_axis,speedometer_matrix,speedometer_axis);obj_i.vehicle.speedometer_axis=speedometer_axis}else if(m_phy.is_vehicle_tachometer(obj_j)&&
vh_set_i.name==vh_set_j.name){obj_i.vehicle.tachometer=obj_j;obj_i.vehicle.delta_tach_angle=vh_set_j.delta_tach_angle;var wm_inv=m_mat4.invert(obj_i.render.world_matrix,new Float32Array(16));var tachometer_matrix=m_mat4.multiply(wm_inv,obj_j.render.world_matrix,wm_inv);obj_i.vehicle.tachometer_matrix=tachometer_matrix;var tachometer_axis=new Float32Array([1,0,0,0]);m_vec4.transformMat4(tachometer_axis,tachometer_matrix,tachometer_axis);obj_i.vehicle.tachometer_axis=tachometer_axis}}if(obj_i.vehicle.props.length!=
4)throw"Not enough wheels for chassis "+obj_i.name;}else if(vh_set_i.part=="HULL"){obj_i.vehicle={};obj_i.vehicle.props=[];obj_i.vehicle.prop_offsets=[];obj_i.vehicle.force_max=vh_set_i.force_max;obj_i.vehicle.brake_max=vh_set_i.brake_max;obj_i.vehicle.floating_factor=vh_set_i.floating_factor;obj_i.vehicle.water_lin_damp=vh_set_i.water_lin_damp;obj_i.vehicle.water_rot_damp=vh_set_i.water_rot_damp;obj_i.vehicle.engine_force=0;obj_i.vehicle.brake_force=1;obj_i.vehicle.steering=0;obj_i.vehicle.speed=
0;obj_i.vehicle.steering_wheel=null;var dg_parent=m_obj_util.get_dg_parent(obj_i);if(dg_parent)var boat_objects=m_obj_util.get_dg_objects(dg_parent,objects);else var boat_objects=objects;for(var j=0;j<boat_objects.length;j++){var obj_j=boat_objects[j];if(!obj_j.is_vehicle)continue;var vh_set_j=obj_j.vehicle_settings;if(m_phy.is_boat_bob(obj_j)&&vh_set_i.name==vh_set_j.name){obj_i.vehicle.props.push(obj_j);obj_i.vehicle.prop_offsets.push(new Float32Array(8))}else if(m_phy.is_vehicle_steering_wheel(obj_j)&&
vh_set_i.name==vh_set_j.name){obj_i.vehicle.steering_wheel=obj_j;obj_i.vehicle.steering_max=vh_set_j.steering_max;obj_i.vehicle.steering_ratio=vh_set_j.steering_ratio;obj_i.vehicle.inverse_control=vh_set_j.inverse_control;var wm_inv=m_mat4.invert(obj_i.render.world_matrix,new Float32Array(16));var steering_wheel_matrix=m_mat4.multiply(wm_inv,obj_j.render.world_matrix,wm_inv);obj_i.vehicle.steering_wheel_matrix=steering_wheel_matrix;var steering_wheel_axis=new Float32Array([1,0,0,0]);m_vec4.transformMat4(steering_wheel_axis,
steering_wheel_matrix,steering_wheel_axis);obj_i.vehicle.steering_wheel_axis=steering_wheel_axis}else if(m_phy.is_vehicle_speedometer(obj_j)&&vh_set_i.name==vh_set_j.name){obj_i.vehicle.speedometer=obj_j;obj_i.vehicle.speed_ratio=vh_set_j.speed_ratio;obj_i.vehicle.max_speed_angle=vh_set_j.max_speed_angle;var wm_inv=m_mat4.invert(obj_i.render.world_matrix,new Float32Array(16));var speedometer_matrix=m_mat4.multiply(wm_inv,obj_j.render.world_matrix,wm_inv);obj_i.vehicle.speedometer_matrix=speedometer_matrix;
var speedometer_axis=new Float32Array([1,0,0,0]);m_vec4.transformMat4(speedometer_axis,speedometer_matrix,speedometer_axis);obj_i.vehicle.speedometer_axis=speedometer_axis}else if(m_phy.is_vehicle_tachometer(obj_j)&&vh_set_i.name==vh_set_j.name){obj_i.vehicle.tachometer=obj_j;obj_i.vehicle.delta_tach_angle=vh_set_j.delta_tach_angle;var wm_inv=m_mat4.invert(obj_i.render.world_matrix,new Float32Array(16));var tachometer_matrix=m_mat4.multiply(wm_inv,obj_j.render.world_matrix,wm_inv);obj_i.vehicle.tachometer_matrix=
tachometer_matrix;var tachometer_axis=new Float32Array([1,0,0,0]);m_vec4.transformMat4(tachometer_axis,tachometer_matrix,tachometer_axis);obj_i.vehicle.tachometer_axis=tachometer_axis}}}}}function prepare_floaters(objects){for(var i=0;i<objects.length;i++){var obj_i=objects[i];if(!obj_i.is_floating)continue;var fl_set_i=obj_i.floating_settings;if(fl_set_i.part=="MAIN_BODY"){obj_i.floater={};obj_i.floater.floating_factor=fl_set_i.floating_factor;obj_i.floater.water_lin_damp=fl_set_i.water_lin_damp;
obj_i.floater.water_rot_damp=fl_set_i.water_rot_damp;obj_i.floater.bobs=[];var dg_parent=m_obj_util.get_dg_parent(obj_i);if(dg_parent)var bob_objects=m_obj_util.get_dg_objects(dg_parent,objects);else var bob_objects=objects;for(var j=0;j<bob_objects.length;j++){var obj_j=bob_objects[j];if(!obj_j.is_floating)continue;var fl_set_j=obj_j.floating_settings;if(m_phy.is_floater_bob(obj_j)&&fl_set_i.name==fl_set_j.name){obj_i.floater.bobs.push(obj_j);obj_j.bob_synchronize_pos=obj_j.floating_settings.synchronize_position}}}}}
function remove_bpy_object(remobj,bpy_scenes){for(var i=0;i<bpy_scenes.length;i++){var bpy_objs=bpy_scenes[i]["objects"];for(var j=0;j<bpy_objs.length;j++){var bpy_obj=bpy_objs[j];var dupli_group=bpy_obj["dupli_group"];if(dupli_group){var dg_objects=dupli_group["objects"];obj_index=dg_objects.indexOf(remobj);if(obj_index>-1)dg_objects.splice(obj_index,1)}}var obj_index=bpy_objs.indexOf(remobj);if(obj_index>-1)bpy_objs.splice(obj_index,1)}}function wait_physics_workers(bpy_data,thread,stage,cb_param,
cb_finish,cb_set_rate){var loaded=true;for(var i=0;i<bpy_data["scenes"].length;i++){var scene=bpy_data["scenes"][i];if(!m_phy.check_worker_loaded(scene)){loaded=false;break}}if(loaded){cb_finish(thread,stage);m_print.log("%cPHYSICS READY","color: #0a0")}}function add_physics_objects(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){var primary_scene=get_primary_main_scene();for(var i=0;i<bpy_data["scenes"].length;i++){var scene=bpy_data["scenes"][i];if(data_is_primary(bpy_data))var enable_physics=
m_phy.scene_has_physics(scene);else var enable_physics=m_phy.scene_has_physics(primary_scene)||m_phy.scene_has_physics(scene);if(!data_is_primary(bpy_data))scene=primary_scene;if(cfg_phy.enabled&&enable_physics)for(var j=0;j<ADD_PHY_TYPES.length;j++){var type=ADD_PHY_TYPES[j];var sobjs=m_obj.get_scene_objs(scene,type,thread.id);for(var k=0;k<sobjs.length;k++){var obj=sobjs[k];if(obj.render.data_id==thread.id){m_phy.append_object(obj,scene);if(thread.load_hidden&&m_phy.obj_has_physics(obj))m_phy.disable_simulation(obj)}}}}cb_finish(thread,
stage)}function load_shoremap(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){var img_by_uri={};var image_assets=[];var bpy_scenes=bpy_data["scenes"];for(var i=0;i<bpy_data["scenes"].length;i++){var scene=bpy_scenes[i];if(scene._render.water_params){var image=scene._render.water_params.shoremap_image;if(image&&image["source"]==="FILE"){var uuid=image["uuid"];var dir_path=dirname(thread.filepath);var image_path=m_util.normpath_preserve_protocol(dir_path+image["filepath"]);if(image._is_dds)var asset_type=
m_assets.AT_ARRAYBUFFER;else var asset_type=m_assets.AT_IMAGE_ELEMENT;image_assets.push([uuid,asset_type,image_path]);img_by_uri[uuid]=image}}}if(image_assets.length){var asset_cb=function(html_image,uri,type,path){if(!html_image)return;var show_path_warning=true;print_image_info(html_image,path,show_path_warning);var image=img_by_uri[uri];var tex_users=find_image_users(image,bpy_data["textures"]);for(var i=0;i<tex_users.length;i++){var tex_user=tex_users[i];var filepath=tex_user["image"]["filepath"];
m_tex.update_texture(tex_user._render,html_image,image._is_dds,filepath,thread.id)}for(var i=0;i<bpy_scenes.length;i++){var scene=bpy_scenes[i];var shr_image=scene._render.water_params.shoremap_image;if(shr_image===image)update_scene_shore_distance(html_image,image,scene)}};var pack_cb=function(){cb_finish(thread,stage)};m_assets.enqueue(image_assets,asset_cb,pack_cb)}else cb_finish(thread,stage)}function update_scene_shore_distance(html_image,shoremap,scene){var tmpcanvas=document.createElement("canvas");
var width=shoremap.size[0];var height=shoremap.size[1];tmpcanvas.width=width;tmpcanvas.height=height;var ctx=tmpcanvas.getContext("2d");ctx.drawImage(html_image,0,0);var image_data=ctx.getImageData(0,0,width,height);var dist_color=image_data.data;var bit_shift=new Float32Array(4);bit_shift[0]=1/(255*255*255);bit_shift[1]=1/(255*255);bit_shift[2]=1/255;bit_shift[3]=1;var arr_size=width*height;var shore_distances=new Float32Array(arr_size);for(var j=0;j<arr_size;j++)shore_distances[j]=bit_shift[1]*
dist_color[4*j+2]+bit_shift[2]*dist_color[4*j+3];scene._render.shore_distances=shore_distances}function load_smaa_textures(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){if(!cfg_def.antialiasing||!cfg_def.smaa){cb_finish(thread,stage);return}var scene=bpy_data["scenes"][0];var subs_smaa_arr=[];var smaa_passes_names=["SMAA_EDGE_DETECTION","SMAA_BLENDING_WEIGHT_CALCULATION","SMAA_NEIGHBORHOOD_BLENDING","SMAA_RESOLVE"];for(var i=0;i<smaa_passes_names.length;i++){var smaa_sub=m_scenes.get_subs(scene,
smaa_passes_names[i]);if(smaa_sub)subs_smaa_arr.push(smaa_sub)}if(!subs_smaa_arr.length){cb_finish(thread,stage);return}var smaa_images=[];var dir_path=dirname(thread.filepath);var asset_type=m_assets.AT_IMAGE_ELEMENT;var search_texture_path=m_cfg.paths.smaa_search_texture_path;smaa_images.push(["SEARCH_TEXTURE",asset_type,search_texture_path]);var area_texture_path=m_cfg.paths.smaa_area_texture_path;smaa_images.push(["AREA_TEXTURE",asset_type,area_texture_path]);for(var i=0;i<subs_smaa_arr.length;i++){var subs_smaa=
subs_smaa_arr[i];if(subs_smaa.type=="SMAA_BLENDING_WEIGHT_CALCULATION"){var slinks_internal=subs_smaa.slinks_internal;for(var j=0;j<slinks_internal.length;j++){var slink=slinks_internal[j];if(slink.to=="u_search_tex")var search_texture=slink.texture;else if(slink.to=="u_area_tex")var area_texture=slink.texture}break}}if(smaa_images.length){var asset_cb=function(image_data,uri,type,path){if(!image_data)return;var show_path_warning=false;print_image_info(image_data,path,show_path_warning);if(uri=="SEARCH_TEXTURE")var texture=
search_texture;else var texture=area_texture;texture.source="IMAGE";texture.auxilary_texture=true;var is_dds=path.indexOf(".dds")!=-1?1:0;m_tex.update_texture(texture,image_data,is_dds,path,thread.id);m_tex.set_filters(texture,m_tex.TF_LINEAR,m_tex.TF_LINEAR)};var pack_cb=function(){cb_finish(thread,stage)};m_assets.enqueue(smaa_images,asset_cb,pack_cb)}else cb_finish(thread,stage)}function prepare_objects_adding(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){for(var i=0;i<bpy_data["scenes"].length;i++){var scene=
bpy_data["scenes"][i];if(!data_is_primary(bpy_data))scene=get_primary_main_scene();var lamps=m_obj.get_scene_objs(scene,"LAMP",thread.id);for(var j=0;j<lamps.length;j++){var lamp=lamps[j];if(lamp.render.data_id==thread.id)cb_param.added_objects.push({scene:scene,obj:lamp})}var objs=m_obj.get_scene_objs(scene,"ALL",thread.id);for(var j=0;j<objs.length;j++){var obj=objs[j];if(obj.type=="LAMP")continue;if(obj.render.data_id==thread.id){if(thread.load_hidden&&m_obj_util.is_mesh(obj))m_scenes.hide_object(obj);
cb_param.added_objects.push({scene:scene,obj:obj})}}}}function add_objects(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){var obj_data=cb_param.added_objects;var obj_counter=cb_param.obj_counter;if(obj_data.length){var obj=obj_data[obj_counter].obj;var scene=obj_data[obj_counter].scene;var sc_data=m_obj_util.get_scene_data(obj,scene);m_scenes.append_object(scene,obj,false);if(obj.anchor)m_anchors.append(obj);var rate=++cb_param.obj_counter/obj_data.length;if(obj.type=="LAMP")m_obj.sort_lamps(scene);
var cube_refl_subs=sc_data.cube_refl_subs;if(obj.render.cube_reflection_id!=null&&cube_refl_subs)m_scenes.update_cube_reflect_subs(cube_refl_subs,obj.render.trans);var refl_objs=obj.reflective_objs;if(refl_objs.length&&scene._render.reflection_params){var rp_trans=obj.render.trans;var rp_quat=obj.render.quat;var refl_subs=sc_data.plane_refl_subs;m_scenes.update_plane_reflect_subs(refl_subs,rp_trans,rp_quat);m_obj_util.update_refl_objects(refl_objs,refl_subs.camera.reflection_plane)}}else var rate=
1;cb_set_rate(thread,stage,rate)}function end_objects_adding(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){if(data_is_primary(bpy_data)){var scene_main=m_scenes.get_main();var scenes=m_scenes.get_rendered_scenes();for(var i=0;i<scenes.length;i++){var scene=scenes[i];m_scenes.prepare_rendering(scene,scene_main);if(scene["b4w_use_logic_editor"])m_lnodes.init_logic(scene,thread.id)}m_scenes.set_active(scene_main)}else m_scenes.update_scene_permanent_uniforms(get_primary_main_scene());var objects=
m_obj.get_all_objects(thread.id);m_obj.update_objects_dynamics(objects);cb_finish(thread,stage)}function synchronize_media(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){if(data_is_primary(bpy_data))for(var i=0;i<bpy_data["scenes"].length;i++){video_play(bpy_data["scenes"][i]);speakers_play(bpy_data["scenes"][i],thread.id)}else{video_play(get_primary_main_scene());speakers_play(get_primary_main_scene(),thread.id)}cb_finish(thread,stage)}exports.setup_canvas=function(canvas){_canvas=canvas};
function mobile_media_start(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){if(cfg_def.is_mobile_device&&(thread.has_video_textures||thread.has_background_music||thread.init_wa_context)){if(!_play_media_btn)create_media_controls(bpy_data,cb_finish,thread,stage)}else cb_finish(thread,stage)}function create_media_controls(bpy_data,cb_finish,thread,stage){var canvas_container=_canvas.parentElement;_canvas_container_z_index=canvas_container.style.zIndex;canvas_container.style.zIndex="999";_play_media_btn=
document.createElement("div");_play_media_btn.style.position="relative";_play_media_btn.style.height="88px";_play_media_btn.style.width="88px";var h=Math.round(_canvas.offsetHeight/2-44);var w=Math.round(_canvas.offsetWidth/2-44);_play_media_btn.style.top=h.toString()+"px";_play_media_btn.style.left=w.toString()+"px";_play_media_btn.style.backgroundImage="url('"+PLAY_MEDIA_IMAGE_MOBILE+"')";_play_media_btn.style.backgroundSize="88px";_play_media_bkg=document.createElement("div");_play_media_bkg.style.position=
"relative";_play_media_bkg.style.height=_canvas.offsetHeight.toString()+"px";_play_media_bkg.style.width=_canvas.offsetWidth.toString()+"px";_play_media_bkg.style.background="rgba(0, 0, 0, 0.5)";_play_media_bkg.style.zIndex="999";canvas_container.appendChild(_play_media_bkg);_play_media_bkg.appendChild(_play_media_btn);_play_media_btn.addEventListener("click",function(){if(thread.has_video_textures){m_tex.play();m_tex.pause();m_tex.reset()}if(thread.has_background_music){if(data_is_primary(bpy_data))for(var i=
0;i<bpy_data["scenes"].length;i++)speakers_play(bpy_data["scenes"][i],thread.id,true);else speakers_play(get_primary_main_scene(),thread.id,true);m_sfx.pause()}if(thread.init_wa_context)m_sfx.play_empty_sound();remove_media_controls();cb_finish(thread,stage)},false)}function remove_media_controls(){if(_play_media_btn){var canvas_container=_canvas.parentElement;canvas_container.style.zIndex=_canvas_container_z_index;_play_media_bkg.removeChild(_play_media_btn);canvas_container.removeChild(_play_media_bkg);
_play_media_bkg=null;_play_media_btn=null;_canvas_container_z_index=0}}exports.update_media_controls=function(width,height){if(_play_media_btn){_play_media_bkg.style.height=height.toString()+"px";_play_media_bkg.style.width=width.toString()+"px";var h=Math.round(height/2-44);var w=Math.round(width/2-44);_play_media_btn.style.top=h.toString()+"px";_play_media_btn.style.left=w.toString()+"px"}};function dirname(path){var dirname=path.split("/").slice(0,-1).join("/");if(dirname)dirname+="/";return dirname}
exports.load=function(path,loaded_cb,stageload_cb,wait_complete_loading,load_hidden){var stages={"load_main":{priority:m_loader.ASYNC_PRIORITY,background_loading:false,inputs:[],is_resource:false,relative_size:500,primary_only:false,cb_before:load_main},"duplicate_objects":{priority:m_loader.SYNC_PRIORITY,background_loading:false,inputs:["load_main"],is_resource:false,relative_size:50,primary_only:false,cb_before:duplicate_objects},"load_binaries":{priority:m_loader.ASYNC_PRIORITY,background_loading:false,
inputs:["load_main"],is_resource:false,relative_size:500,primary_only:false,cb_before:load_binaries},"wait_for_shaders":{priority:m_loader.ASYNC_PRIORITY,background_loading:true,inputs:[],is_resource:false,relative_size:50,primary_only:true,cb_loop:wait_for_shaders},"prepare_bindata":{priority:m_loader.SYNC_PRIORITY,background_loading:false,inputs:["duplicate_objects","load_binaries"],is_resource:false,relative_size:0,primary_only:false,cb_before:prepare_bindata},"prepare_bpy_data":{priority:m_loader.SYNC_PRIORITY,
background_loading:false,inputs:["duplicate_objects","prepare_bindata"],is_resource:false,relative_size:100,primary_only:false,cb_before:prepare_bpy_data},"process_objects":{priority:m_loader.SYNC_PRIORITY,background_loading:false,inputs:["prepare_bpy_data"],is_resource:false,relative_size:100,primary_only:false,cb_before:process_objects},"process_scenes":{priority:m_loader.SYNC_PRIORITY,background_loading:false,inputs:["process_objects","wait_for_shaders"],is_resource:false,relative_size:300,primary_only:false,
cb_before:process_scenes},"load_smaa_textures":{priority:m_loader.ASYNC_PRIORITY,background_loading:true,inputs:["process_scenes"],is_resource:false,relative_size:10,primary_only:true,cb_before:load_smaa_textures},"load_shoremap":{priority:m_loader.ASYNC_PRIORITY,background_loading:true,inputs:["process_scenes"],is_resource:false,relative_size:10,primary_only:true,cb_before:load_shoremap},"load_textures":{priority:m_loader.ASYNC_PRIORITY,background_loading:true,inputs:["process_scenes"],is_resource:true,
relative_size:500,primary_only:false,cb_before:load_textures,cb_param:{image_counter:0}},"update_scenes_nla":{priority:m_loader.SYNC_PRIORITY,background_loading:false,inputs:["process_scenes","load_textures"],is_resource:false,relative_size:20,primary_only:false,cb_before:update_scenes_nla},"wait_physics_workers":{priority:m_loader.ASYNC_PRIORITY,background_loading:true,inputs:["load_shoremap"],is_resource:false,relative_size:20,primary_only:false,cb_loop:wait_physics_workers},"add_physics_objects":{priority:m_loader.SYNC_PRIORITY,
background_loading:false,inputs:["wait_physics_workers"],is_resource:false,relative_size:20,primary_only:false,cb_before:add_physics_objects},"add_objects":{priority:m_loader.SYNC_PRIORITY,background_loading:false,inputs:["add_physics_objects"],is_resource:false,relative_size:800,primary_only:false,cb_before:prepare_objects_adding,cb_loop:add_objects,cb_after:end_objects_adding,cb_param:{added_objects:[],obj_counter:0}},"load_speakers":{priority:m_loader.ASYNC_PRIORITY,background_loading:true,inputs:["add_objects"],
is_resource:true,relative_size:30,primary_only:false,cb_before:load_speakers,cb_param:{sound_counter:0}},"mobile_media_start":{priority:m_loader.SYNC_PRIORITY,background_loading:!cfg_def.is_mobile_device,inputs:["load_textures","update_scenes_nla","load_speakers"],is_resource:true,relative_size:5,primary_only:false,cb_before:mobile_media_start,cb_loop:mobile_media_start},"synchronize_media":{priority:m_loader.SYNC_PRIORITY,background_loading:true,inputs:["mobile_media_start"],is_resource:true,relative_size:70,
primary_only:false,cb_before:synchronize_media},"start_nla":{priority:m_loader.SYNC_PRIORITY,background_loading:true,inputs:["mobile_media_start"],is_resource:false,relative_size:5,primary_only:false,cb_before:start_nla}};var scheduler=m_loader.get_scheduler();if(!scheduler){scheduler=m_loader.create_scheduler();_bpy_data_array={};_all_objects_cache={};_dupli_obj_id_overrides={}}_bpy_data_array[scheduler.threads.length]={};var data_id=m_loader.create_thread(stages,path,loaded_cb,stageload_cb,free_load_data,
wait_complete_loading||cfg_sfx.audio_loading_hack,cfg_def.do_not_load_resources,load_hidden);return data_id};exports.unload=function(data_id){var scheduler=m_loader.get_scheduler();if(!scheduler||!scheduler.threads.length||data_id&&!m_loader.thread_is_finished(scheduler.threads[data_id])){m_print.error("Unable to unload data!");return}if(data_id==0){m_print.log("%cUNLOAD ALL","color: #00a");m_anchors.cleanup();m_anim.cleanup();m_sfx.cleanup();m_nla.cleanup();m_scenes.cleanup();m_loader.cleanup();
m_phy.cleanup();m_obj.cleanup();m_util.cleanup();m_render.cleanup();m_nodemat.cleanup();m_shaders.cleanup();m_ctl.cleanup();m_ext.cleanup();m_assets.cleanup();m_tex.cleanup();m_lnodes.cleanup();_all_objects_cache=null;_dupli_obj_id_overrides={};_primary_data=null;_bpy_data_array=null}else{m_print.log("%cUNLOAD DATA "+data_id,"color: #00a");m_anim.remove_actions(data_id);var scenes=m_scenes.get_all_scenes();for(var i=0;i<scenes.length;i++){var scene=scenes[i];var objs=m_obj.get_scene_objs(scene,"ALL",
data_id);for(var j=objs.length-1;j>=0;j--){var obj=objs[j];prepare_object_unloading(scene,obj,true);objs.splice(j,1);var typed_objs=m_obj.get_scene_objs(scene,obj.type,data_id);var ind=typed_objs.indexOf(obj);if(ind!=-1)typed_objs.splice(ind,1)}}}remove_media_controls()};exports.prepare_object_unloading=prepare_object_unloading;function prepare_object_unloading(scene,obj,clean_buffs){if(m_anim.is_animated(obj))m_anim.remove(obj);m_obj.clear_outline_anim(obj);if(m_ctl.check_sensor_manifold(obj))m_ctl.remove_sensor_manifold(obj);
if(m_phy.obj_has_physics(obj))m_phy.remove_bounding_object(obj);m_scenes.remove_object_bundles(scene,obj,clean_buffs);if(m_obj_util.is_speaker(obj))m_sfx.speaker_remove(obj);if(m_anchors.is_anchor(obj))m_anchors.remove(obj)}exports.set_debug_resources_root=function(debug_resources_root){_debug_resources_root=debug_resources_root};function get_bpy_objects_cached(bpy_data,data_id){if(!_all_objects_cache[data_id])process_bpy_objects_hierarchy(bpy_data,data_id);return _all_objects_cache[data_id]}function process_bpy_objects_hierarchy(bpy_data,
data_id){var scenes=bpy_data["scenes"];var object_levels=[];for(var i=0;i<scenes.length;i++){var scene_objs=scenes[i]["objects"];process_bpy_objects_hierarchy_iter(scene_objs,0,data_is_primary(bpy_data),object_levels)}_all_objects_cache[data_id]=[];for(var i=0;i<object_levels.length;i++){var grp_level=object_levels[i];for(var j=0;j<grp_level.length;j++){var par_level=grp_level[j];for(var k=0;k<par_level.length;k++)_all_objects_cache[data_id].push(par_level[k])}}var particles=bpy_data["particles"];
for(var i=0;i<particles.length;i++){var dg_obj=particles[i]["dupli_object"];if(dg_obj){dg_obj._is_hair_dupli=true;_all_objects_cache[data_id].push(dg_obj)}var dg_group=particles[i]["dupli_group"];if(dg_group){var objects=dg_group["objects"];for(var j=0;j<objects.length;j++){var dg_obj=objects[j];dg_obj._is_hair_dupli=true;_all_objects_cache[data_id].push(dg_obj)}}}}function process_bpy_objects_hierarchy_iter(bpy_objects,grp_num,is_primary,object_levels){object_levels[grp_num]=object_levels[grp_num]||
[];var group_level=object_levels[grp_num];for(var i=0;i<bpy_objects.length;i++){var bpy_obj=bpy_objects[i];var pnum=parent_num(bpy_obj);group_level[pnum]=group_level[pnum]||[];if(is_primary||SECONDARY_LOAD_TYPES_DISABLED.indexOf(bpy_obj["type"])==-1)if(group_level[pnum].indexOf(bpy_obj)==-1)group_level[pnum].push(bpy_obj);var dupli_group=bpy_obj["dupli_group"];if(dupli_group){var dg_objects=dupli_group["objects"];process_bpy_objects_hierarchy_iter(dg_objects,grp_num+1,is_primary,object_levels)}}}
function parent_num(bpy_obj){var par=bpy_obj["parent"]||m_anim.get_bpy_armobj(bpy_obj);if(par)return 1+parent_num(par);else return 0}};b4w.module["__batch"]=function(exports,require){var m_bounds=require("__boundings");var m_cam=require("__camera");var m_cfg=require("__config");var m_print=require("__print");var m_extensions=require("__extensions");var m_geometry=require("__geometry");var m_graph=require("__graph");var m_nodemat=require("__nodemat");var m_obj_util=require("__obj_util");var m_particles=require("__particles");var m_primitives=require("__primitives");var m_quat=require("__quat");var m_reformer=require("__reformer");
var m_render=require("__renderer");var m_scenegraph=require("__scenegraph");var m_shaders=require("__shaders");var m_textures=require("__textures");var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("__vec3");var m_vec4=require("__vec4");var cfg_def=m_cfg.defaults;var cfg_scs=m_cfg.scenes;var DEBUG_SAVE_SUBMESHES=false;var DEBUG_KEEP_BUFS_DATA_ARRAYS=false;var BATCH_TYPES_DEBUG_SPHERE=["MAIN"];var STREE_CELL_COUNT=20;var DEFAULT_PART_SYS_QUAT=new Float32Array([0,-Math.sqrt(.5),
0,Math.sqrt(.5)]);var _vec4_tmp=new Float32Array(4);exports.BATCH_INHERITED_TEXTURES=BATCH_INHERITED_TEXTURES;var BATCH_INHERITED_TEXTURES=["u_colormap0","u_colormap1","u_stencil0","u_specmap0","u_normalmap0","u_mirrormap"];exports.init_batch=init_batch;function init_batch(type){var batch={type:type,subtype:"",id:0,render_id:0,odd_id_prop:"",textures:[],texture_names:[],material_names:[],common_attributes:[],uv_maps_usage:null,vertex_colors_usage:{},shader:null,shaders_info:{vert:null,frag:null,directives:[],
node_elements:[]},attribute_setters:[],particle_system:null,bufs_data:null,use_shape_keys:false,debug_sphere:false,debug_sphere_dynamic:false,wireframe_mode:0,num_vertices:0,num_triangles:0,jitter_amp:0,jitter_freq:0,grass_scale_threshold:0,grass_size:0,grass_map_dim:new Float32Array(3),cube_fog:new Float32Array(16),alpha_clip:false,blend:false,color_mask:false,depth_mask:false,xray:false,use_backface_culling:false,use_shadeless:false,dynamic_geometry:false,shadow_cast:false,shadow_cast_only:false,
shadow_receive:false,reflexible:false,reflexible_only:false,reflective:false,dynamic_grass:false,procedural_sky:false,draw_mode:m_geometry.DM_DEFAULT,zsort_type:m_geometry.ZSORT_DISABLED,can_fork_outline:false,forked_batch:false,psys_name:"",shadow_source:"",halo:false,halo_size:0,halo_hardness:0,halo_stars_blend:0,halo_stars_height:0,halo_rings_color:new Float32Array(3),halo_lines_color:new Float32Array(3),halo_particles:false,ambient:0,emit:0,diffuse_intensity:1,reflect_factor:0,specular_color_factor:0,
specular_alpha:1,parallax_scale:0,diffuse_color_factor:0,alpha_factor:1,normal_factor:0,mirror_factor:0,offset_z:0,refr_bump:0,diffuse_params:new Array(2),specular_params:new Float32Array(3),texture_scale:new Float32Array(3),specular_color:new Float32Array(3),diffuse_color:new Float32Array(4),fresnel_params:new Float32Array(4),lamp_uuid_indexes:null,lamp_light_positions:null,lamp_light_directions:null,lamp_light_color_intensities:null,lamp_light_factors:null,has_nodes:false,water:false,water_dynamic:false,
water_shore_smoothing:false,water_generated_mesh:false,water_num_cascads:0,water_subdivs:0,water_detailed_dist:0,water_norm_uv_velocity:.1,shallow_water_col_fac:0,shore_water_col_fac:0,foam_factor:0,foam_uv_freq:new Float32Array(2),foam_mag:new Float32Array(2),foam_scale:new Float32Array(2),shallow_water_col:new Float32Array(3),shore_water_col:new Float32Array(3),normalmap_scales:null,refractive:false,particles_data:null};batch.diffuse_color[3]=1;batch.color_mask=true;batch.depth_mask=true;return batch}
exports.generate_main_batches=function(scene,mesh_objects,lamps,meta_objects){var graph=scene._render.graph;var dynamic_objects=[];var static_objects=[];for(var i=0;i<mesh_objects.length;i++){var obj=mesh_objects[i];if(obj.is_hair_dupli)continue;if(m_obj_util.is_dynamic(obj))dynamic_objects.push(obj);else static_objects.push(obj)}var all_mbatches=[];all_mbatches=all_mbatches.concat(make_dynamic_metabatches(dynamic_objects,graph));all_mbatches=all_mbatches.concat(make_static_metabatches(static_objects,
graph,scene["b4w_batch_grid_size"]));var metabatches=merge_metabatches(all_mbatches);for(var i=0;i<metabatches.length;i++){var batch=metabatches[i].batch;batch.material_names=metabatches[i].mat_names;update_batch_geometry(batch,metabatches[i].submesh);update_batch_lights(batch,lamps,scene);if(metabatches[i].render.type=="STATIC"&&batch.type!="COLOR_ID"){var unique_name=m_util.unique_name("%meta%"+batch.type+"%"+batch.material_names.join("%")+"%");var meta_obj=m_obj_util.create_meta_object(unique_name,
"MESH");meta_obj.render=metabatches[i].render;m_obj_util.append_scene_data(meta_obj,scene);m_obj_util.append_batch(meta_obj,scene,batch);meta_objects.push(meta_obj)}else{var unique_obj_names=[];for(var j=0;j<metabatches[i].rel_objects.length;j++){var obj=metabatches[i].rel_objects[j];if(unique_obj_names.indexOf(obj.name)==-1){m_obj_util.append_batch(obj,scene,batch);unique_obj_names.push(obj.name)}}}}if(cfg_def.wireframe_debug){for(var i=0;i<metabatches.length;i++){var render=metabatches[i].render;
if(render.type=="DYNAMIC"){var obj=metabatches[i].rel_objects[0];if(BATCH_TYPES_DEBUG_SPHERE.indexOf(metabatches[i].batch.type)>-1){var sc_data=m_obj_util.get_scene_data(obj,scene);var batches=sc_data.batches;var has_debug_sphere=false;for(var j=0;j<batches.length;j++)if(batches[j].debug_sphere){has_debug_sphere=true;continue}if(has_debug_sphere)continue;var ds_batch=create_bounding_ellipsoid_batch(render.be_local,render,obj.name,true,true);m_obj_util.append_batch(obj,scene,ds_batch)}}}for(var i=
0;i<meta_objects.length;i++){var obj=meta_objects[i];var render=obj.render;var sc_data=m_obj_util.get_scene_data(obj,scene);var batches=sc_data.batches;if(BATCH_TYPES_DEBUG_SPHERE.indexOf(batches[0].type)>-1){var ds_batch=create_bounding_ellipsoid_batch(render.bs_local,render,obj.name,false);m_obj_util.append_batch(obj,scene,ds_batch)}}}for(var i=0;i<mesh_objects.length;i++){var sc_data=m_obj_util.get_scene_data(mesh_objects[i],scene);var batches=sc_data.batches;for(var j=0;j<batches.length;j++)update_batch_subtype(batches[j])}for(var i=
0;i<meta_objects.length;i++){var sc_data=m_obj_util.get_scene_data(meta_objects[i],scene);var batches=sc_data.batches;for(var j=0;j<batches.length;j++)update_batch_subtype(batches[j])}};exports.generate_sky_meta_obj=function(scene,sky){var wls=scene._render.world_light_set;var batch=init_batch("MAIN");apply_shader(batch,"special_skydome.glslv","special_skydome.glslf");if(sky.procedural_skydome){set_batch_directive(batch,"PROCEDURAL_SKYDOME",1);batch.procedural_sky=true}else{var sts=wls.sky_texture_param;
if(sts){set_batch_directive(batch,"WO_SKYTEX",1);var sky_texture=get_batch_texture(wls.sky_texture_slot,null);append_texture(batch,sky_texture,"u_sky");if(sts.invert)set_batch_directive(batch,"MTEX_NEGATIVE",1);if(sts.use_rgb_to_intensity)set_batch_directive(batch,"MTEX_RGBTOINT",1);set_batch_directive(batch,"BLENDTYPE",sts.blend_type);if(sts.use_map_blend)set_batch_directive(batch,"WOMAP_BLEND",1);if(sts.use_map_horizon)set_batch_directive(batch,"WOMAP_HORIZ",1);if(sts.use_map_zenith_up)set_batch_directive(batch,
"WOMAP_ZENUP",1);if(sts.use_map_zenith_down)set_batch_directive(batch,"WOMAP_ZENDOWN",1)}if(wls.use_sky_blend)set_batch_directive(batch,"WO_SKYBLEND",1);if(wls.use_sky_paper)set_batch_directive(batch,"WO_SKYPAPER",1);if(wls.use_sky_real)set_batch_directive(batch,"WO_SKYREAL",1)}if(sky.reflexible){batch.reflexible=true;if(sky.reflexible_only)batch.reflexible_only=true}batch.offset_z=99999;set_batch_c_attr(batch,"a_position");var submesh=m_primitives.generate_fullscreen_quad();update_batch_geometry(batch,
submesh);update_batch_subtype(batch);var unique_name=m_util.unique_name("%meta_sky%");var meta_obj=m_obj_util.create_meta_object(unique_name,"MESH");m_obj_util.append_scene_data(meta_obj,scene);var sc_data=m_obj_util.get_scene_data(meta_obj,scene);meta_obj.render=m_obj_util.create_render("STATIC");meta_obj.render.do_not_cull=true;meta_obj.render.bb_local=m_bounds.zero_bounding_box();meta_obj.render.bs_local=m_bounds.zero_bounding_sphere();meta_obj.render.bb_world=m_bounds.zero_bounding_box();meta_obj.render.bs_world=
m_bounds.zero_bounding_sphere();sc_data.batches.push(batch);return meta_obj};function update_batch_subtype(batch){switch(batch.type){case "MAIN":case "PARTICLES":if(batch.blend)if(batch.xray)batch.subtype="XRAY";else batch.subtype="BLEND";else batch.subtype="OPAQUE";break;case "DEPTH":if(batch.has_nodes)batch.subtype="NODES";else batch.subtype="DEPTH";break;case "COLOR_ID":if(batch.xray)batch.subtype="COLOR_ID_XRAY";else batch.subtype="COLOR_ID";break}}exports.create_forked_batches=function(obj,graph,
scene){var scene_data=m_obj_util.get_scene_data(obj,scene);var batches=scene_data.batches;var forked_batches=[];var shadow_cast_subs=m_scenegraph.find_subs(graph,"SHADOW_CAST");var main_reflect_subs=m_scenegraph.find_subs(graph,"MAIN_PLANE_REFLECT");var cube_reflect_subs=m_scenegraph.find_subs(graph,"MAIN_CUBE_REFLECT");var outline_mask_subs=m_scenegraph.find_subs(graph,"OUTLINE_MASK");var picking_mask_subs=m_scenegraph.find_subs(graph,"COLOR_PICKING");for(var j=0;j<batches.length;j++){var batch_src=
batches[j];var batch=null;if(batch_src.type=="DEPTH"&&shadow_cast_subs&&batch_src.shadow_cast){batch=copy_forked_batch(batch_src);batch.subtype="SHADOW_CAST"}if((batch_src.type=="MAIN"||batch_src.type=="PARTICLES")&&(main_reflect_subs||cube_reflect_subs)&&!batch_src.blend&&batch_src.reflexible){batch=copy_forked_batch(batch_src);batch.subtype="REFLECT"}if(batch_src.type=="COLOR_ID"&&batch_src.can_fork_outline)if(outline_mask_subs&&obj.render.outlining)if(picking_mask_subs&&obj.render.selectable){batch=
copy_forked_batch(batch_src);batch.subtype="OUTLINE"}else batch_src.subtype="OUTLINE";if(batch){batch.forked_batch=true;update_batch_id(batch,obj.render.id);forked_batches.push(batch)}}batches.push.apply(batches,forked_batches)};function copy_forked_batch(batch_src){var bufs_data=batch_src.bufs_data;batch_src.bufs_data=null;var batch=m_obj_util.copy_object_props_by_value(batch_src);batch_src.bufs_data=bufs_data;batch.bufs_data=bufs_data;return batch}function batch_copy_wo_bufs(batch){var batch_copy=
m_util.clone_object_nr(batch);batch.shaders_info=JSON.parse(JSON.stringify(batch.shaders_info));return batch_copy}function make_dynamic_metabatches(dyn_objects,graph){var metabatches=[];for(var i=0;i<dyn_objects.length;i++){var obj=dyn_objects[i];var bpy_obj=obj.temp_bpy_obj;var render=obj.render;var bb_local=m_bounds.zero_bounding_box();m_bounds.copy_bb(render.bb_original,bb_local);var cyl_radius=bpy_obj["data"]["b4w_bounding_cylinder_radius"];var bs_radius=bpy_obj["data"]["b4w_bounding_sphere_radius"];
var bs_center=bpy_obj["data"]["b4w_bounding_sphere_center"];var be_axes=bpy_obj["data"]["b4w_bounding_ellipsoid_axes"];var be_center=bpy_obj["data"]["b4w_bounding_ellipsoid_center"];if(render.billboard){var x=Math.max(Math.abs(bb_local.max_x),Math.abs(bb_local.min_x));var y=Math.max(Math.abs(bb_local.max_y),Math.abs(bb_local.min_y));var z=Math.max(Math.abs(bb_local.max_z),Math.abs(bb_local.min_z));var sphere_radius=Math.sqrt(x*x+y*y+z*z);var cylinder_radius=Math.sqrt(x*x+y*y);bb_local.max_x=bb_local.max_y=
bb_local.max_z=sphere_radius;bb_local.min_x=bb_local.min_y=bb_local.min_z=-sphere_radius;cyl_radius=cylinder_radius;bs_radius=sphere_radius;bs_center[0]=bs_center[1]=bs_center[2]=0;be_axes[0]=be_axes[1]=be_axes[2]=sphere_radius;be_center[0]=be_center[1]=be_center[2]=0}render.bb_local=bb_local;var bb_world=m_bounds.bounding_box_transform(bb_local,render.world_matrix);render.bb_world=bb_world;set_local_cylinder_capsule(render,cyl_radius,cyl_radius,bb_local);var bs_local=m_bounds.create_bounding_sphere(bs_radius,
bs_center);render.bs_local=bs_local;var bs_world=m_bounds.bounding_sphere_transform(bs_local,render.world_matrix);render.bs_world=bs_world;var be_local=m_bounds.create_bounding_ellipsoid([be_axes[0],0,0],[0,be_axes[1],0],[0,0,be_axes[2]],be_center);render.be_local=be_local;var be_world=m_bounds.bounding_ellipsoid_transform(be_local,render.tsr);render.be_world=be_world;metabatches=metabatches.concat(make_object_metabatches(obj,render,graph))}return metabatches}function make_static_metabatches(static_objects,
graph,grid_size){var metabatches=[];var clusters=create_object_clusters(static_objects,grid_size);for(var i=0;i<clusters.length;i++){var render=clusters[i].render;var objs=clusters[i].objects;for(var j=0;j<objs.length;j++){var obj=objs[j];var bpy_obj=obj.temp_bpy_obj;var obj_metabatches=make_object_metabatches(obj,render,graph);if(obj.render.billboard&&!obj.render.billboard_pres_glob_orientation){var tsr=m_tsr.create();m_tsr.set_trans(obj.render.trans,tsr)}else var tsr=tsr_from_render(obj.render);
var params={};if(render.wind_bending||render.billboard)params["au_center_pos"]=[tsr[0],tsr[1],tsr[2]];if(render.wind_bending){params["au_wind_bending_amp"]=[obj.render.wind_bending_amp];params["au_wind_bending_freq"]=[bpy_obj["b4w_wind_bending_freq"]];params["au_detail_bending_amp"]=[bpy_obj["b4w_detail_bending_amp"]];params["au_detail_bending_freq"]=[bpy_obj["b4w_detail_bending_freq"]];params["au_branch_bending_amp"]=[bpy_obj["b4w_branch_bending_amp"]]}for(var k=0;k<obj_metabatches.length;k++){var metabatch_render=
obj_metabatches[k].render;var submesh=obj_metabatches[k].submesh;var batch=obj_metabatches[k].batch;if(!metabatch_render.is_hair_particles){if(batch.type=="COLOR_ID"){var obj_render=obj_metabatches[k].render=obj.render;batch.odd_id_prop=bpy_obj["uuid"];update_batch_render(batch,obj_render);var render_id=calculate_render_id(obj_render);update_batch_id(batch,render_id,0)}submesh=m_geometry.submesh_apply_transform(submesh,tsr);submesh=m_geometry.submesh_apply_params(submesh,params)}else if(metabatch_render.billboard)submesh=
m_geometry.submesh_apply_particle_transform(submesh,tsr);else submesh=m_geometry.submesh_apply_transform(submesh,tsr)}metabatches=metabatches.concat(obj_metabatches)}}return metabatches}function make_object_metabatches(obj,render,graph){var bpy_obj=obj.temp_bpy_obj;var metabatches=[];var batch_types=get_batch_types(graph,render);var render_id=calculate_render_id(render);var mesh=bpy_obj["data"];var materials=mesh["materials"];var batches_main=new Array(materials.length);var subs_main=m_scenegraph.find_subs(graph,
"MAIN_OPAQUE");var has_lamp=false;if(subs_main)has_lamp=subs_main.light_positions.length?true:false;for(var i=0;i<batch_types.length;i++){var type=batch_types[i];for(var j=0;j<materials.length;j++){var material=materials[j];if(material["name"]=="LENS_FLARES"&&!has_lamp)continue;if(m_geometry.has_empty_submesh(mesh,j))continue;var batch=init_batch(type);if(type=="COLOR_ID")batch.can_fork_outline=!(bpy_obj["b4w_do_not_render"]||material["b4w_do_not_render"]);if(type=="MAIN")batches_main[j]=batch;if(!batch_material_is_valid(batch,
material))continue;if(type=="DEPTH"&&batches_main[j])batch.use_shadeless=batches_main[j].use_shadeless;batch.draw_mode=render.use_shape_keys||render.dynamic_geometry?m_geometry.DM_DYNAMIC_TRIANGLES:m_geometry.DM_DEFAULT;update_batch_render(batch,render);update_batch_particle_systems(batch,bpy_obj["particle_systems"]);if(render.type=="DYNAMIC")batch.odd_id_prop=bpy_obj["uuid"];update_batch_id(batch,render_id);var submesh=m_geometry.extract_submesh(mesh,j,batch.common_attributes,render.bone_skinning_info,
batch.vertex_colors_usage,batch.uv_maps_usage);if(material["name"]=="LENS_FLARES")submesh=m_particles.prepare_lens_flares(submesh);metabatches.push({batch:batch,submesh:submesh,mat_names:[material["name"]],render:render,rel_objects:[obj]})}}var psystems=bpy_obj["particle_systems"];if(psystems.length>0&&metabatches.length){var render_emitter=false;var need_emitter_submesh=false;for(var i=0;i<psystems.length;i++){var psys=psystems[i];var pset=psys["settings"];if(pset["use_render_emitter"])render_emitter=
true;if(pset["type"]=="HAIR"&&(pset["render_type"]=="OBJECT"||pset["render_type"]=="GROUP"||!psys["transforms"].length))need_emitter_submesh=true;if(render_emitter&&need_emitter_submesh)break}var emitter_vc=metabatches[0].batch.vertex_colors_usage;if(need_emitter_submesh)if(materials.length>1)var em_submesh=build_emitter_submesh(mesh,psystems,emitter_vc);else var em_submesh=metabatches[0].submesh;else var em_submesh=null;var particles_metabatches=make_particles_metabatches(obj,render,graph,render_id,
emitter_vc,em_submesh);if(render_emitter)metabatches=metabatches.concat(particles_metabatches);else metabatches=particles_metabatches}return metabatches}function build_emitter_submesh(mesh,psystems,emitter_vc){var emitter_inherit_vc_usage={};for(var i=0;i<psystems.length;i++){var pset=psystems[i]["settings"];if(pset["type"]=="HAIR"&&(pset["render_type"]=="OBJECT"||pset["render_type"]=="GROUP")){var vcol_from=pset["b4w_vcol_from_name"];var vcol_to=pset["b4w_vcol_to_name"];if(vcol_from!==""&&vcol_to!==
"")emitter_inherit_vc_usage[vcol_from]=m_util.clone_object_r(emitter_vc[vcol_from])}}if("a_bending_col_main"in emitter_vc)emitter_inherit_vc_usage["a_bending_col_main"]=m_util.clone_object_r(emitter_vc["a_bending_col_main"]);if("a_bending_col_detail"in emitter_vc)emitter_inherit_vc_usage["a_bending_col_detail"]=m_util.clone_object_r(emitter_vc["a_bending_col_detail"]);return m_geometry.extract_submesh_all_mats(mesh,[],emitter_inherit_vc_usage)}function make_particles_metabatches(obj,render,graph,
render_id,emitter_vc,em_submesh){var bpy_obj=obj.temp_bpy_obj;var metabatches=[];var psystems=bpy_obj["particle_systems"];var mesh=bpy_obj["data"];var materials=mesh["materials"];for(var i=0;i<psystems.length;i++){var psys=psystems[i];var pset=psys["settings"];if(!pset["count"])continue;if(pset["type"]=="EMITTER"){if(render.type=="DYNAMIC"){var batch=init_batch("PARTICLES");var pmaterial=select_psys_material(psys,mesh["materials"]);if(psys["settings"]["render_type"]==="HALO")batch.halo_particles=
true;update_batch_material(batch,pmaterial);update_batch_particles_emitter(batch,psys);batch.dynamic_geometry=true;batch.odd_id_prop=obj.name+"_"+pset["uuid"];batch.psys_name=psys["name"];update_batch_id(batch,render_id);m_particles.init_particles_data(batch,psys,pmaterial);var submesh=m_particles.generate_emitter_particles_submesh(batch,mesh,psys,obj.render.tsr);metabatches.push({batch:batch,submesh:submesh,mat_names:[pmaterial["name"]],render:render,rel_objects:[obj]})}}else if(pset["type"]=="HAIR"){var seed=
m_util.init_rand_r_seed(psys["seed"]);if(pset["b4w_dynamic_grass"])render.do_not_cull=true;var use_particles_rotation=m_reformer.check_particles_bin_format(cfg_def.loaded_data_version)&&!pset["b4w_initial_rand_rotation"]&&!pset["b4w_hair_billboard"];var data_len=4;if(use_particles_rotation)data_len=8;if(psys["transforms"].length)var ptrans=psys["transforms"];else{var points=m_geometry.geometry_random_points(em_submesh,pset["count"],false,seed);var ptrans=new Float32Array(points.length*data_len);for(var j=
0;j<points.length;j++){var scale=.75+.5*m_util.rand_r(seed);ptrans[j*data_len]=points[j][0];ptrans[j*data_len+1]=points[j][1];ptrans[j*data_len+2]=points[j][2];ptrans[j*data_len+3]=scale;if(use_particles_rotation){ptrans[j*data_len+4]=1;ptrans[j*data_len+5]=0;ptrans[j*data_len+6]=0;ptrans[j*data_len+7]=0}}}var use_grass_map=m_scenegraph.find_subs(graph,"GRASS_MAP")?true:false;if(pset["render_type"]=="OBJECT"){var particles_batch_types=[get_batch_types(graph,pset["dupli_object"]._object.render,true)];
var hair_metabatches=make_hair_particles_metabatches(obj,render,emitter_vc,em_submesh,[pset["dupli_object"]._object],particles_batch_types,[ptrans],pset,psys,use_grass_map,seed,false);metabatches=metabatches.concat(hair_metabatches)}else if(pset["render_type"]=="GROUP"){var dg_objs=[];var bpy_dg_objs=pset["dupli_group"]["objects"];for(var j=0;j<bpy_dg_objs.length;j++)dg_objs.push(bpy_dg_objs[j]._object);var reset_seed=false;var particles_batch_types=[];for(var j=0;j<dg_objs.length;j++){var btypes=
get_batch_types(graph,pset["dupli_group"]["objects"][j]._object.render,true);particles_batch_types.push(btypes)}if(pset["use_whole_group"]){var ptrans_dist=distribute_ptrans_group(ptrans,dg_objs,use_particles_rotation,data_len);reset_seed=true}else if(pset["use_group_count"])var ptrans_dist=distribute_ptrans_by_dupli_weights(ptrans,dg_objs,pset["dupli_weights"],seed,use_particles_rotation,data_len);else var ptrans_dist=distribute_ptrans_equally(ptrans,dg_objs,seed,use_particles_rotation,data_len);
var hair_metabatches=make_hair_particles_metabatches(obj,render,emitter_vc,em_submesh,dg_objs,particles_batch_types,ptrans_dist,pset,psys,use_grass_map,seed,reset_seed);metabatches=metabatches.concat(hair_metabatches)}if(pset["b4w_wind_bend_inheritance"]=="INSTANCE"&&obj.render.wind_bending)m_print.warn('Emitter object "'+obj.name+'" has a particle'+" system with wind bending inheritance from the "+"particle instance. Wind bending on the emitter isn't "+"disabled. Expect unforeseen behavior.")}else throw"Unknown particle settings type";
}return metabatches}function select_psys_material(psys,materials){var mat_index=psys["settings"]["material"]-1;if(mat_index>=materials.length){m_print.warn("Wrong material used for rendering particle "+'system "'+psys["name"]+'"');mat_index=0}return materials[mat_index]}function merge_metabatches(metabatches){var merged_metabatches=[];var unique_data=[];var batches_ids={};for(var i=0;i<metabatches.length;i++){var batch=metabatches[i].batch;var render=metabatches[i].render;var batch_data=null;if(batch.id in
batches_ids){var index=batches_ids[batch.id];var collision_batch=unique_data[index].batch;var collision_render=unique_data[index].render;var canvas_context=null;var video_elements=null;for(var j=0;j<batch.textures.length;j++){var ctx=batch.textures[j].canvas_context;if(ctx){if(!canvas_context)canvas_context={};canvas_context[j]=ctx;batch.textures[j].canvas_context=null}var video=batch.textures[j].video_file;if(video){if(!video_elements)video_elements={};video_elements[j]=video;batch.textures[j].video_file=
null}}if(m_util.strict_objs_is_equal(batch,collision_batch,true)&&m_util.strict_objs_is_equal(render,collision_render,true))var batch_data=unique_data[index];if(canvas_context)for(var j in canvas_context)batch.textures[j].canvas_context=canvas_context[j];if(video_elements)for(var j in video_elements)batch.textures[j].video_file=video_elements[j];if(!batch_data){do batch.id++;while(batches_ids[batch.id])}}if(!batch_data){var batch_data={batch:batch,render:metabatches[i].render,rel_objects:[],submeshes:[],
mat_names:[]};batches_ids[batch.id]=unique_data.length;unique_data.push(batch_data)}batch_data.rel_objects=batch_data.rel_objects.concat(metabatches[i].rel_objects);if(metabatches[i].submesh&&metabatches[i].submesh.base_length)batch_data.submeshes.push(metabatches[i].submesh);if(batch_data.mat_names.length)for(var j=0;j<metabatches[i].mat_names.length;j++){var mat_name=metabatches[i].mat_names[j];if(batch_data.mat_names.indexOf(mat_name)==-1)batch_data.mat_names.push(mat_name)}else batch_data.mat_names=
metabatches[i].mat_names;m_geometry.sort_two_arrays(batch_data.mat_names,batch_data.submeshes,m_geometry.SORT_STRING,false)}for(var i=0;i<unique_data.length;i++){var submeshes=unique_data[i].submeshes;if(submeshes.length==0)var submesh=m_util.create_empty_submesh(m_util.unique_name("%empty"));else if(submeshes.length==1)var submesh=submeshes[0];else{var short_submeshes=[];for(var j=0;j<submeshes.length;j++)if(!m_geometry.is_long_submesh(submeshes[j]))short_submeshes.push(j);if(short_submeshes.length<
submeshes.length)for(var j=0;j<short_submeshes.length;j++)m_geometry.submesh_drop_indices(submeshes[short_submeshes[j]]);var submesh=m_geometry.submesh_list_join(submeshes)}var metabatch={batch:unique_data[i].batch,render:unique_data[i].render,submesh:submesh,mat_names:unique_data[i].mat_names,rel_objects:unique_data[i].rel_objects};merged_metabatches.push(metabatch)}return merged_metabatches}exports.set_local_cylinder_capsule=set_local_cylinder_capsule;function set_local_cylinder_capsule(render,
cyl_radius,cap_radius,bb_local){render.bcyl_local=m_bounds.create_bounding_cylinder(cyl_radius,bb_local);render.bcap_local=m_bounds.create_bounding_capsule(cap_radius,bb_local);render.bcon_local=m_bounds.create_bounding_cone(cyl_radius,bb_local)}exports.wb_angle_to_amp=wb_angle_to_amp;function wb_angle_to_amp(angle,bbox,scale){if(bbox)var height=scale*(bbox.max_y-bbox.min_y);else{var height=1;throw"No bounding box for mesh";}if(height==0)return 0;var delta=height*Math.tan(angle/180*Math.PI);var amp=
Math.sqrt(2*Math.sqrt(4*delta+1)+2)/2-1;return.5*amp/height}exports.bb_bpy_to_b4w=bb_bpy_to_b4w;function bb_bpy_to_b4w(bpy_bb){var max_x=bpy_bb["max_x"];var max_y=bpy_bb["max_y"];var max_z=bpy_bb["max_z"];var min_x=bpy_bb["min_x"];var min_y=bpy_bb["min_y"];var min_z=bpy_bb["min_z"];var bb={max_x:max_x,min_x:min_x,max_y:max_y,min_y:min_y,max_z:max_z,min_z:min_z};return bb}function exclude_batch_types(batch_types,unwanted_types){for(var i=0;i<unwanted_types.length;i++){var index=batch_types.indexOf(unwanted_types[i]);
if(index!==-1)batch_types.splice(index,1)}return batch_types}function get_batch_types(graph,render,is_hair_particles){var batch_types;if(render.do_not_render&&!is_hair_particles){batch_types=[];if(render.selectable&&m_scenegraph.find_subs(graph,"COLOR_PICKING"))batch_types.push("COLOR_ID")}else{batch_types=["MAIN","NODES_GLOW"];if((render.selectable&&m_scenegraph.find_subs(graph,"COLOR_PICKING")||render.outlining&&m_scenegraph.find_subs(graph,"OUTLINE_MASK"))&&!is_hair_particles)batch_types.push("COLOR_ID");
if(m_scenegraph.find_subs(graph,"WIREFRAME"))batch_types.push("WIREFRAME");if(m_scenegraph.find_subs(graph,"DEPTH")||m_scenegraph.find_subs(graph,"SHADOW_CAST"))batch_types.push("DEPTH");if(m_scenegraph.find_subs(graph,"GRASS_MAP"))batch_types.push("GRASS_MAP")}batch_types.push("PHYSICS");if(render.shadow_cast_only||render.reflexible_only){var unwanted_types=null;if(render.shadow_cast_only)unwanted_types=["MAIN","NODES_GLOW","COLOR_ID","PHYSICS","WIREFRAME"];if(render.reflexible_only){var types=["COLOR_ID",
"PHYSICS","DEPTH","WIREFRAME"];if(unwanted_types!==null)unwanted_types=m_util.array_intersect(unwanted_types,types);else unwanted_types=types}batch_types=exclude_batch_types(batch_types,unwanted_types)}return batch_types}function update_batch_material(batch,material,update_tex_color){var ret;switch(batch.type){case "MAIN":ret=update_batch_material_main(batch,material,update_tex_color);break;case "NODES_GLOW":ret=update_batch_material_nodes(batch,material,"GLOW");break;case "DEPTH":ret=update_batch_material_depth(batch,
material);break;case "PHYSICS":ret=update_batch_material_physics(batch,material);break;case "COLOR_ID":ret=update_batch_material_color_id(batch,material);break;case "GRASS_MAP":ret=update_batch_material_grass_map(batch,material);break;case "WIREFRAME":ret=update_batch_material_wireframe(batch,material);break;case "PARTICLES":ret=update_batch_material_particles(batch,material);break;default:throw"Wrong batch type: "+batch.type;}return ret}function update_batch_material_main(batch,material,update_tex_color){if(material["b4w_do_not_render"])return false;
if(material["use_nodes"]){update_batch_material_nodes(batch,material,"MAIN");return true}update_batch_game_settings(batch,material);var gs=material["game_settings"];var alpha_blend=gs["alpha_blend"];batch.xray=material["b4w_render_above_all"]&&alpha_blend!="OPAQUE"&&alpha_blend!="CLIP";batch.offset_z=material["offset_z"];batch.texture_scale.set([1,1,1]);var texture_slots=material["texture_slots"];m_vec4.set(material["diffuse_color"][0],material["diffuse_color"][1],material["diffuse_color"][2],material["alpha"],
batch.diffuse_color);switch(material["name"]){case "LENS_FLARES":apply_shader(batch,"special_lens_flares.glslv","special_lens_flares.glslf");set_batch_c_attr(batch,"a_position");set_batch_c_attr(batch,"a_texcoord");var tex_col=update_tex_color?[1,1,1,0]:null;var tex=get_batch_texture(texture_slots[0],tex_col);append_texture(batch,tex);break;default:apply_shader(batch,"main_stack.glslv","main_stack.glslf");if(!material["use_shadeless"]){var data={use_shadeless:material["use_shadeless"],diffuse_shader:material["diffuse_shader"],
specular_shader:material["specular_shader"]};var nmat_graph=m_nodemat.create_lighting_graph(material["uuid"],material["name"],data);batch.shaders_info.node_elements=m_nodemat.compose_node_elements(nmat_graph)}var colormaps=find_valid_textures("use_map_color_diffuse",true,texture_slots);var specmaps=find_valid_textures("use_map_color_spec",true,texture_slots);var normalmaps=find_valid_textures("use_map_normal",true,texture_slots);var mirrormaps=find_valid_textures("use_map_mirror",true,texture_slots);
var stencilmaps=find_valid_textures("use_stencil",true,texture_slots);var colormap0=colormaps[0];var specmap0=specmaps[0];var normalmap0=normalmaps[0];var mirrormap0=mirrormaps[0];var colormap1=colormaps[1];var stencil0=stencilmaps[0]&&find_valid_textures("use_rgb_to_intensity",true,texture_slots)[0];if(colormap0){switch(colormap0["blend_type"]){case "MIX":set_batch_directive(batch,"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MIX");break;case "MULTIPLY":set_batch_directive(batch,"TEXTURE_BLEND_TYPE",
"TEXTURE_BLEND_TYPE_MULTIPLY");break}if(colormap0["texture"]._render.source=="IMAGE"&&update_tex_color)var tex_col=[batch.diffuse_color[0],batch.diffuse_color[1],batch.diffuse_color[2],1];else if(colormap0["texture"]._render.source=="ENVIRONMENT_MAP"&&update_tex_color)var tex_col=[.8,.8,.8,1];else var tex_col=null;var tex=get_batch_texture(colormap0,tex_col);append_texture(batch,tex,"u_colormap0");if(cfg_def.alpha_clip_filtering_hack&&alpha_blend=="CLIP")m_textures.set_filters(tex,m_textures.TF_NEAREST,
m_textures.TF_NEAREST);batch.diffuse_color_factor=colormap0["diffuse_color_factor"];if(colormap0["use_map_alpha"])batch.alpha_factor=colormap0["alpha_factor"];else batch.alpha_factor=0;batch.texture_scale.set(colormap0["scale"])}var alpha_as_spec=colormap0&&colormap0==specmap0;if(specmap0){if(!alpha_as_spec){var tex_col=update_tex_color?[.5,.5,.5,1]:null;var tex=get_batch_texture(specmap0,tex_col);append_texture(batch,tex,"u_specmap0")}batch.specular_color_factor=specmap0["specular_color_factor"]}if(normalmap0){set_batch_c_attr(batch,
"a_normal");set_batch_c_attr(batch,"a_tangent");var tex_col=update_tex_color?[.5,.5,1,1]:null;var tex=get_batch_texture(normalmap0,tex_col);append_texture(batch,tex,"u_normalmap0");batch.normal_factor=normalmap0["normal_factor"];var nm0tex=normalmap0["texture"];if(nm0tex["b4w_use_map_parallax"]&&cfg_def.parallax){var steps=m_shaders.glsl_value(nm0tex["b4w_parallax_steps"]);var lod_dist=m_shaders.glsl_value(nm0tex["b4w_parallax_lod_dist"]);set_batch_directive(batch,"PARALLAX",1);set_batch_directive(batch,
"PARALLAX_STEPS",steps);set_batch_directive(batch,"PARALLAX_LOD_DIST",lod_dist);batch.parallax_scale=nm0tex["b4w_parallax_scale"]}}if(mirrormap0){var tex_col=update_tex_color?[0,0,.5,1]:null;var tex=get_batch_texture(mirrormap0,tex_col);append_texture(batch,tex,"u_mirrormap");batch.mirror_factor=mirrormap0["mirror_factor"]}var TEXTURE_STENCIL_ALPHA_MASK=colormap0&&colormap1&&stencil0?1:0;if(TEXTURE_STENCIL_ALPHA_MASK){var tex_col=update_tex_color?[.8,.8,.8,1]:null;var tex=get_batch_texture(colormap1,
tex_col);append_texture(batch,tex,"u_colormap1");var tex_col=update_tex_color?[.5,.5,.5,1]:null;var tex=get_batch_texture(stencil0,tex_col);append_texture(batch,tex,"u_stencil0")}var some_tex=colormap0||specmap0||normalmap0;if(some_tex)batch.texture_scale.set(some_tex["scale"]);set_batch_directive(batch,"TEXTURE_SPEC",specmap0==undefined?0:1);set_batch_directive(batch,"ALPHA_AS_SPEC",alpha_as_spec?1:0);set_batch_directive(batch,"TEXTURE_STENCIL_ALPHA_MASK",TEXTURE_STENCIL_ALPHA_MASK);set_batch_c_attr(batch,
"a_position");set_batch_c_attr(batch,"a_normal");if(colormap0||specmap0||normalmap0)set_batch_c_attr(batch,"a_texcoord");if(material["b4w_water"])init_water_material(material,batch);if(material["type"]==="HALO"){var mat_halo=material["halo"];apply_shader(batch,"halo.glslv","halo.glslf");set_batch_directive(batch,"NUM_RINGS",mat_halo["ring_count"]);set_batch_directive(batch,"NUM_LINES",mat_halo["line_count"]);set_batch_directive(batch,"NUM_STARS",mat_halo["star_tip_count"]);set_batch_directive(batch,
"SKY_STARS",material["b4w_halo_sky_stars"]?1:0);batch.common_attributes=["a_position"];batch.halo_size=mat_halo["size"];batch.halo_hardness=mat_halo["hardness"]/20;batch.halo_rings_color.set(mat_halo["b4w_halo_rings_color"]);batch.halo_lines_color.set(mat_halo["b4w_halo_lines_color"]);batch.halo_stars_blend=1/material["b4w_halo_stars_blend_height"];batch.halo_stars_height=material["b4w_halo_stars_min_height"];batch.halo=true}set_batch_directive(batch,"TEXCOORD",0);set_batch_directive(batch,"NORMAL_TEXCOORD",
0);if(colormap0)set_batch_texcoord_directive(batch,colormap0,"TEXTURE_COLOR0_CO");if(colormap1)set_batch_texcoord_directive(batch,colormap1,"TEXTURE_COLOR1_CO");if(stencil0)set_batch_texcoord_directive(batch,stencil0,"TEXTURE_STENCIL_ALPHA_MASK_CO");if(specmap0)set_batch_texcoord_directive(batch,specmap0,"TEXTURE_SPEC_CO");if(normalmap0)set_batch_texcoord_directive(batch,normalmap0,"TEXTURE_NORM_CO");set_batch_directive(batch,"SHADELESS",material["use_shadeless"]?1:0);batch.use_shadeless=material["use_shadeless"]}var alpha_blend=
material["game_settings"]["alpha_blend"];set_batch_directive(batch,"ALPHA",alpha_blend==="OPAQUE"?0:1);set_batch_directive(batch,"ALPHA_CLIP",alpha_blend==="CLIP"?1:0);set_batch_directive(batch,"DOUBLE_SIDED_LIGHTING",material["b4w_double_sided_lighting"]?1:0);if(material["use_vertex_color_paint"]){set_batch_directive(batch,"VERTEX_COLOR",1);set_batch_c_attr(batch,"a_color")}else set_batch_directive(batch,"VERTEX_COLOR",0);batch.ambient=material["ambient"];batch.diffuse_intensity=material["diffuse_intensity"];
batch.emit=material["emit"];batch.specular_color.set(material["specular_color"]);batch.specular_alpha=material["specular_alpha"];update_batch_specular_params(batch,material);update_batch_diffuse_params(batch,material);if(material["b4w_wettable"])set_batch_directive(batch,"WETTABLE",1);else set_batch_directive(batch,"WETTABLE",0);update_batch_fresnel_params(batch,material);batch.refractive=material["b4w_refractive"];batch.refr_bump=material["b4w_refr_bump"];return true}function set_batch_texcoord_directive(batch,
texture,directive_name){switch(texture["texture_coords"]){case "UV":case "ORCO":set_batch_directive(batch,directive_name,"TEXTURE_COORDS_UV_ORCO");set_batch_directive(batch,"TEXCOORD",1);break;case "NORMAL":set_batch_directive(batch,directive_name,"TEXTURE_COORDS_NORMAL");set_batch_directive(batch,"NORMAL_TEXCOORD",1);break;default:set_batch_directive(batch,directive_name,0)}}function update_batch_game_settings(batch,material){var gs=material["game_settings"];var alpha_blend=gs["alpha_blend"];switch(alpha_blend){case "ALPHA_SORT":batch.blend=
true;batch.zsort_type=m_geometry.ZSORT_BACK_TO_FRONT;batch.depth_mask=true;batch.alpha_clip=false;break;case "ALPHA":batch.blend=true;batch.zsort_type=m_geometry.ZSORT_DISABLED;batch.depth_mask=true;batch.alpha_clip=false;break;case "CLIP":batch.blend=false;batch.zsort_type=m_geometry.ZSORT_DISABLED;batch.depth_mask=true;batch.alpha_clip=true;break;case "ADD":batch.blend=true;batch.zsort_type=m_geometry.ZSORT_DISABLED;batch.depth_mask=false;batch.alpha_clip=false;break;case "OPAQUE":batch.blend=false;
batch.zsort_type=m_geometry.ZSORT_DISABLED;batch.depth_mask=true;batch.alpha_clip=false;break;default:throw new Error("Unknown alpha blend mode: "+alpha_blend);}batch.use_backface_culling=gs["use_backface_culling"]}exports.get_batch_texture=get_batch_texture;function get_batch_texture(texture_slot,color){var bpy_texture=texture_slot["texture"];var render=bpy_texture._render;var image=bpy_texture["image"];if(render&&color&&image)m_textures.update_texture(render,color,image._is_dds,image["filepath"]);
return render}function find_valid_textures(key,value,slots){var results=[];var len=slots.length;for(var i=0;i<len;i++){var slot=slots[i];if(slot[key]==value&&slot["texture"]&&slot["texture"]._render)results.push(slot)}return results}function init_water_material(material,batch){batch.water=true;batch.water_dynamic=material["b4w_water_dynamic"];if(material["b4w_water_shore_smoothing"]&&!batch.blend){m_print.warn('Material: "'+material["name"]+'" is opaque.',"Disabling shore smoothing.");batch.water_shore_smoothing=
false}else batch.water_shore_smoothing=material["b4w_water_shore_smoothing"];apply_shader(batch,"special_water.glslv","special_water.glslf");var data={use_shadeless:false,diffuse_shader:material["diffuse_shader"],specular_shader:material["specular_shader"]};var nmat_graph=m_nodemat.create_lighting_graph(material["uuid"],material["name"],data);batch.shaders_info.node_elements=m_nodemat.compose_node_elements(nmat_graph);set_batch_c_attr(batch,"a_position");if(cfg_def.water_wireframe_debug){set_batch_c_attr(batch,
"a_polyindex");batch.depth_mask=true;batch.wireframe_edge_color=[0,0,0];set_batch_directive(batch,"DEBUG_WIREFRAME",1)}else set_batch_directive(batch,"DEBUG_WIREFRAME",0);var texture_slots=material["texture_slots"];var normalmaps=find_valid_textures("use_map_normal",true,texture_slots);var mirrormap0=find_valid_textures("use_map_mirror",true,texture_slots)[0];if(normalmaps.length){var tex_nm=get_batch_texture(normalmaps[0]);append_texture(batch,tex_nm,"u_normalmap0");batch.water_norm_uv_velocity=
material["b4w_water_norm_uv_velocity"]}set_batch_directive(batch,"NUM_NORMALMAPS",normalmaps.length);batch.normalmap_scales=new Array(normalmaps.length);for(var i=0;i<normalmaps.length;i++){batch.normalmap_scales[i]=new Float32Array(2);batch.normalmap_scales[i].set([normalmaps[i]["scale"][0],normalmaps[i]["scale"][1]])}if(mirrormap0){var tex_mm=get_batch_texture(mirrormap0);append_texture(batch,tex_mm,"u_mirrormap");batch.mirror_factor=mirrormap0["mirror_factor"]}var foam=null;if(cfg_def.foam)for(var i=
0;i<texture_slots.length;i++){var texture=texture_slots[i];if(texture["texture"]["b4w_water_foam"]===true){foam=texture;break}}if(foam){set_batch_directive(batch,"FOAM",1);var tex_foam=get_batch_texture(foam);append_texture(batch,tex_foam,"u_foam");batch.foam_factor=material["b4w_foam_factor"];batch.foam_uv_freq.set(foam["texture"]["b4w_foam_uv_freq"]);batch.foam_mag.set(foam["texture"]["b4w_foam_uv_magnitude"]);batch.foam_scale[0]=foam["scale"][0];batch.foam_scale[1]=foam["scale"][1]}else set_batch_directive(batch,
"FOAM",0);for(var i=0;i<texture_slots.length;i++){var texture=texture_slots[i];if(texture["texture"]["b4w_shore_dist_map"]===true){var shore_dist_map=texture;break}}if(shore_dist_map&&cfg_def.allow_vertex_textures){var tex_shr0=get_batch_texture(shore_dist_map);append_texture(batch,tex_shr0,"u_shore_dist_map");set_batch_directive(batch,"SHORE_PARAMS",1);var sh_bounds=texture["texture"]["b4w_shore_boundings"];set_batch_directive(batch,"MAX_SHORE_DIST",m_shaders.glsl_value(texture["texture"]["b4w_max_shore_dist"]));
set_batch_directive(batch,"SHORE_MAP_SIZE_X",m_shaders.glsl_value(sh_bounds[0]-sh_bounds[1]));set_batch_directive(batch,"SHORE_MAP_SIZE_Y",m_shaders.glsl_value(sh_bounds[2]-sh_bounds[3]));set_batch_directive(batch,"SHORE_MAP_CENTER_X",m_shaders.glsl_value((sh_bounds[0]+sh_bounds[1])/2));set_batch_directive(batch,"SHORE_MAP_CENTER_Y",m_shaders.glsl_value((sh_bounds[2]+sh_bounds[3])/2))}else set_batch_directive(batch,"SHORE_PARAMS",0);if(material["b4w_generated_mesh"]&&cfg_def.depth_tex_available){set_batch_directive(batch,
"GENERATED_MESH",1);batch.water_generated_mesh=true;batch.water_num_cascads=material["b4w_water_num_cascads"];batch.water_subdivs=material["b4w_water_subdivs"];batch.water_detailed_dist=material["b4w_water_detailed_dist"]}else{set_batch_c_attr(batch,"a_normal");if(foam||normalmaps.length){set_batch_c_attr(batch,"a_texcoord");set_batch_c_attr(batch,"a_tangent")}set_batch_directive(batch,"GENERATED_MESH",0)}if(material["b4w_water_dynamic"]){var dst_noise_scale0=m_shaders.glsl_value(material["b4w_water_dst_noise_scale0"]);
var dst_noise_scale1=m_shaders.glsl_value(material["b4w_water_dst_noise_scale1"]);var dst_noise_freq0=m_shaders.glsl_value(material["b4w_water_dst_noise_freq0"]);var dst_noise_freq1=m_shaders.glsl_value(material["b4w_water_dst_noise_freq1"]);var dir_min_shore_fac=m_shaders.glsl_value(material["b4w_water_dir_min_shore_fac"]);var dir_freq=m_shaders.glsl_value(material["b4w_water_dir_freq"]);var dir_noise_scale=m_shaders.glsl_value(material["b4w_water_dir_noise_scale"]);var dir_noise_freq=m_shaders.glsl_value(material["b4w_water_dir_noise_freq"]);
var dir_min_noise_fac=m_shaders.glsl_value(material["b4w_water_dir_min_noise_fac"]);var dst_min_fac=m_shaders.glsl_value(material["b4w_water_dst_min_fac"]);var waves_hor_fac=m_shaders.glsl_value(material["b4w_water_waves_hor_fac"]);set_batch_directive(batch,"DST_NOISE_SCALE_0",dst_noise_scale0);set_batch_directive(batch,"DST_NOISE_SCALE_1",dst_noise_scale1);set_batch_directive(batch,"DST_NOISE_FREQ_0",dst_noise_freq0);set_batch_directive(batch,"DST_NOISE_FREQ_1",dst_noise_freq1);set_batch_directive(batch,
"DIR_MIN_SHR_FAC",dir_min_shore_fac);set_batch_directive(batch,"DIR_FREQ",dir_freq);set_batch_directive(batch,"DIR_NOISE_SCALE",dir_noise_scale);set_batch_directive(batch,"DIR_NOISE_FREQ",dir_noise_freq);set_batch_directive(batch,"DIR_MIN_NOISE_FAC",dir_min_noise_fac);set_batch_directive(batch,"DST_MIN_FAC",dst_min_fac);set_batch_directive(batch,"WAVES_HOR_FAC",waves_hor_fac)}update_batch_specular_params(batch,material);update_batch_diffuse_params(batch,material);batch.shallow_water_col.set(material["b4w_shallow_water_col"]);
batch.shore_water_col.set(material["b4w_shore_water_col"]);batch.shallow_water_col_fac=material["b4w_shallow_water_col_fac"];batch.shore_water_col_fac=material["b4w_shore_water_col_fac"];set_batch_directive(batch,"ABSORB",m_shaders.glsl_value(material["b4w_water_absorb_factor"]));set_batch_directive(batch,"SSS_STRENGTH",m_shaders.glsl_value(material["b4w_water_sss_strength"]));set_batch_directive(batch,"SSS_WIDTH",m_shaders.glsl_value(material["b4w_water_sss_width"]))}function update_batch_fresnel_params(batch,
material){var rt=material["raytrace_transparency"];batch.fresnel_params[0]=rt["fresnel"];batch.fresnel_params[1]=1-rt["fresnel_factor"]/5;var rm=material["raytrace_mirror"];batch.reflect_factor=rm["reflect_factor"];batch.fresnel_params[2]=rm["fresnel"];batch.fresnel_params[3]=1-rm["fresnel_factor"]/5}function update_batch_specular_params(batch,material){var spec_param_0;var spec_param_1=0;switch(material["specular_shader"]){case "PHONG":case "COOKTORR":spec_param_0=material["specular_hardness"];break;
case "WARDISO":spec_param_0=material["specular_slope"];break;case "TOON":spec_param_0=material["specular_toon_size"];spec_param_1=material["specular_toon_smooth"];break;case "BLINN":spec_param_0=material["specular_ior"];spec_param_1=material["specular_hardness"];break;default:m_print.error("unsupported specular shader: "+material["specular_shader"]+' (material "'+material["name"]+'")');spec_param_0=material["specular_hardness"];break}batch.specular_params[0]=material["specular_intensity"];batch.specular_params[1]=
spec_param_0;batch.specular_params[2]=spec_param_1}function update_batch_diffuse_params(batch,material){switch(material["diffuse_shader"]){case "LAMBERT":batch.diffuse_params[0]=0;batch.diffuse_params[1]=0;break;case "OREN_NAYAR":batch.diffuse_params[0]=material["roughness"];batch.diffuse_params[1]=0;break;case "FRESNEL":batch.diffuse_params[0]=material["diffuse_fresnel"];batch.diffuse_params[1]=material["diffuse_fresnel_factor"];break;case "MINNAERT":batch.diffuse_params[0]=material["darkness"];
batch.diffuse_params[1]=0;break;case "TOON":batch.diffuse_params[0]=material["diffuse_toon_size"];batch.diffuse_params[1]=material["diffuse_toon_smooth"];break;default:m_print.error("unsupported diffuse shader: "+material["diffuse_shader"]+' (material "'+material["name"]+'")');batch.diffuse_params[0]=0;batch.diffuse_params[1]=0;break}}function update_batch_material_nodes(batch,material,shader_type){if(!material["use_nodes"]||material["b4w_do_not_render"])return false;var is_glow_output;var use_color_edge;
switch(shader_type){case "MAIN":apply_shader(batch,"main.glslv","main.glslf");is_glow_output=false;use_color_edge=true;break;case "GLOW":apply_shader(batch,"main.glslv","main.glslf");is_glow_output=true;use_color_edge=true;break;case "DEPTH":apply_shader(batch,"depth.glslv","depth.glslf");is_glow_output=false;use_color_edge=false;break;case "COLOR_ID":apply_shader(batch,"color_id.glslv","color_id.glslf");is_glow_output=false;use_color_edge=false;break}var node_tree=material["node_tree"];var uuid=
material["uuid"];var nmat_graph=m_nodemat.compose_nmat_graph(node_tree,uuid,false,material["name"],shader_type);if(!nmat_graph){m_print.error('Failed to create node graph for material "'+material["name"]+'", disable nodes');update_batch_material_debug(batch,material);return true}batch.has_nodes=true;set_batch_directive(batch,"NODES",1);set_batch_directive(batch,"NODES_GLOW",is_glow_output?1:0);var alpha_blend=material["game_settings"]["alpha_blend"];set_batch_directive(batch,"ALPHA",alpha_blend===
"OPAQUE"?0:1);set_batch_directive(batch,"ALPHA_CLIP",alpha_blend==="CLIP"?1:0);set_batch_directive(batch,"DOUBLE_SIDED_LIGHTING",material["b4w_double_sided_lighting"]?1:0);set_batch_c_attr(batch,"a_position");if(material["use_orco_tex_coord"])set_batch_c_attr(batch,"a_orco_tex_coord");update_batch_game_settings(batch,material);batch.offset_z=material["offset_z"];var gs=material["game_settings"];var alpha_blend=gs["alpha_blend"];batch.xray=material["b4w_render_above_all"]&&alpha_blend!="OPAQUE"&&alpha_blend!=
"CLIP";m_vec4.set(material["diffuse_color"][0],material["diffuse_color"][1],material["diffuse_color"][2],material["alpha"],batch.diffuse_color);batch.emit=material["emit"];batch.ambient=material["ambient"];update_batch_fresnel_params(batch,material);if(material["b4w_wettable"])set_batch_directive(batch,"WETTABLE",1);else set_batch_directive(batch,"WETTABLE",0);batch.shaders_info.node_elements=m_nodemat.compose_node_elements(nmat_graph);var has_material_nodes=false;m_graph.traverse(nmat_graph,function(node,
attr){switch(attr.type){case "UVMAP":case "TEX_COORD_UV":case "GEOMETRY_UV":case "UV_MERGED":var name=attr.data.name;var uv_layer=attr.data.value;if(!batch.uv_maps_usage)batch.uv_maps_usage={};batch.uv_maps_usage[uv_layer]=name;break;case "GEOMETRY_VC":case "GEOMETRY_VC1":case "GEOMETRY_VC2":case "GEOMETRY_VC3":var name=attr.data.name;var vc_layer=attr.data.value;batch.vertex_colors_usage[name]={generate_buffer:true,src:[{name:vc_layer}]};var mask=0;if(attr.type=="GEOMETRY_VC")mask=7;else for(var i=
0;i<attr.outputs.length;i++){var index="RGB".indexOf(attr.outputs[i].identifier);if(index>-1)mask|=1<<2-index}batch.vertex_colors_usage[name].src[0].mask=mask;break;case "TEX_COORD_NO":case "GEOMETRY_NO":set_batch_c_attr(batch,"a_normal");break;case "MATERIAL_BEGIN":var mat_data=attr.data.value;set_batch_c_attr(batch,"a_normal");has_material_nodes=true;break;case "TEXTURE_COLOR":case "TEXTURE_ENVIRONMENT":var name=attr.data.name;var tex=attr.data.value;if(tex._render.allow_node_dds!==false)if(attr.type!=
"TEXTURE_ENVIRONMENT")tex._render.allow_node_dds=true;else tex._render.allow_node_dds=false;append_texture(batch,tex._render,name);if(cfg_def.alpha_clip_filtering_hack&&alpha_blend=="CLIP")m_textures.set_filters(attr.data.value._render,m_textures.TF_NEAREST,m_textures.TF_NEAREST);break;case "TEXTURE_NORMAL":case "B4W_PARALLAX":set_batch_directive(batch,"CALC_TBN_SPACE",1);set_batch_c_attr(batch,"a_normal");set_batch_c_attr(batch,"a_tangent");var name=attr.data.name;var tex=attr.data.value;tex._render.allow_node_dds=
false;append_texture(batch,tex._render,name);break;case "LAMP":if(attr.data)batch.lamp_uuid_indexes=attr.data;break;case "B4W_REFRACTION":batch.refractive=true;break}});if(!has_material_nodes)batch.use_shadeless=true;return true}exports.update_batch_material_debug=update_batch_material_debug;function update_batch_material_debug(batch,material){switch(batch.type){case "DEPTH":apply_shader(batch,"depth.glslv","depth.glslf");break;case "COLOR_ID":apply_shader(batch,"color_id.glslv","color_id.glslf");
break;default:apply_shader(batch,"main_stack.glslv","main_stack.glslf");break}set_batch_directive(batch,"SHADELESS",1);set_batch_c_attr(batch,"a_position");set_batch_c_attr(batch,"a_normal");m_vec4.set(1,0,1,1,batch.diffuse_color);if(material){var alpha_blend=material["game_settings"]["alpha_blend"];set_batch_directive(batch,"ALPHA",alpha_blend==="OPAQUE"?0:1);set_batch_directive(batch,"ALPHA_CLIP",alpha_blend==="CLIP"?1:0);set_batch_directive(batch,"VERTEX_COLOR",0);batch.offset_z=material["offset_z"];
update_batch_game_settings(batch,material)}return true}function update_batch_material_depth(batch,material){if(material["name"]==="LENS_FLARES"||material["b4w_water"]||material["b4w_do_not_render"]||material["type"]==="HALO")return false;update_batch_game_settings(batch,material);if(batch.blend)return false;var alpha_blend=material["game_settings"]["alpha_blend"];if(material["use_nodes"]&&alpha_blend=="CLIP")update_batch_material_nodes(batch,material,"DEPTH");else{apply_shader(batch,"depth.glslv",
"depth.glslf");m_vec4.set(material["diffuse_color"][0],material["diffuse_color"][1],material["diffuse_color"][2],material["alpha"],batch.diffuse_color)}set_batch_c_attr(batch,"a_position");set_batch_c_attr(batch,"a_normal");var alpha=alpha_blend==="OPAQUE"?0:1;set_batch_directive(batch,"ALPHA",alpha);batch.texture_scale.set([1,1,1]);var texture_slots=material["texture_slots"];var colormap0=find_valid_textures("use_map_color_diffuse",true,texture_slots)[0];var alpha_clip=alpha_blend==="CLIP"?1:0;if(colormap0&&
alpha_clip){batch.texture_scale.set(colormap0["scale"]);set_batch_directive(batch,"TEXTURE_COLOR",1);set_batch_c_attr(batch,"a_texcoord");if(colormap0["texture"]._render.source=="IMAGE"||colormap0["texture"]._render.source=="ENVIRONMENT_MAP"){var tex=get_batch_texture(colormap0);append_texture(batch,tex,"u_colormap0")}if(colormap0["texture"]._render.source=="NONE"){var tex=get_batch_texture(colormap0);append_texture(batch,tex,"u_colormap0")}}else set_batch_directive(batch,"TEXTURE_COLOR",0);return true}
function update_batch_material_physics(batch,material){if(material["b4w_collision"]){batch.use_ghost=material["b4w_use_ghost"];batch.collision_id=material["b4w_collision_id"];batch.collision_margin=material["b4w_collision_margin"];batch.collision_group=material["b4w_collision_group"];batch.collision_mask=material["b4w_collision_mask"];batch.friction=material["physics"]["friction"];batch.elasticity=material["physics"]["elasticity"];return true}else if(material["b4w_water"]){batch.water=true;batch.water_dynamics=
material["b4w_water_dynamic"];batch.dst_noise_scale0=material["b4w_water_dst_noise_scale0"];batch.dst_noise_scale1=material["b4w_water_dst_noise_scale1"];batch.dst_noise_freq0=material["b4w_water_dst_noise_freq0"];batch.dst_noise_freq1=material["b4w_water_dst_noise_freq1"];batch.dir_min_shore_fac=material["b4w_water_dir_min_shore_fac"];batch.dir_freq=material["b4w_water_dir_freq"];batch.dir_noise_scale=material["b4w_water_dir_noise_scale"];batch.dir_noise_freq=material["b4w_water_dir_noise_freq"];
batch.dir_min_noise_fac=material["b4w_water_dir_min_noise_fac"];batch.dst_min_fac=material["b4w_water_dst_min_fac"];batch.waves_hor_fac=material["b4w_water_waves_hor_fac"];return true}else return false}function update_batch_material_color_id(batch,material){if(material["name"]==="LENS_FLARES"||material["type"]==="HALO")return false;update_batch_game_settings(batch,material);batch.zsort_type=m_geometry.ZSORT_DISABLED;batch.depth_mask=true;batch.blend=false;var gs=material["game_settings"];var alpha_blend=
gs["alpha_blend"];batch.xray=material["b4w_render_above_all"]&&alpha_blend!="OPAQUE"&&alpha_blend!="CLIP";if(material["use_nodes"]&&alpha_blend=="CLIP")update_batch_material_nodes(batch,material,"COLOR_ID");else{apply_shader(batch,"color_id.glslv","color_id.glslf");m_vec4.set(material["diffuse_color"][0],material["diffuse_color"][1],material["diffuse_color"][2],material["alpha"],batch.diffuse_color)}set_batch_c_attr(batch,"a_position");var alpha=alpha_blend==="OPAQUE"?0:1;set_batch_directive(batch,
"ALPHA",alpha);batch.texture_scale.set([1,1,1]);var texture_slots=material["texture_slots"];var colormap0=find_valid_textures("use_map_color_diffuse",true,texture_slots)[0];var alpha_clip=alpha_blend==="CLIP"?1:0;if(colormap0&&alpha_clip){batch.texture_scale.set(colormap0["scale"]);set_batch_directive(batch,"TEXTURE_COLOR",1);set_batch_c_attr(batch,"a_texcoord");if(colormap0["texture"]._render.source=="IMAGE"||colormap0["texture"]._render.source=="ENVIRONMENT_MAP"){var tex=get_batch_texture(colormap0);
append_texture(batch,tex,"u_colormap0")}if(colormap0["texture"]._render.source=="NONE"){var tex=get_batch_texture(colormap0);append_texture(batch,tex,"u_colormap0")}}else set_batch_directive(batch,"TEXTURE_COLOR",0);return true}function update_batch_material_wireframe(batch,material){if(material["name"]==="LENS_FLARES"||material["b4w_water"]||material["b4w_do_not_render"]||material["type"]==="HALO")return false;apply_shader(batch,"wireframe.glslv","wireframe.glslf");set_batch_c_attr(batch,"a_position");
set_batch_c_attr(batch,"a_normal");set_batch_c_attr(batch,"a_polyindex");batch.depth_mask=true;batch.wireframe_mode=0;batch.wireframe_edge_color=[0,0,0];return true}function update_batch_material_grass_map(batch,material){if(!material["b4w_terrain"]||material["b4w_do_not_render"])return false;update_batch_game_settings(batch,material);batch.blend=false;batch.zsort_type=m_geometry.ZSORT_DISABLED;batch.depth_mask=true;apply_shader(batch,"grass_map.glslv","grass_map.glslf");set_batch_c_attr(batch,"a_position");
if(material["b4w_dynamic_grass_size"])var vc_usage_gr_size=material["b4w_dynamic_grass_size"];else var vc_usage_gr_size=null;if(material["b4w_dynamic_grass_color"])var vc_usage_gr_color=material["b4w_dynamic_grass_color"];else var vc_usage_gr_color=null;batch.vertex_colors_usage["a_grass_size"]={generate_buffer:true,src:[]};if(vc_usage_gr_size){batch.vertex_colors_usage["a_grass_size"].src.push({name:vc_usage_gr_size,mask:4});set_batch_directive(batch,"DYNAMIC_GRASS_SIZE",1)}else set_batch_directive(batch,
"DYNAMIC_GRASS_SIZE",0);batch.vertex_colors_usage["a_grass_color"]={generate_buffer:true,src:[]};if(vc_usage_gr_color){batch.vertex_colors_usage["a_grass_color"].src.push({name:vc_usage_gr_color,mask:7});set_batch_directive(batch,"DYNAMIC_GRASS_COLOR",1)}else set_batch_directive(batch,"DYNAMIC_GRASS_COLOR",0);return true}function update_batch_material_particles(batch,material){if(material["b4w_do_not_render"])return false;var texture_slots=material["texture_slots"];if(batch.halo_particles)apply_shader(batch,
"particles_color.glslv","particles_color.glslf");else{apply_shader(batch,"particles_texture.glslv","particles_texture.glslf");var data={use_shadeless:false,diffuse_shader:material["diffuse_shader"],specular_shader:material["specular_shader"]};var nmat_graph=m_nodemat.create_lighting_graph(material["uuid"],material["name"],data);batch.shaders_info.node_elements=m_nodemat.compose_node_elements(nmat_graph);var colormap=find_valid_textures("use_map_color_diffuse",true,texture_slots)[0];if(colormap){set_batch_directive(batch,
"TEXTURE_COLOR",1);switch(colormap["blend_type"]){case "MIX":set_batch_directive(batch,"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MIX");break;case "MULTIPLY":set_batch_directive(batch,"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MULTIPLY");break}batch.diffuse_color_factor=colormap["diffuse_color_factor"];if(colormap["use_map_alpha"])batch.alpha_factor=colormap["alpha_factor"];else batch.alpha_factor=0;var tex=get_batch_texture(colormap);append_texture(batch,tex)}}m_vec4.set(material["diffuse_color"][0],
material["diffuse_color"][1],material["diffuse_color"][2],material["alpha"],batch.diffuse_color);batch.ambient=material["ambient"];batch.diffuse_intensity=material["diffuse_intensity"];batch.emit=material["emit"];batch.specular_color.set(material["specular_color"]);batch.specular_alpha=material["specular_alpha"];set_batch_c_attr(batch,"a_position");set_batch_c_attr(batch,"a_normal");var alpha_blend=material["game_settings"]["alpha_blend"];set_batch_directive(batch,"ALPHA",alpha_blend==="OPAQUE"?0:
1);set_batch_directive(batch,"ALPHA_CLIP",alpha_blend==="CLIP"?1:0);set_batch_directive(batch,"PARTICLES_SHADELESS",material["use_shadeless"]?1:0);update_batch_specular_params(batch,material);update_batch_diffuse_params(batch,material);update_batch_game_settings(batch,material);var gs=material["game_settings"];var alpha_blend=gs["alpha_blend"];batch.xray=material["b4w_render_above_all"]&&alpha_blend!="OPAQUE"&&alpha_blend!="CLIP";batch.offset_z=material["offset_z"];return true}function update_batch_render(batch,
render){if(batch.type==="PHYSICS")return;if(render.type=="DYNAMIC"){if(render.is_hair_particles)set_batch_directive(batch,"AU_QUALIFIER","attribute");else set_batch_directive(batch,"AU_QUALIFIER","uniform");set_batch_directive(batch,"STATIC_BATCH",0)}else{set_batch_directive(batch,"AU_QUALIFIER","attribute");set_batch_directive(batch,"STATIC_BATCH",1)}if(batch.type=="WIREFRAME"){if(m_extensions.get_standard_derivatives())set_batch_directive(batch,"WIREFRAME_QUALITY",1);else set_batch_directive(batch,
"WIREFRAME_QUALITY",0);if(batch.debug_sphere){set_batch_directive(batch,"DEBUG_SPHERE",1);if(batch.debug_sphere_dynamic)set_batch_directive(batch,"DEBUG_SPHERE_DYNAMIC",1);else set_batch_directive(batch,"DEBUG_SPHERE_DYNAMIC",0)}else set_batch_directive(batch,"DEBUG_SPHERE",0);set_batch_directive(batch,"ALPHA",1)}if(render.use_shape_keys)batch.use_shape_keys=render.use_shape_keys;if(render.wind_bending){if(render.main_bend_col!==""){batch.vertex_colors_usage["a_bending_col_main"]={generate_buffer:true,
src:[{name:render.main_bend_col,mask:4}]};set_batch_c_attr(batch,"a_bending_col_main");if(render.detail_bend_col.leaves_stiffness!==""&&render.detail_bend_col.leaves_phase!==""&&render.detail_bend_col.overall_stiffness!==""){batch.vertex_colors_usage["a_bending_col_detail"]={generate_buffer:true,src:[{name:render.detail_bend_col.leaves_stiffness,mask:4},{name:render.detail_bend_col.leaves_phase,mask:2},{name:render.detail_bend_col.overall_stiffness,mask:1}]};set_batch_c_attr(batch,"a_bending_col_detail");
set_batch_c_attr(batch,"a_normal");set_batch_directive(batch,"DETAIL_BEND",1)}else set_batch_directive(batch,"DETAIL_BEND",0);set_batch_directive(batch,"MAIN_BEND_COL",1)}else set_batch_directive(batch,"MAIN_BEND_COL",0);set_batch_directive(batch,"WIND_BEND",1)}else set_batch_directive(batch,"WIND_BEND",0);if(render.bend_center_only)set_batch_directive(batch,"BEND_CENTER_ONLY",1);else set_batch_directive(batch,"BEND_CENTER_ONLY",0);set_batch_directive(batch,"BILLBOARD_PRES_GLOB_ORIENTATION",render.billboard_pres_glob_orientation|
0);if(render.billboard)set_batch_directive(batch,"BILLBOARD",1);else set_batch_directive(batch,"BILLBOARD",0);if(render.billboard&&render.is_hair_particles)set_batch_directive(batch,"HAIR_BILLBOARD",1);else set_batch_directive(batch,"HAIR_BILLBOARD",0);if(render.billboard_spherical)set_batch_directive(batch,"BILLBOARD_SPHERICAL",1);else set_batch_directive(batch,"BILLBOARD_SPHERICAL",0);switch(render.billboard_type){case "RANDOM":set_batch_directive(batch,"BILLBOARD_RANDOM",1);set_batch_directive(batch,
"BILLBOARD_JITTERED",0);break;case "JITTERED":set_batch_directive(batch,"BILLBOARD_RANDOM",0);set_batch_directive(batch,"BILLBOARD_JITTERED",1);break;default:set_batch_directive(batch,"BILLBOARD_RANDOM",0);set_batch_directive(batch,"BILLBOARD_JITTERED",0);break}if(render.dynamic_grass&&cfg_def.allow_vertex_textures)set_batch_directive(batch,"DYNAMIC_GRASS",1);else set_batch_directive(batch,"DYNAMIC_GRASS",0);batch.dynamic_grass=render.dynamic_grass;batch.dynamic_geometry=render.dynamic_geometry;batch.shadow_cast=
render.shadow_cast;batch.shadow_cast_only=render.shadow_cast_only;batch.shadow_receive=render.shadow_receive&&!batch.use_shadeless&&!(batch.blend&&cfg_def.disable_blend_shadows_hack);batch.reflexible=render.reflexible;batch.reflexible_only=render.reflexible_only;batch.reflective=render.reflective;if(render.is_skinning){set_batch_c_attr(batch,"a_influence");set_batch_directive(batch,"SKINNED",1);if(render.frames_blending)set_batch_directive(batch,"FRAMES_BLENDING",1);else set_batch_directive(batch,
"FRAMES_BLENDING",0);set_batch_directive(batch,"MAX_BONES",render.max_bones)}else{set_batch_directive(batch,"SKINNED",0);set_batch_directive(batch,"FRAMES_BLENDING",0)}if(render.vertex_anim){set_batch_directive(batch,"VERTEX_ANIM",1);if(cfg_def.vert_anim_mix_normals_hack)set_batch_directive(batch,"VERTEX_ANIM_MIX_NORMALS_FACTOR",.5);else set_batch_directive(batch,"VERTEX_ANIM_MIX_NORMALS_FACTOR","u_va_frame_factor")}else set_batch_directive(batch,"VERTEX_ANIM",0);if(render.is_skinning&&render.vertex_anim)throw"Skinning and vertex animation are mutually exlusive";
if(render.disable_fogging)set_batch_directive(batch,"DISABLE_FOG",1);else set_batch_directive(batch,"DISABLE_FOG",0);if(batch.has_nodes){var nmat_graph=batch.shaders_info.node_elements;var mats_value_inds=render.mats_value_inds;var mats_rgb_inds=render.mats_rgb_inds;for(var i=0;i<nmat_graph.length;i++){var node=nmat_graph[i];switch(node.id){case "VALUE":var ind=node.param_values[0];if(ind)for(var j=0;j<mats_value_inds.length;j+=2)if(mats_value_inds[j]==ind){node.dirs.push(["VALUE_IND",mats_value_inds[j+
1]]);break}break;case "RGB":var ind=node.param_values[0];if(ind)for(var j=0;j<mats_rgb_inds.length;j+=2)if(mats_rgb_inds[j]==ind){node.dirs.push(["RGB_IND",mats_rgb_inds[j+1]]);break}break;default:}}set_batch_directive(batch,"NUM_VALUES",render.mats_values.length);set_batch_directive(batch,"NUM_RGBS",render.mats_rgbs.length)}}exports.update_batch_lights=update_batch_lights;function update_batch_lights(batch,lamps,scene){if(!lamps.length)return;var shadow_lamp=m_obj_util.get_first_lamp_with_shadows(lamps)||
lamps[0];var shaders_info=batch.shaders_info;var lamp_index=0;for(var i=0;i<batch.shaders_info.node_elements.length;i++){var node=batch.shaders_info.node_elements[i];if(node.id=="LIGHTING_LAMP"){var lamp=lamps[lamp_index++%lamps.length];var light=lamp.light;if(light.type=="AREA"){lamp=lamps[lamp_index++%lamps.length];light=lamp.light}var lamp_sc_data=m_obj_util.get_scene_data(lamp,scene);if(light.type=="SPOT"||light.type=="POINT")var sp_size=Math.cos(light.spot_size/2);if(light.type=="SPOT")var blend=
light.spot_blend*(1-sp_size);var index=lamp_sc_data.light_index;var lfac_index=Math.floor(index/2);var lfac_channels=index%2==0?"rg":"ba";if(lamp==shadow_lamp)var shadow_map_ind=0;else var shadow_map_ind=-1;node.dirs=[["LAMP_TYPE",light.type],["LAMP_IND",index],["LAMP_LIGHT_FACT_IND",lfac_index],["LAMP_FAC_CHANNELS",lfac_channels],["LAMP_SPOT_SIZE",m_shaders.glsl_value(sp_size||.01)],["LAMP_SPOT_BLEND",m_shaders.glsl_value(blend||.01)],["LAMP_LIGHT_DIST",m_shaders.glsl_value(light.distance)],["LAMP_SHADOW_MAP_IND",
shadow_map_ind]]}}if(batch.lamp_uuid_indexes){var lamp_size=0;for(var key in batch.lamp_uuid_indexes)lamp_size++;batch.lamp_light_positions=new Float32Array(lamp_size*3);batch.lamp_light_directions=new Float32Array(lamp_size*3);batch.lamp_light_color_intensities=new Float32Array(lamp_size*3);batch.lamp_light_factors=new Float32Array(lamp_size*4);m_shaders.set_directive(shaders_info,"NUM_LAMP_LIGHTS",lamp_size);for(var i=0;i<lamps.length;i++)set_lamp_data(batch,lamps[i])}}exports.set_lamp_data=set_lamp_data;
function set_lamp_data(batch,lamp){var lamp_uuid=lamp.temp_bpy_obj["uuid"];if(lamp_uuid in batch.lamp_uuid_indexes){var data_lamp_index=batch.lamp_uuid_indexes[lamp_uuid];batch.lamp_light_positions.set(lamp.render.trans,data_lamp_index*3);batch.lamp_light_directions.set(lamp.light.direction,data_lamp_index*3);batch.lamp_light_color_intensities.set(lamp.light.color_intensity,data_lamp_index*3);var light_factor=_vec4_tmp;prepare_lamp_light_factor(lamp.light,light_factor);batch.lamp_light_factors.set(light_factor,
data_lamp_index*4)}}function prepare_lamp_light_factor(light,light_factor){light_factor[0]=-1;light_factor[1]=-1;light_factor[2]=-1;light_factor[3]=light.use_specular?1:0;switch(light.type){case "POINT":light_factor[2]=light.distance;break;case "SPOT":light_factor[2]=light.distance;var sp_size=light_factor[0]=Math.cos(light.spot_size/2);light_factor[1]=light.spot_blend*(1-sp_size);break}}function update_batch_particle_systems(batch,psystems){for(var i=0;i<psystems.length;i++){var emitter_col_name=
psystems[i]["settings"]["b4w_vcol_from_name"];var particle_col_name=psystems[i]["settings"]["b4w_vcol_to_name"];if(emitter_col_name!==""&&particle_col_name!=="")batch.vertex_colors_usage[emitter_col_name]={generate_buffer:false,src:[{name:emitter_col_name,mask:7}]}}}exports.assign_shadow_receive_dirs=function(batch,shadow_params,subs_cast){if(subs_cast&&subs_cast.camera.type==m_cam.TYPE_PERSP)set_batch_directive(batch,"PERSPECTIVE_SHADOW_CAST",1);set_batch_directive(batch,"CSM_SECTION0",0);set_batch_directive(batch,
"CSM_SECTION1",0);set_batch_directive(batch,"CSM_SECTION2",0);set_batch_directive(batch,"CSM_SECTION3",0);if(shadow_params){for(var i=0;i<shadow_params.csm_num;i++)set_batch_directive(batch,"CSM_SECTION"+String(i),1);set_batch_directive(batch,"SHADOW_TEX_RES",m_shaders.glsl_value(shadow_params.csm_resolution));set_batch_directive(batch,"CSM_FADE_LAST_CASCADE",shadow_params.fade_last_cascade?1:0);set_batch_directive(batch,"CSM_BLEND_BETWEEN_CASCADES",shadow_params.blend_between_cascades?1:0)}else{set_batch_directive(batch,
"SHADOW_TEX_RES",0);set_batch_directive(batch,"CSM_FADE_LAST_CASCADE",0);set_batch_directive(batch,"CSM_BLEND_BETWEEN_CASCADES",0)}};function set_batch_c_attr(batch,name){var cattrs=batch.common_attributes;if(cattrs.indexOf(name)==-1)cattrs.push(name)}exports.set_batch_directive=set_batch_directive;function set_batch_directive(batch,name,value){m_shaders.set_directive(batch.shaders_info,name,value)}exports.get_batch_directive=get_batch_directive;function get_batch_directive(batch,name){return m_shaders.get_directive(batch.shaders_info,
name)}exports.update_batch_geometry=update_batch_geometry;function update_batch_geometry(batch,submesh){if(batch.type=="PHYSICS"){batch.submesh=submesh;return}var zsort_type=batch.zsort_type;var draw_mode=batch.draw_mode;if(batch.halo)var submesh=m_geometry.extract_halo_submesh(submesh);if(batch.water_generated_mesh){var num_cascads=batch.water_num_cascads;var subdivs=batch.water_subdivs;var detailed_dist=batch.water_detailed_dist;var submesh=m_primitives.generate_multigrid(num_cascads,subdivs,detailed_dist)}var bufs_data=
m_geometry.submesh_to_bufs_data(submesh,zsort_type,draw_mode,batch.vertex_colors_usage);batch.bufs_data=bufs_data;if(!(DEBUG_KEEP_BUFS_DATA_ARRAYS||batch.dynamic_geometry||bufs_data.info_for_z_sort_updates||batch.use_shape_keys)){bufs_data.ibo_array=null;bufs_data.vbo_array=null}var frames=submesh.va_frames.length;batch.num_vertices=submesh.base_length*frames;if(is_triangle_batch(batch))if(m_geometry.is_indexed(submesh))batch.num_triangles=submesh.indices.length/3*frames;else batch.num_triangles=
submesh.base_length/3*frames;else batch.num_triangles=0;if(DEBUG_SAVE_SUBMESHES)batch.submesh=submesh}function is_triangle_batch(batch){switch(batch.draw_mode){case m_geometry.DM_DEFAULT:case m_geometry.DM_TRIANGLES:case m_geometry.DM_DYNAMIC_TRIANGLES:return true;default:return false}}function update_batch_particles_emitter(batch,psystem){var pset=psystem["settings"];switch(pset["b4w_billboard_align"]){case "VIEW":set_batch_directive(batch,"BILLBOARD_ALIGN","BILLBOARD_ALIGN_VIEW");break;case "XY":set_batch_directive(batch,
"BILLBOARD_ALIGN","BILLBOARD_ALIGN_XY");break;case "YZ":set_batch_directive(batch,"BILLBOARD_ALIGN","BILLBOARD_ALIGN_YZ");break;case "ZX":set_batch_directive(batch,"BILLBOARD_ALIGN","BILLBOARD_ALIGN_ZX");break;default:throw"Wrong billboard align value";break}set_batch_directive(batch,"BILLBOARD",0);var enable_softness=pset["b4w_enable_soft_particles"]&&pset["b4w_particles_softness"]>0&&cfg_def.depth_tex_available;set_batch_directive(batch,"SOFT_PARTICLES",enable_softness?1:0);set_batch_directive(batch,
"SOFT_STRENGTH",m_shaders.glsl_value(pset["b4w_particles_softness"]));var world_space=pset["b4w_coordinate_system"]=="WORLD"?1:0;m_shaders.set_directive(batch.shaders_info,"WORLD_SPACE",world_space)}function make_hair_particles_metabatches(em_obj,render,emitter_vc,em_submesh,objs,batch_types_arr,objs_ptrans,pset,psys,use_grass_map,seed,reset_seed){var metabatches=[];var dyn_grass=pset["b4w_dynamic_grass"];if(!use_grass_map&&dyn_grass)return metabatches;var inst_inherit_bend=pset["b4w_wind_bend_inheritance"]==
"INSTANCE";var inst_inherit_shadow=pset["b4w_shadow_inheritance"]=="INSTANCE";var inst_inherit_reflection=pset["b4w_reflection_inheritance"]=="INSTANCE";var objs_hair_render=[];var objs_tsr_array=[];for(var i=0;i<objs.length;i++){var obj=objs[i];var hair_render=m_util.clone_object_nr(render);hair_render.billboard=pset["b4w_hair_billboard"];hair_render.billboard_type=pset["b4w_hair_billboard_type"];hair_render.billboard_spherical=pset["b4w_hair_billboard_geometry"]=="SPHERICAL";hair_render.dynamic_grass=
dyn_grass;hair_render.is_hair_particles=true;hair_render.mats_values=obj.render.mats_values;hair_render.mats_value_inds=obj.render.mats_value_inds;hair_render.mats_rgbs=obj.render.mats_rgbs;hair_render.mats_rgb_inds=obj.render.mats_rgb_inds;if(inst_inherit_bend){hair_render.wind_bending=obj.render.wind_bending;hair_render.wind_bending_angle=obj.render.wind_bending_angle;hair_render.wind_bending_freq=obj.render.wind_bending_freq;hair_render.detail_bending_freq=obj.render.detail_bending_freq;hair_render.main_bend_col=
obj.render.main_bend_col;hair_render.detail_bending_amp=obj.render.detail_bending_amp;hair_render.branch_bending_amp=obj.render.branch_bending_amp;hair_render.wind_bending_amp=obj.render.wind_bending_amp;hair_render.detail_bend_col=obj.render.detail_bend_col;hair_render.bend_center_only=false}else{hair_render.wind_bending=em_obj.render.wind_bending;hair_render.wind_bending_angle=em_obj.render.wind_bending_angle;hair_render.wind_bending_freq=em_obj.render.wind_bending_freq;hair_render.detail_bending_freq=
em_obj.render.detail_bending_freq;hair_render.main_bend_col=em_obj.render.main_bend_col;hair_render.detail_bending_amp=em_obj.render.detail_bending_amp;hair_render.branch_bending_amp=em_obj.render.branch_bending_amp;hair_render.wind_bending_amp=em_obj.render.wind_bending_amp;hair_render.detail_bend_col=em_obj.render.detail_bend_col;hair_render.bend_center_only=true}if(inst_inherit_shadow){hair_render.shadow_cast=obj.render.shadow_cast;hair_render.shadow_cast_only=obj.render.shadow_cast_only;hair_render.shadow_receive=
obj.render.shadow_receive}else{hair_render.shadow_cast=em_obj.render.shadow_cast;hair_render.shadow_cast_only=em_obj.render.shadow_cast_only;hair_render.shadow_receive=em_obj.render.shadow_receive}if(inst_inherit_reflection){hair_render.reflexible=obj.render.reflexible;hair_render.reflexible_only=obj.render.reflexible_only;hair_render.reflective=obj.render.reflective;hair_render.cube_reflection_id=obj.render.cube_reflection_id;hair_render.plane_reflection_id=obj.render.plane_reflection_id;hair_render.reflection_type=
obj.render.reflection_type}else{hair_render.reflexible=em_obj.render.reflexible;hair_render.reflexible_only=em_obj.render.reflexible_only;hair_render.reflective=em_obj.render.reflective;hair_render.cube_reflection_id=em_obj.render.cube_reflection_id;hair_render.plane_reflection_id=em_obj.render.plane_reflection_id;hair_render.reflection_type=em_obj.render.reflection_type}objs_hair_render.push(hair_render);var ptrans=objs_ptrans[i];if(!ptrans)ptrans=new Float32Array;if(reset_seed)m_util.init_rand_r_seed(psys["seed"],
seed);var trans=new Float32Array(3);var quat=new Float32Array([0,0,0,1]);var tsr_array=[];var use_particles_rotation=m_reformer.check_particles_bin_format(cfg_def.loaded_data_version)&&!pset["b4w_initial_rand_rotation"]&&!pset["b4w_hair_billboard"];var data_len=4;if(use_particles_rotation)data_len=8;for(var j=0;j<ptrans.length;j+=data_len){trans[0]=ptrans[j];trans[1]=ptrans[j+1];trans[2]=ptrans[j+2];var scale=ptrans[j+3]*obj.render.scale;if(pset["b4w_initial_rand_rotation"]){switch(pset["b4w_rotation_type"]){case "XYZ":var axis=
new Float32Array([m_util.rand_r(seed),m_util.rand_r(seed),m_util.rand_r(seed)]);m_vec3.normalize(axis,axis);break;case "Z":var axis=new Float32Array([0,1,0]);break;default:throw"Unsupported random rotation type: "+pset["b4w_rotation_type"];break}var strength=pset["b4w_rand_rotation_strength"];m_quat.setAxisAngle(axis,strength*(2*Math.PI*m_util.rand_r(seed)-Math.PI),quat)}else if(use_particles_rotation){quat.set(ptrans.subarray(j+4,j+8));m_util.quat_bpy_b4w(quat,quat);if(!pset["use_whole_group"])if(pset["use_rotation_dupli"])m_quat.multiply(quat,
obj.render.quat,quat);else m_quat.multiply(quat,DEFAULT_PART_SYS_QUAT,quat)}var tsr=m_tsr.create_sep(trans,scale,quat);tsr_array.push(tsr)}objs_tsr_array.push(tsr_array)}var spatial_tree={};for(var i=0;i<objs.length;i++){var obj=objs[i];var bpy_obj=obj.temp_bpy_obj;var btypes=batch_types_arr[i];var hair_render=objs_hair_render[i];var submesh_params={};if(hair_render.wind_bending){submesh_params["au_wind_bending_amp"]=[hair_render.wind_bending_amp];submesh_params["au_wind_bending_freq"]=[hair_render.wind_bending_freq];
submesh_params["au_detail_bending_freq"]=[hair_render.detail_bending_freq];submesh_params["au_detail_bending_amp"]=[hair_render.detail_bending_amp];submesh_params["au_branch_bending_amp"]=[hair_render.branch_bending_amp];hair_render.wind_bending_amp=0;hair_render.wind_bending_freq=0;hair_render.detail_bending_freq=0;hair_render.detail_bending_amp=0;hair_render.branch_bending_amp=0}var hair_render_id=calculate_render_id(hair_render);var tsr_array=objs_tsr_array[i];if(!tsr_array.length)continue;var mesh=
bpy_obj["data"];var materials=mesh["materials"];var batches_main=new Array(materials.length);for(var j=0;j<materials.length;j++){if(m_geometry.has_empty_submesh(mesh,j))continue;for(var k=0;k<btypes.length;k++){var type=btypes[k];var batch=init_batch(type);var material=materials[j];if(type=="COLOR_ID")batch.can_fork_outline=!(bpy_obj["b4w_do_not_render"]||material["b4w_do_not_render"]);if(type=="MAIN")batches_main[j]=batch;if(!batch_material_is_valid(batch,material))continue;if(type=="DEPTH"&&batches_main[j])batch.use_shadeless=
batches_main[j].use_shadeless;batch.draw_mode=m_geometry.DM_DEFAULT;update_batch_render(batch,hair_render);batch.odd_id_prop=pset["uuid"];if(pset["b4w_hair_billboard_type"]=="JITTERED"){batch.jitter_amp=pset["b4w_hair_billboard_jitter_amp"];batch.jitter_freq=pset["b4w_hair_billboard_jitter_freq"]}if(dyn_grass)batch.grass_scale_threshold=pset["b4w_dynamic_grass_scale_threshold"];if(!inst_inherit_bend){delete batch.vertex_colors_usage["a_bending_col_main"];delete batch.vertex_colors_usage["a_bending_col_detail"]}update_batch_id(batch,
hair_render_id);var src_submesh=m_geometry.extract_submesh(mesh,j,batch.common_attributes,render.bone_skinning_info,batch.vertex_colors_usage,batch.uv_maps_usage);var submesh=m_geometry.make_clone_submesh(src_submesh,submesh_params,tsr_array);submesh=fill_submesh_center_pos(submesh,tsr_array);if(hair_render.wind_bending&&hair_render.bend_center_only)submesh=fill_submesh_emitter_center(submesh,em_obj.render.world_matrix);var particle_inherited_attrs=get_particle_inherited_attrs(pset["b4w_vcol_from_name"],
pset["b4w_vcol_to_name"],batch,emitter_vc,!inst_inherit_bend,mesh);submesh=make_particle_inherited_vcols(submesh,tsr_array,em_obj.render.bb_local,em_submesh,particle_inherited_attrs,batch.vertex_colors_usage,spatial_tree);metabatches.push({batch:batch,submesh:submesh,mat_names:[material["name"]],render:hair_render,rel_objects:[em_obj]})}}}return metabatches}function batch_material_is_valid(batch,material){var is_valid=true;if(batch.type=="NODES_GLOW")is_valid=m_nodemat.check_material_glow_output(material);
is_valid=is_valid&&update_batch_material(batch,material);return is_valid}function make_spatial_tree(spatial_tree,obj_bb_local,positions){spatial_tree.cell_size=new Float32Array(3);spatial_tree.base_point=new Float32Array(3);spatial_tree.verts_indices=new Uint32Array(positions.length/3);spatial_tree.octs_indices=new Uint32Array(positions.length/3);spatial_tree.cell_size[0]=(obj_bb_local.max_x-obj_bb_local.min_x)/STREE_CELL_COUNT;spatial_tree.cell_size[1]=(obj_bb_local.max_y-obj_bb_local.min_y)/STREE_CELL_COUNT;
spatial_tree.cell_size[2]=(obj_bb_local.max_z-obj_bb_local.min_z)/STREE_CELL_COUNT;spatial_tree.base_point[0]=obj_bb_local.min_x;spatial_tree.base_point[1]=obj_bb_local.min_y;spatial_tree.base_point[2]=obj_bb_local.min_z;for(var i=0;i<positions.length/3;i++){var x=positions[i*3];var y=positions[i*3+1];var z=positions[i*3+2];var num_x=m_util.trunc((x-spatial_tree.base_point[0])/spatial_tree.cell_size[0]);var num_y=m_util.trunc((y-spatial_tree.base_point[1])/spatial_tree.cell_size[1]);var num_z=m_util.trunc((z-
spatial_tree.base_point[2])/spatial_tree.cell_size[2]);num_x=m_util.clamp(num_x,0,STREE_CELL_COUNT-1);num_y=m_util.clamp(num_y,0,STREE_CELL_COUNT-1);num_z=m_util.clamp(num_z,0,STREE_CELL_COUNT-1);spatial_tree.verts_indices[i]=i;spatial_tree.octs_indices[i]=num_z*Math.pow(STREE_CELL_COUNT,2)+num_y*STREE_CELL_COUNT+num_x}m_geometry.sort_two_arrays(spatial_tree.octs_indices,spatial_tree.verts_indices,m_geometry.SORT_NUMERIC,true);spatial_tree.verts_offsets=new Uint32Array(Math.pow(STREE_CELL_COUNT,3));
for(var i=0;i<spatial_tree.octs_indices.length;i++){var index=spatial_tree.octs_indices[i];spatial_tree.verts_offsets[index]++}delete spatial_tree.octs_indices;for(var i=1;i<spatial_tree.verts_offsets.length;i++)spatial_tree.verts_offsets[i]+=spatial_tree.verts_offsets[i-1];return spatial_tree}function get_particle_inherited_attrs(vc_name_from,vc_name_to,batch,emitter_vc,bend_inheritance,particle_mesh){var inherited_attrs=[];if(vc_name_from!==""&&vc_name_to!==""){var col_usage_data=get_vcol_usage_data_by_name(vc_name_to,
batch.vertex_colors_usage);if(col_usage_data.length>0)for(var i=0;i<col_usage_data.length;i+=3)inherited_attrs.push({emitter_attr:vc_name_from,emitter_mask:7,particle_attr:col_usage_data[i],particle_mask:col_usage_data[i+1],dst_channel_offset:col_usage_data[i+2]});else if(m_geometry.has_attr(batch.common_attributes,"a_color"))if(vc_name_to==particle_mesh["active_vcol_name"])inherited_attrs.push({emitter_attr:vc_name_from,emitter_mask:7,particle_attr:"a_color",particle_mask:7,dst_channel_offset:0})}if(bend_inheritance){if("a_bending_col_main"in
emitter_vc)inherited_attrs.push({emitter_attr:"a_bending_col_main",emitter_mask:4,particle_attr:"a_bending_col_main",particle_mask:4,dst_channel_offset:0});if("a_bending_col_detail"in emitter_vc)inherited_attrs.push({emitter_attr:"a_bending_col_detail",emitter_mask:7,particle_attr:"a_bending_col_detail",particle_mask:7,dst_channel_offset:0})}return inherited_attrs}function get_vcol_usage_data_by_name(color_name,vc_usage){var data=[];for(var attr_name in vc_usage){var src_colors=vc_usage[attr_name].src;
var dst_channel_offset=0;for(var i=0;i<src_colors.length;i++){var mask=src_colors[i].mask;if(color_name==src_colors[i].name)data.push(attr_name,mask,dst_channel_offset);dst_channel_offset+=m_util.rgb_mask_get_channels_count(mask)}}return data}function fill_submesh_center_pos(submesh,transforms){submesh.va_common["au_center_pos"]=new Float32Array(submesh.base_length*3);var t_count=transforms.length;var base_length=submesh.base_length/t_count;for(var i=0;i<t_count;i++){var transform=transforms[i];var v_offset=
base_length*3*i;for(var j=0;j<base_length;j++){submesh.va_common["au_center_pos"][v_offset+j*3]=transform[0];submesh.va_common["au_center_pos"][v_offset+j*3+1]=transform[1];submesh.va_common["au_center_pos"][v_offset+j*3+2]=transform[2]}}return submesh}function fill_submesh_emitter_center(submesh,em_world_matrix){submesh.va_common["a_emitter_center"]=new Float32Array(submesh.base_length*3);var origin=m_vec4.fromValues(0,0,0,1);m_vec4.transformMat4(origin,em_world_matrix,origin);for(var i=0;i<submesh.base_length;i++){submesh.va_common["a_emitter_center"][i*
3]=origin[0];submesh.va_common["a_emitter_center"][i*3+1]=origin[1];submesh.va_common["a_emitter_center"][i*3+2]=origin[2]}return submesh}function make_particle_inherited_vcols(submesh,transforms,em_bb_local,em_submesh,inherited_attrs,vc_usage,spatial_tree){var calc_nearest=false;for(var i=0;i<inherited_attrs.length;i++){var em_attr=inherited_attrs[i].emitter_attr;var cols=em_submesh.va_common[em_attr];if(cols&&cols.length>0){calc_nearest=true;break}}if(calc_nearest){var nearest_points=calc_emitter_nearest_points(em_bb_local,
em_submesh.va_frames[0]["a_position"],transforms,spatial_tree);var particle_verts_count=submesh.base_length/transforms.length;for(var i=0;i<inherited_attrs.length;i++){var p_attr=inherited_attrs[i].particle_attr;var p_mask=inherited_attrs[i].particle_mask;var em_attr=inherited_attrs[i].emitter_attr;var em_mask=inherited_attrs[i].emitter_mask;var cols=em_submesh.va_common[em_attr];switch(p_attr){case "a_bending_col_main":var p_attr_channels_total=1;break;case "a_bending_col_detail":var p_attr_channels_total=
3;break;case "a_color":var p_attr_channels_total=3;break;default:var p_attr_channels_total=0;for(var j=0;j<vc_usage[p_attr].src.length;j++)p_attr_channels_total+=m_util.rgb_mask_get_channels_count(vc_usage[p_attr].src[j].mask);break}if(cols&&cols.length>0){var emitter_comp_count=m_util.rgb_mask_get_channels_count(em_mask);var particle_comp_count=m_util.rgb_mask_get_channels_count(p_mask);var mask_from=em_mask&p_mask;var channel_presence_from=m_util.rgb_mask_get_channels_presence(mask_from);if(mask_from!=
p_mask)m_print.error("Wrong color extraction from "+em_attr+" to "+p_attr+".");if(p_attr=="a_bending_col_main"||p_attr=="a_bending_col_detail")submesh.va_common[p_attr]=new Float32Array(submesh.base_length*particle_comp_count);for(var j=0;j<transforms.length;j++){var nearest_index=nearest_points[j];var em_vert_offset=nearest_index*emitter_comp_count;var p_offset=j*particle_verts_count*p_attr_channels_total;if(nearest_index!=-1)for(var k=0;k<particle_verts_count;k++){var p_vert_offset=k*p_attr_channels_total;
for(var l=0;l<channel_presence_from.length;l++)if(channel_presence_from[l]){var em_channel_offset=m_util.rgb_mask_get_channel_presence_index(em_mask,l);var p_channel_offset=inherited_attrs[i].dst_channel_offset+m_util.rgb_mask_get_channel_presence_index(p_mask,l);submesh.va_common[p_attr][p_offset+p_vert_offset+p_channel_offset]=cols[em_vert_offset+em_channel_offset]}}}}else submesh.va_common[p_attr]=new Float32Array(0)}}return submesh}function calc_emitter_nearest_points(em_bb_local,em_positions,
transforms,spatial_tree){var particle_cen=new Float32Array(3);var em_vert=new Float32Array(3);var nearest_points=new Uint32Array(transforms.length);if(!("verts_indices"in spatial_tree))make_spatial_tree(spatial_tree,em_bb_local,em_positions);for(var i=0;i<transforms.length;i++){particle_cen[0]=transforms[i][0];particle_cen[1]=transforms[i][1];particle_cen[2]=transforms[i][2];var min_dist=1E10;var min_index=-1;var num_x=m_util.trunc((particle_cen[0]-spatial_tree.base_point[0])/spatial_tree.cell_size[0]);
var num_y=m_util.trunc((particle_cen[1]-spatial_tree.base_point[1])/spatial_tree.cell_size[1]);var num_z=m_util.trunc((particle_cen[2]-spatial_tree.base_point[2])/spatial_tree.cell_size[2]);num_x=m_util.clamp(num_x,0,STREE_CELL_COUNT-1);num_y=m_util.clamp(num_y,0,STREE_CELL_COUNT-1);num_z=m_util.clamp(num_z,0,STREE_CELL_COUNT-1);var oct_index=num_z*Math.pow(STREE_CELL_COUNT,2)+num_y*STREE_CELL_COUNT+num_x;var from_index=oct_index==0?0:spatial_tree.verts_offsets[oct_index-1];var to_index=spatial_tree.verts_offsets[oct_index];
for(var j=from_index;j<to_index;j++){var index=spatial_tree.verts_indices[j];em_vert[0]=em_positions[index*3];em_vert[1]=em_positions[index*3+1];em_vert[2]=em_positions[index*3+2];m_vec3.sub(em_vert,particle_cen,em_vert);var sq_len=m_vec3.sqrLen(em_vert);if(sq_len<=min_dist){min_dist=sq_len;min_index=index}}if(min_index==-1)for(var j=0;j<em_positions.length/3;j++){em_vert[0]=em_positions[j*3];em_vert[1]=em_positions[j*3+1];em_vert[2]=em_positions[j*3+2];m_vec3.sub(em_vert,particle_cen,em_vert);var sq_len=
m_vec3.sqrLen(em_vert);if(sq_len<=min_dist){min_dist=sq_len;min_index=j}}nearest_points[i]=min_index}return nearest_points}function distribute_ptrans_equally(ptrans,dupli_objects,seed,use_particles_rotation,data_len){var objs_count=dupli_objects.length;var ptrans_dist={};for(var i=0;i<ptrans.length;i+=data_len){var index=Math.floor(objs_count*m_util.rand_r(seed));var robj_name=dupli_objects[index].name;ptrans_dist[index]=ptrans_dist[index]||[];ptrans_dist[index].push(ptrans[i],ptrans[i+1],ptrans[i+
2],ptrans[i+3]);if(use_particles_rotation)ptrans_dist[index].push(ptrans[i+4],ptrans[i+5],ptrans[i+6],ptrans[i+7])}for(var index in ptrans_dist)ptrans_dist[index]=new Float32Array(ptrans_dist[index]);return ptrans_dist}function distribute_ptrans_group(ptrans,dupli_objects,use_particles_rotation,data_len){var ptrans_dist={};var quat=new Float32Array([0,0,0,1]);for(var i=0;i<ptrans.length;i+=data_len)for(var j=0;j<dupli_objects.length;j++){var obj_name=dupli_objects[j].name;var obj_trans=m_vec3.create();
m_vec3.scale(dupli_objects[j].render.trans,dupli_objects[j].render.scale,obj_trans);var res_trans=m_vec3.clone([ptrans[i],ptrans[i+1],ptrans[i+2]]);if(!ptrans_dist[j])ptrans_dist[j]=new Float32Array(ptrans.length);if(use_particles_rotation){ptrans_dist[j][i+4]=quat[0]=ptrans[i+4];ptrans_dist[j][i+5]=quat[1]=ptrans[i+5];ptrans_dist[j][i+6]=quat[2]=ptrans[i+6];ptrans_dist[j][i+7]=quat[3]=ptrans[i+7];m_util.quat_bpy_b4w(quat,quat);m_util.transformQuatFast(obj_trans,quat,obj_trans)}m_vec3.add(res_trans,
obj_trans,res_trans);ptrans_dist[j][i]=res_trans[0];ptrans_dist[j][i+1]=res_trans[1];ptrans_dist[j][i+2]=res_trans[2];ptrans_dist[j][i+3]=ptrans[i+3]}return ptrans_dist}function distribute_ptrans_by_dupli_weights(ptrans,dupli_objects,dupli_weights,seed,use_particles_rotation,data_len){var ptrans_dist={};function rand_obj_index_by_weights(dupli_weights){var weight_sum_array=[0];for(var i=0;i<dupli_weights.length;i++){var weight=dupli_weights[i];weight_sum_array[i+1]=weight_sum_array[i]+weight["count"]}var last=
weight_sum_array[weight_sum_array.length-1];var weight_sum_rand=last*m_util.rand_r(seed);var weight_index=0;for(var i=0;i<weight_sum_array.length;i++)if(weight_sum_rand>=weight_sum_array[i]&&weight_sum_rand<weight_sum_array[i+1]){weight_index=i;break}return weight_index}var dupli_weights_sorted=[];for(var i=0;i<dupli_objects.length;i++){var dg_obj=dupli_objects[i];var name=dg_obj.origin_name||dg_obj.name;for(var j=0;j<dupli_weights.length;j++){var weight=dupli_weights[j];if(name==weight["name"])dupli_weights_sorted.push(weight)}}if(dupli_weights.length!=
dupli_weights_sorted.length)m_print.error("dupli weights match failed");for(var i=0;i<ptrans.length;i+=data_len){var index=rand_obj_index_by_weights(dupli_weights_sorted);ptrans_dist[index]=ptrans_dist[index]||[];ptrans_dist[index].push(ptrans[i],ptrans[i+1],ptrans[i+2],ptrans[i+3]);if(use_particles_rotation)ptrans_dist[index].push(ptrans[i+4],ptrans[i+5],ptrans[i+6],ptrans[i+7])}for(var index in ptrans_dist)ptrans_dist[index]=new Float32Array(ptrans_dist[index]);return ptrans_dist}function create_object_clusters(batch_objects,
grid_size){var clusters=[];var cluster_ids={};for(var i=0;i<batch_objects.length;i++){var bobj=batch_objects[i];var bpy_bobj=bobj.temp_bpy_obj;var bobj_render=bobj.render;var bb_local=m_bounds.zero_bounding_box();m_bounds.copy_bb(bobj_render.bb_original,bb_local);var bb_world=m_bounds.bounding_box_transform(bb_local,bobj_render.world_matrix);var bs_local=m_bounds.create_bounding_sphere(bpy_bobj["data"]["b4w_bounding_sphere_radius"],bpy_bobj["data"]["b4w_bounding_sphere_center"]);var bs_world=m_bounds.bounding_sphere_transform(bs_local,
bobj_render.world_matrix);var be_axes=bpy_bobj["data"]["b4w_bounding_ellipsoid_axes"];var be_local=m_bounds.create_bounding_ellipsoid([be_axes[0],0,0],[0,be_axes[1],0],[0,0,be_axes[2]],bpy_bobj["data"]["b4w_bounding_ellipsoid_center"]);var be_world=m_bounds.bounding_ellipsoid_transform(be_local,bobj_render.tsr);bobj_render.bb_local=bb_local;bobj_render.bb_world=bb_world;bobj_render.bs_local=bs_local;bobj_render.bs_world=bs_world;bobj_render.be_local=be_local;bobj_render.be_world=be_world;var render_props=
{};render_props.shadow_cast=bobj_render.shadow_cast;render_props.shadow_cast_only=bobj_render.shadow_cast_only;render_props.shadow_receive=bobj_render.shadow_receive;render_props.selectable=bobj_render.selectable;render_props.origin_selectable=bobj_render.origin_selectable;render_props.outlining=bobj_render.outlining;render_props.origin_outlining=bobj_render.origin_outlining;render_props.outline_anim_settings_default=bobj_render.outline_anim_settings_default;render_props.reflexible=bobj_render.reflexible;
render_props.reflexible_only=bobj_render.reflexible_only;render_props.reflective=bobj_render.reflective;render_props.cube_reflection_id=bobj_render.cube_reflection_id;render_props.plane_reflection_id=bobj_render.plane_reflection_id;render_props.reflection_type=bobj_render.reflection_type;render_props.caustics=bobj_render.caustics;render_props.wind_bending=bobj_render.wind_bending;render_props.main_bend_col=bobj_render.main_bend_col;render_props.detail_bend_col=bobj_render.detail_bend_col;render_props.billboard=
bobj_render.billboard;render_props.billboard_type=bobj_render.billboard_type;render_props.billboard_spherical=bobj_render.billboard_spherical;render_props.dynamic_grass=bobj_render.dynamic_grass;render_props.do_not_cull=bobj_render.do_not_cull;render_props.disable_fogging=bobj_render.disable_fogging;render_props.mats_values=bobj_render.mats_values;render_props.mats_value_inds=bobj_render.mats_value_inds;render_props.mats_anim_inds=bobj_render.mats_anim_inds;render_props.mats_rgbs=bobj_render.mats_rgbs;
render_props.mats_rgb_inds=bobj_render.mats_rgb_inds;render_props.mats_rgb_anim_inds=bobj_render.mats_rgb_anim_inds;render_props.dynamic_geometry=bobj_render.dynamic_geometry;render_props.grid_id=calc_grid_id(grid_size,bobj_render.bs_world.center);render_props.lod_dist_max=bobj_render.lod_dist_max;render_props.lod_dist_min=bobj_render.lod_dist_min;render_props.lod_transition_ratio=bobj_render.lod_transition_ratio;render_props.do_not_render=bobj_render.do_not_render;var id=JSON.stringify(render_props);
cluster_ids[id]=cluster_ids[id]||[];cluster_ids[id].push(bobj)}for(var key in cluster_ids){var render_props=JSON.parse(key);var objects=cluster_ids[key];var render=m_obj_util.create_render("STATIC");for(var prop in render_props)render[prop]=render_props[prop];render.data_id=batch_objects[0].render.data_id;render.wind_bending_amp=0;render.wind_bending_freq=0;render.detail_bending_freq=0;render.detail_bending_amp=0;render.branch_bending_amp=0;render.hide=false;for(var i=0;i<objects.length;i++){var obj=
objects[i];if(i==0){render.bb_world=m_util.clone_object_r(obj.render.bb_world);render.bs_world=m_util.clone_object_r(obj.render.bs_world);render.be_local=m_util.clone_object_r(obj.render.be_local);render.be_world=m_util.clone_object_r(obj.render.be_world)}else{m_bounds.expand_bounding_box(render.bb_world,obj.render.bb_world);m_bounds.expand_bounding_sphere(render.bs_world,obj.render.bs_world)}}render.bb_local=m_util.clone_object_r(render.bb_world);render.bs_local=m_util.clone_object_r(render.bs_world);
var cluster={render:render,objects:objects};clusters.push(cluster)}return clusters}function calc_grid_id(grid_size,position){if(grid_size==0)return[0,0];var id_x=Math.floor(position[0]/grid_size);var id_z=Math.floor(position[2]/grid_size);return[id_x,id_z]}function tsr_from_render(render){return m_tsr.create_sep(render.trans,render.scale,render.quat)}exports.update_batch_id=update_batch_id;function update_batch_id(batch,render_id){var canvas_context=null;var video_elements=null;for(var i=0;i<batch.textures.length;i++){var ctx=
batch.textures[i].canvas_context;if(ctx){if(!canvas_context)canvas_context={};canvas_context[i]=ctx;batch.textures[i].canvas_context=null}var video=batch.textures[i].video_file;if(video){if(!video_elements)video_elements={};video_elements[i]=video;batch.textures[i].video_file=null}}batch.id=0;batch.render_id=render_id;batch.id=m_util.calc_variable_id(batch,render_id);if(canvas_context)for(var j in canvas_context)batch.textures[j].canvas_context=canvas_context[j];if(video_elements)for(var j in video_elements)batch.textures[j].video_file=
video_elements[j]}exports.calculate_render_id=calculate_render_id;function calculate_render_id(render){var bone_pointers=render.bone_pointers;render.bone_pointers=null;var id=m_util.calc_variable_id(render,0);render.bone_pointers=bone_pointers;return id}exports.create_bounding_ellipsoid_batch=create_bounding_ellipsoid_batch;function create_bounding_ellipsoid_batch(bv,render,obj_name,ellipsoid,is_dynamic){var batch=init_batch("WIREFRAME");apply_shader(batch,"wireframe.glslv","wireframe.glslf");batch.wireframe_mode=
0;batch.debug_sphere=true;batch.depth_mask=true;batch.odd_id_prop=obj_name;if(is_dynamic)batch.debug_sphere_dynamic=true;update_batch_render(batch,render);var render_id=calculate_render_id(render);update_batch_id(batch,render_id);if(ellipsoid){var submesh=m_primitives.generate_uv_sphere(16,8,1,bv.center,false,false);var scale=[bv.axis_x[0],bv.axis_y[1],bv.axis_z[2]];m_geometry.scale_submesh_xyz(submesh,scale,bv.center)}else var submesh=m_primitives.generate_uv_sphere(16,8,bv.radius,bv.center,false,
false);m_geometry.submesh_drop_indices(submesh,1,true);submesh.va_common["a_polyindex"]=m_geometry.extract_polyindices(submesh);update_batch_geometry(batch,submesh);return batch}function apply_shader(batch,vert,frag){batch.shaders_info.vert=vert;batch.shaders_info.frag=frag;m_shaders.set_default_directives(batch.shaders_info)}exports.append_texture=append_texture;function append_texture(batch,texture,name){if(batch.textures.length==1&&batch.texture_names.length==0)batch.texture_names.push("default0");
name=name||"default"+String(batch.textures.length);if(batch.texture_names.indexOf(name)==-1){batch.textures.push(texture);batch.texture_names.push(name)}if(batch.shader)m_render.assign_texture_uniforms(batch)}exports.replace_texture=function(batch,texture,name){var index=batch.texture_names.indexOf(name);if(index>-1)batch.textures[index]=texture};exports.create_shadeless_batch=function(submesh,color,alpha){var batch=init_batch("MAIN");if(alpha<1)batch.blend=true;m_vec4.set(color[0],color[1],color[2],
alpha,batch.diffuse_color);batch.draw_mode=m_geometry.DM_TRIANGLES;update_batch_geometry(batch,submesh);apply_shader(batch,"main_stack.glslv","main_stack.glslf");set_batch_directive(batch,"SHADELESS",1);update_shader(batch);return batch};exports.update_shader=update_shader;function update_shader(batch){if(!batch.shaders_info)throw"No shaders info for batch "+batch.name;batch.shader=m_shaders.get_compiled_shader(batch.shaders_info);m_render.assign_uniform_setters(batch.shader);m_render.assign_attribute_setters(batch);
m_render.assign_texture_uniforms(batch)}exports.check_batch_perm_uniform=function(batch,uniform_name){if(!batch.shader.permanent_uniform_setters.length)return false;if(batch.shader.permanent_uniform_setters_table[uniform_name])return true;return false};exports.create_depth_pack_batch=function(tex){var batch=init_batch("DEPTH_PACK");batch.use_backface_culling=true;batch.depth_mask=false;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv",
"postprocessing/depth_pack.glslf");update_shader(batch);return batch};exports.create_postprocessing_batch=function(post_effect){var batch=init_batch("POSTPROCESSING");apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/postprocessing.glslf");switch(post_effect){case "NONE":set_batch_directive(batch,"POST_EFFECT","POST_EFFECT_NONE");break;case "GRAYSCALE":set_batch_directive(batch,"POST_EFFECT","POST_EFFECT_GRAYSCALE");break;case "X_BLUR":set_batch_directive(batch,"POST_EFFECT",
"POST_EFFECT_X_BLUR");break;case "Y_BLUR":set_batch_directive(batch,"POST_EFFECT","POST_EFFECT_Y_BLUR");break;case "X_GLOW_BLUR":set_batch_directive(batch,"POST_EFFECT","POST_EFFECT_X_GLOW_BLUR");break;case "Y_GLOW_BLUR":set_batch_directive(batch,"POST_EFFECT","POST_EFFECT_Y_GLOW_BLUR");break;case "X_EXTEND":set_batch_directive(batch,"POST_EFFECT","POST_EFFECT_X_EXTEND");break;case "Y_EXTEND":set_batch_directive(batch,"POST_EFFECT","POST_EFFECT_Y_EXTEND");break;default:throw"Wrong postprocessing effect: "+
post_effect;break}batch.use_backface_culling=true;batch.depth_mask=false;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);update_shader(batch);return batch};exports.create_ssao_batch=function(subs){var batch=init_batch("SSAO");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/ssao.glslf");set_batch_directive(batch,
"SSAO_QUALITY","SSAO_QUALITY_"+subs.ssao_samples);set_batch_directive(batch,"SSAO_HEMISPHERE",subs.ssao_hemisphere?1:0);var texture=m_textures.generate_texture("SSAO_TEXTURE",subs);var texture_slot={"texture":texture};var random_vector_table={width:4,height:4,data:new Uint8Array([150,123,254,0,127,3,97,0,164,246,99,0,155,177,14,0,54,83,221,0,2,142,143,0,32,57,79,0,49,160,32,0,57,232,115,0,178,216,203,0,70,196,218,0,241,164,82,0,225,58,85,0,233,88,189,0,144,25,203,0,117,73,12,0])};var tex=get_batch_texture(texture_slot,
random_vector_table);append_texture(batch,tex,"u_ssao_special_tex");update_shader(batch);return batch};exports.create_ssao_blur_batch=function(subs){var batch=init_batch("SSAO_BLUR");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/ssao_blur.glslf");set_batch_directive(batch,"SSAO_BLUR_DEPTH",subs.ssao_blur_depth?1:0);update_shader(batch);
return batch};exports.create_dof_batch=function(subs){var batch=init_batch("DOF");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/dof.glslf");set_batch_directive(batch,"DEPTH_RGBA",1);update_shader(batch);return batch};exports.create_outline_batch=function(){var batch=init_batch("OUTLINE");batch.depth_mask=false;batch.use_backface_culling=
true;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/outline.glslf");update_shader(batch);return batch};exports.create_glow_combine_batch=function(){var batch=init_batch("GLOW_COMBINE");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/glow.glslf");
update_shader(batch);return batch};exports.create_god_rays_batch=function(tex_input,pack,water,steps){var batch=init_batch("GOD_RAYS");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_billboard();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/god_rays.glslv","postprocessing/god_rays.glslf");set_batch_directive(batch,"DEPTH_RGBA",pack?1:0);set_batch_directive(batch,"WATER_EFFECTS",water?1:0);set_batch_directive(batch,"STEPS_PER_PASS",
m_shaders.glsl_value(steps,1));update_shader(batch);return batch};exports.create_god_rays_combine_batch=function(tex_main,tex_god_rays){var batch=init_batch("GOD_RAYS_COM");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/god_rays_combine.glslf");update_shader(batch);return batch};exports.create_procedural_sky_batch=function(){var batch=
init_batch("SKY");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_cube();update_batch_geometry(batch,submesh);apply_shader(batch,"procedural_skydome.glslv","procedural_skydome.glslf");set_batch_directive(batch,"WATER_EFFECTS",1);update_shader(batch);return batch};exports.create_antialiasing_batch=function(){var batch=init_batch("ANTIALIASING");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,
submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/antialiasing.glslf");if(cfg_def.quality_aa)set_batch_directive(batch,"AA_METHOD","AA_METHOD_FXAA_QUALITY");else set_batch_directive(batch,"AA_METHOD","AA_METHOD_FXAA_LIGHT");update_shader(batch);return batch};exports.create_smaa_batch=function(type){var batch=init_batch("SMAA");var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/smaa.glslv","postprocessing/smaa.glslf");
set_batch_directive(batch,"AA_METHOD","AA_METHOD_SMAA_HIGH");set_batch_directive(batch,"SMAA_PASS",type);set_batch_directive(batch,"SMAA_PREDICATION",0);set_batch_directive(batch,"SMAA_REPROJECTION",0);update_shader(batch);batch.depth_mask=false;batch.use_backface_culling=true;return batch};exports.create_compositing_batch=function(){var batch=init_batch("COMPOSITING");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,
submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/compositing.glslf");update_shader(batch);return batch};exports.create_motion_blur_batch=function(decay_threshold){var batch=init_batch("MOTION_BLUR");batch.use_backface_culling=true;batch.depth_mask=false;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/motion_blur.glslf");update_shader(batch);return batch};
exports.create_anaglyph_batch=function(post_effect){var batch=init_batch("ANAGLYPH");batch.use_backface_culling=true;batch.depth_mask=false;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/anaglyph.glslf");update_shader(batch);return batch};exports.create_luminance_batch=function(){var batch=init_batch("LUMINANCE");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_fullscreen_tri();
update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/luminance.glslf");update_shader(batch);return batch};exports.create_average_luminance_batch=function(){var batch=init_batch("LUMINANCE");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/luminance_av.glslf");update_shader(batch);
return batch};exports.create_luminance_trunced_batch=function(){var batch=init_batch("LUMINANCE_X_BLUR");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/luminance_trunced.glslv","postprocessing/luminance_trunced.glslf");update_shader(batch);return batch};exports.create_bloom_blur_batch=function(){var batch=init_batch("POSTPROCESSING");batch.use_backface_culling=true;batch.depth_mask=
false;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/bloom_blur.glslf");update_shader(batch);return batch};exports.create_bloom_combine_batch=function(){var batch=init_batch("BLOOM");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/bloom_combine.glslf");
update_shader(batch);return batch};exports.create_velocity_batch=function(){var batch=init_batch("VELOCITY");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/velocity.glslf");update_shader(batch);return batch};exports.create_anchor_visibility_batch=function(){var batch=init_batch("ANCHOR_VISIBILITY");batch.depth_mask=true;batch.use_backface_culling=
true;batch.draw_mode=m_geometry.DM_POINTS;apply_shader(batch,"anchors.glslv","anchors.glslf");var submesh=m_primitives.generate_index(1);update_batch_geometry(batch,submesh);set_batch_directive(batch,"ANCHOR_NUM",1);update_shader(batch);batch.positions=new Float32Array([0,0,0]);return batch};exports.update_anchor_visibility_batch=function(batch,positions){var num=positions.length/3;if(num!=batch.positions.length/3){var submesh=m_primitives.generate_index(num);update_batch_geometry(batch,submesh);
set_batch_directive(batch,"ANCHOR_NUM",num);update_shader(batch)}batch.positions=positions};exports.find_batch_material=find_batch_material;function find_batch_material(obj,mat_name,type){var scene_data=obj.scenes_data[0];var batches=scene_data.batches;for(var i=0;i<batches.length;i++)if(batches[i].type==type&&!batches[i].forked_batch&&batches[i].material_names.indexOf(mat_name)!=-1)return batches[i];return null}exports.find_batch_material_forked=find_batch_material_forked;function find_batch_material_forked(obj,
mat_name,type){var scene_data=obj.scenes_data[0];var batches=scene_data.batches;for(var i=0;i<batches.length;i++)if(batches[i].type==type&&batches[i].forked_batch&&batches[i].material_names.indexOf(mat_name)!=-1)return batches[i];return null}exports.set_material_props=set_material_props;function set_material_props(batch_to,batch_from){batch_to.diffuse_color.set(batch_from.diffuse_color);batch_to.diffuse_intensity=batch_from.diffuse_intensity;batch_to.specular_color.set(batch_from.specular_color);
batch_to.specular_color_factor=batch_from.specular_color_factor;batch_to.specular_params.set(batch_from.specular_params);batch_to.emit=batch_from.emit;batch_to.ambient=batch_from.ambient;batch_to.diffuse_color_factor=batch_from.diffuse_color_factor;batch_to.alpha_factor=batch_from.alpha_factor;batch_to.reflect_factor=batch_from.reflect_factor;batch_to.fresnel_params.set(batch_from.fresnel_params);batch_to.parallax_scale=batch_from.parallax_scale;batch_to.shallow_water_col.set(batch_from.shallow_water_col);
batch_to.shallow_water_col_fac=batch_from.shallow_water_col_fac;batch_to.shore_water_col.set(batch_from.shore_water_col);batch_to.shore_water_col_fac=batch_from.shore_water_col_fac;batch_to.foam_factor=batch_from.foam_factor;batch_to.water_norm_uv_velocity=batch_from.water_norm_uv_velocity}exports.check_batch_type=function(obj,type){var scene_data=obj.scenes_data[0];var batches=scene_data.batches;for(var i=0;i<batches.length;i++)if(batches[i].type==type)return true;return false};exports.clear_batch=
function(batch){var textures=batch.textures;for(var i=0;i<textures.length;i++){var tex=textures[i];m_textures.delete_texture(tex.w_texture)}m_geometry.cleanup_bufs_data(batch.bufs_data)};exports.inherit_material=function(obj_from,mat_from_name,obj_to,mat_to_name){var types=["MAIN","DEPTH","COLOR_ID"];var batches_found=false;for(var i=0;i<types.length;i++){var type=types[i];var batch_from=find_batch_material(obj_from,mat_from_name,type);var batch_to=find_batch_material(obj_to,mat_to_name,type);if(batch_from&&
batch_to){batches_found=true;var child_batch=find_batch_material_forked(obj_to,mat_to_name,type);if(type=="MAIN"){set_material_props(batch_to,batch_from);if(child_batch)set_material_props(child_batch,batch_from)}for(var j=0;j<batch_to.texture_names.length;j++){var to_name=batch_to.texture_names[j];if(BATCH_INHERITED_TEXTURES.indexOf(to_name)!==-1){var from_index=batch_from.texture_names.indexOf(to_name);if(from_index!==-1){batch_to.textures[j]=batch_from.textures[from_index];if(child_batch){var child_index=
child_batch.texture_names.indexOf(to_name);if(child_index!==-1)child_batch.textures[child_index]=batch_from.textures[from_index]}}}}}}if(!batches_found)m_print.error("Wrong objects for inheriting material!")}};b4w.module["__nodemat"]=function(exports,require){var m_cfg=require("__config");var m_graph=require("__graph");var m_mat3=require("__mat3");var m_mat4=require("__mat4");var m_obj=require("__objects");var m_print=require("__print");var m_shaders=require("__shaders");var m_scenes=require("__scenes");var m_util=require("__util");var m_vec3=require("__vec3");var _shader_ident_counters={};var _composed_node_graphs={};var _lamp_indexes={};var _lamp_index=0;var _material_index=0;var _vec4_tmp=new Float32Array(4);
var cfg_def=m_cfg.defaults;exports.compose_nmat_graph=compose_nmat_graph;function compose_nmat_graph(node_tree,source_id,is_node_group,mat_name,shader_type){var active_scene=m_scenes.get_active();var ntree_graph_id=generate_graph_id(source_id,shader_type,active_scene.uuid);if(ntree_graph_id in _composed_node_graphs)return _composed_node_graphs[ntree_graph_id];if(shader_type!="DEPTH"&&shader_type!="COLOR_ID"){var graph=m_graph.create();var bpy_nodes=node_tree["nodes"];var links=node_tree["links"];
var anim_data=node_tree["animation_data"];for(var i=0;i<bpy_nodes.length;i++){var bpy_node=bpy_nodes[i];if(append_nmat_node(graph,bpy_node,0,anim_data,mat_name,shader_type)==null){_composed_node_graphs[ntree_graph_id]=null;return null}}if(is_node_group)if(find_node_id(node_tree,graph,"GROUP_OUTPUT","group")==-1)return null;var node_groups=trace_group_nodes(graph);if(!append_node_groups_graphs(graph,links,node_groups))return null;if(is_node_group)return graph;for(var i=0;i<links.length;i++){var link=
links[i];var node_ids1=nmat_node_ids(link["from_node"],graph);var node_ids2=nmat_node_ids(link["to_node"],graph);for(var j=0;j<node_ids1.length;j++)for(var k=0;k<node_ids2.length;k++){var node_id1=node_ids1[j];var node_id2=node_ids2[k];var node_attr1=m_graph.get_node_attr(graph,node_id1);var node_attr2=m_graph.get_node_attr(graph,node_id2);if(!append_nmat_edge(graph,node_id1,node_id2,node_attr1,node_attr2,link)){_composed_node_graphs[ntree_graph_id]=null;return null}}}complete_edges(graph);if(shader_type==
"GLOW")var output_id=find_node_id(node_tree,graph,"B4W_GLOW_OUTPUT","material",true);else var output_id=find_node_id(node_tree,graph,"OUTPUT","material",false,true);if(output_id==-1){graph=create_default_graph();output_id=0}nmat_cleanup_graph(graph);var graph_out=m_graph.subgraph_node_conn(graph,output_id,m_graph.BACKWARD_DIR);split_material_nodes(graph_out,anim_data,mat_name,shader_type);clean_sockets_linked_property(graph_out);merge_nodes(graph_out);optimize_geometry_vcol(graph_out);fix_socket_types(graph_out,
anim_data,mat_name,shader_type)}else{var main_graph=compose_nmat_graph(node_tree,source_id,is_node_group,mat_name,"MAIN");var nodes_cb=function(node){var new_node=m_util.clone_object_nr(node);new_node.inputs=m_util.clone_object_r(node.inputs);new_node.outputs=m_util.clone_object_r(node.outputs);return new_node};var ntree_graph=m_graph.clone(main_graph,nodes_cb);var output_id=find_node_id(node_tree,ntree_graph,"OUTPUT","material",false,true);remove_color_output(ntree_graph,output_id);var graph_out=
m_graph.subgraph_node_conn(ntree_graph,output_id,m_graph.BACKWARD_DIR);clean_sockets_linked_property(graph_out)}_composed_node_graphs[ntree_graph_id]=graph_out;return graph_out}exports.create_lighting_graph=create_lighting_graph;function create_lighting_graph(source_id,mat_name,data){var active_scene=m_scenes.get_active();var ntree_graph_id=generate_graph_id(source_id,"MAIN",active_scene.uuid);if(ntree_graph_id in _composed_node_graphs)return _composed_node_graphs[source_id];var graph=m_graph.create();
var bpy_node={"name":"LIGHTING_BEGIN","type":"LIGHTING_BEGIN"};var begin_node_id=append_nmat_node(graph,bpy_node,0,null,mat_name,null);bpy_node={"name":"LIGHTING_END","type":"LIGHTING_END"};var end_node_id=append_nmat_node(graph,bpy_node,0,null,mat_name,null);var translucency_edges=[[begin_node_id,[8,10]],[begin_node_id,[9,6]]];add_lighting_subgraph(graph,data,begin_node_id,end_node_id,translucency_edges,null,mat_name);clean_sockets_linked_property(graph);_composed_node_graphs[source_id]=graph;return graph}
function split_material_nodes(graph,anim_data,mat_name,shader_type){var material_nodes=[];m_graph.traverse(graph,function(id,node){if(node.type=="MATERIAL"||node.type=="MATERIAL_EXT"){var material={node_id:id,node:node};material_nodes.push(material)}});for(var i=0;i<material_nodes.length;++i){var node_id=material_nodes[i].node_id;var node=material_nodes[i].node;var material_begin_id=m_graph.gen_node_id(graph);m_graph.append_node(graph,material_begin_id,node.data.material_begin);var material_end_id=
m_graph.gen_node_id(graph);m_graph.append_node(graph,material_end_id,node.data.material_end);m_graph.append_edge(graph,material_begin_id,material_end_id,[4,2]);var material_socket_map={5:["LIGHTING_APPLY",10],6:["LIGHTING_APPLY",6],7:["MATERIAL_END",3],8:["MATERIAL_END",4],9:["MATERIAL_END",5]};var in_count=m_graph.in_edge_count(graph,node_id);var remove_edges_in=[];var append_edges_in=[];var translucency_edges=[];var edges_in_counter={};for(var k=0;k<in_count;k++){var in_id=m_graph.get_in_edge(graph,
node_id,k);if(!(in_id in edges_in_counter))edges_in_counter[in_id]=0;var edge_attr=m_graph.get_edge_attr(graph,in_id,node_id,edges_in_counter[in_id]++);remove_edges_in.push([in_id,node_id,edge_attr]);var dest=material_socket_map[edge_attr[1]];if(dest)switch(dest[0]){case "MATERIAL_END":append_edges_in.push([in_id,material_end_id,[edge_attr[0],dest[1]]]);break;case "LIGHTING_APPLY":translucency_edges.push([in_id,[edge_attr[0],dest[1]]]);break}else append_edges_in.push([in_id,material_begin_id,edge_attr])}add_lighting_subgraph(graph,
node.data.value,material_begin_id,material_end_id,translucency_edges,anim_data,mat_name);for(var k=0;k<remove_edges_in.length;k++)m_graph.remove_edge_by_attr(graph,remove_edges_in[k][0],remove_edges_in[k][1],remove_edges_in[k][2]);for(var k=0;k<append_edges_in.length;k++)m_graph.append_edge(graph,append_edges_in[k][0],append_edges_in[k][1],append_edges_in[k][2]);var out_count=m_graph.out_edge_count(graph,node_id);var remove_out_edges=[];var append_out_edges=[];var edges_out_counter={};for(var k=0;k<
out_count;k++){var out_id=m_graph.get_out_edge(graph,node_id,k);if(!(out_id in edges_out_counter))edges_out_counter[out_id]=0;var edge_attr=m_graph.get_edge_attr(graph,node_id,out_id,edges_out_counter[out_id]++);remove_out_edges.push([node_id,out_id,edge_attr]);append_out_edges.push([material_end_id,out_id,edge_attr])}for(var k=0;k<remove_out_edges.length;k++)m_graph.remove_edge_by_attr(graph,remove_out_edges[k][0],remove_out_edges[k][1],remove_out_edges[k][2]);for(var k=0;k<append_out_edges.length;k++)m_graph.append_edge(graph,
append_out_edges[k][0],append_out_edges[k][1],append_out_edges[k][2]);m_graph.remove_node(graph,node_id)}}function add_lighting_subgraph(graph,data,begin_node_id,end_node_id,translucency_edges,anim_data,mat_name){var bpy_node={"name":"LIGHTING_AMBIENT","type":"LIGHTING_AMBIENT"};var curr_node_id=append_nmat_node(graph,bpy_node,0,anim_data,mat_name,null);var prev_node_id=curr_node_id;link_nlight_edge(graph,begin_node_id,curr_node_id,"E");link_nlight_edge(graph,begin_node_id,curr_node_id,"A");link_nlight_edge(graph,
begin_node_id,curr_node_id,"D");var scene=m_scenes.get_active();var lamps=m_obj.get_scene_objs(scene,"LAMP",m_obj.DATA_ID_ALL);if(!data.use_shadeless){var lamp_node_id;var lighting_apply_node_id;var shade_spec_node_id;var shade_dif_node_id;for(var i=0;i<lamps.length;i++){var light=lamps[i].light;bpy_node={"name":"LIGHTING_LAMP","type":"LIGHTING_LAMP"};lamp_node_id=append_nmat_node(graph,bpy_node,0,anim_data,mat_name,null);bpy_node={"name":"LIGHTING_APPLY","type":"LIGHTING_APPLY"};lighting_apply_node_id=
append_nmat_node(graph,bpy_node,0,anim_data,mat_name,null);link_nlight_edge(graph,prev_node_id,lighting_apply_node_id,"color");link_nlight_edge(graph,prev_node_id,lighting_apply_node_id,"specular");link_nlight_edge(graph,lamp_node_id,lighting_apply_node_id,"ldir");link_nlight_edge(graph,begin_node_id,lighting_apply_node_id,"normal");link_nlight_edge(graph,begin_node_id,lighting_apply_node_id,"D");link_nlight_edge(graph,begin_node_id,lighting_apply_node_id,"S");link_nlight_edge(graph,lamp_node_id,
lighting_apply_node_id,"lcolorint");link_nlight_edge(graph,begin_node_id,lamp_node_id,"shadow_factor");if(data.specular_shader=="COOKTORR")var spec_name="SPECULAR_PHONG";else var spec_name="SPECULAR_"+data.specular_shader;bpy_node={"name":spec_name,"type":spec_name};shade_spec_node_id=append_nmat_node(graph,bpy_node,0,anim_data,mat_name,null);link_nlight_edge(graph,lamp_node_id,shade_spec_node_id,"ldir");link_nlight_edge(graph,lamp_node_id,shade_spec_node_id,"lfac");link_nlight_edge(graph,begin_node_id,
shade_spec_node_id,"normal");link_nlight_edge(graph,shade_spec_node_id,lighting_apply_node_id,"sfactor");if(spec_name=="SPECULAR_PHONG"||spec_name=="SPECULAR_BLINN"){link_nlight_edge(graph,lamp_node_id,shade_spec_node_id,"norm_fac");link_nlight_edge(graph,begin_node_id,shade_spec_node_id,"sp_params")}else link_nlight_edge(graph,begin_node_id,shade_spec_node_id,"sp_params");if(light.type=="HEMI")var dif_name="DIFFUSE_LAMBERT";else var dif_name="DIFFUSE_"+data.diffuse_shader;bpy_node={"name":dif_name,
"type":dif_name};shade_dif_node_id=append_nmat_node(graph,bpy_node,0,anim_data,mat_name,null);link_nlight_edge(graph,lamp_node_id,shade_dif_node_id,"ldir");link_nlight_edge(graph,lamp_node_id,shade_dif_node_id,"lfac");link_nlight_edge(graph,begin_node_id,shade_dif_node_id,"normal");link_nlight_edge(graph,lamp_node_id,shade_dif_node_id,"norm_fac");link_nlight_edge(graph,shade_dif_node_id,lighting_apply_node_id,"lfactor");if(dif_name!="DIFFUSE_LAMBERT")link_nlight_edge(graph,begin_node_id,shade_dif_node_id,
"dif_params");for(var j=0;j<translucency_edges.length;j++){var in_node_id=translucency_edges[j][0];var edge_attr=translucency_edges[j][1];m_graph.append_edge(graph,in_node_id,lighting_apply_node_id,edge_attr)}prev_node_id=lighting_apply_node_id}}link_nlight_edge(graph,prev_node_id,end_node_id,"color");link_nlight_edge(graph,prev_node_id,end_node_id,"specular")}function link_nlight_edge(graph,id1,id2,inout_name){var node1=m_graph.get_node_attr(graph,id1);var node2=m_graph.get_node_attr(graph,id2);
var in2;for(var i=0;i<node2.inputs.length;i++){var input=node2.inputs[i];if(inout_name==input.identifier){in2=i;break}}var out1;for(var i=0;i<node1.outputs.length;i++){var output=node1.outputs[i];if(inout_name==output.identifier){out1=i;break}}if(in2!=undefined&&out1!=undefined)m_graph.append_edge(graph,id1,id2,[out1,in2])}function generate_graph_id(graph_id,shader_type,scene_id){switch(shader_type){case "GLOW":return graph_id+scene_id+"11";case "COLOR_ID":case "DEPTH":return graph_id+scene_id+"00";
default:return graph_id+scene_id+"10"}}function remove_color_output(graph,output_id){m_graph.traverse_edges(graph,function(id1,id2,attr){var out_node=m_graph.get_node_attr(graph,id2);if(id2==output_id&&out_node.inputs[attr[1]].identifier=="Color")m_graph.remove_edge_by_attr(graph,id1,id2,attr)})}function create_default_graph(){var graph=m_graph.create();var input_color={default_value:new Float32Array([0,0,0]),identifier:"Color",is_linked:false,name:"Color"};var input_alpha={default_value:1,identifier:"Alpha",
is_linked:false,name:"Alpha"};var node={data:null,dirs:[],params:[],inputs:[input_color,input_alpha],outputs:[],type:"OUTPUT",vparams:[]};m_graph.append_node(graph,0,node);return graph}function clean_sockets_linked_property(graph){m_graph.traverse(graph,function(id,node){var inputs=node.inputs;var outputs=node.outputs;for(var i=0;i<inputs.length;i++)fix_socket_property(graph,inputs[i],id,i,1);for(var i=0;i<outputs.length;i++)fix_socket_property(graph,outputs[i],id,i,0)})}function fix_socket_property(graph,
connection,id,num,check_in_edge){if(connection.is_linked){var clear_linked=true;m_graph.traverse_edges(graph,function(in_edge,out_edge,sockets){if(!check_in_edge&&in_edge==id&&sockets[0]==num||check_in_edge&&out_edge==id&&sockets[1]==num)clear_linked=false});if(clear_linked)connection.is_linked=false}}function fix_socket_types(graph,anim_data,mat_name,shader_type){var edge_data=[];m_graph.traverse_edges(graph,function(in_edge,out_edge,sockets){var in_node=m_graph.get_node_attr(graph,in_edge);var out_node=
m_graph.get_node_attr(graph,out_edge);var is_output_vec=m_util.is_vector(in_node.outputs[sockets[0]].default_value);var is_input_vec=m_util.is_vector(out_node.inputs[sockets[1]].default_value);if(is_output_vec!=is_input_vec){var trans_node;var vector={"default_value":[0,0,0],"identifier":"Vector","is_linked":true,"name":"Vector"};var value={"default_value":0,"identifier":"Value","is_linked":true,"name":"Value"};if(is_output_vec&&!is_input_vec)trans_node=init_bpy_node("vector_to_scalar","B4W_VECTOSCAL",
[vector],[value]);else if(!is_output_vec&&is_input_vec)trans_node=init_bpy_node("scalar_to_vector","B4W_SCALTOVEC",[value],[vector]);append_nmat_node(graph,trans_node,0,anim_data,mat_name,shader_type);edge_data.push([in_edge,out_edge,graph.nodes[graph.nodes.length-2],sockets])}});for(var i=0;i<edge_data.length;++i){m_graph.remove_edge_by_attr(graph,edge_data[i][0],edge_data[i][1],edge_data[i][3]);m_graph.append_edge(graph,edge_data[i][0],edge_data[i][2],[edge_data[i][3][0],0]);m_graph.append_edge(graph,
edge_data[i][2],edge_data[i][1],[0,edge_data[i][3][1]])}}function complete_edges(graph){var appended_edges=[];m_graph.traverse(graph,function(id,attr){switch(attr.type){case "B4W_TRANSLUCENCY":m_graph.traverse_edges(graph,function(edge_from,edge_to,edge_attr){if(edge_from==id){var from_socket_index=edge_attr[0];if(attr.outputs[from_socket_index].name=="Translucency")appended_edges.push(edge_from,edge_to,[edge_attr[0]+1,edge_attr[1]+1])}});break}});for(var i=0;i<appended_edges.length;i+=3)m_graph.append_edge(graph,
appended_edges[i],appended_edges[i+1],appended_edges[i+2])}function nmat_node_ids(bpy_node,graph){var node_ids=[];m_graph.traverse(graph,function(id,attr){if(attr.name==bpy_node["name"])node_ids.push(id)});if(node_ids.length)return node_ids;else throw"Node not found";}function nmat_cleanup_graph(graph){var id_attr=[];m_graph.traverse(graph,function(id,attr){if(attr.type=="B4W_PARALLAX"||attr.type=="REROUTE")id_attr.push(id,attr)});for(var i=0;i<id_attr.length;i+=2){var id=id_attr[i];var attr=id_attr[i+
1];if(attr.type=="B4W_PARALLAX"){var input_id1=get_in_edge_by_input_num(graph,id,1);if(input_id1!=-1){var input_input_id=m_graph.get_in_edge(graph,input_id1,0);m_graph.remove_edge(graph,input_id1,id,-1);if(input_input_id!=-1)m_graph.remove_edge(graph,input_input_id,input_id1,-1);var input1_attr=m_graph.get_node_attr(graph,input_id1);attr.data=input1_attr.data;attr.params[0]=input1_attr.params[0];m_graph.remove_node(graph,input_id1)}attr.inputs.splice(1,1)}else if(attr.type=="REROUTE"){var input_id=
m_graph.get_in_edge(graph,id,0);var out_edge_count=m_graph.out_edge_count(graph,id);var removed_edges=[];var output_ids=[];var edges_quantity=[];for(var j=0;j<out_edge_count;j++){var output_id=m_graph.get_out_edge(graph,id,j);var id_place=output_ids.indexOf(output_id);if(id_place!=-1)edges_quantity[id_place]+=1;else{output_ids.push(output_id);edges_quantity.push(1);removed_edges.push(id,output_id)}}if(input_id!=-1){var from_index=m_graph.get_edge_attr(graph,input_id,id,0)[0];for(var j=0;j<output_ids.length;j++)for(var k=
0;k<edges_quantity[j];k++){var to_index=m_graph.get_edge_attr(graph,id,output_ids[j],k)[1];m_graph.append_edge(graph,input_id,output_ids[j],[from_index,to_index])}}for(var j=0;j<removed_edges.length;j+=2)m_graph.remove_edge(graph,removed_edges[j],removed_edges[j+1],-1)}}}function get_in_edge_by_input_num(graph,node,input_num){var edges=graph.edges;for(var i=0;i<edges.length;i+=3)if(edges[i+1]==node){var num=edges[i+2][1];if(num==input_num)return edges[i]}return-1}function merge_nodes(graph){merge_geometry(graph);
merge_textures(graph);merge_uvs(graph)}function merge_uvs(graph,shader_type){var id_attr=[];var uv_0="";var uv_1="";var uv_counter={};m_graph.traverse(graph,function(id,attr){if(attr.type=="GEOMETRY_UV"||attr.type=="UVMAP"||attr.type=="TEX_COORD_UV"){id_attr.push(id,attr);var curr_uv_layer=attr.data.value;if(!uv_0){uv_0=curr_uv_layer;uv_counter[uv_0]=0}else if(uv_0!=curr_uv_layer&&!uv_1){uv_1=curr_uv_layer;uv_counter[uv_1]=0}uv_counter[curr_uv_layer]++}});for(var curr_uv_layer in uv_counter)if(uv_counter[curr_uv_layer]<
2){for(var i=0;i<id_attr.length;i=i+2)if(id_attr[i+1].data.value==curr_uv_layer)id_attr.splice(i,2);delete uv_counter[curr_uv_layer];if(uv_0==curr_uv_layer){uv_0=uv_1;uv_1=""}if(uv_1==curr_uv_layer)uv_1=""}if(id_attr.length<3)return;var node_name="";var UV_geom={"default_value":[0,0,0],"identifier":"UV_geom","is_linked":false,"name":"UV_geom"};var UV_cycles={"default_value":[0,0,0],"identifier":"UV_cycles","is_linked":false,"name":"UV_cycles"};var uv_0_node=init_bpy_node("merged_uv","UV_MERGED",[],
[UV_geom,UV_cycles]);uv_0_node["uv_layer"]=uv_0;append_nmat_node(graph,uv_0_node,0,null,"",shader_type);var uv_0_node_id=graph.nodes[graph.nodes.length-2];uv_0_node=graph.nodes[graph.nodes.length-1];if(uv_1){var uv_1_node=init_bpy_node("merged_uv","UV_MERGED",[],[UV_geom,UV_cycles]);uv_1_node["uv_layer"]=uv_1;append_nmat_node(graph,uv_1_node,0,null,"",shader_type);var uv_1_node_id=graph.nodes[graph.nodes.length-2];uv_1_node=graph.nodes[graph.nodes.length-1]}else var uv_1_node=null;var unode_id=-1;
var unode=null;for(var i=0;i<id_attr.length;i+=2){var id_current=id_attr[i];var attr_current=id_attr[i+1];if(can_merge_nodes_uv(attr_current,id_attr[1])){unode_id=uv_0_node_id;unode=uv_0_node}else if(uv_1_node){unode_id=uv_1_node_id;unode=uv_1_node}var removed_edges=[];var out_num=m_graph.out_edge_count(graph,id_current);var edges_out_counter={};for(k=0;k<out_num;k++){var out_id=m_graph.get_out_edge(graph,id_current,k);if(!(out_id in edges_out_counter))edges_out_counter[out_id]=0;var edge_attr=m_graph.get_edge_attr(graph,
id_current,out_id,edges_out_counter[out_id]++);removed_edges.push(id_current,out_id,edge_attr);var new_edge_attr=edge_attr.splice(0,edge_attr.length);switch(attr_current.type){case "GEOMETRY_UV":new_edge_attr[0]=0;unode.outputs[0].is_linked=true;break;case "UVMAP":case "TEX_COORD_UV":new_edge_attr[0]=1;unode.outputs[1].is_linked=true;break}m_graph.append_edge(graph,unode_id,out_id,new_edge_attr)}for(var k=0;k<removed_edges.length;k+=3)m_graph.remove_edge(graph,removed_edges[k],removed_edges[k+1],
0);m_graph.remove_node(graph,id_current)}}function merge_geometry(graph){var id_attr=[];m_graph.traverse(graph,function(id,attr){if(attr.type=="GEOMETRY_VC"||attr.type=="GEOMETRY_NO"||attr.type=="GEOMETRY_FB"||attr.type=="GEOMETRY_VW"||attr.type=="GEOMETRY_GL"||attr.type=="GEOMETRY_LO"||attr.type=="GEOMETRY_OR")id_attr.push(id,attr)});var unique_nodes=[];for(var i=0;i<id_attr.length;i+=2){var id_current=id_attr[i];var attr_current=id_attr[i+1];var is_unique=true;for(var j=0;j<unique_nodes.length;j++){var unode=
unique_nodes[j];if(can_merge_nodes(attr_current,unode.attr)){var removed_edges=[];var out_num=m_graph.out_edge_count(graph,id_current);for(k=0;k<out_num;k++){var out_id=m_graph.get_out_edge(graph,id_current,k);var edge_attr=m_graph.get_edge_attr(graph,id_current,out_id,0);removed_edges.push(id_current,out_id,edge_attr);m_graph.append_edge(graph,unode.id,out_id,edge_attr)}for(var k=0;k<removed_edges.length;k+=3)m_graph.remove_edge(graph,removed_edges[k],removed_edges[k+1],0);m_graph.remove_node(graph,
id_current);is_unique=false;break}}if(is_unique){var unode={id:id_current,attr:attr_current};unique_nodes.push(unode)}}}function get_attrs_ascendants(graph){var attrs_ascendants={};for(var i=0;i<graph.nodes.length;i+=2){var id=graph.nodes[i];attrs_ascendants[id]=[]}for(var i=0;i<graph.edges.length;i+=3){var id_from=graph.edges[i];var id_to=graph.edges[i+1];insert_id_ascendant_lists(attrs_ascendants[id_to],id_from);merge_ascendant_lists(attrs_ascendants[id_to],attrs_ascendants[id_from])}return attrs_ascendants}
function insert_id_ascendant_lists(list,id){for(var i=0;i<=list.length;i++){if(i>=list.length||list[i]>id)list.splice(i,0,id);else if(list[i]!=id)continue;return}}function merge_ascendant_lists(list1,list2){var index1=0;var index2=0;var result_length=list1.length+list2.length;var result_list=[];for(var i=0;i<result_length;i++)if(index1>list1.length||list1[index1]>list2[index2])result_list.push(list2[index2++]);else result_list.push(list1[index1++]);list1=result_list}function merge_textures(graph){var id_attr=
[];m_graph.traverse(graph,function(id,attr){if(attr.type=="TEXTURE_COLOR"||attr.type=="TEXTURE_NORMAL")id_attr.push(id,attr)});if(!id_attr.length)return;var ascs=get_attrs_ascendants(graph);var unique_nodes=[];for(var i=0;i<id_attr.length;i+=2){var id_current=id_attr[i];var attr_current=id_attr[i+1];var is_unique=true;for(var j=0;j<unique_nodes.length;j++){var unode=unique_nodes[j];if(unode.merged_nodes.length>=3)continue;if(!can_merge_nodes(attr_current,unode.attr))continue;if(ascs[id_current].indexOf(unode.id)>
-1||ascs[unode.id].indexOf(id_current)>-1)continue;var is_reachable=false;for(var k=0;k<unode.merged_nodes.length;k++){var merged_id=unode.merged_nodes[k].id;if(ascs[id_current].indexOf(merged_id)>-1||ascs[merged_id].indexOf(id_current)>-1){is_reachable=true;break}}if(is_reachable)continue;var removed_edges_in=[];var in_num=m_graph.in_edge_count(graph,id_current);var edges_in_counter={};for(k=0;k<in_num;k++){var in_id=m_graph.get_in_edge(graph,id_current,k);if(!(in_id in edges_in_counter))edges_in_counter[in_id]=
0;var edge_attr=m_graph.get_edge_attr(graph,in_id,id_current,edges_in_counter[in_id]++);removed_edges_in.push(in_id,id_current,edge_attr)}var removed_edges_out=[];var out_num=m_graph.out_edge_count(graph,id_current);var edges_out_counter={};for(k=0;k<out_num;k++){var out_id=m_graph.get_out_edge(graph,id_current,k);if(!(out_id in edges_out_counter))edges_out_counter[out_id]=0;var edge_attr=m_graph.get_edge_attr(graph,id_current,out_id,edges_out_counter[out_id]++);removed_edges_out.push(id_current,
out_id,edge_attr)}var removed_edges=removed_edges_in.concat(removed_edges_out);for(var k=0;k<removed_edges.length;k+=3)m_graph.remove_edge(graph,removed_edges[k],removed_edges[k+1],0);m_graph.remove_node(graph,id_current);var mnode={id:id_current,attr:attr_current,edges_in:removed_edges_in,edges_out:removed_edges_out};unode.merged_nodes.push(mnode);is_unique=false;break}if(is_unique){var unode={id:id_current,attr:attr_current,merged_nodes:[]};unique_nodes.push(unode)}}for(var i=0;i<unique_nodes.length;i++){var unode=
unique_nodes[i];var mnodes_count=unode.merged_nodes.length;for(var j=0;j<mnodes_count;j++){var merged_data=unode.merged_nodes[j];var mnode=merged_data.attr;var edges_in=merged_data.edges_in;var edges_out=merged_data.edges_out;unode.attr.inputs[j+1].is_linked=mnode.inputs[0].is_linked;unode.attr.inputs[j+1].default_value=mnode.inputs[0].default_value;unode.attr.outputs[2*(j+1)].is_linked=mnode.outputs[0].is_linked;unode.attr.outputs[2*(j+1)].default_value=mnode.outputs[0].default_value;unode.attr.outputs[2*
(j+1)+1].is_linked=mnode.outputs[1].is_linked;unode.attr.outputs[2*(j+1)+1].default_value=mnode.outputs[1].default_value;for(var k=0;k<edges_in.length;k+=3){var in_id=edges_in[k];var edge_attr=edges_in[k+2];edge_attr[1]+=j+1;m_graph.append_edge(graph,in_id,unode.id,edge_attr)}for(var k=0;k<edges_out.length;k+=3){var out_id=edges_out[k+1];var edge_attr=edges_out[k+2];edge_attr[0]+=(j+1)*2;m_graph.append_edge(graph,unode.id,out_id,edge_attr)}unode.attr.dirs.push(["USE_uv"+(j+2),1])}m_graph.remove_node(graph,
unode.id);m_graph.append_node(graph,unode.id,unode.attr)}}function can_merge_nodes(attr1,attr2){if(attr1.type!==attr2.type)return false;switch(attr1.type){case "GEOMETRY_VC":return attr1.data.value==attr2.data.value;case "GEOMETRY_NO":case "GEOMETRY_FB":case "GEOMETRY_VW":case "GEOMETRY_GL":case "GEOMETRY_LO":case "GEOMETRY_OR":return true;case "TEXTURE_COLOR":case "TEXTURE_NORMAL":return attr1.data.value==attr2.data.value;default:return false}}function can_merge_nodes_uv(attr1,attr2){var permissible_types=
["GEOMETRY_UV","TEX_COORD_UV","UVMAP"];if(permissible_types.indexOf(attr1.type)!=-1&&permissible_types.indexOf(attr2.type)!=-1)return attr1.data.value==attr2.data.value;return false}function optimize_geometry_vcol(graph){var id_attr=[];m_graph.traverse(graph,function(id,attr){if(attr.type=="GEOMETRY_VC")id_attr.push(id,attr)});for(var i=0;i<id_attr.length;i+=2){var geom_id=id_attr[i];var geom_attr=id_attr[i+1];var need_optimize=false;var removed_edges=[];var removed_seprgb_nodes=[];var channels_usage=
[[],[],[]];var geometry_out_num=m_graph.out_edge_count(graph,geom_id);for(var j=0;j<geometry_out_num;j++){var out_id=m_graph.get_out_edge(graph,geom_id,j);var out_node=m_graph.get_node_attr(graph,out_id);if(out_node.type!="SEPRGB"){need_optimize=false;break}removed_edges.push(geom_id,out_id);var edges_out_num={};var seprgb_out_num=m_graph.out_edge_count(graph,out_id);for(var k=0;k<seprgb_out_num;k++){var seprgb_out_id=m_graph.get_out_edge(graph,out_id,k);if(!(seprgb_out_id in edges_out_num))edges_out_num[seprgb_out_id]=
0;var edge_attr=m_graph.get_edge_attr(graph,out_id,seprgb_out_id,edges_out_num[seprgb_out_id]++);removed_edges.push(out_id,seprgb_out_id);channels_usage[edge_attr[0]].push(geom_id,seprgb_out_id,edge_attr)}removed_seprgb_nodes.push(out_id);need_optimize=true}if(need_optimize){var channels_count=0;var mask=0;for(var j=0;j<channels_usage.length;j++)if(channels_usage[j].length){channels_count++;mask|=1<<2-j}if(channels_count){geom_attr.type+=channels_count;geom_attr.outputs=[];for(var j=0;j<channels_usage.length;j++)if(channels_usage[j].length){geom_attr.outputs.push({default_value:0,
identifier:"RGB"[j],is_linked:true,name:"RGB"[j]});for(var k=0;k<channels_usage[j].length;k+=3)channels_usage[j][k+2][0]=m_util.rgb_mask_get_channel_presence_index(mask,j)}for(var j=0;j<removed_edges.length;j+=2)m_graph.remove_edge(graph,removed_edges[j],removed_edges[j+1],0);for(var j=0;j<removed_seprgb_nodes.length;j++)m_graph.remove_node(graph,removed_seprgb_nodes[j]);for(var j=0;j<channels_usage.length;j++)for(var k=0;k<channels_usage[j].length;k+=3)m_graph.append_edge(graph,channels_usage[j][k],
channels_usage[j][k+1],channels_usage[j][k+2])}}}}function find_node_id(node_tree,graph,type,source_type,is_group_node,suppress_errors){var bpy_nodes=node_tree["nodes"];var last_output_node=null;for(var i=0;i<bpy_nodes.length;i++){var bpy_node=bpy_nodes[i];if(is_group_node){if(bpy_node["type"]=="GROUP"&&bpy_node["node_tree_name"]==type)last_output_node=bpy_node}else if(bpy_node["type"]==type)last_output_node=bpy_node}if(!last_output_node){if(!suppress_errors)m_print.error('No "'+type+'" node in node '+
source_type);return-1}return nmat_node_ids(last_output_node,graph)[0]}function init_bpy_node(name,type,inputs,outputs){var node={"name":name,"type":type,"inputs":inputs,"outputs":outputs};return node}function init_bpy_link(from_node,from_socket,to_node,to_socket){var link={"from_node":from_node,"from_socket":from_socket,"to_node":to_node,"to_socket":to_socket};return link}function append_nmat_node(graph,bpy_node,output_num,anim_data,mat_name,shader_type){var name=bpy_node["name"];var type=bpy_node["type"];
var vparams=[];var inputs=[];var outputs=[];var params=[];var data=null;var dirs=[];switch(type){case "BSDF_ANISOTROPIC":case "BSDF_DIFFUSE":case "BSDF_GLOSSY":case "BSDF_GLASS":case "BSDF_HAIR":case "BSDF_TRANSPARENT":case "BSDF_TRANSLUCENT":case "BSDF_REFRACTION":case "BSDF_TOON":case "BSDF_VELVET":case "SUBSURFACE_SCATTERING":case "EMISSION":case "AMBIENT_OCCLUSION":case "VOLUME_ABSORPTION":case "VOLUME_SCATTER":case "BUMP":case "NORMAL_MAP":case "VECT_TRANSFORM":case "BLACKBODY":case "WAVELENGTH":case "SEPXYZ":case "COMBXYZ":case "LIGHT_FALLOFF":case "TEX_IMAGE":case "TEX_ENVIRONMENT":case "TEX_SKY":case "TEX_NOISE":case "TEX_WAVE":case "TEX_MUSGRAVE":case "TEX_GRADIENT":case "TEX_MAGIC":case "TEX_CHECKER":case "TEX_BRICK":case "WIREFRAME":case "LAYER_WEIGHT":case "TANGENT":case "LIGHT_PATH":case "ATTRIBUTE":case "HOLDOUT":case "PARTICLE_INFO":case "HAIR_INFO":case "OBJECT_INFO":case "SCRIPT":case "NEW_GEOMETRY":inputs=
node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);m_print.warn(type+" node is not fully supported.");break;case "BRIGHTCONTRAST":case "ADD_SHADER":case "MIX_SHADER":inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);break;case "UVMAP":var uv_layer=bpy_node["uv_layer"];if(!uv_layer)type="EMPTY_UV";if(type!="EMPTY_UV"){var uv_name=shader_ident("param_"+type+"_a");var uv_tra_name=shader_ident("param_"+type+"_v");vparams.push(node_param(uv_name));
vparams.push(node_param(uv_tra_name));params.push(node_param(uv_tra_name));data={name:uv_name,value:uv_layer}}outputs=node_outputs_bpy_to_b4w(bpy_node);break;case "UV_MERGED":var uv_name=shader_ident("param_UV_MERGED_a");var uv_tra_name=shader_ident("param_UV_MERGED_v");vparams.push(node_param(uv_name));vparams.push(node_param(uv_tra_name));outputs.push(node_output_by_ident(bpy_node,"UV_geom"));outputs.push(node_output_by_ident(bpy_node,"UV_cycles"));params.push(node_param(uv_tra_name));data={name:uv_name,
value:bpy_node["uv_layer"]};break;case "CAMERA":inputs=[];outputs=node_outputs_bpy_to_b4w(bpy_node);break;case "COMBRGB":case "COMBHSV":inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);break;case "CURVE_RGB":inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);m_print.warn("CURVE_RGB node is not fully supported.");break;case "CURVE_VEC":inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);m_print.warn("CURVE_VEC node is not fully supported.");
break;case "GEOMETRY":if(!check_input_node_outputs(bpy_node))return true;type=geometry_node_type(bpy_node,output_num);if(!type){m_print.error("Geometry output is not supported");return null}switch(type){case "GEOMETRY_UV":var curr_uv_layer=bpy_node["uv_layer"];if(!curr_uv_layer)type="EMPTY_UV";if(type!="EMPTY_UV"){var uv_name=shader_ident("param_GEOMETRY_UV_a");var uv_tra_name=shader_ident("param_GEOMETRY_UV_v");vparams.push(node_param(uv_name));vparams.push(node_param(uv_tra_name));params.push(node_param(uv_tra_name));
data={name:uv_name,value:curr_uv_layer}}outputs.push(node_output_by_ident(bpy_node,"UV"));break;case "GEOMETRY_VC":var curr_color_layer=bpy_node["color_layer"];if(!curr_color_layer)type="EMPTY_VC";if(type!="EMPTY_VC"){var vc_name=shader_ident("param_GEOMETRY_VC_a");var vc_tra_name=shader_ident("param_GEOMETRY_VC_v");vparams.push(node_param(vc_name));vparams.push(node_param(vc_tra_name));params.push(node_param(vc_tra_name));data={name:vc_name,value:curr_color_layer}}outputs.push(node_output_by_ident(bpy_node,
"Vertex Color"));break;case "GEOMETRY_NO":outputs.push(node_output_by_ident(bpy_node,"Normal"));break;case "GEOMETRY_FB":outputs.push(node_output_by_ident(bpy_node,"Front/Back"));break;case "GEOMETRY_VW":outputs.push(node_output_by_ident(bpy_node,"View"));break;case "GEOMETRY_GL":outputs.push(node_output_by_ident(bpy_node,"Global"));break;case "GEOMETRY_LO":outputs.push(node_output_by_ident(bpy_node,"Local"));break;case "GEOMETRY_OR":var or_tra_name=shader_ident("param_GEOMETRY_OR_v");vparams.push(node_param(or_tra_name));
outputs.push(node_output_by_ident(bpy_node,"Orco"));params.push(node_param(or_tra_name));break}break;case "TEX_COORD":if(!check_input_node_outputs(bpy_node))return true;type=tex_coord_node_type(bpy_node,output_num);if(!type){m_print.error("Texture coordinate output is not supported");return null}switch(type){case "TEX_COORD_UV":var uv_layer=bpy_node["uv_layer"];if(!uv_layer)type="EMPTY_UV";if(type!="EMPTY_UV"){var uv_name=shader_ident("param_TEX_COORD_UV_a");var uv_tra_name=shader_ident("param_TEX_COORD_UV_v");
vparams.push(node_param(uv_name));vparams.push(node_param(uv_tra_name));params.push(node_param(uv_tra_name));data={name:uv_name,value:bpy_node["uv_layer"]}}outputs.push(node_output_by_ident(bpy_node,"UV"));break;case "TEX_COORD_NO":outputs.push(node_output_by_ident(bpy_node,"Normal"));break;case "TEX_COORD_GE":var ge_tra_name=shader_ident("param_TEX_COORD_GE_v");vparams.push(node_param(ge_tra_name));outputs.push(node_output_by_ident(bpy_node,"Generated"));params.push(node_param(ge_tra_name));break;
case "TEX_COORD_OB":outputs.push(node_output_by_ident(bpy_node,"Object"));m_print.warn('Output "Object" of node "Texture Coordinate" doesn\'t supported fully.');break;case "TEX_COORD_CA":outputs.push(node_output_by_ident(bpy_node,"Camera"));break;case "TEX_COORD_WI":outputs.push(node_output_by_ident(bpy_node,"Window"));m_print.warn('Output "Window" of node "Texture Coordinate" doesn\'t supported fully.');break;case "TEX_COORD_RE":outputs.push(node_output_by_ident(bpy_node,"Reflection"));m_print.warn('Output "Reflection" of node "Texture Coordinate" doesn\'t supported fully.');
break}break;case "GROUP":var node_name=bpy_node["node_tree_name"];switch(node_name){case "B4W_LINEAR_TO_SRGB":if(!validate_custom_node_group(bpy_node,[1],[1])){data=process_node_group(bpy_node,mat_name,shader_type);break}type="B4W_LINEAR_TO_SRGB";break;case "B4W_NORMAL_VIEW":case "B4W_VECTOR_VIEW":if(!validate_custom_node_group(bpy_node,[1],[1])){data=process_node_group(bpy_node,mat_name,shader_type);break}type="B4W_VECTOR_VIEW";break;case "B4W_SRGB_TO_LINEAR":if(!validate_custom_node_group(bpy_node,
[1],[1])){data=process_node_group(bpy_node,mat_name,shader_type);break}type="B4W_SRGB_TO_LINEAR";break;case "B4W_REFLECT":if(!validate_custom_node_group(bpy_node,[1,1],[1])){data=process_node_group(bpy_node,mat_name,shader_type);break}type="B4W_REFLECT";break;case "B4W_REFRACTION":if(!validate_custom_node_group(bpy_node,[1,0],[1])){data=process_node_group(bpy_node,mat_name,shader_type);break}type="B4W_REFRACTION";break;case "B4W_PARALLAX":if(!validate_custom_node_group(bpy_node,[1,1,0,0,0],[1])){data=
process_node_group(bpy_node,mat_name,shader_type);break}type="B4W_PARALLAX";var tex_name=shader_ident("temp_texture");params.push(node_param(tex_name));break;case "B4W_CLAMP":if(!validate_custom_node_group(bpy_node,[1],[1])){data=process_node_group(bpy_node,mat_name,shader_type);break}type="B4W_CLAMP";break;case "B4W_TRANSLUCENCY":if(!validate_custom_node_group(bpy_node,[0,0,0,0,0],[0])){data=process_node_group(bpy_node,mat_name,shader_type);break}type="B4W_TRANSLUCENCY";break;case "B4W_TIME":if(!validate_custom_node_group(bpy_node,
[],[0])){data=process_node_group(bpy_node,mat_name,shader_type);break}type="B4W_TIME";break;case "B4W_SMOOTHSTEP":if(!validate_custom_node_group(bpy_node,[0,0,0],[0])){data=process_node_group(bpy_node,mat_name,shader_type);break}type="B4W_SMOOTHSTEP";break;case "B4W_GLOW_OUTPUT":type="B4W_GLOW_OUTPUT";break;default:data=process_node_group(bpy_node,mat_name,shader_type)}inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);if(node_name=="B4W_TRANSLUCENCY"){var out=default_node_inout("TranslucencyParams",
"TranslucencyParams",[0,0,0,0]);out.is_linked=outputs[0].is_linked;outputs.push(out)}break;case "LAMP":var bpy_lamp=bpy_node["lamp"];if(!bpy_lamp){m_print.error("There is no lamp in node: "+bpy_node["name"]);return null}outputs.push(node_output_by_ident(bpy_node,"Color"));outputs.push(node_output_by_ident(bpy_node,"Light Vector"));outputs.push(node_output_by_ident(bpy_node,"Distance"));outputs.push(node_output_by_ident(bpy_node,"Visibility Factor"));if(!(bpy_lamp["uuid"]in _lamp_indexes)){_lamp_indexes[bpy_lamp["uuid"]]=
_lamp_index;dirs.push(["LAMP_INDEX",String(_lamp_index++)])}else dirs.push(["LAMP_INDEX",String(_lamp_indexes[bpy_lamp["uuid"]])]);data=_lamp_indexes;break;case "LIGHTING_AMBIENT":inputs=[default_node_inout("E","E",[0,0,0],true),default_node_inout("A","A",[0,0,0],true),default_node_inout("D","D",[0,0,0],true)];outputs=[default_node_inout("color","color",[0,0,0],true),default_node_inout("specular","specular",[0,0,0],true)];break;case "LIGHTING_BEGIN":outputs=[default_node_inout("E","E",[0,0,0],true),
default_node_inout("A","A",[0,0,0],true),default_node_inout("D","D",[0,0,0],true),default_node_inout("S","S",[0,0,0],true),default_node_inout("normal","normal",[0,0,0],true),default_node_inout("dif_params","dif_params",[0,0],true),default_node_inout("sp_params","sp_params",[0,0],true),default_node_inout("shadow_factor","shadow_factor",0,true),default_node_inout("translucency_color","translucency_color",0,true),default_node_inout("translucency_params","translucency_params",[0,0,0,0],true)];break;case "LIGHTING_END":inputs=
[default_node_inout("color","color",[0,0,0],true),default_node_inout("specular","specular",[0,0,0],true)];break;case "LIGHTING_LAMP":inputs=[default_node_inout("shadow_factor","shadow_factor",0,true)];outputs=[default_node_inout("ldir","ldir",[0,0,0],true),default_node_inout("lfac","lfac",[0,0],true),default_node_inout("lcolorint","lcolorint",[0,0,0],true),default_node_inout("norm_fac","norm_fac",0,true)];break;case "DIFFUSE_LAMBERT":inputs=[default_node_inout("ldir","ldir",[0,0,0],true),default_node_inout("lfac",
"lfac",[0,0],true),default_node_inout("normal","normal",[0,0,0],true),default_node_inout("norm_fac","norm_fac",0,true)];outputs=[default_node_inout("lfactor","lfactor",0,true)];break;case "DIFFUSE_FRESNEL":case "DIFFUSE_MINNAERT":case "DIFFUSE_OREN_NAYAR":case "DIFFUSE_TOON":inputs=[default_node_inout("ldir","ldir",[0,0,0],true),default_node_inout("lfac","lfac",[0,0],true),default_node_inout("normal","normal",[0,0,0],true),default_node_inout("norm_fac","norm_fac",0,true),default_node_inout("dif_params",
"dif_params",[0,0],true)];outputs=[default_node_inout("lfactor","lfactor",0,true)];break;case "SPECULAR_BLINN":case "SPECULAR_PHONG":inputs=[default_node_inout("ldir","ldir",[0,0,0],true),default_node_inout("lfac","lfac",[0,0],true),default_node_inout("normal","normal",[0,0,0],true),default_node_inout("norm_fac","norm_fac",0,true),default_node_inout("sp_params","sp_params",[0,0],true)];outputs=[default_node_inout("sfactor","sfactor",0,true)];break;case "SPECULAR_TOON":case "SPECULAR_WARDISO":inputs=
[default_node_inout("ldir","ldir",[0,0,0],true),default_node_inout("lfac","lfac",[0,0],true),default_node_inout("normal","normal",[0,0,0],true),default_node_inout("sp_params","sp_params",[0,0],true)];outputs=[default_node_inout("sfactor","sfactor",0,true)];break;case "LIGHTING_APPLY":inputs=[default_node_inout("color","color",[0,0,0,0],true),default_node_inout("specular","specular",[0,0,0],true),default_node_inout("lfactor","lfactor",0,true),default_node_inout("sfactor","sfactor",0,true),default_node_inout("ldir",
"ldir",[0,0,0],true),default_node_inout("normal","normal",[0,0,0],true),default_node_inout("translucency_params","translucency_params",[0,0,0,0],true),default_node_inout("D","D",[0,0,0],true),default_node_inout("S","S",[0,0,0],true),default_node_inout("lcolorint","lcolorint",[0,0,0],true),default_node_inout("translucency_color","translucency_color",0,true)];outputs=[default_node_inout("color","color",[0,0,0,0],true),default_node_inout("specular","specular",[0,0,0],true)];break;case "NORMAL":inputs=
node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);var output_norm=node_output_by_ident(bpy_node,"Normal");params.push(node_param(shader_ident("param_NORMAL_Normal"),output_norm.default_value,3));break;case "MAPPING":var vector_type=bpy_node["vector_type"];type="MAPPING";inputs.push(node_input_by_ident(bpy_node,"Vector"));outputs.push(node_output_by_ident(bpy_node,"Vector"));var rot=bpy_node["rotation"];var scale=bpy_node["scale"];var trans=bpy_node["translation"];var trs_matrix=
m_mat3.create();var rot_matrix=m_util.euler_to_rotation_matrix(rot);if(vector_type=="TEXTURE"){scale[0]=scale[0]||1;scale[1]=scale[1]||1;scale[2]=scale[2]||1}var scale_matrix=new Float32Array([scale[0],0,0,0,scale[1],0,0,0,scale[2]]);m_mat3.multiply(rot_matrix,scale_matrix,trs_matrix);trs_matrix=m_util.mat3_to_mat4(trs_matrix,m_mat4.create());switch(vector_type){case "POINT":trs_matrix[12]=trans[0];trs_matrix[13]=trans[1];trs_matrix[14]=trans[2];break;case "TEXTURE":trs_matrix[12]=trans[0];trs_matrix[13]=
trans[1];trs_matrix[14]=trans[2];trs_matrix=m_mat4.invert(trs_matrix,trs_matrix);break;case "NORMAL":m_mat4.invert(trs_matrix,trs_matrix);m_mat4.transpose(trs_matrix,trs_matrix);break}switch(vector_type){case "NORMAL":dirs.push(["MAPPING_IS_NORMAL",1]);case "TEXTURE":dirs.push(["MAPPING_TRS_MATRIX",m_shaders.glsl_value(trs_matrix,16)]);break;case "POINT":if(m_vec3.length(rot)!==0)dirs.push(["MAPPING_TRS_MATRIX",m_shaders.glsl_value(trs_matrix,16)]);else{if(m_vec3.length(scale)!==0)dirs.push(["MAPPING_SCALE",
m_shaders.glsl_value(scale,3)]);if(m_vec3.length(trans)!==0)dirs.push(["MAPPING_TRANSLATION",m_shaders.glsl_value(trans,3)])}break;case "VECTOR":if(m_vec3.length(rot)!==0)dirs.push(["MAPPING_TRS_MATRIX",m_shaders.glsl_value(trs_matrix,16)]);else if(m_vec3.length(scale)!==0)dirs.push(["MAPPING_SCALE",m_shaders.glsl_value(scale,3)]);break}if(bpy_node["use_min"])dirs.push(["MAPPING_MIN_CLIP",m_shaders.glsl_value(bpy_node["min"],3)]);if(bpy_node["use_max"])dirs.push(["MAPPING_MAX_CLIP",m_shaders.glsl_value(bpy_node["max"],
3)]);break;case "MATERIAL":case "MATERIAL_EXT":var material_begin_dirs=[];var material_end_dirs=[];var material_begin_inputs=[];var material_begin_outputs=[default_node_inout("E","E",[0,0,0],true),default_node_inout("A","A",[0,0,0],true),default_node_inout("D","D",[0,0,0],true),default_node_inout("S","S",[0,0,0],true),default_node_inout("normal","normal",[0,0,0],true),default_node_inout("dif_params","dif_params",[0,0],true),default_node_inout("sp_params","sp_params",[0,0],true),default_node_inout("shadow_factor",
"shadow_factor",0,true)];var material_end_inputs=[default_node_inout("color","color",[0,0,0],true),default_node_inout("specular","specular",[0,0,0],true),default_node_inout("normal","normal",[0,0,0],true)];var material_end_outputs=[node_output_by_ident(bpy_node,"Color"),node_output_by_ident(bpy_node,"Alpha"),node_output_by_ident(bpy_node,"Normal")];var material_end_params=[];var input=node_input_by_ident(bpy_node,"Color");input.default_value.splice(3);material_begin_inputs.push(input);inputs.push(input);
input=node_input_by_ident(bpy_node,"Spec");input.default_value.splice(3);material_begin_inputs.push(input);inputs.push(input);material_begin_inputs.push(default_node_inout("DiffuseIntensity","DiffuseIntensity",bpy_node["diffuse_intensity"]));inputs.push(input);var input_norm=node_input_by_ident(bpy_node,"Normal");input_norm.default_value.splice(3);material_begin_inputs.push(input_norm);inputs.push(input_norm);if(type=="MATERIAL_EXT"){input=node_input_by_ident(bpy_node,"Emit");if(!input)input=default_node_inout("Emit",
"Emit",0);material_begin_inputs.push(input);inputs.push(input);input=node_input_by_ident(bpy_node,"Translucency");if(input){input.default_value=0;input.name="Translucency";input.identifier="Translucency"}else input=default_node_inout("Translucency","Translucency",0);inputs.push(input);input=node_input_by_ident(bpy_node,"Translucency");if(input){input.default_value=[0,0,0,0];input.name="TranslucencyParams";input.identifier="TranslucencyParams"}else input=default_node_inout("TranslucencyParams","TranslucencyParams",
[0,0,0,0]);inputs.push(input);var input_new=node_input_by_ident(bpy_node,"Reflectivity");var input_old=node_input_by_ident(bpy_node,"Ray Mirror");if(input_new){input=input_new;var input_name="Reflectivity"}else if(input_old){input=input_old;var input_name="Ray Mirror"}else{input=input_new;var input_name="Reflectivity"}if(!input)input=default_node_inout(input_name,input_name,0);inputs.push(input);material_end_inputs.push(input);input=node_input_by_ident(bpy_node,"SpecTra");if(!input)input=default_node_inout("SpecTra",
"SpecTra",0);inputs.push(input);material_end_inputs.push(input);input=node_input_by_ident(bpy_node,"Alpha");if(!input)input=default_node_inout("Alpha","Alpha",bpy_node["alpha"]);inputs.push(input);material_end_inputs.push(input);material_end_outputs.push(node_output_by_ident(bpy_node,"Diffuse"));material_end_outputs.push(node_output_by_ident(bpy_node,"Spec"));material_begin_dirs.push(["MATERIAL_EXT",1]);material_end_dirs.push(["MATERIAL_EXT",1])}else{material_begin_inputs.push(default_node_inout("emit_intensity",
"emit_intensity",0));material_end_inputs.push(default_node_inout("reflect_factor","reflect_factor",0));material_end_inputs.push(default_node_inout("specular_alpha","specular_alpha",0));material_end_inputs.push(default_node_inout("alpha_in","alpha_in",0));material_end_outputs.push(default_node_inout("diffuse_out","diffuse_out",0));material_end_outputs.push(default_node_inout("spec_out","spec_out",0));material_begin_dirs.push(["MATERIAL_EXT",0]);material_end_dirs.push(["MATERIAL_EXT",0])}material_end_params.push(node_param(shader_ident("param_MATERIAL_alpha"),
bpy_node["alpha"]));material_end_params.push(node_param(shader_ident("param_MATERIAL_spec_alpha"),bpy_node["specular_alpha"]));outputs=material_end_outputs;if(input_norm.is_linked)material_begin_dirs.push(["USE_MATERIAL_NORMAL",1]);if(bpy_node["use_diffuse"]){material_begin_dirs.push(["USE_MATERIAL_DIFFUSE",1]);material_end_dirs.push(["USE_MATERIAL_DIFFUSE",1])}if(bpy_node["use_specular"])material_end_dirs.push(["USE_MATERIAL_SPECULAR",1]);var material_begin_params=[];var spec_param_0;var spec_param_1=
0;switch(bpy_node["specular_shader"]){case "COOKTORR":case "PHONG":spec_param_0=bpy_node["specular_hardness"];break;case "WARDISO":spec_param_0=bpy_node["specular_slope"];break;case "TOON":spec_param_0=bpy_node["specular_toon_size"];spec_param_1=bpy_node["specular_toon_smooth"];break;case "BLINN":spec_param_0=bpy_node["specular_ior"];spec_param_1=bpy_node["specular_hardness"];break;default:m_print.error("unsupported specular shader: "+bpy_node["specular_shader"]+' (material "'+bpy_node["material_name"]+
'")');spec_param_0=bpy_node["specular_hardness"];break}var diffuse_param;var diffuse_param2;switch(bpy_node["diffuse_shader"]){case "LAMBERT":diffuse_param=0;diffuse_param2=0;break;case "OREN_NAYAR":diffuse_param=bpy_node["roughness"];diffuse_param2=0;break;case "FRESNEL":diffuse_param=bpy_node["diffuse_fresnel"];diffuse_param2=bpy_node["diffuse_fresnel_factor"];break;case "MINNAERT":diffuse_param=bpy_node["darkness"];diffuse_param2=0;break;case "TOON":diffuse_param=bpy_node["diffuse_toon_size"];
diffuse_param2=bpy_node["diffuse_toon_smooth"];break;default:m_print.error("unsupported diffuse shader: "+bpy_node["diffuse_shader"]+' (material "'+bpy_node["material_name"]+'")');diffuse_param=0;diffuse_param2=0;break}material_begin_params.push(node_param(shader_ident("param_MATERIAL_diffuse"),[diffuse_param,diffuse_param2],2));material_begin_params.push(node_param(shader_ident("param_MATERIAL_spec"),[bpy_node["specular_intensity"],spec_param_0,spec_param_1],3));material_begin_dirs.push(["SHADELESS_MAT",
bpy_node["use_shadeless"]?1:0]);var path_data={name:bpy_node["name"],value:{specular_shader:bpy_node["specular_shader"],diffuse_shader:bpy_node["diffuse_shader"],use_shadeless:bpy_node["use_shadeless"]}};var material_begin={"name":"material_begin","type":"MATERIAL_BEGIN",inputs:material_begin_inputs,outputs:material_begin_outputs,params:material_begin_params,data:path_data,dirs:material_begin_dirs,vparams:[]};var material_end={"name":"material_end","type":"MATERIAL_END",inputs:material_end_inputs,
outputs:material_end_outputs,params:material_end_params,data:path_data,dirs:material_end_dirs,vparams:[]};data={name:bpy_node["name"],value:{specular_shader:bpy_node["specular_shader"],diffuse_shader:bpy_node["diffuse_shader"],use_shadeless:bpy_node["use_shadeless"]},material_begin:material_begin,material_end:material_end};break;case "MATH":switch(bpy_node["operation"]){case "ADD":type="MATH_ADD";break;case "SUBTRACT":type="MATH_SUBTRACT";break;case "MULTIPLY":type="MATH_MULTIPLY";break;case "DIVIDE":type=
"MATH_DIVIDE";break;case "SINE":type="MATH_SINE";break;case "COSINE":type="MATH_COSINE";break;case "TANGENT":type="MATH_TANGENT";break;case "ARCSINE":type="MATH_ARCSINE";break;case "ARCCOSINE":type="MATH_ARCCOSINE";break;case "ARCTANGENT":type="MATH_ARCTANGENT";break;case "POWER":type="MATH_POWER";break;case "LOGARITHM":type="MATH_LOGARITHM";break;case "MINIMUM":type="MATH_MINIMUM";break;case "MAXIMUM":type="MATH_MAXIMUM";break;case "ROUND":type="MATH_ROUND";break;case "LESS_THAN":type="MATH_LESS_THAN";
break;case "GREATER_THAN":type="MATH_GREATER_THAN";break;case "MODULO":type="MATH_MODULO";break;case "ABSOLUTE":type="MATH_ABSOLUTE";break;default:m_print.error("Unsupported MATH operation: "+bpy_node["operation"]);return null}dirs.push(["MATH_USE_CLAMP",Number(bpy_node["use_clamp"])]);inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);break;case "MIX_RGB":switch(bpy_node["blend_type"]){case "MIX":type="MIX_RGB_MIX";break;case "ADD":type="MIX_RGB_ADD";break;case "MULTIPLY":type=
"MIX_RGB_MULTIPLY";break;case "SUBTRACT":type="MIX_RGB_SUBTRACT";break;case "SCREEN":type="MIX_RGB_SCREEN";break;case "DIVIDE":type="MIX_RGB_DIVIDE";break;case "DIFFERENCE":type="MIX_RGB_DIFFERENCE";break;case "DARKEN":type="MIX_RGB_DARKEN";break;case "LIGHTEN":type="MIX_RGB_LIGHTEN";break;case "OVERLAY":type="MIX_RGB_OVERLAY";break;case "DODGE":type="MIX_RGB_DODGE";break;case "BURN":type="MIX_RGB_BURN";break;case "HUE":type="MIX_RGB_HUE";break;case "SATURATION":type="MIX_RGB_SATURATION";break;case "VALUE":type=
"MIX_RGB_VALUE";break;case "COLOR":type="MIX_RGB_COLOR";break;case "SOFT_LIGHT":type="MIX_RGB_SOFT_LIGHT";break;case "LINEAR_LIGHT":type="MIX_RGB_LINEAR_LIGHT";break;default:m_print.error("Unsupported MIX_RGB blend type: "+bpy_node["blend_type"]);return null}dirs.push(["MIX_RGB_USE_CLAMP",Number(bpy_node["use_clamp"])]);inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);break;case "OUTPUT":inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=[];break;case "RGB":var param_name=
mat_name+"%join%"+bpy_node["name"];var param={name:"-1",value:param_name};params.push(param);outputs.push(node_output_by_ident(bpy_node,"Color"));break;case "SEPRGB":case "SEPHSV":inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);break;case "TEXTURE":type=texture_node_type(bpy_node);if(type=="TEXTURE_EMPTY"){outputs.push(node_output_by_ident(bpy_node,"Color"));outputs.push(node_output_by_ident(bpy_node,"Normal"));outputs.push(node_output_by_ident(bpy_node,"Value"))}else if(type==
"TEXTURE_ENVIRONMENT"){inputs.push(node_input_by_ident(bpy_node,"Vector"));outputs.push(node_output_by_ident(bpy_node,"Color"));outputs.push(node_output_by_ident(bpy_node,"Value"))}else{if(type=="TEXTURE_NORMAL")if(bpy_node["texture"]["type"]=="ENVIRONMENT_MAP"){m_print.error("Wrong output for ENVIRONMENT_MAP texture: "+bpy_node["name"]);return null}for(var i=0;i<4;++i){var input,output1,output2;if(i){input=default_node_inout("Vector"+i,"Vector"+i,[0,0,0]);if(type=="TEXTURE_COLOR"){output1=default_node_inout("Color"+
i,"Color"+i,[0,0,0]);output2=default_node_inout("Value"+i,"Value"+i,0)}if(type=="TEXTURE_NORMAL"){output1=default_node_inout("Normal"+i,"Normal"+i,[0,0,0]);output2=default_node_inout("Value"+i,"Value"+i,0)}}else{input=node_input_by_ident(bpy_node,"Vector");if(type=="TEXTURE_COLOR"){output1=node_output_by_ident(bpy_node,"Color");output2=node_output_by_ident(bpy_node,"Value")}if(type=="TEXTURE_NORMAL"){output1=node_output_by_ident(bpy_node,"Normal");output2=node_output_by_ident(bpy_node,"Value")}}inputs.push(input);
outputs.push(output1);outputs.push(output2)}}var tex_name=shader_ident("param_TEXTURE_texture");params.push(node_param(tex_name));data={name:tex_name,value:bpy_node["texture"]};break;case "VALTORGB":inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);m_print.warn("VALTORGB node is not fully supported.");break;case "VALUE":type="VALUE";var param_name=mat_name+"%join%"+bpy_node["name"];var param={name:"-1",value:param_name};params.push(param);outputs.push(node_output_by_ident(bpy_node,
"Value"));break;case "VECT_MATH":switch(bpy_node["operation"]){case "ADD":type="VECT_MATH_ADD";break;case "SUBTRACT":type="VECT_MATH_SUBTRACT";break;case "AVERAGE":type="VECT_MATH_AVERAGE";break;case "DOT_PRODUCT":type="VECT_MATH_DOT_PRODUCT";break;case "CROSS_PRODUCT":type="VECT_MATH_CROSS_PRODUCT";break;case "NORMALIZE":type="VECT_MATH_NORMALIZE";break;default:m_print.error("Unsupported VECT_MATH operation: "+bpy_node["operation"]);return null}inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);
break;default:inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);break}var attr={name:name,type:type,vparams:vparams,inputs:inputs,outputs:outputs,params:params,data:data,dirs:dirs};var new_node_id=m_graph.gen_node_id(graph);m_graph.append_node(graph,m_graph.gen_node_id(graph),attr);if((bpy_node["type"]=="GEOMETRY"||bpy_node["type"]=="TEX_COORD")&&node_output_check_next(bpy_node,output_num))if(append_nmat_node(graph,bpy_node,++output_num,anim_data,mat_name,shader_type)==
null)return null;return new_node_id}function validate_custom_node_group(bpy_node,inputs_map,outputs_map){var bpy_inputs=bpy_node["inputs"];var bpy_outputs=bpy_node["outputs"];var node_name=bpy_node["node_tree_name"];for(var i=0;i<inputs_map.length;i++){var input=bpy_inputs[i];var need_vec_in=inputs_map[i];if(!input||input["default_value"]instanceof Array!=need_vec_in){m_print.warn('Wrong inputs for custom node group "'+bpy_node["name"]+'" of type: "',node_name,'".'+"Processing as general node group.");
return false}}for(var i=0;i<outputs_map.length;i++){var output=bpy_outputs[i];var need_vec_out=outputs_map[i];if(!output||output["default_value"]instanceof Array!=need_vec_out){m_print.warn('Wrong outputs for custom node group "'+bpy_node["name"]+'" of type: "',node_name,'".'+"Processing as general node group.");return false}}return true}function process_node_group(bpy_node,mat_name,shader_type){var node_tree=clone_node_tree(bpy_node["node_group"]["node_tree"]);var node_name=bpy_node["node_tree_name"];
if(node_name=="B4W_REPLACE"||node_name=="B4W_LEVELS_OF_QUALITY"){var gi=init_bpy_node("Group input","GROUP_INPUT",[],bpy_node["inputs"]);var go=init_bpy_node("Group output","GROUP_OUTPUT",bpy_node["outputs"],[]);var link=null;if(node_name=="B4W_REPLACE"||node_name=="B4W_LEVELS_OF_QUALITY"&&(cfg_def.quality==m_cfg.P_LOW||cfg_def.force_low_quality_nodes))link=init_bpy_link(gi,gi["outputs"][1],go,go["inputs"][0]);else link=init_bpy_link(gi,gi["outputs"][0],go,go["inputs"][0]);node_tree["nodes"]=[gi,
go];node_tree["links"]=[link]}rename_node_group_nodes(bpy_node["name"],node_tree);var node_group_graph=compose_nmat_graph(node_tree,bpy_node["node_group"]["uuid"],true,mat_name,shader_type);var data={node_group_graph:node_group_graph,node_group_links:node_tree["links"]};return data}function reset_shader_ident_counters(){_shader_ident_counters={}}function copy_obj(obj){var type=typeof obj;if(type=="string"||type=="number"||type=="boolean"||!obj)return obj;return m_util.clone_object_nr(obj)}function clone_node_tree(tree){var new_tree=
{};for(var i in tree)if(i=="links"||i=="nodes"){new_tree[i]=[];for(var j=0;j<tree[i].length;j++){new_tree[i][j]={};for(var k in tree[i][j])if(i=="links"){new_tree[i][j][k]={};for(var l in tree[i][j][k])new_tree[i][j][k][l]=copy_obj(tree[i][j][k][l])}else new_tree[i][j][k]=copy_obj(tree[i][j][k])}}else new_tree[i]=copy_obj(tree[i]);return new_tree}function shader_ident(name_base){if(!_shader_ident_counters[name_base])_shader_ident_counters[name_base]=0;var name=name_base+_shader_ident_counters[name_base];
name=name.replace(/ /g,"_").replace(/\//g,"_");_shader_ident_counters[name_base]++;return name}function check_input_node_outputs(bpy_node){var outputs=bpy_node["outputs"];for(var i=0;i<outputs.length;i++){var output=outputs[i];if(output["is_linked"])return true}return false}function geometry_node_type(bpy_node,output_num){var outputs=bpy_node["outputs"];var out_counter=0;for(var i=0;i<outputs.length;i++){var output=outputs[i];if(!output["is_linked"])continue;if(out_counter++<output_num)continue;switch(output["identifier"]){case "UV":return"GEOMETRY_UV";
case "Vertex Color":return"GEOMETRY_VC";case "Normal":return"GEOMETRY_NO";case "Front/Back":return"GEOMETRY_FB";case "View":return"GEOMETRY_VW";case "Global":return"GEOMETRY_GL";case "Local":return"GEOMETRY_LO";case "Orco":return"GEOMETRY_OR";default:return null}}}function tex_coord_node_type(bpy_node,output_num){var outputs=bpy_node["outputs"];var out_counter=0;for(var i=0;i<outputs.length;i++){var output=outputs[i];if(!output["is_linked"])continue;if(out_counter++<output_num)continue;switch(output["identifier"]){case "Camera":return"TEX_COORD_CA";
case "Generated":return"TEX_COORD_GE";case "Normal":return"TEX_COORD_NO";case "Object":return"TEX_COORD_OB";case "Reflection":return"TEX_COORD_RE";case "UV":return"TEX_COORD_UV";case "Window":return"TEX_COORD_WI";default:return null}}}function node_output_check_next(bpy_node,output_num){var outputs=bpy_node["outputs"];var out_counter=0;for(var i=0;i<outputs.length;i++){var output=outputs[i];if(!output["is_linked"])continue;if(out_counter++>output_num)return true}return false}function texture_node_type(bpy_node){if(!bpy_node["texture"])return"TEXTURE_EMPTY";
var outputs=bpy_node["outputs"];var node_color=false;var node_normal=false;var node_value=false;for(var i=0;i<outputs.length;i++){var output=outputs[i];if(!output["is_linked"])continue;var ident=output["identifier"];switch(ident){case "Color":node_color=true;break;case "Normal":node_normal=true;break;case "Value":node_value=true;break;default:throw"Unknown texture output";}}if(node_color){if(node_normal)m_print.warn('Node "'+bpy_node["name"]+'" has both Color '+"and Normal outputs. Normal will be omitted");
if(bpy_node["texture"]["type"]=="ENVIRONMENT_MAP")return"TEXTURE_ENVIRONMENT";else return"TEXTURE_COLOR"}else if(node_normal)return"TEXTURE_NORMAL";else if(node_value)if(bpy_node["texture"]["type"]=="ENVIRONMENT_MAP")return"TEXTURE_ENVIRONMENT";else return"TEXTURE_COLOR"}function node_input_by_ident(bpy_node,ident){var inputs=bpy_node["inputs"];for(var i=0;i<inputs.length;i++){var input=inputs[i];if(input["identifier"]==ident)return node_inout_bpy_to_b4w(input)}return null}function node_output_by_ident(bpy_node,
ident){var outputs=bpy_node["outputs"];for(var i=0;i<outputs.length;i++){var output=outputs[i];if(output["identifier"]==ident)return node_inout_bpy_to_b4w(output)}return null}function node_inout_bpy_to_b4w(bpy_node_inout){return{name:bpy_node_inout["name"],identifier:bpy_node_inout["identifier"],is_linked:bpy_node_inout["is_linked"],default_value:bpy_to_b4w_value(bpy_node_inout["default_value"])}}function default_node_inout(name,identifier,default_value,is_linked){return{name:name,identifier:identifier,
is_linked:is_linked||false,default_value:default_value}}function bpy_to_b4w_value(value){if(m_util.is_vector(value))return value.slice(0);return value}function node_inputs_bpy_to_b4w(bpy_node){var inputs=[];for(var i=0;i<bpy_node["inputs"].length;i++){var input=node_inout_bpy_to_b4w(bpy_node["inputs"][i]);if(input.default_value.length)input.default_value.splice(3);inputs.push(input)}return inputs}function node_outputs_bpy_to_b4w(bpy_node){var outputs=[];for(var i=0;i<bpy_node["outputs"].length;i++){var output=
node_inout_bpy_to_b4w(bpy_node["outputs"][i]);outputs.push(output)}return outputs}function node_param(name,value,dim){if(value===null||value===undefined)var pval=null;else var pval=m_shaders.glsl_value(value,dim);var param={name:name,value:pval};return param}function replace_zero_unity_vals(str_val){str_val=str_val.replace(/(,)/g,"$1 ");str_val=str_val.replace(/(^|[^0-9]|\s)(0\.0)($|[^0-9]|\s)/g,"$1ZERO_VALUE_NODES$3");str_val=str_val.replace(/(^|[^0-9]|\s)(1\.0)($|[^0-9]|\s)/g,"$1UNITY_VALUE_NODES$3");
str_val=str_val.replace(/\s+/g,"");return str_val}function append_nmat_edge(graph,id1,id2,attr1,attr2,bpy_link){var attr=[];var ident1=bpy_link["from_socket"]["identifier"];var ident2=bpy_link["to_socket"]["identifier"];var outputs1=attr1.outputs;for(var i=0;i<outputs1.length;i++){var out1=outputs1[i];if(out1.identifier==ident1){attr.push(i);break}}var inputs2=attr2.inputs;for(var i=0;i<inputs2.length;i++){var in2=inputs2[i];if(in2.identifier==ident2){attr.push(i);break}}if(attr.length==2)m_graph.append_edge(graph,
id1,id2,attr);return true}exports.compose_node_elements=function(graph){var node_elements=[];var node_elem_map={};reset_shader_ident_counters();var sgraph=m_graph.topsort(graph);m_graph.traverse(sgraph,function(id,attr){var elem=init_node_elem(attr);node_elements.push(elem);node_elem_map[id]=elem});m_graph.traverse_edges(sgraph,function(id1,id2,attr){var node1=m_graph.get_node_attr(sgraph,id1);var node2=m_graph.get_node_attr(sgraph,id2);var out1=node1.outputs[attr[0]];var in2=node2.inputs[attr[1]];
var elem1_outputs=node_elem_map[id1].outputs;var elem2_inputs=node_elem_map[id2].inputs;var name=elem1_outputs[attr[0]]||shader_ident("out_"+node1.type+"_"+out1.identifier);elem1_outputs[attr[0]]=name;elem2_inputs[attr[1]]=name});return node_elements};function init_node_elem(mat_node){var finputs=[];var finput_values=[];var foutputs=[];var fparams=[];var fparam_values=[];var vparams=[];for(var i=0;i<mat_node.inputs.length;i++){var input=mat_node.inputs[i];if(input.is_linked){finputs.push(null);finput_values.push(null)}else{finputs.push(shader_ident("in_"+
mat_node.type+"_"+input.identifier));var input_val=m_shaders.glsl_value(input.default_value,0);if(cfg_def.shader_constants_hack)if(mat_node.type.indexOf("MIX_RGB_")>=0&&(input.identifier=="Color1"||input.identifier=="Color2"||input.identifier=="Fac")||mat_node.type.indexOf("MATH_")>=0&&(input.identifier=="Value"||input.identifier=="Value_001")||mat_node.type.indexOf("VECT_MATH_")>=0&&input.identifier=="Vector_001")input_val=replace_zero_unity_vals(input_val);finput_values.push(input_val)}}for(var i=
0;i<mat_node.outputs.length;i++){var output=mat_node.outputs[i];if(output.is_linked)foutputs.push(null);else foutputs.push(shader_ident("out_"+mat_node.type+"_"+output.identifier))}for(var i=0;i<mat_node.params.length;i++){var param=mat_node.params[i];fparams.push(param.name);fparam_values.push(param.value)}for(var i=0;i<mat_node.vparams.length;i++){var vparam=mat_node.vparams[i];vparams.push(vparam.name)}var elem={id:mat_node.type,inputs:finputs,input_values:finput_values,outputs:foutputs,params:fparams,
param_values:fparam_values,vparams:vparams,dirs:JSON.parse(JSON.stringify(mat_node.dirs))};return elem}function create_new_name(type,group_name,name){if(type=="GROUP_INPUT")return group_name+"*GI*"+name;else if(type=="GROUP_OUTPUT")return group_name+"*GO*"+name;return group_name+"%join%"+name}function rename_node_group_nodes(node_group_name,node_tree){var nodes=node_tree["nodes"];var links=node_tree["links"];for(var i=0;i<nodes.length;i++)nodes[i]["name"]=create_new_name(nodes[i].type,node_group_name,
nodes[i].name);for(var i=0;i<links.length;i++){links[i]["from_node"]["name"]=create_new_name(links[i]["from_node"]["type"],node_group_name,links[i]["from_node"]["name"]);links[i]["to_node"]["name"]=create_new_name(links[i]["to_node"]["type"],node_group_name,links[i]["to_node"]["name"])}}function trace_group_nodes(graph){var node_groups=[];m_graph.traverse(graph,function(id,node){if(node["type"]=="GROUP")node_groups.push(node)});return node_groups}function append_node_groups_graphs(graph,links,node_groups){for(var i=
0;i<node_groups.length;i++){var node_group_graph=node_groups[i].data.node_group_graph;var node_group_links=node_groups[i].data.node_group_links;if(!node_group_graph)return false;m_graph.traverse(node_group_graph,function(id,node){m_graph.append_node(graph,m_graph.gen_node_id(graph),node)});for(var j=0;j<node_group_links.length;j++)links.push(node_group_links[j]);change_node_groups_links(node_groups[i],links,graph)}return true}function distribute_link(property,group_name,link,node_group_links,node_group_input_links,
node_group_output_links){switch(property.type){case "GROUP":if(property["name"]==group_name)node_group_links.push(link);break;case "GROUP_INPUT":if(!property["name"].indexOf(group_name+"*GI*"))node_group_input_links.push(link);break;case "GROUP_OUTPUT":if(!property["name"].indexOf(group_name+"*GO*"))node_group_output_links.push(link);break}}function relink(links,input_links,output_links){var unused_links=[];for(var i=0;i<output_links.length;i++){var output=output_links[i];var input=null;for(var j=
0;j<input_links.length;j++)if(output["from_socket"]["identifier"]==input_links[j]["to_socket"]["identifier"]){input=input_links[j];break}if(input){output["from_node"]=input["from_node"];output["from_socket"]=input["from_socket"]}else unused_links.push(output)}for(var i=0;i<input_links.length;i++)links.splice(links.indexOf(input_links[i]),1);return unused_links}function add_unused_input_links(links,unused_links){if(!unused_links.length)return;var gi_name=unused_links[0]["from_node"]["name"];for(var i=
0;i<links.length;i++)if(links[i]["from_node"]["name"]==gi_name)unused_links.push(links[i])}function set_input_default_value(link,graph,value){var node_ids=nmat_node_ids(link["to_node"],graph);for(var i=0;i<node_ids.length;i++){var node_attr=m_graph.get_node_attr(graph,node_ids[i]);for(var j=0;j<node_attr.inputs.length;j++)if(node_attr.inputs[j].identifier==link["to_socket"]["identifier"]){node_attr.inputs[j].default_value=value;break}}}function change_default_values(links,graph,node,unused_links){for(var i=
0;i<unused_links.length;i++){var link=unused_links[i];var value;for(var j=0;j<node.inputs.length;j++)if(link["from_socket"]["identifier"]==node.inputs[j].identifier){value=node.inputs[j].default_value;break}set_input_default_value(link,graph,value);var index=links.indexOf(link);if(index!=-1)links.splice(index,1)}}function change_node_groups_links(node,links,graph){var group_name=node.name;var node_group_links_from=[];var node_group_links_to=[];var node_group_input_links=[];var node_group_output_links=
[];for(var i=0;i<links.length;i++){var link=links[i];distribute_link(link["from_node"],group_name,link,node_group_links_from,node_group_input_links,node_group_output_links);distribute_link(link["to_node"],group_name,link,node_group_links_to,node_group_input_links,node_group_output_links)}var unused_input_links=relink(links,node_group_links_to,node_group_input_links);var unused_output_links=relink(links,node_group_output_links,node_group_links_from);add_unused_input_links(links,unused_input_links);
change_default_values(links,graph,node,unused_input_links);if(unused_output_links.length){var output_node;m_graph.traverse(graph,function(id,node){if(node.type=="GROUP_OUTPUT"&&!node.name.indexOf(group_name+"*GO*"))output_node=node});change_default_values(links,graph,output_node,unused_output_links)}}exports.check_material_glow_output=function(mat){if(mat["node_tree"])for(var i=0;i<mat["node_tree"]["nodes"].length;i++){var node=mat["node_tree"]["nodes"][i];if(node.type=="GROUP"&&node["node_tree_name"]==
"B4W_GLOW_OUTPUT")return true}return false};exports.cleanup=cleanup;function cleanup(){for(var graph_id in _composed_node_graphs)delete _composed_node_graphs[graph_id];for(var key in _lamp_indexes)delete _lamp_indexes[key];_lamp_index=0;_material_index=0}};b4w.module["__animation"]=function(exports,require){var m_cfg=require("__config");var m_obj_util=require("__obj_util");var m_particles=require("__particles");var m_phy=require("__physics");var m_print=require("__print");var m_quat=require("__quat");var m_reformer=require("__reformer");var m_sfx=require("__sfx");var m_time=require("__time");var m_trans=require("__transform");var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("__vec3");var m_armat=require("__armature");var cfg_ani=
m_cfg.animation;var cfg_def=m_cfg.defaults;var LAST_FRAME_EPSILON=1E-6;exports.LAST_FRAME_EPSILON=LAST_FRAME_EPSILON;var OBJ_ANIM_TYPE_NONE=0;var OBJ_ANIM_TYPE_ARMATURE=10;var OBJ_ANIM_TYPE_OBJECT=20;var OBJ_ANIM_TYPE_VERTEX=30;var OBJ_ANIM_TYPE_SOUND=40;var OBJ_ANIM_TYPE_PARTICLES=50;var OBJ_ANIM_TYPE_MATERIAL=60;exports.OBJ_ANIM_TYPE_NONE=OBJ_ANIM_TYPE_NONE;exports.OBJ_ANIM_TYPE_ARMATURE=OBJ_ANIM_TYPE_ARMATURE;exports.OBJ_ANIM_TYPE_OBJECT=OBJ_ANIM_TYPE_OBJECT;exports.OBJ_ANIM_TYPE_VERTEX=OBJ_ANIM_TYPE_VERTEX;
exports.OBJ_ANIM_TYPE_SOUND=OBJ_ANIM_TYPE_SOUND;exports.OBJ_ANIM_TYPE_PARTICLES=OBJ_ANIM_TYPE_PARTICLES;exports.OBJ_ANIM_TYPE_MATERIAL=OBJ_ANIM_TYPE_MATERIAL;var SLOT_0=0;var SLOT_1=1;var SLOT_2=2;var SLOT_3=3;var SLOT_4=4;var SLOT_5=5;var SLOT_6=6;var SLOT_7=7;var SLOT_ALL=-1;exports.SLOT_0=SLOT_0;exports.SLOT_1=SLOT_1;exports.SLOT_2=SLOT_2;exports.SLOT_3=SLOT_3;exports.SLOT_4=SLOT_4;exports.SLOT_5=SLOT_5;exports.SLOT_6=SLOT_6;exports.SLOT_7=SLOT_7;exports.SLOT_ALL=SLOT_ALL;var KF_INTERP_BEZIER=
0;var KF_INTERP_LINEAR=1;var KF_INTERP_CONSTANT=2;var AB_CYCLIC=10;var AB_FINISH_RESET=20;var AB_FINISH_STOP=30;var VECTORS_RESERVED=50;exports.AB_CYCLIC=AB_CYCLIC;exports.AB_FINISH_RESET=AB_FINISH_RESET;exports.AB_FINISH_STOP=AB_FINISH_STOP;var AT_NONE=exports.AT_NONE=0;var AT_ARMATURE=exports.AT_ARMATURE=1;var AT_SPEAKER=exports.AT_SPEAKER=2;var AT_OBJECT=exports.AT_OBJECT=3;var AT_MATERIAL=exports.AT_MATERIAL=4;var _frame_info_tmp=new Array(3);var _vec3_tmp=new Float32Array(3);var _vec3_tmp2=new Float32Array(3);
var _quat4_tmp=new Float32Array(4);var _quat4_tmp2=new Float32Array(4);var _quat4_tmp3=new Float32Array(4);var _tsr8_tmp=new Float32Array(8);var _mat4_tmp=new Float32Array(16);var _anim_objs_cache=[];var _actions=[];exports.get_max_bones=function(){return m_util.trunc((cfg_def.max_vertex_uniform_vectors-VECTORS_RESERVED)/4)};exports.frame_to_sec=function(frame){return frame/m_time.get_framerate()};function create_action_render(){var render={type:AT_NONE,num_pierced:0,pierce_step:0,params:null,bones:null,
bflags:null,channels_mask:new Int8Array(3)};return render}exports.update=function(elapsed){for(var i=0;i<_anim_objs_cache.length;i++){var obj=_anim_objs_cache[i];for(var j=0;j<8;j++)animate(obj,elapsed,j);if(obj.render.anim_mixing){process_mix_factor(obj,elapsed);mix_skeletal_animation(obj,elapsed)}}for(var i=0;i<_anim_objs_cache.length;i++){var obj=_anim_objs_cache[i];for(var j=0;j<8;j++){if(!obj.anim_slots.length)break;handle_finish_callback(obj,j)}}};function handle_finish_callback(obj,slot_num){var anim_slot=
obj.anim_slots[slot_num];if(!anim_slot)return;if(anim_slot.finish_callback&&anim_slot.exec_finish_callback){anim_slot.exec_finish_callback=false;anim_slot.finish_callback(obj,slot_num)}}exports.get_all_actions=function(){return _actions};function apply_vertex_anim(obj,va,slot_num){var anim_slot=obj.anim_slots[slot_num];anim_slot.type=OBJ_ANIM_TYPE_VERTEX;var start=va.frame_start;var length=va.frame_end-start+1;anim_slot.start=start;anim_slot.length=length;anim_slot.current_frame_float=start;anim_slot.animation_name=
va.name;var va_frame_offset=0;for(var i=0;i<obj.vertex_anim.length;i++){var va_i=obj.vertex_anim[i];if(va_i==va)break;else va_frame_offset+=va_i.frame_end-va_i.frame_start+1}anim_slot.va_frame_offset=va_frame_offset}function apply_particles_anim(obj,psys_name,slot_num){var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var batches=scenes_data[i].batches;for(var j=0;j<batches.length;j++){var pdata=batches[j].particles_data;if(!pdata||pdata.name!=psys_name)continue;var anim_slot=
obj.anim_slots[slot_num];anim_slot.type=OBJ_ANIM_TYPE_PARTICLES;anim_slot.animation_name=pdata.name;anim_slot.start=pdata.frame_start;anim_slot.length=pdata.frame_end-anim_slot.start;if(!pdata.cyclic)anim_slot.length+=pdata.lifetime_frames}}}function init_anim(obj,slot_num){var anim_slot={type:null,animation_name:null,action_frame_range:null,action_step:0,action_bflags:null,channels_mask:new Int8Array(3),quats:null,trans:null,skinning_data:[],play:false,behavior:AB_FINISH_RESET,current_frame_float:0,
start:0,length:0,trans_smooth_period:0,quat_smooth_period:0,exec_finish_callback:false,va_frame_offset:null,speed:1,volume:null,pitch:null,nodemat_values:[],node_value_inds:[],nodemat_rgbs:[],node_rgb_inds:[]};if(!obj.anim_slots.length)for(var i=0;i<8;i++)obj.anim_slots.push(null);obj.anim_slots[slot_num]=anim_slot}function update_anim_cache(obj){if(_anim_objs_cache.indexOf(obj)==-1)_anim_objs_cache.push(obj)}exports.get_anim_names=function(obj){var anim_names=[];if(has_vertex_anim(obj))for(var i=
0;i<obj.vertex_anim.length;i++)anim_names.push(obj.vertex_anim[i].name);var actions=get_actions(obj);for(var i=0;i<actions.length;i++)anim_names.push(strip_baked_suffix(actions[i]["name"]));if(m_particles.obj_has_particles(obj)&&m_particles.obj_has_anim_particles(obj)){var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var batches=scenes_data[i].batches;for(var j=0;j<batches.length;j++){var pdata=batches[j].particles_data;if(pdata)anim_names.push(pdata.name)}}}return anim_names};
exports.strip_baked_suffix=strip_baked_suffix;function strip_baked_suffix(name){return name.replace(/_B4W_BAKED$/,"")}exports.get_anim_type=function(obj,slot_num){var anim_slot=obj.anim_slots[slot_num];if(anim_slot)return anim_slot.type;return OBJ_ANIM_TYPE_NONE};exports.apply_def=function(obj){var slot_num=SLOT_0;var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var batches=scenes_data[i].batches;for(var j=0;j<batches.length;j++){var pdata=batches[j].particles_data;if(pdata&&
pdata.p_type=="EMITTER"){do_before_apply(obj,slot_num);apply_particles_anim(obj,pdata.name,slot_num);do_after_apply(obj,slot_num);obj.anim_slots[slot_num].behavior=obj.anim_behavior_def;if(pdata.cyclic)obj.anim_slots[slot_num].behavior=AB_CYCLIC;slot_num++}}}var actions=get_default_actions(obj);for(var i=0;i<actions.length;i++){var action=actions[i];do_before_apply(obj,slot_num);if(apply_action(obj,action,slot_num)){do_after_apply(obj,slot_num);obj.anim_slots[slot_num].behavior=obj.anim_behavior_def;
slot_num++}else obj.anim_slots[slot_num]=null}if(has_vertex_anim(obj)){do_before_apply(obj,slot_num);apply_vertex_anim(obj,obj.vertex_anim[0],slot_num);do_after_apply(obj,slot_num);obj.anim_slots[slot_num].behavior=obj.anim_behavior_def;slot_num++}};exports.anim_behavior_bpy_b4w=function(behavior){switch(behavior){case "CYCLIC":return AB_CYCLIC;case "FINISH_RESET":return AB_FINISH_RESET;case "FINISH_STOP":return AB_FINISH_STOP;default:m_util.panic("Wrong animation behavior")}};function get_actions(obj){var act_list=
[];for(var i=0;i<_actions.length;i++){var action=_actions[i];var act_render=action._render;if(act_render.type==AT_OBJECT)act_list.push(action);else if(act_render.type==AT_ARMATURE&&obj.type=="ARMATURE")act_list.push(action);else if(act_render.type==AT_SPEAKER&&obj.type=="SPEAKER")act_list.push(action)}if(obj.type=="MESH")for(var i=0;i<obj.actions.length;i++){var action=obj.actions[i];if(action._render.type==AT_MATERIAL)act_list.push(action)}return act_list}function get_default_actions(obj){return obj.actions.slice()}
exports.get_bpy_material_actions=function(bpy_obj){var act_list=[];var materials=bpy_obj["data"]["materials"];for(var i=0;i<materials.length;i++){var mat=materials[i];var node_tree=mat["node_tree"];if(node_tree)get_node_tree_actions_r(node_tree,act_list)}return act_list};function get_node_tree_actions_r(node_tree,container){if(node_tree["animation_data"]){var anim_data=node_tree["animation_data"];var action=anim_data["action"];if(action&&action._render.type==AT_MATERIAL)container.push(action)}var nodes=
node_tree["nodes"];for(var i=0;i<nodes.length;i++){var node=nodes[i];if(node["node_group"]){var g_node_tree=node["node_group"]["node_tree"];if(g_node_tree)get_node_tree_actions_r(g_node_tree,container)}}}function has_vertex_anim(obj){if(m_obj_util.is_mesh(obj)&&obj.render.vertex_anim)return true;else return false}exports.play=function(obj,finish_callback,slot_num){function play_slot(anim_slot){anim_slot.play=true;if(finish_callback)anim_slot.finish_callback=finish_callback;else anim_slot.finish_callback=
null;anim_slot.exec_finish_callback=false}process_anim_slots(obj.anim_slots,slot_num,play_slot);if(obj.render.anim_mixing)sync_skeletal_animations(obj)};exports.stop=function(obj,slot_num){function stop_slot(anim_slot){anim_slot.play=false;anim_slot.finish_callback=null;anim_slot.exec_finish_callback=false}process_anim_slots(obj.anim_slots,slot_num,stop_slot)};exports.is_play=function(obj,slot_num){var anim_slots=obj.anim_slots;if(slot_num==SLOT_ALL)for(var i=0;i<8;i++){if(anim_slots[i])if(anim_slots[i].play)return true}else{var anim_slot=
anim_slots[slot_num];if(anim_slot)return anim_slot.play}return false};exports.set_frame=set_frame;function set_frame(obj,cff,slot_num){var anim_slots=obj.anim_slots;if(slot_num==SLOT_ALL)for(var i=0;i<8;i++){var anim_slot=anim_slots[i];if(anim_slot){anim_slot.current_frame_float=cff;update_object_animation(obj,0,i,true)}}else{var anim_slot=anim_slots[slot_num];if(anim_slot){anim_slot.current_frame_float=cff;update_object_animation(obj,0,slot_num,true)}}}exports.set_first_frame=set_first_frame;function set_first_frame(obj,
slot_num){function set_slot_first_frame(slot){set_frame(obj,slot.start,slot_num)}slot_num=slot_num||SLOT_0;process_anim_slots(obj.anim_slots,slot_num,set_slot_first_frame)}exports.get_current_frame_float=function(obj,slot_num){var anim_slot=obj.anim_slots[slot_num];if(anim_slot&&anim_slot.current_frame_float)return anim_slot.current_frame_float;else return 0};exports.is_cyclic=function(obj,slot_num){var anim_slot=obj.anim_slots[slot_num];return anim_slot&&anim_slot.behavior==AB_CYCLIC};exports.set_behavior=
function(obj,behavior,slot_num){function set_slot_behavior(anim_slot){anim_slot.behavior=behavior}process_anim_slots(obj.anim_slots,slot_num,set_slot_behavior)};exports.get_behavior=function(obj,slot_num){var anim_slot=obj.anim_slots[slot_num];return anim_slot&&anim_slot.behavior};exports.apply_smoothing=function(obj,trans_period,quat_period,slot_num){function apply_slot_smoothing(anim_slot){anim_slot.trans_smooth_period=trans_period||0;anim_slot.quat_smooth_period=quat_period||0}process_anim_slots(obj.anim_slots,
slot_num,apply_slot_smoothing)};exports.remove_slot_animation=function(obj,slot_num){if(slot_num==SLOT_ALL)for(var i=0;i<8;i++)obj.anim_slots[i]=null;else obj.anim_slots[slot_num]=null;if(obj.render.anim_mixing)recalculate_armature_anim_slots(obj,slot_num)};function process_anim_slots(anim_slots,slot_num,procedure){if(slot_num==SLOT_ALL)for(var i=0;i<8;i++){var anim_slot=anim_slots[i];if(anim_slot)procedure(anim_slot)}else{var anim_slot=anim_slots[slot_num];if(anim_slot)procedure(anim_slot)}}exports.update_object_animation=
update_object_animation;function update_object_animation(obj,elapsed,slot_num,force_update){animate(obj,elapsed,slot_num,force_update);handle_finish_callback(obj,slot_num);if(obj.render.anim_mixing){process_mix_factor(obj,elapsed);mix_skeletal_animation(obj,elapsed)}}exports.obj_is_animatable=function(obj){if(obj.type=="ARMATURE")return true;if(obj.armobj)return true;for(var i=0;i<obj.actions.length;i++){var act_type=obj.actions[i]._render.type;if(act_type==AT_OBJECT||act_type==AT_ARMATURE||act_type==
AT_SPEAKER&&obj.type=="SPEAKER"||act_type==AT_MATERIAL&&obj.type=="MESH")return true}if(m_particles.obj_has_particles(obj)&&m_particles.obj_has_anim_particles(obj))return true;if(obj.type=="MESH"&&obj.vertex_anim.length)return true;return false};exports.bpy_obj_is_animatable=function(bpy_obj,obj){if(obj.type=="ARMATURE")return true;var armobj=get_bpy_armobj(bpy_obj);if(armobj)return true;for(var i=0;i<obj.actions.length;i++){var act_type=obj.actions[i]._render.type;if(act_type==AT_OBJECT||act_type==
AT_ARMATURE||act_type==AT_SPEAKER&&obj.type=="SPEAKER"||act_type==AT_MATERIAL&&obj.type=="MESH")return true}if(m_particles.bpy_obj_has_particles(bpy_obj)&&m_particles.bpy_obj_has_anim_particles(bpy_obj))return true;if(obj.type=="MESH"&&bpy_obj["data"]["b4w_vertex_anim"].length)return true;return false};exports.is_animated=is_animated;function is_animated(obj){return Boolean(obj.anim_slots.length)}function apply_action(obj,action,slot_num){var frame_range=action["frame_range"];if(frame_range[0]>frame_range[1]){m_print.warn('Incompatible action "'+
action["name"]+'" has been applied to object "'+obj.name+'"');return false}var act_render=action._render;var anim_slot=obj.anim_slots[slot_num];anim_slot.animation_name=action["name"];anim_slot.action_frame_range=frame_range;anim_slot.action_step=act_render.pierce_step;anim_slot.action_bflags=act_render.bflags;anim_slot.channels_mask.set(act_render.channels_mask);anim_slot.start=frame_range[0];anim_slot.length=frame_range[1]-frame_range[0];anim_slot.current_frame_float=frame_range[0];var bones=act_render.bones;
switch(act_render.type){case AT_ARMATURE:if(m_obj_util.is_armature(obj)){anim_slot.type=OBJ_ANIM_TYPE_ARMATURE;var pose_data_frames=get_cached_anim_data(obj,action);if(!pose_data_frames){var pose_data_frames=calc_pose_data_frames(action,obj.render.bone_pointers);cache_anim_data(obj,action,pose_data_frames)}anim_slot.trans=pose_data_frames.trans;anim_slot.quats=pose_data_frames.quats;init_skinned_objs_data(obj,slot_num,action,pose_data_frames)}break;case AT_SPEAKER:if(m_obj_util.is_speaker(obj)){anim_slot.volume=
act_render.params["volume"]||null;anim_slot.pitch=act_render.params["pitch"]||null;anim_slot.type=OBJ_ANIM_TYPE_SOUND}break;case AT_MATERIAL:if(obj.type=="MESH"){anim_slot.type=OBJ_ANIM_TYPE_MATERIAL;var nodemat_anim_data=get_cached_anim_data(obj,action);if(!nodemat_anim_data){nodemat_anim_data=calc_nodemat_anim_data(obj,action);cache_anim_data(obj,action,nodemat_anim_data)}anim_slot.node_value_inds=nodemat_anim_data.val_inds;anim_slot.nodemat_values=nodemat_anim_data.values;anim_slot.node_rgb_inds=
nodemat_anim_data.rgb_inds;anim_slot.nodemat_rgbs=nodemat_anim_data.rgbs}break;case AT_OBJECT:var tsr=act_render.params["tsr"];if(tsr){anim_slot.type=OBJ_ANIM_TYPE_OBJECT;var obj_anim_data=get_cached_anim_data(obj,action);if(!obj_anim_data){obj_anim_data=calc_obj_anim_data(obj,action,tsr);cache_anim_data(obj,action,obj_anim_data)}anim_slot.trans=obj_anim_data.trans;anim_slot.quats=obj_anim_data.quats;if(m_particles.obj_has_particles(obj)){var trans=anim_slot.trans[0];var quats=anim_slot.quats[0];
m_particles.update_start_pos(obj,trans,quats)}}else{m_print.warn('Incompatible action "'+action["name"]+'" has been applied to object "'+obj.name+'"');return false}break}if(m_obj_util.is_armature(obj)&&act_render.type!=AT_ARMATURE)recalculate_armature_anim_slots(obj,slot_num);return true}function get_cached_anim_data(obj,action){var cache=obj.action_anim_cache;for(var i=0;i<cache.length;i+=2)if(action==cache[i])return cache[i+1];return null}function cache_anim_data(obj,action,data){var cache=obj.action_anim_cache;
cache.push(action,data)}function init_skinned_objs_data(armobj,slot_num,action,armobj_pose_data_frames){var render=armobj.render;var skinned_renders=render.skinned_renders;var anim_slot=armobj.anim_slots[slot_num];var skinning_data=anim_slot.skinning_data;var skinning_data_cache=get_cached_skinning_data(render,action);if(!skinning_data_cache){for(var i=0;i<skinned_renders.length;i++){var sk_rend=skinned_renders[i];var pose_data_frames=calc_skinned_pose_data_frames(armobj_pose_data_frames,sk_rend.bone_skinning_info);
skinning_data.push(pose_data_frames)}cache_skinning_data(render,action,skinning_data)}else anim_slot.skinning_data=skinning_data_cache;if(render.anim_mixing){var skeletal_slots=render.two_last_skeletal_slots;if(slot_num>skeletal_slots[1]){var tmp=skeletal_slots[1];skeletal_slots[1]=slot_num;skeletal_slots[0]=tmp}else if(slot_num>skeletal_slots[0]&&slot_num<skeletal_slots[1])skeletal_slots[0]=slot_num;sync_skeletal_animations(armobj)}}function get_cached_skinning_data(render,action){var cache=render.skinning_data_cache;
for(var i=0;i<cache.length;i+=2)if(action==cache[i])return cache[i+1];return null}function cache_skinning_data(render,action,skinning_data){var cache=render.skinning_data_cache;cache.push(action,skinning_data)}function sync_skeletal_animations(armobj){var skeletal_slots=armobj.render.two_last_skeletal_slots;if(skeletal_slots[0]==-1||skeletal_slots[1]==-1)return;var last_skel_slot=skeletal_slots[1];var anim_slots=armobj.anim_slots;var last_skel_anim=anim_slots[last_skel_slot];var cff=last_skel_anim.current_frame_float;
var cff_int=Math.floor(cff);var frame_factor=cff-cff_int;var prev_skel_slot=skeletal_slots[0];var prev_skel_anim=anim_slots[prev_skel_slot];var cff=prev_skel_anim.current_frame_float;var cff_int=Math.floor(cff);prev_skel_anim.current_frame_float=cff_int+frame_factor}function recalculate_armature_anim_slots(obj,overriden_slot){var skeletal_slots=obj.render.two_last_skeletal_slots;var last_skel_slot=skeletal_slots[1];skeletal_slots[0]=-1;skeletal_slots[1]=-1;if(overriden_slot==SLOT_ALL)return;var anim_slots=
obj.anim_slots;for(var i=last_skel_slot;i>=SLOT_0;i--){var anim_slot=anim_slots[i];if(anim_slot&&anim_slot.type==OBJ_ANIM_TYPE_ARMATURE){if(i>skeletal_slots[1]){skeletal_slots[1]=i;continue}else if(i>skeletal_slots[0])skeletal_slots[1]=i;break}}}function find_armature_constraint(constraints,type){for(var i=0;i<constraints.length;i++){var cons=constraints[i];if(cons["type"]==type){var target=cons["target"];if(target&&target["type"]=="ARMATURE")return cons}}return false}function calc_nodemat_anim_data(obj,
action){var val_inds=[];var values=[];var rgb_inds=[];var rgbs=[];var act_render=action._render;var val_ind_pairs=obj.render.mats_anim_inds;var rgb_ind_pairs=obj.render.mats_rgb_anim_inds;for(var node_name in act_render.params){var act_node_name=action["name"]+"%join%"+node_name;calc_node_act(node_name,act_node_name,act_render,values,val_inds,val_ind_pairs);calc_node_act(node_name,act_node_name,act_render,rgbs,rgb_inds,rgb_ind_pairs)}return{val_inds:val_inds,values:values,rgb_inds:rgb_inds,rgbs:rgbs}}
function calc_node_act(node_name,act_node_name,act_render,values,inds,val_ind_pairs){for(var i=0;i<val_ind_pairs.length;i+=2){var name=val_ind_pairs[i];if(act_node_name==name){var ind=val_ind_pairs[i+1];inds.push(ind);values.push(new Float32Array(act_render.params[node_name]))}}}function calc_obj_anim_data(obj,action,tsr){var act_render=action._render;var num_pierced=act_render.num_pierced;var anim_trans=[];var anim_quats=[];for(var i=0;i<num_pierced;i++){anim_trans.push(tsr.subarray(i*8,i*8+4));
anim_quats.push(tsr.subarray(i*8+4,i*8+8))}return{trans:anim_trans,quats:anim_quats}}function is_material_action(action){var act_render=action._render;for(var param in act_render.params)if(param.indexOf("nodes")!=-1)return true;return false}function animate(obj,elapsed,slot_num,force_update){var anim_slot=obj.anim_slots[slot_num];if(!anim_slot||anim_slot.type==null)return;if(!anim_slot.play&&!force_update)return;var render=obj.render;var cff=anim_slot.current_frame_float;var start=anim_slot.start;
var length=anim_slot.length;cff+=anim_slot.speed*elapsed*m_time.get_framerate();var anim_type=anim_slot.type;var speed=anim_slot.speed;if(speed>=0&&cff>=start+length||speed<0&&cff<start){if(!force_update)anim_slot.exec_finish_callback=true;switch(anim_slot.behavior){case AB_CYCLIC:if(speed>=0)cff=(cff-start)%length+start;else cff=start+length-LAST_FRAME_EPSILON;break;case AB_FINISH_RESET:if(speed>=0)cff=start;else cff=start+length-LAST_FRAME_EPSILON;anim_slot.play=false;break;case AB_FINISH_STOP:if(speed>=
0)cff=start+length-LAST_FRAME_EPSILON;else cff=start;anim_slot.play=false;break}}anim_slot.current_frame_float=cff;switch(anim_type){case OBJ_ANIM_TYPE_ARMATURE:if(!render.anim_mixing){var finfo=action_anim_finfo(anim_slot,cff,_frame_info_tmp);var frame=finfo[0];var frame_next=finfo[1];var frame_factor=finfo[2];render.quats_before=anim_slot.quats[frame];render.quats_after=anim_slot.quats[frame_next];render.trans_before=anim_slot.trans[frame];render.trans_after=anim_slot.trans[frame_next];render.frame_factor=
frame_factor;animate_skinned_objs(render,anim_slot,frame,frame_next);m_trans.update_transform(obj)}break;case OBJ_ANIM_TYPE_OBJECT:var finfo=action_anim_finfo(anim_slot,cff,_frame_info_tmp);var trans=get_anim_translation(anim_slot,0,finfo,_vec3_tmp);var quat=get_anim_rotation(anim_slot,0,finfo,_quat4_tmp);var scale=get_anim_scale(anim_slot,0,finfo);if(anim_slot.trans_smooth_period){var trans_old=_vec3_tmp2;m_trans.get_translation(obj,trans_old);m_util.smooth_v(trans,trans_old,elapsed,anim_slot.trans_smooth_period,
trans)}if(anim_slot.quat_smooth_period){var quat_old=_quat4_tmp2;m_trans.get_rotation(obj,quat_old);m_util.smooth_q(quat,quat_old,elapsed,anim_slot.quat_smooth_period,quat)}var mask=anim_slot.channels_mask;if(mask[0])m_trans.set_translation_rel(obj,trans);if(mask[1])m_trans.set_rotation_rel(obj,quat);if(mask[2])m_trans.set_scale_rel(obj,scale);m_trans.update_transform(obj);m_phy.sync_transform(obj);break;case OBJ_ANIM_TYPE_VERTEX:vertex_anim_finfo(anim_slot,cff,_frame_info_tmp);var finfo=_frame_info_tmp;
render.va_frame=finfo[0];render.va_frame_factor=finfo[2];break;case OBJ_ANIM_TYPE_SOUND:var finfo=action_anim_finfo(anim_slot,cff,_frame_info_tmp);var fc=finfo[0];var fn=finfo[1];var ff=finfo[2];if(anim_slot.volume){var volume=(1-ff)*anim_slot.volume[fc]+ff*anim_slot.volume[fn];m_sfx.set_volume(obj,volume)}if(anim_slot.pitch){var pitch=(1-ff)*anim_slot.pitch[fc]+ff*anim_slot.pitch[fn];m_sfx.playrate(obj,pitch)}break;case OBJ_ANIM_TYPE_PARTICLES:var time=cff/m_time.get_framerate();m_particles.set_time(obj,
anim_slot.animation_name,time);break;case OBJ_ANIM_TYPE_MATERIAL:var finfo=action_anim_finfo(anim_slot,cff,_frame_info_tmp);var fc=finfo[0];var fn=finfo[1];var ff=finfo[2];var values=anim_slot.nodemat_values;var val_indices=anim_slot.node_value_inds;var rgbs=anim_slot.nodemat_rgbs;var rgb_indices=anim_slot.node_rgb_inds;for(var i=0;i<val_indices.length;i++){var vals=values[i];var ind=val_indices[i];var nodemat_value=(1-ff)*vals[fc]+ff*vals[fn];obj.render.mats_values[ind]=nodemat_value}for(var i=0;i<
rgb_indices.length;i++){var rgb=rgbs[i];var ind=rgb_indices[i];var prev=rgb.subarray(fc*3,fc*3+3);var next=rgb.subarray(fn*3,fn*3+3);var curr=m_vec3.lerp(prev,next,ff,_vec3_tmp);obj.render.mats_rgbs[ind]=curr[0];obj.render.mats_rgbs[ind+1]=curr[1];obj.render.mats_rgbs[ind+2]=curr[2]}break;default:m_util.panic("Unknown animation type:"+anim_type);break}}function action_anim_finfo(anim_slot,cff,dest){if(!dest)var dest=new Array(3);var action_start=anim_slot.action_frame_range[0];var action_end=anim_slot.action_frame_range[1];
var range=action_end-action_start;var index_float=cff-action_start;if(index_float<0)index_float=0;if(index_float>=range)index_float=range;var step=anim_slot.action_step;index_float/=step;var frame=Math.floor(index_float);if(anim_slot.action_bflags[frame])var frame_factor=index_float-frame;else var frame_factor=0;var frame_next=Math.ceil(frame+frame_factor);dest[0]=frame;dest[1]=frame_next;dest[2]=frame_factor;return dest}function vertex_anim_finfo(anim_slot,cff,dest){if(!dest)var dest=new Array(3);
var index_float=cff-anim_slot.start;if(index_float<0)index_float=0;if(index_float>=anim_slot.length)index_float=anim_slot.length;var frame=Math.floor(index_float);var frame_next=frame+1;var frame_factor=index_float-frame;if(anim_slot.behavior!=AB_CYCLIC&&frame_next==anim_slot.length){frame=frame-1;frame_next=frame;frame_factor=1}var va_frame_offset=anim_slot.va_frame_offset;dest[0]=frame+va_frame_offset;dest[1]=frame_next+va_frame_offset;dest[2]=frame_factor;return dest}function animate_skinned_objs(render,
anim_slot,frame,frame_next){var skinned_renders=render.skinned_renders;var skinning_data=anim_slot.skinning_data;for(var i=0;i<skinned_renders.length;i++){var skinned_render=skinned_renders[i];var sk_data=skinning_data[i];skinned_render.quats_before=sk_data.quats[frame];skinned_render.quats_after=sk_data.quats[frame_next];skinned_render.trans_before=sk_data.trans[frame];skinned_render.trans_after=sk_data.trans[frame_next];skinned_render.frame_factor=render.frame_factor}}function mix_skeletal_animation(obj,
elapsed){var render=obj.render;var mix_factor=render.anim_mix_factor;var skeletal_slots=render.two_last_skeletal_slots;var ind_0=skeletal_slots[0];var ind_1=skeletal_slots[1];if(ind_1==-1)return;if(ind_0!=-1){var skeletal_slot_0=obj.anim_slots[ind_0];if(skeletal_slot_0.play||elapsed==0){var cff_0=skeletal_slot_0.current_frame_float;var finfo_0=action_anim_finfo(skeletal_slot_0,cff_0,_frame_info_tmp);var frame_0=finfo_0[0];var frame_next_0=finfo_0[1];render.frame_factor=finfo_0[2];var quats_prev_0=
skeletal_slot_0.quats[frame_0];var quats_next_0=skeletal_slot_0.quats[frame_next_0];var trans_prev_0=skeletal_slot_0.trans[frame_0];var trans_next_0=skeletal_slot_0.trans[frame_next_0]}else mix_factor=1}else mix_factor=1;var skeletal_slot_1=obj.anim_slots[ind_1];if(skeletal_slot_1.play||elapsed==0){var cff_1=skeletal_slot_1.current_frame_float;var finfo_1=action_anim_finfo(skeletal_slot_1,cff_1,_frame_info_tmp);var frame_1=finfo_1[0];var frame_next_1=finfo_1[1];render.frame_factor=finfo_1[2]}else if(ind_0!=
-1&&skeletal_slot_0.play)mix_factor=0;else return;var quats_prev_1=skeletal_slot_1.quats[frame_1];var quats_next_1=skeletal_slot_1.quats[frame_next_1];var trans_prev_1=skeletal_slot_1.trans[frame_1];var trans_next_1=skeletal_slot_1.trans[frame_next_1];if(mix_factor==1){render.quats_before.set(quats_prev_1);render.quats_after.set(quats_next_1);render.trans_before.set(trans_prev_1);render.trans_after.set(trans_next_1)}else if(mix_factor==0){render.quats_before.set(quats_prev_0);render.quats_after.set(quats_next_0);
render.trans_before.set(trans_prev_0);render.trans_after.set(trans_next_0)}else{for(var i=0;i<quats_prev_0.length;i+=4){var quat1=_quat4_tmp;var quat2=_quat4_tmp2;for(var j=0;j<4;j++){quat1[j]=quats_prev_0[i+j];quat2[j]=quats_prev_1[i+j]}m_quat.slerp(quat1,quat2,mix_factor,quat1);for(var j=0;j<4;j++)render.quats_before[i+j]=quat1[j];for(var j=0;j<4;j++){quat1[j]=quats_next_0[i+j];quat2[j]=quats_next_1[i+j]}m_quat.slerp(quat1,quat2,mix_factor,quat1);for(var j=0;j<4;j++)render.quats_after[i+j]=quat1[j]}m_util.blend_arrays(trans_prev_0,
trans_prev_1,mix_factor,render.trans_before);m_util.blend_arrays(trans_next_0,trans_next_1,mix_factor,render.trans_after)}m_trans.update_transform(obj);m_armat.update_skinned_renders(obj)}function process_mix_factor(obj,elapsed){var render=obj.render;var cur_mix_factor=render.anim_mix_factor;var speed=render.anim_mix_factor_change_speed;if(speed==0)return;var dest_mix_factor=render.anim_destination_mix_factor;var delta=dest_mix_factor-cur_mix_factor;var increment=speed*elapsed;if(m_util.sign(delta)==
m_util.sign(speed)&&Math.abs(increment)<Math.abs(delta))render.anim_mix_factor+=increment;else{render.anim_mix_factor=render.anim_destination_mix_factor;render.anim_mix_factor_change_speed=0}}function calc_pose_data_frames(action,bone_pointers){var trans_frames=[];var quats_frames=[];var num_pierced=action._render.num_pierced;for(var i=0;i<num_pierced;i++){for(var bone_name in bone_pointers){var bpointer=bone_pointers[bone_name];var tsr_basis=bpointer.tsr_basis;var bone_tsr=action._render.bones[bone_name];
if(bone_tsr)m_tsr.copy(bone_tsr.subarray(i*8,i*8+8),tsr_basis);else m_tsr.identity(tsr_basis);bpointer.tsr_channel_cache_valid=false}var pose_data=calc_pose_data(bone_pointers);trans_frames.push(pose_data.trans);quats_frames.push(pose_data.quats)}return{trans:trans_frames,quats:quats_frames}}exports.calc_pose_data=calc_pose_data;function calc_pose_data(bone_pointers){var trans=[];var quats=[];var t=new Float32Array(4);var q=new Float32Array(4);for(var bone_name in bone_pointers){var bpointer=bone_pointers[bone_name];
calc_pose_bone(bpointer,t,q);var bone_index=bpointer.bone_index;for(var i=0;i<4;i++){var comp_index=4*bone_index+i;trans[comp_index]=t[i];quats[comp_index]=q[i]}}return{trans:trans,quats:quats}}function calc_skinned_pose_data_frames(armobj_pose_data_frames,bone_skinning_info){var trans_frames=[];var quats_frames=[];var armobj_trans_frames=armobj_pose_data_frames.trans;var armobj_quats_frames=armobj_pose_data_frames.quats;for(var i=0;i<armobj_trans_frames.length;i++){var armobj_pose_data=armobj_pose_data_frames[i];
var pose_data=extract_skinned_pose_data(armobj_trans_frames[i],armobj_quats_frames[i],bone_skinning_info);trans_frames.push(pose_data.trans);quats_frames.push(pose_data.quats)}return{trans:trans_frames,quats:quats_frames}}exports.extract_skinned_pose_data=extract_skinned_pose_data;function extract_skinned_pose_data(arm_trans,arm_quats,bone_skinning_info){var trans=[];var quats=[];var t=new Float32Array(4);var q=new Float32Array(4);for(var bone_name in bone_skinning_info){var skininfo=bone_skinning_info[bone_name];
var index=skininfo.bone_index;var deform_index=skininfo.deform_bone_index;for(var i=0;i<4;i++){var comp_skin_index=4*deform_index+i;var comp_arm_index=4*index+i;trans[comp_skin_index]=arm_trans[comp_arm_index];quats[comp_skin_index]=arm_quats[comp_arm_index]}}trans=new Float32Array(trans);quats=new Float32Array(quats);return{trans:trans,quats:quats}}function calc_pose_bone(bone_pointer,dest_trans_scale,dest_quat){var chain=bone_pointer.chain;var bone_root_ptr=chain[chain.length-1];var tsr_channel_parent=
bone_root_ptr.tsr_channel_cache;if(!bone_root_ptr.tsr_channel_cache_valid)m_tsr.identity(tsr_channel_parent);for(var i=chain.length-1;i>=0;i--){var bone_ptr=chain[i];var tsr_channel=bone_ptr.tsr_channel_cache;if(bone_ptr.tsr_channel_cache_valid){tsr_channel_parent=tsr_channel;continue}var tsr_local=bone_ptr.tsr_local_rest;var tsr_basis=bone_ptr.tsr_basis;m_tsr.invert(tsr_local,_tsr8_tmp);m_tsr.multiply(tsr_basis,_tsr8_tmp,_tsr8_tmp);m_tsr.multiply(tsr_local,_tsr8_tmp,_tsr8_tmp);m_tsr.multiply(tsr_channel_parent,
_tsr8_tmp,tsr_channel);tsr_channel_parent=tsr_channel;bone_ptr.tsr_channel_cache_valid=true}var tsr=bone_ptr.tsr_channel_cache;dest_trans_scale[0]=tsr[0];dest_trans_scale[1]=tsr[1];dest_trans_scale[2]=tsr[2];dest_trans_scale[3]=tsr[3];dest_quat[0]=tsr[4];dest_quat[1]=tsr[5];dest_quat[2]=tsr[6];dest_quat[3]=tsr[7];m_quat.normalize(dest_quat,dest_quat)}exports.append_action=function(action){var BONE_EXP=new RegExp(/pose.bones\[\".+\"\]/g);var TSR8_DEF=m_tsr.create();var init_storage=function(pierced_points,
default_value){if(typeof default_value=="object"&&default_value.length){var len=default_value.length;var storage=new Float32Array(pierced_points*len);for(var i=0;i<pierced_points;i++)for(var j=0;j<len;j++)storage[i*len+j]=default_value[j]}else if(typeof default_value=="number"){var storage=new Float32Array(pierced_points);for(var i=0;i<pierced_points;i++)storage[i]=default_value}else m_util.panic("Wrong storage default value");return storage};var get_storage=function(params,bones,data_path,pierced_points,
num_channels){if(data_path.search(BONE_EXP)>-1){var storage_obj=bones;var name=data_path.split('"')[1];var def_val=TSR8_DEF}else{var storage_obj=params;if(num_channels==8){var name="tsr";var def_val=TSR8_DEF}else if(num_channels>1){var name=data_path;var def_val=new Float32Array(num_channels)}else{var name=data_path;var def_val=0}}if(!storage_obj[name])storage_obj[name]=init_storage(pierced_points,def_val);return storage_obj[name]};var storage_offset=function(data_path,array_index){if(data_path.indexOf("location")>
-1){var base_offset=0;var channel_offset=array_index}else if(data_path.indexOf("rotation_quaternion")>-1){var base_offset=4;var channel_offset=array_index==0?3:array_index-1}else if(data_path.indexOf("scale")>-1){var base_offset=3;var channel_offset=0}else{var base_offset=0;var channel_offset=array_index}return base_offset+channel_offset};var prepare_tsr_arr=function(tsr_arr,num_pierced){for(var i=0;i<num_pierced;i++){var quat=tsr_arr.subarray(i*8+4,i*8+8);m_quat.normalize(quat,quat)}};var act_render=
action._render=create_action_render();act_render.pierce_step=1/cfg_ani.frame_steps;var fcurves=action["fcurves"];var params={};var bones={};var num_pierced=0;for(var data_path in fcurves){var channels=fcurves[data_path];for(var array_index in channels){var fcurve=channels[array_index];var pp=fcurve._pierced_points;m_reformer.check_anim_fcurve_completeness(fcurve,action);var num_channels=fcurve["num_channels"];if(!num_pierced)num_pierced=pp.length;var storage=get_storage(params,bones,data_path,num_pierced,
num_channels);var stride=storage.length/num_pierced;var offset=storage_offset(data_path,array_index|0);for(var i=0;i<num_pierced;i++)storage[i*stride+offset]=pp[i]}}if(m_util.get_dict_length(params)){for(var p in params)if(p=="tsr")prepare_tsr_arr(params[p],num_pierced);act_render.params=params}if(m_util.get_dict_length(bones)){for(var b in bones)prepare_tsr_arr(bones[b],num_pierced);act_render.bones=bones}act_render.num_pierced=num_pierced;act_render.bflags=action._bflags;if("tsr"in params)set_act_channels_mask(fcurves,
act_render.channels_mask);update_action_type(action);_actions.push(action)};function update_action_type(action){var act_render=action._render;if(act_render.bones)act_render.type=AT_ARMATURE;else if(act_render.params)if("volume"in act_render.params||"pitch"in act_render.params)act_render.type=AT_SPEAKER;else if(is_material_action(action))act_render.type=AT_MATERIAL;else act_render.type=AT_OBJECT;else act_render.type=AT_NONE}function is_material_action(action){var params=action._render.params;if(params)for(var param in params)if(param.indexOf("nodes")!=
-1)return true;return false}function set_act_channels_mask(fcurves,mask){mask[0]=mask[1]=mask[2]=0;for(var data_path in fcurves){var channels=fcurves[data_path];if(data_path=="location")mask[0]=1;else if(data_path=="rotation_quaternion")mask[1]=1;else if(data_path=="scale")mask[2]=1}}exports.get_approx_curve_length=function(start,end){return(end-start)*cfg_ani.frame_steps+1};exports.approximate_curve=function(fcurve,fcurve_bin_data,points,bflags,start,end){var v1=new Float32Array(2);var v2=new Float32Array(2);
var v3=new Float32Array(2);var v4=new Float32Array(2);var step=1/cfg_ani.frame_steps;var first_frame=fcurve_bin_data[1];var first_frame_value=fcurve_bin_data[2];var last_frame=fcurve_bin_data[fcurve["last_frame_offset"]+1];var last_frame_value=fcurve_bin_data[fcurve["last_frame_offset"]+2];var out_cursor=0;var bin_cursor=0;var interp_prev=null;for(var i=start;i<=end;i++)if(i<first_frame)for(var j=0;j<cfg_ani.frame_steps;j++)points[out_cursor++]=first_frame_value;else if(i>last_frame)for(var j=0;j<
cfg_ani.frame_steps;j++)points[out_cursor++]=last_frame_value;else{var interp=fcurve_bin_data[bin_cursor];var offset_to_next_kf=3;if(interp===KF_INTERP_BEZIER)offset_to_next_kf+=2;if(interp_prev===KF_INTERP_BEZIER)offset_to_next_kf+=2;var is_blended=interp===KF_INTERP_CONSTANT?0:1;if(fcurve_bin_data[bin_cursor+1]==fcurve_bin_data[bin_cursor+offset_to_next_kf+1]){interp_prev=interp;bin_cursor+=offset_to_next_kf;continue}var substep_from=0;if(i==fcurve_bin_data[bin_cursor+1]){if(is_blended)bflags[out_cursor]=
1;points[out_cursor]=fcurve_bin_data[bin_cursor+2];out_cursor++;substep_from++}if(i==last_frame)for(var j=substep_from;j<cfg_ani.frame_steps;j++)points[out_cursor++]=last_frame_value;else{v1[0]=fcurve_bin_data[bin_cursor+1];v1[1]=fcurve_bin_data[bin_cursor+2];if(interp!==KF_INTERP_BEZIER){v2[0]=0;v2[1]=0}else if(interp_prev===KF_INTERP_BEZIER){v2[0]=fcurve_bin_data[bin_cursor+5];v2[1]=fcurve_bin_data[bin_cursor+6]}else{v2[0]=fcurve_bin_data[bin_cursor+3];v2[1]=fcurve_bin_data[bin_cursor+4]}if(interp!==
KF_INTERP_BEZIER){v3[0]=0;v3[1]=0}else{v3[0]=fcurve_bin_data[bin_cursor+offset_to_next_kf+3];v3[1]=fcurve_bin_data[bin_cursor+offset_to_next_kf+4]}v4[0]=fcurve_bin_data[bin_cursor+offset_to_next_kf+1];v4[1]=fcurve_bin_data[bin_cursor+offset_to_next_kf+2];for(var j=substep_from;j<cfg_ani.frame_steps;j++){var interp_val=i+j/cfg_ani.frame_steps;switch(interp){case KF_INTERP_BEZIER:correct_bezpart(v1,v2,v3,v4);if(is_blended)bflags[out_cursor]=1;points[out_cursor]=bezier(interp_val,v1,v2,v3,v4);out_cursor++;
break;case KF_INTERP_LINEAR:var linear_params=calc_linear_params(v1,v4);if(is_blended)bflags[out_cursor]=1;points[out_cursor]=linear(interp_val,linear_params);out_cursor++;break;case KF_INTERP_CONSTANT:if(is_blended)bflags[out_cursor]=1;points[out_cursor]=fcurve_bin_data[bin_cursor+2];out_cursor++;break;default:m_util.panic("Unknown keyframe intepolation mode: "+interp)}}}if(i+1==fcurve_bin_data[bin_cursor+offset_to_next_kf+1]){interp_prev=interp;bin_cursor+=offset_to_next_kf}}};function calc_linear_params(v1,
v4){var x1=v1[0],y1=v1[1],x2=v4[0],y2=v4[1];var k=(y2-y1)/(x2-x1);var b=y1-k*x1;return{k:k,b:b}}function linear(x,linear_params){return linear_params.k*x+linear_params.b}function correct_bezpart(v1,v2,v3,v4){var h1=[];var h2=[];var len1,len2,len,fac;h1[0]=v1[0]-v2[0];h1[1]=v1[1]-v2[1];h2[0]=v4[0]-v3[0];h2[1]=v4[1]-v3[1];len=v4[0]-v1[0];len1=Math.abs(h1[0]);len2=Math.abs(h2[0]);if(len1+len2==0)return;if(len1+len2>len){fac=len/(len1+len2);v2[0]=v1[0]-fac*h1[0];v2[1]=v1[1]-fac*h1[1];v3[0]=v4[0]-fac*
h2[0];v3[1]=v4[1]-fac*h2[1]}}function bezier(x,v1,v2,v3,v4){var t=bezier_find_root(0,1,x,v1[0],v2[0],v3[0],v4[0]);var y=bezier_parametric(t,v1[1],v2[1],v3[1],v4[1]);return y}function bezier_find_root(t0_so_far,t1_so_far,x_needed,x0,x1,x2,x3){var t=t0_so_far+(t1_so_far-t0_so_far)/2;var x=bezier_parametric(t,x0,x1,x2,x3);var dx=x-x_needed;var precision=.02;if(Math.abs(dx)<precision)return t;if(dx>0)return bezier_find_root(t0_so_far,t,x_needed,x0,x1,x2,x3);else return bezier_find_root(t,t1_so_far,x_needed,
x0,x1,x2,x3)}function bezier_parametric(t,p0,p1,p2,p3){var t1=1-t;return p0*t1*t1*t1+3*p1*t1*t1*t+3*p2*t1*t*t+p3*t*t*t}function get_anim_translation(anim_slot,index,frame_info,dest){var frame=frame_info[0];var frame_next=frame_info[1];var frame_factor=frame_info[2];var trans=anim_slot.trans;var x=trans[frame][4*index];var y=trans[frame][4*index+1];var z=trans[frame][4*index+2];var xn=trans[frame_next][4*index];var yn=trans[frame_next][4*index+1];var zn=trans[frame_next][4*index+2];dest[0]=(1-frame_factor)*
x+frame_factor*xn;dest[1]=(1-frame_factor)*y+frame_factor*yn;dest[2]=(1-frame_factor)*z+frame_factor*zn;return dest}function get_anim_rotation(anim_slot,index,frame_info,dest){var frame=frame_info[0];var frame_next=frame_info[1];var frame_factor=frame_info[2];var quats=anim_slot.quats;var quat_frame=_quat4_tmp2;quat_frame[0]=quats[frame][4*index];quat_frame[1]=quats[frame][4*index+1];quat_frame[2]=quats[frame][4*index+2];quat_frame[3]=quats[frame][4*index+3];var quat_frame_next=_quat4_tmp3;quat_frame_next[0]=
quats[frame_next][4*index];quat_frame_next[1]=quats[frame_next][4*index+1];quat_frame_next[2]=quats[frame_next][4*index+2];quat_frame_next[3]=quats[frame_next][4*index+3];m_quat.slerp(quat_frame,quat_frame_next,frame_factor,dest);return dest}function get_anim_scale(anim_slot,index,frame_info){var frame=frame_info[0];var frame_next=frame_info[1];var frame_factor=frame_info[2];var trans=anim_slot.trans;var s=trans[frame][4*index+3];var sn=trans[frame_next][4*index+3];var scale=(1-frame_factor)*s+frame_factor*
sn;return scale}function do_before_apply(obj,slot_num){init_anim(obj,slot_num);update_anim_cache(obj)}function do_after_apply(obj,slot_num){m_trans.update_transform(obj);m_phy.sync_transform(obj);update_object_animation(obj,0,slot_num,true)}exports.apply=apply;function apply(obj,name,slot_num){slot_num=slot_num||SLOT_0;if(m_obj_util.is_mesh(obj)){var vertex_anim=get_vertex_anim_by_name(obj,name);if(vertex_anim){do_before_apply(obj,slot_num);apply_vertex_anim(obj,vertex_anim,slot_num);do_after_apply(obj,
slot_num);return true}var pdata=get_particles_data_by_name(obj,name);if(pdata&&pdata.p_type=="EMITTER"){do_before_apply(obj,slot_num);apply_particles_anim(obj,pdata.name,slot_num);do_after_apply(obj,slot_num);return true}}var action=m_util.keysearch("name",name,_actions)||m_util.keysearch("name",name+"_B4W_BAKED",_actions);if(action){do_before_apply(obj,slot_num);if(apply_action(obj,action,slot_num)){do_after_apply(obj,slot_num);return true}else obj.anim_slots[slot_num]=null}m_print.error('Unsupported object: "'+
obj.name+'" or animation name: "'+name+'"');return false}exports.apply_by_uuid=function(obj,uuid,slot_num){slot_num=slot_num||SLOT_0;var action=m_util.keysearch("uuid",uuid,_actions);if(action){do_before_apply(obj,slot_num);if(apply_action(obj,action,slot_num)){do_after_apply(obj,slot_num);return true}else obj.anim_slots[slot_num]=null}m_print.error('Unsupported object: "'+obj.name+'" or animation uuid: "'+uuid+'"');return false};exports.validate_action_by_name=function(obj,name){var action=m_util.keysearch("name",
name,_actions)||m_util.keysearch("name",name+"_B4W_BAKED",_actions);if(action){if(action._render.type==AT_NONE)return false}else{var pdata=get_particles_data_by_name(obj,name);if(!pdata)if(!m_obj_util.is_mesh(obj)||!get_vertex_anim_by_name(obj,name))return false}return true};exports.get_slot_num_by_anim=get_slot_num_by_anim;function get_slot_num_by_anim(obj,anim_name){var anim_slots=obj.anim_slots;for(var i=0;i<anim_slots.length;i++){var anim_slot=anim_slots[i];if(anim_slot&&strip_baked_suffix(anim_slot.animation_name)==
strip_baked_suffix(anim_name))return i}return-1}exports.get_anim_by_slot_num=function(obj,slot_num){var anim_slot=obj.anim_slots[slot_num];if(anim_slot&&anim_slot.animation_name)return strip_baked_suffix(anim_slot.animation_name);return null};exports.remove=function(obj){obj.anim_slots.length=0;var ind=_anim_objs_cache.indexOf(obj);if(ind!=-1)_anim_objs_cache.splice(ind,1)};exports.remove_actions=function(data_id){for(var i=_actions.length-1;i>=0;i--)if(_actions[i]._data_id==data_id)_actions.splice(i,
1)};exports.apply_to_first_empty_slot=function(obj,name){if(!obj.anim_slots.length)if(apply(obj,name,SLOT_0))return SLOT_0;else return-1;for(var i=0;i<obj.anim_slots.length;i++)if(!obj.anim_slots[i])if(apply(obj,name,i))return i;else return-1};exports.set_skel_mix_factor=function(obj,factor,time){var cur_mix_factor=obj.render.anim_mix_factor;var speed=(factor-cur_mix_factor)/time;obj.render.anim_mix_factor_change_speed=speed;obj.render.anim_destination_mix_factor=factor};exports.set_speed=function(obj,
speed,slot_num){function set_speed(anim_slot){anim_slot.speed=speed}process_anim_slots(obj.anim_slots,slot_num,set_speed)};exports.get_speed=function(obj,slot_num){return obj.anim_slots[slot_num].speed};exports.get_anim_start_frame=get_anim_start_frame;function get_anim_start_frame(obj,slot_num){var anim_slot=obj.anim_slots[slot_num];return anim_slot.start}exports.get_anim_length=function(obj,slot_num){var anim_slot=obj.anim_slots[slot_num];return anim_slot.length};exports.cleanup=function(){_anim_objs_cache.length=
0;_actions.length=0};exports.fcurve_replace_euler_by_quat=function(fcurve){var ch=fcurve[0]||fcurve[1]||fcurve[2];var pcount=ch._pierced_points.length;var quat=_quat4_tmp;var euler_angles=_vec3_tmp;var is_x_rot=Boolean(fcurve[0]);if(!is_x_rot)fcurve[0]={_pierced_points:new Float32Array(pcount),"num_channels":8};var is_y_rot=Boolean(fcurve[1]);if(!is_y_rot)fcurve[1]={_pierced_points:new Float32Array(pcount),"num_channels":8};var is_z_rot=Boolean(fcurve[2]);if(!is_z_rot)fcurve[2]={_pierced_points:new Float32Array(pcount),
"num_channels":8};fcurve[3]={_pierced_points:new Float32Array(pcount),"num_channels":8};for(var i=0;i<pcount;i++){euler_angles[0]=is_x_rot?fcurve[0]._pierced_points[i]:0;euler_angles[1]=is_y_rot?fcurve[1]._pierced_points[i]:0;euler_angles[2]=is_z_rot?fcurve[2]._pierced_points[i]:0;m_util.euler_to_quat(euler_angles,quat);fcurve[0]._pierced_points[i]=quat[3];fcurve[1]._pierced_points[i]=quat[0];fcurve[2]._pierced_points[i]=quat[1];fcurve[3]._pierced_points[i]=quat[2]}};function get_vertex_anim_by_name(obj,
name){for(var i=0;i<obj.vertex_anim.length;i++){var va=obj.vertex_anim[i];if(va.name===name)return va}return null}function get_particles_data_by_name(obj,name){var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var batches=scenes_data[i].batches;for(var j=0;j<batches.length;j++){var pdata=batches[j].particles_data;if(pdata&&pdata.name===name)return pdata}}return null}exports.get_bpy_armobj=get_bpy_armobj;function get_bpy_armobj(bpy_obj){var modifiers=bpy_obj["modifiers"];for(var i=
0;i<modifiers.length;i++){var modifier=modifiers[i];if(modifier["type"]=="ARMATURE")return modifier["object"]}return null}};b4w.module["__time"]=function(exports,require){var m_cfg=require("__config");var m_print=require("__print");var m_util=require("__util");var _timeline=0;var _timeline_epoch=0;var _timeouts=[];var _timeout_counter=0;var _animator_counter=0;var _animators=[];var _framerate=-1;exports.set_timeline=function(timeline){_timeline=timeline;_timeline_epoch=performance.now();for(var i=0;i<_timeouts.length;i++){var timeout=_timeouts[i];if(_timeline>timeout.expire_time){_timeouts.splice(i,1);i--;timeout.callback()}}for(var i=
0;i<_animators.length;i++){var animator=_animators[i];var time_amount=1-(animator.expire_time-_timeline)/animator.duration;time_amount=Math.min(time_amount,1);var value=animator.from+time_amount*(animator.to-animator.from);animator.callback(value);if(time_amount==1){_animators.splice(i,1);i--}}};exports.get_timeline=function(){return _timeline};function get_timeout_id(){_timeout_counter++;return _timeout_counter}function get_animation_id(){_animator_counter++;return _animator_counter}exports.set_timeout=
function(callback,time){var id=get_timeout_id();var timeout={id:id,callback:callback,expire_time:_timeline+(performance.now()-_timeline_epoch+time)/1E3};_timeouts.push(timeout);return id};exports.clear_timeout=function(id){for(var i=0;i<_timeouts.length;i++){var timeout=_timeouts[i];if(timeout.id==id){_timeouts.splice(i,1);break}}};exports.clear_animation=function(id){for(var i=_animators.length;i--;){var animator=_animators[i];if(animator.id==id){_animators.splice(i,1);break}}};exports.animate=function(from,
to,timeout,anim_cb){var duration=timeout/1E3;var id=get_animation_id();var animator={id:id,callback:anim_cb,from:from,to:to,expire_time:_timeline+duration,duration:duration};_animators.push(animator);anim_cb(from);return id};exports.reset=function(id){_timeline=0;_timeline_epoch=0;_timeouts.length=0;_animators.length=0;_timeout_counter=0;_animator_counter=0};exports.get_framerate=function(){if(m_cfg.animation.framerate!==-1)return m_cfg.animation.framerate;else return _framerate};exports.set_framerate=
function(value){_framerate=value}};b4w.module["__transform"]=function(exports,require){var m_bounds=require("__boundings");var m_cam=require("__camera");var m_cons=require("__constraints");var m_lights=require("__lights");var m_mat3=require("__mat3");var m_mat4=require("__mat4");var m_particles=require("__particles");var m_quat=require("__quat");var m_scs=require("__scenes");var m_sfx=require("__sfx");var m_tsr=require("__tsr");var m_obj=require("__objects");var m_obj_util=require("__obj_util");var m_util=require("__util");var m_vec3=
require("__vec3");var m_vec4=require("__vec4");var _vec3_tmp=new Float32Array(3);var _quat4_tmp=new Float32Array(4);var _mat3_tmp=new Float32Array(9);var _tsr_tmp=m_tsr.create();var _tsr_tmp2=m_tsr.create();var _elapsed=0;exports.SPACE_WORLD=0;exports.SPACE_LOCAL=1;exports.SPACE_PARENT=2;exports.update=function(elapsed){_elapsed=elapsed};exports.set_translation=function(obj,trans){var render=obj.render;if(m_cons.has_child_of(obj)){m_tsr.set_trans(trans,render.tsr);var tsr_par=m_cons.get_child_of_parent_tsr(obj);
var tsr_inv=m_tsr.invert(tsr_par,_tsr_tmp);var offset=m_cons.get_child_of_offset(obj);m_tsr.multiply(tsr_inv,render.tsr,offset)}else m_vec3.copy(trans,render.trans)};exports.set_translation_rel=set_translation_rel;function set_translation_rel(obj,trans){if(m_cons.has_child_of(obj)){var offset=m_cons.get_child_of_offset(obj);m_tsr.set_trans(trans,offset)}else{var render=obj.render;m_vec3.copy(trans,render.trans)}}exports.get_translation=function(obj,dest){m_vec3.copy(obj.render.trans,dest);return dest};
exports.get_translation_rel=function(obj,dest){if(m_cons.has_child_of(obj)){var offset=m_cons.get_child_of_offset(obj);m_vec3.copy(m_tsr.get_trans_view(offset),dest)}else m_vec3.copy(obj.render.trans,dest);return dest};exports.set_rotation=set_rotation;function set_rotation(obj,quat){var render=obj.render;if(m_cons.has_child_of(obj)){m_tsr.set_quat(quat,render.tsr);var tsr_par=m_cons.get_child_of_parent_tsr(obj);var tsr_inv=m_tsr.invert(tsr_par,_tsr_tmp);var offset=m_cons.get_child_of_offset(obj);
m_tsr.multiply(tsr_inv,render.tsr,offset)}else m_quat.copy(quat,render.quat)}exports.set_rotation_rel=set_rotation_rel;function set_rotation_rel(obj,quat){if(m_cons.has_child_of(obj)){var offset=m_cons.get_child_of_offset(obj);m_tsr.set_quat(quat,offset)}else{var render=obj.render;m_quat.copy(quat,render.quat)}}exports.get_rotation=function(obj,dest){m_quat.copy(obj.render.quat,dest);return dest};exports.get_rotation_rel=function(obj,dest){if(m_cons.has_child_of(obj)){var offset=m_cons.get_child_of_offset(obj);
m_quat.copy(m_tsr.get_quat_view(offset),dest)}else m_quat.copy(obj.render.quat,dest);return dest};exports.set_rotation_euler=function(obj,euler){var quat=m_util.euler_to_quat(euler,_quat4_tmp);set_rotation(obj,quat)};exports.set_rotation_euler_rel=function(obj,euler){var quat=m_util.euler_to_quat(euler,_quat4_tmp);set_rotation_rel(obj,quat)};exports.set_scale=function(obj,scale){var render=obj.render;if(m_cons.has_child_of(obj)){var offset=m_cons.get_child_of_offset(obj);var scale_par=m_tsr.get_scale(m_cons.get_child_of_parent_tsr(obj));
m_tsr.set_scale(scale/scale_par,offset)}else render.scale=scale};exports.set_scale_rel=function(obj,scale){if(m_cons.has_child_of(obj)){var offset=m_cons.get_child_of_offset(obj);m_tsr.set_scale(scale,offset)}else obj.render.scale=scale};exports.get_scale=function(obj){return obj.render.scale};exports.get_scale_rel=function(obj){if(m_cons.has_child_of(obj)){var offset=m_cons.get_child_of_offset(obj);return m_tsr.get_scale(offset)}else return obj.render.scale};exports.set_tsr=function(obj,tsr){var render=
obj.render;if(m_cons.has_child_of(obj)){m_tsr.set_trans(trans,render.tsr);var tsr_par=m_cons.get_child_of_parent_tsr(obj);var tsr_inv=m_tsr.invert(tsr_par,_tsr_tmp);var offset=m_cons.get_child_of_offset(obj);m_tsr.multiply(tsr_inv,render.tsr,offset)}else set_tsr_raw(obj,tsr)};exports.set_tsr_rel=set_tsr_rel;function set_tsr_rel(obj,tsr){if(m_cons.has_child_of(obj)){var offset=m_cons.get_child_of_offset(obj);m_tsr.copy(tsr,offset)}else set_tsr_raw(obj,tsr)}function set_tsr_raw(obj,tsr){var render=
obj.render;render.trans[0]=tsr[0];render.trans[1]=tsr[1];render.trans[2]=tsr[2];render.scale=tsr[3];render.quat[0]=tsr[4];render.quat[1]=tsr[5];render.quat[2]=tsr[6];render.quat[3]=tsr[7]}exports.get_tsr=function(obj,dest){var render=obj.render;m_tsr.set_sep(render.trans,render.scale,render.quat,dest);return dest};exports.get_tsr_rel=get_tsr_rel;function get_tsr_rel(obj,dest){if(m_cons.has_child_of(obj)){var offset=m_cons.get_child_of_offset(obj);m_tsr.copy(offset,dest)}else{var render=obj.render;
m_tsr.set_sep(render.trans,render.scale,render.quat,dest)}return dest}exports.get_object_size=function(obj){var render=obj.render;var bb=render.bb_original;var x_size=render.scale*(bb.max_x-bb.min_x);var y_size=render.scale*(bb.max_y-bb.min_y);var z_size=render.scale*(bb.max_z-bb.min_z);var size=.5*Math.sqrt(x_size*x_size+y_size*y_size+z_size*z_size);return size};exports.get_object_center=function(obj,calc_bs_center,dest){if(!dest)var dest=new Float32Array(3);if(calc_bs_center){var render=obj.render;
m_vec3.copy(render.bs_world.center,dest)}else{var render=obj.render;var bb=render.bb_original;dest[0]=(bb.max_x+bb.min_x)/2;dest[1]=(bb.max_y+bb.min_y)/2;dest[2]=(bb.max_z+bb.min_z)/2;m_vec3.transformMat4(dest,render.world_matrix,dest)}return dest};exports.move_local=function(obj,dx,dy,dz){var p_tsr=get_tsr_rel(obj,_tsr_tmp);var trans=_vec3_tmp;trans[0]=dx;trans[1]=dy;trans[2]=dz;m_tsr.transform_vec3(trans,p_tsr,trans);set_translation_rel(obj,trans)};exports.rotate_local=function(obj,quat){var p_tsr=
get_tsr_rel(obj,_tsr_tmp);var tsr=m_tsr.set_quat(quat,m_tsr.identity(_tsr_tmp2));m_tsr.multiply(p_tsr,tsr,tsr);set_tsr_rel(obj,tsr)};exports.update_transform=update_transform;function update_transform(obj){var render=obj.render;var scenes_data=obj.scenes_data;var obj_type=obj.type;if(obj_type=="CAMERA")m_cam.update_camera_upside_down(obj);m_cons.update_constraint(obj,_elapsed);if(obj_type=="CAMERA")m_cam.update_camera(obj);var trans=render.trans;var scale=render.scale;var quat=render.quat;m_tsr.set_sep(trans,
scale,quat,render.tsr);var wm=render.world_matrix;m_mat4.fromQuat(quat,wm);if(obj_type!="CAMERA")m_util.scale_mat4(wm,scale,wm);wm[12]=trans[0];wm[13]=trans[1];wm[14]=trans[2];m_mat4.invert(wm,render.inv_world_matrix);if(render.bb_local&&render.bb_world){m_bounds.bounding_box_transform(render.bb_local,wm,render.bb_world);m_bounds.bounding_sphere_transform(render.bs_local,wm,render.bs_world);m_bounds.bounding_ellipsoid_transform(render.be_local,render.tsr,render.be_world)}switch(obj_type){case "SPEAKER":m_sfx.speaker_update_transform(obj,
_elapsed);break;case "MESH":var armobj=obj.armobj;if(armobj){var armobj_tsr=armobj.render.tsr;m_tsr.invert(armobj_tsr,_tsr_tmp);m_tsr.multiply(_tsr_tmp,render.tsr,_tsr_tmp);m_vec4.set(_tsr_tmp[0],_tsr_tmp[1],_tsr_tmp[2],_tsr_tmp[3],render.arm_rel_trans);m_quat.set(_tsr_tmp[4],_tsr_tmp[5],_tsr_tmp[6],_tsr_tmp[7],render.arm_rel_quat)}break;case "CAMERA":m_cam.update_camera_transform(obj);if(m_scs.check_active()){var active_scene=m_scs.get_active();if(m_scs.get_camera(active_scene)==obj)m_sfx.listener_update_transform(active_scene,
trans,quat,_elapsed)}break;case "LAMP":m_lights.update_light_transform(obj);break}for(var i=0;i<scenes_data.length;i++){var sc_data=scenes_data[i];if(sc_data.is_active){var scene=sc_data.scene;var sc_render=scene._render;var batches=sc_data.batches;switch(obj_type){case "LAMP":m_scs.update_lamp_scene(obj,scene);break;case "CAMERA":m_scs.schedule_grass_map_update(scene);if(sc_render.shadow_params&&sc_render.shadow_params.enable_csm)m_scs.schedule_shadow_update(scene);break;case "MESH":if(render.bb_local&&
render.bb_world){if(render.shadow_cast)m_scs.schedule_shadow_update(scene);var cube_refl_subs=sc_data.cube_refl_subs;if(render.cube_reflection_id!=null&&cube_refl_subs)m_scs.update_cube_reflect_subs(cube_refl_subs,trans)}if(obj.anim_slots.length&&m_particles.obj_has_anim_particles(obj))m_particles.update_emitter_transform(obj,batches);break;case "EMPTY":m_obj.update_force(obj);break}var plane_refl_subs=sc_data.plane_refl_subs;var refl_objs=obj.reflective_objs;if(refl_objs.length&&plane_refl_subs){var cam=
plane_refl_subs.camera;m_scs.update_plane_reflect_subs(plane_refl_subs,trans,quat);m_obj_util.update_refl_objects(refl_objs,cam.reflection_plane);m_cam.set_view(cam,m_scs.get_camera(scene));m_util.extract_frustum_planes(cam.view_proj_matrix,cam.frustum_planes)}}}var cons_descends=obj.cons_descends;for(var i=0;i<cons_descends.length;i++)update_transform(cons_descends[i]);var cons_armat_bone_descends=obj.cons_armat_bone_descends;for(var i=0;i<cons_armat_bone_descends.length;i++){var cons_armat_desc=
cons_armat_bone_descends[i];var armobj=cons_armat_desc[0];var bone_name=cons_armat_desc[1];m_cons.update_bone_constraint(armobj,bone_name)}render.force_zsort=true}exports.distance=function(obj1,obj2){return m_vec3.dist(obj1.render.trans,obj2.render.trans)};exports.obj_point_distance=function(obj,point){return m_vec3.dist(obj.render.trans,point)};exports.get_object_bounding_box=function(obj){return{max_x:obj.render.bb_world.max_x,min_x:obj.render.bb_world.min_x,max_y:obj.render.bb_world.max_y,min_y:obj.render.bb_world.min_y,
max_z:obj.render.bb_world.max_z,min_z:obj.render.bb_world.min_z}}};b4w.module["__tsr"]=function(exports,require){var m_mat4=require("__mat4");var m_quat=require("__quat");var m_util=require("__util");var m_vec3=require("__vec3");var _vec3_tmp=new Float32Array(3);var _quat_tmp=new Float32Array(4);var _mat4_tmp=new Float32Array(16);exports.create=function(){var tsr=new Float32Array(8);tsr[3]=1;tsr[7]=1;return tsr};exports.from_values=function(x,y,z,s,qx,qy,qz,qw){var tsr=new Float32Array(8);tsr[0]=x;tsr[1]=y;tsr[2]=z;tsr[3]=s;tsr[4]=qx;tsr[5]=qy;tsr[6]=qz;tsr[7]=qw;
return tsr};exports.copy=function(tsr,dest){dest[0]=tsr[0];dest[1]=tsr[1];dest[2]=tsr[2];dest[3]=tsr[3];dest[4]=tsr[4];dest[5]=tsr[5];dest[6]=tsr[6];dest[7]=tsr[7];return dest};exports.identity=function(tsr){tsr[0]=0;tsr[1]=0;tsr[2]=0;tsr[3]=1;tsr[4]=0;tsr[5]=0;tsr[6]=0;tsr[7]=1;return tsr};exports.create_sep=function(trans,scale,quat,dest){if(!dest)var dest=new Float32Array(8);set_sep(trans,scale,quat,dest);return dest};exports.set_sep=set_sep;function set_sep(trans,scale,quat,dest){dest[0]=trans[0];
dest[1]=trans[1];dest[2]=trans[2];dest[3]=scale;dest[4]=quat[0];dest[5]=quat[1];dest[6]=quat[2];dest[7]=quat[3];return dest}exports.set_trans=function(trans,dest){dest[0]=trans[0];dest[1]=trans[1];dest[2]=trans[2];return dest};exports.set_scale=function(scale,dest){dest[3]=scale;return dest};exports.set_transcale=function(transcale,dest){dest[0]=transcale[0];dest[1]=transcale[1];dest[2]=transcale[2];dest[3]=transcale[3];return dest};exports.set_quat=function(quat,dest){dest[4]=quat[0];dest[5]=quat[1];
dest[6]=quat[2];dest[7]=quat[3];return dest};exports.get_trans_view=function(tsr){return tsr.subarray(0,3)};exports.get_scale=function(tsr){return tsr[3]};exports.get_quat_view=function(tsr){return tsr.subarray(4)};exports.invert=function(tsr,dest){var sc_inv=1/tsr[3];if(!sc_inv)return null;var tx=tsr[0];var ty=tsr[1];var tz=tsr[2];_quat_tmp[0]=tsr[4];_quat_tmp[1]=tsr[5];_quat_tmp[2]=tsr[6];_quat_tmp[3]=tsr[7];m_quat.invert(_quat_tmp,_quat_tmp);var qx_inv=_quat_tmp[0];var qy_inv=_quat_tmp[1];var qz_inv=
_quat_tmp[2];var qw_inv=_quat_tmp[3];var x=tx*sc_inv;var y=ty*sc_inv;var z=tz*sc_inv;var ix=qw_inv*x+qy_inv*z-qz_inv*y;var iy=qw_inv*y+qz_inv*x-qx_inv*z;var iz=qw_inv*z+qx_inv*y-qy_inv*x;var iw=-qx_inv*x-qy_inv*y-qz_inv*z;dest[0]=-(ix*qw_inv+iw*-qx_inv+iy*-qz_inv-iz*-qy_inv);dest[1]=-(iy*qw_inv+iw*-qy_inv+iz*-qx_inv-ix*-qz_inv);dest[2]=-(iz*qw_inv+iw*-qz_inv+ix*-qy_inv-iy*-qx_inv);dest[3]=sc_inv;dest[4]=qx_inv;dest[5]=qy_inv;dest[6]=qz_inv;dest[7]=qw_inv;return dest};exports.to_mat4=function(tsr,
dest){var trans=tsr.subarray(0,3);var scale=tsr[3];var quat=tsr.subarray(4);var mat=m_mat4.fromRotationTranslation(quat,trans,dest);for(var i=0;i<12;i++)dest[i]*=scale;return dest};exports.from_mat4=function(mat,dest){var trans=m_util.matrix_to_trans(mat,_vec3_tmp);var scale=m_util.matrix_to_scale(mat);var quat=m_util.matrix_to_quat(mat,_quat_tmp);set_sep(trans,scale,quat,dest);return dest};exports.multiply=function(tsr,tsr2,dest){transform_vec3(tsr2,tsr,dest);dest[3]=tsr[3]*tsr2[3];var ax=tsr[4],
ay=tsr[5],az=tsr[6],aw=tsr[7],bx=tsr2[4],by=tsr2[5],bz=tsr2[6],bw=tsr2[7];dest[4]=ax*bw+aw*bx+ay*bz-az*by;dest[5]=ay*bw+aw*by+az*bx-ax*bz;dest[6]=az*bw+aw*bz+ax*by-ay*bx;dest[7]=aw*bw-ax*bx-ay*by-az*bz;return dest};function transform_mat4(matrix,tsr,dest){var trans=tsr.subarray(0,3);var scale=tsr[3];var quat=tsr.subarray(4);var m=m_mat4.fromRotationTranslation(quat,trans,_mat4_tmp);for(var i=0;i<12;i++)dest[i]*=scale;m_mat4.multiply(m,matrix,dest);return dest}exports.transform_vec3=transform_vec3;
function transform_vec3(vec,tsr,dest){var tx=tsr[0];var ty=tsr[1];var tz=tsr[2];var scale=tsr[3];var qx=tsr[4];var qy=tsr[5];var qz=tsr[6];var qw=tsr[7];var x=vec[0]*scale;var y=vec[1]*scale;var z=vec[2]*scale;var ix=qw*x+qy*z-qz*y;var iy=qw*y+qz*x-qx*z;var iz=qw*z+qx*y-qy*x;var iw=-qx*x-qy*y-qz*z;dest[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy;dest[1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;dest[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;dest[0]+=tx;dest[1]+=ty;dest[2]+=tz;return dest}exports.transform_vec3_inv=function(vec,tsr,dest){var tx=
tsr[0];var ty=tsr[1];var tz=tsr[2];var scale=tsr[3];var x=vec[0]-tx;var y=vec[1]-ty;var z=vec[2]-tz;var qx=tsr[4];var qy=tsr[5];var qz=tsr[6];var qw=tsr[7];var dot=qx*qx+qy*qy+qz*qz+qw*qw;var inv_dot=dot?1/dot:0;qx=-qx*inv_dot;qy=-qy*inv_dot;qz=-qz*inv_dot;qw=qw*inv_dot;var ix=qw*x+qy*z-qz*y;var iy=qw*y+qz*x-qx*z;var iz=qw*z+qx*y-qy*x;var iw=-qx*x-qy*y-qz*z;dest[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy;dest[1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;dest[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;dest[0]/=scale;dest[1]/=scale;dest[2]/=
scale;return dest};exports.transform_vectors=function(vectors,tsr,new_vectors,dest_offset){if(!dest_offset)var dest_offset=0;var len=vectors.length;var tx=tsr[0];var ty=tsr[1];var tz=tsr[2];var scale=tsr[3];var qx=tsr[4];var qy=tsr[5];var qz=tsr[6];var qw=tsr[7];for(var i=0;i<len;i+=3){var x=vectors[i]*scale;var y=vectors[i+1]*scale;var z=vectors[i+2]*scale;var ix=qw*x+qy*z-qz*y;var iy=qw*y+qz*x-qx*z;var iz=qw*z+qx*y-qy*x;var iw=-qx*x-qy*y-qz*z;new_vectors[dest_offset+i]=ix*qw+iw*-qx+iy*-qz-iz*-qy;
new_vectors[dest_offset+i+1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;new_vectors[dest_offset+i+2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;new_vectors[dest_offset+i]+=tx;new_vectors[dest_offset+i+1]+=ty;new_vectors[dest_offset+i+2]+=tz}return new_vectors};exports.transform_dir_vectors=function(vectors,tsr,new_vectors,dest_offset){if(!dest_offset)var dest_offset=0;var len=vectors.length;var scale=tsr[3];var qx=tsr[4];var qy=tsr[5];var qz=tsr[6];var qw=tsr[7];for(var i=0;i<len;i+=3){var x=vectors[i]*scale;var y=vectors[i+1]*
scale;var z=vectors[i+2]*scale;var ix=qw*x+qy*z-qz*y;var iy=qw*y+qz*x-qx*z;var iz=qw*z+qx*y-qy*x;var iw=-qx*x-qy*y-qz*z;new_vectors[dest_offset+i]=ix*qw+iw*-qx+iy*-qz-iz*-qy;new_vectors[dest_offset+i+1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;new_vectors[dest_offset+i+2]=iz*qw+iw*-qz+ix*-qy-iy*-qx}return new_vectors};exports.transform_dir_vec3=function(vec,tsr,new_vec){var scale=tsr[3];var qx=tsr[4];var qy=tsr[5];var qz=tsr[6];var qw=tsr[7];var x=vec[0]*scale;var y=vec[1]*scale;var z=vec[2]*scale;var ix=qw*x+
qy*z-qz*y;var iy=qw*y+qz*x-qx*z;var iz=qw*z+qx*y-qy*x;var iw=-qx*x-qy*y-qz*z;new_vec[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy;new_vec[1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;new_vec[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;return new_vec};exports.transform_tangents=function(vectors,tsr,new_vectors,dest_offset){if(!dest_offset)var dest_offset=0;var len=vectors.length;var scale=tsr[3];var qx=tsr[4];var qy=tsr[5];var qz=tsr[6];var qw=tsr[7];for(var i=0;i<len;i+=4){var x=vectors[i]*scale;var y=vectors[i+1]*scale;var z=vectors[i+2]*
scale;var ix=qw*x+qy*z-qz*y;var iy=qw*y+qz*x-qx*z;var iz=qw*z+qx*y-qy*x;var iw=-qx*x-qy*y-qz*z;new_vectors[dest_offset+i]=ix*qw+iw*-qx+iy*-qz-iz*-qy;new_vectors[dest_offset+i+1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;new_vectors[dest_offset+i+2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;new_vectors[dest_offset+i+3]=vectors[i+3]}return new_vectors};exports.translate=function(tsr,vec,dest){var scale=tsr[3];var qx=tsr[4];var qy=tsr[5];var qz=tsr[6];var qw=tsr[7];var x=vec[0]*scale;var y=vec[1]*scale;var z=vec[2]*scale;var ix=
qw*x+qy*z-qz*y;var iy=qw*y+qz*x-qx*z;var iz=qw*z+qx*y-qy*x;var iw=-qx*x-qy*y-qz*z;dest[0]=tsr[0]+ix*qw+iw*-qx+iy*-qz-iz*-qy;dest[1]=tsr[1]+iy*qw+iw*-qy+iz*-qx-ix*-qz;dest[2]=tsr[2]+iz*qw+iw*-qz+ix*-qy-iy*-qx;dest[3]=tsr[3];dest[4]=tsr[4];dest[5]=tsr[5];dest[6]=tsr[6];dest[7]=tsr[7];return dest};exports.interpolate=function(tsr,tsr2,factor,dest){if(!dest)var dest=new Float32Array(8);var trans=tsr.subarray(0,3);var trans2=tsr2.subarray(0,3);var trans_dst=dest.subarray(0,3);m_vec3.lerp(trans,trans2,
factor,trans_dst);var scale=tsr[3];var scale2=tsr2[3];dest[3]=scale+factor*(scale2-scale);var quat=tsr.subarray(4);var quat2=tsr2.subarray(4);var quat_dst=dest.subarray(4);m_quat.slerp(quat,quat2,factor,quat_dst);return dest};exports.extrapolate=function(tsr,tsr2,factor,dest){if(!dest)var dest=new Float32Array(8);var trans=tsr.subarray(0,3);var trans2=tsr2.subarray(0,3);var trans_dst=dest.subarray(0,3);trans_dst[0]=trans2[0]*(factor+1)-trans[0]*factor;trans_dst[1]=trans2[1]*(factor+1)-trans[1]*factor;
trans_dst[2]=trans2[2]*(factor+1)-trans[2]*factor;var scale=tsr[3];var scale2=tsr2[3];dest[3]=scale2*(factor+1)-scale*factor;var quat=tsr.subarray(4);var quat2=tsr2.subarray(4);var quat_dst=dest.subarray(4);quat_dst[0]=quat2[0]*(factor+1)-quat[0]*factor;quat_dst[1]=quat2[1]*(factor+1)-quat[1]*factor;quat_dst[2]=quat2[2]*(factor+1)-quat[2]*factor;quat_dst[3]=quat2[3]*(factor+1)-quat[3]*factor;m_quat.normalize(quat_dst,quat_dst);return dest};exports.integrate=function(tsr,time,linvel,angvel,dest){dest[0]=
tsr[0]+time*linvel[0];dest[1]=tsr[1]+time*linvel[1];dest[2]=tsr[2]+time*linvel[2];dest[3]=tsr[3];tsr_quat_deriv_angvel(tsr,angvel,dest);dest[4]=tsr[4]+dest[4]*time;dest[5]=tsr[5]+dest[5]*time;dest[6]=tsr[6]+dest[6]*time;dest[7]=tsr[7]+dest[7]*time;tsr_quat_normalize(dest,dest)};function tsr_quat_deriv_angvel(tsr,angvel,dest){var wx=angvel[0];var wy=angvel[1];var wz=angvel[2];var qx=tsr[4];var qy=tsr[5];var qz=tsr[6];var qw=tsr[7];dest[4]=.5*(wx*qw+wy*qz-wz*qy);dest[5]=.5*(wy*qw+wz*qx-wx*qz);dest[6]=
.5*(wz*qw+wx*qy-wy*qx);dest[7]=.5*(-wx*qx-wy*qy-wz*qz)}function tsr_quat_normalize(tsr,dest){var x=tsr[4];var y=tsr[5];var z=tsr[6];var w=tsr[7];var len=x*x+y*y+z*z+w*w;if(len>0){len=1/Math.sqrt(len);dest[4]=tsr[4]*len;dest[5]=tsr[5]*len;dest[6]=tsr[6]*len;dest[7]=tsr[7]*len}}};b4w.module["__util"]=function(exports,require){var m_mat3=require("__mat3");var m_mat4=require("__mat4");var m_print=require("__print");var m_quat=require("__quat");var m_vec3=require("__vec3");var m_vec4=require("__vec4");var _unique_counter=0;var _unique_name_counters={};var _vec3_tmp=new Float32Array(3);var _vec3_tmp2=new Float32Array(3);var _vec4_tmp=new Float32Array(4);var _vec4_tmp2=new Float32Array(4);var _mat3_tmp=new Float32Array(9);var _mat4_tmp=new Float32Array(16);var _mat4_tmp2=new Float32Array(16);
var _hash_buffer_in=new Float64Array(1);var _hash_buffer_out=new Uint32Array(_hash_buffer_in.buffer);var VEC3_IDENT=new Float32Array([0,0,0]);var QUAT4_IDENT=new Float32Array([0,0,0,1]);var TSR8_IDENT=new Float32Array([0,0,0,1,0,0,0,1]);var VEC3_UNIT=new Float32Array([1,1,1]);var AXIS_X=new Float32Array([1,0,0]);var AXIS_Y=new Float32Array([0,1,0]);var AXIS_Z=new Float32Array([0,0,1]);var AXIS_MX=new Float32Array([-1,0,0]);var AXIS_MY=new Float32Array([0,-1,0]);var AXIS_MZ=new Float32Array([0,0,-1]);
var DEFAULT_SEED=5E4;var RAND_A=48271;var RAND_M=2147483647;var RAND_R=RAND_M%RAND_A;var RAND_Q=Math.floor(RAND_M/RAND_A);var MIN_CLAMPING_INTERVAL=.001;var INV_CUBE_VIEW_MATRS=[new Float32Array([0,0,-1,0,0,-1,0,0,-1,0,0,0,0,0,0,1]),new Float32Array([0,0,1,0,0,-1,0,0,1,0,0,0,0,0,0,1]),new Float32Array([1,0,0,0,0,0,-1,0,0,1,0,0,0,0,0,1]),new Float32Array([1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1]),new Float32Array([1,0,0,0,0,-1,0,0,0,0,-1,0,0,0,0,1]),new Float32Array([-1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1])];
var GAMMA=2.2;exports.VEC3_IDENT=VEC3_IDENT;exports.QUAT4_IDENT=QUAT4_IDENT;exports.TSR8_IDENT=TSR8_IDENT;exports.VEC3_UNIT=VEC3_UNIT;exports.AXIS_X=AXIS_X;exports.AXIS_Y=AXIS_Y;exports.AXIS_Z=AXIS_Z;exports.AXIS_MX=AXIS_MX;exports.AXIS_MY=AXIS_MY;exports.AXIS_MZ=AXIS_MZ;exports.INV_CUBE_VIEW_MATRS=INV_CUBE_VIEW_MATRS;exports.keyfind=keyfind;function keyfind(key,value,array){var results=[];var len=array.length;for(var i=0;i<len;i++){var obj=array[i];if(obj[key]==value)results.push(obj)}return results}
exports.float32_concat=function(first,second){var firstLength=first.length;var result=new Float32Array(firstLength+second.length);result.set(first);result.set(second,firstLength);return result};exports.uint32_concat=function(first,second){var firstLength=first.length;var result=new Uint32Array(firstLength+second.length);result.set(first);result.set(second,firstLength);return result};exports.check_endians=function(){var value=255;var x=new Uint16Array([value]);var dataview=new DataView(x.buffer);return dataview.getUint16(0,
true)==value};exports.array_intersect=function(arr1,arr2){var r=[],o={},l=arr2.length,i,v;for(i=0;i<l;i++)o[arr2[i]]=true;l=arr1.length;for(i=0;i<l;i++){v=arr1[i];if(v in o)r.push(v)}return r};exports.sign=sign;function sign(value){return value>0?1:value<0?-1:0}exports.keycheck=function(key,value,array){var len=array.length;for(var i=0;i<len;i++){var obj=array[i];if(obj[key]==value)return true}return false};exports.keysearch=function(key,value,array){for(var i=0;i<array.length;i++){var obj=array[i];
if(obj[key]===value)return obj}return null};exports.key2search=function(key1,value1,key2,value2,array){for(var i=0;i<array.length;i++){var obj=array[i];if(obj[key1]==value1&&obj[key2]==value2)return obj}return null};exports.get_index_for_key_value=function(array,key,value){for(var i=0;i<array.length;i++)if(array[i][key]==value)return i;return-1};exports.append_unique=function(array,value){for(var i=0;i<array.length;i++)if(array[i]==value)return;array.push(value)};exports.check_uniqueness=function(array){for(var i=
0;i<array.length-1;i++){var elem_i=array[i];for(var j=i+1;j<array.length;j++){var elem_j=array[j];if(elem_i==elem_j)return false}}return true};exports.trans_matrix=function(x,y,z,dest){if(!dest)var dest=new Float32Array(16);m_mat4.identity(dest);dest[12]=x;dest[13]=y;dest[14]=z;return dest};var _next=1;exports.rand=function(){_next=(_next*69069+5)%Math.pow(2,32);return Math.round(_next/65536)%32768/32767};exports.srand=function(seed){_next=seed};exports.rand_r=function(seedp){var high=Math.floor(seedp[0]/
RAND_Q);var low=seedp[0]%RAND_Q;var test=RAND_A*low-RAND_R*high;if(test>0)seedp[0]=test;else seedp[0]=test+RAND_M;return(seedp[0]-1)/(RAND_M-1)};exports.init_rand_r_seed=function(seed_number,dest){if(!dest)dest=[];dest[0]=DEFAULT_SEED+Math.floor(seed_number);return dest};exports.euler_to_quat=function(euler,quat){if(!quat)quat=new Float32Array(4);var c1=Math.cos(euler[1]/2);var c2=Math.cos(euler[2]/2);var c3=Math.cos(euler[0]/2);var s1=Math.sin(euler[1]/2);var s2=Math.sin(euler[2]/2);var s3=Math.sin(euler[0]/
2);quat[0]=s1*s2*c3+c1*c2*s3;quat[1]=s1*c2*c3+c1*s2*s3;quat[2]=c1*s2*c3-s1*c2*s3;quat[3]=c1*c2*c3-s1*s2*s3;return quat};exports.euler_to_rotation_matrix=function(euler){var matrix=m_mat3.create();var cosX=Math.cos(euler[0]);var cosY=Math.cos(euler[1]);var cosZ=Math.cos(euler[2]);var sinX=Math.sin(euler[0]);var sinY=Math.sin(euler[1]);var sinZ=Math.sin(euler[2]);var cosXcosZ=cosX*cosZ;var cosXsinZ=cosX*sinZ;var sinXcosZ=sinX*cosZ;var sinXsinZ=sinX*sinZ;matrix[0]=cosY*cosZ;matrix[1]=cosY*sinZ;matrix[2]=
-sinY;matrix[3]=sinY*sinXcosZ-cosXsinZ;matrix[4]=sinY*sinXsinZ+cosXcosZ;matrix[5]=cosY*sinX;matrix[6]=sinY*cosXcosZ+sinXsinZ;matrix[7]=sinY*cosXsinZ-sinXcosZ;matrix[8]=cosY*cosX;return matrix};exports.quat_to_euler=function(quat,euler){var qx=quat[0];var qy=quat[1];var qz=quat[2];var qw=quat[3];var qw2=qw*qw;var qx2=qx*qx;var qy2=qy*qy;var qz2=qz*qz;var test=qx*qy+qz*qw;if(test>.499999){euler[0]=0;euler[1]=2*Math.atan2(qx,qw);euler[2]=Math.PI/2}else if(test<-.499999){euler[0]=0;euler[1]=-2*Math.atan2(qx,
qw);euler[2]=-Math.PI/2}else{euler[0]=Math.atan2(2*qx*qw-2*qy*qz,1-2*qx2-2*qz2);euler[1]=Math.atan2(2*qy*qw-2*qx*qz,1-2*qy2-2*qz2);euler[2]=Math.asin(2*qx*qy+2*qz*qw)}return euler};exports.quat_to_dir=function(quat,ident,dest){if(!dest)var dest=new Float32Array(3);m_vec3.transformQuat(ident,quat,dest);return dest};exports.dir_to_quat=function(dir,ident,dest){if(!dest)var dest=new Float32Array(4);var dir=m_vec3.normalize(dir,_vec3_tmp);var dot=m_vec3.dot(ident,dir);var A=m_vec3.cross(ident,dir,_vec3_tmp2);
var teta=Math.acos(dot);dest[0]=A[0]*Math.sin(teta/2);dest[1]=A[1]*Math.sin(teta/2);dest[2]=A[2]*Math.sin(teta/2);dest[3]=Math.cos(teta/2);return dest};exports.trans_quat_to_plane=function(trans,quat,ident,dest){if(!dest)var dest=new Float32Array(4);m_vec3.transformQuat(ident,quat,dest);dest[3]=-m_vec3.dot(trans,dest);return dest};exports.dir_ground_proj_angle=function(obj){var render=obj.render;var quat=render.quat;var proj=_vec3_tmp;var defdir=_vec3_tmp2;switch(obj.type){case "CAMERA":proj[0]=0;
proj[1]=-1;proj[2]=0;m_vec3.transformQuat(proj,quat,proj);defdir[0]=0;defdir[1]=0;defdir[2]=-1;break;case "MESH":proj[0]=0;proj[1]=0;proj[2]=1;m_vec3.transformQuat(proj,quat,proj);defdir[0]=0;defdir[1]=0;defdir[2]=1;break;case "EMPTY":proj[0]=0;proj[1]=1;proj[2]=0;m_vec3.transformQuat(proj,quat,proj);defdir[0]=0;defdir[1]=1;defdir[2]=0;break}proj[1]=0;m_vec3.normalize(proj,proj);var cos=m_vec3.dot(proj,defdir);var sign=-proj[0]*defdir[2]>0?-1:1;var angle=Math.acos(cos)*sign;return angle};exports.blend_arrays=
blend_arrays;function blend_arrays(a1,a2,f,dest){if(f==0)return a1;dest=dest||[];for(var i=0;i<a1.length;i++)dest[i]=(1-f)*a1[i]+f*a2[i];return dest}exports.unique_id=function(){_unique_counter++;return _unique_counter.toString(16)};exports.unique_name=function(name_base){if(!_unique_name_counters[name_base])_unique_name_counters[name_base]=0;var name=name_base+_unique_name_counters[name_base];_unique_name_counters[name_base]++;return name};exports.create_empty_va_frame=function(){var va_frame={"a_position":new Float32Array(0),
"a_tangent":new Float32Array(0),"a_normal":new Float32Array(0)};return va_frame};exports.create_empty_submesh=function(name){var va_common={"a_influence":new Float32Array(0),"a_color":new Float32Array(0),"a_texcoord":new Float32Array(0)};return{name:name,base_length:0,indices:null,va_frames:[],va_common:va_common,shape_keys:[]}};exports.clone_object_json=function(obj){return JSON.parse(JSON.stringify(obj))};exports.clone_object_r=function(obj){if(!(obj instanceof Object))return obj;var obj_clone;
var Constructor=obj.constructor;switch(Constructor){case Float32Array:case Uint32Array:case Uint16Array:obj_clone=new Constructor(obj);break;case Array:obj_clone=new Constructor(obj.length);for(var i=0;i<obj.length;i++)obj_clone[i]=exports.clone_object_r(obj[i]);break;default:obj_clone=new Constructor;for(var prop in obj)obj_clone[prop]=exports.clone_object_r(obj[prop]);break}return obj_clone};exports.clone_object_nr=function(obj){var new_obj=obj instanceof Array?[]:{};for(var prop in obj)if(obj[prop]instanceof
Object){var Constructor=obj[prop].constructor;switch(Constructor){case Float32Array:case Uint32Array:case Uint16Array:new_obj[prop]=new Constructor(obj[prop]);break;case Array:new_obj[prop]=obj[prop].slice(0);break;default:new_obj[prop]=obj[prop];break}}else new_obj[prop]=obj[prop];return new_obj};exports.matrix_to_quat=matrix_to_quat;function matrix_to_quat(matrix,dest){if(!dest)var dest=new Float32Array(4);m_mat3.fromMat4(matrix,_mat3_tmp);var m0=_mat3_tmp[0];var m3=_mat3_tmp[3];var m6=_mat3_tmp[6];
var m1=_mat3_tmp[1];var m4=_mat3_tmp[4];var m7=_mat3_tmp[7];var m2=_mat3_tmp[2];var m5=_mat3_tmp[5];var m8=_mat3_tmp[8];var l0=Math.sqrt(m0*m0+m3*m3+m6*m6)||1;var l1=Math.sqrt(m1*m1+m4*m4+m7*m7)||1;var l2=Math.sqrt(m2*m2+m5*m5+m8*m8)||1;_mat3_tmp[0]/=l0;_mat3_tmp[3]/=l0;_mat3_tmp[6]/=l0;_mat3_tmp[1]/=l1;_mat3_tmp[4]/=l1;_mat3_tmp[7]/=l1;_mat3_tmp[2]/=l2;_mat3_tmp[5]/=l2;_mat3_tmp[8]/=l2;m_quat.fromMat3(_mat3_tmp,dest);return dest}exports.matrix_to_trans=function(matrix,dest){if(!dest)var dest=new Float32Array(3);
dest[0]=matrix[12];dest[1]=matrix[13];dest[2]=matrix[14];return dest};exports.matrix_to_scale=function(matrix){_vec4_tmp[0]=.577350269189626;_vec4_tmp[1]=.577350269189626;_vec4_tmp[2]=.577350269189626;_vec4_tmp[3]=0;m_vec4.transformMat4(_vec4_tmp,matrix,_vec4_tmp);return m_vec4.length(_vec4_tmp)};exports.extract_frustum_planes=function(m,planes){var left=planes.left;var right=planes.right;var top=planes.top;var bottom=planes.bottom;var near=planes.near;var far=planes.far;left[0]=m[3]+m[0];left[1]=
m[7]+m[4];left[2]=m[11]+m[8];left[3]=m[15]+m[12];right[0]=m[3]-m[0];right[1]=m[7]-m[4];right[2]=m[11]-m[8];right[3]=m[15]-m[12];top[0]=m[3]-m[1];top[1]=m[7]-m[5];top[2]=m[11]-m[9];top[3]=m[15]-m[13];bottom[0]=m[3]+m[1];bottom[1]=m[7]+m[5];bottom[2]=m[11]+m[9];bottom[3]=m[15]+m[13];near[0]=m[3]+m[2];near[1]=m[7]+m[6];near[2]=m[11]+m[10];near[3]=m[15]+m[14];far[0]=m[3]-m[2];far[1]=m[7]-m[6];far[2]=m[11]-m[10];far[3]=m[15]-m[14];normalize_plane(left);normalize_plane(right);normalize_plane(top);normalize_plane(bottom);
normalize_plane(near);normalize_plane(far);return planes};function normalize_plane(plane){var a=plane[0],b=plane[1],c=plane[2],d=plane[3];var len=Math.sqrt(a*a+b*b+c*c);len=1/len;plane[0]=a*len;plane[1]=b*len;plane[2]=c*len;plane[3]=d*len}exports.sphere_is_out_of_frustum=function(pt,planes,radius){if(radius<-point_plane_dist(pt,planes.left)||radius<-point_plane_dist(pt,planes.right)||radius<-point_plane_dist(pt,planes.top)||radius<-point_plane_dist(pt,planes.bottom)||radius<-point_plane_dist(pt,planes.near)||
radius<-point_plane_dist(pt,planes.far))return true;else return false};exports.ellipsoid_is_out_of_frustum=function(pt,planes,axis_x,axis_y,axis_z){dot_nx=m_vec3.dot(axis_x,planes.far);dot_ny=m_vec3.dot(axis_y,planes.far);dot_nz=m_vec3.dot(axis_z,planes.far);var r_far=Math.sqrt(dot_nx*dot_nx+dot_ny*dot_ny+dot_nz*dot_nz);if(r_far<-point_plane_dist(pt,planes.near)||r_far<-point_plane_dist(pt,planes.far))return true;var dot_nx=m_vec3.dot(axis_x,planes.left);var dot_ny=m_vec3.dot(axis_y,planes.left);
var dot_nz=m_vec3.dot(axis_z,planes.left);var r_left=Math.sqrt(dot_nx*dot_nx+dot_ny*dot_ny+dot_nz*dot_nz);if(r_left<-point_plane_dist(pt,planes.left))return true;dot_nx=m_vec3.dot(axis_x,planes.right);dot_ny=m_vec3.dot(axis_y,planes.right);dot_nz=m_vec3.dot(axis_z,planes.right);var r_right=Math.sqrt(dot_nx*dot_nx+dot_ny*dot_ny+dot_nz*dot_nz);if(r_right<-point_plane_dist(pt,planes.right))return true;dot_nx=m_vec3.dot(axis_x,planes.top);dot_ny=m_vec3.dot(axis_y,planes.top);dot_nz=m_vec3.dot(axis_z,
planes.top);var r_top=Math.sqrt(dot_nx*dot_nx+dot_ny*dot_ny+dot_nz*dot_nz);if(r_top<-point_plane_dist(pt,planes.top))return true;dot_nx=m_vec3.dot(axis_x,planes.bottom);dot_ny=m_vec3.dot(axis_y,planes.bottom);dot_nz=m_vec3.dot(axis_z,planes.bottom);var r_bott=Math.sqrt(dot_nx*dot_nx+dot_ny*dot_ny+dot_nz*dot_nz);if(r_bott<-point_plane_dist(pt,planes.bottom))return true;return false};function point_plane_dist(pt,plane){return plane[0]*pt[0]+plane[1]*pt[1]+plane[2]*pt[2]+plane[3]}exports.positions_multiply_matrix=
function(positions,matrix,new_positions,dest_offset){if(!dest_offset)var dest_offset=0;var len=positions.length;for(var i=0;i<len;i+=3){var x=positions[i];var y=positions[i+1];var z=positions[i+2];new_positions[dest_offset+i]=matrix[0]*x+matrix[4]*y+matrix[8]*z+matrix[12];new_positions[dest_offset+i+1]=matrix[1]*x+matrix[5]*y+matrix[9]*z+matrix[13];new_positions[dest_offset+i+2]=matrix[2]*x+matrix[6]*y+matrix[10]*z+matrix[14]}return new_positions};exports.vectors_multiply_matrix=function(vectors,
matrix,new_vectors,dest_offset){if(!dest_offset)var dest_offset=0;var len=vectors.length;for(var i=0;i<len;i+=3){var x=vectors[i];var y=vectors[i+1];var z=vectors[i+2];new_vectors[dest_offset+i]=matrix[0]*x+matrix[4]*y+matrix[8]*z;new_vectors[dest_offset+i+1]=matrix[1]*x+matrix[5]*y+matrix[9]*z;new_vectors[dest_offset+i+2]=matrix[2]*x+matrix[6]*y+matrix[10]*z}return new_vectors};exports.tangents_multiply_matrix=function(vectors,matrix,new_vectors,dest_offset){if(!dest_offset)var dest_offset=0;var len=
vectors.length;for(var i=0;i<len;i+=4){var x=vectors[i];var y=vectors[i+1];var z=vectors[i+2];new_vectors[dest_offset+i]=matrix[0]*x+matrix[4]*y+matrix[8]*z;new_vectors[dest_offset+i+1]=matrix[1]*x+matrix[5]*y+matrix[9]*z;new_vectors[dest_offset+i+2]=matrix[2]*x+matrix[6]*y+matrix[10]*z;new_vectors[dest_offset+i+3]=vectors[i+3]}return new_vectors};exports.vecdir_multiply_matrix=function(vec,matrix,dest){if(!dest)var dest=new Float32Array(3);var v4=_vec4_tmp;v4[0]=vec[0];v4[1]=vec[1];v4[2]=vec[2];
v4[3]=0;m_vec4.transformMat4(v4,matrix,v4);dest[0]=v4[0];dest[1]=v4[1];dest[2]=v4[2]};exports.flatten=function(array,dest){var len=array.length;if(!len)throw"flatten(): Wrong or empty array";var len0=array[0].length;if(!len0)throw"flatten(): Wrong or empty subarray";if(!dest)var dest=new Float32Array(len*len0);for(var i=0;i<len;i++)for(var j=0;j<len0;j++)dest[i*len0+j]=array[i][j];return dest};exports.vectorize=function(array,dest){if(!dest)var dest=[];for(var i=0;i<array.length;i+=3){var v3=new Float32Array([array[i],
array[i+1],array[i+2]]);dest[i/3]=v3}return dest};exports.binary_search_max=function(arr,max,start,end){if(end<start)return start;var mid=start+Math.floor((end-start)/2);if(arr[mid]>max)return exports.binary_search_max(arr,max,start,mid-1);else if(arr[mid]<max)return exports.binary_search_max(arr,max,mid+1,end);else return mid};exports.cmp_arr=function(arr_1,arr_2){for(var i=0;i<arr_1.length;i++)if(arr_1[i]!=arr_2[i])return false;return true};exports.cmp_arr_float=function(arr_1,arr_2,precision){for(var i=
0;i<arr_1.length;i++)if(Math.abs(arr_1[i]-arr_2[i])>precision)return false;return true};exports.scale_mat4=function(matrix,scale,dest){if(!dest)var dest=new Float32Array(16);for(var i=0;i<12;i++)dest[i]=matrix[i]*scale;dest[12]=matrix[12];dest[13]=matrix[13];dest[14]=matrix[14];dest[15]=matrix[15];return dest};exports.transform_mat4=function(matrix,scale,quat,trans,dest){if(!dest)var dest=new Float32Array(16);var m=m_mat4.fromRotationTranslation(quat,trans,_mat4_tmp);m_mat4.multiply(m,matrix,dest);
return dest};exports.transform_vec3=function(vec,scale,quat,trans,dest){if(!dest)var dest=new Float32Array(3);var m1=m_mat4.fromRotationTranslation(quat,trans,_mat4_tmp);if(scale!==1){var m2=m_mat4.identity(_mat4_tmp2);var s=m_vec3.set(scale,scale,scale,_vec3_tmp);m_mat4.scale(m2,s,m2);m_mat4.multiply(m1,m2,m1)}m_vec3.transformMat4(vec,m1,dest);return dest};exports.transform_vec4=function(vec,scale,quat,trans,dest){if(!dest)var dest=new Float32Array(4);var m=m_mat4.fromRotationTranslation(quat,trans,
_mat4_tmp);m_vec4.transformMat4(vec,m,dest);return dest};exports.inverse_transform_vec3=function(vec,scale,quat,trans,dest){if(!dest)var dest=new Float32Array(3);var m=m_mat4.fromRotationTranslation(quat,trans,_mat4_tmp);m_mat4.invert(m,m);m_vec3.transformMat4(vec,m,dest);return dest};exports.transcale_quat_to_matrix=function(trans,quat,dest){if(!dest)var dest=new Float32Array(16);m_mat4.fromRotationTranslation(quat,trans,dest);var scale=trans[3];for(var i=0;i<12;i++)dest[i]*=scale;return dest};exports.matrix_to_transcale_quat=
function(matrix,dest_transcale,dest_quat){exports.matrix_to_trans(matrix,dest_transcale);dest_transcale[3]=exports.matrix_to_scale(matrix);exports.matrix_to_quat(matrix,dest_quat)};exports.array_stringify=function(array){var out=[];for(var i=0;i<array.length;i++)out.push(array[i]);return JSON.stringify(out)};exports.rotate_point_pivot=function(point,pivot,quat,dest){if(!dest)var dest=new Float32Array(3);var point_rel=_vec3_tmp;m_vec3.subtract(pivot,point,point_rel);m_vec3.transformQuat(point_rel,
quat,point_rel);m_vec3.subtract(pivot,point_rel,dest)};exports.generate_cubemap_matrices=function(){var eye_pos=_vec3_tmp;eye_pos[0]=0;eye_pos[1]=0;eye_pos[2]=0;var x_pos=new Float32Array(16);var x_neg=new Float32Array(16);var y_pos=new Float32Array(16);var y_neg=new Float32Array(16);var z_pos=new Float32Array(16);var z_neg=new Float32Array(16);m_mat4.lookAt(eye_pos,[-1,0,0],[0,-1,0],x_pos);m_mat4.scale(x_pos,[-1,1,1],x_pos);m_mat4.scale(x_pos,[-1,1,-1],x_neg);m_mat4.lookAt(eye_pos,[0,-1,0],[0,0,
-1],y_pos);m_mat4.scale(y_pos,[1,1,-1],y_pos);m_mat4.scale(y_pos,[1,-1,-1],y_neg);m_mat4.lookAt(eye_pos,[0,0,-1],[0,-1,0],z_pos);m_mat4.scale(z_pos,[-1,1,1],z_pos);m_mat4.scale(z_pos,[-1,1,-1],z_neg);return[x_pos,x_neg,y_pos,y_neg,z_pos,z_neg]};exports.generate_inv_cubemap_matrices=function(){var eye_pos=_vec3_tmp;eye_pos[0]=0;eye_pos[1]=0;eye_pos[2]=0;var x_pos=new Float32Array(16);var x_neg=new Float32Array(16);var y_pos=new Float32Array(16);var y_neg=new Float32Array(16);var z_pos=new Float32Array(16);
var z_neg=new Float32Array(16);m_mat4.lookAt(eye_pos,[1,0,0],[0,-1,0],x_pos);m_mat4.scale(x_pos,[-1,1,-1],x_neg);m_mat4.lookAt(eye_pos,[0,1,0],[0,0,1],y_pos);m_mat4.scale(y_pos,[1,-1,-1],y_neg);m_mat4.lookAt(eye_pos,[0,0,1],[0,-1,0],z_pos);m_mat4.scale(z_pos,[-1,1,-1],z_neg);return[x_pos,x_neg,y_pos,y_neg,z_pos,z_neg]};exports.calc_variable_id=function(a,init_val){return hash_code(a,init_val)};exports.hash_code=hash_code;function hash_code(a,init_val){var hash=init_val;switch(typeof a){case "number":return hash_code_number(a,
hash);case "string":return hash_code_string(a,hash);case "boolean":return hash_code_number(a|0,hash);case "function":case "undefined":return hash_code_number(0,hash);case "object":if(a){var is_arr=a instanceof Array;var is_typed_arr=a.buffer instanceof ArrayBuffer&&a.byteLength!=="undefined";if(is_typed_arr)for(var i=0;i<a.length;i++)hash=hash_code_number(a[i],hash);else if(is_arr)for(var i=0;i<a.length;i++)hash=hash_code(a[i],hash);else for(var prop in a)hash=hash_code(a[prop],hash)}else hash=hash_code_number(0,
hash);return hash}return hash}function hash_code_number(num,init_val){var hash=init_val;_hash_buffer_in[0]=num;hash=(hash<<5)-hash+_hash_buffer_out[0];hash=hash&hash;hash=(hash<<5)-hash+_hash_buffer_out[1];hash=hash&hash;return hash}exports.hash_code_string=hash_code_string;function hash_code_string(str,init_val){var hash=init_val;for(var i=0;i<str.length;i++){var symbol=str.charCodeAt(i);hash=(hash<<5)-hash+symbol;hash=hash&hash}return hash}exports.mat4_translate=function(mat,vec,dest){var x=vec[0],
y=vec[1],z=vec[2],a00,a01,a02,a03,a10,a11,a12,a13,a20,a21,a22,a23;if(!dest||mat===dest){mat[12]=mat[0]*x+mat[4]*y+mat[8]*z+mat[12];mat[13]=mat[1]*x+mat[5]*y+mat[9]*z+mat[13];mat[14]=mat[2]*x+mat[6]*y+mat[10]*z+mat[14];mat[15]=mat[3]*x+mat[7]*y+mat[11]*z+mat[15];return mat}a00=mat[0];a01=mat[1];a02=mat[2];a03=mat[3];a10=mat[4];a11=mat[5];a12=mat[6];a13=mat[7];a20=mat[8];a21=mat[9];a22=mat[10];a23=mat[11];dest[0]=a00;dest[1]=a01;dest[2]=a02;dest[3]=a03;dest[4]=a10;dest[5]=a11;dest[6]=a12;dest[7]=a13;
dest[8]=a20;dest[9]=a21;dest[10]=a22;dest[11]=a23;dest[12]=a00*x+a10*y+a20*z+mat[12];dest[13]=a01*x+a11*y+a21*z+mat[13];dest[14]=a02*x+a12*y+a22*z+mat[14];dest[15]=a03*x+a13*y+a23*z+mat[15];return dest};exports.mat3_to_mat4=function(mat,dest){dest[15]=1;dest[14]=0;dest[13]=0;dest[12]=0;dest[11]=0;dest[10]=mat[8];dest[9]=mat[7];dest[8]=mat[6];dest[7]=0;dest[6]=mat[5];dest[5]=mat[4];dest[4]=mat[3];dest[3]=0;dest[2]=mat[2];dest[1]=mat[1];dest[0]=mat[0];return dest};exports.quat_to_angle_axis=function(src,
dest){if(!dest)dest=src;var sqrlen=src[0]*src[0]+src[1]*src[1]+src[2]*src[2];if(sqrlen>0){dest[3]=2*Math.acos(src[3]);var invlen=1/Math.sqrt(sqrlen);dest[0]=src[0]*invlen;dest[1]=src[1]*invlen;dest[2]=src[2]*invlen}else{dest[3]=0;dest[0]=1;dest[1]=0;dest[2]=0}return dest};function permute3(x){x=(34*x+1)*x;return x%289}function fract(x){return x-Math.floor(x)}exports.trunc=function(x){return isNaN(x)||typeof x=="undefined"?NaN:x|0};exports.rad=function(x){return x*Math.PI/180};exports.deg=function(x){return x*
180/Math.PI};exports.snoise=function(p){var C_x=.211324865405187;var C_y=.366025403784439;var C_z=-.577350269189626;var C_w=.024390243902439;var v_dot_Cyy=p[0]*C_y+p[1]*C_y;var i_x=Math.floor(p[0]+v_dot_Cyy);var i_y=Math.floor(p[1]+v_dot_Cyy);var i_dot_Cxx=i_x*C_x+i_y*C_x;var x0_x=p[0]-i_x+i_dot_Cxx;var x0_y=p[1]-i_y+i_dot_Cxx;var i1_x=x0_x>x0_y?1:0;var i1_y=1-i1_x;var x12_x=x0_x+C_x-i1_x;var x12_y=x0_y+C_x-i1_y;var x12_z=x0_x+C_z;var x12_w=x0_y+C_z;i_x%=289;i_y%=289;var p_x=permute3(permute3(i_y)+
i_x);var p_y=permute3(permute3(i_y+i1_y)+i_x+i1_x);var p_z=permute3(permute3(i_y+1)+i_x+1);var m_x=Math.max(.5-(x0_x*x0_x+x0_y*x0_y),0);var m_y=Math.max(.5-(x12_x*x12_x+x12_y*x12_y),0);var m_z=Math.max(.5-(x12_z*x12_z+x12_w*x12_w),0);m_x*=m_x*m_x*m_x;m_y*=m_y*m_y*m_y;m_z*=m_z*m_z*m_z;var x_x=2*fract(p_x*C_w)-1;var x_y=2*fract(p_y*C_w)-1;var x_z=2*fract(p_z*C_w)-1;var h_x=Math.abs(x_x)-.5;var h_y=Math.abs(x_y)-.5;var h_z=Math.abs(x_z)-.5;var ox_x=Math.floor(x_x+.5);var ox_y=Math.floor(x_y+.5);var ox_z=
Math.floor(x_z+.5);var a0_x=x_x-ox_x;var a0_y=x_y-ox_y;var a0_z=x_z-ox_z;m_x*=1.79284291400159-.85373472095314*(a0_x*a0_x+h_x*h_x);m_y*=1.79284291400159-.85373472095314*(a0_y*a0_y+h_y*h_y);m_z*=1.79284291400159-.85373472095314*(a0_z*a0_z+h_z*h_z);var g_x=a0_x*x0_x+h_x*x0_y;var g_y=a0_y*x12_x+h_y*x12_y;var g_z=a0_z*x12_z+h_z*x12_w;var m_dot_g=m_x*g_x+m_y*g_y+m_z*g_z;return 130*m_dot_g};function permute(x){return mod289((34*x+5)*x)}function mod289(x){return x-Math.floor(x/289)*289}function mod7(x){return x-
Math.floor(x/7)*7}exports.cellular2x2=function(P){var K=1/7;var K2=K/2;var JITTER=.7;var Pi_x=mod289(Math.floor(P[0]));var Pi_y=mod289(Math.floor(P[1]));var Pf_x=fract(P[0]);var Pf_y=fract(P[1]);var Pfx_x=Pf_x-.5;var Pfx_y=Pf_x-1.5;var Pfx_z=Pfx_x;var Pfx_w=Pfx_y;var Pfy_x=Pf_y-.5;var Pfy_y=Pfy_x;var Pfy_z=Pf_y-1.5;var Pfy_w=Pfy_z;var p_x=permute(Pi_x);var p_y=permute(Pi_x+1);var p_z=p_x;var p_w=p_y;p_x=permute(p_x+Pi_y);p_y=permute(p_y+Pi_y);p_z=permute(p_z+Pi_y+1);p_w=permute(p_w+Pi_y+1);var ox_x=
mod7(p_x)*K+K2;var ox_y=mod7(p_y)*K+K2;var ox_z=mod7(p_z)*K+K2;var ox_w=mod7(p_w)*K+K2;var oy_x=mod7(Math.floor(p_x*K))*K+K2;var oy_y=mod7(Math.floor(p_y*K))*K+K2;var oy_z=mod7(Math.floor(p_z*K))*K+K2;var oy_w=mod7(Math.floor(p_w*K))*K+K2;var dx_x=Pfx_x+JITTER*ox_x;var dx_y=Pfx_y+JITTER*ox_y;var dx_z=Pfx_z+JITTER*ox_z;var dx_w=Pfx_w+JITTER*ox_w;var dy_x=Pfy_x+JITTER*oy_x;var dy_y=Pfy_y+JITTER*oy_y;var dy_z=Pfy_z+JITTER*oy_z;var dy_w=Pfy_w+JITTER*oy_w;var d_x=dx_x*dx_x+dy_x*dy_x;var d_y=dx_y*dx_y+
dy_y*dy_y;var d_z=dx_z*dx_z+dy_z*dy_z;var d_w=dx_w*dx_w+dy_w*dy_w;var d=Math.min(d_x,d_y,d_z,d_w);return d};exports.quat_project=function(quat,quat_ident_dir,plane,plane_ident_dir,dest){if(!dest)var dest=new Float32Array(4);var to=m_vec3.transformQuat(quat_ident_dir,quat,_vec3_tmp);var a=plane[0];var b=plane[1];var c=plane[2];var proj=_mat3_tmp;proj[0]=b*b+c*c;proj[1]=-b*a;proj[2]=-c*a;proj[3]=-a*b;proj[4]=a*a+c*c;proj[5]=-c*b;proj[6]=-a*c;proj[7]=-b*c;proj[8]=a*a+b*b;m_vec3.transformMat3(to,proj,
to);m_vec3.normalize(to,to);m_quat.rotationTo(plane_ident_dir,to,dest);return dest};exports.cam_quat_to_mesh_quat=function(cam_quat,dest){if(!dest)var dest=new Float32Array(4);var quat_offset=_vec4_tmp;var quat_offset_x=_vec4_tmp2;quat_offset=m_quat.setAxisAngle([0,1,0],Math.PI,m_quat.create());quat_offset_x=m_quat.setAxisAngle([1,0,0],Math.PI/2,m_quat.create());m_quat.multiply(quat_offset,quat_offset_x,quat_offset);m_quat.multiply(cam_quat,quat_offset,dest);return dest};exports.cleanup=function(){_unique_counter=
0;_unique_name_counters={}};exports.clamp=function(value,min,max){return Math.min(Math.max(value,min),max)};exports.smooth=function(curr,last,delta,period){var e=Math.exp(-delta/period);return(1-e)*curr+e*last};exports.smooth_v=function(curr,last,delta,period,dest){if(!dest)dest=new Float32Array(curr.length);var e=Math.exp(-delta/period);for(var i=0;i<dest.length;i++)dest[i]=(1-e)*curr[i]+e*last[i];return dest};exports.smooth_q=function(curr,last,delta,period,dest){if(!dest)dest=new Float32Array(curr.length);
var e=Math.exp(-delta/period);m_quat.slerp(curr,last,e,dest);return dest};exports.is_arr_buf_view=function(o){if(typeof o==="object"&&o.buffer&&o.buffer instanceof ArrayBuffer)return true;else return false};exports.is_vector=function(o,dimension){if(o instanceof Array||o.buffer&&o.buffer instanceof ArrayBuffer)if(dimension&&dimension==o.length)return true;else if(dimension)return false;else return true;return false};exports.correct_cam_quat_up=function(quat,up_only){var rmat=m_mat3.fromQuat(quat,
_mat3_tmp);var y_world=_vec3_tmp2;y_world[0]=0;y_world[1]=1;y_world[2]=0;var y_cam_world=_vec3_tmp;y_cam_world[0]=rmat[3];y_cam_world[1]=rmat[4];y_cam_world[2]=rmat[5];var x_cam_world_new=m_vec3.cross(y_world,y_cam_world,y_cam_world);m_vec3.normalize(x_cam_world_new,x_cam_world_new);var z_cam_world_y=rmat[7];if(!up_only&&z_cam_world_y>0){x_cam_world_new[0]*=-1;x_cam_world_new[1]*=-1;x_cam_world_new[2]*=-1}var x_cam_world=_vec3_tmp2;x_cam_world[0]=rmat[0];x_cam_world[1]=rmat[1];x_cam_world[2]=rmat[2];
m_vec3.normalize(x_cam_world,x_cam_world);var correct_quat=_vec4_tmp2;m_quat.rotationTo(x_cam_world,x_cam_world_new,correct_quat);m_quat.multiply(correct_quat,quat,quat)};exports.get_array_smooth_value=function(array,row_width,x,y){var px=x*row_width-.5;var py=y*row_width-.5;var fract_px=px-Math.floor(px);var fract_py=py-Math.floor(py);px=Math.floor(px);py=Math.floor(py);var up_lim=row_width-1;var val_00=array[py*row_width+px];var val_10=array[py*row_width+Math.min(px+1,up_lim)];var val_01=array[Math.min(py+
1,up_lim)*row_width+px];var val_11=array[Math.min(py+1,up_lim)*row_width+Math.min(px+1,up_lim)];var val_0010=val_00*(1-fract_px)+val_10*fract_px;var val_0111=val_01*(1-fract_px)+val_11*fract_px;var smooth_value=val_0010*(1-fract_py)+val_0111*fract_py;return smooth_value};exports.rgb_mask_get_channels_count=function(mask){var count=0;for(var i=0;i<3;i++)if((mask&1<<i)>0)count++;return count};exports.rgb_mask_get_channels_presence=rgb_mask_get_channels_presence;function rgb_mask_get_channels_presence(mask){var presence=
[0,0,0];for(var i=0;i<3;i++)if((mask&1<<i)>0)presence[2-i]=1;return presence}exports.rgb_mask_get_channel_presence_index=function(mask,channel){var index=0;if(channel==1||channel==2)if((mask&1<<2)>0)index++;if(channel==2)if((mask&1<<1)>0)index++;return index};exports.gen_uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:r&3|8;return v.toString(16)})};exports.get_dict_length=function(dict){var count=0;for(var prop in dict)if(dict.hasOwnProperty(prop))count++;
return count};exports.random_from_array=function(array){if(!array.length)return null;var pos=Math.floor(Math.random()*array.length);return array[pos]};exports.xz_direction=function(a,b,dest){if(!dest)dest=new Float32Array(3);dest[0]=a[0]-b[0];dest[1]=0;dest[2]=a[2]-b[2];m_vec3.normalize(dest,dest)};exports.transformQuatFast=function(a,q,out){var ax=a[0],ay=a[1],az=a[2];var qx=q[0],qy=q[1],qz=q[2],qw=q[3];var uvx=qy*az-qz*ay,uvy=qz*ax-qx*az,uvz=qx*ay-qy*ax;var uuvx=qy*uvz-qz*uvy,uuvy=qz*uvx-qx*uvz,
uuvz=qx*uvy-qy*uvx;uvx*=qw*2;uvy*=qw*2;uvz*=qw*2;uuvx*=2;uuvy*=2;uuvz*=2;out[0]=ax+uvx+uuvx;out[1]=ay+uvy+uuvy;out[2]=az+uvz+uuvz;return out};exports.assert=function(cond){if(!cond)throw new Error("Assertion failed");};exports.panic=function(s){if(s)m_print.error.apply(m_print,arguments);throw"panic: see above for possible error messages";};exports.angle_wrap_periodic=angle_wrap_periodic;function angle_wrap_periodic(angle,from,to){var rel_angle=angle-from;var period=to-from;return from+(rel_angle-
Math.floor(rel_angle/period)*period)}exports.angle_wrap_0_2pi=angle_wrap_0_2pi;function angle_wrap_0_2pi(angle){return angle_wrap_periodic(angle,0,2*Math.PI)}exports.get_file_extension=function(file_path){var re=/(?:\.([^.]+))?$/;return re.exec(file_path)[1]};exports.strict_objs_is_equal=strict_objs_is_equal;function strict_objs_is_equal(a,b){for(var prop in a){var props_is_equal=true;var val1=a[prop];var val2=b[prop];switch(typeof val1){case "number":case "string":case "boolean":props_is_equal=val1==
val2;break;case "object":props_is_equal=objs_is_equal(val1,val2);break;default:break}if(!props_is_equal)return false}return true}function objs_is_equal(a,b){if(a&&b){var a_is_arr=a instanceof Array;var a_is_typed_arr=a.buffer instanceof ArrayBuffer&&a.byteLength!=="undefined";var b_is_arr=b instanceof Array;var b_is_typed_arr=b.buffer instanceof ArrayBuffer&&b.byteLength!=="undefined";if(a_is_arr!=b_is_arr||a_is_typed_arr!=b_is_typed_arr)return false;if(a_is_arr){if(a.length!=b.length)return false;
for(var i=0;i<a.length;i++)if(!vars_is_equal(a[i],b[i]))return false}else if(a_is_typed_arr){if(a.length!=b.length)return false;for(var i=0;i<a.length;i++)if(a[i]!=b[i])return false}else{for(var prop in a)if(!vars_is_equal(a[prop],b[prop]))return false;for(var prop in b)if(!(prop in a))return false}return true}else return!(a||b)}function vars_is_equal(a,b){if(typeof a!=typeof b)return false;switch(typeof a){case "number":case "string":case "boolean":return a==b;case "object":return objs_is_equal(a,
b);default:return true}}exports.quat_bpy_b4w=function(quat,dest){var w=quat[0];var x=quat[1];var y=quat[2];var z=quat[3];dest[0]=x;dest[1]=y;dest[2]=z;dest[3]=w;return dest};exports.gen_color_id=function(counter){var counter=counter+1;if(counter>51*51*51)m_print.error("Color ID pool depleted");var r=Math.floor(counter/(51*51));counter%=51*51;var g=Math.floor(counter/51);counter%=51;var b=counter;var color_id=new Float32Array([r/51,g/51,b/51]);return color_id};exports.line_plane_intersect=function(pn,
p_dist,lp,l_dir,dest){var plane=_vec4_tmp;plane.set(pn);plane[3]=p_dist;var line_dir=_vec4_tmp2;line_dir.set(l_dir);line_dir[3]=0;var denominator=m_vec4.dot(plane,line_dir);if(denominator==0)return null;var line_point=_vec4_tmp2;line_point.set(lp);line_point[3]=1;var numerator=m_vec4.dot(plane,line_point);var t=-numerator/denominator;dest[0]=lp[0]+t*l_dir[0];dest[1]=lp[1]+t*l_dir[1];dest[2]=lp[2]+t*l_dir[2];return dest};exports.get_plane_normal=function(a,b,c,dest){var a12=b[0]-a[0];var a13=c[0]-
a[0];var a22=b[1]-a[1];var a23=c[1]-a[1];var a32=b[2]-a[2];var a33=c[2]-a[2];dest[0]=a22*a33-a32*a23;dest[1]=a13*a32-a12*a33;dest[2]=a12*a23-a22*a13;return dest};exports.copy_array=function(a,out){for(var i=0;i<a.length;i++)out[i]=a[i];return out};exports.rotation_to_stable=function(a,b,out){var tmp=_vec3_tmp;var dot=m_vec3.dot(a,b);if(dot<-.9999999){m_vec3.cross(AXIS_X,a,tmp);if(m_vec3.length(tmp)<1E-6)m_vec3.cross(AXIS_Y,a,tmp);m_vec3.normalize(tmp,tmp);m_quat.setAxisAngle(tmp,Math.PI,out)}else{m_vec3.cross(a,
b,tmp);out.set(tmp);out[3]=1+dot;m_quat.normalize(out,out)}return out};exports.calc_returning_angle=function(angle,min_angle,max_angle){if(min_angle==max_angle)return max_angle-angle;angle=angle_wrap_0_2pi(angle);min_angle=angle_wrap_0_2pi(min_angle);max_angle=angle_wrap_0_2pi(max_angle);var delta=Math.abs(min_angle-max_angle);if(delta<MIN_CLAMPING_INTERVAL||Math.abs(delta-2*Math.PI)<MIN_CLAMPING_INTERVAL)return 0;var rotation=2*Math.PI-min_angle;min_angle=0;max_angle+=rotation;max_angle=angle_wrap_0_2pi(max_angle);
angle+=rotation;angle=angle_wrap_0_2pi(angle);if(angle>max_angle){var delta_to_max=max_angle-angle;var delta_to_min=2*Math.PI-angle;return-delta_to_max>delta_to_min?delta_to_min:delta_to_max}return 0};exports.smooth_step=function(t,min,max){if(isFinite(min)&&isFinite(max))t=clamp(t,min,max);return t*t*(3-2*t)};exports.lerp=function(t,from,to){return from+t*(to-from)};exports.arrays_have_common=function(arr_1,arr_2){for(var i=0;i<arr_1.length;i++)for(var k=0;k<arr_2.length;k++)if(arr_2[k]==arr_1[i])return true;
return false};exports.create_zero_array=function(length){var array=new Array(length);for(var i=0;i<length;i++)array[i]=0;return array};exports.version_cmp=function(ver1,ver2){var max_len=Math.max(ver1.length,ver2.length);for(var i=0;i<max_len;i++){var n1=i>=ver1.length?0:ver1[i];var n2=i>=ver2.length?0:ver2[i];var s=sign(n1-n2);if(s)return s}return 0};exports.version_to_str=function(ver){return ver.join(".")};exports.str_to_version=function(str){return str.split(".").map(function(val){return val|
0})};exports.srgb_to_lin=function(color,dest){dest[0]=Math.pow(color[0],GAMMA);dest[1]=Math.pow(color[1],GAMMA);dest[2]=Math.pow(color[2],GAMMA);return dest};exports.lin_to_srgb=function(color,dest){dest[0]=Math.pow(color[0],1/GAMMA);dest[1]=Math.pow(color[1],1/GAMMA);dest[2]=Math.pow(color[2],1/GAMMA);return dest};exports.normpath_preserve_protocol=function(dir_path){var separated_str=dir_path.split("://",2);if(separated_str.length>1){separated_str[1]=normpath(separated_str[1]);return separated_str.join("://")}else return normpath(dir_path)};
function normpath(path){var sep="/";var empty="";var dot=".";var dotdot="..";if(path==empty)return dot;var initial_slashes=path.indexOf(sep)==0|0;if(initial_slashes&&path.indexOf(sep+sep)==0&&path.indexOf(sep+sep+sep)!=0)initial_slashes=2;var comps=path.split(sep);var new_comps=[];for(var i=0;i<comps.length;i++){var comp=comps[i];if(comp==empty||comp==dot)continue;if(comp!=dotdot||!initial_slashes&&!new_comps.length||new_comps.length&&new_comps[new_comps.length-1]==dotdot)new_comps.push(comp);else if(new_comps.length)new_comps.pop()}comps=
new_comps;path=comps.join(sep);for(var i=0;i<initial_slashes;i++)path=sep+path;return path||dot}};b4w.module["__sfx"]=function(exports,require){var m_cfg=require("__config");var m_print=require("__print");var m_time=require("__time");var m_util=require("__util");var m_vec3=require("__vec3");var cfg_ani=m_cfg.animation;var cfg_def=m_cfg.defaults;var cfg_sfx=m_cfg.sfx;var SPEED_SMOOTH_PERIOD=.3;var SPKSTATE_UNDEFINED=10;var SPKSTATE_PLAY=20;var SPKSTATE_STOP=30;var SPKSTATE_PAUSE=40;var SCHED_PARAM_LOOPS=5;var SCHED_PARAM_ANTICIPATE_TIME=3;exports.AST_NONE=10;exports.AST_ARRAY_BUFFER=20;exports.AST_HTML_ELEMENT=
30;var _vec3_tmp=new Float32Array(3);var _vec3_tmp2=new Float32Array(3);var _vec3_tmp3=new Float32Array(3);var _supported_audio=[];var _supported_video=[];var _wa=null;var _active_scene=null;var _speaker_objects=[];var _seed_tmp=[1];var _playlist=null;exports.create_sfx=function(){var sfx={behavior:"NONE",disable_doppler:false,muted:false,volume:1,pitch:1,attenuation:1,dist_ref:1,dist_max:1E4,cone_angle_inner:360,cone_angle_outer:360,cone_volume_outer:1,cyclic:false,loop:false,delay:0,delay_random:0,
volume_random:0,pitch_random:0,fade_in:0,fade_out:0,start_time:0,pause_time:0,buf_offset:0,duration:0,vp_rand_end_time:0,base_seed:1,src:null,state:SPKSTATE_UNDEFINED,last_position:new Float32Array(3),direction:new Float32Array(3),speed_avg:new Float32Array(3),bgm_start_timeout:-1,bgm_stop_timeout:-1,duck_time:0};return sfx};exports.init=function(){var audio=document.createElement("audio");var video=document.createElement("video");if(audio.canPlayType){if(audio.canPlayType("audio/ogg")!=""){_supported_audio.push("ogg");
_supported_audio.push("ogv")}if(audio.canPlayType("audio/mpeg")!="")_supported_audio.push("mp3");if(audio.canPlayType("audio/mp4")!=""){_supported_audio.push("mp4");_supported_audio.push("m4v")}if(audio.canPlayType("audio/webm")!="")_supported_audio.push("webm")}if(video.canPlayType){if(video.canPlayType("video/ogg")!="")_supported_video.push("ogv");if(video.canPlayType("video/mp4")!="")_supported_video.push("m4v");if(video.canPlayType("video/webm")!="")_supported_video.push("webm")}_wa=cfg_sfx.webaudio?
create_wa_context():null;if(_wa)m_print.log("%cINIT WEBAUDIO: "+_wa.sampleRate+"Hz","color: #00a")};exports.attach_scene_sfx=function(scene){var scene_sfx={listener_last_eye:new Float32Array(3),listener_direction:new Float32Array(3),listener_speed_avg:new Float32Array(3)};scene._sfx=scene_sfx;if(_wa){var gnode=_wa.createGain();var fade_gnode=_wa.createGain();scene_sfx.gain_node=gnode;scene_sfx.fade_gain_node=fade_gnode;gnode.connect(fade_gnode);fade_gnode.connect(_wa.destination);if(scene["b4w_enable_dynamic_compressor"]){var compressor=
_wa.createDynamicsCompressor();var dcs=scene["b4w_dynamic_compressor_settings"];compressor.threshold.value=dcs["threshold"];compressor.knee.value=dcs["knee"];compressor.ratio.value=dcs["ratio"];compressor.attack.value=dcs["attack"];compressor.release.value=dcs["release"];compressor.connect(gnode);scene_sfx.compressor_node=compressor;scene_sfx.proc_chain_in=compressor}else{scene_sfx.compressor_node=null;scene_sfx.proc_chain_in=gnode}var listener=_wa.listener;scene_sfx.disable_doppler=cfg_def.disable_doppler_hack;
if(!scene_sfx.disable_doppler){listener.dopplerFactor=scene["audio_doppler_factor"];listener.speedOfSound=scene["audio_doppler_speed"]}scene_sfx.muted=false;scene_sfx.volume=1;scene_sfx.duck_time=0}};function create_wa_context(){var AudioContext=window.AudioContext||window.webkitAudioContext;if(AudioContext){var ctx=new AudioContext;if(ctx.createGain)return ctx;else{m_print.warn("deprecated WebAudio implementation");return null}}else{m_print.warn("WebAudio is not supported");return null}}exports.set_active_scene=
function(scene){_active_scene=scene};exports.detect_audio_container=function(hint){if(!hint)var hint="ogg";if(_supported_audio.indexOf(hint)>-1)return hint;else if(hint=="ogg"&&_supported_audio.indexOf("mp4")>-1)return"mp4";else if(hint=="mp3"&&_supported_audio.indexOf("ogg")>-1)return"ogg";else if(hint=="mp4"&&_supported_audio.indexOf("ogg")>-1)return"ogg";else if(hint=="ogv"&&_supported_audio.indexOf("m4v")>-1)return"m4v";else if(hint=="webm"&&_supported_audio.indexOf("m4v")>-1)return"m4v";else if(hint==
"m4v"&&_supported_audio.indexOf("webm")>-1)return"webm";else return""};exports.detect_video_container=function(hint){if(!hint)var hint="webm";if(_supported_video.indexOf(hint)>-1)return hint;else if(hint=="ogv"&&_supported_video.indexOf("m4v")>-1)return"m4v";else if(hint=="webm"&&_supported_video.indexOf("m4v")>-1)return"m4v";else if(hint=="m4v"&&_supported_video.indexOf("webm")>-1)return"webm";else return""};exports.update_object=function(bpy_obj,obj){if(obj.type!="SPEAKER")throw"Wrong speaker object";
var speaker=bpy_obj["data"];var sfx=obj.sfx;switch(speaker["b4w_behavior"]){case "POSITIONAL":case "BACKGROUND_SOUND":sfx.behavior=_wa?speaker["b4w_behavior"]:"NONE";break;case "BACKGROUND_MUSIC":sfx.behavior=_wa?check_media_element_node()?"BACKGROUND_MUSIC":"BACKGROUND_SOUND":"NONE";break;default:throw"Wrong speaker behavior";break}if(!speaker["sound"])sfx.behavior="NONE";sfx.disable_doppler=speaker["b4w_disable_doppler"]||cfg_def.disable_doppler_hack;sfx.muted=speaker["muted"];sfx.volume=speaker["volume"];
sfx.pitch=speaker["pitch"];sfx.attenuation=speaker["attenuation"];sfx.dist_ref=speaker["distance_reference"];sfx.dist_max=speaker["distance_max"]||1E4;sfx.cone_angle_inner=speaker["cone_angle_inner"];sfx.cone_angle_outer=speaker["cone_angle_outer"];sfx.cone_volume_outer=speaker["cone_volume_outer"];sfx.cyclic=speaker["b4w_cyclic_play"];sfx.loop=speaker["b4w_loop"];sfx.delay=speaker["b4w_delay"];sfx.delay_random=speaker["b4w_delay_random"];sfx.volume_random=speaker["b4w_volume_random"];sfx.pitch_random=
speaker["b4w_pitch_random"];sfx.fade_in=speaker["b4w_fade_in"];sfx.fade_out=speaker["b4w_fade_out"];_speaker_objects.push(obj)};function check_media_element_node(){if(window.MediaElementAudioSourceNode)return true;else{m_print.warn("MediaElementAudioSourceNode not found");return false}}exports.source_type=function(obj){if(obj.type!="SPEAKER")throw"Wrong object type";switch(obj.sfx.behavior){case "POSITIONAL":return exports.AST_ARRAY_BUFFER;case "BACKGROUND_SOUND":return exports.AST_ARRAY_BUFFER;case "BACKGROUND_MUSIC":return exports.AST_HTML_ELEMENT;
case "NONE":return exports.AST_NONE;default:throw"Wrong speaker behavior";}};exports.update_spkobj=function(obj,sound_data){var sfx=obj.sfx;switch(sfx.behavior){case "POSITIONAL":case "BACKGROUND_SOUND":case "BACKGROUND_MUSIC":sfx.src=sound_data;break;case "NONE":break;default:throw"Wrong speaker behavior";}};exports.play_empty_sound=function(){var source=_wa.createBufferSource();source.buffer=_wa.createBuffer(1,22050,22050);source.connect(_wa.destination);source.start(0)};exports.decode_audio_data=
function(arr_buf,decode_cb,fail_cb){if(_wa)_wa.decodeAudioData(arr_buf,decode_cb,fail_cb);else fail_cb()};exports.speaker_remove=function(obj){stop(obj);obj.sfx=null;_speaker_objects.splice(_speaker_objects.indexOf(obj),1)};exports.cleanup=function(){for(var i=0;i<_speaker_objects.length;i++){var obj=_speaker_objects[i];var sfx=obj.sfx;if(sfx.behavior=="BACKGROUND_MUSIC"){var audio_el=sfx.src;if(audio_el)audio_el.pause()}else if(sfx.source_node)sfx.source_node.disconnect()}if(_active_scene&&_active_scene._sfx){var scene_sfx=
_active_scene._sfx;scene_sfx.listener_last_eye[0]=0;scene_sfx.listener_last_eye[1]=0;scene_sfx.listener_last_eye[2]=0;scene_sfx.listener_speed_avg[0]=0;scene_sfx.listener_speed_avg[1]=0;scene_sfx.listener_speed_avg[2]=0}_active_scene=null;_speaker_objects.splice(0);_playlist=null};exports.update=function(timeline,elapsed){if(!_wa||_speaker_objects.length==0)return;for(var i=0;i<_speaker_objects.length;i++){var obj=_speaker_objects[i];var sfx=obj.sfx;var curr_time=_wa.currentTime;if(_wa&&!sfx.loop&&
sfx.cyclic&&sfx.state==SPKSTATE_PLAY&&sfx.duration&&sfx.start_time+sfx.duration<curr_time)play_def(obj);if(sfx.state==SPKSTATE_PLAY&&sfx.vp_rand_end_time-curr_time<SCHED_PARAM_ANTICIPATE_TIME)schedule_volume_pitch_random(sfx)}if(_playlist&&_playlist.speakers.length&&(_playlist.active==-1||timeline>_playlist.active_start_time+_playlist.durations[_playlist.active]))playlist_switch_next(_playlist,timeline)};function playlist_switch_next(playlist,timeline){if(playlist.active>-1)stop(playlist.speakers[playlist.active]);
if(playlist.active==-1&&playlist.random)var next=Math.round(Math.random()*(playlist.speakers.length-1));else if(playlist.random){var advance=1+Math.round(Math.random()*(playlist.speakers.length-2));var next=(playlist.active+advance)%playlist.speakers.length}else var next=(playlist.active+1)%playlist.speakers.length;play_def(playlist.speakers[next]);playlist.active=next;playlist.active_start_time=timeline}exports.play=play;function play(obj,when,duration){var sfx=obj.sfx;if(sfx.behavior=="NONE")return;
if(!duration)var duration=0;var loop=sfx.loop;var playrate=sfx.pitch;if(!(sfx.src&&(loop||duration>=0)))return;sfx.base_seed=Math.floor(5E4*Math.random());var start_time=_wa.currentTime+when;sfx.start_time=start_time;sfx.state=SPKSTATE_PLAY;update_proc_chain(obj);if(sfx.behavior=="POSITIONAL"||sfx.behavior=="BACKGROUND_SOUND"){var source=_wa.createBufferSource();source.buffer=sfx.src;source.playbackRate.value=playrate;if(loop){if(sfx.source_node)sfx.source_node.disconnect();source.loop=true;source.start(start_time);
sfx.duration=0}else{var buf_dur=source.buffer?source.buffer.duration:0;if(duration>buf_dur){var to=start_time+duration+sfx.fade_out;source.loop=true;source.start(start_time);source.stop(to);sfx.duration=duration}else{source.loop=false;source.start(start_time);sfx.duration=buf_dur}}source.connect(sfx.proc_chain_in);sfx.source_node=source;reset_volume_pitch_random(sfx);schedule_volume_pitch_random(sfx)}else if(sfx.behavior=="BACKGROUND_MUSIC"){m_time.clear_timeout(sfx.bgm_start_timeout);m_time.clear_timeout(sfx.bgm_stop_timeout);
var start_cb=function(){fire_audio_element(obj)};if(when==0)start_cb();else sfx.bgm_start_timeout=m_time.set_timeout(start_cb,when*1E3);if(loop)sfx.duration=0;else{var el_dur=get_duration(obj);sfx.duration=el_dur}}schedule_fades(sfx,start_time)}function update_proc_chain(obj){var sfx=obj.sfx;if(sfx.proc_chain_in)return;var pos=obj.render.trans;var quat=obj.render.quat;if(cfg_sfx.mix_mode){var filter_node=_wa.createBiquadFilter();filter_node.type="peaking"}else var filter_node=null;var fade_gnode=
_wa.createGain();switch(sfx.behavior){case "POSITIONAL":var ap=_wa.createPanner();if(typeof ap.panningModel!="string"){ap.panningModel=ap.EQUALPOWER;ap.distanceModel=ap.INVERSE_DISTANCE}else{ap.panningModel="equalpower";ap.distanceModel="inverse"}ap.setPosition(pos[0],pos[1],pos[2]);m_vec3.copy(pos,sfx.last_position);var orient=_vec3_tmp;m_util.quat_to_dir(quat,m_util.AXIS_MY,orient);ap.setOrientation(orient[0],orient[1],orient[2]);m_vec3.copy(orient,sfx.direction);ap.refDistance=sfx.dist_ref;ap.maxDistance=
sfx.dist_max;ap.rolloffFactor=sfx.attenuation;ap.coneInnerAngle=sfx.cone_angle_inner;ap.coneOuterAngle=sfx.cone_angle_outer;ap.coneOuterGain=sfx.cone_volume_outer;var gnode=_wa.createGain();gnode.gain.value=calc_gain(sfx);if(filter_node){ap.connect(filter_node);filter_node.connect(gnode)}else ap.connect(gnode);gnode.connect(fade_gnode);sfx.proc_chain_in=ap;if(sfx.volume_random){var rand_gnode=_wa.createGain();fade_gnode.connect(rand_gnode);rand_gnode.connect(get_scene_dst_node(_active_scene))}else{var rand_gnode=
null;fade_gnode.connect(get_scene_dst_node(_active_scene))}break;case "BACKGROUND_SOUND":var ap=null;var gnode=_wa.createGain();gnode.gain.value=calc_gain(sfx);if(filter_node){sfx.proc_chain_in=filter_node;filter_node.connect(gnode)}else sfx.proc_chain_in=gnode;gnode.connect(fade_gnode);if(sfx.volume_random){var rand_gnode=_wa.createGain();fade_gnode.connect(rand_gnode);rand_gnode.connect(get_scene_dst_node(_active_scene))}else{var rand_gnode=null;fade_gnode.connect(get_scene_dst_node(_active_scene))}break;
case "BACKGROUND_MUSIC":var ap=null;var rand_gnode=null;var gnode=_wa.createGain();gnode.gain.value=calc_gain(sfx);if(filter_node){sfx.proc_chain_in=filter_node;filter_node.connect(gnode)}else sfx.proc_chain_in=gnode;gnode.connect(fade_gnode);fade_gnode.connect(get_scene_dst_node(_active_scene));break}sfx.panner_node=ap;sfx.filter_node=filter_node;sfx.gain_node=gnode;sfx.fade_gain_node=fade_gnode;sfx.rand_gain_node=rand_gnode}exports.play_def=play_def;function play_def(obj){var sfx=obj.sfx;var duration=
sfx.duration;var delay=sfx.delay+sfx.delay_random*Math.random();play(obj,delay,duration)}function get_scene_dst_node(scene){if(_wa)return scene._sfx.proc_chain_in;else return null}function get_gain_node(scene){if(_wa)return scene._sfx.gain_node;else return null}function get_fade_node(scene){if(_wa)return scene._sfx.fade_gain_node;else return null}function reset_volume_pitch_random(sfx){if(sfx.volume_random)sfx.rand_gain_node.gain.cancelScheduledValues(sfx.start_time);if(sfx.pitch_random)sfx.source_node.playbackRate.cancelScheduledValues(sfx.start_time);
sfx.vp_rand_end_time=sfx.start_time}function schedule_volume_pitch_random(sfx){if(!(sfx.volume_random||sfx.pitch_random))return;var rand_gnode=sfx.rand_gain_node;var source=sfx.source_node;var buf_dur=source.buffer?source.buffer.duration:0;if(!buf_dur)return;var time=sfx.start_time;_seed_tmp[0]=sfx.base_seed;for(var cnt=0;cnt<SCHED_PARAM_LOOPS;){var playrate=sfx.pitch+sfx.pitch_random*m_util.rand_r(_seed_tmp);if(time>=sfx.vp_rand_end_time){if(sfx.volume_random){var gain=1-m_util.clamp(sfx.volume_random,
0,1)*Math.random();rand_gnode.gain.setValueAtTime(gain,time)}if(sfx.pitch_random)source.playbackRate.setValueAtTime(playrate,time);cnt++}time+=buf_dur/playrate}sfx.vp_rand_end_time=time-.001}function schedule_fades(sfx,from_time){if(!(sfx.fade_in||sfx.fade_out))return;var fade_gnode=sfx.fade_gain_node;fade_gnode.gain.cancelScheduledValues(from_time);if(sfx.fade_in){fade_gnode.gain.setValueAtTime(0,from_time);fade_gnode.gain.linearRampToValueAtTime(1,from_time+sfx.fade_in)}else fade_gnode.gain.setValueAtTime(1,
from_time);if(sfx.fade_out&&!sfx.loop){var source=sfx.source_node;fade_gnode.gain.setValueAtTime(1,from_time+sfx.duration);fade_gnode.gain.linearRampToValueAtTime(0,from_time+sfx.duration+sfx.fade_out)}}function fire_audio_element(obj){var sfx=obj.sfx;var audio=sfx.src;if(audio){audio.volume=1;audio.loop=sfx.loop;sfx.source_node=sfx.source_node||_wa.createMediaElementSource(audio);sfx.source_node.connect(sfx.proc_chain_in);if(sfx.state==SPKSTATE_PLAY){if(audio.currentTime)audio.currentTime=0;audio.play()}}}
function stop_audio_element(obj){var sfx=obj.sfx;var audio=sfx.src;if(audio){if(audio.currentTime)audio.currentTime=0;audio.pause()}}exports.stop=stop;function stop(sobj){if(sobj.type!="SPEAKER")throw"Wrong object type";var sfx=sobj.sfx;if(sfx.state!=SPKSTATE_PLAY&&sfx.state!=SPKSTATE_PAUSE)return;var fade_gnode=sfx.fade_gain_node;var current_time=_wa.currentTime;if(sfx.fade_out){fade_gnode.gain.setValueAtTime(fade_gnode.gain.value,current_time);fade_gnode.gain.linearRampToValueAtTime(0,current_time+
sfx.fade_out)}if(sfx.behavior=="BACKGROUND_MUSIC"){var audio_el=sfx.src;if(audio_el){var stop_cb=function(){stop_audio_element(sobj)};m_time.clear_timeout(sfx.bgm_start_timeout);m_time.clear_timeout(sfx.bgm_stop_timeout);sfx.bgm_stop_timeout=m_time.set_timeout(stop_cb,sfx.fade_out*1E3)}}else{var source=sfx.source_node;if(sfx.duration<source.buffer.duration)if(sfx.fade_out&&sfx.state==SPKSTATE_PLAY)source.stop(current_time+sfx.fade_out);else{if(sfx.state==SPKSTATE_PLAY){source.stop(0);source.disconnect()}}else source.disconnect();
sfx.start_time=0;sfx.pause_time=0;sfx.buf_offset=0}sfx.state=SPKSTATE_STOP}exports.is_play=is_play;function is_play(obj){return obj.sfx.state==SPKSTATE_PLAY}exports.speaker_pause=speaker_pause;function speaker_pause(obj){var sfx=obj.sfx;if(sfx.state!=SPKSTATE_PLAY)return;var current_time=_wa.currentTime;sfx.pause_time=current_time;if(sfx.behavior=="BACKGROUND_MUSIC"){var audio_el=sfx.src;if(audio_el)audio_el.pause()}else{var source=sfx.source_node;var playrate=source.playbackRate.value;var buf_dur=
source.buffer.duration;if(current_time>sfx.start_time)sfx.buf_offset=calc_buf_offset(sfx,current_time);else sfx.buf_offset=0;sfx.source_node.stop(0);sfx.source_node.disconnect();reset_volume_pitch_random(sfx)}sfx.state=SPKSTATE_PAUSE}function calc_buf_offset(sfx,current_time){_seed_tmp[0]=sfx.base_seed;var buf_dur=sfx.source_node.buffer.duration;var time=sfx.start_time;var playrate;while(time<current_time){playrate=sfx.pitch+sfx.pitch_random*m_util.rand_r(_seed_tmp);time+=buf_dur/playrate}return(buf_dur/
playrate-(time-current_time))*playrate}exports.speaker_resume=speaker_resume;function speaker_resume(obj){var sfx=obj.sfx;if(sfx.state!=SPKSTATE_PAUSE)return;var current_time=_wa.currentTime;sfx.start_time+=current_time-sfx.pause_time;if(sfx.behavior=="BACKGROUND_MUSIC"){var audio_el=sfx.src;audio_el.play()}else{update_source_node(obj);sfx.vp_rand_end_time=current_time;var source=sfx.source_node;var playrate=source.playbackRate.value;var buf_dur=source.buffer.duration;source.start(sfx.start_time,
sfx.buf_offset);schedule_volume_pitch_random(sfx)}schedule_fades(sfx,sfx.start_time);sfx.state=SPKSTATE_PLAY}function update_source_node(obj){var sfx=obj.sfx;var source=_wa.createBufferSource();source.loop=sfx.source_node.loop;source.buffer=sfx.source_node.buffer;source.playbackRate.value=sfx.source_node.playbackRate.value;if(sfx.panner_node)source.connect(sfx.panner_node);else source.connect(sfx.gain_node);sfx.source_node=source}exports.playrate=function(obj,playrate){var sfx=obj.sfx;sfx.pitch=playrate;
if(spk_is_active(obj)&&(sfx.behavior=="POSITIONAL"||sfx.behavior=="BACKGROUND_SOUND")){sfx.source_node.playbackRate.value=playrate;reset_volume_pitch_random(sfx);schedule_volume_pitch_random(sfx)}};exports.get_playrate=function(obj){return obj.sfx.pitch};exports.cyclic=function(obj,cyclic){obj.sfx.cyclic=Boolean(cyclic)};exports.is_cyclic=is_cyclic;function is_cyclic(obj){return obj.sfx.cyclic}exports.listener_update_transform=function(scene,trans,quat,elapsed){if(!_wa)return;if(!scene._sfx)return;
var front=_vec3_tmp;front[0]=0;front[1]=-1;front[2]=0;m_vec3.transformQuat(front,quat,front);var up=_vec3_tmp2;up[0]=0;up[1]=0;up[2]=-1;m_vec3.transformQuat(up,quat,up);var listener=_wa.listener;listener.setPosition(trans[0],trans[1],trans[2]);listener.setOrientation(front[0],front[1],front[2],up[0],up[1],up[2]);m_vec3.copy(front,scene._sfx.listener_direction);if(!scene._sfx.disable_doppler&&elapsed){var speed=_vec3_tmp3;speed[0]=(trans[0]-scene._sfx.listener_last_eye[0])/elapsed;speed[1]=(trans[1]-
scene._sfx.listener_last_eye[1])/elapsed;speed[2]=(trans[2]-scene._sfx.listener_last_eye[2])/elapsed;m_util.smooth_v(speed,scene._sfx.listener_speed_avg,elapsed,SPEED_SMOOTH_PERIOD,speed);listener.setVelocity(speed[0],speed[1],speed[2]);m_vec3.copy(speed,scene._sfx.listener_speed_avg)}m_vec3.copy(trans,scene._sfx.listener_last_eye)};exports.listener_reset_speed=function(speed,dir){if(!_wa)return;if(!_active_scene._sfx||_active_scene._sfx.disable_doppler)return;var velocity=_vec3_tmp;if(dir)m_vec3.copy(dir,
velocity);else m_vec3.copy(_active_scene._sfx.listener_direction,velocity);m_vec3.scale(velocity,speed,velocity);var listener=_wa.listener;listener.setVelocity(velocity[0],velocity[1],velocity[2]);m_vec3.copy(velocity,_active_scene._sfx.listener_speed_avg)};exports.speaker_update_transform=function(obj,elapsed){var sfx=obj.sfx;if(!(spk_is_active(obj)&&sfx.behavior=="POSITIONAL"))return;var pos=obj.render.trans;var panner=sfx.panner_node;panner.setPosition(pos[0],pos[1],pos[2]);var orient=_vec3_tmp;
m_util.quat_to_dir(obj.render.quat,m_util.AXIS_MY,orient);panner.setOrientation(orient[0],orient[1],orient[2]);var lpos=sfx.last_position;if(!sfx.disable_doppler&&elapsed){var speed=_vec3_tmp2;speed[0]=(pos[0]-lpos[0])/elapsed;speed[1]=(pos[1]-lpos[1])/elapsed;speed[2]=(pos[2]-lpos[2])/elapsed;m_util.smooth_v(speed,sfx.speed_avg,elapsed,SPEED_SMOOTH_PERIOD,speed);panner.setVelocity(speed[0],speed[1],speed[2]);m_vec3.copy(speed,sfx.speed_avg)}m_vec3.copy(pos,lpos)};exports.speaker_reset_speed=function(obj,
speed,dir){var sfx=obj.sfx;if(!(spk_is_active(obj)&&sfx.behavior=="POSITIONAL")||sfx.disable_doppler)return;var velocity=_vec3_tmp;if(dir)m_vec3.copy(dir,velocity);else m_vec3.copy(sfx.direction,velocity);m_vec3.scale(velocity,speed,velocity);var panner=sfx.panner_node;panner.setVelocity(velocity[0],velocity[1],velocity[2]);m_vec3.copy(velocity,sfx.speed_avg);var pos=obj.render.trans;m_vec3.copy(obj.render.trans,sfx.last_position)};exports.get_spk_behavior=function(obj){return obj.sfx.behavior};exports.check_active_speakers=
function(){for(var i=0;i<_speaker_objects.length;i++)if(spk_is_active(_speaker_objects[i]))return true;return false};function spk_is_active(obj){if(obj.sfx&&(obj.sfx.state==SPKSTATE_PLAY||obj.sfx.state==SPKSTATE_PAUSE||obj.sfx.state==SPKSTATE_STOP))return true;else return false}function calc_distance_gain(pos,pos_lis,dist_ref,dist_max,atten){var x=pos[0];var y=pos[1];var z=pos[2];var x0=pos_lis[0];var y0=pos_lis[1];var z0=pos_lis[2];var gain;var dist=Math.sqrt(Math.pow(x-x0,2)+Math.pow(y-y0,2)+Math.pow(z-
z0,2));if(dist<dist_ref)gain=1;else if(dist>dist_max)gain=0;else var gain=dist_ref/(dist_ref+atten*(dist-dist_ref));return gain}function calc_gain(sfx){var volume=sfx.muted?0:sfx.volume;return volume}exports.set_master_volume=function(volume){var scene_sfx=_active_scene._sfx;if(scene_sfx){scene_sfx.volume=volume;if(_wa)scene_sfx.gain_node.gain.value=calc_gain(scene_sfx)}};exports.get_master_volume=function(){var scene_sfx=_active_scene._sfx;if(scene_sfx)return scene_sfx.volume;else return 0};exports.set_volume=
function(obj,volume){var sfx=obj.sfx;sfx.volume=volume;if(spk_is_active(obj))sfx.gain_node.gain.value=calc_gain(sfx)};exports.get_volume=function(obj){return obj.sfx.volume};exports.mute=function(obj,muted){obj.sfx.muted=Boolean(muted);if(spk_is_active(obj))obj.sfx.gain_node.gain.value=calc_gain(obj.sfx)};exports.is_muted=function(obj){return obj.sfx.muted};exports.mute_master=function(muted){var scene_sfx=_active_scene._sfx;if(scene_sfx){scene_sfx.muted=Boolean(muted);if(_wa)scene_sfx.gain_node.gain.value=
calc_gain(scene_sfx)}};exports.is_master_muted=function(){var scene_sfx=_active_scene._sfx;if(scene_sfx)return scene_sfx.muted;else return false};exports.get_speaker_objects=function(){return _speaker_objects};exports.pause=function(){for(var i=0;i<_speaker_objects.length;i++)speaker_pause(_speaker_objects[i])};exports.resume=function(){for(var i=0;i<_speaker_objects.length;i++)speaker_resume(_speaker_objects[i])};exports.set_compressor_params=function(scene,params){if(!(scene._sfx&&scene._sfx.compressor_node))return;
var compressor=scene._sfx.compressor_node;compressor.threshold.value=params["threshold"];compressor.knee.value=params["knee"];compressor.ratio.value=params["ratio"];compressor.attack.value=params["attack"];compressor.release.value=params["release"]};exports.get_compressor_params=function(scene){if(!(scene._sfx&&scene._sfx.compressor_node))return null;var compressor=scene._sfx.compressor_node;var params={"threshold":compressor.threshold.value,"knee":compressor.knee.value,"ratio":compressor.ratio.value,
"attack":compressor.attack.value,"release":compressor.release.value};return params};exports.duck=function(obj,value,time){if(!spk_is_active(obj))return;var sfx=obj.sfx;var fade_gnode=sfx.fade_gain_node;var current_time=_wa.currentTime;fade_gnode.gain.setValueAtTime(fade_gnode.gain.value,current_time);fade_gnode.gain.linearRampToValueAtTime(value,current_time+time);sfx.duck_time=time};exports.unduck=function(obj){if(!spk_is_active(obj))return;var sfx=obj.sfx;var fade_gnode=sfx.fade_gain_node;var current_time=
_wa.currentTime;fade_gnode.gain.setValueAtTime(fade_gnode.gain.value,current_time);fade_gnode.gain.linearRampToValueAtTime(1,current_time+sfx.duck_time);sfx.duck_time=0};exports.duck_master=function(value,time){if(!_wa)return;var scene_sfx=_active_scene._sfx;var fade_gnode=scene_sfx.fade_gain_node;var current_time=_wa.currentTime;fade_gnode.gain.setValueAtTime(fade_gnode.gain.value,current_time);fade_gnode.gain.linearRampToValueAtTime(value,current_time+time);scene_sfx.duck_time=time};exports.unduck_master=
function(){if(!_wa)return;var scene_sfx=_active_scene._sfx;var fade_gnode=scene_sfx.fade_gain_node;var current_time=_wa.currentTime;fade_gnode.gain.setValueAtTime(fade_gnode.gain.value,current_time);fade_gnode.gain.linearRampToValueAtTime(1,current_time+scene_sfx.duck_time);scene_sfx.duck_time=0};exports.apply_playlist=function(objs,delay,random){_playlist={active:-1,active_start_time:0,random:random,speakers:[],durations:[]};for(var i=0;i<objs.length;i++){var obj=objs[i];var duration=get_duration(obj);
if(duration==0){m_print.warn("Ignoring speaker with zero duration: "+obj.name);continue}stop(obj);var sfx=obj.sfx;sfx.cyclic=false;_playlist.speakers.push(obj);_playlist.durations.push(duration+delay)}};exports.get_duration=get_duration;function get_duration(obj){var sfx=obj.sfx;if(sfx.behavior=="POSITIONAL"||sfx.behavior=="BACKGROUND_SOUND"){var buffer=sfx.src;if(buffer)return buffer.duration;else return 0}else{var audio=sfx.src;if(audio)return audio.duration;else return 0}}exports.clear_playlist=
function(){if(_playlist){var spks=_playlist.speakers;for(var i=0;i<spks.length;i++)stop(spks[i])}_playlist=null};exports.get_positional_params=function(obj){var sfx=obj.sfx;if(!sfx||sfx.behavior!="POSITIONAL")return null;var pos_params={"dist_ref":sfx.dist_ref,"dist_max":sfx.dist_max,"attenuation":sfx.attenuation};return pos_params};exports.set_positional_params=function(obj,params){var sfx=obj.sfx;if(!sfx||sfx.behavior!="POSITIONAL")return;sfx.dist_ref=params["dist_ref"];sfx.dist_max=params["dist_max"];
sfx.attenuation=params["attenuation"];var ap=sfx.panner_node;if(ap){ap.refDistance=sfx.dist_ref;ap.maxDistance=sfx.dist_max;ap.rolloffFactor=sfx.attenuation}};exports.set_filter_params=function(obj,params){var sfx=obj.sfx;if(!sfx||!sfx.filter_node)return;sfx.filter_node.frequency.value=params["freq"];sfx.filter_node.Q.value=params["Q"];sfx.filter_node.gain.value=params["gain"]};exports.get_filter_params=function(obj){var sfx=obj.sfx;if(!sfx||!sfx.filter_node)return null;var params={"freq":sfx.filter_node.frequency.value,
"Q":sfx.filter_node.Q.value,"gain":sfx.filter_node.gain.value};return params};exports.get_filter_freq_response=function(obj,freq_arr,mag_arr,phase_arr){var sfx=obj.sfx;if(!sfx||!sfx.filter_node)return null;sfx.filter_node.getFrequencyResponse(freq_arr,mag_arr,phase_arr)}};b4w.module["__vec3"]=function(exports,require){var GLMAT_EPSILON=1E-7;var GLMAT_ARRAY_TYPE=typeof Float32Array!=="undefined"?Float32Array:Array;var GLMAT_RANDOM=Math.random;var vec3=exports;vec3.create=function(){var out=new GLMAT_ARRAY_TYPE(3);out[0]=0;out[1]=0;out[2]=0;return out};vec3.clone=function(a){var out=new GLMAT_ARRAY_TYPE(3);out[0]=a[0];out[1]=a[1];out[2]=a[2];return out};vec3.fromValues=function(x,y,z){var out=new GLMAT_ARRAY_TYPE(3);out[0]=x;out[1]=y;out[2]=z;return out};vec3.copy=function(a,
out){out[0]=a[0];out[1]=a[1];out[2]=a[2];return out};vec3.set=function(x,y,z,out){out[0]=x;out[1]=y;out[2]=z;return out};vec3.add=function(a,b,out){out[0]=a[0]+b[0];out[1]=a[1]+b[1];out[2]=a[2]+b[2];return out};vec3.subtract=function(a,b,out){out[0]=a[0]-b[0];out[1]=a[1]-b[1];out[2]=a[2]-b[2];return out};vec3.sub=vec3.subtract;vec3.multiply=function(a,b,out){out[0]=a[0]*b[0];out[1]=a[1]*b[1];out[2]=a[2]*b[2];return out};vec3.mul=vec3.multiply;vec3.divide=function(a,b,out){out[0]=a[0]/b[0];out[1]=
a[1]/b[1];out[2]=a[2]/b[2];return out};vec3.div=vec3.divide;vec3.min=function(a,b,out){out[0]=Math.min(a[0],b[0]);out[1]=Math.min(a[1],b[1]);out[2]=Math.min(a[2],b[2]);return out};vec3.max=function(a,b,out){out[0]=Math.max(a[0],b[0]);out[1]=Math.max(a[1],b[1]);out[2]=Math.max(a[2],b[2]);return out};vec3.scale=function(a,b,out){out[0]=a[0]*b;out[1]=a[1]*b;out[2]=a[2]*b;return out};vec3.scaleAndAdd=function(a,b,scale,out){out[0]=a[0]+b[0]*scale;out[1]=a[1]+b[1]*scale;out[2]=a[2]+b[2]*scale;return out};
vec3.distance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2];return Math.sqrt(x*x+y*y+z*z)};vec3.dist=vec3.distance;vec3.squaredDistance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2];return x*x+y*y+z*z};vec3.sqrDist=vec3.squaredDistance;vec3.length=function(a){var x=a[0],y=a[1],z=a[2];return Math.sqrt(x*x+y*y+z*z)};vec3.len=vec3.length;vec3.squaredLength=function(a){var x=a[0],y=a[1],z=a[2];return x*x+y*y+z*z};vec3.sqrLen=vec3.squaredLength;vec3.negate=function(a,out){out[0]=-a[0];
out[1]=-a[1];out[2]=-a[2];return out};vec3.inverse=function(a,out){out[0]=1/a[0];out[1]=1/a[1];out[2]=1/a[2];return out};vec3.normalize=function(a,out){var x=a[0],y=a[1],z=a[2];var len=x*x+y*y+z*z;if(len>0){len=1/Math.sqrt(len);out[0]=a[0]*len;out[1]=a[1]*len;out[2]=a[2]*len}return out};vec3.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]};vec3.cross=function(a,b,out){var ax=a[0],ay=a[1],az=a[2],bx=b[0],by=b[1],bz=b[2];out[0]=ay*bz-az*by;out[1]=az*bx-ax*bz;out[2]=ax*by-ay*bx;return out};vec3.lerp=
function(a,b,t,out){var ax=a[0],ay=a[1],az=a[2];out[0]=ax+t*(b[0]-ax);out[1]=ay+t*(b[1]-ay);out[2]=az+t*(b[2]-az);return out};vec3.random=function(scale,out){scale=scale||1;var r=GLMAT_RANDOM()*2*Math.PI;var z=GLMAT_RANDOM()*2-1;var zScale=Math.sqrt(1-z*z)*scale;out[0]=Math.cos(r)*zScale;out[1]=Math.sin(r)*zScale;out[2]=z*scale;return out};vec3.transformMat4=function(a,m,out){var x=a[0],y=a[1],z=a[2],w=m[3]*x+m[7]*y+m[11]*z+m[15];w=w||1;out[0]=(m[0]*x+m[4]*y+m[8]*z+m[12])/w;out[1]=(m[1]*x+m[5]*y+
m[9]*z+m[13])/w;out[2]=(m[2]*x+m[6]*y+m[10]*z+m[14])/w;return out};vec3.transformMat3=function(a,m,out){var x=a[0],y=a[1],z=a[2];out[0]=x*m[0]+y*m[3]+z*m[6];out[1]=x*m[1]+y*m[4]+z*m[7];out[2]=x*m[2]+y*m[5]+z*m[8];return out};vec3.transformQuat=function(a,q,out){var x=a[0],y=a[1],z=a[2],qx=q[0],qy=q[1],qz=q[2],qw=q[3],ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;out[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy;out[1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;out[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;return out};
vec3.rotateX=function(a,b,c,out){var p=[],r=[];p[0]=a[0]-b[0];p[1]=a[1]-b[1];p[2]=a[2]-b[2];r[0]=p[0];r[1]=p[1]*Math.cos(c)-p[2]*Math.sin(c);r[2]=p[1]*Math.sin(c)+p[2]*Math.cos(c);out[0]=r[0]+b[0];out[1]=r[1]+b[1];out[2]=r[2]+b[2];return out};vec3.rotateY=function(a,b,c,out){var p=[],r=[];p[0]=a[0]-b[0];p[1]=a[1]-b[1];p[2]=a[2]-b[2];r[0]=p[2]*Math.sin(c)+p[0]*Math.cos(c);r[1]=p[1];r[2]=p[2]*Math.cos(c)-p[0]*Math.sin(c);out[0]=r[0]+b[0];out[1]=r[1]+b[1];out[2]=r[2]+b[2];return out};vec3.rotateZ=function(a,
b,c,out){var p=[],r=[];p[0]=a[0]-b[0];p[1]=a[1]-b[1];p[2]=a[2]-b[2];r[0]=p[0]*Math.cos(c)-p[1]*Math.sin(c);r[1]=p[0]*Math.sin(c)+p[1]*Math.cos(c);r[2]=p[2];out[0]=r[0]+b[0];out[1]=r[1]+b[1];out[2]=r[2]+b[2];return out};vec3.forEach=function(){var vec=vec3.create();return function(a,stride,offset,count,fn,arg){var i,l;if(!stride)stride=3;if(!offset)offset=0;if(count)l=Math.min(count*stride+offset,a.length);else l=a.length;for(i=offset;i<l;i+=stride){vec[0]=a[i];vec[1]=a[i+1];vec[2]=a[i+2];fn(vec,arg,
vec);a[i]=vec[0];a[i+1]=vec[1];a[i+2]=vec[2]}return a}}();vec3.angle=function(a,b){var tempA=vec3.fromValues(a[0],a[1],a[2]);var tempB=vec3.fromValues(b[0],b[1],b[2]);vec3.normalize(tempA,tempA);vec3.normalize(tempB,tempB);var cosine=vec3.dot(tempA,tempB);if(cosine>1)return 0;else return Math.acos(cosine)};vec3.str=function(a){return"vec3("+a[0]+", "+a[1]+", "+a[2]+")"};if(typeof exports!=="undefined")exports.vec3=vec3};b4w.module["vec3"]=b4w.module["__vec3"];
b4w.module["__vec4"]=function(exports,require){var GLMAT_EPSILON=1E-7;var GLMAT_ARRAY_TYPE=typeof Float32Array!=="undefined"?Float32Array:Array;var GLMAT_RANDOM=Math.random;var vec4=exports;vec4.create=function(){var out=new GLMAT_ARRAY_TYPE(4);out[0]=0;out[1]=0;out[2]=0;out[3]=0;return out};vec4.clone=function(a){var out=new GLMAT_ARRAY_TYPE(4);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out};vec4.fromValues=function(x,y,z,w){var out=new GLMAT_ARRAY_TYPE(4);out[0]=x;out[1]=y;out[2]=z;
out[3]=w;return out};vec4.copy=function(a,out){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out};vec4.set=function(x,y,z,w,out){out[0]=x;out[1]=y;out[2]=z;out[3]=w;return out};vec4.add=function(a,b,out){out[0]=a[0]+b[0];out[1]=a[1]+b[1];out[2]=a[2]+b[2];out[3]=a[3]+b[3];return out};vec4.subtract=function(a,b,out){out[0]=a[0]-b[0];out[1]=a[1]-b[1];out[2]=a[2]-b[2];out[3]=a[3]-b[3];return out};vec4.sub=vec4.subtract;vec4.multiply=function(a,b,out){out[0]=a[0]*b[0];out[1]=a[1]*b[1];out[2]=
a[2]*b[2];out[3]=a[3]*b[3];return out};vec4.mul=vec4.multiply;vec4.divide=function(a,b,out){out[0]=a[0]/b[0];out[1]=a[1]/b[1];out[2]=a[2]/b[2];out[3]=a[3]/b[3];return out};vec4.div=vec4.divide;vec4.min=function(a,b,out){out[0]=Math.min(a[0],b[0]);out[1]=Math.min(a[1],b[1]);out[2]=Math.min(a[2],b[2]);out[3]=Math.min(a[3],b[3]);return out};vec4.max=function(a,b,out){out[0]=Math.max(a[0],b[0]);out[1]=Math.max(a[1],b[1]);out[2]=Math.max(a[2],b[2]);out[3]=Math.max(a[3],b[3]);return out};vec4.scale=function(a,
b,out){out[0]=a[0]*b;out[1]=a[1]*b;out[2]=a[2]*b;out[3]=a[3]*b;return out};vec4.scaleAndAdd=function(a,b,scale,out){out[0]=a[0]+b[0]*scale;out[1]=a[1]+b[1]*scale;out[2]=a[2]+b[2]*scale;out[3]=a[3]+b[3]*scale;return out};vec4.distance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2],w=b[3]-a[3];return Math.sqrt(x*x+y*y+z*z+w*w)};vec4.dist=vec4.distance;vec4.squaredDistance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2],w=b[3]-a[3];return x*x+y*y+z*z+w*w};vec4.sqrDist=vec4.squaredDistance;
vec4.length=function(a){var x=a[0],y=a[1],z=a[2],w=a[3];return Math.sqrt(x*x+y*y+z*z+w*w)};vec4.len=vec4.length;vec4.squaredLength=function(a){var x=a[0],y=a[1],z=a[2],w=a[3];return x*x+y*y+z*z+w*w};vec4.sqrLen=vec4.squaredLength;vec4.negate=function(a,out){out[0]=-a[0];out[1]=-a[1];out[2]=-a[2];out[3]=-a[3];return out};vec4.inverse=function(a,out){out[0]=1/a[0];out[1]=1/a[1];out[2]=1/a[2];out[3]=1/a[3];return out};vec4.normalize=function(a,out){var x=a[0],y=a[1],z=a[2],w=a[3];var len=x*x+y*y+z*z+
w*w;if(len>0){len=1/Math.sqrt(len);out[0]=a[0]*len;out[1]=a[1]*len;out[2]=a[2]*len;out[3]=a[3]*len}return out};vec4.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]};vec4.lerp=function(a,b,t,out){var ax=a[0],ay=a[1],az=a[2],aw=a[3];out[0]=ax+t*(b[0]-ax);out[1]=ay+t*(b[1]-ay);out[2]=az+t*(b[2]-az);out[3]=aw+t*(b[3]-aw);return out};vec4.random=function(scale,out){scale=scale||1;out[0]=GLMAT_RANDOM();out[1]=GLMAT_RANDOM();out[2]=GLMAT_RANDOM();out[3]=GLMAT_RANDOM();vec4.normalize(out,
out);vec4.scale(out,scale,out);return out};vec4.transformMat4=function(a,m,out){var x=a[0],y=a[1],z=a[2],w=a[3];out[0]=m[0]*x+m[4]*y+m[8]*z+m[12]*w;out[1]=m[1]*x+m[5]*y+m[9]*z+m[13]*w;out[2]=m[2]*x+m[6]*y+m[10]*z+m[14]*w;out[3]=m[3]*x+m[7]*y+m[11]*z+m[15]*w;return out};vec4.transformQuat=function(a,q,out){var x=a[0],y=a[1],z=a[2],qx=q[0],qy=q[1],qz=q[2],qw=q[3],ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;out[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy;out[1]=iy*qw+iw*-qy+iz*-qx-ix*
-qz;out[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;out[3]=a[3];return out};vec4.forEach=function(){var vec=vec4.create();return function(a,stride,offset,count,fn,arg){var i,l;if(!stride)stride=4;if(!offset)offset=0;if(count)l=Math.min(count*stride+offset,a.length);else l=a.length;for(i=offset;i<l;i+=stride){vec[0]=a[i];vec[1]=a[i+1];vec[2]=a[i+2];vec[3]=a[i+3];fn(vec,arg,vec);a[i]=vec[0];a[i+1]=vec[1];a[i+2]=vec[2];a[i+3]=vec[3]}return a}}();vec4.str=function(a){return"vec4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+
")"};if(typeof exports!=="undefined")exports.vec4=vec4};b4w.module["vec4"]=b4w.module["__vec4"];
b4w.module["__quat"]=function(exports,require){var vec3=require("__vec3");var vec4=require("__vec4");var mat3=require("__mat3");var GLMAT_EPSILON=1E-7;var GLMAT_ARRAY_TYPE=typeof Float32Array!=="undefined"?Float32Array:Array;var GLMAT_RANDOM=Math.random;var quat=exports;quat.create=function(){var out=new GLMAT_ARRAY_TYPE(4);out[0]=0;out[1]=0;out[2]=0;out[3]=1;return out};quat.rotationTo=function(){var tmpvec3=vec3.create();var xUnitVec3=vec3.fromValues(1,0,0);var yUnitVec3=vec3.fromValues(0,1,0);
return function(a,b,out){var dot=vec3.dot(a,b);if(dot<-.9999999){vec3.cross(xUnitVec3,a,tmpvec3);if(vec3.length(tmpvec3)<1E-6)vec3.cross(yUnitVec3,a,tmpvec3);vec3.normalize(tmpvec3,tmpvec3);quat.setAxisAngle(tmpvec3,Math.PI,out);return out}else if(dot>.9999999){out[0]=0;out[1]=0;out[2]=0;out[3]=1;return out}else{vec3.cross(a,b,tmpvec3);out[0]=tmpvec3[0];out[1]=tmpvec3[1];out[2]=tmpvec3[2];out[3]=1+dot;return quat.normalize(out,out)}}}();quat.setAxes=function(){var matr=mat3.create();return function(view,
right,up,out){matr[0]=right[0];matr[3]=right[1];matr[6]=right[2];matr[1]=up[0];matr[4]=up[1];matr[7]=up[2];matr[2]=-view[0];matr[5]=-view[1];matr[8]=-view[2];return quat.normalize(quat.fromMat3(matr,out),out)}}();quat.clone=vec4.clone;quat.fromValues=vec4.fromValues;quat.copy=vec4.copy;quat.set=vec4.set;quat.identity=function(out){out[0]=0;out[1]=0;out[2]=0;out[3]=1;return out};quat.setAxisAngle=function(axis,rad,out){rad=rad*.5;var s=Math.sin(rad);out[0]=s*axis[0];out[1]=s*axis[1];out[2]=s*axis[2];
out[3]=Math.cos(rad);return out};quat.add=vec4.add;quat.multiply=function(a,b,out){var ax=a[0],ay=a[1],az=a[2],aw=a[3],bx=b[0],by=b[1],bz=b[2],bw=b[3];out[0]=ax*bw+aw*bx+ay*bz-az*by;out[1]=ay*bw+aw*by+az*bx-ax*bz;out[2]=az*bw+aw*bz+ax*by-ay*bx;out[3]=aw*bw-ax*bx-ay*by-az*bz;return out};quat.mul=quat.multiply;quat.scale=vec4.scale;quat.rotateX=function(a,rad,out){rad*=.5;var ax=a[0],ay=a[1],az=a[2],aw=a[3],bx=Math.sin(rad),bw=Math.cos(rad);out[0]=ax*bw+aw*bx;out[1]=ay*bw+az*bx;out[2]=az*bw-ay*bx;out[3]=
aw*bw-ax*bx;return out};quat.rotateY=function(a,rad,out){rad*=.5;var ax=a[0],ay=a[1],az=a[2],aw=a[3],by=Math.sin(rad),bw=Math.cos(rad);out[0]=ax*bw-az*by;out[1]=ay*bw+aw*by;out[2]=az*bw+ax*by;out[3]=aw*bw-ay*by;return out};quat.rotateZ=function(a,rad,out){rad*=.5;var ax=a[0],ay=a[1],az=a[2],aw=a[3],bz=Math.sin(rad),bw=Math.cos(rad);out[0]=ax*bw+ay*bz;out[1]=ay*bw-ax*bz;out[2]=az*bw+aw*bz;out[3]=aw*bw-az*bz;return out};quat.calculateW=function(a,out){var x=a[0],y=a[1],z=a[2];out[0]=x;out[1]=y;out[2]=
z;out[3]=Math.sqrt(Math.abs(1-x*x-y*y-z*z));return out};quat.dot=vec4.dot;quat.lerp=vec4.lerp;quat.slerp=function(a,b,t,out){var ax=a[0],ay=a[1],az=a[2],aw=a[3],bx=b[0],by=b[1],bz=b[2],bw=b[3];var omega,cosom,sinom,scale0,scale1;cosom=ax*bx+ay*by+az*bz+aw*bw;if(cosom<0){cosom=-cosom;bx=-bx;by=-by;bz=-bz;bw=-bw}if(1-cosom>1E-6){omega=Math.acos(cosom);sinom=Math.sin(omega);scale0=Math.sin((1-t)*omega)/sinom;scale1=Math.sin(t*omega)/sinom}else{scale0=1-t;scale1=t}out[0]=scale0*ax+scale1*bx;out[1]=scale0*
ay+scale1*by;out[2]=scale0*az+scale1*bz;out[3]=scale0*aw+scale1*bw;return out};quat.invert=function(a,out){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],dot=a0*a0+a1*a1+a2*a2+a3*a3,invDot=dot?1/dot:0;out[0]=-a0*invDot;out[1]=-a1*invDot;out[2]=-a2*invDot;out[3]=a3*invDot;return out};quat.conjugate=function(a,out){out[0]=-a[0];out[1]=-a[1];out[2]=-a[2];out[3]=a[3];return out};quat.length=vec4.length;quat.len=quat.length;quat.squaredLength=vec4.squaredLength;quat.sqrLen=quat.squaredLength;quat.normalize=vec4.normalize;
quat.fromMat3=function(m,out){var fTrace=m[0]+m[4]+m[8];var fRoot;if(fTrace>0){fRoot=Math.sqrt(fTrace+1);out[3]=.5*fRoot;fRoot=.5/fRoot;out[0]=(m[5]-m[7])*fRoot;out[1]=(m[6]-m[2])*fRoot;out[2]=(m[1]-m[3])*fRoot}else{var i=0;if(m[4]>m[0])i=1;if(m[8]>m[i*3+i])i=2;var j=(i+1)%3;var k=(i+2)%3;fRoot=Math.sqrt(m[i*3+i]-m[j*3+j]-m[k*3+k]+1);out[i]=.5*fRoot;fRoot=.5/fRoot;out[3]=(m[j*3+k]-m[k*3+j])*fRoot;out[j]=(m[j*3+i]+m[i*3+j])*fRoot;out[k]=(m[k*3+i]+m[i*3+k])*fRoot}return out};quat.str=function(a){return"quat("+
a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};if(typeof exports!=="undefined")exports.quat=quat};b4w.module["quat"]=b4w.module["__quat"];
b4w.module["__mat3"]=function(exports,require){var GLMAT_EPSILON=1E-7;var GLMAT_ARRAY_TYPE=typeof Float32Array!=="undefined"?Float32Array:Array;var GLMAT_RANDOM=Math.random;var mat3=exports;mat3.create=function(){var out=new GLMAT_ARRAY_TYPE(9);out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=1;out[5]=0;out[6]=0;out[7]=0;out[8]=1;return out};mat3.fromMat4=function(a,out){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[4];out[4]=a[5];out[5]=a[6];out[6]=a[8];out[7]=a[9];out[8]=a[10];return out};mat3.clone=function(a){var out=
new GLMAT_ARRAY_TYPE(9);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];return out};mat3.copy=function(a,out){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];return out};mat3.identity=function(out){out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=1;out[5]=0;out[6]=0;out[7]=0;out[8]=1;return out};mat3.transpose=function(a,out){if(out===a){var a01=a[1],a02=a[2],a12=a[5];out[1]=a[3];out[2]=
a[6];out[3]=a01;out[5]=a[7];out[6]=a02;out[7]=a12}else{out[0]=a[0];out[1]=a[3];out[2]=a[6];out[3]=a[1];out[4]=a[4];out[5]=a[7];out[6]=a[2];out[7]=a[5];out[8]=a[8]}return out};mat3.invert=function(a,out){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],b01=a22*a11-a12*a21,b11=-a22*a10+a12*a20,b21=a21*a10-a11*a20,det=a00*b01+a01*b11+a02*b21;if(!det)return null;det=1/det;out[0]=b01*det;out[1]=(-a22*a01+a02*a21)*det;out[2]=(a12*a01-a02*a11)*det;out[3]=b11*det;out[4]=
(a22*a00-a02*a20)*det;out[5]=(-a12*a00+a02*a10)*det;out[6]=b21*det;out[7]=(-a21*a00+a01*a20)*det;out[8]=(a11*a00-a01*a10)*det;return out};mat3.adjoint=function(a,out){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8];out[0]=a11*a22-a12*a21;out[1]=a02*a21-a01*a22;out[2]=a01*a12-a02*a11;out[3]=a12*a20-a10*a22;out[4]=a00*a22-a02*a20;out[5]=a02*a10-a00*a12;out[6]=a10*a21-a11*a20;out[7]=a01*a20-a00*a21;out[8]=a00*a11-a01*a10;return out};mat3.determinant=function(a){var a00=
a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8];return a00*(a22*a11-a12*a21)+a01*(-a22*a10+a12*a20)+a02*(a21*a10-a11*a20)};mat3.multiply=function(a,b,out){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],b00=b[0],b01=b[1],b02=b[2],b10=b[3],b11=b[4],b12=b[5],b20=b[6],b21=b[7],b22=b[8];out[0]=b00*a00+b01*a10+b02*a20;out[1]=b00*a01+b01*a11+b02*a21;out[2]=b00*a02+b01*a12+b02*a22;out[3]=b10*a00+b11*a10+b12*a20;out[4]=b10*a01+b11*a11+b12*
a21;out[5]=b10*a02+b11*a12+b12*a22;out[6]=b20*a00+b21*a10+b22*a20;out[7]=b20*a01+b21*a11+b22*a21;out[8]=b20*a02+b21*a12+b22*a22;return out};mat3.mul=mat3.multiply;mat3.translate=function(a,v,out){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],x=v[0],y=v[1];out[0]=a00;out[1]=a01;out[2]=a02;out[3]=a10;out[4]=a11;out[5]=a12;out[6]=x*a00+y*a10+a20;out[7]=x*a01+y*a11+a21;out[8]=x*a02+y*a12+a22;return out};mat3.rotate=function(a,rad,out){var a00=a[0],a01=a[1],a02=a[2],
a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],s=Math.sin(rad),c=Math.cos(rad);out[0]=c*a00+s*a10;out[1]=c*a01+s*a11;out[2]=c*a02+s*a12;out[3]=c*a10-s*a00;out[4]=c*a11-s*a01;out[5]=c*a12-s*a02;out[6]=a20;out[7]=a21;out[8]=a22;return out};mat3.scale=function(a,v,out){var x=v[0],y=v[1];out[0]=x*a[0];out[1]=x*a[1];out[2]=x*a[2];out[3]=y*a[3];out[4]=y*a[4];out[5]=y*a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];return out};mat3.fromTranslation=function(v,out){out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=
1;out[5]=0;out[6]=v[0];out[7]=v[1];out[8]=1;return out};mat3.fromRotation=function(rad,out){var s=Math.sin(rad),c=Math.cos(rad);out[0]=c;out[1]=s;out[2]=0;out[3]=-s;out[4]=c;out[5]=0;out[6]=0;out[7]=0;out[8]=1;return out};mat3.fromScaling=function(v,out){out[0]=v[0];out[1]=0;out[2]=0;out[3]=0;out[4]=v[1];out[5]=0;out[6]=0;out[7]=0;out[8]=1;return out};mat3.fromMat2d=function(a,out){out[0]=a[0];out[1]=a[1];out[2]=0;out[3]=a[2];out[4]=a[3];out[5]=0;out[6]=a[4];out[7]=a[5];out[8]=1;return out};mat3.fromQuat=
function(q,out){var x=q[0],y=q[1],z=q[2],w=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,yx=y*x2,yy=y*y2,zx=z*x2,zy=z*y2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;out[0]=1-yy-zz;out[3]=yx-wz;out[6]=zx+wy;out[1]=yx+wz;out[4]=1-xx-zz;out[7]=zy-wx;out[2]=zx-wy;out[5]=zy+wx;out[8]=1-xx-yy;return out};mat3.normalFromMat4=function(a,out){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*
a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32,det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;if(!det)return null;det=1/det;out[0]=(a11*b11-a12*b10+a13*b09)*det;out[1]=(a12*b08-a10*b11-a13*b07)*det;out[2]=(a10*b10-a11*b08+a13*b06)*det;out[3]=(a02*b10-a01*b11-a03*b09)*det;out[4]=(a00*b11-a02*b08+a03*b07)*det;out[5]=(a01*b08-a00*b10-a03*b06)*
det;out[6]=(a31*b05-a32*b04+a33*b03)*det;out[7]=(a32*b02-a30*b05-a33*b01)*det;out[8]=(a30*b04-a31*b02+a33*b00)*det;return out};mat3.str=function(a){return"mat3("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+")"};mat3.frob=function(a){return Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2)+Math.pow(a[3],2)+Math.pow(a[4],2)+Math.pow(a[5],2)+Math.pow(a[6],2)+Math.pow(a[7],2)+Math.pow(a[8],2))};if(typeof exports!=="undefined")exports.mat3=mat3};
b4w.module["mat3"]=b4w.module["__mat3"];
b4w.module["__mat4"]=function(exports,require){var GLMAT_EPSILON=1E-7;var GLMAT_ARRAY_TYPE=typeof Float32Array!=="undefined"?Float32Array:Array;var GLMAT_RANDOM=Math.random;var mat4=exports;mat4.create=function(){var out=new GLMAT_ARRAY_TYPE(16);out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=1;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=1;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.clone=function(a){var out=new GLMAT_ARRAY_TYPE(16);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=
a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out};mat4.copy=function(a,out){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out};mat4.identity=function(out){out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=1;out[6]=
0;out[7]=0;out[8]=0;out[9]=0;out[10]=1;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.transpose=function(a,out){if(out===a){var a01=a[1],a02=a[2],a03=a[3],a12=a[6],a13=a[7],a23=a[11];out[1]=a[4];out[2]=a[8];out[3]=a[12];out[4]=a01;out[6]=a[9];out[7]=a[13];out[8]=a02;out[9]=a12;out[11]=a[14];out[12]=a03;out[13]=a13;out[14]=a23}else{out[0]=a[0];out[1]=a[4];out[2]=a[8];out[3]=a[12];out[4]=a[1];out[5]=a[5];out[6]=a[9];out[7]=a[13];out[8]=a[2];out[9]=a[6];out[10]=a[10];out[11]=a[14];
out[12]=a[3];out[13]=a[7];out[14]=a[11];out[15]=a[15]}return out};mat4.invert=function(a,out){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32,det=b00*b11-b01*
b10+b02*b09+b03*b08-b04*b07+b05*b06;if(!det)return null;det=1/det;out[0]=(a11*b11-a12*b10+a13*b09)*det;out[1]=(a02*b10-a01*b11-a03*b09)*det;out[2]=(a31*b05-a32*b04+a33*b03)*det;out[3]=(a22*b04-a21*b05-a23*b03)*det;out[4]=(a12*b08-a10*b11-a13*b07)*det;out[5]=(a00*b11-a02*b08+a03*b07)*det;out[6]=(a32*b02-a30*b05-a33*b01)*det;out[7]=(a20*b05-a22*b02+a23*b01)*det;out[8]=(a10*b10-a11*b08+a13*b06)*det;out[9]=(a01*b08-a00*b10-a03*b06)*det;out[10]=(a30*b04-a31*b02+a33*b00)*det;out[11]=(a21*b02-a20*b04-a23*
b00)*det;out[12]=(a11*b07-a10*b09-a12*b06)*det;out[13]=(a00*b09-a01*b07+a02*b06)*det;out[14]=(a31*b01-a30*b03-a32*b00)*det;out[15]=(a20*b03-a21*b01+a22*b00)*det;return out};mat4.adjoint=function(a,out){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15];out[0]=a11*(a22*a33-a23*a32)-a21*(a12*a33-a13*a32)+a31*(a12*a23-a13*a22);out[1]=-(a01*(a22*a33-a23*a32)-a21*(a02*a33-a03*a32)+a31*(a02*a23-a03*a22));
out[2]=a01*(a12*a33-a13*a32)-a11*(a02*a33-a03*a32)+a31*(a02*a13-a03*a12);out[3]=-(a01*(a12*a23-a13*a22)-a11*(a02*a23-a03*a22)+a21*(a02*a13-a03*a12));out[4]=-(a10*(a22*a33-a23*a32)-a20*(a12*a33-a13*a32)+a30*(a12*a23-a13*a22));out[5]=a00*(a22*a33-a23*a32)-a20*(a02*a33-a03*a32)+a30*(a02*a23-a03*a22);out[6]=-(a00*(a12*a33-a13*a32)-a10*(a02*a33-a03*a32)+a30*(a02*a13-a03*a12));out[7]=a00*(a12*a23-a13*a22)-a10*(a02*a23-a03*a22)+a20*(a02*a13-a03*a12);out[8]=a10*(a21*a33-a23*a31)-a20*(a11*a33-a13*a31)+a30*
(a11*a23-a13*a21);out[9]=-(a00*(a21*a33-a23*a31)-a20*(a01*a33-a03*a31)+a30*(a01*a23-a03*a21));out[10]=a00*(a11*a33-a13*a31)-a10*(a01*a33-a03*a31)+a30*(a01*a13-a03*a11);out[11]=-(a00*(a11*a23-a13*a21)-a10*(a01*a23-a03*a21)+a20*(a01*a13-a03*a11));out[12]=-(a10*(a21*a32-a22*a31)-a20*(a11*a32-a12*a31)+a30*(a11*a22-a12*a21));out[13]=a00*(a21*a32-a22*a31)-a20*(a01*a32-a02*a31)+a30*(a01*a22-a02*a21);out[14]=-(a00*(a11*a32-a12*a31)-a10*(a01*a32-a02*a31)+a30*(a01*a12-a02*a11));out[15]=a00*(a11*a22-a12*a21)-
a10*(a01*a22-a02*a21)+a20*(a01*a12-a02*a11);return out};mat4.determinant=function(a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32;return b00*b11-b01*b10+
b02*b09+b03*b08-b04*b07+b05*b06};mat4.multiply=function(a,b,out){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15];var b0=b[0],b1=b[1],b2=b[2],b3=b[3];out[0]=b0*a00+b1*a10+b2*a20+b3*a30;out[1]=b0*a01+b1*a11+b2*a21+b3*a31;out[2]=b0*a02+b1*a12+b2*a22+b3*a32;out[3]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[4];b1=b[5];b2=b[6];b3=b[7];out[4]=b0*a00+b1*a10+b2*a20+b3*a30;out[5]=b0*a01+b1*a11+b2*a21+b3*a31;out[6]=
b0*a02+b1*a12+b2*a22+b3*a32;out[7]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[8];b1=b[9];b2=b[10];b3=b[11];out[8]=b0*a00+b1*a10+b2*a20+b3*a30;out[9]=b0*a01+b1*a11+b2*a21+b3*a31;out[10]=b0*a02+b1*a12+b2*a22+b3*a32;out[11]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[12];b1=b[13];b2=b[14];b3=b[15];out[12]=b0*a00+b1*a10+b2*a20+b3*a30;out[13]=b0*a01+b1*a11+b2*a21+b3*a31;out[14]=b0*a02+b1*a12+b2*a22+b3*a32;out[15]=b0*a03+b1*a13+b2*a23+b3*a33;return out};mat4.mul=mat4.multiply;mat4.translate=function(a,v,out){var x=v[0],y=v[1],
z=v[2],a00,a01,a02,a03,a10,a11,a12,a13,a20,a21,a22,a23;if(a===out){out[12]=a[0]*x+a[4]*y+a[8]*z+a[12];out[13]=a[1]*x+a[5]*y+a[9]*z+a[13];out[14]=a[2]*x+a[6]*y+a[10]*z+a[14];out[15]=a[3]*x+a[7]*y+a[11]*z+a[15]}else{a00=a[0];a01=a[1];a02=a[2];a03=a[3];a10=a[4];a11=a[5];a12=a[6];a13=a[7];a20=a[8];a21=a[9];a22=a[10];a23=a[11];out[0]=a00;out[1]=a01;out[2]=a02;out[3]=a03;out[4]=a10;out[5]=a11;out[6]=a12;out[7]=a13;out[8]=a20;out[9]=a21;out[10]=a22;out[11]=a23;out[12]=a00*x+a10*y+a20*z+a[12];out[13]=a01*
x+a11*y+a21*z+a[13];out[14]=a02*x+a12*y+a22*z+a[14];out[15]=a03*x+a13*y+a23*z+a[15]}return out};mat4.scale=function(a,v,out){var x=v[0],y=v[1],z=v[2];out[0]=a[0]*x;out[1]=a[1]*x;out[2]=a[2]*x;out[3]=a[3]*x;out[4]=a[4]*y;out[5]=a[5]*y;out[6]=a[6]*y;out[7]=a[7]*y;out[8]=a[8]*z;out[9]=a[9]*z;out[10]=a[10]*z;out[11]=a[11]*z;out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out};mat4.rotate=function(a,rad,axis,out){var x=axis[0],y=axis[1],z=axis[2],len=Math.sqrt(x*x+y*y+z*z),s,c,t,a00,a01,
a02,a03,a10,a11,a12,a13,a20,a21,a22,a23,b00,b01,b02,b10,b11,b12,b20,b21,b22;if(Math.abs(len)<GLMAT_EPSILON)return null;len=1/len;x*=len;y*=len;z*=len;s=Math.sin(rad);c=Math.cos(rad);t=1-c;a00=a[0];a01=a[1];a02=a[2];a03=a[3];a10=a[4];a11=a[5];a12=a[6];a13=a[7];a20=a[8];a21=a[9];a22=a[10];a23=a[11];b00=x*x*t+c;b01=y*x*t+z*s;b02=z*x*t-y*s;b10=x*y*t-z*s;b11=y*y*t+c;b12=z*y*t+x*s;b20=x*z*t+y*s;b21=y*z*t-x*s;b22=z*z*t+c;out[0]=a00*b00+a10*b01+a20*b02;out[1]=a01*b00+a11*b01+a21*b02;out[2]=a02*b00+a12*b01+
a22*b02;out[3]=a03*b00+a13*b01+a23*b02;out[4]=a00*b10+a10*b11+a20*b12;out[5]=a01*b10+a11*b11+a21*b12;out[6]=a02*b10+a12*b11+a22*b12;out[7]=a03*b10+a13*b11+a23*b12;out[8]=a00*b20+a10*b21+a20*b22;out[9]=a01*b20+a11*b21+a21*b22;out[10]=a02*b20+a12*b21+a22*b22;out[11]=a03*b20+a13*b21+a23*b22;if(a!==out){out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}return out};mat4.rotateX=function(a,rad,out){var s=Math.sin(rad),c=Math.cos(rad),a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],
a23=a[11];if(a!==out){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[4]=a10*c+a20*s;out[5]=a11*c+a21*s;out[6]=a12*c+a22*s;out[7]=a13*c+a23*s;out[8]=a20*c-a10*s;out[9]=a21*c-a11*s;out[10]=a22*c-a12*s;out[11]=a23*c-a13*s;return out};mat4.rotateY=function(a,rad,out){var s=Math.sin(rad),c=Math.cos(rad),a00=a[0],a01=a[1],a02=a[2],a03=a[3],a20=a[8],a21=a[9],a22=a[10],a23=a[11];if(a!==out){out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[12]=
a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[0]=a00*c-a20*s;out[1]=a01*c-a21*s;out[2]=a02*c-a22*s;out[3]=a03*c-a23*s;out[8]=a00*s+a20*c;out[9]=a01*s+a21*c;out[10]=a02*s+a22*c;out[11]=a03*s+a23*c;return out};mat4.rotateZ=function(a,rad,out){var s=Math.sin(rad),c=Math.cos(rad),a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7];if(a!==out){out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[0]=a00*c+a10*s;out[1]=
a01*c+a11*s;out[2]=a02*c+a12*s;out[3]=a03*c+a13*s;out[4]=a10*c-a00*s;out[5]=a11*c-a01*s;out[6]=a12*c-a02*s;out[7]=a13*c-a03*s;return out};mat4.fromTranslation=function(v,out){out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=1;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=1;out[11]=0;out[12]=v[0];out[13]=v[1];out[14]=v[2];out[15]=1;return out};mat4.fromScaling=function(v,out){out[0]=v[0];out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=v[1];out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=v[2];out[11]=0;out[12]=
0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.fromRotation=function(rad,axis,out){var x=axis[0],y=axis[1],z=axis[2],len=Math.sqrt(x*x+y*y+z*z),s,c,t;if(Math.abs(len)<GLMAT_EPSILON)return null;len=1/len;x*=len;y*=len;z*=len;s=Math.sin(rad);c=Math.cos(rad);t=1-c;out[0]=x*x*t+c;out[1]=y*x*t+z*s;out[2]=z*x*t-y*s;out[3]=0;out[4]=x*y*t-z*s;out[5]=y*y*t+c;out[6]=z*y*t+x*s;out[7]=0;out[8]=x*z*t+y*s;out[9]=y*z*t-x*s;out[10]=z*z*t+c;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.fromXRotation=
function(rad,out){var s=Math.sin(rad),c=Math.cos(rad);out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=c;out[6]=s;out[7]=0;out[8]=0;out[9]=-s;out[10]=c;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.fromYRotation=function(rad,out){var s=Math.sin(rad),c=Math.cos(rad);out[0]=c;out[1]=0;out[2]=-s;out[3]=0;out[4]=0;out[5]=1;out[6]=0;out[7]=0;out[8]=s;out[9]=0;out[10]=c;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.fromZRotation=function(rad,out){var s=Math.sin(rad),
c=Math.cos(rad);out[0]=c;out[1]=s;out[2]=0;out[3]=0;out[4]=-s;out[5]=c;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=1;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.fromRotationTranslation=function(q,v,out){var x=q[0],y=q[1],z=q[2],w=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;out[0]=1-(yy+zz);out[1]=xy+wz;out[2]=xz-wy;out[3]=0;out[4]=xy-wz;out[5]=1-(xx+zz);out[6]=yz+wx;out[7]=0;out[8]=xz+wy;out[9]=yz-wx;out[10]=1-(xx+yy);out[11]=
0;out[12]=v[0];out[13]=v[1];out[14]=v[2];out[15]=1;return out};mat4.fromQuat=function(q,out){var x=q[0],y=q[1],z=q[2],w=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,yx=y*x2,yy=y*y2,zx=z*x2,zy=z*y2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;out[0]=1-yy-zz;out[1]=yx+wz;out[2]=zx-wy;out[3]=0;out[4]=yx-wz;out[5]=1-xx-zz;out[6]=zy+wx;out[7]=0;out[8]=zx+wy;out[9]=zy-wx;out[10]=1-xx-yy;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.frustum=function(left,right,bottom,top,near,far,out){var rl=1/(right-left),
tb=1/(top-bottom),nf=1/(near-far);out[0]=near*2*rl;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=near*2*tb;out[6]=0;out[7]=0;out[8]=(right+left)*rl;out[9]=(top+bottom)*tb;out[10]=(far+near)*nf;out[11]=-1;out[12]=0;out[13]=0;out[14]=far*near*2*nf;out[15]=0;return out};mat4.perspective=function(fovy,aspect,near,far,out){var f=1/Math.tan(fovy/2),nf=1/(near-far);out[0]=f/aspect;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=f;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=(far+near)*nf;out[11]=-1;out[12]=0;out[13]=
0;out[14]=2*far*near*nf;out[15]=0;return out};mat4.perspectiveFromFieldOfView=function(fov,near,far,out){var upTan=Math.tan(fov.upDegrees*Math.PI/180),downTan=Math.tan(fov.downDegrees*Math.PI/180),leftTan=Math.tan(fov.leftDegrees*Math.PI/180),rightTan=Math.tan(fov.rightDegrees*Math.PI/180),xScale=2/(leftTan+rightTan),yScale=2/(upTan+downTan);out[0]=xScale;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=yScale;out[6]=0;out[7]=0;out[8]=-((leftTan-rightTan)*xScale*.5);out[9]=(upTan-downTan)*yScale*.5;out[10]=
far/(near-far);out[11]=-1;out[12]=0;out[13]=0;out[14]=far*near/(near-far);out[15]=0;return out};mat4.ortho=function(left,right,bottom,top,near,far,out){var lr=1/(left-right),bt=1/(bottom-top),nf=1/(near-far);out[0]=-2*lr;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=-2*bt;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=2*nf;out[11]=0;out[12]=(left+right)*lr;out[13]=(top+bottom)*bt;out[14]=(far+near)*nf;out[15]=1;return out};mat4.lookAt=function(eye,center,up,out){var x0,x1,x2,y0,y1,y2,z0,z1,z2,len,eyex=
eye[0],eyey=eye[1],eyez=eye[2],upx=up[0],upy=up[1],upz=up[2],centerx=center[0],centery=center[1],centerz=center[2];if(Math.abs(eyex-centerx)<GLMAT_EPSILON&&Math.abs(eyey-centery)<GLMAT_EPSILON&&Math.abs(eyez-centerz)<GLMAT_EPSILON)return mat4.identity(out);z0=eyex-centerx;z1=eyey-centery;z2=eyez-centerz;len=1/Math.sqrt(z0*z0+z1*z1+z2*z2);z0*=len;z1*=len;z2*=len;x0=upy*z2-upz*z1;x1=upz*z0-upx*z2;x2=upx*z1-upy*z0;len=Math.sqrt(x0*x0+x1*x1+x2*x2);if(!len){x0=0;x1=0;x2=0}else{len=1/len;x0*=len;x1*=len;
x2*=len}y0=z1*x2-z2*x1;y1=z2*x0-z0*x2;y2=z0*x1-z1*x0;len=Math.sqrt(y0*y0+y1*y1+y2*y2);if(!len){y0=0;y1=0;y2=0}else{len=1/len;y0*=len;y1*=len;y2*=len}out[0]=x0;out[1]=y0;out[2]=z0;out[3]=0;out[4]=x1;out[5]=y1;out[6]=z1;out[7]=0;out[8]=x2;out[9]=y2;out[10]=z2;out[11]=0;out[12]=-(x0*eyex+x1*eyey+x2*eyez);out[13]=-(y0*eyex+y1*eyey+y2*eyez);out[14]=-(z0*eyex+z1*eyey+z2*eyez);out[15]=1;return out};mat4.str=function(a){return"mat4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+
", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+")"};mat4.frob=function(a){return Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2)+Math.pow(a[3],2)+Math.pow(a[4],2)+Math.pow(a[5],2)+Math.pow(a[6],2)+Math.pow(a[7],2)+Math.pow(a[8],2)+Math.pow(a[9],2)+Math.pow(a[10],2)+Math.pow(a[11],2)+Math.pow(a[12],2)+Math.pow(a[13],2)+Math.pow(a[14],2)+Math.pow(a[15],2))};if(typeof exports!=="undefined")exports.mat4=mat4};b4w.module["mat4"]=b4w.module["__mat4"];b4w.module["__md5"]=function(exports,require){function md5cycle(x,k){var a=x[0],b=x[1],c=x[2],d=x[3];a=ff(a,b,c,d,k[0],7,-680876936);d=ff(d,a,b,c,k[1],12,-389564586);c=ff(c,d,a,b,k[2],17,606105819);b=ff(b,c,d,a,k[3],22,-1044525330);a=ff(a,b,c,d,k[4],7,-176418897);d=ff(d,a,b,c,k[5],12,1200080426);c=ff(c,d,a,b,k[6],17,-1473231341);b=ff(b,c,d,a,k[7],22,-45705983);a=ff(a,b,c,d,k[8],7,1770035416);d=ff(d,a,b,c,k[9],12,-1958414417);c=ff(c,d,a,b,k[10],17,-42063);b=ff(b,c,d,a,k[11],22,-1990404162);a=ff(a,
b,c,d,k[12],7,1804603682);d=ff(d,a,b,c,k[13],12,-40341101);c=ff(c,d,a,b,k[14],17,-1502002290);b=ff(b,c,d,a,k[15],22,1236535329);a=gg(a,b,c,d,k[1],5,-165796510);d=gg(d,a,b,c,k[6],9,-1069501632);c=gg(c,d,a,b,k[11],14,643717713);b=gg(b,c,d,a,k[0],20,-373897302);a=gg(a,b,c,d,k[5],5,-701558691);d=gg(d,a,b,c,k[10],9,38016083);c=gg(c,d,a,b,k[15],14,-660478335);b=gg(b,c,d,a,k[4],20,-405537848);a=gg(a,b,c,d,k[9],5,568446438);d=gg(d,a,b,c,k[14],9,-1019803690);c=gg(c,d,a,b,k[3],14,-187363961);b=gg(b,c,d,a,k[8],
20,1163531501);a=gg(a,b,c,d,k[13],5,-1444681467);d=gg(d,a,b,c,k[2],9,-51403784);c=gg(c,d,a,b,k[7],14,1735328473);b=gg(b,c,d,a,k[12],20,-1926607734);a=hh(a,b,c,d,k[5],4,-378558);d=hh(d,a,b,c,k[8],11,-2022574463);c=hh(c,d,a,b,k[11],16,1839030562);b=hh(b,c,d,a,k[14],23,-35309556);a=hh(a,b,c,d,k[1],4,-1530992060);d=hh(d,a,b,c,k[4],11,1272893353);c=hh(c,d,a,b,k[7],16,-155497632);b=hh(b,c,d,a,k[10],23,-1094730640);a=hh(a,b,c,d,k[13],4,681279174);d=hh(d,a,b,c,k[0],11,-358537222);c=hh(c,d,a,b,k[3],16,-722521979);
b=hh(b,c,d,a,k[6],23,76029189);a=hh(a,b,c,d,k[9],4,-640364487);d=hh(d,a,b,c,k[12],11,-421815835);c=hh(c,d,a,b,k[15],16,530742520);b=hh(b,c,d,a,k[2],23,-995338651);a=ii(a,b,c,d,k[0],6,-198630844);d=ii(d,a,b,c,k[7],10,1126891415);c=ii(c,d,a,b,k[14],15,-1416354905);b=ii(b,c,d,a,k[5],21,-57434055);a=ii(a,b,c,d,k[12],6,1700485571);d=ii(d,a,b,c,k[3],10,-1894986606);c=ii(c,d,a,b,k[10],15,-1051523);b=ii(b,c,d,a,k[1],21,-2054922799);a=ii(a,b,c,d,k[8],6,1873313359);d=ii(d,a,b,c,k[15],10,-30611744);c=ii(c,d,
a,b,k[6],15,-1560198380);b=ii(b,c,d,a,k[13],21,1309151649);a=ii(a,b,c,d,k[4],6,-145523070);d=ii(d,a,b,c,k[11],10,-1120210379);c=ii(c,d,a,b,k[2],15,718787259);b=ii(b,c,d,a,k[9],21,-343485551);x[0]=add32(a,x[0]);x[1]=add32(b,x[1]);x[2]=add32(c,x[2]);x[3]=add32(d,x[3])}function cmn(q,a,b,x,s,t){a=add32(add32(a,q),add32(x,t));return add32(a<<s|a>>>32-s,b)}function ff(a,b,c,d,x,s,t){return cmn(b&c|~b&d,a,b,x,s,t)}function gg(a,b,c,d,x,s,t){return cmn(b&d|c&~d,a,b,x,s,t)}function hh(a,b,c,d,x,s,t){return cmn(b^
c^d,a,b,x,s,t)}function ii(a,b,c,d,x,s,t){return cmn(c^(b|~d),a,b,x,s,t)}function md51(s){var n=s.length,state=[1732584193,-271733879,-1732584194,271733878],i;for(i=64;i<=s.length;i+=64)md5cycle(state,md5blk(s.substring(i-64,i)));s=s.substring(i-64);var tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(i=0;i<s.length;i++)tail[i>>2]|=s.charCodeAt(i)<<(i%4<<3);tail[i>>2]|=128<<(i%4<<3);if(i>55){md5cycle(state,tail);for(i=0;i<16;i++)tail[i]=0}tail[14]=n*8;md5cycle(state,tail);return state}function md5blk(s){var md5blks=
[],i;for(i=0;i<64;i+=4)md5blks[i>>2]=s.charCodeAt(i)+(s.charCodeAt(i+1)<<8)+(s.charCodeAt(i+2)<<16)+(s.charCodeAt(i+3)<<24);return md5blks}var hex_chr="0123456789abcdef".split("");function rhex(n){var s="",j=0;for(;j<4;j++)s+=hex_chr[n>>j*8+4&15]+hex_chr[n>>j*8&15];return s}function hex(x){for(var i=0;i<x.length;i++)x[i]=rhex(x[i]);return x.join("")}function add32(a,b){return a+b&4294967295}exports.hexdigest=function(msg){return hex(md51(msg))}};b4w.module["shader_texts"]=function(exports,require){exports["anchors.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["void","main","(",")","{","gl_FragColor","=","vec4","(","1.0",")",";","}"]}]},exports["anchors.glslv"]={type:"group",parts:[{type:"var",name:"ANCHOR_NUM",tokens:["0"]},{type:"textline",tokens:["attribute","float","a_index",";","uniform","vec3","u_position","[","ANCHOR_NUM","]",";","uniform","mat4","u_view_matrix",";","uniform",
"mat4","u_proj_matrix",";","void","main","(",")","{","vec4","a","=","u_view_matrix","*","vec4","(","u_position","[","int","(","a_index",")","]",",","1.0",")",";","gl_Position","=","u_proj_matrix","*","a",";","gl_PointSize","=","4.0",";","}"]}]},exports["color_id.glslf"]={type:"group",parts:[{type:"var",name:"WATER_LEVEL",tokens:["0.0"]},{type:"var",name:"WAVES_HEIGHT",tokens:["0.0"]},{type:"var",name:"NUM_LAMP_LIGHTS",tokens:["0"]},{type:"var",name:"NUM_VALUES",tokens:["0"]},{type:"var",name:"NUM_RGBS",
tokens:["0"]},{type:"var",name:"MAPPING_TRS_MATRIX",tokens:["mat4","(","0.0",")"]},{type:"var",name:"MAPPING_SCALE",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_TRANSLATION",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_MIN_CLIP",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_MAX_CLIP",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_IS_NORMAL",tokens:["0.0"]},{type:"var",name:"RGB_IND",tokens:["0"]},{type:"var",name:"VALUE_IND",tokens:["0"]},{type:"var",name:"LAMP_INDEX",
tokens:["0"]},{type:"var",name:"NUM_LIGHTS",tokens:["0"]},{type:"var",name:"LAMP_IND",tokens:["0"]},{type:"var",name:"LAMP_SPOT_SIZE",tokens:["0"]},{type:"var",name:"LAMP_SPOT_BLEND",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_DIST",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_FACT_IND",tokens:["0"]},{type:"var",name:"LAMP_FAC_CHANNELS",tokens:["rgb"]},{type:"var",name:"LAMP_SHADOW_MAP_IND",tokens:["0"]},{type:"var",name:"NUM_LFACTORS",tokens:["0"]},{type:"include",file:"precision_statement.glslf"},
{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"include",file:"std_enums.glsl"},{type:"include",file:"pack.glslf"},{type:"include",file:"procedural.glslf"},{type:"condition",parts:[{type:"if",expression:["CAUSTICS"],group:{type:"group",parts:[{type:"include",file:"caustics.glslf"}]}}]},{type:"include",file:"gamma.glslf"},{type:"include",file:"math.glslv"}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES",
"ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_time",";","uniform","float","u_environment_energy",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_LIGHTS",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_light_positions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_directions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_color_intensities","[","NUM_LIGHTS",
"]",";","uniform","vec4","u_light_factors","[","NUM_LFACTORS","]",";"]}]}}]},{type:"textline",tokens:["uniform","vec3","u_camera_eye_frag",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_VECTOR_VIEW","REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_view_matrix_frag",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ENVIRONMENT_LIGHT","SKY_TEXTURE",
{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_sky_texture",";"]}]}},{type:"elif",expression:["USE_ENVIRONMENT_LIGHT","SKY_COLOR",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_horizon_color",";","uniform","vec3","u_zenith_color",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_diffuse_color",";"]},{type:"condition",parts:[{type:"if",
expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_sampler",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_OUTLINE",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_color_id",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE",
"REFL_PLANE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_plane_reflection",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_CUBE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_cube_reflection",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_MIRRORMAP",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube",
"u_mirrormap",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_refractmap",";"]},{type:"condition",parts:[{type:"if",expression:["USE_REFRACTION"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_scene_depth",";"]}]}}]}]}}]},{type:"textline",tokens:["uniform","float","u_emit",";","uniform","float","u_ambient",";","uniform","vec4","u_fresnel_params",
";"]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_MIRRORMAP",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_mirror_factor",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_refl_plane",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_LAMP"],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","vec3","u_lamp_light_positions","[","NUM_LAMP_LIGHTS","]",";","uniform","vec3","u_lamp_light_directions","[","NUM_LAMP_LIGHTS","]",";","uniform","vec3","u_lamp_light_color_intensities","[","NUM_LAMP_LIGHTS","]",";","uniform","vec4","u_lamp_light_factors","[","NUM_LAMP_LIGHTS","]",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_VALUE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_node_values","[","NUM_VALUES","]",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["USE_NODE_RGB"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_node_rgbs","[","NUM_RGBS","]",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_OUTLINE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_outline_intensity",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bQ",
";","varying","vec4","bR",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE",{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bS",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bT",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",
{type:"equal_expr",places:2},"USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bU",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION","USE_REFRACTION",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","float","bV",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2}],
group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_perspective_cast_far_bound",";","varying","vec4","bW",";","varying","vec4","bX",";","varying","vec4","bY",";","varying","vec4","bZ",";","uniform","float","u_perspective_cast_far_bound",";","uniform","vec4","u_pcf_blur_radii",";","uniform","vec4","u_csm_center_dists",";","uniform","sampler2D","u_shadow_map0",";","uniform","sampler2D","u_shadow_map1",";","uniform","sampler2D","u_shadow_map2",";","uniform","sampler2D","u_shadow_map3",
";","uniform","sampler2D","u_shadow_mask",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","b_",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"include",file:"shadow.glslf"},{type:"include",file:"mirror.glslf"},{type:"include",file:"environment.glslf"},{type:"condition",
parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["USE_REFRACTION"],group:{type:"group",parts:[{type:"include",file:"refraction.glslf"}]}}]}]}}]},{type:"include",file:"nodes.glslf"}]}}]},{type:"textline",tokens:["void","main","(",")","{"]},{type:"condition",parts:[{type:"if",expression:["ALPHA"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["NODES"],group:{type:"group",parts:[{type:"textline",
tokens:["vec3","tA","=","u_camera_eye_frag","-","bQ",";","vec3","tB","=","normalize","(","tA",")",";","vec3","tC",";","vec3","tD",";","vec3","tE",";","float","tF",";","float","tG",";","tz","(","tB",",","tC",",","tD",",","tE",",","tF",",","tG",")",";","float","tH","=","tG",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["float","tH","=","(","texture2D","(","u_sampler",",","b_",")",
")",".","a",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["float","tH","=","u_diffuse_color",".","a",";"]}]}}]}]}}]},{type:"textline",tokens:["if","(","tH","<","0.5",")","discard",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_OUTLINE"],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","vec4","(","1.0",",","1.0",",","1.0",",","u_outline_intensity",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor",
"=","vec4","(","u_color_id",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["}"]}]},exports["color_id.glslv"]={type:"group",parts:[{type:"var",name:"AU_QUALIFIER",tokens:["uniform"]},{type:"var",name:"MAX_BONES",tokens:["0"]},{type:"var",name:"VERTEX_ANIM_MIX_NORMALS_FACTOR",tokens:["u_va_frame_factor"]},{type:"include",file:"std_enums.glsl"},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"include",file:"scale_texcoord.glslv"},
{type:"textline",tokens:["attribute","vec3","a_position",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},{type:"logical_or_expr",places:5}],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_normal",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",
parts:[{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_tangent",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_influence",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MAIN_BEND_COL"],group:{type:"group",parts:[{type:"textline",
tokens:["attribute","float","a_bending_col_main",";"]},{type:"condition",parts:[{type:"if",expression:["DETAIL_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_bending_col_detail",";","AU_QUALIFIER","float","au_detail_bending_amp",";","AU_QUALIFIER","float","au_branch_bending_amp",";","AU_QUALIFIER","float","au_detail_bending_freq",";"]}]}}]}]}}]},{type:"textline",tokens:["AU_QUALIFIER","float","au_wind_bending_amp",";","AU_QUALIFIER","float","au_wind_bending_freq",
";"]},{type:"condition",parts:[{type:"if",expression:["BEND_CENTER_ONLY"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_emitter_center",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","BILLBOARD",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["AU_QUALIFIER","vec3","au_center_pos",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["attribute",
"vec3","a_position_next",";"]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE",{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_normal_next",";"]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",
tokens:["attribute","vec4","a_tangent_next",";"]}]}}]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec2","a_texcoord",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["STATIC_BATCH"],group:{type:"group",parts:[{type:"textline",tokens:["const","mat4","u_model_matrix","=","mat4","(","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_model_matrix",
";"]}]}}]},{type:"textline",tokens:["uniform","mat4","u_view_matrix",";","uniform","mat4","u_proj_matrix",";"]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_camera_eye",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["SMAA_JITTER"],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","vec2","u_subpixel_jitter",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","float","u_view_max_depth",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsb","[","MAX_BONES","]",";","uniform","vec4","u_transb","[","MAX_BONES","]",";","uniform","vec4","u_arm_rel_trans",";",
"uniform","vec4","u_arm_rel_quat",";"]},{type:"condition",parts:[{type:"if",expression:["FRAMES_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsa","[","MAX_BONES","]",";","uniform","vec4","u_transa","[","MAX_BONES","]",";","uniform","float","u_frame_factor",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["BILLBOARD_JITTERED"],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","float","u_jitter_amp",";","uniform","float","u_jitter_freq",";"]}]}}]},{type:"textline",tokens:["uniform","vec3","u_wind",";","uniform","float","u_time",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_va_frame_factor",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_texture_scale",";"]}]}}]},
{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bQ",";","varying","vec4","bR",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},{type:"logical_or_expr",places:5}],group:{type:"group",parts:[{type:"textline",tokens:["varying",
"vec3","bS",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bT",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bU",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION",
"REFRACTIVE",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","float","bV",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","b_",";"]}]}}]}]}}]},{type:"include",file:"skin.glslv"},{type:"include",file:"wind_bending.glslv"},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],
group:{type:"group",parts:[{type:"include",file:"nodes.glslv"}]}}]},{type:"textline",tokens:["void","main","(",")","{","vec3","wB","=","a_position",";"]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA","CALC_TBN_SPACE","USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},{type:"logical_or_expr",places:5},{type:"logical_and_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["vec3",
"wC","=","a_normal",";"]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","wD","=","vec3","(","a_tangent",")",";","vec3","wE","=","a_tangent","[","3","]","*","cross","(","wC",",","wD",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","wD","=","vec3","(","0.0",")",";","vec3","wE","=","vec3","(","0.0",")",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3",
"wC","=","vec3","(","0.0",")",";","vec3","wD","=","vec3","(","0.0",")",";","vec3","wE","=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["wB","=","mix","(","wB",",","a_position_next",",","u_va_frame_factor",")",";"]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN",
"USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE",{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["wC","=","mix","(","wC",",","a_normal_next",",","VERTEX_ANIM_MIX_NORMALS_FACTOR",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","wF","=","vec3","(","a_tangent",")",";","vec3","wG","=","a_tangent_next","[","3","]","*","cross","(","a_normal_next",",","wF",")",";","wD","=",
"mix","(","wD",",","wF",",","u_va_frame_factor",")",";","wE","=","mix","(","wE",",","wG",",","u_va_frame_factor",")",";"]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["vD","(","wB",",","wD",",","wE",",","wC",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","BILLBOARD",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","wH","=","au_center_pos",";"]}]}},
{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","wH","=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","wI","=","(","u_model_matrix","*","vec4","(","wH",",","1.0",")",")",".","xyz",";"]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD_PRES_GLOB_ORIENTATION","STATIC_BATCH",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",
parts:[{type:"textline",tokens:["mat4","wJ","=","um","(","u_camera_eye",",","wI",",","u_view_matrix",",","u_model_matrix",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["mat4","wJ","=","ug","(","u_camera_eye",",","wI",",","u_view_matrix",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","BILLBOARD_JITTERED",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","wK","=","(","u_model_matrix","*","vec4",
"(","wH",",","1.0",")",")",".","xyz",";","wJ","=","wJ","*","tW","(","u_wind",",","u_time",",","u_jitter_amp",",","u_jitter_freq",",","wK",")",";"]}]}}]},{type:"textline",tokens:["bh","wL","=","ut","(","wB","-","wH",",","wH",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","wJ",")",";","wL",".","b","=","wI",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["bh","wL","=","ut","(","wB",",","wH",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",",
"vec3","(","0.0",")",",","u_model_matrix",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["wv","(","wL",".","a",",","wL",".","b",",","wC",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","wM","=","a_normal",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","wM","=","vec3","(","0.0",")",";"]}]}}]},{type:"textline",tokens:["wv","(","wL",".","a",",","wL",".","b",",","wM",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2},{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",
expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["b_","=","uw","(","a_texcoord",",","u_texture_scale",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["bQ","=","wL",".","a",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",
{type:"logical_and_expr",places:3},{type:"logical_or_expr",places:5}],group:{type:"group",parts:[{type:"textline",tokens:["bS","=","wL",".","e",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["float","wN","=","(","dot","(","cross","(","wL",".","e",",","wL",".","c",")",",","wL",".","d",")","<","0.0",")","?","-","1.0",":","1.0",";","bT","=","vec4","(","wL",".","c",",","wN",")",";"]}]}}]},{type:"textline",tokens:["bR","=",
"u_view_matrix","*","vec4","(","wL",".","a",",","1.0",")",";","vec4","wO","=","u_proj_matrix","*","bR",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_JITTER"],group:{type:"group",parts:[{type:"textline",tokens:["wO",".","xy","+=","u_subpixel_jitter","*","wO",".","w",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["float","wP","=","wO",".","x",";","float","wQ","=","wO",".","y",";","float","wR","=","wO",".","w",";","bU",".","x","=","(","wP","+","wR",")","/","2.0",";","bU",".","y","=","(","wQ","+","wR",")","/","2.0",";","bU",".","z","=","wR",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION","REFRACTIVE",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["bV","=","-","bR",".","z","/","u_view_max_depth",";"]}]}}]},{type:"textline",
tokens:["wA","(",")",";"]}]}}]},{type:"textline",tokens:["gl_Position","=","u_proj_matrix","*","u_view_matrix","*","vec4","(","wL",".","a",",","1.0",")",";","}"]}]},exports["depth.glslf"]={type:"group",parts:[{type:"var",name:"WATER_LEVEL",tokens:["0.0"]},{type:"var",name:"WAVES_HEIGHT",tokens:["0.0"]},{type:"var",name:"NUM_LAMP_LIGHTS",tokens:["0"]},{type:"var",name:"NUM_VALUES",tokens:["0"]},{type:"var",name:"NUM_RGBS",tokens:["0"]},{type:"var",name:"MAPPING_TRS_MATRIX",tokens:["mat4","(","0.0",
")"]},{type:"var",name:"MAPPING_SCALE",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_TRANSLATION",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_MIN_CLIP",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_MAX_CLIP",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_IS_NORMAL",tokens:["0.0"]},{type:"var",name:"RGB_IND",tokens:["0"]},{type:"var",name:"VALUE_IND",tokens:["0"]},{type:"var",name:"LAMP_INDEX",tokens:["0"]},{type:"var",name:"NUM_LIGHTS",tokens:["0"]},{type:"var",
name:"LAMP_IND",tokens:["0"]},{type:"var",name:"LAMP_SPOT_SIZE",tokens:["0"]},{type:"var",name:"LAMP_SPOT_BLEND",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_DIST",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_FACT_IND",tokens:["0"]},{type:"var",name:"LAMP_FAC_CHANNELS",tokens:["rgb"]},{type:"var",name:"LAMP_SHADOW_MAP_IND",tokens:["0"]},{type:"var",name:"NUM_LFACTORS",tokens:["0"]},{type:"include",file:"std_enums.glsl"},{type:"include",file:"precision_statement.glslf"},{type:"condition",parts:[{type:"if",
expression:["SHADELESS",{type:"logic_negative_expr",places:1},"NODES","ALPHA",{type:"logical_and_expr",places:2},"SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2},{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"include",file:"procedural.glslf"}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"include",file:"pack.glslf"},{type:"condition",parts:[{type:"if",expression:["CAUSTICS"],
group:{type:"group",parts:[{type:"include",file:"caustics.glslf"}]}}]},{type:"include",file:"gamma.glslf"},{type:"include",file:"math.glslv"}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_time",";","uniform","float","u_environment_energy",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_LIGHTS",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","vec3","u_light_positions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_directions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_color_intensities","[","NUM_LIGHTS","]",";","uniform","vec4","u_light_factors","[","NUM_LFACTORS","]",";"]}]}}]},{type:"textline",tokens:["uniform","vec3","u_camera_eye_frag",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_VECTOR_VIEW","REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],
group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_view_matrix_frag",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ENVIRONMENT_LIGHT","SKY_TEXTURE",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_sky_texture",";"]}]}},{type:"elif",expression:["USE_ENVIRONMENT_LIGHT","SKY_COLOR",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_horizon_color",
";","uniform","vec3","u_zenith_color",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_plane_reflection",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_CUBE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_cube_reflection",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_MIRRORMAP",
{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_mirrormap",";"]}]}}]},{type:"textline",tokens:["uniform","float","u_emit",";","uniform","float","u_ambient",";","uniform","vec4","u_fresnel_params",";"]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_MIRRORMAP",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_mirror_factor",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE",
"REFL_PLANE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_refl_plane",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_LAMP"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_lamp_light_positions","[","NUM_LAMP_LIGHTS","]",";","uniform","vec3","u_lamp_light_directions","[","NUM_LAMP_LIGHTS","]",";","uniform","vec3","u_lamp_light_color_intensities","[","NUM_LAMP_LIGHTS","]",";","uniform","vec4","u_lamp_light_factors",
"[","NUM_LAMP_LIGHTS","]",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_VALUE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_node_values","[","NUM_VALUES","]",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_RGB"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_node_rgbs","[","NUM_RGBS","]",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],
group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_colormap0",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_diffuse_color",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["PERSPECTIVE_SHADOW_CAST"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float",
"u_perspective_cast_far_bound",";"]}]}}]},{type:"textline",tokens:["uniform","vec4","u_pcf_blur_radii",";","uniform","vec4","u_csm_center_dists",";","uniform","PRECISION","sampler2D","u_shadow_map0",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_shadow_map1",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["uniform",
"PRECISION","sampler2D","u_shadow_map2",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_shadow_map3",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MAPPING_OPAQUE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_shadow_mask",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION"],
group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_refractmap",";"]},{type:"condition",parts:[{type:"if",expression:["USE_REFRACTION"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_scene_depth",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bQ",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN",
"USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE",{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bS",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bT",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","b_",
";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2},"NODES","ALPHA",{type:"logical_and_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bR",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bW",";"]},
{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bX",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bY",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bZ",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE",
"REFL_PLANE",{type:"equal_expr",places:2},"USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bU",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION","USE_REFRACTION",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying",
"float","bV",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADELESS",{type:"logic_negative_expr",places:1},"NODES","ALPHA",{type:"logical_and_expr",places:2},"SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2},{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"include",file:"shadow.glslf"}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"include",file:"mirror.glslf"},
{type:"include",file:"environment.glslf"},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["USE_REFRACTION"],group:{type:"group",parts:[{type:"include",file:"refraction.glslf"}]}}]}]}}]},{type:"include",file:"nodes.glslf"}]}}]},{type:"textline",tokens:["void","main","(",")","{"]},{type:"condition",parts:[{type:"if",expression:["ALPHA"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",
expression:["NODES"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","wB","=","u_camera_eye_frag","-","bQ",";","vec3","wC","=","normalize","(","wB",")",";","vec3","wD",";","vec3","wE",";","vec3","wF",";","float","wG",";","float","wH",";","tz","(","wC",",","wD",",","wE",",","wF",",","wG",",","wH",")",";","float","wI","=","wH",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["float",
"wI","=","(","texture2D","(","u_colormap0",",","b_",")",")",".","a",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["float","wI","=","u_diffuse_color",".","a",";"]}]}}]}]}}]},{type:"textline",tokens:["if","(","wI","<","0.5",")","discard",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","NO_SHADOWS",{type:"equal_expr",places:2},"SHADOW_USAGE","SHADOW_CASTING",{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["gl_FragColor","=","vec4","(","1.0",")",";"]}]}},{type:"elif",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","vec4","(","dT","(","bR",".","z",")",",","1.0",",","1.0",",","1.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",
parts:[{type:"textline",tokens:["gl_FragColor",".","a","+=","0.00001","*","bT",".","r",";"]}]}}]}]}}]},{type:"textline",tokens:["}"]}]},exports["depth.glslv"]={type:"group",parts:[{type:"var",name:"AU_QUALIFIER",tokens:["uniform"]},{type:"var",name:"MAX_BONES",tokens:["0"]},{type:"var",name:"SHADOW_TEX_RES",tokens:["0.0"]},{type:"var",name:"VERTEX_ANIM_MIX_NORMALS_FACTOR",tokens:["u_va_frame_factor"]},{type:"include",file:"std_enums.glsl"},{type:"include",file:"precision_statement.glslf"},{type:"include",
file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"include",file:"scale_texcoord.glslv"},{type:"textline",tokens:["attribute","vec3","a_position",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},"SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2},{type:"logical_or_expr",places:6}],group:{type:"group",parts:[{type:"textline",
tokens:["attribute","vec3","a_normal",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA","CALC_TBN_SPACE",{type:"logical_and_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_tangent",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_influence",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","DYNAMIC_GRASS","BILLBOARD",
{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["AU_QUALIFIER","vec3","au_center_pos",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MAIN_BEND_COL"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","float","a_bending_col_main",";"]},{type:"condition",parts:[{type:"if",expression:["DETAIL_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["attribute",
"vec3","a_bending_col_detail",";","AU_QUALIFIER","float","au_detail_bending_amp",";","AU_QUALIFIER","float","au_branch_bending_amp",";","AU_QUALIFIER","float","au_detail_bending_freq",";"]}]}}]}]}}]},{type:"textline",tokens:["AU_QUALIFIER","float","au_wind_bending_amp",";","AU_QUALIFIER","float","au_wind_bending_freq",";"]},{type:"condition",parts:[{type:"if",expression:["BEND_CENTER_ONLY"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_emitter_center",";"]}]}}]}]}}]},{type:"condition",
parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_position_next",";"]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE",{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_normal_next",
";"]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_tangent_next",";"]}]}}]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2},{type:"logic_negative_expr",places:1},"TEXTURE_COLOR",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec2","a_texcoord",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["STATIC_BATCH"],group:{type:"group",parts:[{type:"textline",tokens:["const","mat4","u_model_matrix","=","mat4","(","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_model_matrix",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_JITTER"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec2","u_subpixel_jitter",";"]}]}}]},{type:"textline",tokens:["uniform","mat4","u_view_matrix",";","uniform","mat4","u_proj_matrix",
";"]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS","BILLBOARD",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_camera_eye",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD","SHADOW_USAGE","SHADOW_CASTING",{type:"equal_expr",places:2},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_shadow_cast_billboard_view_matrix",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["DYNAMIC_GRASS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_grass_map_depth",";","uniform","sampler2D","u_grass_map_color",";","uniform","vec4","u_camera_quat",";","uniform","vec3","u_grass_map_dim",";","uniform","float","u_grass_size",";","uniform","float","u_scale_threshold",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsb",
"[","MAX_BONES","]",";","uniform","vec4","u_transb","[","MAX_BONES","]",";","uniform","vec4","u_arm_rel_trans",";","uniform","vec4","u_arm_rel_quat",";"]},{type:"condition",parts:[{type:"if",expression:["FRAMES_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsa","[","MAX_BONES","]",";","uniform","vec4","u_transa","[","MAX_BONES","]",";","uniform","float","u_frame_factor",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",
parts:[{type:"condition",parts:[{type:"if",expression:["BILLBOARD_JITTERED"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_jitter_amp",";","uniform","float","u_jitter_freq",";"]}]}}]},{type:"textline",tokens:["uniform","vec3","u_wind",";","uniform","float","u_time",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_va_frame_factor",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["NODES","ALPHA",{type:"logical_and_expr",places:2},{type:"logic_negative_expr",places:1},"TEXTURE_COLOR",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_texture_scale",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_normal_offset",";","uniform","mat4","u_v_light_matrix",";",
"uniform","mat4","u_b_light_matrix",";","uniform","mat4","u_p_light_matrix0",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_p_light_matrix1",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_p_light_matrix2",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","mat4","u_p_light_matrix3",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","float","u_view_max_depth",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bQ",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN",
"USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},{type:"logical_or_expr",places:5}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bS",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bT",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],
group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","b_",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2},"NODES","ALPHA",{type:"logical_and_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bR",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2}],group:{type:"group",
parts:[{type:"textline",tokens:["varying","vec4","bW",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bX",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bY",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bZ",";"]}]}}]}]}}]},
{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bU",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION","REFRACTIVE",{type:"logical_and_expr",places:2}],
group:{type:"group",parts:[{type:"textline",tokens:["varying","float","bV",";"]}]}}]}]}}]},{type:"include",file:"dynamic_grass.glslv"},{type:"include",file:"shadow.glslv"},{type:"include",file:"skin.glslv"},{type:"include",file:"wind_bending.glslv"},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"include",file:"nodes.glslv"}]}}]},{type:"textline",tokens:["void","main","(",")","{","vec3","xA","=","a_position",";"]},
{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2},"CALC_TBN_SPACE","USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},{type:"logical_or_expr",places:6}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","xB","=","a_normal",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","xB","=","vec3","(","0.0",")",";"]}]}}]},
{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA","CALC_TBN_SPACE",{type:"logical_and_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","xC","=","vec3","(","a_tangent",")",";","vec3","xD","=","a_tangent","[","3","]","*","cross","(","xB",",","xC",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","xC","=","vec3","(","0.0",")",";","vec3","xD","=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],
group:{type:"group",parts:[{type:"textline",tokens:["xA","=","mix","(","xA",",","a_position_next",",","u_va_frame_factor",")",";"]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE",{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["xB","=","mix","(","xB",",","a_normal_next",
",","VERTEX_ANIM_MIX_NORMALS_FACTOR",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","xE","=","vec3","(","a_tangent",")",";","vec3","xF","=","a_tangent_next","[","3","]","*","cross","(","a_normal_next",",","xE",")",";","xC","=","mix","(","xC",",","xE",",","u_va_frame_factor",")",";","xD","=","mix","(","xD",",","xF",",","u_va_frame_factor",")",";"]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],
group:{type:"group",parts:[{type:"textline",tokens:["vD","(","xA",",","xC",",","xD",",","xB",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","DYNAMIC_GRASS","BILLBOARD",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","xG","=","au_center_pos",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","xG","=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS"],
group:{type:"group",parts:[{type:"textline",tokens:["bh","xH","=","xp","(","xA",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","xB",",","xG",",","u_grass_map_depth",",","u_grass_map_color",",","u_grass_map_dim",",","u_grass_size",",","u_camera_eye",",","u_camera_quat",",","u_view_matrix",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","xI","=","(","u_model_matrix","*",
"vec4","(","xG",",","1.0",")",")",".","xyz",";"]},{type:"condition",parts:[{type:"if",expression:["HAIR_BILLBOARD",{type:"logic_negative_expr",places:1},"SHADOW_USAGE","SHADOW_CASTING",{type:"equal_expr",places:2},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["mat4","xJ","=","u_shadow_cast_billboard_view_matrix",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["mat4","xJ","=","u_view_matrix",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["BILLBOARD_PRES_GLOB_ORIENTATION","STATIC_BATCH",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["mat4","xK","=","um","(","u_camera_eye",",","xI",",","xJ",",","u_model_matrix",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["mat4","xK","=","ug","(","u_camera_eye",",","xI",",","xJ",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","BILLBOARD_JITTERED",{type:"logical_and_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","xL","=","(","u_model_matrix","*","vec4","(","xG",",","1.0",")",")",".","xyz",";","xK","=","xK","*","tW","(","u_wind",",","u_time",",","u_jitter_amp",",","u_jitter_freq",",","xL",")",";"]}]}}]},{type:"textline",tokens:["bh","xH","=","ut","(","xA","-","xG",",","xG",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","xB",",","xK",")",";","xH",".","b","=","xI",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["bh",
"xH","=","ut","(","xA",",","xG",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","xB",",","u_model_matrix",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","xM","=","a_normal",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","xM","=",
"vec3","(","0.0",")",";"]}]}}]},{type:"textline",tokens:["wv","(","xH",".","a",",","xH",".","b",",","xM",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["bQ","=","xH",".","a",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},
{type:"logical_or_expr",places:5}],group:{type:"group",parts:[{type:"textline",tokens:["bS","=","xH",".","e",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["float","xN","=","(","dot","(","cross","(","xH",".","e",",","xH",".","c",")",",","xH",".","d",")","<","0.0",")","?","-","1.0",":","1.0",";","bT","=","vec4","(","xH",".","c",",","xN",")",";"]}]}}]}]}}]},{type:"textline",tokens:["vec4","xO","=","u_view_matrix","*",
"vec4","(","xH",".","a",",","1.0",")",";","vec4","xP","=","u_proj_matrix","*","xO",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_JITTER"],group:{type:"group",parts:[{type:"textline",tokens:["xP",".","xy","+=","u_subpixel_jitter","*","xP",".","w",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},
"USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["bU","=","bP","(","xP",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION","REFRACTIVE",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["bV","=","-","bR",".","z","/","u_view_max_depth",";"]}]}}]},{type:"textline",tokens:["wA","(",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",
expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["b_","=","uw","(","a_texcoord",",","u_texture_scale",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["xz","(","xH",".","a",",","xH",".","e",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2},"NODES",
"ALPHA",{type:"logical_and_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["bR","=","xO",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_CASTING",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec2","xQ","=","(","u_proj_matrix","*","u_view_matrix","[","3","]",")",".","xy",";","float","xR","=","SHADOW_TEX_RES","/","2.0",";","xQ","=","floor","(","xQ","*","xR","+","0.5",")","/",
"xR","-","xQ",";","xP",".","xy","+=","xQ",";"]}]}}]},{type:"textline",tokens:["gl_Position","=","xP",";","}"]}]},exports["grass_map.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_SIZE"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","xA",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",
tokens:["varying","float","xA",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","xA",";"]}]}}]}]}}]},{type:"textline",tokens:["void","main","(",")","{"]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_SIZE"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",
tokens:["gl_FragColor","=","xA",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","vec4","(","xA",",","vec3","(","1.0",")",")",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","vec4","(","1.0",",","xA",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","vec4","(","1.0",
")",";"]}]}}]}]}}]},{type:"textline",tokens:["}"]}]},exports["grass_map.glslv"]={type:"group",parts:[{type:"include",file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"textline",tokens:["attribute","vec3","a_position",";"]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_SIZE"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","float","a_grass_size",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",
tokens:["attribute","vec3","a_grass_color",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["STATIC_BATCH"],group:{type:"group",parts:[{type:"textline",tokens:["const","mat4","u_model_matrix","=","mat4","(","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_model_matrix",";"]}]}}]},{type:"textline",tokens:["uniform","mat4","u_view_matrix",";","uniform","mat4","u_proj_matrix",";"]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD"],
group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_camera_eye",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","BILLBOARD_JITTERED",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_wind",";","uniform","float","u_time",";","uniform","float","u_jitter_amp",";","uniform","float","u_jitter_freq",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_SIZE"],group:{type:"group",parts:[{type:"condition",
parts:[{type:"if",expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","xA",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["varying","float","xA",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","xA",";"]}]}}]}]}}]},{type:"textline",tokens:["void","main","(",")","{"]},{type:"condition",
parts:[{type:"if",expression:["BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","xB","=","(","u_model_matrix","*","vec4","(","vec3","(","0.0",")",",","1.0",")",")",".","xyz",";","mat4","xC","=","ug","(","u_camera_eye",",","xB",",","u_view_matrix",")",";"]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","BILLBOARD_JITTERED",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["xC","=","xC","*","tW","(","u_wind",",","u_time",",",
"u_jitter_amp",",","u_jitter_freq",",","vec3","(","0.0",")",")",";"]}]}}]},{type:"textline",tokens:["bh","xD","=","ut","(","a_position",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","xC",")",";","xD",".","b","=","xB",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["bh","xD","=","ut","(","a_position",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","u_model_matrix",
")",";"]}]}}]},{type:"textline",tokens:["vec4","xE","=","u_proj_matrix","*","u_view_matrix","*","vec4","(","xD",".","a",",","1.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_SIZE"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["xA","=","vec4","(","a_grass_size",",","a_grass_color",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["xA","=",
"a_grass_size",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["xA","=","a_grass_color",";"]}]}}]}]}}]},{type:"textline",tokens:["gl_Position","=","xE",";","}"]}]},exports["halo.glslf"]={type:"group",parts:[{type:"var",name:"NUM_LINES",tokens:["0"]},{type:"var",name:"NUM_RINGS",tokens:["0"]},{type:"var",name:"NUM_STARS",tokens:["0"]},{type:"var",name:"WAVES_HEIGHT",tokens:["0.0"]},
{type:"include",file:"precision_statement.glslf"},{type:"include",file:"gamma.glslf"},{type:"textline",tokens:["uniform","vec4","u_diffuse_color",";","uniform","vec3","u_halo_rings_color",";","uniform","vec3","u_halo_lines_color",";","uniform","float","u_halo_hardness",";","uniform","float","u_halo_size",";"]},{type:"condition",parts:[{type:"if",expression:["SKY_STARS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_sun_intensity",";"]},{type:"condition",parts:[{type:"if",
expression:["WATER_EFFECTS","DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_halo_stars_blend",";","uniform","float","u_halo_stars_height",";","uniform","float","u_cam_water_depth",";","varying","vec4","xB",";"]}]}}]}]}}]},{type:"textline",tokens:["varying","vec2","b_",";","varying","float","xC",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_RINGS","NUM_LINES",{type:"g_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["const","int","xD","=","NUM_RINGS",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["const","int","xD","=","NUM_LINES",";"]}]}}]},{type:"textline",tokens:["float","xF","(","float","xE",")","{","return","xE","-","floor","(","xE","*","(","1.0","/","0.01",")",")","*","0.01",";","}"]},{type:"condition",parts:[{type:"if",expression:["NUM_RINGS"],group:{type:"group",parts:[{type:"textline",tokens:["void","xO","(","inout",
"float","xG",",","in","float","xH","[","xD","]",",","in","float","xI",")","{","for","(","int","xJ","=","0",";","xJ","<","NUM_RINGS",";","xJ","++",")","{","float","xK","=","40.0","*","xH","[","xJ","]",";","float","xL","=","300.0","*","(","xF","(","xK",")","-","0.005",")",";","float","xM","=","xK",";","float","xN","=","abs","(","xM","*","(","u_halo_size","*","xL","-","xI",")",")",";","xG","+=","1.0","-","min","(","xN",",","1.0",")",";","}","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_LINES"],
group:{type:"group",parts:[{type:"textline",tokens:["void","xX","(","inout","float","xP",",","in","float","xQ","[","xD","]",",","in","float","xR",")","{","for","(","int","xS","=","0",";","xS","<","NUM_LINES",";","xS","++",")","{","float","xT","=","xQ","[","xS","]",";","float","xU","=","xT",";","float","xV","=","1000.0","*","(","xF","(","xT",")","-","0.005",")",";","float","xW","=","20.0","*","abs","(","xU","*","b_",".","x","+","xV","*","b_",".","y",")",";","xP","+=","1.0","-","min","(","xW",",","1.0",
")",";","}","xP","*=","xR",";","}"]}]}}]},{type:"textline",tokens:["void","yd","(","inout","float","xY",",","in","vec2","xZ",")","{","float","x_",",","ya",";","ya","=","atan","(","xZ",".","y",",","xZ",".","x",")",";","ya","*=","(","1.0","+","0.25","*","float","(","NUM_STARS",")",")",";","float","yb","=","cos","(","ya",")",";","float","yc","=","sin","(","ya",")",";","ya","=","(","yb","*","xZ",".","x","+","yc","*","xZ",".","y",")","*","(","yb","*","xZ",".","y","-","yc","*","xZ",".","x",")",";","x_",
"=","abs","(","ya",")",";","if","(","x_","<","1.0",")","{","x_","=","(","0.01","*","u_halo_size",")","/","(","x_",")",";","xY","*=","sqrt","(","min","(","x_",",","1.0",")",")",";","}","}","void","main","(",")","{","float","ye","=","(","b_",".","x","*","b_",".","x","+","b_",".","y","*","b_",".","y",")",";","float","yf","=","sqrt","(","ye",")",";","ye","=","max","(","1.0","-","ye",",","0.0",")",";","ye","=","pow","(","ye",",","u_halo_hardness",")",";","float","yg","=","u_diffuse_color",".","a",";"]},
{type:"condition",parts:[{type:"if",expression:["NUM_RINGS","NUM_LINES",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["float","yh","[","xD","]",";","for","(","int","yi","=","0",";","yi","<","xD",";","yi","++",")","{","yh","[","yi","]","=","fract","(","xC","/","(","float","(","yi",")","+","0.01",")",")","-","1.0",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_RINGS"],group:{type:"group",parts:[{type:"textline",tokens:["float","yj","=","0.0",
";","xO","(","yj",",","yh",",","yf",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_LINES"],group:{type:"group",parts:[{type:"textline",tokens:["float","yk","=","0.0",";","xX","(","yk",",","yh",",","ye",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_STARS"],group:{type:"group",parts:[{type:"textline",tokens:["yd","(","ye",",","b_",")",";"]}]}}]},{type:"textline",tokens:["ye","*=","yg",";","vec3","yl","=","u_diffuse_color",".","rgb",";"]},{type:"condition",
parts:[{type:"if",expression:["NUM_RINGS"],group:{type:"group",parts:[{type:"textline",tokens:["yj","*=","ye",";","yl","+=","u_halo_rings_color","*","yj",";","ye","+=","yj",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_LINES"],group:{type:"group",parts:[{type:"textline",tokens:["yk","*=","yg",";","yl","+=","u_halo_lines_color","*","yk",";","ye","+=","yk",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKY_STARS"],group:{type:"group",parts:[{type:"textline",tokens:["ye",
"*=","max","(","1.0","-","2.0","*","u_sun_intensity",".","x",",","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["float","ym","=","u_halo_stars_blend","*","(","xB",".","y","-","u_halo_stars_height",")",";","ye","*=","clamp","(","ym",",","0.0",",","1.0",")",";","ye","*=","min","(","u_cam_water_depth","+","2.0","*","WAVES_HEIGHT",
",","1.0",")",";"]}]}}]}]}}]},{type:"textline",tokens:["bb","(","yl",")",";","be","(","yl",",","ye",")",";","gl_FragColor","=","vec4","(","yl",",","ye",")",";","}"]}]},exports["halo.glslv"]={type:"group",parts:[{type:"var",name:"PRECISION",tokens:["lowp"]},{type:"include",file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"textline",tokens:["attribute","vec3","a_position",";","attribute","vec2","a_halo_bb_vertex",";","uniform","mat4","u_proj_matrix",";","uniform","mat4","u_view_matrix",
";","uniform","PRECISION","float","u_halo_size",";","varying","vec2","b_",";","varying","float","xC",";"]},{type:"condition",parts:[{type:"if",expression:["STATIC_BATCH"],group:{type:"group",parts:[{type:"textline",tokens:["const","mat4","u_model_matrix","=","mat4","(","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_model_matrix",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","DISABLE_FOG",{type:"logic_negative_expr",
places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","xB",";"]}]}}]},{type:"textline",tokens:["void","main","(",")","{","vec3","xD","=","(","u_model_matrix","*","vec4","(","a_position",",","1.0",")",")",".","xyz",";","b_","=","a_halo_bb_vertex","*","2.0",";","xC","=","fract","(","xD",".","x","+","xD",".","y","+","xD",".","z",")",";"]},{type:"condition",parts:[{type:"if",expression:["SKY_STARS"],group:{type:"group",parts:[{type:"textline",
tokens:["mat4","xE","=","tG","(","xD",",","u_view_matrix",")",";","mat4","xF","=","u_view_matrix",";","xF","[","3","]","[","0","]","=","0.0",";","xF","[","3","]","[","1","]","=","0.0",";","xF","[","3","]","[","2","]","=","0.0",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["mat4","xE","=","tG","(","xD",",","u_view_matrix",")",";"]}]}}]},{type:"textline",tokens:["vec4","xG","=","vec4","(","a_halo_bb_vertex","*","2.0","*","u_halo_size",",","0.0",",","1.0",")",";","vec4","xH",
"=","xE","*","xG",";"]},{type:"condition",parts:[{type:"if",expression:["SKY_STARS"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","xI","=","u_proj_matrix","*","xF","*","xH",";","xI",".","z","=","0.99999","*","xI",".","w",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["xB","=","xH",";"]}]}}]}]}},{type:"else",group:{type:"group",
parts:[{type:"textline",tokens:["vec4","xI","=","u_proj_matrix","*","u_view_matrix","*","xH",";"]}]}}]},{type:"textline",tokens:["gl_Position","=","xI",";","}"]}]},exports["line.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","vec4","u_diffuse_color",";","void","main","(",")","{","gl_FragColor","=","u_diffuse_color",";","}"]}]},exports["line.glslv"]={type:"group",parts:[{type:"var",name:"NUM_POINTS",tokens:["0"]},{type:"textline",tokens:["attribute",
"float","a_point",";","uniform","vec3","u_line_points","[","NUM_POINTS","]",";","uniform","mat4","u_view_matrix",";","uniform","mat4","u_proj_matrix",";","void","main","(",")","{","vec3","xD","=","u_line_points","[","int","(","a_point",")","]",";","gl_Position","=","u_proj_matrix","*","u_view_matrix","*","vec4","(","xD",",","1.0",")",";","}"]}]},exports["main.glslf"]={type:"group",parts:[{type:"var",name:"WATER_LEVEL",tokens:["0.0"]},{type:"var",name:"WAVES_HEIGHT",tokens:["0.0"]},{type:"var",name:"NUM_LAMP_LIGHTS",
tokens:["0"]},{type:"var",name:"NUM_VALUES",tokens:["0"]},{type:"var",name:"NUM_RGBS",tokens:["0"]},{type:"var",name:"PARALLAX_STEPS",tokens:["0.0"]},{type:"var",name:"PARALLAX_LOD_DIST",tokens:["0.0"]},{type:"var",name:"WATER_LEVEL",tokens:["0.0"]},{type:"var",name:"WAVES_HEIGHT",tokens:["0.0"]},{type:"var",name:"NUM_LIGHTS",tokens:["0"]},{type:"var",name:"LAMP_IND",tokens:["0"]},{type:"var",name:"LAMP_SPOT_SIZE",tokens:["0"]},{type:"var",name:"LAMP_SPOT_BLEND",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_DIST",
tokens:["0"]},{type:"var",name:"LAMP_LIGHT_FACT_IND",tokens:["0"]},{type:"var",name:"LAMP_FAC_CHANNELS",tokens:["rgb"]},{type:"var",name:"LAMP_SHADOW_MAP_IND",tokens:["0"]},{type:"var",name:"NUM_LFACTORS",tokens:["0"]},{type:"include",file:"std_enums.glsl"},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"pack.glslf"},{type:"condition",parts:[{type:"if",expression:["SHADELESS",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"include",file:"procedural.glslf"},
{type:"condition",parts:[{type:"if",expression:["CAUSTICS"],group:{type:"group",parts:[{type:"include",file:"caustics.glslf"}]}}]}]}}]},{type:"include",file:"gamma.glslf"},{type:"include",file:"math.glslv"},{type:"textline",tokens:["uniform","float","u_time",";"]},{type:"condition",parts:[{type:"if",expression:["USE_ENVIRONMENT_LIGHT","SKY_TEXTURE",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_sky_texture",";"]}]}},{type:"elif",
expression:["USE_ENVIRONMENT_LIGHT","SKY_COLOR",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_horizon_color",";","uniform","vec3","u_zenith_color",";"]}]}}]},{type:"textline",tokens:["uniform","float","u_environment_energy",";"]},{type:"condition",parts:[{type:"if",expression:["SHADELESS",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["NUM_LIGHTS",0,{type:"g_expr",places:2}],
group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_light_positions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_directions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_color_intensities","[","NUM_LIGHTS","]",";","uniform","vec4","u_light_factors","[","NUM_LFACTORS","]",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","CAUSTICS",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_sun_quaternion",
";"]}]}}]}]}}]},{type:"textline",tokens:["uniform","vec3","u_camera_eye_frag",";"]},{type:"condition",parts:[{type:"if",expression:["NORMAL_TEXCOORD","REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"USE_NODE_B4W_VECTOR_VIEW",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_view_matrix_frag",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","vec4","u_fog_color_density",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_underwater_fog_color_density",";","uniform","float","u_cam_water_depth",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["PROCEDURAL_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_cube_fog",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_FOG"],group:{type:"group",
parts:[{type:"textline",tokens:["uniform","vec4","u_fog_params",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_sun_intensity",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","CAUSTICS",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform",
"vec3","u_sun_direction",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_plane_reflection",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_CUBE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_cube_reflection",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_MIRRORMAP",{type:"equal_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_mirrormap",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MAPPING_OPAQUE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_shadow_mask",";"]}]}},{type:"elif",expression:["SHADOW_USAGE","SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["PERSPECTIVE_SHADOW_CAST"],
group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_perspective_cast_far_bound",";"]}]}}]},{type:"textline",tokens:["uniform","vec4","u_pcf_blur_radii",";","uniform","vec4","u_csm_center_dists",";","uniform","PRECISION","sampler2D","u_shadow_map0",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_shadow_map1",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],
group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_shadow_map2",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_shadow_map3",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE","USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_refractmap",
";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION","USE_REFRACTION","REFRACTIVE","USE_REFRACTION_CORRECTION",{type:"logical_and_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_scene_depth",";"]}]}}]},{type:"textline",tokens:["uniform","float","u_emit",";","uniform","float","u_ambient",";","uniform","vec4","u_fresnel_params",";"]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",
{type:"equal_expr",places:2},"REFLECTION_TYPE","REFL_CUBE",{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_MIRRORMAP",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_mirror_factor",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform",
"vec4","u_refl_plane",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_LAMP"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_lamp_light_positions","[","NUM_LAMP_LIGHTS","]",";","uniform","vec3","u_lamp_light_directions","[","NUM_LAMP_LIGHTS","]",";","uniform","vec3","u_lamp_light_color_intensities","[","NUM_LAMP_LIGHTS","]",";","uniform","vec4","u_lamp_light_factors","[","NUM_LAMP_LIGHTS","]",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_VALUE"],
group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_node_values","[","NUM_VALUES","]",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_RGB"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_node_rgbs","[","NUM_RGBS","]",";"]}]}}]},{type:"textline",tokens:["varying","vec3","bQ",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","WIND_BEND","MAIN_BEND_COL",
"DETAIL_BEND",{type:"logical_and_expr",places:3},"USE_NODE_TEX_COORD_NO",{type:"logical_or_expr",places:6}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bS",";"]}]}}]},{type:"textline",tokens:["varying","vec4","bR",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","CALC_TBN_SPACE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bT",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE",
"SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bW",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bX",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bY",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",
parts:[{type:"textline",tokens:["varying","vec4","bZ",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"SHADOW_USAGE","SHADOW_MAPPING_OPAQUE",{type:"equal_expr",places:2},"REFRACTIVE","USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bU",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE","USE_NODE_B4W_REFRACTION",{type:"logical_and_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","float","bV",";"]}]}}]},{type:"include",file:"mirror.glslf"},{type:"include",file:"environment.glslf"},{type:"condition",parts:[{type:"if",expression:["SHADELESS",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"include",file:"shadow.glslf"}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION","USE_REFRACTION",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"include",
file:"refraction.glslf"}]}}]},{type:"include",file:"nodes.glslf"},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"include",file:"fog.glslf"}]}}]},{type:"textline",tokens:["void","main","(",")","{","float","yx","=","length","(","bR",")",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["float","yy","=","bQ",".","y","-","WATER_LEVEL",";"]}]}}]},
{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","DISABLE_FOG",{type:"logic_negative_expr",places:1},"CAUSTICS","WATER_EFFECTS",{type:"logical_and_expr",places:2},{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","yz","=","u_sun_intensity",";"]}]}}]},{type:"textline",tokens:["vec3","yA","=","normalize","(","u_camera_eye_frag","-","bQ",")",";","vec3","yB",";","vec3","yC",";","vec3","yD",";","float","yE",";","float","yF",";","tz","(","yA",",",
"yB",",","yC",",","yD",",","yE",",","yF",")",";","vec3","yG","=","yB",";","float","yH","=","yF",";","vec3","yI","=","yD",";","float","yJ","=","yE",";"]},{type:"condition",parts:[{type:"if",expression:["SHADELESS",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WETTABLE"],group:{type:"group",parts:[{type:"textline",tokens:["yG","=","max","(",
"yG","-","sqrt","(","0.01","*","-","min","(","yy",",","0.0",")",")",",","0.5","*","yG",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CAUSTICS"],group:{type:"group",parts:[{type:"textline",tokens:["aY","(","yG",",","yy",",","u_time",",","yJ",",","yI",",","u_sun_direction",",","yz",",","u_sun_quaternion",",","bQ",",","yx",")",";"]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["ALPHA"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["ALPHA_CLIP"],
group:{type:"group",parts:[{type:"textline",tokens:["if","(","yH","<=","0.5",")","discard",";","yH","=","1.0",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["NODES_GLOW",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["yH","=","1.0",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",
expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["yw","(","yG",",","length","(","bR",")",",","yA",",","yy",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["yw","(","yG",",","length","(","bR",")",",","yA",",","1.0",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SSAO_ONLY","SHADOW_USAGE","SHADOW_MAPPING_OPAQUE",{type:"equal_expr",places:2},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["vec2","yK","=","texture2DProj","(","u_shadow_mask",",","bU",")",".","rg",";","float","yL","=","yK",".","g",";","yG","=","vec3","(","yL",")",";"]}]}}]},{type:"textline",tokens:["bb","(","yG",")",";"]},{type:"condition",parts:[{type:"if",expression:["ALPHA","ALPHA_CLIP",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2},"NODES_GLOW",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["be","(","yG",",","yH",")",";"]}]}}]},{type:"textline",
tokens:["gl_FragColor","=","vec4","(","yG",",","yH",")",";","}"]}]},exports["main.glslv"]={type:"group",parts:[{type:"var",name:"AU_QUALIFIER",tokens:["uniform"]},{type:"var",name:"MAX_BONES",tokens:["0"]},{type:"var",name:"PRECISION",tokens:["lowp"]},{type:"var",name:"VERTEX_ANIM_MIX_NORMALS_FACTOR",tokens:["u_va_frame_factor"]},{type:"include",file:"std_enums.glsl"},{type:"include",file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"include",file:"scale_texcoord.glslv"},{type:"textline",
tokens:["attribute","vec3","a_position",";"]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1},"USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},"USE_NODE_TEX_COORD_NO",{type:"logical_or_expr",places:7}],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_normal",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO",
"CALC_TBN_SPACE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_tangent",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_influence",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","DYNAMIC_GRASS","BILLBOARD",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["AU_QUALIFIER","vec3","au_center_pos",
";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MAIN_BEND_COL"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","float","a_bending_col_main",";"]},{type:"condition",parts:[{type:"if",expression:["DETAIL_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_bending_col_detail",";","AU_QUALIFIER","float","au_detail_bending_amp",";","AU_QUALIFIER","float","au_branch_bending_amp",
";","AU_QUALIFIER","float","au_detail_bending_freq",";"]}]}}]}]}}]},{type:"textline",tokens:["AU_QUALIFIER","float","au_wind_bending_amp",";","AU_QUALIFIER","float","au_wind_bending_freq",";"]},{type:"condition",parts:[{type:"if",expression:["BEND_CENTER_ONLY"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_emitter_center",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3",
"a_position_next",";"]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1},"USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","USE_NODE_TEX_COORD_NO",{type:"logical_or_expr",places:6}],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_normal_next",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","CALC_TBN_SPACE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["attribute","vec4","a_tangent_next",";"]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["TEXCOORD"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec2","a_texcoord",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_color",";"]}]}}]}]}}]},
{type:"condition",parts:[{type:"if",expression:["STATIC_BATCH"],group:{type:"group",parts:[{type:"textline",tokens:["const","mat4","u_model_matrix","=","mat4","(","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_model_matrix",";"]}]}}]},{type:"textline",tokens:["uniform","mat4","u_view_matrix",";","uniform","mat4","u_proj_matrix",";"]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1},"BILLBOARD",{type:"logical_or_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_camera_eye",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_JITTER"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec2","u_subpixel_jitter",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_grass_map_depth",";","uniform","sampler2D","u_grass_map_color",";","uniform","vec4",
"u_camera_quat",";","uniform","vec3","u_grass_map_dim",";","uniform","float","u_grass_size",";","uniform","float","u_scale_threshold",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsb","[","MAX_BONES","]",";","uniform","vec4","u_transb","[","MAX_BONES","]",";","uniform","vec4","u_arm_rel_trans",";","uniform","vec4","u_arm_rel_quat",";"]},{type:"condition",parts:[{type:"if",expression:["FRAMES_BLENDING"],
group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsa","[","MAX_BONES","]",";","uniform","vec4","u_transa","[","MAX_BONES","]",";","uniform","float","u_frame_factor",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["BILLBOARD_JITTERED"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_jitter_amp",";","uniform","float","u_jitter_freq",";"]}]}}]},{type:"textline",
tokens:["uniform","vec3","u_wind",";","uniform","PRECISION","float","u_time",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_va_frame_factor",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_texture_scale",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE",
"SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_normal_offset",";","uniform","mat4","u_v_light_matrix",";","uniform","mat4","u_b_light_matrix",";","uniform","mat4","u_p_light_matrix0",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_p_light_matrix1",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",
parts:[{type:"textline",tokens:["uniform","mat4","u_p_light_matrix2",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_p_light_matrix3",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE","USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","float","u_view_max_depth",";"]}]}}]},{type:"textline",tokens:["varying",
"vec3","bQ",";"]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1},"USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},"USE_NODE_TEX_COORD_NO",{type:"logical_or_expr",places:7}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bS",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","DISABLE_FOG",{type:"logic_negative_expr",
places:1},"TEXTURE_NORM_CO","PARALLAX",{type:"logical_and_expr",places:2},"WATER_EFFECTS","CAUSTICS",{type:"logical_and_expr",places:2},{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bR",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","CALC_TBN_SPACE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bT",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES",
{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","yx",";"]},{type:"condition",parts:[{type:"if",expression:["TEXCOORD"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","b_",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_COLOR","DYNAMIC_GRASS",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","yy",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",
expression:["SHADOW_USAGE","SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bW",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bX",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bY",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],
group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bZ",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"SHADOW_USAGE","SHADOW_MAPPING_OPAQUE",{type:"equal_expr",places:2},"REFRACTIVE","USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bU",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE","NODES",{type:"logic_negative_expr",
places:1},"USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",places:2},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","float","bV",";"]}]}}]},{type:"include",file:"dynamic_grass.glslv"},{type:"include",file:"shadow.glslv"},{type:"include",file:"skin.glslv"},{type:"include",file:"wind_bending.glslv"},{type:"condition",parts:[{type:"if",expression:["NODES"],group:{type:"group",parts:[{type:"include",file:"nodes.glslv"}]}}]},{type:"textline",tokens:["void",
"main","(",")","{","vec3","yz","=","a_position",";"]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE","USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},"NODES",{type:"logic_negative_expr",places:1},{type:"logical_or_expr",places:6}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","yA","=","a_normal",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","yA",
"=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE","NODES",{type:"logic_negative_expr",places:1},"TEXTURE_NORM_CO","TEXTURE_COORDS_UV_ORCO",{type:"equal_expr",places:2},{type:"logical_and_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","yB","=","vec3","(","a_tangent",")",";","vec3","yC","=","a_tangent","[","3","]","*","cross","(","yA",",","yB",")",";"]}]}},{type:"elif",expression:["NODES",
{type:"logic_negative_expr",places:1},"TEXTURE_NORM_CO","TEXTURE_COORDS_NORMAL",{type:"equal_expr",places:2},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","yD","=","(","u_model_matrix","*","vec4","(","a_position",",","1.0",")",")",".","xyz",";","vec3","yE","=","normalize","(","(","u_model_matrix","*","vec4","(","a_normal",",","0.0",")",")",".","xyz",")",";","vec3","yF","=","yD","-","u_camera_eye",";","vec3","yC","=","cross","(","yF",",","yE",")",";",
"vec3","yB","=","cross","(","yE",",","yC",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","yB","=","vec3","(","0.0",")",";","vec3","yC","=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["yz","=","mix","(","yz",",","a_position_next",",","u_va_frame_factor",")",";"]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1},"USE_NODE_MATERIAL_BEGIN",
"USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE",{type:"logical_or_expr",places:5}],group:{type:"group",parts:[{type:"textline",tokens:["yA","=","mix","(","yA",",","a_normal_next",",","VERTEX_ANIM_MIX_NORMALS_FACTOR",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","yG","=","vec3","(","a_tangent",")",";","vec3","yH","=","a_tangent_next","[","3","]","*","cross","(","a_normal_next",",","yG",")",";","yB","=",
"mix","(","yB",",","yG",",","u_va_frame_factor",")",";","yC","=","mix","(","yC",",","yH",",","u_va_frame_factor",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["vD","(","yz",",","yB",",","yC",",","yA",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","DYNAMIC_GRASS","BILLBOARD",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","yI","=","au_center_pos",
";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","yI","=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS"],group:{type:"group",parts:[{type:"textline",tokens:["bh","yJ","=","xp","(","yz",",","yB",",","yC",",","yA",",","yI",",","u_grass_map_depth",",","u_grass_map_color",",","u_grass_map_dim",",","u_grass_size",",","u_camera_eye",",","u_camera_quat",",","u_view_matrix",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",
parts:[{type:"if",expression:["BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","yK","=","(","u_model_matrix","*","vec4","(","yI",",","1.0",")",")",".","xyz",";"]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD_PRES_GLOB_ORIENTATION","STATIC_BATCH",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["mat4","yL","=","um","(","u_camera_eye",",","yK",",","u_view_matrix",",","u_model_matrix",")",
";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["mat4","yL","=","ug","(","u_camera_eye",",","yK",",","u_view_matrix",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","BILLBOARD_JITTERED",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","yM","=","(","u_model_matrix","*","vec4","(","yI",",","1.0",")",")",".","xyz",";","yL","=","yL","*","tW","(","u_wind",",","u_time",",","u_jitter_amp",",","u_jitter_freq",
",","yM",")",";"]}]}}]},{type:"textline",tokens:["bh","yJ","=","ut","(","yz","-","yI",",","yI",",","yB",",","yC",",","yA",",","yL",")",";","yJ",".","b","=","yK",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["bh","yJ","=","ut","(","yz",",","yI",",","yB",",","yC",",","yA",",","u_model_matrix",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","CALC_TBN_SPACE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["float","yN","=","(","dot","(","cross","(","yJ",".","e",",","yJ",".","c",")",",","yJ",".","d",")","<","0.0",")","?","-","1.0",":","1.0",";","bT","=","vec4","(","yJ",".","c",",","yN",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["wv","(","yJ",".","a",",","yJ",".","b",",","yA",")",";"]}]}}]},{type:"textline",tokens:["bQ","=","yJ",".","a",";"]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",
places:1},"USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},{type:"logical_or_expr",places:6}],group:{type:"group",parts:[{type:"textline",tokens:["bS","=","yJ",".","e",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["yx","=","u_camera_eye","-","yJ",".","a",";"]},{type:"condition",parts:[{type:"if",
expression:["TEXCOORD"],group:{type:"group",parts:[{type:"textline",tokens:["b_","=","uw","(","a_texcoord",",","u_texture_scale",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS"],group:{type:"group",parts:[{type:"textline",tokens:["yy","=","yJ",".","f",";"]}]}},{type:"elif",expression:["VERTEX_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["yy","=","a_color",";"]}]}}]}]}}]},{type:"textline",tokens:["vec4","yO","=","u_view_matrix","*","vec4","(","yJ",".",
"a",",","1.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["NODES","DISABLE_FOG",{type:"logic_negative_expr",places:1},"TEXTURE_NORM_CO","PARALLAX",{type:"logical_and_expr",places:2},"WATER_EFFECTS","CAUSTICS",{type:"logical_and_expr",places:2},{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["bR","=","yO",";"]}]}}]},{type:"textline",tokens:["vec4","yP","=","u_proj_matrix","*","yO",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_JITTER"],
group:{type:"group",parts:[{type:"textline",tokens:["yP",".","xy","+=","u_subpixel_jitter","*","yP",".","w",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"SHADOW_USAGE","SHADOW_MAPPING_OPAQUE",{type:"equal_expr",places:2},"REFRACTIVE","USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["bU","=","bP","(","yP",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE",
"SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["xz","(","yJ",".","a",",","yJ",".","e",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE","NODES",{type:"logic_negative_expr",places:1},"USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",places:2},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["bV","=","-","yO",".","z","/","u_view_max_depth",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["NODES"],group:{type:"group",parts:[{type:"textline",tokens:["wA","(",")",";"]}]}}]},{type:"textline",tokens:["gl_Position","=","yP",";","}"]}]},exports["main_stack.glslf"]={type:"group",parts:[{type:"var",name:"WATER_LEVEL",tokens:["0.0"]},{type:"var",name:"WAVES_HEIGHT",tokens:["0.0"]},{type:"var",name:"NUM_LAMP_LIGHTS",tokens:["0"]},{type:"var",name:"NUM_VALUES",tokens:["0"]},{type:"var",name:"NUM_RGBS",tokens:["0"]},{type:"var",name:"PARALLAX_STEPS",tokens:["0.0"]},{type:"var",name:"PARALLAX_LOD_DIST",
tokens:["0.0"]},{type:"var",name:"WATER_LEVEL",tokens:["0.0"]},{type:"var",name:"WAVES_HEIGHT",tokens:["0.0"]},{type:"var",name:"NUM_LIGHTS",tokens:["0"]},{type:"var",name:"LAMP_IND",tokens:["0"]},{type:"var",name:"LAMP_SPOT_SIZE",tokens:["0"]},{type:"var",name:"LAMP_SPOT_BLEND",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_DIST",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_FACT_IND",tokens:["0"]},{type:"var",name:"LAMP_FAC_CHANNELS",tokens:["rgb"]},{type:"var",name:"LAMP_SHADOW_MAP_IND",tokens:["0"]},
{type:"var",name:"NUM_LFACTORS",tokens:["0"]},{type:"include",file:"std_enums.glsl"},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"pack.glslf"},{type:"condition",parts:[{type:"if",expression:["SHADELESS",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"include",file:"procedural.glslf"},{type:"condition",parts:[{type:"if",expression:["CAUSTICS"],group:{type:"group",parts:[{type:"include",file:"caustics.glslf"}]}}]}]}}]},{type:"include",file:"gamma.glslf"},
{type:"include",file:"math.glslv"},{type:"textline",tokens:["uniform","float","u_time",";"]},{type:"condition",parts:[{type:"if",expression:["USE_ENVIRONMENT_LIGHT","SKY_TEXTURE",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_sky_texture",";"]}]}},{type:"elif",expression:["USE_ENVIRONMENT_LIGHT","SKY_COLOR",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_horizon_color",";",
"uniform","vec3","u_zenith_color",";"]}]}}]},{type:"textline",tokens:["uniform","float","u_environment_energy",";"]},{type:"condition",parts:[{type:"if",expression:["SHADELESS",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["NUM_LIGHTS",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_light_positions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_directions","[","NUM_LIGHTS",
"]",";","uniform","vec3","u_light_color_intensities","[","NUM_LIGHTS","]",";","uniform","vec4","u_light_factors","[","NUM_LFACTORS","]",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","CAUSTICS",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_sun_quaternion",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NORMAL_TEXCOORD","REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},{type:"logical_or_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_view_matrix_frag",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_fog_color_density",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_underwater_fog_color_density",";","uniform","float","u_cam_water_depth",
";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["PROCEDURAL_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_cube_fog",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_fog_params",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","vec3","u_sun_intensity",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","CAUSTICS",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_sun_direction",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR0_CO"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_colormap0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_SPEC","ALPHA_AS_SPEC",
{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_specmap0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_normalmap0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_STENCIL_ALPHA_MASK"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_colormap1",
";","uniform","sampler2D","u_stencil0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_plane_reflection",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_CUBE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_cube_reflection",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_MIRRORMAP",
{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_mirrormap",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MAPPING_OPAQUE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_shadow_mask",";"]}]}},{type:"elif",expression:["SHADOW_USAGE","SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",
expression:["PERSPECTIVE_SHADOW_CAST"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_perspective_cast_far_bound",";"]}]}}]},{type:"textline",tokens:["uniform","vec4","u_pcf_blur_radii",";","uniform","vec4","u_csm_center_dists",";","uniform","PRECISION","sampler2D","u_shadow_map0",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_shadow_map1",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_shadow_map2",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_shadow_map3",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_refractmap",";"]}]}}]},
{type:"condition",parts:[{type:"if",expression:["REFRACTIVE","USE_REFRACTION_CORRECTION",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_scene_depth",";"]}]}}]},{type:"textline",tokens:["uniform","float","u_emit",";","uniform","float","u_ambient",";","uniform","vec4","u_fresnel_params",";","uniform","float","u_specular_alpha",";"]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",
places:2},"REFLECTION_TYPE","REFL_CUBE",{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_reflect_factor",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_MIRRORMAP",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_mirror_factor",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2}],group:{type:"group",
parts:[{type:"textline",tokens:["uniform","vec4","u_refl_plane",";"]}]}}]},{type:"textline",tokens:["uniform","vec4","u_diffuse_color",";","uniform","vec2","u_diffuse_params",";","uniform","float","u_diffuse_intensity",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_normal_factor",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR0_CO"],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","float","u_diffuse_color_factor",";","uniform","float","u_alpha_factor",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_SPEC"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_specular_color_factor",";"]}]}}]},{type:"textline",tokens:["uniform","vec3","u_specular_color",";","uniform","vec3","u_specular_params",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","PARALLAX",{type:"logical_and_expr",places:2}],group:{type:"group",
parts:[{type:"textline",tokens:["uniform","float","u_parallax_scale",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_refr_bump",";"]}]}}]},{type:"textline",tokens:["varying","vec3","bQ",";","varying","vec3","bS",";"]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1},"TEXTURE_NORM_CO","PARALLAX",{type:"logical_and_expr",places:2},"WATER_EFFECTS","CAUSTICS",
{type:"logical_and_expr",places:2},{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bR",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","CALC_TBN_SPACE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bT",";"]}]}}]},{type:"textline",tokens:["varying","vec3","yx",";"]},{type:"condition",parts:[{type:"if",expression:["TEXCOORD"],group:{type:"group",parts:[{type:"textline",
tokens:["varying","vec2","b_",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_COLOR","DYNAMIC_GRASS",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","yy",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bW",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",
parts:[{type:"textline",tokens:["varying","vec4","bX",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bY",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bZ",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"SHADOW_USAGE","SHADOW_MAPPING_OPAQUE",
{type:"equal_expr",places:2},"REFRACTIVE",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bU",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["varying","float","bV",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADELESS",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"include",file:"shadow.glslf"}]}}]},{type:"include",file:"mirror.glslf"},
{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"include",file:"refraction.glslf"}]}}]},{type:"include",file:"environment.glslf"},{type:"condition",parts:[{type:"if",expression:["SHADELESS",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"include",file:"lighting_nodes.glslf"}]}}]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"include",file:"fog.glslf"}]}}]},
{type:"textline",tokens:["void","main","(",")","{"]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1},"TEXTURE_NORM_CO","PARALLAX",{type:"logical_and_expr",places:2},"WATER_EFFECTS","CAUSTICS",{type:"logical_and_expr",places:2},{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["float","Br","=","length","(","bR",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",
parts:[{type:"textline",tokens:["float","Bs","=","bQ",".","y","-","WATER_LEVEL",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","DISABLE_FOG",{type:"logic_negative_expr",places:1},"CAUSTICS","WATER_EFFECTS",{type:"logical_and_expr",places:2},{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","Bt","=","u_sun_intensity",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXCOORD"],group:{type:"group",parts:[{type:"textline",
tokens:["vec2","Bu","=","b_",";"]}]}}]},{type:"textline",tokens:["vec3","Bv","=","normalize","(","bS",")",";"]},{type:"condition",parts:[{type:"if",expression:["DOUBLE_SIDED_LIGHTING"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","gl_FrontFacing",")","Bv","=","Bv",";","else","Bv","=","-","Bv",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","Bw","=","cross","(","Bv",",","bT",".","xyz",")","*","bT",
".","w",";","mat3","Bx","=","mat3","(","bT",".","xyz",",","Bw",",","Bv",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NORMAL_TEXCOORD"],group:{type:"group",parts:[{type:"textline",tokens:["vec2","By","=","normalize","(","u_view_matrix_frag","*","vec4","(","bS",",","0.0",")",")",".","st",";","By","=","By","*","vec2","(","0.495",")","+","vec2","(","0.5",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","PARALLAX",{type:"logical_and_expr",places:2}],group:{type:"group",
parts:[{type:"textline",tokens:["if","(","Br","<","PARALLAX_LOD_DIST",")","{","float","Bz","=","clamp","(","0.5","*","(","PARALLAX_LOD_DIST","-","Br",")",",","0.0",",","1.0",")",";","float","BA","=","u_parallax_scale","*","Bz",";","vec3","BB","=","normalize","(","yx","*","Bx",")",";","float","BC","=","1.0","/","PARALLAX_STEPS",";","vec2","BD","=","BB",".","xy","*","BA","/","(","PARALLAX_STEPS","*","BB",".","z",")",";","float","BE","=","1.0",";","float","BF",";"]},{type:"condition",parts:[{type:"if",
expression:["TEXTURE_NORM_CO","TEXTURE_COORDS_NORMAL",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec2","BG","=","By",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec2","BG","=","Bu",";"]}]}}]},{type:"textline",tokens:["BF","=","texture2D","(","u_normalmap0",",","BG",")",".","a",";","for","(","float","BH","=","1.0",";","BH","<=","PARALLAX_STEPS",";","BH","++",")","{","if","(","BF","<","BE",")","{","BE","-=","BC",";","BG","-=","BD",
";","BF","=","texture2D","(","u_normalmap0",",","BG",")",".","a",";","}","}","vec2","BI","=","BG","+","BD",";","float","BJ","=","texture2D","(","u_normalmap0",",","BI",")",".","a","-","(","BE","+","BC",")",";","float","BK","=","BF","-","BE",";","float","BL","=","BK","/","(","BK","-","BJ",")",";","BG","=","BL","*","BI","+","(","1.0","-","BL",")","*","BG",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","TEXTURE_COORDS_NORMAL",{type:"equal_expr",places:2}],group:{type:"group",
parts:[{type:"condition",parts:[{type:"if",expression:["TEXCOORD"],group:{type:"group",parts:[{type:"textline",tokens:["Bu","+=","BG","-","By",";"]}]}}]},{type:"textline",tokens:["By","=","BG",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["NORMAL_TEXCOORD"],group:{type:"group",parts:[{type:"textline",tokens:["By","+=","BG","-","Bu",";"]}]}}]},{type:"textline",tokens:["Bu","=","BG",";"]}]}}]},{type:"textline",tokens:["}"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["TEXTURE_NORM_CO"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","BM",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","TEXTURE_COORDS_NORMAL",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["BM","=","texture2D","(","u_normalmap0",",","By",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["BM","=","texture2D","(","u_normalmap0",",","Bu",")",";"]}]}}]},{type:"textline",tokens:["vec3","BN",
"=","BM",".","rgb","-","0.5",";","BN","=","mix","(","vec3","(","0.0",",","0.0",",","1.0",")",",","BN",",","u_normal_factor",")",";","vec3","BO","=","Bx","*","BN",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","BO","=","Bv",";"]}]}}]},{type:"textline",tokens:["BO","=","normalize","(","BO",")",";"]},{type:"condition",parts:[{type:"if",expression:["NORMAL_TEXCOORD"],group:{type:"group",parts:[{type:"textline",tokens:["By","=","normalize","(","u_view_matrix_frag","*",
"vec4","(","BO",",","0.0",")",")",".","st",";","By","=","By","*","vec2","(","0.495",")","+","vec2","(","0.5",")",";"]}]}}]},{type:"textline",tokens:["vec3","BP","=","normalize","(","yx",")",";"]},{type:"condition",parts:[{type:"if",expression:["VERTEX_COLOR","DYNAMIC_GRASS",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","BQ","=","yy",";","a_","(","BQ",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_COLOR","DYNAMIC_GRASS",{type:"logical_or_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec4","BR","=","vec4","(","BQ",",","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec4","BR","=","u_diffuse_color",";"]}]}}]},{type:"textline",tokens:["float","BS","=","1.0",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR0_CO","TEXTURE_COORDS_NORMAL",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec4","BT","=","texture2D","(","u_colormap0",
",","By",")",";"]}]}},{type:"elif",expression:["TEXTURE_COLOR0_CO","TEXTURE_COORDS_UV_ORCO",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec4","BT","=","texture2D","(","u_colormap0",",","Bu",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR0_CO"],group:{type:"group",parts:[{type:"textline",tokens:["a_","(","BT",".","rgb",")",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_STENCIL_ALPHA_MASK"],group:{type:"group",parts:[{type:"textline",
tokens:["vec4","BU",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR1_CO","TEXTURE_COORDS_NORMAL",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["BU","=","texture2D","(","u_colormap1",",","By",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["BU","=","texture2D","(","u_colormap1",",","Bu",")",";"]}]}}]},{type:"textline",tokens:["a_","(","BU",".","rgb",")",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_STENCIL_ALPHA_MASK_CO",
"TEXTURE_COORDS_NORMAL",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec4","BV","=","texture2D","(","u_stencil0",",","By",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec4","BV","=","texture2D","(","u_stencil0",",","Bu",")",";"]}]}}]},{type:"textline",tokens:["BT","=","mix","(","BT",",","BU",",","BV",".","r",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MIX",{type:"equal_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["BR",".","rgb","=","mix","(","BR",".","rgb",",","BT",".","rgb",",","u_diffuse_color_factor",")",";","float","BW","=","u_alpha_factor","*","BT",".","a",";","BW","+=","(","1.0","-","step","(","0.0",",","BW",")",")",";","BR",".","a","=","mix","(","BW",",","1.0",",","u_diffuse_color",".","a",")",";","BS","=","BT",".","a",";"]}]}},{type:"elif",expression:["TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MULTIPLY",{type:"equal_expr",places:2}],group:{type:"group",
parts:[{type:"textline",tokens:["BR",".","rgb","*=","mix","(","vec3","(","1.0",")",",","BT",".","rgb",",","u_diffuse_color_factor",")",";","BR",".","a","=","BT",".","a",";","BS","=","BT",".","a",";"]}]}}]}]}}]},{type:"textline",tokens:["vec3","BX","=","u_diffuse_intensity","*","BR",".","rgb",";"]},{type:"condition",parts:[{type:"if",expression:["SHADELESS"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","BY","=","BX",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3",
"BZ","=","u_environment_energy","*","ew","(","BO",")",";","vec3","B_","=","u_ambient","*","BZ",";","float","Ca","=","dY","(","BX",")",";","vec3","Cb","=","u_emit","*","BR",".","rgb",";","vec3","Cc","=","u_specular_color",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_SPEC"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["ALPHA_AS_SPEC"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","Cd","=","vec3","(","BS",")",";"]}]}},{type:"elif",expression:["TEXTURE_SPEC_CO",
"TEXTURE_COORDS_NORMAL",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","Cd","=","texture2D","(","u_specmap0",",","By",")",".","rgb",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","Cd","=","texture2D","(","u_specmap0",",","Bu",")",".","rgb",";"]}]}}]},{type:"textline",tokens:["a_","(","Cd",".","rgb",")",";","Cc","=","mix","(","Cc",",","Cd",",","u_specular_color_factor",")",";"]}]}}]},{type:"textline",tokens:["float","Ce","=",
"u_specular_params","[","0","]",";","vec2","Cf","=","vec2","(","u_specular_params","[","1","]",",","u_specular_params","[","2","]",")",";","vec3","Cg","=","Ce","*","Cc",";","vec3","BY",";","vec3","Ch",";","Bq","(","Cb",",","B_",",","BX",",","Cg",",","bQ",",","BO",",","BP",",","Cf",",","u_diffuse_params",",","Ca",",","0.0",",","vec4","(","0.0",")",",","BY",",","Ch",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"REFLECTION_TYPE",
"REFL_CUBE",{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["et","(","BY",",","BP",",","BO",",","u_reflect_factor",")",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_MIRRORMAP",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["et","(","BY",",","BP",",","BO",",","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADELESS",{type:"logic_negative_expr",places:1}],group:{type:"group",
parts:[{type:"textline",tokens:["BY","+=","Ch",";"]}]}}]},{type:"textline",tokens:["float","Ci","=","BR",".","a",";"]},{type:"condition",parts:[{type:"if",expression:["SHADELESS",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WETTABLE"],group:{type:"group",parts:[{type:"textline",tokens:["BY","=","max","(","BY","-","sqrt","(","0.01","*","-",
"min","(","Bs",",","0.0",")",")",",","0.5","*","BY",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CAUSTICS"],group:{type:"group",parts:[{type:"textline",tokens:["aY","(","BY",",","Bs",",","u_time",",","Ca",",","BO",",","u_sun_direction",",","Bt",",","u_sun_quaternion",",","bQ",",","Br",")",";"]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["ALPHA"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["ALPHA_CLIP"],group:{type:"group",parts:[{type:"textline",
tokens:["if","(","Ci","<=","0.5",")","discard",";","Ci","=","1.0",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["SHADELESS",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["float","Cj","=","max","(","max","(","Ch",".","r",",","Ch",".","g",")",",","Ch",".","b",")","*","u_specular_alpha",";","Ci","=","BR",".","a","*","(","1.0","-","Cj",")","+","Cj",";"]}]}}]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",
tokens:["Ci","=","1.0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["BY","=","mix","(","eK","(","bU",",","BO",".","xz","*","u_refr_bump",")",",","BY",",","Ci",")",";","Ci","=","1.0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",
tokens:["yw","(","BY",",","Br",",","BP",",","Bs",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["yw","(","BY",",","Br",",","BP",",","1.0",")",";"]}]}}]}]}}]},{type:"textline",tokens:["bb","(","BY",")",";"]},{type:"condition",parts:[{type:"if",expression:["ALPHA","ALPHA_CLIP",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["be","(","BY",",","Ci",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor",
"=","vec4","(","BY",",","Ci",")",";","}"]}]},exports["main_stack.glslv"]={type:"group",parts:[{type:"var",name:"AU_QUALIFIER",tokens:["uniform"]},{type:"var",name:"MAX_BONES",tokens:["0"]},{type:"var",name:"PRECISION",tokens:["lowp"]},{type:"var",name:"VERTEX_ANIM_MIX_NORMALS_FACTOR",tokens:["u_va_frame_factor"]},{type:"include",file:"std_enums.glsl"},{type:"include",file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"include",file:"scale_texcoord.glslv"},{type:"textline",tokens:["attribute",
"vec3","a_position",";"]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1},"USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},"USE_NODE_TEX_COORD_NO",{type:"logical_or_expr",places:7}],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_normal",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","CALC_TBN_SPACE",
{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_tangent",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_influence",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","DYNAMIC_GRASS","BILLBOARD",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["AU_QUALIFIER","vec3","au_center_pos",";"]}]}}]},
{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MAIN_BEND_COL"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","float","a_bending_col_main",";"]},{type:"condition",parts:[{type:"if",expression:["DETAIL_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_bending_col_detail",";","AU_QUALIFIER","float","au_detail_bending_amp",";","AU_QUALIFIER","float","au_branch_bending_amp",
";","AU_QUALIFIER","float","au_detail_bending_freq",";"]}]}}]}]}}]},{type:"textline",tokens:["AU_QUALIFIER","float","au_wind_bending_amp",";","AU_QUALIFIER","float","au_wind_bending_freq",";"]},{type:"condition",parts:[{type:"if",expression:["BEND_CENTER_ONLY"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_emitter_center",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3",
"a_position_next",";"]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1},"USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","USE_NODE_TEX_COORD_NO",{type:"logical_or_expr",places:6}],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_normal_next",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","CALC_TBN_SPACE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["attribute","vec4","a_tangent_next",";"]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["TEXCOORD"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec2","a_texcoord",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_color",";"]}]}}]}]}}]},
{type:"condition",parts:[{type:"if",expression:["STATIC_BATCH"],group:{type:"group",parts:[{type:"textline",tokens:["const","mat4","u_model_matrix","=","mat4","(","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_model_matrix",";"]}]}}]},{type:"textline",tokens:["uniform","mat4","u_view_matrix",";","uniform","mat4","u_proj_matrix",";"]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1},"BILLBOARD",{type:"logical_or_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_camera_eye",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_JITTER"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec2","u_subpixel_jitter",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_grass_map_depth",";","uniform","sampler2D","u_grass_map_color",";","uniform","vec4",
"u_camera_quat",";","uniform","vec3","u_grass_map_dim",";","uniform","float","u_grass_size",";","uniform","float","u_scale_threshold",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsb","[","MAX_BONES","]",";","uniform","vec4","u_transb","[","MAX_BONES","]",";","uniform","vec4","u_arm_rel_trans",";","uniform","vec4","u_arm_rel_quat",";"]},{type:"condition",parts:[{type:"if",expression:["FRAMES_BLENDING"],
group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsa","[","MAX_BONES","]",";","uniform","vec4","u_transa","[","MAX_BONES","]",";","uniform","float","u_frame_factor",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["BILLBOARD_JITTERED"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_jitter_amp",";","uniform","float","u_jitter_freq",";"]}]}}]},{type:"textline",
tokens:["uniform","vec3","u_wind",";","uniform","PRECISION","float","u_time",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_va_frame_factor",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_texture_scale",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE",
"SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_normal_offset",";","uniform","mat4","u_v_light_matrix",";","uniform","mat4","u_b_light_matrix",";","uniform","mat4","u_p_light_matrix0",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_p_light_matrix1",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",
parts:[{type:"textline",tokens:["uniform","mat4","u_p_light_matrix2",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_p_light_matrix3",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE","USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","float","u_view_max_depth",";"]}]}}]},{type:"textline",tokens:["varying",
"vec3","bQ",";"]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1},"USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},"USE_NODE_TEX_COORD_NO",{type:"logical_or_expr",places:7}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bS",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","DISABLE_FOG",{type:"logic_negative_expr",
places:1},"TEXTURE_NORM_CO","PARALLAX",{type:"logical_and_expr",places:2},"WATER_EFFECTS","CAUSTICS",{type:"logical_and_expr",places:2},{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bR",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","CALC_TBN_SPACE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bT",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES",
{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","yx",";"]},{type:"condition",parts:[{type:"if",expression:["TEXCOORD"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","b_",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_COLOR","DYNAMIC_GRASS",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","yy",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",
expression:["SHADOW_USAGE","SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bW",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bX",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bY",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],
group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bZ",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"SHADOW_USAGE","SHADOW_MAPPING_OPAQUE",{type:"equal_expr",places:2},"REFRACTIVE","USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bU",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE","NODES",{type:"logic_negative_expr",
places:1},"USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",places:2},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","float","bV",";"]}]}}]},{type:"include",file:"dynamic_grass.glslv"},{type:"include",file:"shadow.glslv"},{type:"include",file:"skin.glslv"},{type:"include",file:"wind_bending.glslv"},{type:"condition",parts:[{type:"if",expression:["NODES"],group:{type:"group",parts:[{type:"include",file:"nodes.glslv"}]}}]},{type:"textline",tokens:["void",
"main","(",")","{","vec3","Br","=","a_position",";"]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE","USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},"NODES",{type:"logic_negative_expr",places:1},{type:"logical_or_expr",places:6}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","Bs","=","a_normal",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","Bs",
"=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE","NODES",{type:"logic_negative_expr",places:1},"TEXTURE_NORM_CO","TEXTURE_COORDS_UV_ORCO",{type:"equal_expr",places:2},{type:"logical_and_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","Bt","=","vec3","(","a_tangent",")",";","vec3","Bu","=","a_tangent","[","3","]","*","cross","(","Bs",",","Bt",")",";"]}]}},{type:"elif",expression:["NODES",
{type:"logic_negative_expr",places:1},"TEXTURE_NORM_CO","TEXTURE_COORDS_NORMAL",{type:"equal_expr",places:2},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","Bv","=","(","u_model_matrix","*","vec4","(","a_position",",","1.0",")",")",".","xyz",";","vec3","Bw","=","normalize","(","(","u_model_matrix","*","vec4","(","a_normal",",","0.0",")",")",".","xyz",")",";","vec3","Bx","=","Bv","-","u_camera_eye",";","vec3","Bu","=","cross","(","Bx",",","Bw",")",";",
"vec3","Bt","=","cross","(","Bw",",","Bu",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","Bt","=","vec3","(","0.0",")",";","vec3","Bu","=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["Br","=","mix","(","Br",",","a_position_next",",","u_va_frame_factor",")",";"]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1},"USE_NODE_MATERIAL_BEGIN",
"USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE",{type:"logical_or_expr",places:5}],group:{type:"group",parts:[{type:"textline",tokens:["Bs","=","mix","(","Bs",",","a_normal_next",",","VERTEX_ANIM_MIX_NORMALS_FACTOR",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","By","=","vec3","(","a_tangent",")",";","vec3","Bz","=","a_tangent_next","[","3","]","*","cross","(","a_normal_next",",","By",")",";","Bt","=",
"mix","(","Bt",",","By",",","u_va_frame_factor",")",";","Bu","=","mix","(","Bu",",","Bz",",","u_va_frame_factor",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["vD","(","Br",",","Bt",",","Bu",",","Bs",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","DYNAMIC_GRASS","BILLBOARD",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","BA","=","au_center_pos",
";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","BA","=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS"],group:{type:"group",parts:[{type:"textline",tokens:["bh","BB","=","xp","(","Br",",","Bt",",","Bu",",","Bs",",","BA",",","u_grass_map_depth",",","u_grass_map_color",",","u_grass_map_dim",",","u_grass_size",",","u_camera_eye",",","u_camera_quat",",","u_view_matrix",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",
parts:[{type:"if",expression:["BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","BC","=","(","u_model_matrix","*","vec4","(","BA",",","1.0",")",")",".","xyz",";"]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD_PRES_GLOB_ORIENTATION","STATIC_BATCH",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["mat4","BD","=","um","(","u_camera_eye",",","BC",",","u_view_matrix",",","u_model_matrix",")",
";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["mat4","BD","=","ug","(","u_camera_eye",",","BC",",","u_view_matrix",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","BILLBOARD_JITTERED",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","BE","=","(","u_model_matrix","*","vec4","(","BA",",","1.0",")",")",".","xyz",";","BD","=","BD","*","tW","(","u_wind",",","u_time",",","u_jitter_amp",",","u_jitter_freq",
",","BE",")",";"]}]}}]},{type:"textline",tokens:["bh","BB","=","ut","(","Br","-","BA",",","BA",",","Bt",",","Bu",",","Bs",",","BD",")",";","BB",".","b","=","BC",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["bh","BB","=","ut","(","Br",",","BA",",","Bt",",","Bu",",","Bs",",","u_model_matrix",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","CALC_TBN_SPACE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["float","BF","=","(","dot","(","cross","(","BB",".","e",",","BB",".","c",")",",","BB",".","d",")","<","0.0",")","?","-","1.0",":","1.0",";","bT","=","vec4","(","BB",".","c",",","BF",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["wv","(","BB",".","a",",","BB",".","b",",","Bs",")",";"]}]}}]},{type:"textline",tokens:["bQ","=","BB",".","a",";"]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",
places:1},"USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},{type:"logical_or_expr",places:6}],group:{type:"group",parts:[{type:"textline",tokens:["bS","=","BB",".","e",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["yx","=","u_camera_eye","-","BB",".","a",";"]},{type:"condition",parts:[{type:"if",
expression:["TEXCOORD"],group:{type:"group",parts:[{type:"textline",tokens:["b_","=","uw","(","a_texcoord",",","u_texture_scale",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS"],group:{type:"group",parts:[{type:"textline",tokens:["yy","=","BB",".","f",";"]}]}},{type:"elif",expression:["VERTEX_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["yy","=","a_color",";"]}]}}]}]}}]},{type:"textline",tokens:["vec4","BG","=","u_view_matrix","*","vec4","(","BB",".",
"a",",","1.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["NODES","DISABLE_FOG",{type:"logic_negative_expr",places:1},"TEXTURE_NORM_CO","PARALLAX",{type:"logical_and_expr",places:2},"WATER_EFFECTS","CAUSTICS",{type:"logical_and_expr",places:2},{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["bR","=","BG",";"]}]}}]},{type:"textline",tokens:["vec4","BH","=","u_proj_matrix","*","BG",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_JITTER"],
group:{type:"group",parts:[{type:"textline",tokens:["BH",".","xy","+=","u_subpixel_jitter","*","BH",".","w",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"SHADOW_USAGE","SHADOW_MAPPING_OPAQUE",{type:"equal_expr",places:2},"REFRACTIVE","USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["bU","=","bP","(","BH",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE",
"SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["xz","(","BB",".","a",",","BB",".","e",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE","NODES",{type:"logic_negative_expr",places:1},"USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",places:2},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["bV","=","-","BG",".","z","/","u_view_max_depth",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["NODES"],group:{type:"group",parts:[{type:"textline",tokens:["wA","(",")",";"]}]}}]},{type:"textline",tokens:["gl_Position","=","BH",";","}"]}]},exports["particles_color.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"include",file:"gamma.glslf"},{type:"condition",parts:[{type:"if",expression:["SOFT_PARTICLES"],group:{type:"group",parts:[{type:"include",file:"pack.glslf"}]}}]},{type:"var",name:"SOFT_STRENGTH",tokens:["1.0"]},{type:"textline",tokens:["uniform",
"vec4","u_diffuse_color",";","uniform","float","u_p_alpha_start",";","uniform","float","u_p_alpha_end",";","uniform","vec2","u_texel_size",";"]},{type:"condition",parts:[{type:"if",expression:["SOFT_PARTICLES"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_scene_depth",";","uniform","float","u_view_max_depth",";"]}]}}]},{type:"textline",tokens:["varying","float","Br",";","varying","vec3","yy",";"]},{type:"condition",parts:[{type:"if",expression:["SOFT_PARTICLES"],
group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bR",";","varying","vec3","bU",";","varying","float","Bs",";"]}]}}]},{type:"textline",tokens:["void","main","(",")","{","vec2","Bt","=","gl_PointCoord","-","0.5",";","float","Bu","=","2.0","*","length","(","Bt",")",";","float","Bv","=","smoothstep","(","u_p_alpha_start",",","u_p_alpha_end",",","Bu",")",";","float","Bw","=","u_diffuse_color",".","a","*","Br","*","(","1.0","-","Bv",")",";","vec3","Bx","=","yy","*","u_diffuse_color",
".","rgb",";"]},{type:"condition",parts:[{type:"if",expression:["SOFT_PARTICLES"],group:{type:"group",parts:[{type:"textline",tokens:["vec2","By","=","bU",".","xy","/","bU",".","z",";","vec2","Bz","=","vec2","(","Bt",".","x",",","-","Bt",".","y",")","*","Bs","*","u_texel_size",";","vec2","BA","=","vec2","(","By","+","Bz",")",";","vec4","BB","=","texture2D","(","u_scene_depth",",","BA",")",";","float","BC","=","l","(","BB",")",";","float","BD","=","-","bR",".","z","/","u_view_max_depth",";","float",
"BE","=","BC","-","BD",";","float","BF","=","u_view_max_depth","/","SOFT_STRENGTH","*","BE",";","Bw","=","Bw","*","min","(","BF",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["bb","(","Bx",")",";"]},{type:"condition",parts:[{type:"if",expression:["ALPHA","ALPHA_CLIP",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["be","(","Bx",",","Bw",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor","=","vec4","(","Bx",",","Bw",
")",";","}"]}]},exports["particles_color.glslv"]={type:"group",parts:[{type:"var",name:"COLOR_RAMP_LENGTH",tokens:["0"]},{type:"var",name:"SIZE_RAMP_LENGTH",tokens:["0"]},{type:"textline",tokens:["attribute","vec3","a_position",";","attribute","vec3","a_normal",";","attribute","float","a_p_delay",";","attribute","float","a_p_lifetime",";","attribute","vec4","a_p_vels",";"]},{type:"condition",parts:[{type:"if",expression:["COLOR_RAMP_LENGTH",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","vec4","u_p_color_ramp","[","COLOR_RAMP_LENGTH","]",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SIZE_RAMP_LENGTH",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec2","u_p_size_ramp","[","SIZE_RAMP_LENGTH","]",";"]}]}}]},{type:"textline",tokens:["uniform","float","u_p_time",";","uniform","float","u_p_length",";","uniform","int","u_p_cyclic",";","uniform","float","u_p_fade_in",";","uniform","float","u_p_fade_out",";","uniform",
"float","u_p_nfactor",";","uniform","float","u_p_gravity",";","uniform","float","u_p_mass",";","uniform","float","u_p_wind_fac",";","uniform","float","u_p_max_lifetime",";","uniform","mat4","u_view_matrix",";","uniform","mat4","u_proj_matrix",";","uniform","vec3","u_wind",";","uniform","float","u_height",";","uniform","float","u_p_size",";"]},{type:"condition",parts:[{type:"if",expression:["WORLD_SPACE",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["uniform",
"mat4","u_model_matrix",";"]}]}}]},{type:"textline",tokens:["varying","float","Br",";","varying","vec3","yy",";"]},{type:"condition",parts:[{type:"if",expression:["SOFT_PARTICLES"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bR",";","varying","vec3","bU",";","varying","float","Bs",";"]}]}}]},{type:"include",file:"particles.glslv"},{type:"textline",tokens:["void","main","(",")","{","Bt","Ci",";","Ci","=","Ch","(",")",";","vec4","Cj","=","u_view_matrix","*","vec4","(","Ci",
".","b",",","1.0",")",";","vec4","Ck","=","u_proj_matrix","*","Cj",";","gl_Position","=","Ck",";","Br","=","Ci",".","c",";","yy","=","Ci",".","d",";"]},{type:"condition",parts:[{type:"if",expression:["SOFT_PARTICLES"],group:{type:"group",parts:[{type:"textline",tokens:["bR","=","Cj",";"]}]}}]},{type:"textline",tokens:["float","Cl","=","u_height","*","u_proj_matrix","[","1","]","[","1","]","*","u_p_size","/","gl_Position",".","z",";","float","Cm","=","Ci",".","a","*","Cl",";"]},{type:"condition",parts:[{type:"if",
expression:["SOFT_PARTICLES"],group:{type:"group",parts:[{type:"textline",tokens:["float","Cn","=","Ck",".","x",";","float","Co","=","Ck",".","y",";","float","Cp","=","Ck",".","w",";","bU",".","x","=","(","Cn","+","Cp",")","/","2.0",";","bU",".","y","=","(","Co","+","Cp",")","/","2.0",";","bU",".","z","=","Cp",";","Bs","=","Cm",";"]}]}}]},{type:"textline",tokens:["gl_PointSize","=","Cm",";","}"]}]},exports["particles_texture.glslf"]={type:"group",parts:[{type:"var",name:"NUM_LIGHTS",tokens:["0"]},
{type:"var",name:"LAMP_IND",tokens:["0"]},{type:"var",name:"LAMP_SPOT_SIZE",tokens:["0"]},{type:"var",name:"LAMP_SPOT_BLEND",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_DIST",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_FACT_IND",tokens:["0"]},{type:"var",name:"LAMP_FAC_CHANNELS",tokens:["rgb"]},{type:"var",name:"LAMP_SHADOW_MAP_IND",tokens:["0"]},{type:"var",name:"NUM_LFACTORS",tokens:["0"]},{type:"include",file:"std_enums.glsl"},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"gamma.glslf"},
{type:"condition",parts:[{type:"if",expression:["SOFT_PARTICLES"],group:{type:"group",parts:[{type:"include",file:"pack.glslf"}]}}]},{type:"var",name:"PARTICLES_SHADELESS",tokens:["0"]},{type:"var",name:"SOFT_STRENGTH",tokens:["1.0"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_sampler",";"]}]}}]},{type:"textline",tokens:["uniform","float","u_environment_energy",";"]},{type:"condition",parts:[{type:"if",
expression:["NUM_LIGHTS",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_light_positions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_directions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_color_intensities","[","NUM_LIGHTS","]",";","uniform","vec4","u_light_factors","[","NUM_LFACTORS","]",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","vec4","u_fog_color_density",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_underwater_fog_color_density",";","uniform","float","u_cam_water_depth",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["PROCEDURAL_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_cube_fog",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_FOG"],group:{type:"group",
parts:[{type:"textline",tokens:["uniform","vec4","u_fog_params",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_diffuse_color_factor",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ENVIRONMENT_LIGHT","SKY_TEXTURE",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_sky_texture",";"]}]}},{type:"elif",expression:["USE_ENVIRONMENT_LIGHT",
"SKY_COLOR",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_horizon_color",";","uniform","vec3","u_zenith_color",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SOFT_PARTICLES"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_scene_depth",";","uniform","float","u_view_max_depth",";"]}]}}]},{type:"textline",tokens:["uniform","vec4","u_diffuse_color",";","uniform","vec2","u_diffuse_params",
";","uniform","float","u_diffuse_intensity",";","uniform","float","u_emit",";","uniform","float","u_ambient",";","uniform","vec3","u_specular_color",";","uniform","vec3","u_specular_params",";","varying","float","Br",";","varying","vec3","yy",";","varying","vec2","b_",";","varying","vec3","bQ",";"]},{type:"condition",parts:[{type:"if",expression:["PARTICLES_SHADELESS",{type:"logic_negative_expr",places:1},"DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_or_expr",places:2}],group:{type:"group",
parts:[{type:"textline",tokens:["varying","vec3","yx",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1},"SOFT_PARTICLES",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bR",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SOFT_PARTICLES"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bU",";"]}]}}]},{type:"include",file:"environment.glslf"},{type:"condition",
parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"include",file:"fog.glslf"}]}}]},{type:"condition",parts:[{type:"if",expression:["PARTICLES_SHADELESS",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"include",file:"lighting_nodes.glslf"}]}}]},{type:"textline",tokens:["void","main","(",")","{","vec4","Ci","=","u_diffuse_color",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",
parts:[{type:"textline",tokens:["vec4","Cj","=","texture2D","(","u_sampler",",","b_",")",";","a_","(","Cj",".","rgb",")",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MIX",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Ci",".","rgb","=","mix","(","Ci",".","rgb",",","Cj",".","rgb",",","u_diffuse_color_factor",")",";"]}]}},{type:"elif",expression:["TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MULTIPLY",{type:"equal_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Ci",".","rgb","*=","mix","(","vec3","(","1.0",")",",","Cj",".","rgb",",","u_diffuse_color_factor",")",";"]}]}}]},{type:"textline",tokens:["Ci",".","a","=","Cj",".","a",";"]}]}}]},{type:"textline",tokens:["Ci",".","rgb","*=","yy",";","vec3","Ck","=","u_diffuse_intensity","*","Ci",".","rgb",";"]},{type:"condition",parts:[{type:"if",expression:["PARTICLES_SHADELESS",{type:"logic_negative_expr",places:1},"DISABLE_FOG",{type:"logic_negative_expr",
places:1},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","Cl","=","normalize","(","yx",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["PARTICLES_SHADELESS",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","Cm","=","u_emit","*","Ci",".","rgb",";","vec3","Cn","=","vec3","(","0.0",",","1.0",",","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["USE_ENVIRONMENT_LIGHT","SKY_TEXTURE",
{type:"logic_negative_expr",places:1},"SKY_COLOR",{type:"logical_and_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","Co","=","u_environment_energy","*","ew","(","vec3","(","0.0",")",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","Co","=","u_environment_energy","*","ew","(","Cn",")",";"]}]}}]},{type:"textline",tokens:["vec3","Cp","=","u_ambient","*","Co",";","float","Cq","=","u_specular_params","[","0","]",";","vec2","Cr","=","vec2",
"(","u_specular_params","[","1","]",",","u_specular_params","[","2","]",")",";","vec3","Cs","=","Cq","*","u_specular_color",";","vec3","Ct",";","vec3","Cu",";","Bq","(","Cm",",","Cp",",","Ck",",","Cs",",","bQ",",","Cn",",","Cl",",","Cr",",","u_diffuse_params",",","1.0",",","0.0",",","vec4","(","0.0",")",",","Ct",",","Cu",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","Ct","=","Ck",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",
places:1}],group:{type:"group",parts:[{type:"textline",tokens:["yw","(","Ct",",","length","(","bR",")",",","Cl",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["float","Cv","=","Ci",".","a","*","Br",";"]},{type:"condition",parts:[{type:"if",expression:["SOFT_PARTICLES"],group:{type:"group",parts:[{type:"textline",tokens:["float","Cw","=","-","bR",".","z","/","u_view_max_depth",";","vec4","Cx","=","texture2DProj","(","u_scene_depth",",","bU",")",";","float","Cy","=","l","(","Cx",")",";","float",
"Cz","=","Cy","-","Cw",";","float","CA","=","u_view_max_depth","/","SOFT_STRENGTH","*","Cz",";","Cv","=","Cv","*","min","(","CA",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["bb","(","Ct",")",";"]},{type:"condition",parts:[{type:"if",expression:["ALPHA","ALPHA_CLIP",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["be","(","Ct",",","Cv",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor","=","vec4","(","Ct",",","Cv",
")",";","}"]}]},exports["particles_texture.glslv"]={type:"group",parts:[{type:"var",name:"BILLBOARD_ALIGN",tokens:["0"]},{type:"var",name:"COLOR_RAMP_LENGTH",tokens:["0"]},{type:"var",name:"SIZE_RAMP_LENGTH",tokens:["0"]},{type:"include",file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"define",name:"BILLBOARD_ALIGN_VIEW",tokens:["1"]},{type:"define",name:"BILLBOARD_ALIGN_XY",tokens:["2"]},{type:"define",name:"BILLBOARD_ALIGN_YZ",tokens:["3"]},{type:"define",name:"BILLBOARD_ALIGN_ZX",
tokens:["4"]},{type:"textline",tokens:["attribute","vec3","a_position",";","attribute","vec3","a_normal",";","attribute","float","a_p_delay",";","attribute","float","a_p_lifetime",";","attribute","vec4","a_p_vels",";","attribute","vec2","a_p_bb_vertex",";"]},{type:"condition",parts:[{type:"if",expression:["COLOR_RAMP_LENGTH",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_p_color_ramp","[","COLOR_RAMP_LENGTH","]",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["SIZE_RAMP_LENGTH",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec2","u_p_size_ramp","[","SIZE_RAMP_LENGTH","]",";"]}]}}]},{type:"textline",tokens:["uniform","float","u_p_time",";","uniform","float","u_p_length",";","uniform","int","u_p_cyclic",";","uniform","float","u_p_fade_in",";","uniform","float","u_p_fade_out",";","uniform","float","u_p_nfactor",";","uniform","float","u_p_gravity",";","uniform","float","u_p_mass",";","uniform","float",
"u_p_wind_fac",";","uniform","float","u_p_max_lifetime",";","uniform","mat4","u_proj_matrix",";","uniform","mat4","u_view_matrix",";","uniform","vec3","u_camera_eye",";","uniform","vec3","u_wind",";","uniform","float","u_p_size",";"]},{type:"condition",parts:[{type:"if",expression:["WORLD_SPACE",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_model_matrix",";"]}]}}]},{type:"textline",tokens:["varying","float","Br",";","varying","vec3",
"yy",";","varying","vec2","b_",";","varying","vec3","yx",";","varying","vec3","bQ",";"]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1},"SOFT_PARTICLES",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bR",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SOFT_PARTICLES"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bU",";"]}]}}]},{type:"include",file:"particles.glslv"},
{type:"textline",tokens:["float","Ck","(","vec2","Ci",",","vec2","Cj",")","{","return","(","atan","(","Cj",".","y",",","Cj",".","x",")","-","atan","(","Ci",".","y",",","Ci",".","x",")",")",";","}","void","main","(",")","{","Bt","Cl",";","Cl","=","Ch","(",")",";","float","Cm",";","mat4","Cn",";","if","(","BILLBOARD_ALIGN","==","BILLBOARD_ALIGN_VIEW",")","{","Cm","=","Cl",".","e",";","Cn","=","tG","(","Cl",".","b",",","u_view_matrix",")",";","}","else","if","(","BILLBOARD_ALIGN","==","BILLBOARD_ALIGN_XY",
")","{","Cm","=","Cl",".","e",";","Cn","=","bB","(",")",";","Cn","[","3","]","=","vec4","(","Cl",".","b",",","1.0",")",";","}","else","if","(","BILLBOARD_ALIGN","==","BILLBOARD_ALIGN_YZ",")","{","Cm","=","Cl",".","e",";","Cn","=","bF","(","radians","(","90.0",")",")",";","Cn","[","3","]","=","vec4","(","Cl",".","b",",","1.0",")",";","}","else","if","(","BILLBOARD_ALIGN","==","BILLBOARD_ALIGN_ZX",")","{","Cm","=","Ck","(","vec2","(","EPSILON",",","1.0",")",",","vec2","(","a_normal",".","x",",","a_normal",
".","z",")",")","+","Cl",".","e",";","Cn","=","bD","(","radians","(","-","90.0",")",")",";","Cn","[","3","]","=","vec4","(","Cl",".","b",",","1.0",")",";","}","vec4","Co","=","vec4","(","a_p_bb_vertex","*","2.0","*","Cl",".","a","*","u_p_size",",","0.0",",","1.0",")",";","vec4","Cp","=","Cn","*","bH","(","Cm",")","*","Co",";","vec4","Cq","=","u_view_matrix","*","Cp",";","vec4","Cr","=","u_proj_matrix","*","Cq",";"]},{type:"condition",parts:[{type:"if",expression:["SOFT_PARTICLES"],group:{type:"group",
parts:[{type:"textline",tokens:["float","Cs","=","Cr",".","x",";","float","Ct","=","Cr",".","y",";","float","Cu","=","Cr",".","w",";","bU",".","x","=","(","Cs","+","Cu",")","/","2.0",";","bU",".","y","=","(","Ct","+","Cu",")","/","2.0",";","bU",".","z","=","Cu",";"]}]}}]},{type:"textline",tokens:["gl_Position","=","Cr",";","Br","=","Cl",".","c",";","yy","=","Cl",".","d",";","b_","=","a_p_bb_vertex","+","0.5",";","bQ","=","Cp",".","xyz",";","yx","=","u_camera_eye","-","Cp",".","xyz",";"]},{type:"condition",
parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1},"SOFT_PARTICLES",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["bR","=","Cq",";"]}]}}]},{type:"textline",tokens:["}"]}]},exports["procedural_skydome.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"include",file:"gamma.glslf"},{type:"textline",tokens:["uniform","vec3","u_sky_color",";","uniform","vec3","u_sun_direction",";","uniform","float",
"u_rayleigh_brightness",";","uniform","float","u_mie_brightness",";","uniform","float","u_spot_brightness",";","uniform","float","u_scatter_strength",";","uniform","float","u_rayleigh_strength",";","uniform","float","u_mie_strength",";","uniform","float","u_rayleigh_collection_power",";","uniform","float","u_mie_collection_power",";","uniform","float","u_mie_distribution",";","varying","vec3","Ci",";","const","float","Cj","=","0.99",";","const","float","Ck","=","1.8",";","const","int","Cl","=","8",
";","float","Cv","(","vec3","Cm",",","vec3","Cn",")","{","float","Co","=","dot","(","Cn",",","Cn",")",";","float","Cp","=","2.0","*","dot","(","Cn",",","Cm",")",";","float","Cq","=","dot","(","Cm",",","Cm",")","-","1.0",";","float","Cr","=","Cp","*","Cp","-","4.0","*","Co","*","Cq",";","float","Cs","=","sqrt","(","Cr",")",";","float","Ct","=","(","-","Cp","-","Cs",")","/","2.0",";","float","Cu","=","Cq","/","Ct",";","return","Cu",";","}","float","CC","(","float","Cw",",","float","Cx",")","{","float",
"Cy","=","3.0","*","(","1.0","-","Cx","*","Cx",")",";","float","Cz","=","2.0","*","(","2.0","+","Cx","*","Cx",")",";","float","CA","=","1.0","+","Cw","*","Cw",";","float","CB","=","pow","(","1.0","+","Cx","*","Cx","-","2.0","*","Cx","*","Cw",",","1.5",")",";","CB","=","max","(","CB",",","0.00001",")",";","return","(","Cy","/","Cz",")","*","(","CA","/","CB",")",";","}","float","CK","(","vec3","CD",",","vec3","CE",",","float","CF",")","{","float","CG","=","dot","(","CE",",","-","CD",")",";","if","(",
"CG","<","0.0",")","{","return","1.0",";","}","vec3","CH","=","CD","+","CG","*","CE",";","if","(","length","(","CH",")","<","CF",")","{","return","0.0",";","}","else","if","(","length","(","CH",")",">=","CF",")","{","vec3","CI","=","normalize","(","CH",")","*","CF","-","CD",";","float","CJ","=","acos","(","dot","(","normalize","(","CI",")",",","CE",")",")",";","return","smoothstep","(","0.0",",","1.0",",","pow","(","CJ","*","2.0",",","3.0",")",")",";","}","else","return","1.0",";","}","vec3","CO",
"(","float","CL",",","vec3","CM",",","float","CN",")","{","return","CM","-","CM","*","pow","(","u_sky_color",",","vec3","(","CN","/","CL",")",")",";","}","void","main","(",")","{","vec3","CP","=","normalize","(","Ci",")",";","vec3","CQ","=","u_sun_direction",";","float","CR","=","dot","(","CP",",","CQ",")",";","float","CS","=","CC","(","CR",",","-","0.01",")","*","u_rayleigh_brightness","*","CQ",".","y",";","float","CT","=","CC","(","CR","-","0.5",",","u_mie_distribution",")","*","u_mie_brightness",
"*","(","1.0","-","CQ",".","y",")",";","float","CU","=","smoothstep","(","0.0",",","100.0",",","CC","(","CR",",","0.9995",")",")","*","u_spot_brightness",";","vec3","CV","=","vec3","(","0.0",",","Cj",",","0.0",")",";","float","CW","=","Cv","(","CV",",","CP",")",";","float","CX","=","CW","/","float","(","Cl",")",";","float","CY","=","CK","(","CV",",","CP",",","Cj","-","0.3",")",";","vec3","CZ","=","vec3","(","0.0",",","0.0",",","0.0",")",";","vec3","C_","=","vec3","(","0.0",",","0.0",",","0.0",")",
";","for","(","int","Da","=","0",";","Da","<","Cl",";","Da","++",")","{","float","Db","=","CX","*","float","(","Da",")",";","vec3","Dc","=","CV","+","CP","*","Db",";","float","Dd","=","CK","(","Dc",",","CQ",",","Cj","-","0.2",")",";","float","De","=","Cv","(","Dc",",","CQ",")",";","vec3","Df","=","CO","(","De",",","vec3","(","Ck",")",",","u_scatter_strength",")","*","Dd",";","CZ","+=","CO","(","sqrt","(","Db",")",",","u_sky_color","*","Df",",","u_rayleigh_strength",")",";","C_","+=","CO","(","Db",
",","Df",",","u_mie_strength",")",";","}","CZ","=","CZ","*","CY","*","pow","(","CW",",","u_rayleigh_collection_power",")","/","float","(","Cl",")",";","C_","=","(","C_","*","CY","*","pow","(","CW",",","u_mie_collection_power",")",")","/","float","(","Cl",")",";","vec3","Dg","=","vec3","(","CU","*","C_","+","CT","*","C_","+","CS","*","CZ",")",";","bb","(","Dg",")",";","gl_FragColor","=","vec4","(","Dg",",","1.0",")",";","}"]}]},exports["procedural_skydome.glslv"]={type:"group",parts:[{type:"textline",
tokens:["attribute","vec3","a_position",";","uniform","mat4","u_cube_view_matrix",";","varying","vec3","Ci",";","void","main","(",")","{","vec4","Cj","=","vec4","(","a_position",".","xy",",","0.999999",",","1.0",")",";","vec4","Ck","=","u_cube_view_matrix","*","Cj",";","Ci","=","Ck",".","xyz",";","gl_Position","=","Cj",";","}"]}]},exports["special_lens_flares.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"include",file:"gamma.glslf"},{type:"textline",tokens:["uniform",
"sampler2D","u_sampler",";","varying","vec2","b_",";","void","main","(",")","{","vec4","Cj","=","texture2D","(","u_sampler",",","b_",")",";","bb","(","Cj",".","rgb",")",";","be","(","Cj",".","rgb",",","Cj",".","a",")",";","gl_FragColor","=","Cj",";","}"]}]},exports["special_lens_flares.glslv"]={type:"group",parts:[{type:"var",name:"NUM_LIGHTS",tokens:["0"]},{type:"define",name:"LIGHT_INDEX",tokens:["0"]},{type:"textline",tokens:["attribute","float","a_lf_dist",";","attribute","vec2","a_lf_bb_vertex",
";","attribute","vec2","a_texcoord",";","uniform","mat4","u_view_matrix",";","uniform","mat4","u_proj_matrix",";","uniform","vec3","u_light_directions","[","NUM_LIGHTS","]",";","varying","vec2","b_",";","void","main","(",")","{","b_","=","a_texcoord",";","vec3","Cj","=","normalize","(","u_light_directions","[","LIGHT_INDEX","]",")",";","vec4","Ck","=","u_proj_matrix","*","u_view_matrix","*","vec4","(","Cj",",","0.0",")",";","Ck",".","x","/=","Ck",".","w",";","Ck",".","y","/=","Ck",".","w",";","Ck",
"+=","99999.0","*","step","(","Ck",".","z",",","0.0",")",";","Ck","+=","100.0","*","(","step","(","1.0",",","abs","(","Ck",".","x",")",")","+","step","(","1.0",",","abs","(","Ck",".","y",")",")",")",";","Ck",".","x","=","-","a_lf_dist","*","Ck",".","x",";","Ck",".","y","=","-","a_lf_dist","*","Ck",".","y",";","float","Cl","=","u_proj_matrix","[","1","]","[","1","]","/","u_proj_matrix","[","0","]","[","0","]",";","vec2","Cm","=","vec2","(","a_lf_bb_vertex",".","x","/","Cl",",","a_lf_bb_vertex",".",
"y",")",";","if","(","a_lf_dist",">","-","0.999",")","{","const","float","Cn","=","1.9",";","Cm","*=","(","1.0","+","Cn","*","length","(","Ck",".","xy",")",")",";","}","gl_Position","=","vec4","(","Ck",".","xy","+","Cm",",","0.999999",",","1.0",")",";","}"]}]},exports["special_skydome.glslf"]={type:"group",parts:[{type:"var",name:"WATER_LEVEL",tokens:["0.0"]},{type:"define",name:"INV_PI",tokens:["0.318309886"]},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"gamma.glslf"},
{type:"condition",parts:[{type:"if",expression:["WO_SKYTEX","PROCEDURAL_SKYDOME",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_sky",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["PROCEDURAL_SKYDOME",{type:"logic_negative_expr",places:1},"WO_SKYTEX",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"include",file:"std_enums.glsl"},{type:"include",file:"blending.glslf"},{type:"textline",tokens:["uniform",
"vec4","u_sky_tex_fac",";","uniform","vec3","u_sky_tex_color",";","uniform","float","u_sky_tex_dvar",";","vec3","Et","(","vec3","Eo",",","vec3","Ep",",","float","Eq",",","float","Er",")","{","float","Es","=","Eq","*","Er",";"]},{type:"condition",parts:[{type:"if",expression:["BLENDTYPE","MIX",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","CB","(","Ep",",","Eo",",","Es",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","ADD",{type:"equal_expr",places:2}],
group:{type:"group",parts:[{type:"textline",tokens:["return","CF","(","Eo",",","Ep",",","Es",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","SUBTRACT",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","CJ","(","Eo",",","Ep",",","Es",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","MULTIPLY",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","CO","(","Eo",",","Ep",",","Es",")",";"]}]}},{type:"elif",expression:["BLENDTYPE",
"SCREEN",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","CT","(","Eo",",","Ep",",","Es",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","OVERLAY",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","CY","(","Eo",",","Ep",",","Es",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","DIFFERENCE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","Db","(","Eo",",","Ep",",","Es",
")",";"]}]}},{type:"elif",expression:["BLENDTYPE","DIVIDE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","Df","(","Eo",",","Ep",",","Es",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","DARKEN",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","Dj","(","Eo",",","Ep",",","Es",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","LIGHTEN",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return",
"Dn","(","Eo",",","Ep",",","Es",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","HUE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","Du","(","Ep",",","Eo",",","Es",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","SATURATION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","DA","(","Ep",",","Eo",",","Es",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","VALUE",{type:"equal_expr",places:2}],group:{type:"group",
parts:[{type:"textline",tokens:["return","DG","(","Ep",",","Eo",",","Es",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","COLOR",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","DN","(","Ep",",","Eo",",","Es",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","SOFT_LIGHT",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","DS","(","Ep",",","Eo",",","Es",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","LINEAR_LIGHT",
{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","DW","(","Ep",",","Eo",",","Es",")",";"]}]}}]},{type:"textline",tokens:["return","vec3","(","1.0",",","0.0",",","1.0",")",";","}","float","EB","(","float","Eu",",","float","Ev",",","float","Ew",",","float","Ex",")","{","vec3","Ey","=","vec3","(","Eu",")",",","Ez","=","vec3","(","Ev",")",";","float","EA","=","Ew","*","Ex",";"]},{type:"condition",parts:[{type:"if",expression:["BLENDTYPE","MIX",{type:"equal_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","CB","(","Ez",",","Ey",",","EA",")",".","x",";"]}]}},{type:"elif",expression:["BLENDTYPE","ADD",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","CF","(","Ey",",","Ez",",","EA",")",".","x",";"]}]}},{type:"elif",expression:["BLENDTYPE","SUBTRACT",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","CJ","(","Ey",",","Ez",",","EA",")",".","x",";"]}]}},
{type:"elif",expression:["BLENDTYPE","MULTIPLY",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","Eb","(","Eu",",","Ev",",","EA",",","Ex",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","SCREEN",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","Eh","(","Eu",",","Ev",",","EA",",","Ex",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","OVERLAY",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["return","En","(","Eu",",","Ev",",","EA",",","Ex",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","DIFFERENCE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","Db","(","Ey",",","Ez",",","EA",")",".","x",";"]}]}},{type:"elif",expression:["BLENDTYPE","DIVIDE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","Df","(","Ey",",","Ez",",","EA",")",".","x",";"]}]}},{type:"elif",expression:["BLENDTYPE","DARKEN",
{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","Dj","(","Ey",",","Ez",",","EA",")",".","x",";"]}]}},{type:"elif",expression:["BLENDTYPE","LIGHTEN",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","Dn","(","Ey",",","Ez",",","EA",")",".","x",";"]}]}},{type:"elif",expression:["BLENDTYPE","SOFT_LIGHT",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","DS","(","Ez",",","Ey",",",
"EA",")",".","x",";"]}]}},{type:"elif",expression:["BLENDTYPE","LINEAR_LIGHT",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","DW","(","Ez",",","Ey",",","EA",")",".","x",";"]}]}}]},{type:"textline",tokens:["return","0.0",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["PROCEDURAL_SKYDOME",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_horizon_color",";","uniform","vec3","u_zenith_color",
";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","DISABLE_FOG",{type:"logic_negative_expr",places:1},"REFLECTION_PASS",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_camera_eye_frag",";","uniform","vec3","u_sun_intensity",";","uniform","float","u_environment_energy",";","uniform","vec4","u_underwater_fog_color_density",";"]}]}}]},{type:"textline",tokens:["varying","vec3","Ci",
";"]},{type:"condition",parts:[{type:"if",expression:["PROCEDURAL_SKYDOME",{type:"logic_negative_expr",places:1},"WO_SKYTEX","WO_SKYBLEND",{type:"logical_or_expr",places:2},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","b_",";"]}]}}]},{type:"textline",tokens:["void","main","(",")","{","vec3","EC",";","vec3","ED","=","normalize","(","Ci",")",";"]},{type:"condition",parts:[{type:"if",expression:["PROCEDURAL_SKYDOME"],group:{type:"group",parts:[{type:"textline",
tokens:["EC","=","textureCube","(","u_sky",",","ED",")",".","rgb",";"]}]}},{type:"elif",expression:["WO_SKYTEX","WO_SKYBLEND",{type:"logical_or_expr",places:2},{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["EC","=","u_horizon_color",";","bb","(","EC",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","EE",";"]},{type:"condition",parts:[{type:"if",expression:["WO_SKYPAPER"],group:{type:"group",parts:[{type:"textline",tokens:["EE",
"=","vec3","(","b_",",","0.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["EE","=","vec3","(","Ci",".","xy",",","0.0",")",";"]}]}}]},{type:"textline",tokens:["float","EF","=","0.0",";"]},{type:"condition",parts:[{type:"if",expression:["WO_SKYBLEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WO_SKYPAPER"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WO_SKYREAL"],group:{type:"group",parts:[{type:"textline",
tokens:["EF","=","abs","(","b_",".","y",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["EF","=","(","b_",".","y","+","1.0",")","*","0.5",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["float","EG","=","acos","(","ED",".","y",")",";"]},{type:"condition",parts:[{type:"if",expression:["WO_SKYREAL"],group:{type:"group",parts:[{type:"textline",tokens:["EF","=","abs","(","EG","*","INV_PI","-","0.5",")","*","2.0",";"]}]}},{type:"else",group:{type:"group",
parts:[{type:"textline",tokens:["EF","=","1.0","-","EG","*","INV_PI",";"]}]}}]}]}}]}]}}]},{type:"textline",tokens:["vec3","EH","=","u_horizon_color",";","vec3","EI","=","u_zenith_color",";"]},{type:"condition",parts:[{type:"if",expression:["WO_SKYTEX"],group:{type:"group",parts:[{type:"textline",tokens:["float","EJ","=","1.0",";","vec4","EK","=","textureCube","(","u_sky",",","ED",")",";","a_","(","EK",".","rgb",")",";","EJ","=","EK",".","a",";"]},{type:"condition",parts:[{type:"if",expression:["MTEX_RGBTOINT"],
group:{type:"group",parts:[{type:"textline",tokens:["EJ","=","dot","(","EK",".","rgb",",","vec3","(","0.2126",",","0.7152",",","0.0722",")",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["MTEX_NEGATIVE"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MTEX_RGBTOINT",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["EK","=","vec4","(","vec3","(","1.0",")","-","EK",".","rgb",",","EK",".","a",")",";"]}]}},{type:"else",
group:{type:"group",parts:[{type:"textline",tokens:["EJ","=","1.0","-","EJ",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WOMAP_HORIZ","WOMAP_ZENUP","WOMAP_ZENDOWN",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MTEX_RGBTOINT"],group:{type:"group",parts:[{type:"textline",tokens:["EK","=","vec4","(","u_sky_tex_color",",","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["EJ","=","EK",
".","a",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WOMAP_HORIZ"],group:{type:"group",parts:[{type:"textline",tokens:["EH","=","Et","(","EK",".","rgb",",","EH",",","EJ",",","u_sky_tex_fac","[","1","]",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WOMAP_ZENUP","WOMAP_ZENDOWN",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["float","EL","=","0.0",";"]},{type:"condition",parts:[{type:"if",expression:["WO_SKYREAL"],group:{type:"group",
parts:[{type:"textline",tokens:["if","(","dot","(","EE",",","vec3","(","0.0",",","1.0",",","0.0",")",")",">=","0.0",")","{"]},{type:"condition",parts:[{type:"if",expression:["WOMAP_ZENUP"],group:{type:"group",parts:[{type:"textline",tokens:["EL","=","u_sky_tex_fac","[","2","]",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:[";"]}]}}]},{type:"textline",tokens:["}"]},{type:"condition",parts:[{type:"if",expression:["WOMAP_ZENDOWN"],group:{type:"group",parts:[{type:"textline",
tokens:["else","EL","=","u_sky_tex_fac","[","3","]",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WOMAP_ZENUP"],group:{type:"group",parts:[{type:"textline",tokens:["EL","=","u_sky_tex_fac","[","2","]",";"]}]}},{type:"elif",expression:["WOMAP_ZENDOWN"],group:{type:"group",parts:[{type:"textline",tokens:["EL","=","u_sky_tex_fac","[","3","]",";"]}]}}]}]}}]},{type:"textline",tokens:["if","(","EL","!=","0.0",")","EI","=","Et","(","EK",".","rgb",
",","EI",",","EJ",",","EL",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WOMAP_BLEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MTEX_RGBTOINT",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["EJ","=","dot","(","EK",".","rgb",",","vec3","(","0.2126",",","0.7152",",","0.0722",")",")",";"]}]}}]},{type:"textline",tokens:["EF","=","EB","(","u_sky_tex_dvar",",","EF",",","EJ",",","u_sky_tex_fac","[","0",
"]",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WO_SKYBLEND"],group:{type:"group",parts:[{type:"textline",tokens:["EC","=","mix","(","EH",",","EI",",","EF",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["EC","=","EH",";"]}]}}]},{type:"textline",tokens:["bb","(","EC",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["bb","(","EH",")",";","bb","(","EI",")",";"]},{type:"condition",parts:[{type:"if",expression:["WO_SKYBLEND"],
group:{type:"group",parts:[{type:"textline",tokens:["EC","=","mix","(","EH",",","EI",",","EF",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["EC","=","EH",";"]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","DISABLE_FOG",{type:"logic_negative_expr",places:1},"REFLECTION_PASS",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["a_","(","EC",")",";","float","EM",
"=","u_camera_eye_frag",".","y","-","WATER_LEVEL",";","EM","=","min","(","-","EM","*","0.03",",","0.8",")",";","float","EN","=","clamp","(","length","(","u_sun_intensity",")","+","u_environment_energy",",","0.0",",","1.0",")",";","vec3","EO","=","vec3","(","0.0",")",";","vec4","EP","=","u_underwater_fog_color_density",";","EP",".","rgb","=","mix","(","EP",".","rgb",",","EO",",","min","(","-","ED",".","y","+","EM",",","1.0",")",")","*","EN",";","float","EQ","=","clamp","(","sign","(","ED",".","y",
"-","0.05","*","EM",")",",","0.0",",","1.0",")",";","EC","=","mix","(","EP",".","rgb",",","EC",",","EQ",")",";","bb","(","EC",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor","=","vec4","(","EC",",","1.0",")",";","}"]}]},exports["special_skydome.glslv"]={type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_position",";","uniform","mat4","u_sky_vp_inverse",";","varying","vec3","Ci",";"]},{type:"condition",parts:[{type:"if",expression:["PROCEDURAL_SKYDOME",{type:"logic_negative_expr",
places:1},"WO_SKYTEX","WO_SKYBLEND",{type:"logical_or_expr",places:2},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","b_",";"]}]}}]},{type:"textline",tokens:["void","main","(",")","{","vec4","Eo","=","vec4","(","a_position",".","xy",",","0.9999999",",","1.0",")",";","vec4","Ep","=","u_sky_vp_inverse","*","Eo",";","Ci","=","Ep",".","xyz",";"]},{type:"condition",parts:[{type:"if",expression:["PROCEDURAL_SKYDOME",{type:"logic_negative_expr",places:1},
"WO_SKYTEX","WO_SKYBLEND",{type:"logical_or_expr",places:2},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["b_","=","a_position",".","xy",";"]}]}}]},{type:"textline",tokens:["gl_Position","=","Eo",";","}"]}]},exports["special_water.glslf"]={type:"group",parts:[{type:"var",name:"ABSORB",tokens:["0.0"]},{type:"var",name:"WATER_LEVEL",tokens:["0.0"]},{type:"var",name:"SSS_STRENGTH",tokens:["6.0"]},{type:"var",name:"SSS_WIDTH",tokens:["0.0"]},{type:"var",name:"PRECISION",
tokens:["lowp"]},{type:"var",name:"NUM_LIGHTS",tokens:["0"]},{type:"var",name:"LAMP_IND",tokens:["0"]},{type:"var",name:"LAMP_SPOT_SIZE",tokens:["0"]},{type:"var",name:"LAMP_SPOT_BLEND",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_DIST",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_FACT_IND",tokens:["0"]},{type:"var",name:"LAMP_FAC_CHANNELS",tokens:["rgb"]},{type:"var",name:"LAMP_SHADOW_MAP_IND",tokens:["0"]},{type:"var",name:"NUM_LFACTORS",tokens:["0"]},{type:"include",file:"std_enums.glsl"},{type:"include",
file:"precision_statement.glslf"},{type:"include",file:"procedural.glslf"},{type:"include",file:"pack.glslf"},{type:"include",file:"gamma.glslf"},{type:"include",file:"math.glslv"},{type:"define",name:"REFL_BUMP",tokens:["0.001"]},{type:"define",name:"REFR_BUMP",tokens:["0.0005"]},{type:"textline",tokens:["uniform","float","u_time",";"]},{type:"condition",parts:[{type:"if",expression:["USE_ENVIRONMENT_LIGHT","SKY_TEXTURE",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","samplerCube","u_sky_texture",";"]}]}},{type:"elif",expression:["USE_ENVIRONMENT_LIGHT","SKY_COLOR",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_horizon_color",";","uniform","vec3","u_zenith_color",";"]}]}}]},{type:"textline",tokens:["uniform","float","u_environment_energy",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_LIGHTS",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform",
"vec3","u_light_positions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_directions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_color_intensities","[","NUM_LIGHTS","]",";","uniform","vec4","u_light_factors","[","NUM_LFACTORS","]",";"]}]}}]},{type:"textline",tokens:["uniform","vec3","u_sun_intensity",";","uniform","vec3","u_sun_direction",";"]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"SHORE_SMOOTHING","WATER_EFFECTS",
"DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2},{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_cam_water_depth",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_fog_color_density",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",
parts:[{type:"textline",tokens:["uniform","vec4","u_underwater_fog_color_density",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["PROCEDURAL_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_cube_fog",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_fog_params",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2}],
group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_normalmap0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_refractmap",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_plane_reflection",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE",
"REFL_MIRRORMAP",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_mirrormap",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_scene_depth",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["FOAM"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_foam",";"]}]}}]},{type:"textline",tokens:["uniform",
"vec4","u_diffuse_color",";","uniform","vec2","u_diffuse_params",";","uniform","float","u_diffuse_intensity",";","uniform","float","u_ambient",";","uniform","vec4","u_fresnel_params",";","uniform","vec3","u_specular_color",";","uniform","vec3","u_specular_params",";","uniform","vec3","u_shallow_water_col",";","uniform","vec3","u_shore_water_col",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform",
"float","u_water_norm_uv_velocity",";","uniform","vec2","u_normalmap0_scale",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",1,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec2","u_normalmap1_scale",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",2,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec2","u_normalmap2_scale",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",
3,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec2","u_normalmap3_scale",";"]}]}}]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_MIRRORMAP",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_mirror_factor",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_reflect_factor",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["SHORE_SMOOTHING","DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_view_max_depth",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_water_shallow_col_fac",";","uniform","float","u_water_shore_col_fac",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["FOAM"],group:{type:"group",
parts:[{type:"textline",tokens:["uniform","float","u_foam_factor",";","uniform","vec2","u_foam_uv_freq",";","uniform","vec2","u_foam_mag",";","uniform","vec2","u_foam_scale",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_refr_bump",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DEBUG_WIREFRAME"],group:{type:"group",parts:[{type:"textline",tokens:["const","float","Eo","=","1.0",";","uniform",
"vec3","u_wireframe_edge_color",";"]}]}}]},{type:"textline",tokens:["varying","vec3","yx",";","varying","vec3","bQ",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2},"FOAM",{type:"logical_or_expr",places:2},"GENERATED_MESH",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","b_",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bT",";","varying","vec3","Ep",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC","NUM_NORMALMAPS",0,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bS",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2},"FOAM",{type:"logical_or_expr",places:2},"GENERATED_MESH","DYNAMIC",
{type:"logical_and_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","Eq",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","Er",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING","REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"REFRACTIVE",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["varying",
"vec3","bU",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING","REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"REFRACTIVE","DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["varying","float","bV",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DEBUG_WIREFRAME"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","Es",";"]}]}}]},{type:"include",
file:"environment.glslf"},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE","SHORE_SMOOTHING","USE_REFRACTION_CORRECTION",{type:"logical_and_expr",places:3}],group:{type:"group",parts:[{type:"include",file:"refraction.glslf"}]}}]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"include",file:"fog.glslf"}]}}]},{type:"textline",tokens:["vec3","EG","(","in","vec2","Et",",","in","vec3","Eu",",","in","vec3",
"Ev",",","in","vec3","Ew",",","out","float","Ex",")","{","Ex","=","0.0",";","vec3","Ey","=","reflect","(","-","Ev",",","Eu",")",";"]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec2","Ez","=","Et",".","xy","+","Eu",".","xz","*","REFL_BUMP","/","bV",";","Ex","=","u_reflect_factor",";","vec3","EA",";","if","(","u_cam_water_depth","<","0.0",")","{"]},{type:"condition",parts:[{type:"if",
expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1},"WATER_EFFECTS",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["EA","=","u_underwater_fog_color_density",".","rgb",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["EA","=","u_diffuse_color",".","rgb",";"]}]}}]},{type:"textline",tokens:["}","else","{","EA","=","texture2D","(","u_plane_reflection",",","Ez",")",".","rgb",";","a_","(","EA",")",";","}"]}]}},{type:"elif",expression:["REFLECTION_TYPE",
"REFL_MIRRORMAP",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Ex","=","u_mirror_factor",";","vec3","EA","=","Ew","*","textureCube","(","u_mirrormap",",","Ey",")",".","rgb",";","a_","(","EA",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Ex","=","u_reflect_factor",";","vec3","EA","=","Ew","*","vec3","(","0.3",",","0.5",",","1.0",")",";","a_","(","EA",")",";"]}]}}]},{type:"textline",tokens:["vec3","EB","=","normalize","(","Ey","+",
"Ev",")",";","float","EC","=","1.0","-","dot","(","Ev",",","EB",")",";","float","ED","=","u_fresnel_params","[","3","]",";","float","EE","=","u_fresnel_params","[","2","]",";","float","EF","=","ED","+","(","1.0","-","ED",")","*","pow","(","EC",",","EE",")",";","Ex","=","min","(","Ex","*","EF",",","1.0",")",";","return","EA",";","}"]},{type:"include",file:"lighting_nodes.glslf"},{type:"textline",tokens:["void","main","(",")","{"]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,
{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["mat3","EH","=","mat3","(","bT",",","Ep",",","bS",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","EI","=","normalize","(","bS",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","EI","=","vec3","(","0.0",",","1.0",",","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC","FOAM",
{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["float","EJ","=","bQ",".","y","-","WATER_LEVEL",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2},"FOAM",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["GENERATED_MESH"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC"],group:{type:"group",parts:[{type:"textline",
tokens:["vec2","EK","=","vec2","(","Eq",".","x",",","-","Eq",".","z",")","+","0.5",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec2","EK","=","vec2","(","bQ",".","x",",","-","bQ",".","z",")","+","0.5",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec2","EK","=","b_",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","EL",
"=","vec3","(","0.0",")",";","vec3","EM","=","texture2D","(","u_normalmap0",",","EK","*","u_normalmap0_scale","+","vec2","(","0.3",",","0.5",")","*","u_water_norm_uv_velocity","*","u_time",")",".","xyz","-","0.5",";","EL","+=","EM",";"]},{type:"condition",parts:[{type:"if",expression:["FOAM"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","EN","=","vec3","(","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["NORM_FOAM0"],group:{type:"group",parts:[{type:"textline",tokens:["EN",
"+=","EM",";"]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",1,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["EM","=","texture2D","(","u_normalmap0",",","EK","*","u_normalmap1_scale","+","vec2","(","-","0.3",",","0.7",")","*","u_water_norm_uv_velocity","*","u_time",")",".","xyz","-","0.5",";","EL","+=","EM",";"]},{type:"condition",parts:[{type:"if",expression:["FOAM"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",
expression:["NORM_FOAM1"],group:{type:"group",parts:[{type:"textline",tokens:["EN","+=","EM",";"]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",2,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["EM","=","texture2D","(","u_normalmap0",",","EK","*","u_normalmap2_scale","+","vec2","(","0.0",",","1.1",")","*","u_water_norm_uv_velocity","*","u_time",")",".","xyz","-","0.5",";","EL","+=","EM",";"]},{type:"condition",parts:[{type:"if",expression:["FOAM"],
group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["NORM_FOAM2"],group:{type:"group",parts:[{type:"textline",tokens:["EN","+=","EM",";"]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",3,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["EM","=","texture2D","(","u_normalmap0",",","EK","*","u_normalmap3_scale","+","vec2","(","-","0.66",",","-","0.3",")","*","u_water_norm_uv_velocity","*","u_time",")",".","xyz","-",
"0.5",";","EL","+=","EM",";"]},{type:"condition",parts:[{type:"if",expression:["FOAM"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["NORM_FOAM3"],group:{type:"group",parts:[{type:"textline",tokens:["EN","+=","EM",";"]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["FOAM"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","EO",
"=","EH","*","EN",";","if","(","!","bk","(","EO",",","vec3","(","0.0",")",")",")","EO","=","normalize","(","EO",")",";","vec3","EP","=","mix","(","EI",",","EO",",","0.2",")",";","EP","=","normalize","(","EP",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC"],group:{type:"group",parts:[{type:"textline",tokens:["EI","=","mix","(","EI",",","normalize","(","EH","*","EL",")",",","0.3",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["EI","=","mix","(",
"EI",",","normalize","(","EH","*","EL",")",",","0.5",")",";"]}]}}]},{type:"textline",tokens:["EI","=","normalize","(","EI",")",";"]}]}}]},{type:"textline",tokens:["vec3","EQ","=","normalize","(","yx",")",";"]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"REFRACTIVE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec2","ER","=","bU",".","xy","/","bU",".","z",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["SHORE_SMOOTHING","DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["float","ES","=","bV","*","u_view_max_depth",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING"],group:{type:"group",parts:[{type:"textline",tokens:["float","ET","=","u_diffuse_color",".","a",";","vec4","EU","=","texture2DProj","(","u_scene_depth",",","bU",")",";","float","EV","=","l","(","EU",")",";","float",
"EW","=","max","(","EV","-","bV",",","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["vec2","EX","=","ER","+","EI",".","xz","*","u_refr_bump","/","bV",";","float","EY","=","eC","(","EV",",","EX",",","ER",")",";","float","EZ","=","max","(","EY","-","bV",",","0.0",")",";","float","E_","=","u_view_max_depth","/","ABSORB","*","EZ",";","float","Fa",";","if","(","u_cam_water_depth","<","0.0",")","Fa","=","0.0",";","else",
"Fa","=","min","(","ET","*","E_",",","1.0",")",";","float","Fb","=","u_view_max_depth","/","ABSORB","*","EW",";","ET","=","min","(","15.0","*","ET","*","u_view_max_depth","*","EW",",","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["float","Fb","=","u_view_max_depth","/","ABSORB","*","EW",";","if","(","u_cam_water_depth",">","0.0",")","ET","=","min","(","ET","*","Fb",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["ET","*=","min","(","5.0","*","ES",",","1.0",
")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["float","ET","=","u_diffuse_color",".","a",";"]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["float","Fa","=","1.0","-","ET",";","vec2","EX","=","ER","+","EI",".","xz","*","u_refr_bump","/","bV",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","Fc","=","texture2D",
"(","u_refractmap",",","EX",")",".","rgb",";","a_","(","Fc",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["float","Fd","=","pow","(","min","(","Er",".","b","/","u_water_shallow_col_fac",",","1.0",")",",","0.3",")",";","vec3","Fe","=","mix","(","u_shallow_water_col",",","u_diffuse_color",".","rgb",",","Fd",")",";","Fd","=","pow","(","min","(","Er",".","b","/","u_water_shore_col_fac",",","1.0",")",",","0.3",")",";",
"Fe","=","mix","(","u_shore_water_col",",","Fe",",","Fd",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","Fe","=","u_diffuse_color",".","rgb",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["FOAM"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING"],group:{type:"group",parts:[{type:"textline",tokens:["float","Ff","=","max","(","1.0","-","u_view_max_depth","*","EW",",","0.0",")",";"]}]}},{type:"else",group:{type:"group",
parts:[{type:"textline",tokens:["float","Ff","=","1.0","-","ET",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC"],group:{type:"group",parts:[{type:"textline",tokens:["float","Fg","=","max","(","EJ","/","WAVES_HEIGHT","+","0.1",",","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","Fh","=","normalize","(","vec3","(","Er",".","r",",","0.0",",","Er",".","g",")",")",";","vec3","Fi","=","normalize",
"(","mix","(","vec3","(","0.0",",","1.0",",","0.0",")",",","Fh",",","0.8",")",")",";","float","Fj","=","1.25","*","max","(","dot","(","EP",",","Fi",")","-","0.2",",","0.0",")",";","Fj","+=","max","(","dot","(","EP",",","vec3","(","0.0",",","-","1.0",",","0.0",")",")",",","0.0",")",";","Ff","+=","Fj","*","(","1.0","-","Er",".","b",")",";","Fg","*=","(","1.0","-","0.95","*","pow","(","Er",".","b",",","0.1",")",")",";"]}]}}]},{type:"textline",tokens:["Ff","+=","Fg",";","Ff","=","min","(","u_foam_factor",
"*","Ff",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["vec4","Fk","=","texture2D","(","u_foam",",","u_foam_mag","*","sin","(","u_foam_uv_freq","*","u_time",")","+","EK","*","u_foam_scale",")",";"]}]}}]},{type:"textline",tokens:["float","Fl","=","u_specular_params","[","0","]",";","vec2","Fm","=","vec2","(","u_specular_params","[","1","]",",","u_specular_params","[","2","]",")",";","vec3","Fn","=","Fl","*","u_specular_color",";","vec3","Fo","=","u_environment_energy","*","ew","(","EI",")",";",
"vec3","Fp","=","u_ambient","*","Fo",";","vec3","Fq","=","Fp","+","u_sun_intensity",";","float","Fr",";"]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","Fs","=","EG","(","ER",",","EI",",","EQ",",","Fq",",","Fr",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","Fs","=","EG","(","vec2","(","0.0",")",",","EI",",","EQ",",","Fq",",","Fr",")",";"]}]}}]},
{type:"textline",tokens:["vec3","Ft","=","u_diffuse_intensity","*","Fe",";","vec3","Fu",";","vec3","Fv",";","Bq","(","vec3","(","0.0",")",",","vec3","(","0.0",")",",","Ft",",","Fn",",","bQ",",","EI",",","EQ",",","Fm",",","u_diffuse_params",",","1.0",",","0.0",",","vec4","(","0.0",")",",","Fu",",","Fv",")",";"]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC"],group:{type:"group",parts:[{type:"textline",tokens:["float","Fw","=","max","(","dot","(","u_sun_direction",",","-","bS",")","+","SSS_WIDTH",
",","0.0",")","*","max","(","dot","(","-","EQ",",","u_sun_direction",")","-","0.5",",","0.0",")","*","max","(","0.0",",","length","(","u_sun_intensity",")","-","0.1",")",";","Fw","=","clamp","(","SSS_STRENGTH","*","Fw",",","0.0",",","1.0",")",";","Fu","=","mix","(","Fu",",","u_shallow_water_col",",","Fw",")",";","Fu","=","mix","(","Fu",",","u_shore_water_col",",","Fw",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["Fu",
"=","mix","(","Fc",",","Fu",",","Fa",")",";"]}]}}]},{type:"textline",tokens:["Fu","=","mix","(","Fu",",","Fs",",","Fr",")",";"]},{type:"condition",parts:[{type:"if",expression:["FOAM"],group:{type:"group",parts:[{type:"textline",tokens:["float","Fx","=","mix","(","Fk",".","g",",","Fk",".","r",",","max","(","4.0","*","(","Ff","-","0.75",")",",","0.0",")",")",";","Fx","=","mix","(","Fk",".","b",",","Fx",",","max","(","2.0","*","Ff","-","1.0",",","0.0",")",")",";","Fx","=","mix","(","0.0",",","Fx",",",
"Ff",")",";","Fu","=","mix","(","Fu",",","Fq",",","Fx",")",";"]}]}}]},{type:"textline",tokens:["Fu","+=","Fv",";"]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","u_cam_water_depth","<","0.0",")","{","yp","(","Fu",",","ES",",","u_cam_water_depth",")",";","}","else","{","yw","(","Fu",",","ES",
",","EQ",",","1.0",")",";","}"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["yw","(","Fu",",","ES",",","EQ",",","1.0",")",";"]}]}}]}]}}]},{type:"textline",tokens:["bb","(","Fu",")",";"]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["ET","=","max","(","ET",",","Fv",".","r",")",";"]},{type:"condition",parts:[{type:"if",expression:["FOAM"],group:{type:"group",parts:[{type:"textline",
tokens:["ET","+=","Fx",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["ALPHA"],group:{type:"group",parts:[{type:"textline",tokens:["be","(","Fu",",","ET",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DEBUG_WIREFRAME"],group:{type:"group",parts:[{type:"extension",tokens:["GL_OES_standard_derivatives",":","enable"]},{type:"textline",tokens:["vec3","Fy","=","fwidth","(","Es",")",";","vec3","Fz","=","smoothstep","(","vec3","(","0.0",")",",","Fy","*","Eo",",","Es",")",
";","float","FA","=","min","(","min","(","Fz",".","x",",","Fz",".","y",")",",","Fz",".","z",")",";","FA","=","clamp","(","FA",",","0.0",",","1.0",")",";","Fu","=","mix","(","u_wireframe_edge_color",",","Fu",",","FA",")",";","ET","=","mix","(","1.0",",","ET",",","FA",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor","=","vec4","(","Fu",",","ET",")",";","}"]}]},exports["special_water.glslv"]={type:"group",parts:[{type:"var",name:"DIR_MIN_SHR_FAC",tokens:["0.0"]},{type:"var",name:"DIR_FREQ",tokens:["0.0"]},
{type:"var",name:"DIR_NOISE_SCALE",tokens:["0.0"]},{type:"var",name:"DIR_NOISE_FREQ",tokens:["0.0"]},{type:"var",name:"DIR_MIN_NOISE_FAC",tokens:["0.0"]},{type:"var",name:"DST_NOISE_SCALE_0",tokens:["0.0"]},{type:"var",name:"DST_NOISE_FREQ_0",tokens:["0.0"]},{type:"var",name:"DST_NOISE_SCALE_1",tokens:["0.0"]},{type:"var",name:"DST_NOISE_FREQ_1",tokens:["0.0"]},{type:"var",name:"DST_MIN_FAC",tokens:["0.0"]},{type:"var",name:"MAX_SHORE_DIST",tokens:["0.0"]},{type:"var",name:"PRECISION",tokens:["mediump"]},
{type:"var",name:"SHORE_MAP_CENTER_X",tokens:["0.0"]},{type:"var",name:"SHORE_MAP_SIZE_X",tokens:["0.0"]},{type:"var",name:"SHORE_MAP_CENTER_Y",tokens:["0.0"]},{type:"var",name:"SHORE_MAP_SIZE_Y",tokens:["0.0"]},{type:"var",name:"WAVES_HOR_FAC",tokens:["0.0"]},{type:"var",name:"WATER_LEVEL",tokens:["0.0"]},{type:"var",name:"WAVES_HEIGHT",tokens:["0.0"]},{type:"var",name:"WAVES_LENGTH",tokens:["0.0"]},{type:"include",file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"include",file:"scale_texcoord.glslv"},
{type:"include",file:"procedural.glslf"},{type:"textline",tokens:["attribute","vec3","a_position",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2},"DYNAMIC",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_normal",";","attribute","vec3","a_tangent",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["GENERATED_MESH",{type:"logic_negative_expr",
places:1},"NUM_NORMALMAPS",0,{type:"g_expr",places:2},"FOAM",{type:"logical_or_expr",places:2},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec2","a_texcoord",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DEBUG_WIREFRAME"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","float","a_polyindex",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["STATIC_BATCH"],group:{type:"group",parts:[{type:"textline",tokens:["const",
"mat4","u_model_matrix","=","mat4","(","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_model_matrix",";"]}]}}]},{type:"textline",tokens:["uniform","mat4","u_view_matrix",";","uniform","mat4","u_proj_matrix",";","uniform","vec3","u_camera_eye",";"]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","float","u_time",";","uniform","vec3","u_wind",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["SHORE_SMOOTHING","REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"REFRACTIVE","DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","float","u_view_max_depth",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_shore_dist_map",";"]}]}}]},{type:"textline",
tokens:["varying","vec3","yx",";","varying","vec3","bQ",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2},"FOAM",{type:"logical_or_expr",places:2},"GENERATED_MESH",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","b_",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["varying","vec3","bT",";","varying","vec3","Ep",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC","NUM_NORMALMAPS",0,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bS",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2},"FOAM",{type:"logical_or_expr",places:2},"GENERATED_MESH","DYNAMIC",{type:"logical_and_expr",places:3}],group:{type:"group",
parts:[{type:"textline",tokens:["varying","vec3","Eq",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","Er",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING","REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"REFRACTIVE",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bU",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["SHORE_SMOOTHING","REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"REFRACTIVE","DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["varying","float","bV",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DEBUG_WIREFRAME"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","Es",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",
parts:[{type:"textline",tokens:["vec3","Ey","(","in","vec2","Eo",")","{","vec2","Et","=","0.5","+","vec2","(","(","Eo",".","x","-","SHORE_MAP_CENTER_X",")","/","SHORE_MAP_SIZE_X",",","-","(","Eo",".","y","+","SHORE_MAP_CENTER_Y",")","/","SHORE_MAP_SIZE_Y",")",";","vec4","Eu","=","texture2D","(","u_shore_dist_map",",","Et",")",";","const","vec2","Ev","=","vec2","(","1.0","/","255.0",",","1.0",")",";","float","Ew","=","dot","(","Eu",".","ba",",","Ev",")",";","vec2","Ex","=","normalize","(","Eu",".",
"rg","*","2.0","-","1.0",")",";","return","vec3","(","Ex",",","Ew",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC"],group:{type:"group",parts:[{type:"define",name:"M_PI",tokens:["3.14159265359"]},{type:"define",name:"SMALL_WAVES_FAC",tokens:["0.3"]},{type:"textline",tokens:["void","EP","(","inout","vec3","Ez",",","in","float","EA",",","in","vec3","EB",")","{","float","EC","=","au","(","DST_NOISE_SCALE_0","*","(","Ez",".","xz","+","DST_NOISE_FREQ_0","*","EA",")",")","*",
"au","(","DST_NOISE_SCALE_1","*","(","Ez",".","zx","-","DST_NOISE_FREQ_1","*","EA",")",")",";"]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["float","ED","=","WAVES_LENGTH","/","MAX_SHORE_DIST","/","M_PI",";","float","EE","=","EB",".","b",";","float","EF","=","sqrt","(","EE",")",";","float","EG","=","max","(","EE",",","DIR_MIN_SHR_FAC",")","*","sin","(","EF","/","ED","+","DIR_FREQ","*","EA",")",";","float","EH","=","max","(",
"au","(","DIR_NOISE_SCALE","*","(","Ez",".","xz","+","DIR_NOISE_FREQ","*","EA",")",")",",","DIR_MIN_NOISE_FAC",")",";","EG","*=","EH",";","float","EI","=","WAVES_HEIGHT","*","mix","(","EG",",","EC",",","max","(","EF",",","DST_MIN_FAC",")",")",";","vec2","EJ","=","EB",".","rg",";","float","EK","=","WAVES_HOR_FAC","*","EG","*","max","(","MAX_SHORE_DIST","/","35.0","*","(","0.05","-","EE",")",",","0.0",")",";","vec2","EL","=","EK","*","EJ",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",
tokens:["float","EI","=","WAVES_HEIGHT","*","EC",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["GENERATED_MESH"],group:{type:"group",parts:[{type:"textline",tokens:["vec2","EM","=","2.0","*","(","Ez",".","xz","-","0.1","*","EA",")",";","vec2","EN","=","1.3","*","(","Ez",".","zx","+","0.03","*","EA",")",";","float","EO","=","Q","(","0.5","*","EM",")",".","x","+","Q","(","0.5","*","EN",")",".","x","-","1.0",";"]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",
parts:[{type:"textline",tokens:["Ez",".","xz","+=","EL",";","EO","*=","EE",";"]}]}}]},{type:"textline",tokens:["EI","+=","SMALL_WAVES_FAC","*","EO",";"]}]}}]},{type:"textline",tokens:["Ez",".","y","+=","EI",";","}"]}]}}]},{type:"textline",tokens:["void","main","(",")","{"]},{type:"condition",parts:[{type:"if",expression:["DEBUG_WIREFRAME"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","a_polyindex","==","0.0",")","Es","=","vec3","(","1.0",",","0.0",",","0.0",")",";","else","if","(",
"a_polyindex","==","1.0",")","Es","=","vec3","(","0.0",",","1.0",",","0.0",")",";","else","if","(","a_polyindex","==","2.0",")","Es","=","vec3","(","0.0",",","0.0",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["vec3","EQ","=","a_position",";"]},{type:"condition",parts:[{type:"if",expression:["GENERATED_MESH"],group:{type:"group",parts:[{type:"textline",tokens:["float","ER","=","abs","(","EQ",".","y",")",";","vec2","ES","=","u_camera_eye",".","xz","-","mod","(","u_camera_eye",".","xz",",","ER",
")",";","EQ",".","y","=","WATER_LEVEL",";","EQ",".","xz","+=","ES",";"]}]}},{type:"elif",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2},"FOAM",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["b_","=","a_texcoord",";"]}]}}]},{type:"textline",tokens:["bh","ET","=","ut","(","EQ",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","u_model_matrix",")",";"]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],
group:{type:"group",parts:[{type:"textline",tokens:["Er","=","Ey","(","ET",".","a",".","xz",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC"],group:{type:"group",parts:[{type:"textline",tokens:["float","EU","=","length","(","u_wind",")",";","float","EV","=","u_time",";","EV","*=","EU",";"]},{type:"condition",parts:[{type:"if",expression:["GENERATED_MESH"],group:{type:"group",parts:[{type:"textline",tokens:["float","EW","=","ER",";","vec3","EX","=","ET",".","a","+","vec3","(",
"EW",",","0.0",",","0.0",")",";","vec3","EY","=","ET",".","a","+","vec3","(","0.0",",","0.0",",","EW",")",";","if","(","a_position",".","y","<","0.0",")","{","ET",".","a",".","y","=","WATER_LEVEL","-","1.0",";","EX",".","y","=","ET",".","a",".","y",";","EY",".","y","=","ET",".","a",".","y",";","}"]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2},"FOAM",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Eq","=","ET",
".","a",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","EX","=","ET",".","a","+","vec3","(","0.05",",","0.0",",","0.0",")",";","vec3","EY","=","ET",".","a","+","vec3","(","0.0",",","0.0",",","0.05",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","EZ","=","Ey","(","EX",".","xz",")",";","vec3","E_","=","Ey","(","EY",".","xz",")",";","EP","(","EX",",","EV",",","EZ",")",";",
"EP","(","EY",",","EV",",","E_",")",";","EP","(","ET",".","a",",","EV",",","Er",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["EP","(","EX",",","EV",",","vec3","(","0.0",")",")",";","EP","(","EY",",","EV",",","vec3","(","0.0",")",")",";","EP","(","ET",".","a",",","EV",",","vec3","(","0.0",")",")",";"]}]}}]},{type:"textline",tokens:["vec3","Fa","=","normalize","(","EX","-","ET",".","a",")",";","vec3","Fb","=","normalize","(","EY","-","ET",".","a",")",";","bS","=","normalize",
"(","cross","(","Fb",",","Fa",")",")",";","float","Fc","=","dot","(","bS",",","vec3","(","0.0",",","1.0",",","0.0",")",")",";","float","Fd","=","clamp","(","0.8","-","Fc",",","0.0",",","1.0",")",";","bS","=","mix","(","bS",",","vec3","(","0.0",",","1.0",",","0.0",")",",","Fd",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC",{type:"logic_negative_expr",places:1}],
group:{type:"group",parts:[{type:"textline",tokens:["vec3","Fb","=","a_tangent",";","bS","=","a_normal",";"]}]}}]},{type:"textline",tokens:["bT","=","Fb",";","Ep","=","cross","(","bS",",","bT",")",";"]}]}}]},{type:"textline",tokens:["bQ","=","ET",".","a",";","yx","=","u_camera_eye","-","ET",".","a",";","vec4","Fe","=","u_view_matrix","*","vec4","(","ET",".","a",",","1.0",")",";","vec4","Ff","=","u_proj_matrix","*","Fe",";"]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING","REFLECTION_TYPE",
"REFL_PLANE",{type:"equal_expr",places:2},"REFRACTIVE",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["float","Fg","=","Ff",".","x",";","float","Fh","=","Ff",".","y",";","float","Fi","=","Ff",".","w",";","bU",".","x","=","(","Fg","+","Fi",")","/","2.0",";","bU",".","y","=","(","Fh","+","Fi",")","/","2.0",";","bU",".","z","=","Fi",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING","REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},
"REFRACTIVE","DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["bV","=","-","Fe",".","z","/","u_view_max_depth",";"]}]}}]},{type:"textline",tokens:["gl_Position","=","Ff",";","}"]}]},exports["wireframe.glslf"]={type:"group",parts:[{type:"define",name:"WM_NONE",tokens:["0"]},{type:"define",name:"WM_OPAQUE_WIREFRAME",tokens:["1"]},{type:"define",name:"WM_TRANSPARENT_WIREFRAME",tokens:["2"]},{type:"define",name:"WM_FRONT_BACK_VIEW",
tokens:["3"]},{type:"define",name:"WM_DEBUG_SPHERES",tokens:["4"]},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"gamma.glslf"},{type:"condition",parts:[{type:"if",expression:["DEBUG_SPHERE",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","int","u_wireframe_mode",";","uniform","vec3","u_wireframe_edge_color",";"]}]}}]},{type:"textline",tokens:["varying","vec3","Es",";","const","float","Eo","=","1.0",";"]},{type:"condition",
parts:[{type:"if",expression:["DEBUG_SPHERE"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DEBUG_SPHERE_DYNAMIC"],group:{type:"group",parts:[{type:"textline",tokens:["const","vec3","Et","=","vec3","(","1.0",",","0.05",",","0.05",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["const","vec3","Et","=","vec3","(","0.05",",","0.05",",","1.0",")",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["const","vec3","Eu",
"=","vec3","(","0.4",",","0.4",",","1.0",")",";","const","vec3","Ev","=","vec3","(","1.0",",","0.4",",","0.4",")",";","const","vec3","Ew","=","vec3","(","1.0",",","1.0",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["void","main","(",")","{","vec3","Ex","=","vec3","(","0.0",")",";","float","Ey","=","0.0",";"]},{type:"condition",parts:[{type:"if",expression:["DEBUG_SPHERE"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","Ez","=","sign","(","Es","-","vec3","(","0.02","*","Eo",")",")",
";","if","(","Ez",".","x","<","0.0","||","Ez",".","y","<","0.0","||","Ez",".","z","<","0.0",")","{","Ex","=","Et",";","Ey","=","1.0",";","}","else","discard",";"]}]}},{type:"elif",expression:["WIREFRAME_QUALITY",0,{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","Ez","=","sign","(","Es","-","vec3","(","0.02","*","Eo",")",")",";","if","(","u_wireframe_mode","==","WM_OPAQUE_WIREFRAME",")","{","if","(","Ez",".","x","<","0.0","||","Ez",".","y","<","0.0","||","Ez",
".","z","<","0.0",")","Ex","=","u_wireframe_edge_color",";","else","Ex","=","Ew",";","Ey","=","1.0",";","}","else","if","(","u_wireframe_mode","==","WM_TRANSPARENT_WIREFRAME",")","{","if","(","Ez",".","x","<","0.0","||","Ez",".","y","<","0.0","||","Ez",".","z","<","0.0",")","Ey","=","1.0",";","else","Ey","=","0.0",";","Ex","=","u_wireframe_edge_color",";","}","else","if","(","u_wireframe_mode","==","WM_FRONT_BACK_VIEW",")","{","if","(","Ez",".","x","<","0.0","||","Ez",".","y","<","0.0","||","Ez",
".","z","<","0.0",")","Ex","=","u_wireframe_edge_color",";","else","if","(","gl_FrontFacing",")","Ex","=","Eu",";","else","Ex","=","Ev",";","Ey","=","1.0",";","}"]}]}},{type:"elif",expression:["WIREFRAME_QUALITY",1,{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"extension",tokens:["GL_OES_standard_derivatives",":","enable"]},{type:"textline",tokens:["vec3","EA","=","fwidth","(","Es",")",";","vec3","EB","=","smoothstep","(","vec3","(","0.0",")",",","EA","*","Eo",",","Es",")",";","float",
"EC","=","min","(","min","(","EB",".","x",",","EB",".","y",")",",","EB",".","z",")",";","EC","=","clamp","(","EC",",","0.0",",","1.0",")",";","if","(","u_wireframe_mode","==","WM_OPAQUE_WIREFRAME",")","{","Ex","=","vec3","(","mix","(","u_wireframe_edge_color",",","Ew",",","EC",")",")",";","Ey","=","1.0",";","}","else","if","(","u_wireframe_mode","==","WM_TRANSPARENT_WIREFRAME",")","{","Ex","=","u_wireframe_edge_color",";","Ey","=","mix","(","1.0",",","0.0",",","EC",")",";","}","else","if","(","u_wireframe_mode",
"==","WM_FRONT_BACK_VIEW",")","{","if","(","gl_FrontFacing",")","Ex","=","mix","(","u_wireframe_edge_color",",","Eu",",","EC",")",";","else","Ex","=","mix","(","u_wireframe_edge_color",",","Ev",",","EC",")",";","Ey","=","1.0",";","}"]}]}}]},{type:"textline",tokens:["bb","(","Ex",")",";"]},{type:"condition",parts:[{type:"if",expression:["ALPHA"],group:{type:"group",parts:[{type:"textline",tokens:["be","(","Ex",",","Ey",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor","=","vec4","(","Ex",",",
"Ey",")",";","}"]}]},exports["wireframe.glslv"]={type:"group",parts:[{type:"var",name:"AU_QUALIFIER",tokens:["uniform"]},{type:"var",name:"PRECISION",tokens:["lowp"]},{type:"var",name:"MAX_BONES",tokens:["0"]},{type:"include",file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"textline",tokens:["attribute","vec3","a_position",";","attribute","vec3","a_normal",";","attribute","float","a_polyindex",";"]},{type:"condition",parts:[{type:"if",expression:["DEBUG_SPHERE",{type:"logic_negative_expr",
places:1}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MAIN_BEND_COL"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","float","a_bending_col_main",";"]},{type:"condition",parts:[{type:"if",expression:["DETAIL_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_bending_col_detail",";","AU_QUALIFIER","float","au_detail_bending_amp",";",
"AU_QUALIFIER","float","au_branch_bending_amp",";","AU_QUALIFIER","float","au_detail_bending_freq",";"]}]}}]}]}}]},{type:"textline",tokens:["AU_QUALIFIER","float","au_wind_bending_amp",";","AU_QUALIFIER","float","au_wind_bending_freq",";"]},{type:"condition",parts:[{type:"if",expression:["BEND_CENTER_ONLY"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_emitter_center",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","DYNAMIC_GRASS","BILLBOARD",
{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["AU_QUALIFIER","vec3","au_center_pos",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_position_next",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_influence",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["STATIC_BATCH"],
group:{type:"group",parts:[{type:"textline",tokens:["const","mat4","u_model_matrix","=","mat4","(","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_model_matrix",";"]}]}}]},{type:"textline",tokens:["uniform","mat4","u_proj_matrix",";","uniform","mat4","u_view_matrix",";"]},{type:"condition",parts:[{type:"if",expression:["DEBUG_SPHERE",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],
group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_wind",";","uniform","PRECISION","float","u_time",";"]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD","BILLBOARD_JITTERED",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_jitter_amp",";","uniform","float","u_jitter_freq",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS","BILLBOARD",{type:"logical_or_expr",places:2}],group:{type:"group",
parts:[{type:"textline",tokens:["uniform","vec3","u_camera_eye",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_va_frame_factor",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsb","[","MAX_BONES","]",";","uniform","vec4","u_transb","[","MAX_BONES","]",";","uniform","vec4","u_arm_rel_trans",";","uniform",
"vec4","u_arm_rel_quat",";"]},{type:"condition",parts:[{type:"if",expression:["FRAMES_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsa","[","MAX_BONES","]",";","uniform","vec4","u_transa","[","MAX_BONES","]",";","uniform","float","u_frame_factor",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_grass_map_depth",";","uniform","sampler2D",
"u_grass_map_color",";","uniform","vec4","u_camera_quat",";","uniform","vec3","u_grass_map_dim",";","uniform","float","u_grass_size",";","uniform","float","u_scale_threshold",";"]}]}}]}]}}]},{type:"textline",tokens:["varying","vec3","Es",";"]},{type:"condition",parts:[{type:"if",expression:["DEBUG_SPHERE",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"include",file:"skin.glslv"},{type:"include",file:"wind_bending.glslv"},{type:"include",file:"dynamic_grass.glslv"}]}}]},{type:"textline",
tokens:["void","main","(",")","{","if","(","a_polyindex","==","0.0",")","Es","=","vec3","(","1.0",",","0.0",",","0.0",")",";","else","if","(","a_polyindex","==","1.0",")","Es","=","vec3","(","0.0",",","1.0",",","0.0",")",";","else","if","(","a_polyindex","==","2.0",")","Es","=","vec3","(","0.0",",","0.0",",","1.0",")",";","vec3","Eo","=","a_position",";","vec3","Et","=","a_normal",";"]},{type:"condition",parts:[{type:"if",expression:["DEBUG_SPHERE"],group:{type:"group",parts:[{type:"textline",tokens:["bh",
"Eu","=","ut","(","Eo",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","u_model_matrix",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["Eo","=","mix","(","Eo",",","a_position_next",",","u_va_frame_factor",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["vec3",
"Ev","=","vec3","(","0.0",")",";","vec3","Ew","=","vec3","(","0.0",")",";","vD","(","Eo",",","Ev",",","Ew",",","Et",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","DYNAMIC_GRASS","BILLBOARD",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","Ex","=","au_center_pos",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","Ex","=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS"],
group:{type:"group",parts:[{type:"textline",tokens:["bh","Eu","=","xp","(","Eo",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","Ex",",","u_grass_map_depth",",","u_grass_map_color",",","u_grass_map_dim",",","u_grass_size",",","u_camera_eye",",","u_camera_quat",",","u_view_matrix",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","Ey","=","(","u_model_matrix",
"*","vec4","(","Ex",",","1.0",")",")",".","xyz",";"]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD_PRES_GLOB_ORIENTATION","STATIC_BATCH",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["mat4","Ez","=","um","(","u_camera_eye",",","Ey",",","u_view_matrix",",","u_model_matrix",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["mat4","Ez","=","ug","(","u_camera_eye",",","Ey",",","u_view_matrix",
")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","BILLBOARD_JITTERED",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","EA","=","(","u_model_matrix","*","vec4","(","Ex",",","1.0",")",")",".","xyz",";","Ez","=","Ez","*","tW","(","u_wind",",","u_time",",","u_jitter_amp",",","u_jitter_freq",",","EA",")",";"]}]}}]},{type:"textline",tokens:["bh","Eu","=","ut","(","Eo","-","Ex",",","Ex",",","vec3","(","0.0",")",",","vec3","(","0.0",
")",",","vec3","(","0.0",")",",","Ez",")",";","Eu",".","b","=","Ey",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["bh","Eu","=","ut","(","Eo",",","Ex",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","u_model_matrix",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["wv","(","Eu",".","a",",","Eu",".","b",",","Et",")",";"]}]}}]}]}}]},{type:"textline",tokens:["vec4",
"EB","=","u_view_matrix","*","vec4","(","Eu",".","a",",","1.0",")",";","gl_Position","=","u_proj_matrix","*","EB",";","}"]}]},exports["postprocessing/anaglyph.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_sampler_left",";","uniform","sampler2D","u_sampler_right",";","varying","vec2","b_",";","void","main","(",")","{","vec4","Eo","=","texture2D","(","u_sampler_left",",","b_",")",";","vec4","Et","=","texture2D","(","u_sampler_right",
",","b_",")",";","gl_FragColor","=","vec4","(","Eo","[","0","]",",","Et","[","1","]",",","Et","[","2","]",",","Eo","[","3","]","+","Et","[","3","]",")",";","}"]}]},exports["postprocessing/antialiasing.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"define",name:"AA_METHOD_PASS",tokens:["1"]},{type:"define",name:"AA_METHOD_FXAA_LIGHT",tokens:["2"]},{type:"define",name:"AA_METHOD_FXAA_QUALITY",tokens:["3"]},{type:"define",name:"FXAA_REDUCE_MIN",tokens:["(","1.0",
"/","128.0",")"]},{type:"define",name:"FXAA_REDUCE_MUL",tokens:["(","1.0","/","8.0",")"]},{type:"define",name:"FXAA_SPAN_MAX",tokens:["8.0"]},{type:"textline",tokens:["uniform","sampler2D","u_color",";","uniform","vec2","u_texel_size",";","varying","vec2","b_",";","vec4","Ev","(","float","Eo",",","float","Et",")","{","vec2","Eu","=","b_","+","vec2","(","Eo",",","Et",")","*","u_texel_size",";","return","texture2D","(","u_color",",","Eu",")",";","}","float","Ez","(","vec4","Ew",")","{","vec3","Ex",
"=","vec3","(","0.299",",","0.587",",","0.114",")",";","float","Ey","=","dot","(","Ew",".","rgb",",","Ex",")",";","return","Ey",";","}","vec4","ES","(",")","{","vec4","EA","=","Ev","(","-","1.0",",","-","1.0",")",";","vec4","EB","=","Ev","(","1.0",",","-","1.0",")",";","vec4","EC","=","Ev","(","-","1.0",",","1.0",")",";","vec4","ED","=","Ev","(","1.0",",","1.0",")",";","vec4","EE","=","Ev","(","0.0",",","0.0",")",";","float","EF","=","Ez","(","EA",")",";","float","EG","=","Ez","(","EB",")",";","float",
"EH","=","Ez","(","EC",")",";","float","EI","=","Ez","(","ED",")",";","float","EJ","=","Ez","(","EE",")",";","float","EK","=","min","(","EJ",",","min","(","min","(","EF",",","EG",")",",","min","(","EH",",","EI",")",")",")",";","float","EL","=","max","(","EJ",",","max","(","max","(","EF",",","EG",")",",","max","(","EH",",","EI",")",")",")",";","vec2","EM",";","EM",".","x","=","-","(","(","EF","+","EG",")","-","(","EH","+","EI",")",")",";","EM",".","y","=","(","(","EF","+","EH",")","-","(","EG","+",
"EI",")",")",";","float","EN","=","max","(","(","EF","+","EG","+","EH","+","EI",")","*","(","0.25","*","FXAA_REDUCE_MUL",")",",","FXAA_REDUCE_MIN",")",";","float","EO","=","1.0","/","(","min","(","abs","(","EM",".","x",")",",","abs","(","EM",".","y",")",")","+","EN",")",";","EM","=","min","(","vec2","(","FXAA_SPAN_MAX",",","FXAA_SPAN_MAX",")",",","max","(","vec2","(","-","FXAA_SPAN_MAX",",","-","FXAA_SPAN_MAX",")",",","EM","*","EO",")",")","*","u_texel_size",";","vec4","EP","=","0.5","*","(","texture2D",
"(","u_color",",","b_","+","EM","*","(","1.0","/","3.0","-","0.5",")",")","+","texture2D","(","u_color",",","b_","+","EM","*","(","2.0","/","3.0","-","0.5",")",")",")",";","vec4","EQ","=","EP","*","0.5","+","0.25","*","(","texture2D","(","u_color",",","b_","+","EM","*","-","0.5",")","+","texture2D","(","u_color",",","b_","+","EM","*","0.5",")",")",";","float","ER","=","Ez","(","EQ",")",";","if","(","(","ER","<","EK",")","||","(","ER",">","EL",")",")","return","EP",";","else","return","EQ",";","}"]},
{type:"define",name:"FXAA_QUALITY_EDGE_THRESHOLD",tokens:["(","1.0","/","6.0",")"]},{type:"define",name:"FXAA_QUALITY_EDGE_THRESHOLD_MIN",tokens:["(","1.0","/","12.0",")"]},{type:"define",name:"FXAA_QUALITY_SUBPIX",tokens:["(","3.0","/","4.0",")"]},{type:"textline",tokens:["vec4","GD","(",")","{","vec2","ET",";","ET",".","x","=","b_",".","x",";","ET",".","y","=","b_",".","y",";","vec4","EU","=","texture2D","(","u_color",",","ET",")",";","vec4","EV","=","Ev","(","0.0",",","1.0",")",";","vec4","EW",
"=","Ev","(","1.0",",","0.0",")",";","vec4","EX","=","Ev","(","0.0",",","-","1.0",")",";","vec4","EY","=","Ev","(","-","1.0",",","0.0",")",";","float","EZ","=","Ez","(","EV",")",";","float","E_","=","Ez","(","EW",")",";","float","Fa","=","Ez","(","EX",")",";","float","Fb","=","Ez","(","EY",")",";","float","Fc","=","Ez","(","EU",")",";","float","Fd","=","max","(","EZ",",","Fc",")",";","float","Fe","=","min","(","EZ",",","Fc",")",";","float","Ff","=","max","(","E_",",","Fd",")",";","float","Fg","=",
"min","(","E_",",","Fe",")",";","float","Fh","=","max","(","Fa",",","Fb",")",";","float","Fi","=","min","(","Fa",",","Fb",")",";","float","Fj","=","max","(","Fh",",","Ff",")",";","float","Fk","=","min","(","Fi",",","Fg",")",";","float","Fl","=","Fj","*","FXAA_QUALITY_EDGE_THRESHOLD",";","float","Fm","=","Fj","-","Fk",";","float","Fn","=","max","(","FXAA_QUALITY_EDGE_THRESHOLD_MIN",",","Fl",")",";","bool","Fo","=","Fm","<","Fn",";","if","(","Fo",")","return","EU",";","vec4","Fp","=","Ev","(","-","1.0",
",","-","1.0",")",";","vec4","Fq","=","Ev","(","1.0",",","1.0",")",";","vec4","Fr","=","Ev","(","1.0",",","-","1.0",")",";","vec4","Fs","=","Ev","(","-","1.0",",","1.0",")",";","float","Ft","=","Ez","(","Fp",")",";","float","Fu","=","Ez","(","Fq",")",";","float","Fv","=","Ez","(","Fr",")",";","float","Fw","=","Ez","(","Fs",")",";","float","Fx","=","Fa","+","EZ",";","float","Fy","=","Fb","+","E_",";","float","Fz","=","1.0","/","Fm",";","float","FA","=","Fx","+","Fy",";","float","FB","=","(","-","2.0",
"*","Fc",")","+","Fx",";","float","FC","=","(","-","2.0","*","Fc",")","+","Fy",";","float","FD","=","Fv","+","Fu",";","float","FE","=","Ft","+","Fv",";","float","FF","=","(","-","2.0","*","E_",")","+","FD",";","float","FG","=","(","-","2.0","*","Fa",")","+","FE",";","float","FH","=","Ft","+","Fw",";","float","FI","=","Fw","+","Fu",";","float","FJ","=","(","abs","(","FB",")","*","2.0",")","+","abs","(","FF",")",";","float","FK","=","(","abs","(","FC",")","*","2.0",")","+","abs","(","FG",")",";","float",
"FL","=","(","-","2.0","*","Fb",")","+","FH",";","float","FM","=","(","-","2.0","*","EZ",")","+","FI",";","float","FN","=","abs","(","FL",")","+","FJ",";","float","FO","=","abs","(","FM",")","+","FK",";","float","FP","=","FH","+","FD",";","float","FQ","=","u_texel_size",".","x",";","bool","FR","=","FN",">=","FO",";","float","FS","=","FA","*","2.0","+","FP",";","if","(","!","FR",")","Fa","=","Fb",";","if","(","!","FR",")","EZ","=","E_",";","if","(","FR",")","FQ","=","u_texel_size",".","y",";","float",
"FT","=","(","FS","*","(","1.0","/","12.0",")",")","-","Fc",";","float","FU","=","Fa","-","Fc",";","float","FV","=","EZ","-","Fc",";","float","FW","=","Fa","+","Fc",";","float","FX","=","EZ","+","Fc",";","bool","FY","=","abs","(","FU",")",">=","abs","(","FV",")",";","float","FZ","=","max","(","abs","(","FU",")",",","abs","(","FV",")",")",";","if","(","FY",")","FQ","=","-","FQ",";","float","F_","=","clamp","(","abs","(","FT",")","*","Fz",",","0.0",",","1.0",")",";","vec2","Ga",";","Ga",".","x","=",
"ET",".","x",";","Ga",".","y","=","ET",".","y",";","vec2","Gb",";","Gb",".","x","=","(","!","FR",")","?","0.0",":","u_texel_size",".","x",";","Gb",".","y","=","(","FR",")","?","0.0",":","u_texel_size",".","y",";","if","(","!","FR",")","Ga",".","x","+=","FQ","*","0.5",";","if","(","FR",")","Ga",".","y","+=","FQ","*","0.5",";","vec2","Gc",";","Gc",".","x","=","Ga",".","x","-","Gb",".","x",";","Gc",".","y","=","Ga",".","y","-","Gb",".","y",";","vec2","Gd",";","Gd",".","x","=","Ga",".","x","+","Gb",".",
"x",";","Gd",".","y","=","Ga",".","y","+","Gb",".","y",";","float","Ge","=","(","(","-","2.0",")","*","F_",")","+","3.0",";","float","Gf","=","Ez","(","texture2D","(","u_color",",","Gc",")",")",";","float","Gg","=","F_","*","F_",";","float","Gh","=","Ez","(","texture2D","(","u_color",",","Gd",")",")",";","if","(","!","FY",")","FW","=","FX",";","float","Gi","=","FZ","*","1.0","/","4.0",";","float","Gj","=","Fc","-","FW","*","0.5",";","float","Gk","=","Ge","*","Gg",";","bool","Gl","=","Gj","<","0.0",
";","Gf","-=","FW","*","0.5",";","Gh","-=","FW","*","0.5",";","bool","Gm","=","abs","(","Gf",")",">=","Gi",";","bool","Gn","=","abs","(","Gh",")",">=","Gi",";","if","(","!","Gm",")","Gc",".","x","-=","Gb",".","x","*","1.5",";","if","(","!","Gm",")","Gc",".","y","-=","Gb",".","y","*","1.5",";","bool","Go","=","(","!","Gm",")","||","(","!","Gn",")",";","if","(","!","Gn",")","Gd",".","x","+=","Gb",".","x","*","1.5",";","if","(","!","Gn",")","Gd",".","y","+=","Gb",".","y","*","1.5",";","if","(","Go",
")","{","if","(","!","Gm",")","Gf","=","Ez","(","texture2D","(","u_color",",","Gc",".","xy",")",")",";","if","(","!","Gn",")","Gh","=","Ez","(","texture2D","(","u_color",",","Gd",".","xy",")",")",";","if","(","!","Gm",")","Gf","=","Gf","-","FW","*","0.5",";","if","(","!","Gn",")","Gh","=","Gh","-","FW","*","0.5",";","Gm","=","abs","(","Gf",")",">=","Gi",";","Gn","=","abs","(","Gh",")",">=","Gi",";","if","(","!","Gm",")","Gc",".","x","-=","Gb",".","x","*","2.0",";","if","(","!","Gm",")","Gc",".","y",
"-=","Gb",".","y","*","2.0",";","Go","=","(","!","Gm",")","||","(","!","Gn",")",";","if","(","!","Gn",")","Gd",".","x","+=","Gb",".","x","*","2.0",";","if","(","!","Gn",")","Gd",".","y","+=","Gb",".","y","*","2.0",";","if","(","Go",")","{","if","(","!","Gm",")","Gf","=","Ez","(","texture2D","(","u_color",",","Gc",".","xy",")",")",";","if","(","!","Gn",")","Gh","=","Ez","(","texture2D","(","u_color",",","Gd",".","xy",")",")",";","if","(","!","Gm",")","Gf","=","Gf","-","FW","*","0.5",";","if","(","!",
"Gn",")","Gh","=","Gh","-","FW","*","0.5",";","Gm","=","abs","(","Gf",")",">=","Gi",";","Gn","=","abs","(","Gh",")",">=","Gi",";","if","(","!","Gm",")","Gc",".","x","-=","Gb",".","x","*","2.0",";","if","(","!","Gm",")","Gc",".","y","-=","Gb",".","y","*","2.0",";","Go","=","(","!","Gm",")","||","(","!","Gn",")",";","if","(","!","Gn",")","Gd",".","x","+=","Gb",".","x","*","2.0",";","if","(","!","Gn",")","Gd",".","y","+=","Gb",".","y","*","2.0",";","if","(","Go",")","{","if","(","!","Gm",")","Gf","=",
"Ez","(","texture2D","(","u_color",",","Gc",".","xy",")",")",";","if","(","!","Gn",")","Gh","=","Ez","(","texture2D","(","u_color",",","Gd",".","xy",")",")",";","if","(","!","Gm",")","Gf","=","Gf","-","FW","*","0.5",";","if","(","!","Gn",")","Gh","=","Gh","-","FW","*","0.5",";","Gm","=","abs","(","Gf",")",">=","Gi",";","Gn","=","abs","(","Gh",")",">=","Gi",";","if","(","!","Gm",")","Gc",".","x","-=","Gb",".","x","*","4.0",";","if","(","!","Gm",")","Gc",".","y","-=","Gb",".","y","*","4.0",";","Go",
"=","(","!","Gm",")","||","(","!","Gn",")",";","if","(","!","Gn",")","Gd",".","x","+=","Gb",".","x","*","4.0",";","if","(","!","Gn",")","Gd",".","y","+=","Gb",".","y","*","4.0",";","if","(","Go",")","{","if","(","!","Gm",")","Gf","=","Ez","(","texture2D","(","u_color",",","Gc",".","xy",")",")",";","if","(","!","Gn",")","Gh","=","Ez","(","texture2D","(","u_color",",","Gd",".","xy",")",")",";","if","(","!","Gm",")","Gf","=","Gf","-","FW","*","0.5",";","if","(","!","Gn",")","Gh","=","Gh","-","FW","*",
"0.5",";","Gm","=","abs","(","Gf",")",">=","Gi",";","Gn","=","abs","(","Gh",")",">=","Gi",";","if","(","!","Gm",")","Gc",".","x","-=","Gb",".","x","*","2.0",";","if","(","!","Gm",")","Gc",".","y","-=","Gb",".","y","*","2.0",";","if","(","!","Gn",")","Gd",".","x","+=","Gb",".","x","*","2.0",";","if","(","!","Gn",")","Gd",".","y","+=","Gb",".","y","*","2.0",";","}","}","}","}","float","Gp","=","ET",".","x","-","Gc",".","x",";","float","Gq","=","Gd",".","x","-","ET",".","x",";","if","(","!","FR",")",
"Gp","=","ET",".","y","-","Gc",".","y",";","if","(","!","FR",")","Gq","=","Gd",".","y","-","ET",".","y",";","bool","Gr","=","(","Gf","<","0.0",")","!=","Gl",";","float","Gs","=","(","Gq","+","Gp",")",";","bool","Gt","=","(","Gh","<","0.0",")","!=","Gl",";","float","Gu","=","1.0","/","Gs",";","bool","Gv","=","Gp","<","Gq",";","float","Gw","=","min","(","Gp",",","Gq",")",";","bool","Gx","=","Gv","?","Gr",":","Gt",";","float","Gy","=","Gk","*","Gk",";","float","Gz","=","(","Gw","*","(","-","Gu",")",
")","+","0.5",";","float","GA","=","Gy","*","FXAA_QUALITY_SUBPIX",";","float","GB","=","Gx","?","Gz",":","0.0",";","float","GC","=","max","(","GB",",","GA",")",";","if","(","!","FR",")","ET",".","x","+=","GC","*","FQ",";","if","(","FR",")","ET",".","y","+=","GC","*","FQ",";","return","texture2D","(","u_color",",","ET",")",";","}"]},{type:"define",name:"FXAA_CONSOLE_EDGE_SHARPNESS",tokens:["8.0"]},{type:"define",name:"FXAA_CONSOLE_EDGE_THRESHOLD",tokens:["0.125"]},{type:"define",name:"FXAA_CONSOLE_EDGE_THRESHOLD_MIN",
tokens:["0.05"]},{type:"textline",tokens:["void","main","(",")","{"]},{type:"condition",parts:[{type:"if",expression:["AA_METHOD","AA_METHOD_PASS",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","texture2D","(","u_color",",","b_",")",";"]}]}},{type:"elif",expression:["AA_METHOD","AA_METHOD_FXAA_LIGHT",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","ES","(",")",";"]}]}},{type:"elif",expression:["AA_METHOD",
"AA_METHOD_FXAA_QUALITY",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","GD","(",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","vec4","(","1.0",",","1.0",",","0.0",",","1.0",")","*","texture2D","(","u_color",",","b_",")",";"]}]}}]},{type:"textline",tokens:["}"]}]},exports["postprocessing/bloom_blur.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"textline",
tokens:["uniform","vec2","u_texel_size",";","uniform","sampler2D","u_color",";","varying","vec2","b_",";","void","main","(",")","{","vec2","Eo","=","vec2","(","0.0",",","0.0",")",";","vec2","Et","=","u_texel_size",";","vec4","Eu","=","texture2D","(","u_color",",","b_",")",";","gl_FragColor","=","Eu","*","0.0875447373698",";","Eo","+=","Et",";","gl_FragColor","+=","texture2D","(","u_color",",","b_","+","Eo",")","*","0.0858112354248",";","gl_FragColor","+=","texture2D","(","u_color",",","b_","-","Eo",
")","*","0.0858112354248",";","Eo","+=","Et",";","gl_FragColor","+=","texture2D","(","u_color",",","b_","+","Eo",")","*","0.0808139781061",";","gl_FragColor","+=","texture2D","(","u_color",",","b_","-","Eo",")","*","0.0808139781061",";","Eo","+=","Et",";","gl_FragColor","+=","texture2D","(","u_color",",","b_","+","Eo",")","*","0.0731235112908",";","gl_FragColor","+=","texture2D","(","u_color",",","b_","-","Eo",")","*","0.0731235112908",";","Eo","+=","Et",";","gl_FragColor","+=","texture2D","(","u_color",
",","b_","+","Eo",")","*","0.0635705267419",";","gl_FragColor","+=","texture2D","(","u_color",",","b_","-","Eo",")","*","0.0635705267419",";","Eo","+=","Et",";","gl_FragColor","+=","texture2D","(","u_color",",","b_","+","Eo",")","*","0.0530985673112",";","gl_FragColor","+=","texture2D","(","u_color",",","b_","-","Eo",")","*","0.0530985673112",";","Eo","+=","Et",";","gl_FragColor","+=","texture2D","(","u_color",",","b_","+","Eo",")","*","0.0426125984122",";","gl_FragColor","+=","texture2D","(","u_color",
",","b_","-","Eo",")","*","0.0426125984122",";","Eo","+=","Et",";","gl_FragColor","+=","texture2D","(","u_color",",","b_","+","Eo",")","*","0.0328565115809",";","gl_FragColor","+=","texture2D","(","u_color",",","b_","-","Eo",")","*","0.0328565115809",";","Eo","+=","Et",";","gl_FragColor","+=","texture2D","(","u_color",",","b_","+","Eo",")","*","0.0243407024472",";","gl_FragColor","+=","texture2D","(","u_color",",","b_","-","Eo",")","*","0.0243407024472",";","gl_FragColor","=","max","(","0.7","*",
"Eu",",","gl_FragColor",")",";","}"]}]},exports["postprocessing/bloom_combine.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_main",";","uniform","sampler2D","u_bloom",";","varying","vec2","b_",";","void","main","(",")","{","vec4","Eo","=","texture2D","(","u_main",",","b_",")",";","vec4","Et","=","texture2D","(","u_bloom",",","b_",")",";","vec4","Eu","=","Eo",";","Eu","+=","Et",";","gl_FragColor","=","vec4","(","Eu",
".","rgb",",","1.0",")",";","}"]}]},exports["postprocessing/compositing.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"define",name:"PI_4",tokens:["0.785398163"]},{type:"textline",tokens:["uniform","sampler2D","u_color",";","uniform","float","u_brightness",";","uniform","float","u_contrast",";","uniform","float","u_exposure",";","uniform","float","u_saturation",";","varying","vec2","b_",";","void","main","(",")","{","vec4","Eo","=","texture2D","(","u_color",
",","b_",")",";","vec3","Et","=","Eo",".","rgb",";","if","(","u_brightness","<","0.0",")","Et","=","Et","*","(","1.0","+","u_brightness",")",";","else","Et","=","Et","+","(","(","1.0","-","Et",")","*","u_brightness",")",";","Et","=","(","Et","-","0.5",")","*","(","tan","(","(","u_contrast","+","1.0",")","*","PI_4",")",")","+","0.5",";","Et","*=","u_exposure",";","vec3","Eu","=","vec3","(","0.299",",","0.587",",","0.114",")",";","float","Ev","=","dot","(","Et",",","Eu",")",";","Et","=","mix","(","vec3",
"(","Ev",")",",","Et",",","u_saturation",")",";","gl_FragColor","=","vec4","(","Et",",","Eo",".","a",")",";","}"]}]},exports["postprocessing/depth_pack.glslf"]={type:"group",parts:[{type:"var",name:"PRECISION",tokens:["lowp"]},{type:"textline",tokens:["precision","PRECISION","sampler2D",";"]},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"pack.glslf"},{type:"include",file:"depth_fetch.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_depth",";","uniform","vec2","u_camera_range",
";","varying","vec2","b_",";","void","main","(",")","{","gl_FragColor","=","h","(","clamp","(","EA","(","u_depth",",","b_",",","u_camera_range",")",",","0.0",",","0.999999",")",")",";","}"]}]},exports["postprocessing/dof.glslf"]={type:"group",parts:[{type:"var",name:"PRECISION",tokens:["lowp"]},{type:"textline",tokens:["precision","PRECISION","sampler2D",";"]},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"depth_fetch.glslf"},{type:"textline",tokens:["uniform","sampler2D",
"u_sharp",";","uniform","sampler2D","u_blurred",";","uniform","sampler2D","u_depth",";","uniform","float","u_view_max_depth",";","uniform","float","u_dof_dist",";","uniform","float","u_dof_front",";","uniform","float","u_dof_rear",";","uniform","vec2","u_camera_range",";","varying","vec2","b_",";","void","main","(",")","{","vec4","Eo","=","texture2D","(","u_sharp",",","b_",")",";","if","(","u_dof_dist",">","0.0",")","{","float","EB","=","EA","(","u_depth",",","b_",",","u_camera_range",")",";","EB",
"*=","u_view_max_depth",";","float","EC",";","if","(","EB","<","u_dof_dist",")","EC","=","(","u_dof_dist","-","EB",")","/","u_dof_front",";","else","EC","=","(","EB","-","u_dof_dist",")","/","u_dof_rear",";","EC","=","clamp","(","EC",",","0.0",",","1.0",")",";","vec4","ED","=","texture2D","(","u_blurred",",","b_",")",";","gl_FragColor","=","mix","(","Eo",",","ED",",","EC",")",";","}","else","gl_FragColor","=","Eo",";","}"]}]},exports["postprocessing/glow.glslf"]={type:"group",parts:[{type:"include",
file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_src_color",";","uniform","sampler2D","u_glow_mask_small",";","uniform","sampler2D","u_glow_mask_large",";","uniform","float","u_glow_mask_small_coeff",";","uniform","float","u_glow_mask_large_coeff",";","varying","vec2","b_",";","void","main","(",")","{","vec4","Eo","=","texture2D","(","u_src_color",",","b_",")",";","vec4","EB","=","texture2D","(","u_glow_mask_small",",","b_",")",";","vec4","EC","=","texture2D","(",
"u_glow_mask_large",",","b_",")",";","gl_FragColor","=","Eo",";","if","(","EC",".","a","!=","0.0",")","{","float","ED","=","u_glow_mask_large_coeff","*","EC",".","a",";","ED","=","clamp","(","ED",",","0.0",",","1.0",")",";","gl_FragColor",".","rgb","=","mix","(","gl_FragColor",".","rgb",",","EC",".","rgb","/","EC",".","a",",","ED",")",";","gl_FragColor",".","a","=","mix","(","gl_FragColor",".","a",",","1.0",",","ED",")",";","}","if","(","EB",".","a","!=","0.0",")","{","float","EE","=","u_glow_mask_small_coeff",
"*","EB",".","a",";","EE","=","clamp","(","EE",",","0.0",",","1.0",")",";","gl_FragColor",".","rgb","=","mix","(","gl_FragColor",".","rgb",",","EB",".","rgb","/","EB",".","a",",","EE",")",";","gl_FragColor",".","a","=","mix","(","gl_FragColor",".","a",",","1.0",",","EE",")",";","}","}"]}]},exports["postprocessing/god_rays.glslf"]={type:"group",parts:[{type:"var",name:"PRECISION",tokens:["lowp"]},{type:"textline",tokens:["precision","PRECISION","sampler2D",";"]},{type:"include",file:"precision_statement.glslf"},
{type:"include",file:"depth_fetch.glslf"},{type:"include",file:"procedural.glslf"},{type:"include",file:"pack.glslf"},{type:"var",name:"STEPS_PER_PASS",tokens:["0.0"]},{type:"textline",tokens:["uniform","float","u_time",";","uniform","float","u_radial_blur_step",";","uniform","sampler2D","u_input",";"]},{type:"condition",parts:[{type:"if",expression:["DEPTH_RGBA"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec2","u_camera_range",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],
group:{type:"group",parts:[{type:"textline",tokens:["varying","float","EB",";","varying","vec2","EC",";"]}]}}]}]}}]},{type:"textline",tokens:["varying","vec2","b_",";","varying","vec4","ED",";","void","main","(",")","{","vec2","EE","=","(","ED",".","xy","-","b_",")",";","float","EF","=","length","(","EE",")",";","vec2","EG","=","u_radial_blur_step","*","EE","/","EF",";","float","EH","=","EF","/","u_radial_blur_step",";","EG","*=","min","(","EH",",","STEPS_PER_PASS",")","/","STEPS_PER_PASS",";","EH",
"=","max","(","EH",",","STEPS_PER_PASS",")",";","vec2","EI","=","b_",";","float","EJ","=","0.0",";","for","(","float","EK","=","0.0",";","EK","<","STEPS_PER_PASS",";","EK","+=","1.0",")","{","if","(","EK","<=","EH",")","{"]},{type:"condition",parts:[{type:"if",expression:["DEPTH_RGBA"],group:{type:"group",parts:[{type:"textline",tokens:["float","EL","=","EA","(","u_input",",","EI",",","u_camera_range",")",";","EJ","+=","max","(","(","1.0","-","pow","(","EF",",","0.3",")",")","*","step","(","0.9",
",","EL",")",",","0.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec4","EM","=","texture2D","(","u_input",",","EI",")",";","EJ","+=","l","(","EM",")",";"]}]}}]},{type:"textline",tokens:["}","EI","+=","EG",";","}"]},{type:"condition",parts:[{type:"if",expression:["DEPTH_RGBA","WATER_EFFECTS",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec2","EN","=","b_","+","EC",";","float","EO","=","Q","(","vec2","(","2.5","*","(",
"EN",".","x",")",",","2.5","*","(","EN",".","y",")","+","1.0","*","u_time",")",")",".","x","+","0.75","*","Q","(","vec2","(","5.0","*","(","EN",".","x",")","-","0.66","*","u_time",",","5.0","*","(","EN",".","y",")","+","0.66","*","u_time",")",")",".","x","+","0.5","*","au","(","vec2","(","7.5","*","(","EN",".","x",")","+","0.33","*","u_time",",","7.5","*","(","EN",".","y",")","-","0.33","*","u_time",")",")",";","EO","*=","clamp","(","1.2","-","sqrt","(","0.2","*","EF",")",",","0.0",",","1.0",")",
"*","EB",";","EJ","=","max","(","EO",",","EJ",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor","=","h","(","EJ","/","STEPS_PER_PASS",")",";","}"]}]},exports["postprocessing/god_rays.glslv"]={type:"group",parts:[{type:"include",file:"math.glslv"},{type:"textline",tokens:["attribute","vec2","a_bb_vertex",";","uniform","mat4","u_view_matrix",";","uniform","mat4","u_proj_matrix",";","uniform","vec3","u_sun_direction",";"]},{type:"condition",parts:[{type:"if",expression:["DEPTH_RGBA"],group:{type:"group",
parts:[{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_camera_quat",";","uniform","float","u_cam_water_depth",";","varying","float","EB",";","varying","vec2","EC",";"]}]}}]}]}}]},{type:"textline",tokens:["varying","vec2","b_",";","varying","vec4","ED",";","void","main","(",")","{","b_","=","a_bb_vertex","+","0.5",";","vec3","Eo","=","normalize","(","u_sun_direction",")",";","ED","=","u_proj_matrix","*","u_view_matrix",
"*","vec4","(","Eo",",","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["DEPTH_RGBA","WATER_EFFECTS",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["if","(","u_cam_water_depth","<","0.0",")","{","EB","=","1.0",";","vec3","EE","=","vec3","(","0.0",",","1.0",",","0.0",")",";","vec3","EF","=","bn","(","u_camera_quat",",","EE",")",";","EF","=","normalize","(","EF",")",";","float","EG","=","dot","(","EF",",","vec3","(","0.0",",","1.0",",","0.0",
")",")",";","float","EH","=","atan","(","EF",".","x",",","EF",".","z",")",";","EC","=","vec2","(","-","EH",",","acos","(","EG",")",")",";","}","else","{","EB","=","0.0",";","}"]}]}}]},{type:"textline",tokens:["ED",".","xy","=","0.5","*","(","ED",".","xy","/","ED",".","w","+","1.0",")",";","ED","+=","99999.0","*","step","(","ED",".","z",",","0.0",")",";","gl_Position","=","vec4","(","2.0","*","a_bb_vertex",".","xy",",","0.0",",","1.0",")",";","}"]}]},exports["postprocessing/god_rays_combine.glslf"]=
{type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"include",file:"gamma.glslf"},{type:"include",file:"pack.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_main",";","uniform","sampler2D","u_god_rays",";","uniform","float","u_god_rays_intensity",";","uniform","vec3","u_sun_intensity",";","varying","vec2","b_",";","void","main","(",")","{","vec4","Eo","=","texture2D","(","u_main",",","b_",")",";","vec3","EE","=","clamp","(","u_sun_intensity",",","0.4",",","0.8",
")",";","a_","(","Eo",".","rgb",")",";","float","EF","=","l","(","texture2D","(","u_god_rays",",","b_",")",")",";","vec3","EG","=","Eo",".","rgb","+","u_god_rays_intensity","*","vec3","(","EF",")","*","EE",";","bb","(","EG",")",";","gl_FragColor",".","rgb","=","EG",";","gl_FragColor",".","a","=","Eo",".","a",";","}"]}]},exports["postprocessing/luminance.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_input",";","varying",
"vec2","b_",";","void","main","(",")","{","vec4","Eo","=","texture2D","(","u_input",",","b_",")",";","float","EE","=","dot","(","Eo",".","rgb",",","vec3","(","0.2126",",","0.7152",",","0.0722",")",")",";","gl_FragColor","=","vec4","(","vec3","(","EE",")",",","1.0",")",";","}"]}]},exports["postprocessing/luminance_av.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_input",";","void","main","(",")","{","float","Eo",";",
"float","EE","=","0.0",";","for","(","float","EF","=","0.025",";","EF","<","1.0",";","EF","+=","0.05",")","for","(","float","EG","=","0.025",";","EG","<","1.0",";","EG","+=","0.05",")","{","Eo","=","max","(","texture2D","(","u_input",",","vec2","(","EF",",","EG",")",")",".","r",",","0.01",")",";","EE","+=","log","(","Eo",")",";","}","float","EH","=","exp","(","EE","/","400.0",")",";","gl_FragColor","=","vec4","(","vec3","(","EH",")",",","1.0",")",";","}"]}]},exports["postprocessing/luminance_trunced.glslf"]=
{type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_main",";","uniform","sampler2D","u_luminance",";","uniform","sampler2D","u_average_lum",";","uniform","float","u_bloom_edge_lum",";","varying","vec2","b_",";","varying","float","EE",";","void","main","(",")","{","float","EF","=","texture2D","(","u_average_lum",",","vec2","(","0.5",")",")",".","r",";","float","EG","=","texture2D","(","u_luminance",",","b_",")",".","r",";","vec4",
"EH","=","texture2D","(","u_main",",","b_",")",";","float","EI","=","EG","/","EF",";","float","EJ","=","u_bloom_edge_lum",";","gl_FragColor","=","EH","*","max","(","EI","-","EJ",",","0.0",")","*","EE",";","}"]}]},exports["postprocessing/luminance_trunced.glslv"]={type:"group",parts:[{type:"textline",tokens:["attribute","vec2","a_position",";","uniform","vec4","u_camera_quat",";","uniform","vec3","u_sun_direction",";","uniform","float","u_bloom_key",";","varying","vec2","b_",";","varying","float",
"EE",";","const","vec3","Eo","=","vec3","(","0.0",",","1.0",",","0.0",")",";","void","EM","(","in","vec4","EF",",","in","vec3","EG",",","out","vec3","EH",")","{","float","EI","=","EF",".","w","*","EG",".","x","+","EF",".","y","*","EG",".","z","-","EF",".","z","*","EG",".","y",";","float","EJ","=","EF",".","w","*","EG",".","y","+","EF",".","z","*","EG",".","x","-","EF",".","x","*","EG",".","z",";","float","EK","=","EF",".","w","*","EG",".","z","+","EF",".","x","*","EG",".","y","-","EF",".","y","*",
"EG",".","x",";","float","EL","=","-","EF",".","x","*","EG",".","x","-","EF",".","y","*","EG",".","y","-","EF",".","z","*","EG",".","z",";","EH",".","x","=","EI","*","EF",".","w","-","EL","*","EF",".","x","-","EJ","*","EF",".","z","+","EK","*","EF",".","y",";","EH",".","y","=","EJ","*","EF",".","w","-","EL","*","EF",".","y","-","EK","*","EF",".","x","+","EI","*","EF",".","z",";","EH",".","z","=","EK","*","EF",".","w","-","EL","*","EF",".","z","-","EI","*","EF",".","y","+","EJ","*","EF",".","x",";",
"}","void","main","(",")","{","b_","=","2.0","*","a_position",";","vec3","EN",";","EM","(","u_camera_quat",",","Eo",",","EN",")",";","EE","=","dot","(","-","EN",",","u_sun_direction",")","*","u_bloom_key",";","EE","*=","max","(","sign","(","u_sun_direction",".","y",")",",","0.0",")",";","gl_Position","=","vec4","(","4.0","*","(","a_position",".","xy","-","0.25",")",",","0.0",",","1.0",")",";","}"]}]},exports["postprocessing/motion_blur.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},
{type:"textline",tokens:["uniform","sampler2D","u_mb_tex_curr",";","uniform","sampler2D","u_mb_tex_accum",";","uniform","float","u_motion_blur_exp",";","uniform","float","u_motion_blur_decay_threshold",";","varying","vec2","b_",";","float","Eo","=","0.0042",";","void","main","(",")","{","vec4","EF","=","texture2D","(","u_mb_tex_curr",",","b_",")",";","vec4","EG","=","texture2D","(","u_mb_tex_accum",",","b_",")",";","if","(","length","(","EF","-","EG",")",">","u_motion_blur_decay_threshold",")","{",
"vec4","EH","=","(","1.0","-","u_motion_blur_exp",")","*","EF","+","u_motion_blur_exp","*","EG",";","vec4","EI","=","EH","-","EG",";","vec4","EJ","=","EF","-","EG",";","vec4","EK","=","min","(","max","(","abs","(","EI",")",",","vec4","(","Eo",")",")",",","abs","(","EJ",")",")","*","sign","(","EI",")",";","gl_FragColor","=","EG","+","EK",";","}","else","{","gl_FragColor","=","EF",";","}","}"]}]},exports["postprocessing/outline.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},
{type:"include",file:"gamma.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_outline_src",";","uniform","sampler2D","u_outline_mask",";","uniform","sampler2D","u_outline_mask_blurred",";","uniform","vec3","u_outline_color",";","uniform","float","u_draw_outline",";","varying","vec2","b_",";","void","main","(",")","{","vec4","Eo","=","texture2D","(","u_outline_src",",","b_",")",";","gl_FragColor","=","Eo",";","if","(","u_draw_outline","!=","0.0",")","{","vec4","EF","=","texture2D","(","u_outline_mask",
",","b_",")",";","vec4","EG","=","texture2D","(","u_outline_mask_blurred",",","b_",")",";","float","EH","=","EG",".","a","-","EF",".","a",";","if","(","EH","!=","0.0",")","{","float","EI","=","smoothstep","(","0.0",",","1.0",",","EG",".","a",")",";","if","(","EF",".","a","==","0.0",")","{","vec3","EJ","=","u_outline_color",";","bb","(","EJ",")",";","vec4","EK","=","vec4","(","clamp","(","EJ",",","0.0",",","1.0",")",",","1.0",")",";","gl_FragColor","=","mix","(","Eo",",","EK",",","EI",")",";","}",
"}","}","}"]}]},exports["postprocessing/postprocessing.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"define",name:"POST_EFFECT_NONE",tokens:["1"]},{type:"define",name:"POST_EFFECT_GRAYSCALE",tokens:["2"]},{type:"define",name:"POST_EFFECT_X_BLUR",tokens:["3"]},{type:"define",name:"POST_EFFECT_Y_BLUR",tokens:["4"]},{type:"define",name:"POST_EFFECT_X_EXTEND",tokens:["5"]},{type:"define",name:"POST_EFFECT_Y_EXTEND",tokens:["6"]},{type:"textline",tokens:["uniform",
"vec2","u_texel_size",";","uniform","sampler2D","u_color",";","varying","vec2","b_",";","void","main","(",")","{"]},{type:"condition",parts:[{type:"if",expression:["POST_EFFECT","POST_EFFECT_NONE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","texture2D","(","u_color",",","b_",")",";"]}]}},{type:"elif",expression:["POST_EFFECT","POST_EFFECT_GRAYSCALE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec4","Eo",
"=","texture2D","(","u_color",",","b_",")",";","gl_FragColor",".","rgb","=","vec3","(","(","Eo",".","r","+","Eo",".","g","+","Eo",".","b",")","/","3.0",")",";","gl_FragColor",".","a","=","1.0",";"]}]}},{type:"elif",expression:["POST_EFFECT","POST_EFFECT_X_BLUR",{type:"equal_expr",places:2},"POST_EFFECT","POST_EFFECT_Y_BLUR",{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec2","EF","=","vec2","(","0.0",",","0.0",")",";","vec2","EG",
"=","u_texel_size",";","vec4","EH",";","EH","=","texture2D","(","u_color",",","b_",")",";","gl_FragColor","=","EH","*","0.2270270270",";","EF","+=","EG",";","EH","=","texture2D","(","u_color",",","b_","+","EF",")",";","gl_FragColor","+=","EH","*","0.1945945946",";","EH","=","texture2D","(","u_color",",","b_","-","EF",")",";","gl_FragColor","+=","EH","*","0.1945945946",";","EF","+=","EG",";","EH","=","texture2D","(","u_color",",","b_","+","EF",")",";","gl_FragColor","+=","EH","*","0.1216216216",";",
"EH","=","texture2D","(","u_color",",","b_","-","EF",")",";","gl_FragColor","+=","EH","*","0.1216216216",";","EF","+=","EG",";","EH","=","texture2D","(","u_color",",","b_","+","EF",")",";","gl_FragColor","+=","EH","*","0.0540540541",";","EH","=","texture2D","(","u_color",",","b_","-","EF",")",";","gl_FragColor","+=","EH","*","0.0540540541",";","EF","+=","EG",";","EH","=","texture2D","(","u_color",",","b_","+","EF",")",";","gl_FragColor","+=","EH","*","0.0162162162",";","EH","=","texture2D","(","u_color",
",","b_","-","EF",")",";","gl_FragColor","+=","EH","*","0.0162162162",";"]}]}},{type:"elif",expression:["POST_EFFECT","POST_EFFECT_X_GLOW_BLUR",{type:"equal_expr",places:2},"POST_EFFECT","POST_EFFECT_Y_GLOW_BLUR",{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec2","EF","=","vec2","(","0.0",",","0.0",")",";","vec2","EG","=","u_texel_size",";","vec4","EH",";","EH","=","texture2D","(","u_color",",","b_",")",";","gl_FragColor","=",
"EH","*","(","1.0","-","step","(","0.0",",","-","EH",".","a",")",")","*","0.152507",";","EF","+=","EG",";","EH","=","texture2D","(","u_color",",","b_","+","EF",")",";","gl_FragColor","+=","EH","*","(","1.0","-","step","(","0.0",",","-","EH",".","a",")",")","*","0.141763",";","EH","=","texture2D","(","u_color",",","b_","-","EF",")",";","gl_FragColor","+=","EH","*","(","1.0","-","step","(","0.0",",","-","EH",".","a",")",")","*","0.141763",";","EF","+=","EG",";","EH","=","texture2D","(","u_color",",",
"b_","+","EF",")",";","gl_FragColor","+=","EH","*","(","1.0","-","step","(","0.0",",","-","EH",".","a",")",")","*","0.113861",";","EH","=","texture2D","(","u_color",",","b_","-","EF",")",";","gl_FragColor","+=","EH","*","(","1.0","-","step","(","0.0",",","-","EH",".","a",")",")","*","0.113861",";","EF","+=","EG",";","EH","=","texture2D","(","u_color",",","b_","+","EF",")",";","gl_FragColor","+=","EH","*","(","1.0","-","step","(","0.0",",","-","EH",".","a",")",")","*","0.079019",";","EH","=","texture2D",
"(","u_color",",","b_","-","EF",")",";","gl_FragColor","+=","EH","*","(","1.0","-","step","(","0.0",",","-","EH",".","a",")",")","*","0.079019",";","EF","+=","EG",";","EH","=","texture2D","(","u_color",",","b_","+","EF",")",";","gl_FragColor","+=","EH","*","(","1.0","-","step","(","0.0",",","-","EH",".","a",")",")","*","0.047383",";","EH","=","texture2D","(","u_color",",","b_","-","EF",")",";","gl_FragColor","+=","EH","*","(","1.0","-","step","(","0.0",",","-","EH",".","a",")",")","*","0.047383",
";","EF","+=","EG",";","EH","=","texture2D","(","u_color",",","b_","+","EF",")",";","gl_FragColor","+=","EH","*","(","1.0","-","step","(","0.0",",","-","EH",".","a",")",")","*","0.024549",";","EH","=","texture2D","(","u_color",",","b_","-","EF",")",";","gl_FragColor","+=","EH","*","(","1.0","-","step","(","0.0",",","-","EH",".","a",")",")","*","0.024549",";","EF","+=","EG",";","EH","=","texture2D","(","u_color",",","b_","+","EF",")",";","gl_FragColor","+=","EH","*","(","1.0","-","step","(","0.0",
",","-","EH",".","a",")",")","*","0.01099",";","EH","=","texture2D","(","u_color",",","b_","-","EF",")",";","gl_FragColor","+=","EH","*","(","1.0","-","step","(","0.0",",","-","EH",".","a",")",")","*","0.01099",";","EF","+=","EG",";","EH","=","texture2D","(","u_color",",","b_","+","EF",")",";","gl_FragColor","+=","EH","*","(","1.0","-","step","(","0.0",",","-","EH",".","a",")",")","*","0.00425",";","EH","=","texture2D","(","u_color",",","b_","-","EF",")",";","gl_FragColor","+=","EH","*","(","1.0",
"-","step","(","0.0",",","-","EH",".","a",")",")","*","0.00425",";","EF","+=","EG",";","EH","=","texture2D","(","u_color",",","b_","+","EF",")",";","gl_FragColor","+=","EH","*","(","1.0","-","step","(","0.0",",","-","EH",".","a",")",")","*","0.00142",";","EH","=","texture2D","(","u_color",",","b_","-","EF",")",";","gl_FragColor","+=","EH","*","(","1.0","-","step","(","0.0",",","-","EH",".","a",")",")","*","0.00142",";","gl_FragColor","=","clamp","(","gl_FragColor",",","0.0",",","1.0",")",";"]}]}},
{type:"elif",expression:["POST_EFFECT","POST_EFFECT_X_EXTEND",{type:"equal_expr",places:2},"POST_EFFECT","POST_EFFECT_Y_EXTEND",{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec2","EG","=","u_texel_size",";","vec4","EH","=","texture2D","(","u_color",",","b_",")",";","gl_FragColor","=","EH",";","if","(","EH",".","a","==","0.0",")","{","EH","=","texture2D","(","u_color",",","b_","+","EG",")",";","if","(","EH",".","a",">","0.0",")",
"gl_FragColor","=","vec4","(","1.0",",","1.0",",","1.0",",","EH",".","a",")",";","else","{","EH","=","texture2D","(","u_color",",","b_","-","EG",")",";","if","(","EH",".","a",">","0.0",")","gl_FragColor","=","vec4","(","1.0",",","1.0",",","1.0",",","EH",".","a",")",";","}","}"]}]}}]},{type:"textline",tokens:["}"]}]},exports["postprocessing/postprocessing.glslv"]={type:"group",parts:[{type:"textline",tokens:["attribute","vec2","a_position",";","varying","vec2","b_",";","void","main","(",")","{","b_",
"=","2.0","*","a_position",";","gl_Position","=","vec4","(","4.0","*","(","a_position",".","xy","-","0.25",")",",","0.0",",","1.0",")",";","}"]}]},exports["postprocessing/smaa.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"include",file:"gamma.glslf"},{type:"include",file:"pack.glslf"},{type:"define",name:"SMAA_RESOLVE",tokens:["1"]},{type:"define",name:"SMAA_EDGE_DETECTION",tokens:["2"]},{type:"define",name:"SMAA_BLENDING_WEIGHT_CALCULATION",tokens:["3"]},{type:"define",
name:"SMAA_NEIGHBORHOOD_BLENDING",tokens:["4"]},{type:"define",name:"AA_METHOD_SMAA_LOW",tokens:["1"]},{type:"define",name:"AA_METHOD_SMAA_MEDIUM",tokens:["2"]},{type:"define",name:"AA_METHOD_SMAA_HIGH",tokens:["3"]},{type:"define",name:"AA_METHOD_SMAA_ULTRA",tokens:["4"]},{type:"textline",tokens:["uniform","sampler2D","u_color",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_RESOLVE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform",
"sampler2D","u_color_prev",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_NEIGHBORHOOD_BLENDING",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_blend",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_REPROJECTION"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_velocity_tex",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_EDGE_DETECTION",
{type:"equal_expr",places:2},"SMAA_PREDICATION",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_predication_tex",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_BLENDING_WEIGHT_CALCULATION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_search_tex",";","uniform","sampler2D","u_area_tex",";","uniform","vec4","u_subsample_indices",";"]}]}}]},{type:"textline",
tokens:["uniform","vec2","u_texel_size",";","varying","vec2","b_",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_NEIGHBORHOOD_BLENDING",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","EF",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","EG",";","varying","vec4","EH",";","varying","vec4","EI",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_BLENDING_WEIGHT_CALCULATION",
{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","EJ",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["AA_METHOD","AA_METHOD_SMAA_LOW",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"SMAA_THRESHOLD",tokens:["0.15"]},{type:"define",name:"SMAA_DISABLE_DIAG_DETECTION",tokens:["1"]},{type:"define",name:"SMAA_DISABLE_CORNER_DETECTION",tokens:["1"]}]}},{type:"elif",expression:["AA_METHOD","AA_METHOD_SMAA_MEDIUM",
{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"SMAA_THRESHOLD",tokens:["0.1"]},{type:"define",name:"SMAA_DISABLE_DIAG_DETECTION",tokens:["1"]},{type:"define",name:"SMAA_DISABLE_CORNER_DETECTION",tokens:["1"]}]}},{type:"elif",expression:["AA_METHOD","AA_METHOD_SMAA_HIGH",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"SMAA_THRESHOLD",tokens:["0.1"]},{type:"define",name:"SMAA_DISABLE_DIAG_DETECTION",tokens:["0"]},{type:"define",name:"SMAA_MAX_SEARCH_STEPS_DIAG",
tokens:["8"]},{type:"define",name:"SMAA_CORNER_ROUNDING",tokens:["25"]}]}},{type:"elif",expression:["AA_METHOD","AA_METHOD_SMAA_ULTRA",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"SMAA_THRESHOLD",tokens:["0.05"]},{type:"define",name:"SMAA_DISABLE_DIAG_DETECTION",tokens:["0"]},{type:"define",name:"SMAA_MAX_SEARCH_STEPS_DIAG",tokens:["16"]},{type:"define",name:"SMAA_CORNER_ROUNDING",tokens:["25"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_THRESHOLD",group:{type:"group",
parts:[{type:"define",name:"SMAA_THRESHOLD",tokens:["0.1"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_DEPTH_THRESHOLD",group:{type:"group",parts:[{type:"define",name:"SMAA_DEPTH_THRESHOLD",tokens:["(","0.1","*","SMAA_THRESHOLD",")"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_MAX_SEARCH_STEPS_DIAG",group:{type:"group",parts:[{type:"define",name:"SMAA_MAX_SEARCH_STEPS_DIAG",tokens:["8"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_CORNER_ROUNDING",group:{type:"group",
parts:[{type:"define",name:"SMAA_CORNER_ROUNDING",tokens:["25"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_LOCAL_CONTRAST_ADAPTATION_FACTOR",group:{type:"group",parts:[{type:"define",name:"SMAA_LOCAL_CONTRAST_ADAPTATION_FACTOR",tokens:["2.0"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_PREDICATION",group:{type:"group",parts:[{type:"define",name:"SMAA_PREDICATION",tokens:["0"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_PREDICATION_THRESHOLD",group:{type:"group",
parts:[{type:"define",name:"SMAA_PREDICATION_THRESHOLD",tokens:["0.01"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_PREDICATION_SCALE",group:{type:"group",parts:[{type:"define",name:"SMAA_PREDICATION_SCALE",tokens:["2.0"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_PREDICATION_STRENGTH",group:{type:"group",parts:[{type:"define",name:"SMAA_PREDICATION_STRENGTH",tokens:["0.4"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_REPROJECTION",group:{type:"group",parts:[{type:"define",
name:"SMAA_REPROJECTION",tokens:["0"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_REPROJECTION_WEIGHT_SCALE",group:{type:"group",parts:[{type:"define",name:"SMAA_REPROJECTION_WEIGHT_SCALE",tokens:["30.0"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_MAX_SEARCH_STEPS",group:{type:"group",parts:[{type:"define",name:"SMAA_MAX_SEARCH_STEPS",tokens:["16"]}]}}]},{type:"define",name:"SMAA_AREATEX_MAX_DISTANCE",tokens:["16"]},{type:"define",name:"SMAA_AREATEX_MAX_DISTANCE_DIAG",tokens:["20"]},
{type:"define",name:"SMAA_AREATEX_PIXEL_SIZE",tokens:["(","1.0","/","vec2","(","160.0",",","560.0",")",")"]},{type:"define",name:"SMAA_AREATEX_SUBTEX_SIZE",tokens:["(","1.0","/","7.0",")"]},{type:"define",name:"SMAA_SEARCHTEX_SIZE",tokens:["vec2","(","66.0",",","33.0",")"]},{type:"define",name:"SMAA_SEARCHTEX_PACKED_SIZE",tokens:["vec2","(","64.0",",","16.0",")"]},{type:"define",name:"SMAA_CORNER_ROUNDING_NORM",tokens:["(","float","(","SMAA_CORNER_ROUNDING",")","/","100.0",")"]},{type:"condition",
parts:[{type:"if",expression:["SMAA_PASS","SMAA_EDGE_DETECTION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","EP","(","vec2","EK",",","sampler2D","EL",")","{","float","EM","=","texture2D","(","EL",",","EK",")",".","r",";","float","EN","=","texture2D","(","EL",",","EG",".","xy",")",".","r",";","float","EO","=","texture2D","(","EL",",","EG",".","zw",")",".","r",";","return","vec3","(","EM",",","EN",",","EO",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["SMAA_PASS","SMAA_EDGE_DETECTION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec2","EV","(","vec2","EQ",",","sampler2D","ER",")","{","vec3","ES","=","EP","(","EQ",",","ER",")",";","vec2","ET","=","abs","(","ES",".","xx","-","ES",".","yz",")",";","vec2","EU","=","step","(","SMAA_PREDICATION_THRESHOLD",",","ET",")",";","return","SMAA_PREDICATION_SCALE","*","SMAA_THRESHOLD","*","(","1.0","-","SMAA_PREDICATION_STRENGTH","*","EU",")",";","}"]}]}}]},{type:"textline",
tokens:["void","EZ","(","bvec2","EW",",","inout","vec2","EX",",","vec2","EY",")","{","if","(","EW",".","x",")","EX",".","x","=","EY",".","x",";","if","(","EW",".","y",")","EX",".","y","=","EY",".","y",";","}","void","EZ","(","bvec4","E_",",","inout","vec4","Fa",",","vec4","Fb",")","{","EZ","(","E_",".","xy",",","Fa",".","xy",",","Fb",".","xy",")",";","EZ","(","E_",".","zw",",","Fa",".","zw",",","Fb",".","zw",")",";","}","vec2","Fd","(","vec2","Fc",")","{","return","sign","(","Fc",")","*","floor",
"(","abs","(","Fc",")","+",".5",")",";","}","vec4","Fd","(","vec4","Fe",")","{","return","sign","(","Fe",")","*","floor","(","abs","(","Fe",")","+",".5",")",";","}"]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_EDGE_DETECTION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec2","Fv","(","vec2","Ff",",","sampler2D","Fg"]},{type:"condition",parts:[{type:"if",expression:["SMAA_PREDICATION"],group:{type:"group",parts:[{type:"textline",tokens:[",",
"sampler2D","Fh"]}]}}]},{type:"textline",tokens:[")","{"]},{type:"condition",parts:[{type:"if",expression:["SMAA_PREDICATION"],group:{type:"group",parts:[{type:"textline",tokens:["vec2","Fi","=","EV","(","Ff",",","Fh",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec2","Fi","=","vec2","(","SMAA_THRESHOLD",",","SMAA_THRESHOLD",")",";"]}]}}]},{type:"textline",tokens:["vec3","Fj","=","vec3","(","0.2126",",","0.7152",",","0.0722",")",";","float","Fk","=","dot","(","texture2D",
"(","Fg",",","Ff",")",".","rgb",",","Fj",")",";","float","Fl","=","dot","(","texture2D","(","Fg",",","EG",".","xy",")",".","rgb",",","Fj",")",";","float","Fm","=","dot","(","texture2D","(","Fg",",","EG",".","zw",")",".","rgb",",","Fj",")",";","vec4","Fn",";","Fn",".","xy","=","abs","(","Fk","-","vec2","(","Fl",",","Fm",")",")",";","vec2","Fo","=","step","(","Fi",",","Fn",".","xy",")",";","if","(","dot","(","Fo",",","vec2","(","1.0",",","1.0",")",")","==","0.0",")","discard",";","float","Fp","=","dot",
"(","texture2D","(","Fg",",","EH",".","xy",")",".","rgb",",","Fj",")",";","float","Fq","=","dot","(","texture2D","(","Fg",",","EH",".","zw",")",".","rgb",",","Fj",")",";","Fn",".","zw","=","abs","(","Fk","-","vec2","(","Fp",",","Fq",")",")",";","vec2","Fr","=","max","(","Fn",".","xy",",","Fn",".","zw",")",";","float","Fs","=","dot","(","texture2D","(","Fg",",","EI",".","xy",")",".","rgb",",","Fj",")",";","float","Ft","=","dot","(","texture2D","(","Fg",",","EI",".","zw",")",".","rgb",",","Fj",")",
";","Fn",".","zw","=","abs","(","vec2","(","Fl",",","Fm",")","-","vec2","(","Fs",",","Ft",")",")",";","Fr","=","max","(","Fr",".","xy",",","Fn",".","zw",")",";","float","Fu","=","max","(","Fr",".","x",",","Fr",".","y",")",";","Fo",".","xy","*=","step","(","Fu",",","SMAA_LOCAL_CONTRAST_ADAPTATION_FACTOR","*","Fn",".","xy",")",";","return","Fo",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_DISABLE_DIAG_DETECTION",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",
tokens:["vec2","Fx","(","vec2","Fw",")","{","Fw",".","r","=","Fw",".","r","*","abs","(","5.0","*","Fw",".","r","-","5.0","*","0.75",")",";","return","Fd","(","Fw",")",";","}","vec4","Fx","(","vec4","Fy",")","{","Fy",".","rb","=","Fy",".","rb","*","abs","(","5.0","*","Fy",".","rb","-","5.0","*","0.75",")",";","return","Fd","(","Fy",")",";","}","vec2","FG","(","sampler2D","Fz",",","vec2","FA",",","vec2","FB",",","out","vec2","FC",")","{","vec4","FD","=","vec4","(","FA",",","-","1.0",",","1.0",")",";",
"vec3","FE","=","vec3","(","u_texel_size",",","1.0",")",";","for","(","int","FF","=","0",";","FF","<","SMAA_MAX_SEARCH_STEPS_DIAG",";","FF","++",")","{","if","(","FD",".","z","<","float","(","SMAA_MAX_SEARCH_STEPS_DIAG","-","1",")","&&","FD",".","w",">","0.9",")","{","FD",".","xyz","+=","FE","*","vec3","(","FB",",","1.0",")",";","FC","=","texture2D","(","Fz",",","FD",".","xy",",","0.0",")",".","rg",";","FD",".","w","=","dot","(","FC",",","vec2","(","0.5",",","0.5",")",")",";","}","}","return","FD",
".","zw",";","}","vec2","FO","(","sampler2D","FH",",","vec2","FI",",","vec2","FJ",",","out","vec2","FK",")","{","vec4","FL","=","vec4","(","FI",",","-","1.0",",","1.0",")",";","FL",".","x","+=","0.25","*","u_texel_size",".","x",";","vec3","FM","=","vec3","(","u_texel_size",",","1.0",")",";","for","(","int","FN","=","0",";","FN","<","SMAA_MAX_SEARCH_STEPS_DIAG",";","FN","++",")","{","if","(","FL",".","z","<","float","(","SMAA_MAX_SEARCH_STEPS_DIAG","-","1",")","&&","FL",".","w",">","0.9",")","{","FL",
".","xyz","=","FM","*","vec3","(","FJ",",","1.0",")","+","FL",".","xyz",";","FK","=","texture2D","(","FH",",","FL",".","xy",",","0.0",")",".","rg",";","FK","=","Fx","(","FK",")",";","FL",".","w","=","dot","(","FK",",","vec2","(","0.5",",","0.5",")",")",";","}","}","return","FL",".","zw",";","}","vec2","FU","(","sampler2D","FP",",","vec2","FQ",",","vec2","FR",",","float","FS",")","{","vec2","FT","=","vec2","(","SMAA_AREATEX_MAX_DISTANCE_DIAG",",","SMAA_AREATEX_MAX_DISTANCE_DIAG",")","*","FR","+","FQ",
";","FT","=","SMAA_AREATEX_PIXEL_SIZE","*","FT","+","0.5","*","SMAA_AREATEX_PIXEL_SIZE",";","FT",".","x","+=","0.5",";","FT",".","y","+=","SMAA_AREATEX_SUBTEX_SIZE","*","FS",";","return","texture2D","(","FP",",","FT",",","0.0",")",".","rg",";","}","vec2","Gi","(","sampler2D","FV",",","sampler2D","FW",",","vec2","FX",",","vec2","FY",",","vec4","FZ",")","{","vec2","F_","=","vec2","(","0.0",",","0.0",")",";","vec4","Ga",";","vec2","Gb",";","if","(","FY",".","r",">","0.0",")","{","Ga",".","xz","=","FG",
"(","FV",",","FX",",","vec2","(","-","1.0",",","1.0",")",",","Gb",")",";","Ga",".","x","+=","float","(","Gb",".","y",">","0.9",")",";","}","else","Ga",".","xz","=","vec2","(","0.0",",","0.0",")",";","Ga",".","yw","=","FG","(","FV",",","FX",",","vec2","(","1.0",",","-","1.0",")",",","Gb",")",";","if","(","Ga",".","x","+","Ga",".","y",">","2.0",")","{","vec4","Gc","=","vec4","(","-","Ga",".","x","+","0.25",",","Ga",".","x",",","Ga",".","y",",","-","Ga",".","y","-","0.25",")","*","u_texel_size",".",
"xyxy","+","FX",".","xyxy",";","vec4","Gd",";","Gd",".","xy","=","texture2D","(","FV",",","Gc",".","xy","+","u_texel_size","*","vec2","(","-","1",",","0",")",",","0.0",")",".","rg",";","Gd",".","zw","=","texture2D","(","FV",",","Gc",".","zw","+","u_texel_size","*","vec2","(","1",",","0",")",",","0.0",")",".","rg",";","Gd",".","yxwz","=","Fx","(","Gd",".","xyzw",")",";","vec2","Ge","=","vec2","(","2.0",",","2.0",")","*","Gd",".","xz","+","Gd",".","yw",";","EZ","(","bvec2","(","step","(","0.9",",",
"Ga",".","zw",")",")",",","Ge",",","vec2","(","0.0",",","0.0",")",")",";","F_","+=","FU","(","FW",",","Ga",".","xy",",","Ge",",","FZ",".","z",")",";","}","Ga",".","xz","=","FO","(","FV",",","FX",",","vec2","(","-","1",",","-","1",")",",","Gb",")",";","if","(","texture2D","(","FV",",","FX","+","u_texel_size","*","vec2","(","1",",","0",")",",","0.0",")",".","r",">","0.0",")","{","Ga",".","yw","=","FO","(","FV",",","FX",",","vec2","(","1",",","1",")",",","Gb",")",";","Ga",".","y","+=","float","(","Gb",
".","y",">","0.9",")",";","}","else","Ga",".","yw","=","vec2","(","0.0",",","0.0",")",";","if","(","Ga",".","x","+","Ga",".","y",">","2.0",")","{","vec4","Gf","=","vec4","(","-","Ga",".","x",",","-","Ga",".","x",",","Ga",".","y",",","Ga",".","y",")","*","u_texel_size",".","xyxy","+","FX",".","xyxy",";","vec4","Gg",";","Gg",".","x","=","texture2D","(","FV",",","Gf",".","xy","+","u_texel_size","*","vec2","(","-","1",",","0",")",",","0.0",")",".","g",";","Gg",".","y","=","texture2D","(","FV",",","Gf",
".","xy","+","u_texel_size","*","vec2","(","0",",","-","1",")",",","0.0",")",".","r",";","Gg",".","zw","=","texture2D","(","FV",",","Gf",".","zw","+","u_texel_size","*","vec2","(","1",",","0",")",",","0.0",")",".","gr",";","vec2","Gh","=","vec2","(","2.0",",","2.0",")","*","Gg",".","xz","+","Gg",".","yw",";","EZ","(","bvec2","(","step","(","0.9",",","Ga",".","zw",")",")",",","Gh",",","vec2","(","0",",","0",")",")",";","F_","+=","FU","(","FW",",","Ga",".","xy",",","Gh",",","FZ",".","w",")",".","gr",
";","}","return","F_",";","}"]}]}}]},{type:"textline",tokens:["float","Go","(","sampler2D","Gj",",","vec2","Gk",",","float","Gl",")","{","vec2","Gm","=","SMAA_SEARCHTEX_SIZE","*","vec2","(","0.5",",","-","1.0",")",";","vec2","Gn","=","SMAA_SEARCHTEX_SIZE","*","vec2","(","Gl",",","1.0",")",";","Gm","+=","vec2","(","-","1.0",",","1.0",")",";","Gn","+=","vec2","(","0.5",",","-","0.5",")",";","Gm","*=","1.0","/","SMAA_SEARCHTEX_PACKED_SIZE",";","Gn","*=","1.0","/","SMAA_SEARCHTEX_PACKED_SIZE",";","return",
"texture2D","(","Gj",",","Gm","*","Gk","+","Gn",",","0.0",")",".","r",";","}","float","Gw","(","sampler2D","Gp",",","sampler2D","Gq",",","vec2","Gr",",","float","Gs",")","{","vec2","Gt","=","vec2","(","0.0",",","1.0",")",";","for","(","int","Gu","=","0",";","Gu","<","SMAA_MAX_SEARCH_STEPS",";","Gu","++",")","{","if","(","Gr",".","x",">","Gs","&&","Gt",".","g",">","0.8281","&&","Gt",".","r","==","0.0",")","{","Gt","=","texture2D","(","Gp",",","Gr",",","0.0",")",".","rg",";","Gr","=","-","vec2","(",
"2.0",",","0.0",")","*","u_texel_size","+","Gr",";","}","}","float","Gv","=","-","(","255.0","/","127.0",")","*","Go","(","Gq",",","Gt",",","0.0",")","+","3.25",";","return","u_texel_size",".","x","*","Gv","+","Gr",".","x",";","}","float","GE","(","sampler2D","Gx",",","sampler2D","Gy",",","vec2","Gz",",","float","GA",")","{","vec2","GB","=","vec2","(","0.0",",","1.0",")",";","for","(","int","GC","=","0",";","GC","<","SMAA_MAX_SEARCH_STEPS",";","GC","++",")","{","if","(","Gz",".","x","<","GA","&&",
"GB",".","g",">","0.8281","&&","GB",".","r","==","0.0",")","{","GB","=","texture2D","(","Gx",",","Gz",",","0.0",")",".","rg",";","Gz","=","vec2","(","2.0",",","0.0",")","*","u_texel_size","+","Gz",";","}","}","float","GD","=","-","(","255.0","/","127.0",")","*","Go","(","Gy",",","GB",",","0.5",")","+","3.25",";","return","-","u_texel_size",".","x","*","GD","+","Gz",".","x",";","}","float","GM","(","sampler2D","GF",",","sampler2D","GG",",","vec2","GH",",","float","GI",")","{","vec2","GJ","=","vec2",
"(","1.0",",","0.0",")",";","for","(","int","GK","=","0",";","GK","<","SMAA_MAX_SEARCH_STEPS",";","GK","++",")","{","if","(","GH",".","y",">","GI","&&","GJ",".","r",">","0.8281","&&","GJ",".","g","==","0.0",")","{","GJ","=","texture2D","(","GF",",","GH",",","0.0",")",".","rg",";","GH","=","-","vec2","(","0.0",",","2.0",")","*","u_texel_size","+","GH",";","}","}","float","GL","=","-","(","255.0","/","127.0",")","*","Go","(","GG",",","GJ",".","gr",",","0.0",")","+","3.25",";","return","u_texel_size",
".","y","*","GL","+","GH",".","y",";","}","float","GU","(","sampler2D","GN",",","sampler2D","GO",",","vec2","GP",",","float","GQ",")","{","vec2","GR","=","vec2","(","1.0",",","0.0",")",";","for","(","int","GS","=","0",";","GS","<","SMAA_MAX_SEARCH_STEPS",";","GS","++",")","{","if","(","GP",".","y","<","GQ","&&","GR",".","r",">","0.8281","&&","GR",".","g","==","0.0",")","{","GR","=","texture2D","(","GN",",","GP",",","0.0",")",".","rg",";","GP","=","vec2","(","0.0",",","2.0",")","*","u_texel_size",
"+","GP",";","}","}","float","GT","=","-","(","255.0","/","127.0",")","*","Go","(","GO",",","GR",".","gr",",","0.5",")","+","3.25",";","return","-","u_texel_size",".","y","*","GT","+","GP",".","y",";","}","vec2","Ha","(","sampler2D","GV",",","vec2","GW",",","float","GX",",","float","GY",",","float","GZ",")","{","vec2","G_","=","vec2","(","SMAA_AREATEX_MAX_DISTANCE",",","SMAA_AREATEX_MAX_DISTANCE",")","*","Fd","(","4.0","*","vec2","(","GX",",","GY",")",")","+","GW",";","G_","=","SMAA_AREATEX_PIXEL_SIZE",
"*","G_","+","0.5","*","SMAA_AREATEX_PIXEL_SIZE",";","G_",".","y","=","SMAA_AREATEX_SUBTEX_SIZE","*","GZ","+","G_",".","y",";","return","texture2D","(","GV",",","G_",",","0.0",")",".","rg",";","}","void","Hi","(","sampler2D","Hb",",","inout","vec2","Hc",",","vec4","Hd",",","vec2","He",")","{"]},{type:"condition",parts:[{type:"if",expression:["SMAA_DISABLE_CORNER_DETECTION",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["vec2","Hf","=","step","(","He",".",
"xy",",","He",".","yx",")",";","vec2","Hg","=","(","1.0","-","SMAA_CORNER_ROUNDING_NORM",")","*","Hf",";","Hg","/=","Hf",".","x","+","Hf",".","y",";","vec2","Hh","=","vec2","(","1.0",",","1.0",")",";","Hh",".","x","-=","Hg",".","x","*","texture2D","(","Hb",",","Hd",".","xy","+","u_texel_size","*","vec2","(","0",",","1",")",",","0.0",")",".","r",";","Hh",".","x","-=","Hg",".","y","*","texture2D","(","Hb",",","Hd",".","zw","+","u_texel_size","*","vec2","(","1",",","1",")",",","0.0",")",".","r",";",
"Hh",".","y","-=","Hg",".","x","*","texture2D","(","Hb",",","Hd",".","xy","+","u_texel_size","*","vec2","(","0",",","-","2",")",",","0.0",")",".","r",";","Hh",".","y","-=","Hg",".","y","*","texture2D","(","Hb",",","Hd",".","zw","+","u_texel_size","*","vec2","(","1",",","-","2",")",",","0.0",")",".","r",";","Hc","*=","clamp","(","Hh",",","0.0",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["}","void","Hq","(","sampler2D","Hj",",","inout","vec2","Hk",",","vec4","Hl",",","vec2","Hm",")","{"]},{type:"condition",
parts:[{type:"if",expression:["SMAA_DISABLE_CORNER_DETECTION",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["vec2","Hn","=","step","(","Hm",".","xy",",","Hm",".","yx",")",";","vec2","Ho","=","(","1.0","-","SMAA_CORNER_ROUNDING_NORM",")","*","Hn",";","Ho","/=","Hn",".","x","+","Hn",".","y",";","vec2","Hp","=","vec2","(","1.0",",","1.0",")",";","Hp",".","x","-=","Ho",".","x","*","texture2D","(","Hj",",","Hl",".","xy","+","u_texel_size","*","vec2","(","1",
",","0",")",",","0.0",")",".","g",";","Hp",".","x","-=","Ho",".","y","*","texture2D","(","Hj",",","Hl",".","zw","+","u_texel_size","*","vec2","(","1",",","1",")",",","0.0",")",".","g",";","Hp",".","y","-=","Ho",".","x","*","texture2D","(","Hj",",","Hl",".","xy","+","u_texel_size","*","vec2","(","-","2",",","0",")",",","0.0",")",".","g",";","Hp",".","y","-=","Ho",".","y","*","texture2D","(","Hj",",","Hl",".","zw","+","u_texel_size","*","vec2","(","-","2",",","1",")",",","0.0",")",".","g",";","Hk",
"*=","clamp","(","Hp",",","0.0",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["}"]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_BLENDING_WEIGHT_CALCULATION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec4","HJ","(","vec2","Hr",",","vec2","Hs",",","sampler2D","Ht",",","sampler2D","Hu",",","sampler2D","Hv",",","vec4","Hw",")","{","vec4","Hx","=","vec4","(","0.0",",","0.0",",","0.0",",","0.0",")",";","vec2","Hy","=","texture2D","(","Ht",
",","Hr",")",".","rg",";","if","(","Hy",".","g",">","0.0",")","{"]},{type:"condition",parts:[{type:"if",expression:["SMAA_DISABLE_DIAG_DETECTION",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["Hx",".","rg","=","Gi","(","Ht",",","Hu",",","Hr",",","Hy",",","Hw",")",";","if","(","Hx",".","r","==","-","Hx",".","g",")","{"]}]}}]},{type:"textline",tokens:["vec2","Hz",";","vec3","HA",";","HA",".","x","=","Gw","(","Ht",",","Hv",",","EG",".","xy",",","EI",".","x",
")",";","HA",".","y","=","EH",".","y",";","Hz",".","x","=","HA",".","x",";","float","HB","=","texture2D","(","Ht",",","HA",".","xy",",","0.0",")",".","r",";","HA",".","z","=","GE","(","Ht",",","Hv",",","EG",".","zw",",","EI",".","y",")",";","Hz",".","y","=","HA",".","z",";","Hz","=","abs","(","Fd","(","Hz","/","u_texel_size",".","xx","-","Hs",".","xx",")",")",";","vec2","HC","=","sqrt","(","Hz",")",";","float","HD","=","texture2D","(","Ht",",","HA",".","zy","+","u_texel_size","*","vec2","(","1",",",
"0",")",",","0.0",")",".","r",";","Hx",".","rg","=","Ha","(","Hu",",","HC",",","HB",",","HD",",","Hw",".","y",")",";","HA",".","y","=","Hr",".","y",";","Hi","(","Ht",",","Hx",".","rg",",","HA",".","xyzy",",","Hz",")",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_DISABLE_DIAG_DETECTION",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["}","else","Hy",".","r","=","0.0",";"]}]}}]},{type:"textline",tokens:["}","if","(","Hy",".","r",">","0.0",")",
"{","vec2","HE",";","vec3","HF",";","HF",".","y","=","GM","(","Ht",",","Hv",",","EH",".","xy",",","EI",".","z",")",";","HF",".","x","=","EG",".","x",";","HE",".","x","=","HF",".","y",";","float","HG","=","texture2D","(","Ht",",","HF",".","xy",",","0.0",")",".","g",";","HF",".","z","=","GU","(","Ht",",","Hv",",","EH",".","zw",",","EI",".","w",")",";","HE",".","y","=","HF",".","z",";","HE","=","abs","(","Fd","(","HE","/","u_texel_size",".","yy","-","Hs",".","yy",")",")",";","vec2","HH","=","sqrt","(",
"HE",")",";","float","HI","=","texture2D","(","Ht",",","HF",".","xz","+","u_texel_size","*","vec2","(","0",",","1",")",",","0.0",")",".","g",";","Hx",".","ba","=","Ha","(","Hu",",","HH",",","HG",",","HI",",","Hw",".","x",")",";","HF",".","x","=","Hr",".","x",";","Hq","(","Ht",",","Hx",".","ba",",","HF",".","xyxz",",","HE",")",";","}","return","Hx",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_NEIGHBORHOOD_BLENDING",{type:"equal_expr",places:2}],group:{type:"group",
parts:[{type:"textline",tokens:["vec4","H_","(","vec2","HK",",","sampler2D","HL",",","sampler2D","HM"]},{type:"condition",parts:[{type:"if",expression:["SMAA_REPROJECTION"],group:{type:"group",parts:[{type:"textline",tokens:[",","sampler2D","HN"]}]}}]},{type:"textline",tokens:[")","{","vec4","HO",";","HO",".","x","=","texture2D","(","HM",",","EF",".","xy",")",".","a",";","HO",".","y","=","texture2D","(","HM",",","EF",".","zw",")",".","g",";","HO",".","wz","=","texture2D","(","HM",",","HK",")",".",
"xz",";","if","(","dot","(","HO",",","vec4","(","1.0",",","1.0",",","1.0",",","1.0",")",")","<","1e-5",")","{","vec4","HP","=","texture2D","(","HL",",","HK",",","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_REPROJECTION"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","HQ","=","texture2D","(","HN",",","b_",")",";","vec2","HR","=","2.0","*","t","(","HQ",")","-","1.0",";","HP",".","a","=","sqrt","(","2.0","*","length","(","HR",")",")",";"]}]}}]},{type:"textline",
tokens:["return","HP",";","}","else","{","bool","HS","=","max","(","HO",".","x",",","HO",".","z",")",">","max","(","HO",".","y",",","HO",".","w",")",";","vec4","HT","=","vec4","(","0.0",",","HO",".","y",",","0.0",",","HO",".","w",")",";","vec2","HU","=","HO",".","yw",";","EZ","(","bvec4","(","HS",",","HS",",","HS",",","HS",")",",","HT",",","vec4","(","HO",".","x",",","0.0",",","HO",".","z",",","0.0",")",")",";","EZ","(","bvec2","(","HS",",","HS",")",",","HU",",","HO",".","xz",")",";","HU","/=","dot",
"(","HU",",","vec2","(","1.0",",","1.0",")",")",";","vec4","HV","=","HT","*","vec4","(","u_texel_size",",","-","u_texel_size",")","+","HK",".","xyxy",";","vec4","HW","=","HU",".","x","*","texture2D","(","HL",",","HV",".","xy",",","0.0",")",";","HW","+=","HU",".","y","*","texture2D","(","HL",",","HV",".","zw",",","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_REPROJECTION"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","HX","=","texture2D","(","HN",",","HV",".",
"xy",")",";","vec2","HY","=","2.0","*","t","(","HX",")","-","1.0",";","vec2","HZ","=","HU",".","x","*","HY",";","HX","=","texture2D","(","HN",",","HV",".","zw",")",";","HY","=","2.0","*","t","(","HX",")","-","1.0",";","HZ","+=","HU",".","y","*","HY",";","HW",".","a","=","sqrt","(","2.0","*","length","(","HZ",")",")",";"]}]}}]},{type:"textline",tokens:["return","HW",";","}","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_RESOLVE",{type:"equal_expr",places:2}],group:{type:"group",
parts:[{type:"textline",tokens:["vec4","Il","(","vec2","Ia",",","sampler2D","Ib",",","sampler2D","Ic"]},{type:"condition",parts:[{type:"if",expression:["SMAA_REPROJECTION"],group:{type:"group",parts:[{type:"textline",tokens:[",","sampler2D","Id"]}]}}]},{type:"textline",tokens:[")","{"]},{type:"condition",parts:[{type:"if",expression:["SMAA_REPROJECTION"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","Ie","=","texture2D","(","Id",",","b_",")",";","vec2","If",";","If","=","2.0","*","t",
"(","Ie",")","-","1.0",";","vec4","Ig","=","texture2D","(","Ib",",","Ia",")",";","vec4","Ih","=","texture2D","(","Ic",",","Ia","-","If",")",";","float","Ii","=","abs","(","Ig",".","a","*","Ig",".","a","-","Ih",".","a","*","Ih",".","a",")","/","2.0",";","float","Ij","=","0.5","*","clamp","(","1.0","-","sqrt","(","Ii",")","*","SMAA_REPROJECTION_WEIGHT_SCALE",",","0.0",",","1.0",")",";","vec4","Ik","=","mix","(","Ig",",","Ih",",","Ij",")",";","Ik",".","a","=","1.0",";","return","Ik",";"]}]}},{type:"else",
group:{type:"group",parts:[{type:"textline",tokens:["vec4","Ig","=","texture2D","(","Ib",",","Ia",")",";","vec4","Ih","=","texture2D","(","Ic",",","Ia",")",";","return","mix","(","Ig",",","Ih",",","0.5",")",";"]}]}}]},{type:"textline",tokens:["}"]}]}}]},{type:"textline",tokens:["void","main","(",")","{"]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_EDGE_DETECTION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec4","Im","=","vec4","(","Fv",
"(","b_",",","u_color"]},{type:"condition",parts:[{type:"if",expression:["SMAA_PREDICATION"],group:{type:"group",parts:[{type:"textline",tokens:[",","u_predication_tex"]}]}}]},{type:"textline",tokens:[")",",","0.0",",","0.0",")",";"]}]}},{type:"elif",expression:["SMAA_PASS","SMAA_BLENDING_WEIGHT_CALCULATION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec4","Im","=","HJ","(","b_",",","EJ",",","u_color",",","u_area_tex",",","u_search_tex",",","u_subsample_indices",
")",";"]}]}},{type:"elif",expression:["SMAA_PASS","SMAA_NEIGHBORHOOD_BLENDING",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec4","Im","=","H_","(","b_",",","u_color",",","u_blend"]},{type:"condition",parts:[{type:"if",expression:["SMAA_REPROJECTION"],group:{type:"group",parts:[{type:"textline",tokens:[",","u_velocity_tex"]}]}}]},{type:"textline",tokens:[")",";"]}]}},{type:"elif",expression:["SMAA_PASS","SMAA_RESOLVE",{type:"equal_expr",places:2}],group:{type:"group",
parts:[{type:"textline",tokens:["vec4","Im","=","vec4","(","Il","(","b_",",","u_color",",","u_color_prev"]},{type:"condition",parts:[{type:"if",expression:["SMAA_REPROJECTION"],group:{type:"group",parts:[{type:"textline",tokens:[",","u_velocity_tex"]}]}}]},{type:"textline",tokens:[")",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec4","Im","=","texture2D","(","u_color",",","b_",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor","=","Im",";","}"]}]},exports["postprocessing/smaa.glslv"]=
{type:"group",parts:[{type:"define",name:"SMAA_EDGE_DETECTION",tokens:["1"]},{type:"define",name:"SMAA_BLENDING_WEIGHT_CALCULATION",tokens:["2"]},{type:"define",name:"SMAA_NEIGHBORHOOD_BLENDING",tokens:["3"]},{type:"define",name:"AA_METHOD_SMAA_LOW",tokens:["1"]},{type:"define",name:"AA_METHOD_SMAA_MEDIUM",tokens:["2"]},{type:"define",name:"AA_METHOD_SMAA_HIGH",tokens:["3"]},{type:"define",name:"AA_METHOD_SMAA_ULTRA",tokens:["4"]},{type:"textline",tokens:["attribute","vec2","a_position",";","uniform",
"vec2","u_texel_size",";","varying","vec2","b_",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_NEIGHBORHOOD_BLENDING",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","EF",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","EG",";","varying","vec4","EH",";","varying","vec4","EI",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_BLENDING_WEIGHT_CALCULATION",
{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","EJ",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["AA_METHOD","AA_METHOD_SMAA_LOW",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"SMAA_MAX_SEARCH_STEPS",tokens:["4"]}]}},{type:"elif",expression:["AA_METHOD","AA_METHOD_SMAA_MEDIUM",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"SMAA_MAX_SEARCH_STEPS",tokens:["8"]}]}},{type:"elif",
expression:["AA_METHOD","AA_METHOD_SMAA_HIGH",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"SMAA_MAX_SEARCH_STEPS",tokens:["16"]}]}},{type:"elif",expression:["AA_METHOD","AA_METHOD_SMAA_ULTRA",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"SMAA_MAX_SEARCH_STEPS",tokens:["32"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_MAX_SEARCH_STEPS",group:{type:"group",parts:[{type:"define",name:"SMAA_MAX_SEARCH_STEPS",tokens:["16"]}]}}]},
{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_EDGE_DETECTION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["void","EK","(","vec2","Eo",")","{","EG","=","u_texel_size",".","xyxy","*","vec4","(","-","1.0",",","0.0",",","0.0",",","-","1.0",")","+","Eo",".","xyxy",";","EH","=","u_texel_size",".","xyxy","*","vec4","(","1.0",",","0.0",",","0.0",",","1.0",")","+","Eo",".","xyxy",";","EI","=","u_texel_size",".","xyxy","*","vec4","(","-","2.0",",","0.0",
",","0.0",",","-","2.0",")","+","Eo",".","xyxy",";","}"]}]}},{type:"elif",expression:["SMAA_PASS","SMAA_BLENDING_WEIGHT_CALCULATION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["void","EN","(","vec2","EL",",","out","vec2","EM",")","{","EM","=","EL","/","u_texel_size",";","EG","=","u_texel_size",".","xyxy","*","vec4","(","-","0.25",",","-","0.125",",","1.25",",","-","0.125",")","+","EL",".","xyxy",";","EH","=","u_texel_size",".","xyxy","*","vec4","(","-","0.125",
",","-","0.25",",","-","0.125",",","1.25",")","+","EL",".","xyxy",";","EI","=","u_texel_size",".","xxyy","*","vec4","(","-","2.0",",","2.0",",","-","2.0",",","2.0",")","*","float","(","SMAA_MAX_SEARCH_STEPS",")","+","vec4","(","EG",".","xz",",","EH",".","yw",")",";","}"]}]}},{type:"elif",expression:["SMAA_PASS","SMAA_NEIGHBORHOOD_BLENDING",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["void","EP","(","vec2","EO",")","{","EF","=","u_texel_size",".","xyxy","*","vec4",
"(","1.0",",","0.0",",","0.0",",","1.0",")","+","EO",".","xyxy",";","}"]}]}}]},{type:"textline",tokens:["void","main","(",")","{","b_","=","2.0","*","a_position",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_EDGE_DETECTION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["EK","(","b_",")",";"]}]}},{type:"elif",expression:["SMAA_PASS","SMAA_BLENDING_WEIGHT_CALCULATION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["EN","(","b_",",","EJ",")",";"]}]}},{type:"elif",expression:["SMAA_PASS","SMAA_NEIGHBORHOOD_BLENDING",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["EP","(","b_",")",";"]}]}}]},{type:"textline",tokens:["gl_Position","=","vec4","(","4.0","*","(","a_position",".","xy","-","0.25",")",",","0.0",",","1.0",")",";","}"]}]},exports["postprocessing/ssao.glslf"]={type:"group",parts:[{type:"var",name:"PRECISION",tokens:["lowp"]},{type:"textline",tokens:["precision",
"PRECISION","sampler2D",";"]},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"depth_fetch.glslf"},{type:"include",file:"procedural.glslf"},{type:"define",name:"SSAO_QUALITY_8",tokens:["1"]},{type:"define",name:"SSAO_QUALITY_16",tokens:["2"]},{type:"define",name:"SSAO_QUALITY_24",tokens:["3"]},{type:"define",name:"SSAO_QUALITY_32",tokens:["4"]},{type:"textline",tokens:["uniform","sampler2D","u_color",";","uniform","sampler2D","u_depth",";","uniform","sampler2D","u_ssao_special_tex",
";","uniform","vec2","u_camera_range",";","uniform","vec2","u_texel_size",";","varying","vec2","b_",";","uniform","float","u_ssao_radius_increase",";","uniform","float","u_ssao_influence",";","uniform","float","u_ssao_dist_factor",";","float","EK","(","in","vec2","Eo",")","{","return","EA","(","u_depth",",","Eo",",","u_camera_range",")",";","}","void","main","(",")","{","float","EL","=","texture2D","(","u_color",",","b_",")",".","r",";"]},{type:"condition",parts:[{type:"if",expression:["SSAO_WHITE"],
group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","vec4","(","EL",",","1.0",",","0.0",",","1.0",")",";","return",";"]}]}}]},{type:"textline",tokens:["vec3","EM","=","normalize","(","2.0","*","texture2D","(","u_ssao_special_tex",",","b_","*","0.25","/","u_texel_size",")",".","rgb","-","1.0",")",";","float","EN","=","EK","(","b_",")",";","float","EO","=","EN","*","(","u_camera_range",".","y","-","u_camera_range",".","x",")",";"]},{type:"condition",parts:[{type:"if",expression:["SSAO_QUALITY",
"SSAO_QUALITY_8",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["const","float","EP","=","8.0",";","const","int","EQ","=","1",";"]}]}},{type:"elif",expression:["SSAO_QUALITY","SSAO_QUALITY_16",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["const","float","EP","=","16.0",";","const","int","EQ","=","2",";"]}]}},{type:"elif",expression:["SSAO_QUALITY","SSAO_QUALITY_24",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["const","float","EP","=","24.0",";","const","int","EQ","=","3",";"]}]}},{type:"elif",expression:["SSAO_QUALITY","SSAO_QUALITY_32",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["const","float","EP","=","32.0",";","const","int","EQ","=","4",";"]}]}}]},{type:"textline",tokens:["float","ER","=","u_ssao_radius_increase","*","0.001",";","const","float","ES","=","1.0","+","2.4","/","EP",";","float","ET","=","0.0",";","for","(","int","EU","=","0",";","EU","<","EQ",
";","EU","++",")","for","(","int","EV","=","-","1",";","EV","<=","1",";","EV","+=","2",")","for","(","int","EW","=","-","1",";","EW","<=","1",";","EW","+=","2",")","for","(","int","EX","=","-","1",";","EX","<=","1",";","EX","+=","2",")","{","vec3","EY","=","reflect","(","normalize","(","vec3","(","EV",",","EW",",","EX",")",")",",","EM",")","*","(","ER","*=","ES",")",";","vec3","EZ","=","vec3","(","b_",",","EO",")",";","EZ","+=","vec3","(","EY",".","xy",",","EY",".","z","*","EO","*","2.0",")",";"]},
{type:"condition",parts:[{type:"if",expression:["SSAO_HEMISPHERE"],group:{type:"group",parts:[{type:"textline",tokens:["EZ",".","z","-=","1.4","*","(","EZ",".","z","-","EO",")","*","step","(","EO",",","EZ",".","z",")",";"]}]}}]},{type:"textline",tokens:["float","E_","=","EK","(","EZ",".","xy",")","*","(","u_camera_range",".","y","-","u_camera_range",".","x",")",";","float","Fa","=","clamp","(","(","EO","-","E_",")","/","E_",",","0.0",",","1.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["SSAO_HEMISPHERE"],
group:{type:"group",parts:[{type:"textline",tokens:["ET","+=","mix","(","1.0",",","Fa",",","step","(","E_",",","EZ",".","z",")",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["ET","+=","mix","(","step","(","EZ",".","z",",","E_",")",",","0.5",",","Fa",")",";"]}]}}]},{type:"textline",tokens:["}","ET","=","ET","/","EP",";"]},{type:"condition",parts:[{type:"if",expression:["SSAO_HEMISPHERE"],group:{type:"group",parts:[{type:"textline",tokens:["ET","=","clamp","(","ET","*",
"ET","+","0.6","*","ET",",","0.0",",","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["ET","=","clamp","(","ET","*","ET","+","ET",",","0.0",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["float","Fb","=","u_ssao_influence","*","(","1.0","-","u_ssao_dist_factor","*","EN",")",";","ET","=","mix","(","1.0",",","ET",",","Fb",")",";","gl_FragColor","=","vec4","(","EL",",","ET",",","0.0",",","1.0",")",";","}"]}]},exports["postprocessing/ssao_blur.glslf"]={type:"group",
parts:[{type:"var",name:"PRECISION",tokens:["lowp"]},{type:"textline",tokens:["precision","PRECISION","sampler2D",";"]},{type:"include",file:"precision_statement.glslf"},{type:"condition",parts:[{type:"if",expression:["SSAO_BLUR_DEPTH"],group:{type:"group",parts:[{type:"include",file:"depth_fetch.glslf"}]}}]},{type:"textline",tokens:["uniform","sampler2D","u_ssao_mask",";","uniform","vec2","u_texel_size",";","varying","vec2","b_",";"]},{type:"condition",parts:[{type:"if",expression:["SSAO_BLUR_DEPTH"],
group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_depth",";","uniform","vec2","u_camera_range",";","uniform","float","u_ssao_blur_discard_value",";","float","EK","(","in","vec2","Eo",")","{","return","EA","(","u_depth",",","Eo",",","u_camera_range",")",";","}"]}]}}]},{type:"textline",tokens:["void","main","(",")","{","float","EL","=","0.0",";"]},{type:"condition",parts:[{type:"if",expression:["SSAO_BLUR_DEPTH"],group:{type:"group",parts:[{type:"textline",tokens:["float",
"EM","=","EK","(","b_",")",";","float","EN","=","0.0",";","float","EO","=","u_ssao_blur_discard_value","*","100.0",";"]}]}}]},{type:"textline",tokens:["vec2","EP","=","vec2","(","-","2.0",")",";","for","(","int","EQ","=","0",";","EQ","<","4",";","++","EQ",")","{","for","(","int","ER","=","0",";","ER","<","4",";","++","ER",")","{","vec2","ES","=","(","EP","+","vec2","(","float","(","EQ",")",",","float","(","ER",")",")",")","*","u_texel_size",";","float","ET","=","texture2D","(","u_ssao_mask",",","b_",
"+","ES",")",".","g",";"]},{type:"condition",parts:[{type:"if",expression:["SSAO_BLUR_DEPTH"],group:{type:"group",parts:[{type:"textline",tokens:["float","EU","=","EK","(","b_","+","ES",")",";","float","EV","=","1.0","-","clamp","(","abs","(","EU","-","EM",")","*","EO",",","0.0",",","1.0",")",";","EL","+=","ET","*","EV",";","EN","+=","EV",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["EL","+=","ET",";"]}]}}]},{type:"textline",tokens:["}","}"]},{type:"condition",parts:[{type:"if",
expression:["SSAO_BLUR_DEPTH"],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","vec4","(","texture2D","(","u_ssao_mask",",","b_",")",".","r",",","EL","/","EN",",","0.0",",","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","vec4","(","texture2D","(","u_ssao_mask",",","b_",")",".","r",",","EL","/","16.0",",","0.0",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["}"]}]},exports["postprocessing/velocity.glslf"]={type:"group",
parts:[{type:"include",file:"precision_statement.glslf"},{type:"include",file:"pack.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_depth",";","uniform","mat4","u_view_proj_inverse",";","uniform","mat4","u_view_proj_prev",";","varying","vec2","b_",";","void","main","(",")","{","float","Eo","=","texture2D","(","u_depth",",","b_",")",".","x",";","vec4","EK","=","vec4","(","b_","*","2.0","-","1.0",",","2.0","*","Eo","-","1.0",",","1.0",")",";","vec4","EL","=","u_view_proj_inverse","*","EK",
";","vec4","EM","=","EL","/","EL",".","w",";","vec4","EN","=","u_view_proj_prev","*","EM",";","EN","/=","EN",".","w",";","vec2","EO","=","(","EK",".","xy","-","EN",".","xy",")","/","4.0","+","0.5",";","EO","=","clamp","(","EO",",","0.0",",","1.0",")",";","gl_FragColor","=","h","(","EO",")",";","}"]}]},exports["include/precision_statement.glslf"]={type:"group",parts:[{type:"var",name:"PRECISION",tokens:["lowp"]},{type:"textline",tokens:["precision","PRECISION","float",";"]}]},exports["include/std_enums.glsl"]=
{type:"group",parts:[{type:"define",name:"TEXTURE_COORDS_UV_ORCO",tokens:["1"]},{type:"define",name:"TEXTURE_COORDS_NORMAL",tokens:["2"]},{type:"define",name:"TEXTURE_BLEND_TYPE_MIX",tokens:["1"]},{type:"define",name:"TEXTURE_BLEND_TYPE_MULTIPLY",tokens:["2"]},{type:"define",name:"SHADOW_SRC_NONE",tokens:["1"]},{type:"define",name:"SHADOW_SRC_DEPTH",tokens:["2"]},{type:"define",name:"SHADOW_SRC_MASK",tokens:["3"]},{type:"define",name:"SHADOW_DST_NONE",tokens:["1"]},{type:"define",name:"SHADOW_DST_DEPTH",
tokens:["2"]},{type:"define",name:"SHADOW_DST_MASK",tokens:["3"]},{type:"define",name:"NO_SHADOWS",tokens:["1"]},{type:"define",name:"SHADOW_CASTING",tokens:["2"]},{type:"define",name:"SHADOW_MASK_GENERATION",tokens:["3"]},{type:"define",name:"SHADOW_MAPPING_OPAQUE",tokens:["4"]},{type:"define",name:"SHADOW_MAPPING_BLEND",tokens:["5"]},{type:"define",name:"SPECULAR_PHONG",tokens:["1"]},{type:"define",name:"SPECULAR_COOKTORR",tokens:["2"]},{type:"define",name:"SPECULAR_WARDISO",tokens:["3"]},{type:"define",
name:"SPECULAR_BLINN",tokens:["4"]},{type:"define",name:"SPECULAR_TOON",tokens:["5"]},{type:"define",name:"DIFFUSE_LAMBERT",tokens:["1"]},{type:"define",name:"DIFFUSE_OREN_NAYAR",tokens:["2"]},{type:"define",name:"DIFFUSE_FRESNEL",tokens:["3"]},{type:"define",name:"DIFFUSE_MINNAERT",tokens:["4"]},{type:"define",name:"DIFFUSE_TOON",tokens:["5"]},{type:"define",name:"MAPPING_TYPE_TEXTURE",tokens:["0.0"]},{type:"define",name:"MAPPING_TYPE_POINT",tokens:["1.0"]},{type:"define",name:"MAPPING_TYPE_VECTOR",
tokens:["2.0"]},{type:"define",name:"MAPPING_TYPE_NORMAL",tokens:["3.0"]},{type:"define",name:"MIX",tokens:["0"]},{type:"define",name:"ADD",tokens:["1"]},{type:"define",name:"SUBTRACT",tokens:["2"]},{type:"define",name:"MULTIPLY",tokens:["3"]},{type:"define",name:"SCREEN",tokens:["4"]},{type:"define",name:"OVERLAY",tokens:["5"]},{type:"define",name:"DIFFERENCE",tokens:["6"]},{type:"define",name:"DIVIDE",tokens:["7"]},{type:"define",name:"DARKEN",tokens:["8"]},{type:"define",name:"LIGHTEN",tokens:["9"]},
{type:"define",name:"HUE",tokens:["10"]},{type:"define",name:"SATURATION",tokens:["11"]},{type:"define",name:"VALUE",tokens:["12"]},{type:"define",name:"COLOR",tokens:["13"]},{type:"define",name:"SOFT_LIGHT",tokens:["14"]},{type:"define",name:"LINEAR_LIGHT",tokens:["15"]},{type:"define",name:"REFL_NONE",tokens:["0"]},{type:"define",name:"REFL_MIRRORMAP",tokens:["1"]},{type:"define",name:"REFL_PLANE",tokens:["2"]},{type:"define",name:"REFL_CUBE",tokens:["3"]},{type:"define",name:"INVERSE_QUADRATIC",
tokens:["0"]},{type:"define",name:"LINEAR",tokens:["1"]},{type:"define",name:"QUADRATIC",tokens:["2"]},{type:"define",name:"HEMI",tokens:["1"]},{type:"define",name:"SPOT",tokens:["2"]},{type:"define",name:"POINT",tokens:["3"]},{type:"define",name:"SUN",tokens:["4"]}]},exports["include/pack.glslf"]={type:"group",parts:[{type:"textline",tokens:["float","a","=","255.0",";","float","b","=","0.0",";","float","c","=","1.0",";","vec4","h","(","const","in","float","d",")","{","vec4","e","=","vec4","(","a",
"*","a","*","a",",","a","*","a",",","a",",","c",")",";","vec4","f","=","vec4","(","b",",","c","/","a",",","c","/","a",",","c","/","a",")",";","vec4","g","=","fract","(","d","*","e",")",";","g","-=","g",".","xxyz","*","f",";","return","g",";","}","float","l","(","const","in","vec4","i",")","{","float","j",";","vec4","k","=","vec4","(","c","/","(","a","*","a","*","a",")",",","c","/","(","a","*","a",")",",","c","/","a",",","c",")",";","j","=","dot","(","i",",","k",")",";","return","j",";","}","vec4",
"h","(","const","in","vec2","m",")","{","vec2","n","=","vec2","(","a",",","c",")",";","vec2","o","=","vec2","(","b",",","c","/","a",")",";","vec4","p","=","fract","(","m",".","xxyy","*","n",".","xyxy",")",";","p","-=","p",".","xxzz","*","o",".","xyxy",";","if","(","m",".","r","==","c",")","p",".","rg","=","vec2","(","b",",","c",")",";","if","(","m",".","g","==","c",")","p",".","ba","=","vec2","(","b",",","c",")",";","return","p",";","}","vec2","t","(","const","in","vec4","q",")","{","vec2","r",";",
"vec2","s","=","vec2","(","c","/","a",",","c",")",";","r",".","r","=","dot","(","q",".","rg",",","s",")",";","r",".","g","=","dot","(","q",".","ba",",","s",")",";","return","r",";","}"]}]},exports["include/procedural.glslf"]={type:"group",parts:[{type:"textline",tokens:["float","u","=","0.0",";","float","v","=","1.0",";","vec4","x","(","vec4","w",")","{","return","w","-","floor","(","w","*","(","v","/","289.0",")",")","*","289.0",";","}","vec3","x","(","vec3","y",")","{","return","y","-","floor",
"(","y","*","(","v","/","289.0",")",")","*","289.0",";","}","vec2","x","(","vec2","z",")","{","return","z","-","floor","(","z","*","(","v","/","289.0",")",")","*","289.0",";","}","vec4","B","(","vec4","A",")","{","return","A","-","floor","(","A","*","(","v","/","7.0",")",")","*","7.0",";","}","vec4","D","(","vec4","C",")","{","return","x","(","(","34.0","*","C","+","5.0",")","*","C",")",";","}"]},{type:"define",name:"K",tokens:["0.142857142857"]},{type:"define",name:"K2",tokens:["0.0714285714285"]},
{type:"define",name:"JITTER",tokens:["0.7"]},{type:"textline",tokens:["vec2","Q","(","vec2","E",")","{","vec2","F","=","x","(","floor","(","E",")",")",";","vec2","G","=","fract","(","E",")",";","vec4","H","=","G",".","x","+","vec4","(","-","0.5",",","-","1.5",",","-","0.5",",","-","1.5",")",";","vec4","I","=","G",".","y","+","vec4","(","-","0.5",",","-","0.5",",","-","1.5",",","-","1.5",")",";","vec4","J","=","D","(","F",".","x","+","vec4","(","u",",","v",",","u",",","v",")",")",";","J","=","D","(",
"J","+","F",".","y","+","vec4","(","u",",","u",",","v",",","v",")",")",";","vec4","L","=","B","(","J",")","*","K","+","K2",";","vec4","M","=","B","(","floor","(","J","*","K",")",")","*","K","+","K2",";","vec4","N","=","H","+","JITTER","*","L",";","vec4","O","=","I","+","JITTER","*","M",";","vec4","P","=","N","*","N","+","O","*","O",";"]},{type:"condition",parts:[{type:"if",expression:[1],group:{type:"group",parts:[{type:"textline",tokens:["P",".","xy","=","min","(","P",".","xy",",","P",".","zw",")",
";","P",".","x","=","min","(","P",".","x",",","P",".","y",")",";","return","P",".","xx",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["P",".","xy","=","(","P",".","x","<","P",".","y",")","?","P",".","xy",":","P",".","yx",";","P",".","xz","=","(","P",".","x","<","P",".","z",")","?","P",".","xz",":","P",".","zx",";","P",".","xw","=","(","P",".","x","<","P",".","w",")","?","P",".","xw",":","P",".","wx",";","P",".","y","=","min","(","P",".","y",",","P",".","z",")",";","P",
".","y","=","min","(","P",".","y",",","P",".","w",")",";","return","sqrt","(","P",".","xy",")",";"]}]}}]},{type:"textline",tokens:["}","vec3","ae","(","vec2","R",",","float","S",")","{","vec2","T","=","x","(","floor","(","R",")",")",";","vec2","U","=","fract","(","R",")",";","vec4","V","=","U",".","x","+","vec4","(","-","0.5",",","-","1.5",",","-","0.5",",","-","1.5",")",";","vec4","W","=","U",".","y","+","vec4","(","-","0.5",",","-","0.5",",","-","1.5",",","-","1.5",")",";","vec4","X","=","D","(",
"T",".","x","+","vec4","(","u",",","v",",","u",",","v",")",")",";","X","=","D","(","X","+","T",".","y","+","vec4","(","u",",","u",",","v",",","v",")",")",";","vec4","Y","=","B","(","X",")","*","K","+","K2",";","vec4","Z","=","B","(","floor","(","X","*","K",")",")","*","K","+","K2",";","vec4","_","=","V","+","JITTER","*","Y",";","vec4","aa","=","W","+","JITTER","*","Z",";","vec4","ab","=","_","*","_","+","aa","*","aa",";","_","+=","S",";","aa","+=","S",";","vec4","ac","=","_","*","_","+","aa","*",
"aa",";","_","+=","S",";","aa","+=","S",";","vec4","ad","=","_","*","_","+","aa","*","aa",";","ab",".","xy","=","min","(","ab",".","xy",",","ab",".","zw",")",";","ab",".","x","=","min","(","ab",".","x",",","ab",".","y",")",";","ac",".","xy","=","min","(","ac",".","xy",",","ac",".","zw",")",";","ac",".","x","=","min","(","ac",".","x",",","ac",".","y",")",";","ad",".","xy","=","min","(","ad",".","xy",",","ad",".","zw",")",";","ad",".","x","=","min","(","ad",".","x",",","ad",".","y",")",";","return",
"vec3","(","ab",".","x",",","ac",".","x",",","ad",".","x",")",";","}","vec3","ag","(","vec3","af",")","{","return","x","(","(","(","af","*","34.0",")","+","v",")","*","af",")",";","}","float","au","(","vec2","ah",")","{","const","vec4","ai","=","vec4","(","0.211324865405187",",","0.366025403784439",",","-","0.577350269189626",",","0.024390243902439",")",";","vec2","aj","=","floor","(","ah","+","dot","(","ah",",","ai",".","yy",")",")",";","vec2","ak","=","ah","-","aj","+","dot","(","aj",",","ai",".",
"xx",")",";","vec2","al",";","al","=","(","ak",".","x",">","ak",".","y",")","?","vec2","(","v",",","u",")",":","vec2","(","u",",","v",")",";","vec4","am","=","ak",".","xyxy","+","ai",".","xxzz",";","am",".","xy","-=","al",";","aj","=","x","(","aj",")",";","vec3","an","=","ag","(","ag","(","aj",".","y","+","vec3","(","u",",","al",".","y",",","v",")",")","+","aj",".","x","+","vec3","(","u",",","al",".","x",",","v",")",")",";","vec3","ao","=","max","(","0.5","-","vec3","(","dot","(","ak",",","ak",")",
",","dot","(","am",".","xy",",","am",".","xy",")",",","dot","(","am",".","zw",",","am",".","zw",")",")",",","u",")",";","ao","=","ao","*","ao",";","ao","=","ao","*","ao",";","vec3","ap","=","2.0","*","fract","(","an","*","ai",".","www",")","-","v",";","vec3","aq","=","abs","(","ap",")","-","0.5",";","vec3","ar","=","floor","(","ap","+","0.5",")",";","vec3","as","=","ap","-","ar",";","ao","*=","1.79284291400159","-","0.85373472095314","*","(","as","*","as","+","aq","*","aq",")",";","vec3","at",";",
"at",".","x","=","as",".","x","*","ak",".","x","+","aq",".","x","*","ak",".","y",";","at",".","yz","=","as",".","yz","*","am",".","xz","+","aq",".","yz","*","am",".","yw",";","return","130.0","*","dot","(","ao",",","at",")",";","}","vec2","aA","(","vec2","av",")","{","float","aw","=","dot","(","av",",","vec2","(","12.9898",",","78.233",")",")",";","float","ax","=","dot","(","av",",","vec2","(","12.9898",",","78.233",")","*","2.0",")",";","float","ay","=","fract","(","sin","(","aw",")","*","43758.5453",
")","*","2.0","-","v",";","float","az","=","fract","(","sin","(","ax",")","*","43758.5453",")","*","2.0","-","v",";","return","vec2","(","ay",",","az",")",";","}"]}]},exports["include/caustics.glslf"]={type:"group",parts:[{type:"var",name:"CAUST_SPEED",tokens:["vec2","(","0.0",")"]},{type:"var",name:"CAUST_SCALE",tokens:["0.0"]},{type:"var",name:"CAUST_BRIGHT",tokens:["0.0"]},{type:"define",name:"CAUSTICS_VIEW_DISTANCE",tokens:["100.0"]},{type:"textline",tokens:["void","aY","(","inout","vec3","aB",
",","float","aC",",","float","aD",",","float","aE",",","vec3","aF",",","vec3","aG",",","vec3","aH",",","vec4","aI",",","vec3","aJ",",","float","aK",")","{","if","(","aK",">","CAUSTICS_VIEW_DISTANCE",")","return",";","vec4","aL","=","aI",";","vec3","aM","=","aJ","+","aF",";","aM",".","xz","=","10.0","*","sin","(","0.1","*","aM",".","xz",")",";","vec3","aN","=","aM","+","2.0","*","cross","(","-","aL",".","xyz",",","cross","(","-","aL",".","xyz",",","aM",")","+","aL",".","w","*","aM",")",";","vec2",
"aO","=","aN",".","xz",";","vec3","aP","=","aG",";","float","aQ","=","max","(","dot","(","aF",",","aP",")",",","0.0",")",";","float","aR","=","0.025",";","vec2","aS","=","CAUST_SPEED","*","aD",";","aO",".","s","+=","0.25","*","sin","(","dot","(","aJ","+","aD",",","vec3","(","1.0",")",")",")",";","aO",".","t","+=","0.35","*","(","-","sin","(","dot","(","aJ","-","aD",",","vec3","(","-","0.7",")",")",")",")",";","aO",".","st","+=","0.15","*","cos","(","4.0","*","aC","-","aS",".","x",")","+","1.5","*",
"sin","(","aC","-","0.3","*","aS",".","y",")",";","float","aT","=","CAUST_SCALE","*","(","1.0","+","max","(","0.1","*","aC",",","0.0",")",")",";","vec3","aU","=","ae","(","(","aO","/","aT",")",",","aR",")",";","aU","*=","CAUST_BRIGHT",";","aU","*=","aU",";","float","aV","=","min","(","0.25","*","aC",",","-","aC",")","+","1.0",";","aV","=","max","(","aV",",","0.0",")",";","float","aW","=","aE","*","aQ",";","float","aX","=","max","(","sign","(","aC",")",",","0.0",")",";","aW","=","aW","+","max","(",
"0.5","*","sign","(","-","aF",".","y",")","*","aX",",","0.0",")",";","aW","=","min","(","aW",",","1.0",")",";","aB","+=","aH","*","aU","*","aV","*","aW",";","}"]}]},exports["include/gamma.glslf"]={type:"group",parts:[{type:"define",name:"GAMMA",tokens:["1"]},{type:"define",name:"PREMULTIPLY_ALPHA",tokens:["1"]},{type:"textline",tokens:["void","a_","(","inout","vec3","aZ",")","{"]},{type:"condition",parts:[{type:"if",expression:["GAMMA"],group:{type:"group",parts:[{type:"textline",tokens:["aZ","=",
"max","(","vec3","(","0.0",")",",","aZ",")",";","aZ","=","pow","(","aZ",",","vec3","(","2.2",")",")",";"]}]}}]},{type:"textline",tokens:["}","void","bb","(","inout","vec3","ba",")","{"]},{type:"condition",parts:[{type:"if",expression:["GAMMA"],group:{type:"group",parts:[{type:"textline",tokens:["ba","=","max","(","vec3","(","0.0",")",",","ba",")",";","ba","=","pow","(","ba",",","vec3","(","1.0","/","2.2",")",")",";"]}]}}]},{type:"textline",tokens:["}","void","be","(","inout","vec3","bc",",","in",
"float","bd",")","{"]},{type:"condition",parts:[{type:"if",expression:["PREMULTIPLY_ALPHA"],group:{type:"group",parts:[{type:"textline",tokens:["bc","=","bc","*","bd",";"]}]}}]},{type:"textline",tokens:["}"]}]},exports["include/math.glslv"]={type:"group",parts:[{type:"var",name:"EPSILON",tokens:["0.0001"]},{type:"textline",tokens:["float","bf","=","0.0",";","float","bg","=","1.0",";","struct","bh","{","vec3","a",";","vec3","b",";","vec3","c",";","vec3","d",";","vec3","e",";","vec3","f",";","}",";",
"bool","bk","(","vec3","bi",",","vec3","bj",")","{","return","any","(","lessThan","(","abs","(","bi","-","bj",")",",","vec3","(","EPSILON",")",")",")",";","}","vec3","bn","(","in","vec4","bl",",","in","vec3","bm",")","{","return","bm","+","2.0","*","cross","(","bl",".","xyz",",","cross","(","bl",".","xyz",",","bm",")","+","bl",".","w","*","bm",")",";","}","vec4","bp","(","in","vec4","bo",")","{","return","vec4","(","-","bo",".","xyz",",","bo",".","w",")","/","dot","(","bo",",","bo",")",";","}","vec3",
"bu","(","vec4","bq",",","vec4","br",",","vec4","bs",")","{","vec3","bt","=","bs",".","xyz","*","bq",".","w",";","bt","=","bn","(","br",",","bt",")",";","bt","+=","bq",".","xyz","*","bs",".","w",";","return","bt",";","}","vec3","bA","(","vec4","bv",",","vec4","bw",",","vec4","bx",")","{","vec3","by","=","bx",".","xyz","-","bv",".","xyz","*","bx",".","w",";","vec4","bz","=","bp","(","bw",")",";","by","=","bn","(","bz",",","by",")",";","by","/=","bv",".","w",";","return","by",";","}","mat4","bB","(",
")","{","return","mat4","(","bg",",","bf",",","bf",",","bf",",","bf",",","bg",",","bf",",","bf",",","bf",",","bf",",","bg",",","bf",",","bf",",","bf",",","bf",",","bg",")",";","}","mat4","bD","(","float","bC",")","{","return","mat4","(","bg",",","bf",",","bf",",","bf",",","bf",",","cos","(","bC",")",",","sin","(","bC",")",",","bf",",","bf",",","-","sin","(","bC",")",",","cos","(","bC",")",",","bf",",","bf",",","bf",",","bf",",","bg",")",";","}","mat4","bF","(","float","bE",")","{","return","mat4",
"(","cos","(","bE",")",",","bf",",","-","sin","(","bE",")",",","bf",",","bf",",","bg",",","bf",",","bf",",","sin","(","bE",")",",","bf",",","cos","(","bE",")",",","bf",",","bf",",","bf",",","bf",",","bg",")",";","}","mat4","bH","(","float","bG",")","{","return","mat4","(","cos","(","bG",")",",","sin","(","bG",")",",","bf",",","bf",",","-","sin","(","bG",")",",","cos","(","bG",")",",","bf",",","bf",",","bf",",","bf",",","bg",",","bf",",","bf",",","bf",",","bf",",","bg",")",";","}","bh","bJ","(","in",
"bh","bI",")","{","return","bh","(","bI",".","a",",","bI",".","b",",","normalize","(","bI",".","c",")",",","normalize","(","bI",".","d",")",",","normalize","(","bI",".","e",")",",","bI",".","f",")",";","}"]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"SHADOW_USAGE","SHADOW_MAPPING_OPAQUE",{type:"equal_expr",places:2},"REFRACTIVE","USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",
tokens:["vec3","bP","(","vec4","bK",")","{","float","bL","=","bK",".","x",";","float","bM","=","bK",".","y",";","float","bN","=","bK",".","w",";","vec3","bO",";","bO",".","x","=","(","bL","+","bN",")","/","2.0",";","bO",".","y","=","(","bM","+","bN",")","/","2.0",";","bO",".","z","=","bN",";","return","bO",";","}"]}]}}]}]},exports["include/shadow.glslf"]={type:"group",parts:[{type:"var",name:"PRECISION",tokens:["lowp"]},{type:"var",name:"CSM_BLEND_BETWEEN_CASCADES",tokens:["1.0"]},{type:"var",name:"CSM_FADE_LAST_CASCADE",
tokens:["1.0"]},{type:"var",name:"SHADOW_TEX_RES",tokens:["0.0"]},{type:"define",name:"M_PI",tokens:["3.14159265359"]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MAPPING_OPAQUE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec4","ca",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2},"SHADOW_USAGE","SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2},{type:"logical_or_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["const","float","cb","=","0.1",";","const","float","cc","=","0.1",";","const","float","cd","=","-","0.01",";","const","float","ce","=","0.05",";","vec4","cf","=","vec4","(","0.14383161",",","0.34495938",",","-","0.38277543",",","-","0.26496911",")",";","vec4","cg","=","vec4","(","0.53742981",",","0.19984126",",","0.79197514",",","-","0.094184101",")",";","vec4","ch","=","vec4","(","-","0.94201624",",","-","0.91588581",",","-","0.2418884",
",","0.44323325",")",";","vec4","ci","=","vec4","(","-","0.81544232",",","0.94558609",",","-","0.81409955",",","0.97484398",")",";","vec4","cj","=","vec4","(","-","0.1410079",",","0.2938776",",","0.27676845",",","-","0.41893023",")",";","vec4","ck","=","vec4","(","-","0.4737342",",","0.78641367",",","0.19090188",",","-","0.9293887",")",";","vec4","cl","=","vec4","(","-","0.39906216",",","0.45771432",",","0.99706507",",","-","0.97511554",")",";","vec4","cm","=","vec4","(","-","0.87912464",",","-",
"0.76890725",",","0.9143759",",","0.7564837",")",";","bool","cp","(","vec2","cn",",","float","co",")","{","return","all","(","lessThanEqual","(","cn",",","vec2","(","1.0","+","co",")",")",")","&&","all","(","greaterThanEqual","(","cn",",","vec2","(","0.0","-","co",")",")",")",";","}","float","cy","(","float","cq",",","float","cr",",","mat2","cs",",","vec3","ct",",","float","cu",",","PRECISION","sampler2D","cv",")","{","vec2","cw",",","cx",";","cx",".","x","=","cq",";","cx",".","y","=","cr",";","cx",
"=","cs","*","cx",";","cw","=","ct",".","xy","+","cx","*","cu","/","SHADOW_TEX_RES",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["if","(","!","cp","(","cw",",","cd",")",")","return","1.0",";","else"]}]}}]},{type:"textline",tokens:["return","step","(","ct",".","z",",","texture2D","(","cv",",","cw",")",".","r",")",";","}","void","cM","(","inout","float","cz",",","inout","float","cA",",",
"float","cB",",","float","cC",",","mat2","cD",",","vec3","cE",",","vec3","cF",",","float","cG",",","float","cH",",","PRECISION","sampler2D","cI",",","PRECISION","sampler2D","cJ",")","{","vec2","cK",",","cL",";","cL",".","x","=","cB",";","cL",".","y","=","cC",";","cL","=","cD","*","cL",";","cK","=","cE",".","xy","+","cL","*","cG","/","SHADOW_TEX_RES",";","cz","+=","step","(","cE",".","z",",","texture2D","(","cI",",","cK",")",".","r",")",";","cK","=","cF",".","xy","+","cL","*","cH","/","SHADOW_TEX_RES",
";","cA","+=","step","(","cF",".","z",",","texture2D","(","cJ",",","cK",")",".","r",")",";","}","float","cW","(","vec3","cN",",","PRECISION","sampler2D","cO",",","float","cP",")","{"]},{type:"condition",parts:[{type:"if",expression:["PERSPECTIVE_SHADOW_CAST"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","cN",".","z",">","u_perspective_cast_far_bound",")","return","1.0",";","else","{"]}]}}]},{type:"textline",tokens:["cN",".","z","=","clamp","(","cN",".","z",",","0.0",",","1.0",")",
";","float","cQ","=","0.0",";","float","cR","=","aA","(","cN",".","xy",")",".","x","*","M_PI",";","float","cS","=","cos","(","cR",")",";","float","cT","=","sin","(","cR",")",";","mat2","cU","=","mat2","(","cS",",","cT",",","-","cT",",","cS",")",";","for","(","int","cV","=","0",";","cV","<","4",";","cV","++",")","{","cQ","+=","cy","(","cf","[","cV","]",",","cj","[","cV","]",",","cU",",","cN",",","cP",",","cO",")",";","cQ","+=","cy","(","cg","[","cV","]",",","ck","[","cV","]",",","cU",",","cN",",",
"cP",",","cO",")",";","cQ","+=","cy","(","ch","[","cV","]",",","cl","[","cV","]",",","cU",",","cN",",","cP",",","cO",")",";","cQ","+=","cy","(","ci","[","cV","]",",","cm","[","cV","]",",","cU",",","cN",",","cP",",","cO",")",";","}","cQ","/=","16.0",";","return","clamp","(","cQ",",","0.0",",","1.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["PERSPECTIVE_SHADOW_CAST"],group:{type:"group",parts:[{type:"textline",tokens:["}"]}]}}]},{type:"textline",tokens:["return","1.0",";","}","float",
"dk","(","vec3","cX",",","PRECISION","sampler2D","cY",",","vec3","cZ",",","PRECISION","sampler2D","c_",",","float","da",",","float","db",",","float","dc",")","{","float","dd",",","de",";","cX",".","z","=","clamp","(","cX",".","z",",","0.0",",","1.0",")",";","cZ",".","z","=","clamp","(","cZ",".","z",",","0.0",",","1.0",")",";","dd","=","0.0",";","de","=","0.0",";","float","df","=","aA","(","cX",".","xy",")",".","x","*","M_PI",";","float","dg","=","cos","(","df",")",";","float","dh","=","sin","(","df",
")",";","mat2","di","=","mat2","(","dg",",","dh",",","-","dh",",","dg",")",";","for","(","int","dj","=","0",";","dj","<","4",";","dj","++",")","{","cM","(","dd",",","de",",","cf","[","dj","]",",","cj","[","dj","]",",","di",",","cX",",","cZ",",","da",",","db",",","cY",",","c_",")",";","cM","(","dd",",","de",",","cg","[","dj","]",",","ck","[","dj","]",",","di",",","cX",",","cZ",",","da",",","db",",","cY",",","c_",")",";","cM","(","dd",",","de",",","ch","[","dj","]",",","cl","[","dj","]",",","di",",",
"cX",",","cZ",",","da",",","db",",","cY",",","c_",")",";","cM","(","dd",",","de",",","ci","[","dj","]",",","cm","[","dj","]",",","di",",","cX",",","cZ",",","da",",","db",",","cY",",","c_",")",";","}","dd","=","mix","(","dd",",","de",",","dc",")",";","dd","/=","16.0",";","return","clamp","(","dd",",","0.0",",","1.0",")",";","}","float","dp","(","vec2","dl",")","{","float","dm","=","min","(","dl",".","x",",","dl",".","y",")",";","float","dn","=","min","(","1.0","-","dl",".","x",",","1.0","-","dl",".",
"y",")",";","return","min","(","dm",",","dn",")",";","}","float","ds","(","float","dq",",","float","dr",")","{","if","(","dr",">=","0.0","&&","dr","<=","cc",")","dq","=","(","dq","-","1.0",")","/","cc","*","dr","+","1.0",";","return","dq",";","}","float","dE","(","vec3","dt",",","vec3","du",",","PRECISION","sampler2D","dv",",","PRECISION","sampler2D","dw",",","float","dx",",","float","dy",",","float","dz",",","float","dA",")","{","float","dB",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_BLEND_BETWEEN_CASCADES"],
group:{type:"group",parts:[{type:"textline",tokens:["float","dC","=","dp","(","dt",".","xy",")",";","if","(","-","dA",">","dz","&&","dC",">=","0.0","&&","dC","<=","cb","&&","cp","(","du",".","xy",",","0.0",")",")","{","float","dD","=","1.0","-","dC","/","cb",";","dB","=","dk","(","dt",",","dv",",","du",",","dw",",","dx",",","dy",",","dD",")",";","}","else"]}]}}]},{type:"textline",tokens:["dB","=","cW","(","dt",",","dv",",","dx",")",";","return","dB",";","}","float","dM","(","vec3","dF",",","PRECISION",
"sampler2D","dG",",","float","dH",",","float","dI",",","float","dJ",")","{","float","dK","=","cW","(","dF",",","dG",",","dH",")",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_FADE_LAST_CASCADE"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","-","dJ",">","dI",")","{","float","dL","=","dp","(","dF",".","xy",")",";","dK","=","ds","(","dK",",","dL",")",";","}"]}]}}]},{type:"textline",tokens:["return","dK",";","}","float","dT","(","float","dN",")","{","float","dO","=","1.0",
";","vec3","dP","=","bW",".","xyz","/","bW",".","w",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","dQ","=","bX",".","xyz","/","bX",".","w",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","dR","=","bY",".","xyz","/","bY",".","w",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",
tokens:["vec3","dS","=","bZ",".","xyz","/","bZ",".","w",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","cp","(","dP",".","xy",",","0.0",")",")","{","dO","=","dE","(","dP",",","dQ",",","u_shadow_map0",",","u_shadow_map1",",","u_pcf_blur_radii","[","0","]",",","u_pcf_blur_radii","[","1","]",",","u_csm_center_dists","[","0","]",",","dN",")",";","}"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["if",
"(","cp","(","dP",".","xy",",","ce",")",")","{","dO","=","dM","(","dP",",","u_shadow_map0",",","u_pcf_blur_radii","[","0","]",",","u_csm_center_dists","[","0","]",",","dN",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["else","{","if","(","cp","(","dQ",".","xy",",","0.0",")",")","{"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["dO","=","dE",
"(","dQ",",","dR",",","u_shadow_map1",",","u_shadow_map2",",","u_pcf_blur_radii","[","1","]",",","u_pcf_blur_radii","[","2","]",",","u_csm_center_dists","[","1","]",",","dN",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["dO","=","dM","(","dQ",",","u_shadow_map1",",","u_pcf_blur_radii","[","1","]",",","u_csm_center_dists","[","1","]",",","dN",")",";"]}]}}]},{type:"textline",tokens:["}"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",
parts:[{type:"textline",tokens:["else","{","if","(","cp","(","dR",".","xy",",","0.0",")",")","{"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",tokens:["dO","=","dE","(","dR",",","dS",",","u_shadow_map2",",","u_shadow_map3",",","u_pcf_blur_radii","[","2","]",",","u_pcf_blur_radii","[","3","]",",","u_csm_center_dists","[","2","]",",","dN",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["dO","=","dM","(","dR",
",","u_shadow_map2",",","u_pcf_blur_radii","[","2","]",",","u_csm_center_dists","[","2","]",",","dN",")",";"]}]}}]},{type:"textline",tokens:["}"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",tokens:["else","{","if","(","cp","(","dS",".","xy",",","0.0",")",")","dO","=","dM","(","dS",",","u_shadow_map3",",","u_pcf_blur_radii","[","3","]",",","u_csm_center_dists","[","3","]",",","dN",")",";","}"]}]}}]},{type:"textline",tokens:["}"]}]}}]},
{type:"textline",tokens:["}"]}]}}]},{type:"textline",tokens:["return","dO",";","}"]}]}}]},{type:"textline",tokens:["float","dY","(","inout","vec3","dU",")","{"]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MAPPING_OPAQUE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec2","dV","=","texture2DProj","(","u_shadow_mask",",","bU",")",".","rg",";","vec3","dW","=","vec3","(","dV",".","r",")",";","float","dX","=","dV",".","g",";","ca","=","vec4",
"(","dW",",","dX",")",";","dU","*=","ca",".","a",";","return","ca",".","r",";"]}]}},{type:"elif",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2},"SHADOW_USAGE","SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","dT","(","bR",".","z",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["return","1.0",";"]}]}}]},{type:"textline",tokens:["}"]}]},exports["include/mirror.glslf"]=
{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"REFLECTION_TYPE","REFL_CUBE",{type:"equal_expr",places:2},"REFLECTION_TYPE","REFL_MIRRORMAP",{type:"equal_expr",places:2},{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"define",name:"REFL_BUMP",tokens:["0.1"]},{type:"textline",tokens:["float","ef","(","in","vec3","dZ",",","vec3","d_",",","float","ea",",","float","eb",")","{","vec3","ec","=","normalize",
"(","d_","+","dZ",")",";","float","ed","=","1.0","-","dot","(","dZ",",","ec",")",";","float","ee","=","eb","+","(","1.0","-","eb",")","*","pow","(","ed",",","ea",")",";","return","ee",";","}","void","et","(","inout","vec3","eg",",","vec3","eh",",","vec3","ei",",","float","ej",")","{","vec3","ek","=","reflect","(","-","eh",",","ei",")",";","float","el","=","u_fresnel_params","[","2","]",";","float","em","=","u_fresnel_params","[","3","]",";","float","en","=","1.0",";","if","(","el","!=","0.0",")",
"en","=","ef","(","eh",",","ek",",","el",",","em",")",";"]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_CUBE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","eo","=","textureCube","(","u_cube_reflection",",","ek",")",".","xyz",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","ep","=","u_refl_plane",".","xyz","*","dot","(","ei",
",","u_refl_plane",".","xyz",")",";","vec3","eq","=","ei","-","ep",";","vec2","er","=","(","u_view_matrix_frag","*","vec4","(","eq",",","0.0",")",")",".","xy",";","vec2","es","=","bU",".","xy","/","bU",".","z",";","es","+=","er","*","REFL_BUMP",";","vec3","eo","=","texture2D","(","u_plane_reflection",",","es",")",".","rgb",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_MIRRORMAP",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","eo","=","textureCube",
"(","u_mirrormap",",","ek",")",".","xyz",";","ej","=","u_mirror_factor",";"]}]}}]},{type:"textline",tokens:["a_","(","eo",".","rgb",")",";","eg","=","mix","(","eg",",","eo",",","ej","*","en",")",";","}"]}]}}]}]},exports["include/environment.glslf"]={type:"group",parts:[{type:"textline",tokens:["vec3","ew","(","vec3","eu",")","{"]},{type:"condition",parts:[{type:"if",expression:["USE_ENVIRONMENT_LIGHT"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["SKY_TEXTURE"],group:{type:"group",
parts:[{type:"textline",tokens:["return","textureCube","(","u_sky_texture",",","eu",")",".","rgb",";"]}]}},{type:"elif",expression:["SKY_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["float","ev","=","0.5","*","eu",".","y","+","0.5",";","return","mix","(","u_horizon_color",",","u_zenith_color",",","ev",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["return","vec3","(","1.0",")",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["return",
"vec3","(","0.0",")",";"]}]}}]},{type:"textline",tokens:["}"]}]},exports["include/refraction.glslf"]={type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["USE_REFRACTION_CORRECTION"],group:{type:"group",parts:[{type:"textline",tokens:["float","eC","(","in","float","ex",",","inout","vec2","ey",",","in","vec2","ez",")","{","vec4","eA","=","texture2D","(","u_scene_depth",",","ey",")",";","float",
"eB","=","l","(","eA",")",";","if","(","eB","<","bV",")","{","ey","=","ez",";","return","ex",";","}","else","{","return","eB",";","}","return","ex",";","}"]}]}}]},{type:"textline",tokens:["vec3","eK","(","in","vec3","eD",",","in","vec2","eE",")","{","vec2","eF","=","eD",".","xy","/","eD",".","z",";","vec2","eG","=","eF","+","eE",";"]},{type:"condition",parts:[{type:"if",expression:["USE_REFRACTION_CORRECTION"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","eH","=","texture2DProj","(",
"u_scene_depth",",","eD",")",";","float","eI","=","l","(","eH",")",";","eC","(","eI",",","eG",",","eF",")",";"]}]}}]},{type:"textline",tokens:["vec3","eJ","=","texture2D","(","u_refractmap",",","eG",")",".","rgb",";","a_","(","eJ",")",";","return","eJ",";","}"]}]}}]}]},exports["include/nodes.glslf"]={type:"group",parts:[{type:"var",name:"MAPPING_TRS_MATRIX",tokens:["mat4","(","0.0",")"]},{type:"var",name:"MAPPING_SCALE",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_TRANSLATION",tokens:["vec3",
"(","0.0",")"]},{type:"var",name:"MAPPING_MIN_CLIP",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_MAX_CLIP",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_IS_NORMAL",tokens:["0.0"]},{type:"var",name:"RGB_IND",tokens:["0"]},{type:"var",name:"VALUE_IND",tokens:["0"]},{type:"var",name:"LAMP_INDEX",tokens:["0"]},{type:"var",name:"NUM_LIGHTS",tokens:["0"]},{type:"var",name:"LAMP_IND",tokens:["0"]},{type:"var",name:"LAMP_SPOT_SIZE",tokens:["0"]},{type:"var",name:"LAMP_SPOT_BLEND",tokens:["0"]},
{type:"var",name:"LAMP_LIGHT_DIST",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_FACT_IND",tokens:["0"]},{type:"var",name:"LAMP_FAC_CHANNELS",tokens:["rgb"]},{type:"var",name:"LAMP_SHADOW_MAP_IND",tokens:["0"]},{type:"define",name:"M_PI",tokens:["3.14159265359"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_GEOMETRY_OR","USE_NODE_TEX_COORD_GE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","eL",";"]}]}}]},{type:"textline",tokens:["float",
"ZERO_VALUE_NODES","=","0.0",";","float","UNITY_VALUE_NODES","=","1.0",";","float","eM","=","0.5",";","vec3","eN","=","vec3","(","ZERO_VALUE_NODES",")",";","vec3","eO","=","vec3","(","UNITY_VALUE_NODES",")",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","eS","(","in","vec3","eP",",","in","float","eQ",")","{","vec3","eR","=","eN",";"]},{type:"condition",parts:[{type:"if",expression:["USE_REFRACTION"],group:{type:"group",
parts:[{type:"textline",tokens:["eR","=","eK","(","bU",",","eP",".","xz","*","eQ",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["eR","=","texture2D","(","u_refractmap",",","bU",".","xy","/","bU",".","z",")",".","rgb",";","a_","(","eR",")",";"]}]}}]},{type:"textline",tokens:["return","eR",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_HUE_SAT","USE_NODE_MIX_RGB_HUE","USE_NODE_MIX_RGB_SATURATION","USE_NODE_MIX_RGB_VALUE","USE_NODE_MIX_RGB_COLOR",
"USE_NODE_SEPHSV",{type:"logical_or_expr",places:6}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","eZ","(","vec3","eT",")","{","vec4","eU","=","vec4","(","ZERO_VALUE_NODES",",","-","UNITY_VALUE_NODES","/","3.0",",","2.0","/","3.0",",","-","UNITY_VALUE_NODES",")",";","vec4","eV","=","mix","(","vec4","(","eT",".","bg",",","eU",".","wz",")",",","vec4","(","eT",".","gb",",","eU",".","xy",")",",","step","(","eT",".","b",",","eT",".","g",")",")",";","vec4","eW","=","mix","(","vec4","(","eV",
".","xyw",",","eT",".","r",")",",","vec4","(","eT",".","r",",","eV",".","yzx",")",",","step","(","eV",".","x",",","eT",".","r",")",")",";","float","eX","=","eW",".","x","-","min","(","eW",".","w",",","eW",".","y",")",";","float","eY","=","1.0e-10",";","return","vec3","(","abs","(","eW",".","z","+","(","eW",".","w","-","eW",".","y",")","/","(","6.0","*","eX","+","eY",")",")",",","eX","/","(","eW",".","x","+","eY",")",",","eW",".","x",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_HUE_SAT",
"USE_NODE_MIX_RGB_HUE","USE_NODE_MIX_RGB_SATURATION","USE_NODE_MIX_RGB_VALUE","USE_NODE_MIX_RGB_COLOR","USE_NODE_COMBHSV",{type:"logical_or_expr",places:6}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","fc","(","vec3","e_",")","{","vec4","fa","=","vec4","(","UNITY_VALUE_NODES",",","2.0","/","3.0",",","UNITY_VALUE_NODES","/","3.0",",","3.0",")",";","vec3","fb","=","abs","(","fract","(","vec3","(","e_",".","r",",","e_",".","r",",","e_",".","r",")","+","fa",".","xyz",")","*","6.0","-",
"fa",".","www",")",";","return","e_",".","b","*","mix","(","fa",".","xxx",",","clamp","(","fb","-","fa",".","xxx",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",",","e_",".","g",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_GEOMETRY_UV","USE_NODE_B4W_PARALLAX","USE_NODE_UV_MERGED",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","fe","(","vec2","fd",")","{","return","vec3","(","fd","*","2.0","-","vec2","(","UNITY_VALUE_NODES",
",","UNITY_VALUE_NODES",")",",","ZERO_VALUE_NODES",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_TEXTURE_COLOR","USE_NODE_TEXTURE_NORMAL","USE_NODE_B4W_PARALLAX",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["vec2","fg","(","vec3","ff",")","{","return","vec2","(","ff",".","xy","*","0.5","+","vec2","(","0.5",",","0.5",")",")",";","}"]}]}}]},{type:"node",name:"CAMERA",declarations:[{type:"node_out",name:"fL",qualifier:["vec3"],
is_optional:true},{type:"node_out",name:"fM",qualifier:["float"],is_optional:true},{type:"node_out",name:"fN",qualifier:["float"],is_optional:true}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_fL"],statements:[{type:"textline",tokens:["fL","=","normalize","(","fI",".","xyz",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_fM"],statements:[{type:"textline",tokens:["fM","=","abs","(","fI",".","z",")",";"]}]}]},{type:"node_condition",
parts:[{type:"node_if",expression:["USE_OUT_fN"],statements:[{type:"textline",tokens:["fN","=","length","(","fI",".","xyz",")",";"]}]}]}]},{type:"node",name:"COMBRGB",declarations:[{type:"node_in",name:"fO",qualifier:["float"],is_optional:false},{type:"node_in",name:"fP",qualifier:["float"],is_optional:false},{type:"node_in",name:"fQ",qualifier:["float"],is_optional:false},{type:"node_out",name:"fR",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fR","=","vec3","(","fO",
",","fP",",","fQ",")",";"]}]},{type:"node",name:"COMBHSV",declarations:[{type:"node_in",name:"fS",qualifier:["float"],is_optional:false},{type:"node_in",name:"fT",qualifier:["float"],is_optional:false},{type:"node_in",name:"fU",qualifier:["float"],is_optional:false},{type:"node_out",name:"fV",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fV","=","fc","(","vec3","(","fS",",","fT",",","fU",")",")",";"]}]},{type:"node",name:"EMPTY_UV",declarations:[{type:"node_out",name:"fW",
qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fW","=","vec3","(","-","1.0",",","-","1.0",",","0.0",")",";"]}]},{type:"node",name:"EMPTY_VC",declarations:[{type:"node_out",name:"fX",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fX","=","eN",";"]}]},{type:"node",name:"GEOMETRY_UV",declarations:[{type:"node_out",name:"fY",qualifier:["vec3"],is_optional:false},{type:"node_param",name:"fh",qualifier:["varying","vec2"]}],statements:[{type:"textline",
tokens:["fY","=","fe","(","fh",")",";"]}]},{type:"node",name:"GEOMETRY_OR",declarations:[{type:"node_out",name:"fZ",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fZ","=","2.0","*","eL","-","eO",";"]}]},{type:"node",name:"GEOMETRY_VC",declarations:[{type:"node_out",name:"f_",qualifier:["vec3"],is_optional:false},{type:"node_param",name:"fi",qualifier:["varying","vec3"]}],statements:[{type:"textline",tokens:["f_","=","fi",";"]}]},{type:"node",name:"GEOMETRY_VC1",declarations:[{type:"node_out",
name:"ga",qualifier:["float"],is_optional:false},{type:"node_param",name:"fj",qualifier:["varying","float"]}],statements:[{type:"textline",tokens:["ga","=","fj",";"]}]},{type:"node",name:"GEOMETRY_VC2",declarations:[{type:"node_out",name:"gb",qualifier:["float"],is_optional:false},{type:"node_out",name:"gc",qualifier:["float"],is_optional:false},{type:"node_param",name:"fk",qualifier:["varying","vec2"]}],statements:[{type:"textline",tokens:["gb","=","fk","[","0","]",";","gc","=","fk","[","1","]",
";"]}]},{type:"node",name:"GEOMETRY_VC3",declarations:[{type:"node_out",name:"gd",qualifier:["float"],is_optional:false},{type:"node_out",name:"ge",qualifier:["float"],is_optional:false},{type:"node_out",name:"gf",qualifier:["float"],is_optional:false},{type:"node_param",name:"fl",qualifier:["varying","vec3"]}],statements:[{type:"textline",tokens:["gd","=","fl","[","0","]",";","ge","=","fl","[","1","]",";","gf","=","fl","[","2","]",";"]}]},{type:"node",name:"GEOMETRY_NO",declarations:[{type:"node_out",
name:"gg",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["gg","=","fD",";"]}]},{type:"node",name:"GEOMETRY_FB",declarations:[{type:"node_out",name:"gh",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["gh","=","(","gl_FrontFacing",")","?","UNITY_VALUE_NODES",":","ZERO_VALUE_NODES",";"]}]},{type:"node",name:"GEOMETRY_VW",declarations:[{type:"node_out",name:"gi",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["gi",
"=","fu",";"]}]},{type:"node",name:"GEOMETRY_LO",declarations:[{type:"node_out",name:"gj",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["gj","[","0","]","=","fI","[","0","]",";","gj","[","1","]","=","fI","[","1","]",";","gj","[","2","]","=","fI","[","2","]",";"]}]},{type:"node",name:"GEOMETRY_GL",declarations:[{type:"node_out",name:"gk",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["gk","=","vec3","(","fH",".","r",",","-","fH",".","b",",",
"fH",".","g",")",";"]}]},{type:"node",name:"NEW_GEOMETRY",declarations:[{type:"node_out",name:"gl",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"gm",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"gn",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"go",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"gp",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"gq",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"gr",qualifier:["float"],
is_optional:false},{type:"node_out",name:"gs",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["gl","=","eN",";","gm","=","eN",";","gn","=","eN",";","go","=","eN",";","gp","=","eN",";","gq","=","eN",";","gr","=","ZERO_VALUE_NODES",";","gs","=","ZERO_VALUE_NODES",";"]}]},{type:"node",name:"HUE_SAT",declarations:[{type:"node_in",name:"gt",qualifier:["float"],is_optional:false},{type:"node_in",name:"gu",qualifier:["float"],is_optional:false},{type:"node_in",name:"gv",qualifier:["float"],
is_optional:false},{type:"node_in",name:"gw",qualifier:["float"],is_optional:false},{type:"node_in",name:"gx",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"gy",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["vec3","gz","=","eZ","(","gx",")",";","gz","[","0","]","+=","(","gt","-","0.5",")",";","if","(","gz","[","0","]",">","UNITY_VALUE_NODES",")","gz","[","0","]","-=","UNITY_VALUE_NODES",";","else","if","(","gz","[","0","]","<","ZERO_VALUE_NODES",")","gz",
"[","0","]","+=","UNITY_VALUE_NODES",";","gz","*=","vec3","(","UNITY_VALUE_NODES",",","gu",",","gv",")",";","gz","=","mix","(","eO",",","mix","(","eN",",","gz",",","step","(","eN",",","gz",")",")",",","step","(","gz",",","eO",")",")",";","gy","=","mix","(","gx",",","fc","(","gz",")",",","gw",")",";"]}]},{type:"node",name:"INVERT",declarations:[{type:"node_in",name:"gA",qualifier:["float"],is_optional:false},{type:"node_in",name:"gB",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"gC",
qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["gC","=","mix","(","gB",",","eO","-","gB",",","gA",")",";"]}]},{type:"node",name:"LAMP",declarations:[{type:"node_out",name:"gD",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"gE",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"gF",qualifier:["float"],is_optional:false},{type:"node_out",name:"gG",qualifier:["float"],is_optional:true}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_gD"],
statements:[{type:"textline",tokens:["gD","=","u_lamp_light_color_intensities","[","LAMP_INDEX","]",";"]}]}]},{type:"textline",tokens:["vec4","gH","=","u_lamp_light_factors","[","LAMP_INDEX","]",";","vec3","gI","=","u_lamp_light_directions","[","LAMP_INDEX","]",";","vec3","gJ","=","u_lamp_light_positions","[","LAMP_INDEX","]",";","float","gK","=","gH",".","z",";","if","(","gK","!=","-","UNITY_VALUE_NODES",")","{"]},{type:"textline",tokens:["gE","=","gJ","-","bQ",";","gF","=","length","(","gE",")",
";","gE","=","normalize","(","gE",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_gG"],statements:[{type:"textline",tokens:["gG","=","gK","/","(","gK","+","gF","*","gF",")",";","float","gL","=","gH",".","x",";","float","gM","=","gH",".","y",";","if","(","gL",">","-","UNITY_VALUE_NODES",")","{","float","gN","=","dot","(","gE",",","gI",")",";","gN","*=","smoothstep","(","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",",","(","gN","-","gL",")","/","gM",")",";","gG","*=","gN",
";","}"]}]}]},{type:"textline",tokens:["}","else","{"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_gE"],statements:[{type:"textline",tokens:["gE","=","gI",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_gF"],statements:[{type:"textline",tokens:["gF","=","length","(","gJ","-","bQ",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_gG"],statements:[{type:"textline",tokens:["gG","=","UNITY_VALUE_NODES",";"]}]}]},{type:"textline",
tokens:["}"]}]},{type:"node",name:"NORMAL",declarations:[{type:"node_in",name:"gO",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"gP",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"gQ",qualifier:["float"],is_optional:true},{type:"node_param",name:"fm",qualifier:["vec3"]}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_gP"],statements:[{type:"textline",tokens:["gP","=","fm",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_gQ"],
statements:[{type:"textline",tokens:["gQ","=","-","dot","(","gO",",","fm",")",";"]}]}]}]},{type:"node",name:"B4W_VECTOR_VIEW",declarations:[{type:"node_in",name:"gR",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"gS",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["gS","=","-","(","u_view_matrix_frag","*","vec4","(","gR",",","ZERO_VALUE_NODES",")",")",".","xyz",";"]}]},{type:"node",name:"BSDF_ANISOTROPIC",declarations:[{type:"node_in",name:"gT",qualifier:["vec3"],
is_optional:false},{type:"node_in",name:"gU",qualifier:["float"],is_optional:false},{type:"node_in",name:"gV",qualifier:["float"],is_optional:false},{type:"node_in",name:"gW",qualifier:["float"],is_optional:false},{type:"node_in",name:"gX",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"gY",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"gZ",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["gZ","=","gT",";"]},{type:"textline",tokens:["gU",";","gV",
";","gW",";","gX",";","gY",";"]}]},{type:"node",name:"BSDF_DIFFUSE",declarations:[{type:"node_in",name:"g_",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"ha",qualifier:["float"],is_optional:false},{type:"node_in",name:"hb",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"hc",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["hc","=","g_",";"]},{type:"textline",tokens:["ha",";","hb",";"]}]},{type:"node",name:"BSDF_GLASS",declarations:[{type:"node_in",
name:"hd",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"he",qualifier:["float"],is_optional:false},{type:"node_in",name:"hf",qualifier:["float"],is_optional:false},{type:"node_in",name:"hg",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"hh",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["hh","=","hd",";"]},{type:"textline",tokens:["he",";","hf",";","hg",";"]}]},{type:"node",name:"BSDF_GLOSSY",declarations:[{type:"node_in",name:"hi",qualifier:["vec3"],
is_optional:false},{type:"node_in",name:"hj",qualifier:["float"],is_optional:false},{type:"node_in",name:"hk",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"hl",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["hl","=","hi",";"]},{type:"textline",tokens:["hj",";","hk",";"]}]},{type:"node",name:"BSDF_HAIR",declarations:[{type:"node_in",name:"hm",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"hn",qualifier:["float"],is_optional:false},{type:"node_in",
name:"ho",qualifier:["float"],is_optional:false},{type:"node_in",name:"hp",qualifier:["float"],is_optional:false},{type:"node_out",name:"hq",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["hq","=","hm",";"]},{type:"textline",tokens:["hn",";","ho",";","hp",";"]}]},{type:"node",name:"BSDF_TRANSPARENT",declarations:[{type:"node_in",name:"hr",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"hs",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",
tokens:["hs","=","hr",";"]}]},{type:"node",name:"BSDF_TRANSLUCENT",declarations:[{type:"node_in",name:"ht",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"hu",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"hv",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["hv","=","ht",";"]},{type:"textline",tokens:["hu",";"]}]},{type:"node",name:"BSDF_REFRACTION",declarations:[{type:"node_in",name:"hw",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"hx",
qualifier:["float"],is_optional:false},{type:"node_in",name:"hy",qualifier:["float"],is_optional:false},{type:"node_in",name:"hz",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"hA",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["hA","[","0","]","=","hA","[","1","]","=","hA","[","2","]","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["hw",";","hx",";","hy",";","hz",";"]}]},{type:"node",name:"BSDF_TOON",declarations:[{type:"node_in",name:"hB",qualifier:["vec3"],
is_optional:false},{type:"node_in",name:"hC",qualifier:["float"],is_optional:false},{type:"node_in",name:"hD",qualifier:["float"],is_optional:false},{type:"node_in",name:"hE",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"hF",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["hF","=","hB",";"]},{type:"textline",tokens:["hC",";","hD",";","hE",";"]}]},{type:"node",name:"BSDF_VELVET",declarations:[{type:"node_in",name:"hG",qualifier:["vec3"],is_optional:false},
{type:"node_in",name:"hH",qualifier:["float"],is_optional:false},{type:"node_in",name:"hI",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"hJ",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["hJ","=","hG",";"]},{type:"textline",tokens:["hH",";","hI",";"]}]},{type:"node",name:"SUBSURFACE_SCATTERING",declarations:[{type:"node_in",name:"hK",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"hL",qualifier:["float"],is_optional:false},{type:"node_in",name:"hM",
qualifier:["vec3"],is_optional:false},{type:"node_in",name:"hN",qualifier:["float"],is_optional:false},{type:"node_in",name:"hO",qualifier:["float"],is_optional:false},{type:"node_in",name:"hP",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"hQ",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["hQ","[","0","]","=","hQ","[","1","]","=","hQ","[","2","]","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["hK",";","hM",";","hN",";","hO",";","hP",";","hL",";"]}]},
{type:"node",name:"EMISSION",declarations:[{type:"node_in",name:"hR",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"hS",qualifier:["float"],is_optional:false},{type:"node_out",name:"hT",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["hT","=","hR",";"]},{type:"textline",tokens:["hS",";"]}]},{type:"node",name:"AMBIENT_OCCLUSION",declarations:[{type:"node_in",name:"hU",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"hV",qualifier:["vec3"],is_optional:false}],
statements:[{type:"textline",tokens:["hV","[","0","]","=","hV","[","1","]","=","hV","[","2","]","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["hU",";"]}]},{type:"node",name:"HOLDOUT",declarations:[{type:"node_out",name:"hW",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["hW","[","0","]","=","hW","[","1","]","=","hW","[","2","]","=","ZERO_VALUE_NODES",";"]}]},{type:"node",name:"VOLUME_ABSORPTION",declarations:[{type:"node_in",name:"hX",qualifier:["vec3"],is_optional:false},
{type:"node_in",name:"hY",qualifier:["float"],is_optional:false},{type:"node_out",name:"hZ",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["hZ","[","0","]","=","hZ","[","1","]","=","hZ","[","2","]","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["hX",";","hY",";"]}]},{type:"node",name:"VOLUME_SCATTER",declarations:[{type:"node_in",name:"h_",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"ia",qualifier:["float"],is_optional:false},{type:"node_in",name:"ib",
qualifier:["float"],is_optional:false},{type:"node_out",name:"ic",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["ic","[","0","]","=","ic","[","1","]","=","ic","[","2","]","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["h_",";","ia",";","ib",";"]}]},{type:"node",name:"BUMP",declarations:[{type:"node_in",name:"id",qualifier:["float"],is_optional:false},{type:"node_in",name:"ie",qualifier:["float"],is_optional:false},{type:"node_in",name:"ig",qualifier:["float"],
is_optional:false},{type:"node_in",name:"ih",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"ii",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["ii","=","ih",";"]},{type:"textline",tokens:["id",";","ie",";","ig",";"]}]},{type:"node",name:"NORMAL_MAP",declarations:[{type:"node_in",name:"ij",qualifier:["float"],is_optional:false},{type:"node_in",name:"ik",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"il",qualifier:["vec3"],is_optional:false}],
statements:[{type:"textline",tokens:["il","=","ik",";"]},{type:"textline",tokens:["ij",";"]}]},{type:"node",name:"VECT_TRANSFORM",declarations:[{type:"node_in",name:"im",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"io",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["io","[","0","]","=","io","[","1","]","=","io","[","2","]","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["im",";"]}]},{type:"node",name:"BLACKBODY",declarations:[{type:"node_in",name:"ip",
qualifier:["float"],is_optional:false},{type:"node_out",name:"iq",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["iq","[","0","]","=","iq","[","1","]","=","iq","[","2","]","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["ip",";"]}]},{type:"node",name:"WAVELENGTH",declarations:[{type:"node_in",name:"ir",qualifier:["float"],is_optional:false},{type:"node_out",name:"is",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["is","[","0","]","=",
"is","[","1","]","=","is","[","2","]","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["ir",";"]}]},{type:"node",name:"SEPXYZ",declarations:[{type:"node_in",name:"it",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"iu",qualifier:["float"],is_optional:false},{type:"node_out",name:"iv",qualifier:["float"],is_optional:false},{type:"node_out",name:"iw",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["iu","=","it","[","0","]",";","iv","=","it","[","1","]",
";","iw","=","it","[","2","]",";"]}]},{type:"node",name:"COMBXYZ",declarations:[{type:"node_in",name:"ix",qualifier:["float"],is_optional:false},{type:"node_in",name:"iy",qualifier:["float"],is_optional:false},{type:"node_in",name:"iz",qualifier:["float"],is_optional:false},{type:"node_out",name:"iA",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["iA","[","0","]","=","ix",";","iA","[","1","]","=","iy",";","iA","[","2","]","=","iz",";"]}]},{type:"node",name:"BRIGHTCONTRAST",
declarations:[{type:"node_in",name:"iB",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"iC",qualifier:["float"],is_optional:false},{type:"node_in",name:"iD",qualifier:["float"],is_optional:false},{type:"node_out",name:"iE",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["float","iF","=","iC","-","iD","*","0.5",";","iE","=","max","(","(","UNITY_VALUE_NODES","+","iD",")","*","iB","+","iF",",","eN",")",";"]}]},{type:"node",name:"LIGHT_FALLOFF",declarations:[{type:"node_in",
name:"iG",qualifier:["float"],is_optional:false},{type:"node_in",name:"iH",qualifier:["float"],is_optional:false},{type:"node_out",name:"iI",qualifier:["float"],is_optional:false},{type:"node_out",name:"iJ",qualifier:["float"],is_optional:false},{type:"node_out",name:"iK",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["iI","=","iJ","=","iK","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["iG",";","iH",";"]}]},{type:"node",name:"TEX_IMAGE",declarations:[{type:"node_in",
name:"iL",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"iM",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"iN",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["iM","[","0","]","=","iM","[","1","]","=","iM","[","2","]","=","ZERO_VALUE_NODES",";","iN","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["iL",";"]}]},{type:"node",name:"TEX_ENVIRONMENT",declarations:[{type:"node_in",name:"iO",qualifier:["vec3"],is_optional:false},{type:"node_out",
name:"iP",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["iP","[","0","]","=","iP","[","1","]","=","iP","[","2","]","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["iO",";"]}]},{type:"node",name:"TEX_SKY",declarations:[{type:"node_in",name:"iQ",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"iR",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["iR","[","0","]","=","iR","[","1","]","=","iR","[","2","]","=","ZERO_VALUE_NODES",
";"]},{type:"textline",tokens:["iQ",";"]}]},{type:"node",name:"TEX_NOISE",declarations:[{type:"node_in",name:"iS",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"iT",qualifier:["float"],is_optional:false},{type:"node_in",name:"iU",qualifier:["float"],is_optional:false},{type:"node_in",name:"iV",qualifier:["float"],is_optional:false},{type:"node_out",name:"iW",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"iX",qualifier:["float"],is_optional:false}],statements:[{type:"textline",
tokens:["iW","[","0","]","=","iW","[","1","]","=","iW","[","2","]","=","ZERO_VALUE_NODES",";","iX","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["iS",";","iT",";","iU",";","iV",";"]}]},{type:"node",name:"TEX_WAVE",declarations:[{type:"node_in",name:"iY",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"iZ",qualifier:["float"],is_optional:false},{type:"node_in",name:"i_",qualifier:["float"],is_optional:false},{type:"node_in",name:"ja",qualifier:["float"],is_optional:false},{type:"node_in",
name:"jb",qualifier:["float"],is_optional:false},{type:"node_out",name:"jc",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"jd",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["jc","[","0","]","=","jc","[","1","]","=","jc","[","2","]","=","ZERO_VALUE_NODES",";","jd","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["iY",";","iZ",";","i_",";","ja",";","jb",";"]}]},{type:"node",name:"TEX_VORONOI",declarations:[{type:"node_in",name:"je",qualifier:["vec3"],
is_optional:false},{type:"node_in",name:"jf",qualifier:["float"],is_optional:false},{type:"node_out",name:"jg",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"jh",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["jg","[","0","]","=","jg","[","1","]","=","jg","[","2","]","=","ZERO_VALUE_NODES",";","jh","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["je",";","jf",";"]}]},{type:"node",name:"TEX_MUSGRAVE",declarations:[{type:"node_in",name:"ji",qualifier:["vec3"],
is_optional:false},{type:"node_in",name:"jj",qualifier:["float"],is_optional:false},{type:"node_in",name:"jk",qualifier:["float"],is_optional:false},{type:"node_in",name:"jl",qualifier:["float"],is_optional:false},{type:"node_in",name:"jm",qualifier:["float"],is_optional:false},{type:"node_in",name:"jn",qualifier:["float"],is_optional:false},{type:"node_in",name:"jo",qualifier:["float"],is_optional:false},{type:"node_out",name:"jp",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"jq",
qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["jp","[","0","]","=","jp","[","1","]","=","jp","[","2","]","=","ZERO_VALUE_NODES",";","jq","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["ji",";","jj",";","jk",";","jl",";","jm",";","jn",";","jo",";"]}]},{type:"node",name:"TEX_GRADIENT",declarations:[{type:"node_in",name:"jr",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"js",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"jt",qualifier:["float"],
is_optional:false}],statements:[{type:"textline",tokens:["js","[","0","]","=","js","[","1","]","=","js","[","2","]","=","ZERO_VALUE_NODES",";","jt","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["jr",";"]}]},{type:"node",name:"TEX_MAGIC",declarations:[{type:"node_in",name:"ju",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"jv",qualifier:["float"],is_optional:false},{type:"node_in",name:"jw",qualifier:["float"],is_optional:false},{type:"node_out",name:"jx",qualifier:["vec3"],is_optional:false},
{type:"node_out",name:"jy",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["jx","[","0","]","=","jx","[","1","]","=","jx","[","2","]","=","ZERO_VALUE_NODES",";","jy","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["ju",";","jv",";","jw",";"]}]},{type:"node",name:"TEX_CHECKER",declarations:[{type:"node_in",name:"jz",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"jA",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"jB",qualifier:["vec3"],is_optional:false},
{type:"node_in",name:"jC",qualifier:["float"],is_optional:false},{type:"node_out",name:"jD",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"jE",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["jD","[","0","]","=","jD","[","1","]","=","jD","[","2","]","=","ZERO_VALUE_NODES",";","jE","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["jz",";","jA",";","jB",";","jC",";"]}]},{type:"node",name:"TEX_BRICK",declarations:[{type:"node_in",name:"jF",qualifier:["vec3"],
is_optional:false},{type:"node_in",name:"jG",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"jH",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"jI",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"jJ",qualifier:["float"],is_optional:false},{type:"node_in",name:"jK",qualifier:["float"],is_optional:false},{type:"node_in",name:"jL",qualifier:["float"],is_optional:false},{type:"node_in",name:"jM",qualifier:["float"],is_optional:false},{type:"node_in",name:"jN",qualifier:["float"],
is_optional:false},{type:"node_out",name:"jO",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"jP",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["jO","[","0","]","=","jO","[","1","]","=","jO","[","2","]","=","ZERO_VALUE_NODES",";","jP","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["jF",";","jG",";","jH",";","jI",";","jJ",";","jK",";","jL",";","jM",";","jN",";"]}]},{type:"node",name:"ADD_SHADER",declarations:[{type:"node_in",name:"jQ",qualifier:["vec3"],
is_optional:false},{type:"node_in",name:"jR",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"jS",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["jS","=","clamp","(","jQ","+","jR",",","eN",",","eO",")",";"]}]},{type:"node",name:"MIX_SHADER",declarations:[{type:"node_in",name:"jT",qualifier:["float"],is_optional:false},{type:"node_in",name:"jU",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"jV",qualifier:["vec3"],is_optional:false},{type:"node_out",
name:"jW",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["float","jX","=","clamp","(","jT",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","jW","=","jX","*","jU","+","(","UNITY_VALUE_NODES","-","jX",")","*","jV",";"]}]},{type:"node",name:"UV_MERGED",declarations:[{type:"node_out",name:"jY",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"jZ",qualifier:["vec3"],is_optional:false},{type:"node_param",name:"fn",qualifier:["varying","vec2"]}],statements:[{type:"node_condition",
parts:[{type:"node_if",expression:["USE_OUT_jY"],statements:[{type:"textline",tokens:["jY","=","fe","(","fn",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_jZ"],statements:[{type:"textline",tokens:["jZ","=","vec3","(","fn",",","ZERO_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"TEX_COORD_UV",declarations:[{type:"node_out",name:"j_",qualifier:["vec3"],is_optional:false},{type:"node_param",name:"fo",qualifier:["varying","vec2"]}],statements:[{type:"textline",tokens:["j_",
"=","vec3","(","fo",",","ZERO_VALUE_NODES",")",";"]}]},{type:"node",name:"TEX_COORD_NO",declarations:[{type:"node_out",name:"ka",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["ka","=","fC",";"]}]},{type:"node",name:"TEX_COORD_GE",declarations:[{type:"node_out",name:"kb",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["kb","=","eL",";"]}]},{type:"node",name:"TEX_COORD_OB",declarations:[{type:"node_out",name:"kc",qualifier:["vec3"],is_optional:false}],
statements:[{type:"textline",tokens:["kc","[","0","]","=","kc","[","1","]","=","kc","[","2","]","=","UNITY_VALUE_NODES",";"]}]},{type:"node",name:"TEX_COORD_CA",declarations:[{type:"node_out",name:"kd",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["kd","[","0","]","=","fI","[","0","]",";","kd","[","1","]","=","fI","[","1","]",";","kd","[","2","]","=","UNITY_VALUE_NODES",";"]}]},{type:"node",name:"TEX_COORD_WI",declarations:[{type:"node_out",name:"ke",qualifier:["vec3"],
is_optional:false}],statements:[{type:"textline",tokens:["ke","[","0","]","=","ke","[","1","]","=","ke","[","2","]","=","UNITY_VALUE_NODES",";"]}]},{type:"node",name:"TEX_COORD_RE",declarations:[{type:"node_out",name:"kf",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["kf","[","0","]","=","kf","[","1","]","=","kf","[","2","]","=","UNITY_VALUE_NODES",";"]}]},{type:"node",name:"UVMAP",declarations:[{type:"node_out",name:"kg",qualifier:["vec3"],is_optional:false},{type:"node_param",
name:"fp",qualifier:["varying","vec2"]}],statements:[{type:"textline",tokens:["kg","=","vec3","(","fp",",","ZERO_VALUE_NODES",")",";"]}]},{type:"node",name:"PARTICLE_INFO",declarations:[{type:"node_out",name:"kh",qualifier:["float"],is_optional:false},{type:"node_out",name:"ki",qualifier:["float"],is_optional:false},{type:"node_out",name:"kj",qualifier:["float"],is_optional:false},{type:"node_out",name:"kk",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"kl",qualifier:["float"],is_optional:false},
{type:"node_out",name:"km",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"kn",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["kh","=","ZERO_VALUE_NODES",";","ki","=","ZERO_VALUE_NODES",";","kj","=","ZERO_VALUE_NODES",";","kk","=","vec3","(","ZERO_VALUE_NODES",")",";","kl","=","ZERO_VALUE_NODES",";","km","=","kk",";","kn","=","kk",";"]}]},{type:"node",name:"HAIR_INFO",declarations:[{type:"node_out",name:"ko",qualifier:["float"],is_optional:false},{type:"node_out",
name:"kp",qualifier:["float"],is_optional:false},{type:"node_out",name:"kq",qualifier:["float"],is_optional:false},{type:"node_out",name:"kr",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["ko","=","ZERO_VALUE_NODES",";","kp","=","ZERO_VALUE_NODES",";","kq","=","ZERO_VALUE_NODES",";","kr","=","vec3","(","ZERO_VALUE_NODES",")",";"]}]},{type:"node",name:"OBJECT_INFO",declarations:[{type:"node_out",name:"ks",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"kt",
qualifier:["float"],is_optional:false},{type:"node_out",name:"ku",qualifier:["float"],is_optional:false},{type:"node_out",name:"kv",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["kt","=","ZERO_VALUE_NODES",";","ku","=","ZERO_VALUE_NODES",";","kv","=","ZERO_VALUE_NODES",";","ks","=","vec3","(","ZERO_VALUE_NODES",")",";"]}]},{type:"node",name:"WIREFRAME",declarations:[{type:"node_in",name:"kw",qualifier:["float"],is_optional:false},{type:"node_out",name:"kx",qualifier:["float"],
is_optional:false}],statements:[{type:"textline",tokens:["kx","=","kw",";"]}]},{type:"node",name:"TANGENT",declarations:[{type:"node_out",name:"ky",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["ky","=","vec3","(","ZERO_VALUE_NODES",")",";"]}]},{type:"node",name:"LAYER_WEIGHT",declarations:[{type:"node_in",name:"kz",qualifier:["float"],is_optional:false},{type:"node_in",name:"kA",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"kB",qualifier:["float"],is_optional:false},
{type:"node_out",name:"kC",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["kB","=","kC","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["kA",";","kz",";"]}]},{type:"node",name:"LIGHT_PATH",declarations:[{type:"node_out",name:"kD",qualifier:["float"],is_optional:false},{type:"node_out",name:"kE",qualifier:["float"],is_optional:false},{type:"node_out",name:"kF",qualifier:["float"],is_optional:false},{type:"node_out",name:"kG",qualifier:["float"],is_optional:false},
{type:"node_out",name:"kH",qualifier:["float"],is_optional:false},{type:"node_out",name:"kI",qualifier:["float"],is_optional:false},{type:"node_out",name:"kJ",qualifier:["float"],is_optional:false},{type:"node_out",name:"kK",qualifier:["float"],is_optional:false},{type:"node_out",name:"kL",qualifier:["float"],is_optional:false},{type:"node_out",name:"kM",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["kD","=","kE","=","kF","=","ZERO_VALUE_NODES",";","kG","=","kH","=",
"kI","=","ZERO_VALUE_NODES",";","kJ","=","kJ","=","kL","=","kM","=","ZERO_VALUE_NODES",";","kK","=","ZERO_VALUE_NODES",";"]}]},{type:"node",name:"ATTRIBUTE",declarations:[{type:"node_out",name:"kN",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"kO",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"kP",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["kN","=","kO","=","vec3","(","ZERO_VALUE_NODES",")",";","kP","=","ZERO_VALUE_NODES",";"]}]},{type:"node",
name:"SCRIPT",declarations:[],statements:[]},{type:"node",name:"CURVE_VEC",declarations:[{type:"node_in",name:"kQ",qualifier:["float"],is_optional:false},{type:"node_in",name:"kR",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"kS",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["kS","=","kR",";"]},{type:"textline",tokens:["kQ",";"]}]},{type:"node",name:"CURVE_RGB",declarations:[{type:"node_in",name:"kT",qualifier:["float"],is_optional:false},{type:"node_in",
name:"kU",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"kV",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["kV","=","kU",";"]},{type:"textline",tokens:["kT",";"]}]},{type:"node",name:"VALTORGB",declarations:[{type:"node_in",name:"kW",qualifier:["float"],is_optional:false},{type:"node_out",name:"kX",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"kY",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["kX","[","0","]",
"=","kX","[","1","]","=","kX","[","2","]","=","clamp","(","kW",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","kY","=","kX","[","0","]",";"]}]},{type:"node",name:"MAPPING",declarations:[{type:"node_in",name:"kZ",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"k_",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["k_","=","kZ",";"]},{type:"node_condition",parts:[{type:"node_ifdef",name:"MAPPING_TRS_MATRIX",statements:[{type:"textline",tokens:["k_","=",
"(","MAPPING_TRS_MATRIX","*","vec4","(","k_",",","UNITY_VALUE_NODES",")",")",".","xyz",";"]}]}]},{type:"node_condition",parts:[{type:"node_ifdef",name:"MAPPING_SCALE",statements:[{type:"textline",tokens:["k_","=","k_","*","MAPPING_SCALE",";"]}]}]},{type:"node_condition",parts:[{type:"node_ifdef",name:"MAPPING_TRANSLATION",statements:[{type:"textline",tokens:["k_","=","k_","+","MAPPING_TRANSLATION",";"]}]}]},{type:"node_condition",parts:[{type:"node_ifdef",name:"MAPPING_MIN_CLIP",statements:[{type:"textline",
tokens:["k_","=","max","(","k_",",","MAPPING_MIN_CLIP",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_ifdef",name:"MAPPING_MAX_CLIP",statements:[{type:"textline",tokens:["k_","=","min","(","k_",",","MAPPING_MAX_CLIP",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["MAPPING_IS_NORMAL"],statements:[{type:"textline",tokens:["k_","=","normalize","(","k_",")",";"]}]}]}]},{type:"node",name:"MATH_ADD",declarations:[{type:"node_in",name:"la",qualifier:["float"],is_optional:false},
{type:"node_in",name:"lb",qualifier:["float"],is_optional:false},{type:"node_out",name:"lc",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["lc","=","la","+","lb",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["lc","=","clamp","(","lc",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_SUBTRACT",declarations:[{type:"node_in",name:"ld",qualifier:["float"],is_optional:false},
{type:"node_in",name:"le",qualifier:["float"],is_optional:false},{type:"node_out",name:"lf",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["lf","=","ld","-","le",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["lf","=","clamp","(","lf",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_MULTIPLY",declarations:[{type:"node_in",name:"lg",qualifier:["float"],is_optional:false},
{type:"node_in",name:"lh",qualifier:["float"],is_optional:false},{type:"node_out",name:"li",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["li","=","lg","*","lh",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["li","=","clamp","(","li",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_DIVIDE",declarations:[{type:"node_in",name:"lj",qualifier:["float"],is_optional:false},
{type:"node_in",name:"lk",qualifier:["float"],is_optional:false},{type:"node_out",name:"ll",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["ll","=","(","lk","!=","ZERO_VALUE_NODES",")","?","lj","/","lk",":","ZERO_VALUE_NODES",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["ll","=","clamp","(","ll",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_SINE",declarations:[{type:"node_in",
name:"lm",qualifier:["float"],is_optional:false},{type:"node_in",name:"ln",qualifier:["float"],is_optional:false},{type:"node_out",name:"lo",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["lo","=","sin","(","lm",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["lo","=","clamp","(","lo",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]},{type:"textline",tokens:["ln",";"]}]},{type:"node",
name:"MATH_COSINE",declarations:[{type:"node_in",name:"lp",qualifier:["float"],is_optional:false},{type:"node_in",name:"lq",qualifier:["float"],is_optional:false},{type:"node_out",name:"lr",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["lr","=","cos","(","lp",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["lr","=","clamp","(","lr",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]},
{type:"textline",tokens:["lq",";"]}]},{type:"node",name:"MATH_TANGENT",declarations:[{type:"node_in",name:"ls",qualifier:["float"],is_optional:false},{type:"node_in",name:"lt",qualifier:["float"],is_optional:false},{type:"node_out",name:"lu",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["lu","=","tan","(","ls",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["lu","=","clamp","(","lu",",","ZERO_VALUE_NODES",
",","UNITY_VALUE_NODES",")",";"]}]}]},{type:"textline",tokens:["lt",";"]}]},{type:"node",name:"MATH_ARCSINE",declarations:[{type:"node_in",name:"lv",qualifier:["float"],is_optional:false},{type:"node_in",name:"lw",qualifier:["float"],is_optional:false},{type:"node_out",name:"lx",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["lx","=","(","lv","<=","UNITY_VALUE_NODES","&&","lv",">=","-","UNITY_VALUE_NODES",")","?","asin","(","lv",")",":","ZERO_VALUE_NODES",";"]},{type:"node_condition",
parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["lx","=","clamp","(","lx",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]},{type:"textline",tokens:["lw",";"]}]},{type:"node",name:"MATH_ARCCOSINE",declarations:[{type:"node_in",name:"ly",qualifier:["float"],is_optional:false},{type:"node_in",name:"lz",qualifier:["float"],is_optional:false},{type:"node_out",name:"lA",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["lA",
"=","(","ly","<=","UNITY_VALUE_NODES","&&","ly",">=","-","UNITY_VALUE_NODES",")","?","acos","(","ly",")",":","ZERO_VALUE_NODES",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["lA","=","clamp","(","lA",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]},{type:"textline",tokens:["lz",";"]}]},{type:"node",name:"MATH_ARCTANGENT",declarations:[{type:"node_in",name:"lB",qualifier:["float"],is_optional:false},{type:"node_in",
name:"lC",qualifier:["float"],is_optional:false},{type:"node_out",name:"lD",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["lD","=","atan","(","lB",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["lD","=","clamp","(","lD",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]},{type:"textline",tokens:["lC",";"]}]},{type:"node",name:"MATH_POWER",declarations:[{type:"node_in",name:"lE",qualifier:["float"],
is_optional:false},{type:"node_in",name:"lF",qualifier:["float"],is_optional:false},{type:"node_out",name:"lG",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["if","(","lE","<","ZERO_VALUE_NODES","||","lE","==","ZERO_VALUE_NODES","&&","lF","==","ZERO_VALUE_NODES",")","lG","=","ZERO_VALUE_NODES",";","else","lG","=","pow","(","lE",",","lF",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["lG","=",
"clamp","(","lG",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_LOGARITHM",declarations:[{type:"node_in",name:"lH",qualifier:["float"],is_optional:false},{type:"node_in",name:"lI",qualifier:["float"],is_optional:false},{type:"node_out",name:"lJ",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["lJ","=","(","lH",">","ZERO_VALUE_NODES","&&","lI",">","ZERO_VALUE_NODES",")","?","log2","(","lH",")","/","log2","(","lI",")",":","ZERO_VALUE_NODES",
";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["lJ","=","clamp","(","lJ",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_MINIMUM",declarations:[{type:"node_in",name:"lK",qualifier:["float"],is_optional:false},{type:"node_in",name:"lL",qualifier:["float"],is_optional:false},{type:"node_out",name:"lM",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["lM","=","min",
"(","lK",",","lL",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["lM","=","clamp","(","lM",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_MAXIMUM",declarations:[{type:"node_in",name:"lN",qualifier:["float"],is_optional:false},{type:"node_in",name:"lO",qualifier:["float"],is_optional:false},{type:"node_out",name:"lP",qualifier:["float"],is_optional:false}],statements:[{type:"textline",
tokens:["lP","=","max","(","lN",",","lO",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["lP","=","clamp","(","lP",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_ROUND",declarations:[{type:"node_in",name:"lQ",qualifier:["float"],is_optional:false},{type:"node_in",name:"lR",qualifier:["float"],is_optional:false},{type:"node_out",name:"lS",qualifier:["float"],is_optional:false}],statements:[{type:"textline",
tokens:["lS","=","floor","(","lQ","+","0.5",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["lS","=","clamp","(","lS",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]},{type:"textline",tokens:["lR",";"]}]},{type:"node",name:"MATH_LESS_THAN",declarations:[{type:"node_in",name:"lT",qualifier:["float"],is_optional:false},{type:"node_in",name:"lU",qualifier:["float"],is_optional:false},{type:"node_out",name:"lV",qualifier:["float"],
is_optional:false}],statements:[{type:"textline",tokens:["lV","=","(","lT","<","lU",")","?","UNITY_VALUE_NODES",":","ZERO_VALUE_NODES",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["lV","=","clamp","(","lV",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_GREATER_THAN",declarations:[{type:"node_in",name:"lW",qualifier:["float"],is_optional:false},{type:"node_in",name:"lX",qualifier:["float"],
is_optional:false},{type:"node_out",name:"lY",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["lY","=","(","lW",">","lX",")","?","UNITY_VALUE_NODES",":","ZERO_VALUE_NODES",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["lY","=","clamp","(","lY",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_MODULO",declarations:[{type:"node_in",name:"lZ",qualifier:["float"],
is_optional:false},{type:"node_in",name:"l_",qualifier:["float"],is_optional:false},{type:"node_out",name:"ma",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["ma","=","abs","(","l_",")",">","0.000001","?","mod","(","lZ",",","l_",")",":","ZERO_VALUE_NODES",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["ma","=","clamp","(","ma",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",
name:"MATH_ABSOLUTE",declarations:[{type:"node_in",name:"mb",qualifier:["float"],is_optional:false},{type:"node_in",name:"mc",qualifier:["float"],is_optional:false},{type:"node_out",name:"md",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["md","=","abs","(","mb",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["md","=","clamp","(","md",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]},
{type:"textline",tokens:["mc",";"]}]},{type:"node",name:"MIX_RGB_MIX",declarations:[{type:"node_in",name:"me",qualifier:["float"],is_optional:false},{type:"node_in",name:"mf",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"mg",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"mh",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["float","mi","=","clamp","(","me",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","mh","=","mix","(","mf",",","mg",
",","mi",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["mh","=","clamp","(","mh",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_ADD",declarations:[{type:"node_in",name:"mj",qualifier:["float"],is_optional:false},{type:"node_in",name:"mk",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"ml",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"mm",qualifier:["vec3"],
is_optional:false}],statements:[{type:"textline",tokens:["float","mn","=","clamp","(","mj",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","mm","=","mix","(","mk",",","mk","+","ml",",","mn",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["mm","=","clamp","(","mm",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_MULTIPLY",declarations:[{type:"node_in",name:"mo",qualifier:["float"],
is_optional:false},{type:"node_in",name:"mp",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"mq",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"mr",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["float","ms","=","clamp","(","mo",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","mr","=","mix","(","mp",",","mp","*","mq",",","ms",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",
tokens:["mr","=","clamp","(","mr",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_SUBTRACT",declarations:[{type:"node_in",name:"mt",qualifier:["float"],is_optional:false},{type:"node_in",name:"mu",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"mv",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"mw",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["float","mx","=","clamp","(","mt",",","ZERO_VALUE_NODES",
",","UNITY_VALUE_NODES",")",";","mw","=","mix","(","mu",",","mu","-","mv",",","mx",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["mw","=","clamp","(","mw",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_SCREEN",declarations:[{type:"node_in",name:"my",qualifier:["float"],is_optional:false},{type:"node_in",name:"mz",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"mA",
qualifier:["vec3"],is_optional:false},{type:"node_out",name:"mB",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["float","mC","=","clamp","(","my",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","float","mD","=","UNITY_VALUE_NODES","-","mC",";","mB","=","eO","-","(","vec3","(","mD",")","+","mC","*","(","eO","-","mA",")",")","*","(","eO","-","mz",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",
tokens:["mB","=","clamp","(","mB",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_DIVIDE",declarations:[{type:"node_in",name:"mE",qualifier:["float"],is_optional:false},{type:"node_in",name:"mF",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"mG",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"mH",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["float","mI","=","clamp","(","mE",",","ZERO_VALUE_NODES",",",
"UNITY_VALUE_NODES",")",";","float","mJ","=","UNITY_VALUE_NODES","-","mI",";","mG","+=","step","(","mG",",","eN",")",";","mH","=","mJ","*","mF","+","mI","*","mF","/","mG",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["mH","=","clamp","(","mH",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_DIFFERENCE",declarations:[{type:"node_in",name:"mK",qualifier:["float"],is_optional:false},{type:"node_in",
name:"mL",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"mM",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"mN",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["float","mO","=","clamp","(","mK",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","mN","=","mix","(","mL",",","abs","(","mL","-","mM",")",",","mO",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["mN","=",
"clamp","(","mN",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_DARKEN",declarations:[{type:"node_in",name:"mP",qualifier:["float"],is_optional:false},{type:"node_in",name:"mQ",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"mR",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"mS",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["float","mT","=","clamp","(","mP",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",
")",";","mS","=","min","(","mQ",".","rgb",",","mR",".","rgb","*","mT",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["mS","=","clamp","(","mS",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_LIGHTEN",declarations:[{type:"node_in",name:"mU",qualifier:["float"],is_optional:false},{type:"node_in",name:"mV",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"mW",qualifier:["vec3"],
is_optional:false},{type:"node_out",name:"mX",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["float","mY","=","clamp","(","mU",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","mX","=","max","(","mV",".","rgb",",","mW",".","rgb","*","mY",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["mX","=","clamp","(","mX",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",
name:"MIX_RGB_OVERLAY",declarations:[{type:"node_in",name:"mZ",qualifier:["float"],is_optional:false},{type:"node_in",name:"m_",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"na",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"nb",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["float","nc","=","clamp","(","mZ",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","vec3","nd","=","vec3","(","UNITY_VALUE_NODES","-","nc",")",";","nb","=","mix",
"(","m_","*","(","nd","+","2.0","*","nc","*","na",")",",","eO","-","(","nd","+","2.0","*","nc","*","(","eO","-","na",")",")","*","(","eO","-","m_",")",",","step","(","0.5",",","m_",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["nb","=","clamp","(","nb",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_DODGE",declarations:[{type:"node_in",name:"ne",qualifier:["float"],is_optional:false},
{type:"node_in",name:"nf",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"ng",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"nh",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["float","ni","=","clamp","(","ne",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","vec3","nj","=","eO","-","ni","*","ng",";","vec3","nk","=","clamp","(","nf","/","nj",",","0.0",",","1.0",")",";","nh","=","mix","(","mix","(","nk",",","eO",",","step","(","nj",",","eN",
")",")",",","nf",",","step","(","nf",",","eN",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["nh","=","clamp","(","nh",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_BURN",declarations:[{type:"node_in",name:"nl",qualifier:["float"],is_optional:false},{type:"node_in",name:"nm",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"nn",qualifier:["vec3"],is_optional:false},
{type:"node_out",name:"no",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["float","np","=","clamp","(","nl",",","0.0",",","1.0",")",";","vec3","nq","=","vec3","(","1.0","-","np",")",";","vec3","nr","=","nq","+","np","*","nn",";","vec3","ns","=","clamp","(","eO","-","(","eO","-","nm",")","/","nr",",","0.0",",","1.0",")",";","no","=","mix","(","ns",",","eN",",","step","(","nr",",","eN",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],
statements:[{type:"textline",tokens:["no","=","clamp","(","no",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_HUE",declarations:[{type:"node_in",name:"nt",qualifier:["float"],is_optional:false},{type:"node_in",name:"nu",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"nv",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"nw",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["float","nx","=","clamp","(","nt",
",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","vec3","ny",",","nz",",","nA",";","nw","=","nu",";","nz","=","eZ","(","nv",")",";","if","(","nz",".","y","!=","ZERO_VALUE_NODES",")","{","ny","=","eZ","(","nw",")",";","ny",".","x","=","nz",".","x",";","nA","=","fc","(","ny",")",";","nw","=","mix","(","nw",",","nA",",","nx",")",";","}"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["nw","=","clamp","(","nw",",","ZERO_VALUE_NODES",
",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_SATURATION",declarations:[{type:"node_in",name:"nB",qualifier:["float"],is_optional:false},{type:"node_in",name:"nC",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"nD",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"nE",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["float","nF","=","clamp","(","nB",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","float","nG","=","UNITY_VALUE_NODES",
"-","nF",";","nE","=","nC",";","vec3","nH",",","nI",";","nH","=","eZ","(","nE",")",";","if","(","nH",".","y","!=","ZERO_VALUE_NODES",")","{","nI","=","eZ","(","nD",")",";","nH",".","y","=","nG","*","nH",".","y","+","nF","*","nI",".","y",";","nE","=","fc","(","nH",")",";","}"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["nE","=","clamp","(","nE",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_VALUE",
declarations:[{type:"node_in",name:"nJ",qualifier:["float"],is_optional:false},{type:"node_in",name:"nK",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"nL",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"nM",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["float","nN","=","clamp","(","nJ",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","float","nO","=","UNITY_VALUE_NODES","-","nN",";","vec3","nP",",","nQ",";","nP","=","eZ","(","nK",")",
";","nQ","=","eZ","(","nL",")",";","nP",".","z","=","nO","*","nP",".","z","+","nN","*","nQ",".","z",";","nM","=","fc","(","nP",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["nM","=","clamp","(","nM",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_COLOR",declarations:[{type:"node_in",name:"nR",qualifier:["float"],is_optional:false},{type:"node_in",name:"nS",qualifier:["vec3"],is_optional:false},
{type:"node_in",name:"nT",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"nU",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["float","nV","=","clamp","(","nR",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","vec3","nW",",","nX",",","nY",";","nU","=","nS",";","nX","=","eZ","(","nT",")",";","if","(","nX",".","y","!=","ZERO_VALUE_NODES",")","{","nW","=","eZ","(","nU",")",";","nW",".","x","=","nX",".","x",";","nW",".","y","=","nX",".","y",";","nY","=",
"fc","(","nW",")",";","nU","=","mix","(","nU",",","nY",",","nV",")",";","}"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["nU","=","clamp","(","nU",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_SOFT_LIGHT",declarations:[{type:"node_in",name:"nZ",qualifier:["float"],is_optional:false},{type:"node_in",name:"n_",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"oa",qualifier:["vec3"],
is_optional:false},{type:"node_out",name:"ob",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["float","oc","=","clamp","(","nZ",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","float","od","=","UNITY_VALUE_NODES","-","oc",";","vec3","oe","=","oa","+","n_","-","oa","*","n_",";","ob","=","n_","*","(","vec3","(","od",")","+","vec3","(","oc",")","*","(","(","eO","-","n_",")","*","oa","+","oe",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],
statements:[{type:"textline",tokens:["ob","=","clamp","(","ob",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_LINEAR_LIGHT",declarations:[{type:"node_in",name:"of",qualifier:["float"],is_optional:false},{type:"node_in",name:"og",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"oh",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"oi",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["float","oj","=","clamp",
"(","of",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","oi","=","og","+","oj","*","(","2.0","*","oh","-","eO",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["oi","=","clamp","(","oi",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"OUTPUT",declarations:[{type:"node_in",name:"ok",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"ol",qualifier:["float"],is_optional:false}],
statements:[{type:"textline",tokens:["fv","=","ok",";","fz","=","ol",";"]}]},{type:"node",name:"MATERIAL_BEGIN",declarations:[{type:"node_in",name:"om",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"on",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"oo",qualifier:["float"],is_optional:false},{type:"node_in",name:"op",qualifier:["vec3"],is_optional:true},{type:"node_in",name:"oq",qualifier:["float"],is_optional:true},{type:"node_out",name:"or",qualifier:["vec3"],is_optional:false},
{type:"node_out",name:"os",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"ot",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"ou",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"ov",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"ow",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"ox",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"oy",qualifier:["float"],is_optional:false},{type:"node_param",name:"fq",qualifier:["const",
"vec2"]},{type:"node_param",name:"fr",qualifier:["const","vec3"]}],statements:[{type:"textline",tokens:["ot","=","clamp","(","om",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]},{type:"textline",tokens:["ou","=","fr","[","0","]","*","clamp","(","on",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_MATERIAL_NORMAL"],statements:[{type:"textline",tokens:["ov","=","normalize","(","op",")",";"]}]},{type:"node_else",statements:[{type:"textline",
tokens:["ov","=","fC",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["SHADELESS_MAT",{type:"logic_negative_expr",places:1},"NODES_GLOW",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["MATERIAL_EXT"],statements:[{type:"textline",tokens:["or","=","oq","*","ot",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["or","=","fJ","*","ot",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",
expression:["USE_MATERIAL_DIFFUSE"],statements:[{type:"textline",tokens:["ot","*=","oo",";"]}]}]},{type:"textline",tokens:["os","=","fK","*","u_environment_energy","*","ew","(","ov",")",";","oy","=","dY","(","ot",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["NUM_LIGHTS",0,{type:"g_expr",places:2}],statements:[{type:"textline",tokens:["ow","=","vec2","(","fq","[","0","]",",","fq","[","1","]",")",";"]},{type:"textline",tokens:["ox","=","vec2","(","fr","[","1","]",",","fr","[",
"2","]",")",";"]}]}]},{type:"textline",tokens:["fy","=","oy",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["or","=","eN",";","os","=","eO",";"]}]}]}]},{type:"node",name:"MATERIAL_END",declarations:[{type:"node_in",name:"oz",qualifier:["vec4"],is_optional:false},{type:"node_in",name:"oA",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"oB",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"oC",qualifier:["float"],is_optional:true},{type:"node_in",name:"oD",qualifier:["float"],
is_optional:true},{type:"node_in",name:"oE",qualifier:["float"],is_optional:true},{type:"node_out",name:"oF",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"oG",qualifier:["float"],is_optional:true},{type:"node_out",name:"oH",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"oI",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"oJ",qualifier:["vec3"],is_optional:true},{type:"node_param",name:"fs",qualifier:["float"]},{type:"node_param",name:"ft",qualifier:["float"]}],
statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_oF"],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_MATERIAL_DIFFUSE"],statements:[{type:"textline",tokens:["oF","=","oz",".","rgb",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["oF","=","eN",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["MATERIAL_EXT","REFLECTION_TYPE","REFL_NONE",{type:"non_equal_expr",places:2},{type:"logical_and_expr",places:2}],statements:[{type:"textline",
tokens:["et","(","oF",",","fu",",","oB",",","oC",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_MATERIAL_SPECULAR"],statements:[{type:"textline",tokens:["oF","+=","oA",";"]}]}]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_oH"],statements:[{type:"textline",tokens:["oH","=","oB",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["MATERIAL_EXT"],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_oI"],
statements:[{type:"textline",tokens:["oI","=","oz",".","rgb",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_oJ"],statements:[{type:"textline",tokens:["oJ","=","oA",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_oG"],statements:[{type:"textline",tokens:["oG","=","clamp","(","oE",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_MATERIAL_SPECULAR"],statements:[{type:"textline",
tokens:["float","oK","=","max","(","max","(","oA",".","r",",","oA",".","g",")",",","oA",".","b",")","*","oD",";","oG","=","clamp","(","oE","*","(","UNITY_VALUE_NODES","-","oK",")","+","oK",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]}]}]},{type:"node_else",statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_oG"],statements:[{type:"textline",tokens:["oG","=","clamp","(","fs",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]},{type:"node_condition",
parts:[{type:"node_if",expression:["USE_MATERIAL_SPECULAR"],statements:[{type:"textline",tokens:["float","oK","=","max","(","max","(","oA",".","r",",","oA",".","g",")",",","oA",".","b",")","*","ft",";","oG","=","fs","*","(","UNITY_VALUE_NODES","-","oK",")","+","oK",";"]}]}]}]}]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_MATERIAL_SPECULAR"],statements:[{type:"textline",tokens:["fw","=","oA",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["fw","=","eN",";"]}]}]},
{type:"textline",tokens:["fx","=","oB",";"]}]},{type:"node",name:"LIGHTING_AMBIENT",declarations:[{type:"node_in",name:"oL",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"oM",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"oN",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"oO",qualifier:["vec4"],is_optional:false},{type:"node_out",name:"oP",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["oO","=","vec4","(","oL","+","oN","*","oM",
",","ZERO_VALUE_NODES",")",";","oP","=","vec3","(","ZERO_VALUE_NODES",")",";"]}]},{type:"node",name:"LIGHTING_LAMP",declarations:[{type:"node_in",name:"oQ",qualifier:["float"],is_optional:false},{type:"node_out",name:"oR",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"oS",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"oT",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"oU",qualifier:["float"],is_optional:false}],statements:[{type:"node_condition",parts:[{type:"node_if",
expression:["NODES_GLOW",{type:"logic_negative_expr",places:1},"NUM_LIGHTS",0,{type:"g_expr",places:2},{type:"logical_and_expr",places:2}],statements:[{type:"textline",tokens:["oS","=","u_light_factors","[","LAMP_LIGHT_FACT_IND","]",".","LAMP_FAC_CHANNELS",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["LAMP_TYPE","HEMI",{type:"equal_expr",places:2}],statements:[{type:"textline",tokens:["oU","=","eM",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["oU","=","ZERO_VALUE_NODES",
";"]}]}]},{type:"textline",tokens:["oT","=","u_light_color_intensities","[","LAMP_IND","]",";","if","(","LAMP_SHADOW_MAP_IND","!=","-","1",")","oT","*=","oQ",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["LAMP_TYPE","SPOT",{type:"equal_expr",places:2},"LAMP_TYPE","POINT",{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],statements:[{type:"textline",tokens:["vec3","oV","=","u_light_positions","[","LAMP_IND","]",";","oR","=","oV","-","fH",";"]},{type:"textline",tokens:["float",
"oW","=","length","(","oR",")",";","oT","*=","LAMP_LIGHT_DIST","/","(","LAMP_LIGHT_DIST","+","oW","*","oW",")",";","oR","=","normalize","(","oR",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["LAMP_TYPE","SPOT",{type:"equal_expr",places:2}],statements:[{type:"textline",tokens:["vec3","oX","=","u_light_directions","[","LAMP_IND","]",";","float","oY","=","dot","(","oR",",","oX",")",";","oY","*=","smoothstep","(","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",",","(","oY","-","LAMP_SPOT_SIZE",
")","/","LAMP_SPOT_BLEND",")",";","oT","*=","oY",";"]}]}]}]},{type:"node_else",statements:[{type:"textline",tokens:["oR","=","u_light_directions","[","LAMP_IND","]",";"]}]}]}]}]}]},{type:"node",name:"DIFFUSE_FRESNEL",declarations:[{type:"node_in",name:"oZ",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"o_",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"pa",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"pb",qualifier:["float"],is_optional:false},{type:"node_in",
name:"pc",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"pd",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["pd","=","ZERO_VALUE_NODES",";","if","(","o_",".","r","!=","ZERO_VALUE_NODES",")","{","float","pe","=","(","UNITY_VALUE_NODES","-","pb",")","*","dot","(","pa",",","oZ",")","+","pb",";","if","(","pc","[","0","]","==","ZERO_VALUE_NODES",")","{","pd","=","UNITY_VALUE_NODES",";","}","else","{","float","pf","=","UNITY_VALUE_NODES","+","abs","(","pe",")",
";","pf","=","pc","[","1","]","+","(","UNITY_VALUE_NODES","-","pc","[","1","]",")","*","pow","(","pf",",","pc","[","0","]",")",";","pd","=","clamp","(","pf",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","}","pd","=","max","(","pd",",","ZERO_VALUE_NODES",")",";","}"]}]},{type:"node",name:"DIFFUSE_LAMBERT",declarations:[{type:"node_in",name:"pg",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"ph",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"pi",qualifier:["vec3"],
is_optional:false},{type:"node_in",name:"pj",qualifier:["float"],is_optional:false},{type:"node_out",name:"pk",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["pk","=","ZERO_VALUE_NODES",";","if","(","ph",".","r","!=","ZERO_VALUE_NODES",")","{","float","pl","=","(","UNITY_VALUE_NODES","-","pj",")","*","dot","(","pi",",","pg",")","+","pj",";","pk","=","max","(","pl",",","ZERO_VALUE_NODES",")",";","}"]}]},{type:"node",name:"DIFFUSE_OREN_NAYAR",declarations:[{type:"node_in",
name:"pm",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"pn",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"po",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"pp",qualifier:["float"],is_optional:false},{type:"node_in",name:"pq",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"pr",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["pr","=","ZERO_VALUE_NODES",";","if","(","pn",".","r","!=","ZERO_VALUE_NODES",")","{","float",
"ps","=","(","UNITY_VALUE_NODES","-","pp",")","*","dot","(","po",",","pm",")","+","pp",";","if","(","pq","[","0","]",">","ZERO_VALUE_NODES",")","{","float","pt","=","max","(","dot","(","po",",","fu",")",",","ZERO_VALUE_NODES",")",";","float","pu","=","pq","[","0","]","*","pq","[","0","]",";","float","pv","=","UNITY_VALUE_NODES","-","eM","*","(","pu","/","(","pu","+","0.33",")",")",";","vec3","pw","=","pm","-","ps","*","po",";","vec3","px","=","fu","-","pt","*","po",";"]},{type:"textline",tokens:["if",
"(","length","(","pw",")","==","ZERO_VALUE_NODES","||","length","(","px",")","==","ZERO_VALUE_NODES","||","abs","(","ps",")",">","UNITY_VALUE_NODES","||","abs","(","pt",")",">","UNITY_VALUE_NODES",")"]},{type:"textline",tokens:["pr","=","ps","*","pv",";","else","{","float","py","=","acos","(","ps",")",";","float","pz","=","acos","(","pt",")",";","vec3","pA","=","normalize","(","pw",")",";","vec3","pB","=","normalize","(","px",")",";","float","pC",",","pD",";","pC","=","max","(","py",",","pz",")",
";","pD","=","min","(","py",",","pz",")",";","pD","*=","0.95",";","float","pE","=","max","(","dot","(","pA",",","pB",")",",","ZERO_VALUE_NODES",")",";","float","pF","=","0.45","*","(","pu","/","(","pu","+","0.09",")",")",";","pr","=","ps","*","(","pv","+","(","pF","*","pE","*","sin","(","pC",")","*","tan","(","pD",")",")",")",";","}","}","else","pr","=","ps",";","pr","=","max","(","pr",",","ZERO_VALUE_NODES",")",";","}"]}]},{type:"node",name:"DIFFUSE_MINNAERT",declarations:[{type:"node_in",name:"pG",
qualifier:["vec3"],is_optional:false},{type:"node_in",name:"pH",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"pI",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"pJ",qualifier:["float"],is_optional:false},{type:"node_in",name:"pK",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"pL",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["pL","=","ZERO_VALUE_NODES",";","if","(","pH",".","r","!=","ZERO_VALUE_NODES",")","{","float","pM","=",
"(","UNITY_VALUE_NODES","-","pJ",")","*","dot","(","pI",",","pG",")","+","pJ",";","float","pN","=","max","(","dot","(","pI",",","fu",")",",","ZERO_VALUE_NODES",")",";","if","(","pK","[","0","]","<=","UNITY_VALUE_NODES",")","pL","=","pM","*","pow","(","max","(","pN","*","pM",",","0.1",")",",","pK","[","0","]","-","UNITY_VALUE_NODES",")",";","else","pL","=","pM","*","pow","(","1.0001","-","pN",",","pK","[","0","]","-","UNITY_VALUE_NODES",")",";","pL","=","max","(","pL",",","ZERO_VALUE_NODES",")",";",
"}"]}]},{type:"node",name:"DIFFUSE_TOON",declarations:[{type:"node_in",name:"pO",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"pP",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"pQ",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"pR",qualifier:["float"],is_optional:false},{type:"node_in",name:"pS",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"pT",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["pT","=","ZERO_VALUE_NODES",
";","if","(","pP",".","r","!=","ZERO_VALUE_NODES",")","{","float","pU","=","(","UNITY_VALUE_NODES","-","pR",")","*","dot","(","pQ",",","pO",")","+","pR",";","float","pV","=","acos","(","pU",")",";","if","(","pV","<","pS","[","0","]",")","pT","=","UNITY_VALUE_NODES",";","else","if","(","pV",">","(","pS","[","0","]","+","pS","[","1","]",")","||","pS","[","1","]","==","ZERO_VALUE_NODES",")","pT","=","ZERO_VALUE_NODES",";","else","pT","=","UNITY_VALUE_NODES","-","(","(","pV","-","pS","[","0","]",")",
"/","pS","[","1","]",")",";","pT","=","max","(","pT",",","ZERO_VALUE_NODES",")",";","}"]}]},{type:"node",name:"SPECULAR_PHONG",declarations:[{type:"node_in",name:"pW",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"pX",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"pY",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"pZ",qualifier:["float"],is_optional:false},{type:"node_in",name:"p_",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"qa",qualifier:["float"],
is_optional:false}],statements:[{type:"textline",tokens:["qa","=","ZERO_VALUE_NODES",";","if","(","pX",".","g","==","UNITY_VALUE_NODES",")","{","vec3","qb","=","normalize","(","pW","+","fu",")",";","qa","=","(","UNITY_VALUE_NODES","-","pZ",")","*","max","(","dot","(","pY",",","qb",")",",","ZERO_VALUE_NODES",")","+","pZ",";","qa","=","pow","(","qa",",","p_","[","0","]",")",";","}"]}]},{type:"node",name:"SPECULAR_WARDISO",declarations:[{type:"node_in",name:"qc",qualifier:["vec3"],is_optional:false},
{type:"node_in",name:"qd",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"qe",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"qf",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"qg",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["qg","=","ZERO_VALUE_NODES",";","if","(","qd",".","g","==","UNITY_VALUE_NODES",")","{","vec3","qh","=","normalize","(","qc","+","fu",")",";","float","qi","=","max","(","dot","(","qe",",","qh",")",",","0.001",
")",";"]},{type:"textline",tokens:["float","qj","=","max","(","dot","(","qe",",","fu",")",",","0.01",")",";","float","qk","=","max","(","dot","(","qe",",","qc",")",",","0.01",")",";","float","ql","=","tan","(","acos","(","qi",")",")",";","float","qm","=","max","(","qf","[","0","]",",","0.001",")",";","qg","=","qk","*","(","UNITY_VALUE_NODES","/","(","4.0","*","M_PI","*","qm","*","qm",")",")","*","(","exp","(","-","(","ql","*","ql",")","/","(","qm","*","qm",")",")","/","(","sqrt","(","qj","*","qk",
")",")",")",";","}"]}]},{type:"node",name:"SPECULAR_TOON",declarations:[{type:"node_in",name:"qn",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"qo",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"qp",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"qq",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"qr",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["qr","=","ZERO_VALUE_NODES",";","if","(","qo",".","g","==","UNITY_VALUE_NODES",
")","{","vec3","qs","=","normalize","(","qn","+","fu",")",";","float","qt","=","acos","(","dot","(","qs",",","qp",")",")",";","if","(","qt","<","qq","[","0","]",")","qr","=","UNITY_VALUE_NODES",";","else","if","(","qt",">=","qq","[","0","]","+","qq","[","1","]","||","qq","[","1","]","==","ZERO_VALUE_NODES",")","qr","=","ZERO_VALUE_NODES",";","else","qr","=","UNITY_VALUE_NODES","-","(","qt","-","qq","[","0","]",")","/","qq","[","1","]",";","}"]}]},{type:"node",name:"SPECULAR_BLINN",declarations:[{type:"node_in",
name:"qu",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"qv",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"qw",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"qx",qualifier:["float"],is_optional:false},{type:"node_in",name:"qy",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"qz",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["qz","=","ZERO_VALUE_NODES",";","if","(","qv",".","g","==","UNITY_VALUE_NODES",")","{","if",
"(","qy","[","0","]","<","1.0","||","qy","[","1","]","==","ZERO_VALUE_NODES",")","qz","=","ZERO_VALUE_NODES",";","else","{","if","(","qy","[","1","]","<","100.0",")","qy","[","1","]","=","sqrt","(","1.0","/","qy","[","1","]",")",";","else","qy","[","1","]","=","10.0","/","qy","[","1","]",";","vec3","qA","=","normalize","(","fu","+","qu",")",";","float","qB","=","(","UNITY_VALUE_NODES","-","qx",")","*","max","(","dot","(","qw",",","qA",")",",","ZERO_VALUE_NODES",")","+","qx",";","if","(","qB","<",
"ZERO_VALUE_NODES",")","qz","=","ZERO_VALUE_NODES",";","else","{","float","qC","=","max","(","dot","(","qw",",","fu",")",",","0.01",")",";","float","qD","=","dot","(","qw",",","qu",")",";","if","(","qD","<=","0.01",")","qz","=","ZERO_VALUE_NODES",";","else","{","float","qE","=","max","(","dot","(","fu",",","qA",")",",","0.01",")",";","float","qF","=","UNITY_VALUE_NODES",";","float","qG","=","(","2.0","*","qB","*","qC",")","/","qE",";","float","qH","=","(","2.0","*","qB","*","qD",")","/","qE",";",
"float","qI","=","min","(","min","(","qF",",","qG",")",",","qH",")",";","float","qJ","=","sqrt","(","pow","(","qy","[","0","]",",","2.0",")","+","pow","(","qE",",","2.0",")","-","UNITY_VALUE_NODES",")",";","float","qK","=","pow","(","qJ","-","qE",",","2.0",")","/","pow","(","qJ","+","qE",",","2.0",")","*","(","UNITY_VALUE_NODES","+","pow","(","qE","*","(","qJ","+","qE",")","-","UNITY_VALUE_NODES",",","2.0",")","/","pow","(","qE","*","(","qJ","-","qE",")","+","UNITY_VALUE_NODES",",","2.0",")",")",
";","float","qL","=","acos","(","qB",")",";","qz","=","max","(","qK","*","qI","*","exp","(","-","pow","(","qL",",","2.0",")","/","(","2.0","*","pow","(","qy","[","1","]",",","2.0",")",")",")",",","ZERO_VALUE_NODES",")",";","}","}","}","}"]}]},{type:"node",name:"LIGHTING_APPLY",declarations:[{type:"node_in",name:"qM",qualifier:["vec4"],is_optional:false},{type:"node_in",name:"qN",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"qO",qualifier:["float"],is_optional:false},{type:"node_in",
name:"qP",qualifier:["float"],is_optional:false},{type:"node_in",name:"qQ",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"qR",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"qS",qualifier:["vec4"],is_optional:false},{type:"node_in",name:"qT",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"qU",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"qV",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"qW",qualifier:["float"],is_optional:false},{type:"node_out",
name:"qX",qualifier:["vec4"],is_optional:false},{type:"node_out",name:"qY",qualifier:["vec3"],is_optional:false}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_NODE_B4W_TRANSLUCENCY"],statements:[{type:"textline",tokens:["if","(","dot","(","qQ",",","qR",")","*","dot","(","fu",",","qR",")","<","ZERO_VALUE_NODES",")","{","float","qZ","=","qS",".","x",";","float","q_","=","qS",".","y",";","float","ra","=","qS",".","z",";","float","rb","=","qS",".","w",";"]},{type:"textline",
tokens:["float","rc","=","clamp","(","abs","(","dot","(","qQ",",","qR",")",")",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","float","rd","=","clamp","(","dot","(","fu",",","-","qQ",")",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","float","re","=","pow","(","rd",",","q_",")",";"]},{type:"textline",tokens:["qX","=","qM","+","qW","*","vec4","(","qV","*","rc","*","pow","(","qT",",","vec3","(","qZ",")",")",",","UNITY_VALUE_NODES",")",";"]},{type:"textline",tokens:["qX","+=","ra","*",
"mix","(","vec4","(","qT",",","UNITY_VALUE_NODES",")",",","vec4","(","UNITY_VALUE_NODES",")",",","rb",")","*","qW","*","vec4","(","qV","*","rc","*","vec3","(","re",")",",","UNITY_VALUE_NODES",")",";","qY","=","qN",";","}","else","{"]},{type:"textline",tokens:["qY","=","qN","+","qV","*","qU","*","qP",";","qX","=","qM","+","vec4","(","qV","*","qT","*","qO",",","qP",")",";","}"]}]},{type:"node_else",statements:[{type:"textline",tokens:["qY","=","qN","+","qV","*","qU","*","qP",";","qX","=","qM","+","vec4",
"(","qV","*","qT","*","qO",",","qP",")",";"]}]}]}]},{type:"node",name:"RGB",declarations:[{type:"node_out",name:"rf",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["rf","=","u_node_rgbs","[","RGB_IND","]",";"]}]},{type:"node",name:"RGBTOBW",declarations:[{type:"node_in",name:"rg",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"rh",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["rh","=","dot","(","rg",",","vec3","(","0.35",",",
"0.45",",","0.2",")",")",";"]}]},{type:"node",name:"SEPRGB",declarations:[{type:"node_in",name:"ri",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"rj",qualifier:["float"],is_optional:true},{type:"node_out",name:"rk",qualifier:["float"],is_optional:true},{type:"node_out",name:"rl",qualifier:["float"],is_optional:true}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_rj"],statements:[{type:"textline",tokens:["rj","=","ri",".","r",";"]}]}]},{type:"node_condition",
parts:[{type:"node_if",expression:["USE_OUT_rk"],statements:[{type:"textline",tokens:["rk","=","ri",".","g",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_rl"],statements:[{type:"textline",tokens:["rl","=","ri",".","b",";"]}]}]}]},{type:"node",name:"SEPHSV",declarations:[{type:"node_in",name:"rm",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"rn",qualifier:["float"],is_optional:true},{type:"node_out",name:"ro",qualifier:["float"],is_optional:true},{type:"node_out",
name:"rp",qualifier:["float"],is_optional:true}],statements:[{type:"textline",tokens:["vec3","rq","=","eZ","(","rm",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_rn"],statements:[{type:"textline",tokens:["rn","=","rq",".","r",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_ro"],statements:[{type:"textline",tokens:["ro","=","rq",".","g",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_rp"],statements:[{type:"textline",
tokens:["rp","=","rq",".","b",";"]}]}]}]},{type:"node",name:"SQUEEZE",declarations:[{type:"node_in",name:"rr",qualifier:["float"],is_optional:false},{type:"node_in",name:"rs",qualifier:["float"],is_optional:false},{type:"node_in",name:"rt",qualifier:["float"],is_optional:false},{type:"node_out",name:"ru",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["ru","=","UNITY_VALUE_NODES","/","(","UNITY_VALUE_NODES","+","pow","(","2.71828183",",","-","(","(","rr","-","rt",")",
"*","rs",")",")",")",";"]}]},{type:"node",name:"GAMMA",declarations:[{type:"node_in",name:"rv",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"rw",qualifier:["float"],is_optional:false},{type:"node_out",name:"rx",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["rx","=","max","(","eN",",","rv",")",";","rx","=","pow","(","rx",",","vec3","(","rw",")",")",";"]}]},{type:"node",name:"B4W_SRGB_TO_LINEAR",declarations:[{type:"node_in",name:"ry",qualifier:["vec3"],is_optional:false},
{type:"node_out",name:"rz",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["rz","=","max","(","eN",",","ry",")",";","rz","=","pow","(","rz",",","vec3","(","2.2",")",")",";"]}]},{type:"node",name:"B4W_LINEAR_TO_SRGB",declarations:[{type:"node_in",name:"rA",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"rB",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["rB","=","max","(","eN",",","rA",")",";","rB","=","pow","(","rB",",","vec3",
"(","UNITY_VALUE_NODES","/","2.2",")",")",";"]}]},{type:"node",name:"TEXTURE_EMPTY",declarations:[{type:"node_out",name:"rC",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"rD",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"rE",qualifier:["float"],is_optional:false}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_rE"],statements:[{type:"textline",tokens:["rC","[","2","]","=","rC","[","1","]","=","rC","[","0","]","=","0.0",";"]}]}]},{type:"node_condition",
parts:[{type:"node_if",expression:["USE_OUT_rE"],statements:[{type:"textline",tokens:["rD","[","2","]","=","rD","[","1","]","=","rD","[","0","]","=","0.0",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_rE"],statements:[{type:"textline",tokens:["rE","=","0.0",";"]}]}]}]},{type:"node",name:"TEXTURE_ENVIRONMENT",declarations:[{type:"node_in",name:"rF",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"rG",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"rH",
qualifier:["float"],is_optional:true},{type:"node_param",name:"node_TEXTURE_ENVIRONMENT_var_texture",qualifier:["uniform","samplerCube"]}],statements:[{type:"textline",tokens:["vec4","rI","=","textureCube","(","node_TEXTURE_ENVIRONMENT_var_texture",",","rF",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_rG"],statements:[{type:"textline",tokens:["rG","=","rI",".","xyz",";","a_","(","rG",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_rH"],
statements:[{type:"textline",tokens:["rH","=","rI",".","w",";"]}]}]}]},{type:"node",name:"TEXTURE_COLOR",declarations:[{type:"node_in",name:"rJ",qualifier:["vec3"],is_optional:true},{type:"node_in",name:"rK",qualifier:["vec3"],is_optional:true},{type:"node_in",name:"rL",qualifier:["vec3"],is_optional:true},{type:"node_in",name:"rM",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"rN",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"rO",qualifier:["float"],is_optional:true},{type:"node_out",
name:"rP",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"rQ",qualifier:["float"],is_optional:true},{type:"node_out",name:"rR",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"rS",qualifier:["float"],is_optional:true},{type:"node_out",name:"rT",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"rU",qualifier:["float"],is_optional:true},{type:"node_param",name:"node_TEXTURE_COLOR_var_texture",qualifier:["uniform","sampler2D"]}],statements:[{type:"textline",tokens:["vec4",
"rV","=","texture2D","(","node_TEXTURE_COLOR_var_texture",",","fg","(","rJ",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_rN"],statements:[{type:"textline",tokens:["rN","=","rV",".","xyz",";","a_","(","rN",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_rO"],statements:[{type:"textline",tokens:["rO","=","rV",".","w",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_uv2"],statements:[{type:"textline",tokens:["rV",
"=","texture2D","(","node_TEXTURE_COLOR_var_texture",",","fg","(","rK",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_rP"],statements:[{type:"textline",tokens:["rP","=","rV",".","xyz",";","a_","(","rP",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_rQ"],statements:[{type:"textline",tokens:["rQ","=","rV",".","w",";"]}]}]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_uv3"],statements:[{type:"textline",tokens:["rV",
"=","texture2D","(","node_TEXTURE_COLOR_var_texture",",","fg","(","rL",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_rR"],statements:[{type:"textline",tokens:["rR","=","rV",".","xyz",";","a_","(","rR",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_rS"],statements:[{type:"textline",tokens:["rS","=","rV",".","w",";"]}]}]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_uv4"],statements:[{type:"textline",tokens:["rV",
"=","texture2D","(","node_TEXTURE_COLOR_var_texture",",","fg","(","rM",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_rT"],statements:[{type:"textline",tokens:["rT","=","rV",".","xyz",";","a_","(","rT",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_rU"],statements:[{type:"textline",tokens:["rU","=","rV",".","w",";"]}]}]}]}]}]},{type:"node",name:"TEXTURE_NORMAL",declarations:[{type:"node_in",name:"rW",qualifier:["vec3"],is_optional:true},
{type:"node_in",name:"rX",qualifier:["vec3"],is_optional:true},{type:"node_in",name:"rY",qualifier:["vec3"],is_optional:true},{type:"node_in",name:"rZ",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"r_",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"sa",qualifier:["float"],is_optional:true},{type:"node_out",name:"sb",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"sc",qualifier:["float"],is_optional:true},{type:"node_out",name:"sd",qualifier:["vec3"],is_optional:true},
{type:"node_out",name:"se",qualifier:["float"],is_optional:true},{type:"node_out",name:"sf",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"sg",qualifier:["float"],is_optional:true},{type:"node_param",name:"node_TEXTURE_NORMAL_var_texture",qualifier:["uniform","sampler2D"]}],statements:[{type:"textline",tokens:["vec4","sh","=","texture2D","(","node_TEXTURE_NORMAL_var_texture",",","fg","(","rW",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_r_"],statements:[{type:"textline",
tokens:["r_","=","normalize","(","fG","*","(","sh",".","xyz","-","0.5",")",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_sa"],statements:[{type:"textline",tokens:["sa","=","sh",".","w",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_uv2"],statements:[{type:"textline",tokens:["sh","=","texture2D","(","node_TEXTURE_NORMAL_var_texture",",","fg","(","rX",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_sb"],statements:[{type:"textline",
tokens:["sb","=","normalize","(","fG","*","(","sh",".","xyz","-","0.5",")",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_sc"],statements:[{type:"textline",tokens:["sc","=","sh",".","w",";"]}]}]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_uv3"],statements:[{type:"textline",tokens:["sh","=","texture2D","(","node_TEXTURE_NORMAL_var_texture",",","fg","(","rY",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_sd"],
statements:[{type:"textline",tokens:["sd","=","normalize","(","fG","*","(","sh",".","xyz","-","0.5",")",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_se"],statements:[{type:"textline",tokens:["se","=","sh",".","w",";"]}]}]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_uv4"],statements:[{type:"textline",tokens:["sh","=","texture2D","(","node_TEXTURE_NORMAL_var_texture",",","fg","(","rZ",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",
expression:["USE_OUT_sf"],statements:[{type:"textline",tokens:["sf","=","normalize","(","fG","*","(","sh",".","xyz","-","0.5",")",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_sg"],statements:[{type:"textline",tokens:["sg","=","sh",".","w",";"]}]}]}]}]}]},{type:"node",name:"VALUE",declarations:[{type:"node_out",name:"si",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["si","=","u_node_values","[","VALUE_IND","]",";"]}]},{type:"node",
name:"VECT_MATH_ADD",declarations:[{type:"node_in",name:"sj",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"sk",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"sl",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"sm",qualifier:["float"],is_optional:true}],statements:[{type:"textline",tokens:["sl","=","sj","+","sk",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_sm"],statements:[{type:"textline",tokens:["sm","=","(","abs","(","sl","[",
"0","]",")","+","abs","(","sl","[","1","]",")","+","abs","(","sl","[","2","]",")",")","/","3.0",";"]}]}]}]},{type:"node",name:"VECT_MATH_SUBTRACT",declarations:[{type:"node_in",name:"sn",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"so",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"sp",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"sq",qualifier:["float"],is_optional:true}],statements:[{type:"textline",tokens:["sp","=","sn","-","so",";"]},{type:"node_condition",
parts:[{type:"node_if",expression:["USE_OUT_sq"],statements:[{type:"textline",tokens:["sq","=","(","abs","(","sp","[","0","]",")","+","abs","(","sp","[","1","]",")","+","abs","(","sp","[","2","]",")",")","/","3.0",";"]}]}]}]},{type:"node",name:"VECT_MATH_AVERAGE",declarations:[{type:"node_in",name:"sr",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"ss",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"st",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"su",qualifier:["float"],
is_optional:true}],statements:[{type:"textline",tokens:["st","=","sr","+","ss",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_su"],statements:[{type:"textline",tokens:["su","=","length","(","st",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_st"],statements:[{type:"textline",tokens:["st","=","normalize","(","st",")",";"]}]}]}]},{type:"node",name:"VECT_MATH_DOT_PRODUCT",declarations:[{type:"node_in",name:"sv",qualifier:["vec3"],is_optional:false},
{type:"node_in",name:"sw",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"sx",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"sy",qualifier:["float"],is_optional:true}],statements:[{type:"textline",tokens:["sx","=","eN",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_sy"],statements:[{type:"textline",tokens:["sy","=","dot","(","sv",",","sw",")",";"]}]}]}]},{type:"node",name:"VECT_MATH_CROSS_PRODUCT",declarations:[{type:"node_in",name:"sz",qualifier:["vec3"],
is_optional:false},{type:"node_in",name:"sA",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"sB",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"sC",qualifier:["float"],is_optional:true}],statements:[{type:"textline",tokens:["sB","=","cross","(","sz",",","sA",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_sC"],statements:[{type:"textline",tokens:["sC","=","length","(","sB",")",";"]}]}]}]},{type:"node",name:"VECT_MATH_NORMALIZE",declarations:[{type:"node_in",
name:"sD",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"sE",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"sF",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"sG",qualifier:["float"],is_optional:true}],statements:[{type:"textline",tokens:["sF","=","normalize","(","sD",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_sG"],statements:[{type:"textline",tokens:["sG","=","length","(","sD",")",";"]}]}]},{type:"textline",tokens:["sE",";"]}]},
{type:"node",name:"B4W_REFLECT",declarations:[{type:"node_in",name:"sH",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"sI",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"sJ",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["sJ","=","reflect","(","-","sH",",","sI",")",";"]}]},{type:"node",name:"B4W_PARALLAX",declarations:[{type:"node_in",name:"sK",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"sL",qualifier:["float"],is_optional:false},
{type:"node_in",name:"sM",qualifier:["const","float"],is_optional:false},{type:"node_in",name:"sN",qualifier:["const","float"],is_optional:false},{type:"node_out",name:"sO",qualifier:["vec3"],is_optional:false},{type:"node_param",name:"node_B4W_PARALLAX_var_texture",qualifier:["uniform","sampler2D"]}],statements:[{type:"textline",tokens:["float","sP","=","length","(","fI",")",";","if","(","sP","<","sN",")","{","vec2","sQ","=","fg","(","sK",")",";","float","sR","=","clamp","(","0.5","*","(","sN","-",
"sP",")",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","float","sS","=","sL","*","sR",";"]},{type:"textline",tokens:["vec3","sT","=","normalize","(","fu","*","fG",")",";"]},{type:"textline",tokens:["float","sU","=","UNITY_VALUE_NODES","/","sM",";"]},{type:"textline",tokens:["vec2","sV","=","sT",".","xy","*","sS","/","(","sM","*","sT",".","z",")",";","float","sW","=","UNITY_VALUE_NODES",";","float","sX","=","texture2D","(","node_B4W_PARALLAX_var_texture",",","sQ",")",".","a",";"]},{type:"textline",
tokens:["for","(","float","sY","=","1.0",";","sY","<=","sM",";","sY","++",")","{","if","(","sX","<","sW",")","{","sW","-=","sU",";","sQ","-=","sV",";","sX","=","texture2D","(","node_B4W_PARALLAX_var_texture",",","sQ",")",".","a",";","}","}"]},{type:"textline",tokens:["vec2","sZ","=","sQ","+","sV",";","float","s_","=","texture2D","(","node_B4W_PARALLAX_var_texture",",","sZ",")",".","a","-","(","sW","+","sU",")",";","float","ta","=","sX","-","sW",";","float","tb","=","ta","/","(","ta","-","s_",")",
";"]},{type:"textline",tokens:["sQ","=","tb","*","sZ","+","(","UNITY_VALUE_NODES","-","tb",")","*","sQ",";","sO","=","fe","(","sQ",")",";","}","else","sO","=","sK",";"]}]},{type:"node",name:"B4W_CLAMP",declarations:[{type:"node_in",name:"tc",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"td",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["td","=","clamp","(","tc",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]},{type:"node",name:"B4W_REFRACTION",
declarations:[{type:"node_in",name:"te",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"tf",qualifier:["float"],is_optional:false},{type:"node_out",name:"tg",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["tg","=","eS","(","te",",","tf",")",";"]}]},{type:"node",name:"B4W_TRANSLUCENCY",declarations:[{type:"node_in",name:"th",qualifier:["float"],is_optional:false},{type:"node_in",name:"ti",qualifier:["float"],is_optional:false},{type:"node_in",name:"tj",qualifier:["float"],
is_optional:false},{type:"node_in",name:"tk",qualifier:["float"],is_optional:false},{type:"node_in",name:"tl",qualifier:["float"],is_optional:false},{type:"node_out",name:"tm",qualifier:["float"],is_optional:true},{type:"node_out",name:"tn",qualifier:["vec4"],is_optional:true}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_tm"],statements:[{type:"textline",tokens:["tm","=","th",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_tn"],statements:[{type:"textline",
tokens:["tn","=","vec4","(","ti",",","tj",",","tk",",","tl",")",";"]}]}]}]},{type:"node",name:"B4W_TIME",declarations:[{type:"node_out",name:"to",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["to","=","u_time",";"]}]},{type:"node",name:"B4W_SMOOTHSTEP",declarations:[{type:"node_in",name:"tp",qualifier:["float"],is_optional:false},{type:"node_in",name:"tq",qualifier:["float"],is_optional:false},{type:"node_in",name:"tr",qualifier:["float"],is_optional:false},{type:"node_out",
name:"ts",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["ts","=","smoothstep","(","tq",",","tr",",","tp",")",";"]}]},{type:"node",name:"B4W_GLOW_OUTPUT",declarations:[{type:"node_in",name:"tt",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"tu",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["fv","=","tt",";","fz","=","tu",";"]}]},{type:"node",name:"B4W_VECTOSCAL",declarations:[{type:"node_in",name:"tv",qualifier:["vec3"],is_optional:false},
{type:"node_out",name:"tw",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["tw","=","(","tv",".","r","+","tv",".","g","+","tv",".","b",")","/","3.0",";"]}]},{type:"node",name:"B4W_SCALTOVEC",declarations:[{type:"node_in",name:"tx",qualifier:["float"],is_optional:false},{type:"node_out",name:"ty",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["ty","[","0","]","=","tx",";","ty","[","1","]","=","tx",";","ty","[","2","]","=","tx",";"]}]},{type:"nodes_global"},
{type:"textline",tokens:["void","tz","(","in","vec3","fu",",","out","vec3","fv",",","out","vec3","fw",",","out","vec3","fx",",","out","float","fy",",","out","float","fz",")","{","fv","=","eN",";","fw","=","eN",";","fx","=","eN",";","fy","=","ZERO_VALUE_NODES",";","fz","=","ZERO_VALUE_NODES",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","USE_NODE_TEX_COORD_NO",{type:"logical_or_expr",places:5}],group:{type:"group",
parts:[{type:"textline",tokens:["vec3","fA","=","normalize","(","bS",")",";","vec3","fB","=","fA",";"]},{type:"condition",parts:[{type:"if",expression:["DOUBLE_SIDED_LIGHTING","USE_NODE_GEOMETRY_NO",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["if","(","gl_FrontFacing",")","fB","=","fB",";","else","fB","=","-","fB",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DOUBLE_SIDED_LIGHTING"],group:{type:"group",parts:[{type:"textline",tokens:["vec3",
"fC","=","fB",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","fC","=","fA",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_GEOMETRY_NO"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","fD","=","fB",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","fE","=","cross","(","fB",",","bT",".","xyz",")","*","bT",".","w",";","mat3","fF","=","mat3","(",
"bT",".","xyz",",","fE",",","fB",")",";","mat3","fG","=","fF",";"]}]}}]},{type:"textline",tokens:["vec3","fH","=","bQ",";","vec4","fI","=","bR",";","float","fJ","=","u_emit",";","float","fK","=","u_ambient",";"]},{type:"nodes_main"},{type:"textline",tokens:["}"]}]},exports["include/to_world.glslv"]={type:"group",parts:[{type:"define",name:"M_PI",tokens:["3.14159265359"]},{type:"define",name:"MAX_BILLBOARD_ANGLE",tokens:["(","M_PI","/","4.0",")"]},{type:"textline",tokens:["const","vec3","tA","=","vec3",
"(","0.0",",","1.0",",","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD_SPHERICAL","BILLBOARD",{type:"logic_negative_expr",places:1},"BILLBOARD_ALIGN","BILLBOARD_ALIGN_VIEW",{type:"equal_expr",places:2},{type:"logical_and_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["mat4","tG","(","vec3","tB",",","mat4","tC",")","{","vec3","tD","=","vec3","(","tC","[","0","]","[","0","]",",","tC","[","1","]","[","0","]",",","tC",
"[","2","]","[","0","]",")",";","vec3","tE","=","vec3","(","tC","[","0","]","[","1","]",",","tC","[","1","]","[","1","]",",","tC","[","2","]","[","1","]",")",";","vec3","tF","=","vec3","(","tC","[","0","]","[","2","]",",","tC","[","1","]","[","2","]",",","tC","[","2","]","[","2","]",")",";","tE","=","cross","(","tF",",","tD",")",";","tD","=","normalize","(","tD",")",";","tE","=","normalize","(","tE",")",";","tF","=","normalize","(","tF",")",";","return","mat4","(","vec4","(","tD",",","0.0",")",",",
"vec4","(","tE",",","0.0",")",",","vec4","(","tF",",","0.0",")",",","vec4","(","tB",",","1.0",")",")",";","}"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["mat4","tM","(","vec3","tH",",","vec3","tI",")","{","vec3","tJ","=","tH","-","tI",";","tJ",".","y","=","0.0",";","vec3","tK","=","cross","(","tA",",","tJ",")",";","vec3","tL","=","cross","(","tJ",",","tK",")",";","tK","=","normalize","(","tK",")",";","tL","=","normalize","(","tL",")",";","tJ","=","normalize","(","tJ",")",
";","return","mat4","(","vec4","(","tK",",","0.0",")",",","vec4","(","tL",",","0.0",")",",","vec4","(","tJ",",","0.0",")",",","vec4","(","tI",",","1.0",")",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD_JITTERED"],group:{type:"group",parts:[{type:"textline",tokens:["mat4","tW","(","in","vec3","tN",",","float","tO",",","float","tP",",","float","tQ",",","vec3","tR",")","{","float","tS","=","fract","(","length","(","tR",")","/","0.17",")",";","float","tT","=","tQ","+",
"tS","/","10.0",";","float","tU","=","tS",";","if","(","tQ","!=","0.0",")","tU","/=","tQ",";","tN","*=","1.0","+","0.5","*","sin","(","tO",")",";","float","tV","=","length","(","tN",")","*","tP","*","sin","(","2.0","*","3.14","*","tO","*","tT","+","tU",")",";","return","bH","(","tV",")",";","}"]}]}}]},{type:"textline",tokens:["mat4","ug","(","in","vec3","tX",",","in","vec3","tY",",","in","mat4","tZ",")","{"]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD_SPHERICAL","BILLBOARD",{type:"logic_negative_expr",
places:1},"BILLBOARD_ALIGN","BILLBOARD_ALIGN_VIEW",{type:"equal_expr",places:2},{type:"logical_and_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["mat4","t_","=","tG","(","tY",",","tZ",")",";"]}]}},{type:"elif",expression:["BILLBOARD_RANDOM"],group:{type:"group",parts:[{type:"textline",tokens:["float","ua","=","fract","(","(","tY",".","x","*","1.43","+","tY",".","y","*","0.123","+","tY",".","z","*","6.1",")",")",";","float","ub","=","2.0","*",
"M_PI","*","ua",";","vec3","uc","=","normalize","(","vec3","(","tZ","[","0","]","[","2","]",",","0.0",",","tZ","[","2","]","[","2","]",")",")",";","float","ud","=","acos","(","uc","[","2","]",")",";","if","(","uc","[","0","]","<","0.0",")","ud","=","2.0","*","M_PI","-","ud",";","float","ue","=","ud","-","ub",";","if","(","ue","<","0.0",")","ue","=","2.0","*","M_PI","+","ue",";","float","uf","=","ub",";","if","(","ue","<=","MAX_BILLBOARD_ANGLE",")","uf","+=","ue",";","else","if","(","ue","<=","M_PI",
"-","MAX_BILLBOARD_ANGLE",")","uf","+=","MAX_BILLBOARD_ANGLE","*","(","2.0","*","ue","-","M_PI",")","/","(","2.0","*","MAX_BILLBOARD_ANGLE","-","M_PI",")",";","else","if","(","ue","<=","M_PI","+","MAX_BILLBOARD_ANGLE",")","uf","+=","ue","-","M_PI",";","else","if","(","ue","<=","2.0","*","M_PI","-","MAX_BILLBOARD_ANGLE",")","uf","+=","MAX_BILLBOARD_ANGLE","*","(","2.0","*","ue","-","M_PI",")","/","(","2.0","*","MAX_BILLBOARD_ANGLE","-","M_PI",")","+","M_PI",";","else","uf","+=","ue","-","2.0","*",
"M_PI",";","mat4","t_","=","bF","(","uf",")",";","t_","[","3","]","=","vec4","(","tY",",","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["mat4","t_","=","tM","(","tX",",","tY",")",";"]}]}}]},{type:"textline",tokens:["return","t_",";","}"]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD_PRES_GLOB_ORIENTATION","STATIC_BATCH",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["mat4",
"um","(","in","vec3","uh",",","in","vec3","ui",",","in","mat4","uj",",","mat4","uk",")","{","mat4","ul","=","ug","(","uh",",","ui",",","uj",")",";","uk","[","3","]","=","vec4","(","0.0",",","0.0",",","0.0",",","1.0",")",";","ul","=","ul","*","uk",";","return","ul",";","}"]}]}}]},{type:"textline",tokens:["bh","ut","(","in","vec3","un",",","in","vec3","uo",",","in","vec3","up",",","in","vec3","uq",",","in","vec3","ur",",","in","mat4","us",")","{","un","=","(","us","*","vec4","(","un",",","1.0",")",
")",".","xyz",";","uo","=","(","us","*","vec4","(","uo",",","1.0",")",")",".","xyz",";","up","=","(","us","*","vec4","(","up",",","0.0",")",")",".","xyz",";","uq","=","(","us","*","vec4","(","uq",",","0.0",")",")",".","xyz",";","ur","=","(","us","*","vec4","(","ur",",","0.0",")",")",".","xyz",";","return","bJ","(","bh","(","un",",","uo",",","up",",","uq",",","ur",",","vec3","(","0.0",")",")",")",";","}"]}]},exports["include/scale_texcoord.glslv"]={type:"group",parts:[{type:"textline",tokens:["vec2",
"uw","(","vec2","uu",",","vec3","uv",")","{","return","(","uu","+","0.5",")","*","uv",".","xy","-","0.5",";","}"]}]},exports["include/skin.glslv"]={type:"group",parts:[{type:"define",name:"SKIN_SLERP",tokens:["0"]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["SKIN_SLERP"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","uF","(","in","vec4","ux",",","in","vec4","uy",",","in","float","uz",")","{","float",
"uA","=","ux","[","0","]","*","uy","[","0","]","+","ux","[","1","]","*","uy","[","1","]","+","ux","[","2","]","*","uy","[","2","]","+","ux","[","3","]","*","uy","[","3","]",";","if","(","uA","<","0.0",")","{","uy","*=","-","1.0",";","uA","=","-","uA",";","}","if","(","abs","(","uA",")",">=","1.0",")","return","ux",";","float","uB","=","acos","(","uA",")",";","float","uC","=","sqrt","(","1.0","-","uA","*","uA",")",";","if","(","abs","(","uC",")","<","0.001",")","return","vec4","(","ux","*","0.5","+",
"uy","*","0.5",")",";","float","uD","=","sin","(","(","1.0","-","uz",")","*","uB",")","/","uC",";","float","uE","=","sin","(","uz","*","uB",")","/","uC",";","return","ux","*","uD","+","uy","*","uE",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["FRAMES_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","uV","(","in","vec3","uG",",","in","vec4","uH",",","in","vec4","uI",",","in","vec4","uJ",",","in","vec4","uK",",","in","float","uL",")","{","vec3","uM","=","bu","(",
"u_arm_rel_trans",",","u_arm_rel_quat",",","vec4","(","uG",",","1.0",")",")",";"]},{type:"condition",parts:[{type:"if",expression:["SKIN_SLERP"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","uN","=","uF","(","uH",",","uI",",","uL",")",";","vec4","uO","=","mix","(","uJ",",","uK",",","uL",")",";","vec3","uP","=","bn","(","uN",",","uM",")",";","vec3","uQ","=","uP","*","uO",".","w","+","uO",".","xyz",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","uR","=",
"bn","(","uH",",","uM",")",";","vec3","uS","=","bn","(","uI",",","uM",")",";","vec3","uT","=","uR","*","uJ",".","w","+","uJ",".","xyz",";","vec3","uU","=","uS","*","uK",".","w","+","uK",".","xyz",";","vec3","uQ","=","mix","(","uT",",","uU",",","uL",")",";"]}]}}]},{type:"textline",tokens:["return","bA","(","u_arm_rel_trans",",","u_arm_rel_quat",",","vec4","(","uQ",",","1.0",")",")",";","}","vec3","ve","(","in","vec3","uW",",","in","vec4","uX",",","in","vec4","uY",",","in","float","uZ",")","{","vec3",
"u_","=","bu","(","u_arm_rel_trans",",","u_arm_rel_quat",",","vec4","(","uW",",","0.0",")",")",";"]},{type:"condition",parts:[{type:"if",expression:["SKIN_SLERP"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","va","=","uF","(","uX",",","uY",",","uZ",")",";","vec3","vb","=","bn","(","va",",","u_",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","vc","=","bn","(","uX",",","u_",")",";","vec3","vd","=","bn","(","uY",",","u_",")",";","vec3","vb","=","mix",
"(","vc",",","vd",",","uZ",")",";"]}]}}]},{type:"textline",tokens:["return","bA","(","u_arm_rel_trans",",","u_arm_rel_quat",",","vec4","(","vb",",","0.0",")",")",";","}"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","uV","(","in","vec3","vf",",","in","vec4","vg",",","in","vec4","vh",")","{","vec3","vi","=","bu","(","u_arm_rel_trans",",","u_arm_rel_quat",",","vec4","(","vf",",","1.0",")",")",";","vec3","vj","=","bn","(","vg",",","vi",")",";","vec3","vk","=","vj","*",
"vh",".","w","+","vh",".","xyz",";","return","bA","(","u_arm_rel_trans",",","u_arm_rel_quat",",","vec4","(","vk",",","1.0",")",")",";","}","vec3","ve","(","in","vec3","vl",",","in","vec4","vm",")","{","vec3","vn","=","bu","(","u_arm_rel_trans",",","u_arm_rel_quat",",","vec4","(","vl",",","0.0",")",")",";","vec3","vo","=","bn","(","vm",",","vn",")",";","return","bA","(","u_arm_rel_trans",",","u_arm_rel_quat",",","vec4","(","vo",",","0.0",")",")",";","}"]}]}}]},{type:"textline",tokens:["void","vD",
"(","inout","vec3","vp",",","inout","vec3","vq",",","inout","vec3","vr",",","inout","vec3","vs",")","{"]},{type:"condition",parts:[{type:"if",expression:["FRAMES_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["float","vt","=","u_frame_factor",";"]}]}}]},{type:"textline",tokens:["if","(","a_influence",".","y",">","0.0",")","{","vec3","vu","=","vec3","(","0.0",",","0.0",",","0.0",")",";","vec3","vv","=","vec3","(","0.0",",","0.0",",","0.0",")",";","vec3","vw","=","vec3","(","0.0",",",
"0.0",",","0.0",")",";","vec3","vx","=","vec3","(","0.0",",","0.0",",","0.0",")",";","vec4","vy","=","a_influence",";","for","(","int","vz","=","0",";","vz","<","4",";","vz","++",")","{","int","vA","=","int","(","vy","[","vz","]",")",";","float","vB","=","fract","(","vy","[","vz","]",")",";"]},{type:"condition",parts:[{type:"if",expression:["FRAMES_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["vu","+=","vB","*","uV","(","vp",",","u_quatsb","[","vA","]",",","u_quatsa","[","vA","]",
",","u_transb","[","vA","]",",","u_transa","[","vA","]",",","vt",")",";","vv","+=","vB","*","ve","(","vq",",","u_quatsb","[","vA","]",",","u_quatsa","[","vA","]",",","vt",")",";","vw","+=","vB","*","ve","(","vr",",","u_quatsb","[","vA","]",",","u_quatsa","[","vA","]",",","vt",")",";","vx","+=","vB","*","ve","(","vs",",","u_quatsb","[","vA","]",",","u_quatsa","[","vA","]",",","vt",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vu","+=","vB","*","uV","(","vp",",","u_quatsb",
"[","vA","]",",","u_transb","[","vA","]",")",";","vv","+=","vB","*","ve","(","vq",",","u_quatsb","[","vA","]",")",";","vw","+=","vB","*","ve","(","vr",",","u_quatsb","[","vA","]",")",";","vx","+=","vB","*","ve","(","vs",",","u_quatsb","[","vA","]",")",";"]}]}}]},{type:"textline",tokens:["}","vp","=","vu",";","vq","=","vv",";","vr","=","vw",";","vs","=","vx",";","}","if","(","!","(","a_influence",".","y",">","0.0",")",")","{","int","vC","=","int","(","a_influence","[","0","]","-","1.0",")",";","if",
"(","vC",">","-","1",")","{"]},{type:"condition",parts:[{type:"if",expression:["FRAMES_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["vp","=","uV","(","vp",",","u_quatsb","[","vC","]",",","u_quatsa","[","vC","]",",","u_transb","[","vC","]",",","u_transa","[","vC","]",",","vt",")",";","vq","=","ve","(","vq",",","u_quatsb","[","vC","]",",","u_quatsa","[","vC","]",",","vt",")",";","vr","=","ve","(","vr",",","u_quatsb","[","vC","]",",","u_quatsa","[","vC","]",",","vt",")",";","vs","=",
"ve","(","vs",",","u_quatsb","[","vC","]",",","u_quatsa","[","vC","]",",","vt",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vp","=","uV","(","vp",",","u_quatsb","[","vC","]",",","u_transb","[","vC","]",")",";","vq","=","ve","(","vq",",","u_quatsb","[","vC","]",")",";","vr","=","ve","(","vr",",","u_quatsb","[","vC","]",")",";","vs","=","ve","(","vs",",","u_quatsb","[","vC","]",")",";"]}]}}]},{type:"textline",tokens:["}","}","}"]}]}}]}]},exports["include/wind_bending.glslv"]=
{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["void","vS","(","inout","vec3","vE",",","in","vec3","vF",",","in","float","vG",",","in","float","vH",",","in","float","vI",",","in","vec3","vJ",",","in","float","vK",")","{","float","vL","=","length","(","vF",")",";","float","vM","=","vH","*","(","1.0","+","0.1","*","fract","(","vL",")",")",";","float","vN","=","vG","*","vK","*","(","1.0","+","sin","(","2.0","*","3.14",
"*","vI","*","vM","+","vL",")",")",";","float","vO","=","(","vE",".","y","-","vF",".","y",")","*","abs","(","vN",")",";","vO","+=","1.0",";","vO","*=","vO",";","vO","=","vO","*","vO","-","vO",";","vec3","vP","=","vE",";","vP",".","xz","+=","vJ",".","xz","*","vO","*","sign","(","vN",")",";","vec3","vQ","=","vP","-","vF",";","if","(","all","(","equal","(","vQ",",","vec3","(","0.0",")",")",")",")","vE","=","vF",";","else","{","float","vR","=","length","(","vE","-","vF",")",";","vE","=","vF","+","normalize",
"(","vQ",")","*","vR",";","}","}"]},{type:"condition",parts:[{type:"if",expression:["DETAIL_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","vU","(","vec4","vT",")","{","return","vT","*","vT","*","(","3.0","-","2.0","*","vT",")",";","}","vec4","vW","(","vec4","vV",")","{","return","abs","(","fract","(","vV","+","0.5",")","*","2.0","-","1.0",")",";","}","vec4","vY","(","vec4","vX",")","{","return","vU","(","vW","(","vX",")",")",";","}","void","wo","(","inout","vec3","vZ",",","in",
"float","v_",",","in","vec3","wa",",","in","vec3","wb",",","in","vec3","wc",",","in","float","wd",",","in","float","we",",","in","float","wf",",","in","vec3","wg",")","{","float","wh",";","float","wi",";","float","wj",";","vec2","wk",";","vec4","wl",";","vec2","wm",";","vec3","wn",";","wh","=","dot","(","wc",",","vec3","(","1.0",")",")",";","wi","=","wh","+","wg",".","g",";","wj","=","dot","(","vZ",",","vec3","(","wg",".","g",")",")",";","wk","=","(","v_","+","vec2","(","wj",",","wi",")",")",";",
"wl","=","(","(","fract","(","(","wk",".","xxyy","*","vec4","(","1.975",",","0.793",",","0.375",",","0.193",")",")",")","*","2.0",")","-","1.0",")","*","length","(","wb",")","*","wd",";","wl","=","vY","(","wl",")",";","wm","=","wl",".","xz","+","wl",".","yw",";","wm",".","y","=","0.5","-","wm",".","y",";","wn","=","wm",".","xyx","*","wg",".","rbr","*","vec3","(","we","*","wa",".","x",",","wf",",","we","*","wa",".","z",")",";","vZ","+=","wn",";","}"]}]}}]},{type:"textline",tokens:["void","wv","(",
"inout","vec3","wp",",","inout","vec3","wq",",","in","vec3","wr",")","{","vec3","ws","=","u_wind","*","1.0","+","0.7","*","sin","(","u_time",")",";"]},{type:"condition",parts:[{type:"if",expression:["BEND_CENTER_ONLY"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","wt","=","wq",";","vec3","wu","=","a_emitter_center",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","wt","=","wp",";","vec3","wu","=","wq",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["MAIN_BEND_COL"],
group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DETAIL_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["wo","(","wt",",","u_time",",","wr",",","ws",",","wu",",","au_detail_bending_freq",",","au_detail_bending_amp",",","au_branch_bending_amp",",","a_bending_col_detail",")",";"]}]}}]},{type:"textline",tokens:["vS","(","wt",",","wu",",","au_wind_bending_amp",",","au_wind_bending_freq",",","u_time",",","ws",",","a_bending_col_main",")",";"]}]}},{type:"else",group:{type:"group",
parts:[{type:"textline",tokens:["vS","(","wt",",","wu",",","au_wind_bending_amp",",","au_wind_bending_freq",",","u_time",",","ws",",","1.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["BEND_CENTER_ONLY"],group:{type:"group",parts:[{type:"textline",tokens:["wp","+=","wt","-","wq",";","wq","=","wt",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["wp","=","wt",";","wq","=","wu",";"]}]}}]},{type:"textline",tokens:["}"]}]}}]}]},exports["include/nodes.glslv"]=
{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["USE_NODE_GEOMETRY_OR","USE_NODE_TEX_COORD_GE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_orco_tex_coord",";","varying","vec3","eL",";"]}]}}]},{type:"node",name:"TEX_COORD_UV",declarations:[{type:"node_param",name:"node_TEX_COORD_UV_var_a_uv",qualifier:["attribute","vec2"]},{type:"node_param",name:"fo",qualifier:["varying","vec2"]}],statements:[{type:"textline",tokens:["fo",
"=","node_TEX_COORD_UV_var_a_uv",";"]}]},{type:"node",name:"UV_MERGED",declarations:[{type:"node_param",name:"node_UV_MERGED_var_a_uv",qualifier:["attribute","vec2"]},{type:"node_param",name:"fn",qualifier:["varying","vec2"]}],statements:[{type:"textline",tokens:["fn","=","node_UV_MERGED_var_a_uv",";"]}]},{type:"node",name:"UVMAP",declarations:[{type:"node_param",name:"node_UVMAP_var_a_uv",qualifier:["attribute","vec2"]},{type:"node_param",name:"fp",qualifier:["varying","vec2"]}],statements:[{type:"textline",
tokens:["fp","=","node_UVMAP_var_a_uv",";"]}]},{type:"node",name:"GEOMETRY_UV",declarations:[{type:"node_param",name:"node_GEOMETRY_UV_var_a_uv",qualifier:["attribute","vec2"]},{type:"node_param",name:"fh",qualifier:["varying","vec2"]}],statements:[{type:"textline",tokens:["fh","=","node_GEOMETRY_UV_var_a_uv",";"]}]},{type:"node",name:"GEOMETRY_VC",declarations:[{type:"node_param",name:"node_GEOMETRY_VC_var_a_vertex_color",qualifier:["attribute","vec3"]},{type:"node_param",name:"ww",qualifier:["varying",
"vec3"]}],statements:[{type:"textline",tokens:["ww","=","node_GEOMETRY_VC_var_a_vertex_color",";"]}]},{type:"node",name:"GEOMETRY_VC1",declarations:[{type:"node_param",name:"node_GEOMETRY_VC1_var_a_vertex_color",qualifier:["attribute","float"]},{type:"node_param",name:"wx",qualifier:["varying","float"]}],statements:[{type:"textline",tokens:["wx","=","node_GEOMETRY_VC1_var_a_vertex_color",";"]}]},{type:"node",name:"GEOMETRY_VC2",declarations:[{type:"node_param",name:"node_GEOMETRY_VC2_var_a_vertex_color",
qualifier:["attribute","vec2"]},{type:"node_param",name:"wy",qualifier:["varying","vec2"]}],statements:[{type:"textline",tokens:["wy","=","node_GEOMETRY_VC2_var_a_vertex_color",";"]}]},{type:"node",name:"GEOMETRY_VC3",declarations:[{type:"node_param",name:"node_GEOMETRY_VC3_var_a_vertex_color",qualifier:["attribute","vec3"]},{type:"node_param",name:"wz",qualifier:["varying","vec3"]}],statements:[{type:"textline",tokens:["wz","=","node_GEOMETRY_VC3_var_a_vertex_color",";"]}]},{type:"nodes_global"},
{type:"textline",tokens:["void","wA","(",")","{"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_GEOMETRY_OR","USE_NODE_TEX_COORD_GE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["eL","=","a_orco_tex_coord",";"]}]}}]},{type:"nodes_main"},{type:"textline",tokens:["}"]}]},exports["include/dynamic_grass.glslv"]={type:"group",parts:[{type:"var",name:"PRECISION",tokens:["lowp"]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS"],group:{type:"group",
parts:[{type:"textline",tokens:["vec2","wF","(","vec3","wB",",","float","wC",",","vec2","wD",")","{","vec2","wE","=","vec2","(","(","wB",".","x","-","wD",".","x",")","/","wC",",","-","(","wB",".","z","-","wD",".","y",")","/","wC",")",";","return","fract","(","wE",")",";","}","vec2","wJ","(","vec2","wG",",","float","wH",",","vec2","wI",")","{","return","vec2","(","wG",".","x","*","wH",",","-","wG",".","y","*","wH",")","+","wI",";","}","bh","wK","(",")","{","return","bh","(","vec3","(","-","10000.0",
")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",")",";","}","bh","xp","(","vec3","wL",",","vec3","wM",",","vec3","wN",",","vec3","wO",",","vec3","wP",",","PRECISION","sampler2D","wQ",",","sampler2D","wR",",","vec3","wS",",","float","wT",",","vec3","wU",",","vec4","wV",",","mat4","wW",")","{","vec3","wX","=","bn","(","wV",",","vec3","(","0.0",",","-","1.0",",","0.0",")",")",";","float","wY","=","-","wX",".","x",";","float",
"wZ","=","-","wX",".","z",";","vec2","w_","=","vec2","(","wU",".","x","+","wT","*","(","-","1.0","-","wY",")","/","2.0",",","wU",".","z","+","wT","*","(","1.0","-","wZ",")","/","2.0",")",";","vec2","xa","=","wF","(","wP",",","wT",",","w_",")",";","float","xb","=","wT","/","2.0",";","vec2","xc","=","abs","(","wJ","(","xa","-","vec2","(","0.5",")",",","wT",",","vec2","(","0.0",")",")",")",";","float","xd","=","xb","*","(","1.0","+","sqrt","(","2.0",")",")","/","2.0",";","if","(","length","(","xc",")",
">","xd",")","return","wK","(",")",";","float","xe","=","wT","/","wS",".","z",";","vec2","xf","=","(","xa","-","vec2","(","0.5",")",")","*","xe","+","vec2","(","0.5",")",";","vec3","xg","=","wX","*","(","wT","/","wS",".","z","-","1.0",")","/","2.0",";","xf",".","x","+=","xg",".","x",";","xf",".","y","-=","xg",".","z",";","vec4","xh","=","texture2D","(","wR",",","xf",")",";","float","xi","=","xh",".","r",";","if","(","xi","<","u_scale_threshold",")","return","wK","(",")",";","float","xj","=","wS",
".","y","-","wS",".","x",";","float","xk","=","wS",".","y","-","texture2D","(","wQ",",","xf",")",".","r","*","xj",";","vec2","xl","=","wL",".","xz","-","wP",".","xz",";","wP",".","xz","=","wJ","(","xa",",","wT",",","w_",")",";","wP",".","y","=","xk",";","wL",".","xz","=","wP",".","xz","+","xl",";","wL",".","y","*=","xi",";","wL",".","y","+=","xk",";","vec3","xm","=","xh",".","gba",";"]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["wL",
"-=","wP",";","mat4","xn","=","ug","(","wU",",","wP",",","wW",")",";","bh","xo","=","ut","(","wL",",","wP",",","wM",",","wN",",","wO",",","xn",")",";","xo",".","b","=","wP",";","xo",".","f","=","xm",";","return","bJ","(","xo",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["return","bJ","(","bh","(","wL",",","wP",",","wM",",","wN",",","wO",",","xm",")",")",";"]}]}}]},{type:"textline",tokens:["}"]}]}}]}]},exports["include/shadow.glslv"]={type:"group",parts:[{type:"var",
name:"SHADOW_TEX_RES",tokens:["0.0"]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2},"SHADOW_USAGE","SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec4","xv","(","mat4","xq",",","vec4","xr",")","{","vec2","xs","=","(","xq","*","u_v_light_matrix","[","3","]",")",".","xy",";","float","xt","=","SHADOW_TEX_RES","/","2.0",";","xs","=","floor",
"(","xs","*","xt","+","0.5",")","/","xt","-","xs",";","vec4","xu","=","xq","*","xr",";","xu",".","xy","+=","xs",";","xu","=","u_b_light_matrix","*","xu",";","return","xu",";","}","void","xz","(","vec3","xw",",","vec3","xx",")","{","vec4","xy","=","u_v_light_matrix","*","vec4","(","xw","+","u_normal_offset","*","xx",",","1.0",")",";","bW","=","xv","(","u_p_light_matrix0",",","xy",")",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["bX",
"=","xv","(","u_p_light_matrix1",",","xy",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["bY","=","xv","(","u_p_light_matrix2",",","xy",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",tokens:["bZ","=","xv","(","u_p_light_matrix3",",","xy",")",";"]}]}}]},{type:"textline",tokens:["}"]}]}}]}]},exports["include/fog.glslf"]={type:"group",parts:[{type:"var",
name:"WAVES_HEIGHT",tokens:["0.0"]},{type:"textline",tokens:["void","xK","(","inout","vec3","xD",",","in","float","xE",",","in","float","xF",",","in","vec4","xG",")","{"]},{type:"condition",parts:[{type:"if",expression:["USE_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["float","xH","=","clamp","(","(","xE","-","u_fog_params",".","z",")","/","u_fog_params",".","y",",","0.0",",","1.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["FOG_TYPE","QUADRATIC",{type:"equal_expr",places:2}],
group:{type:"group",parts:[{type:"textline",tokens:["xH","*=","xH",";"]}]}},{type:"elif",expression:["FOG_TYPE","LINEAR",{type:"equal_expr",places:2}],group:{type:"group",parts:[]}},{type:"elif",expression:["FOG_TYPE","INVERSE_QUADRATIC",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["xH","=","sqrt","(","xH",")",";"]}]}}]},{type:"textline",tokens:["if","(","u_fog_params",".","w",">","0.0",")","{","if","(","xF",">","u_fog_params",".","w",")","xH","=","0.0",";","else",
"if","(","xF",">","0.0",")","{","float","xI","=","(","u_fog_params",".","w","-","xF",")","/","u_fog_params",".","w",";","xH","*=","xI","*","xI",";","}","}","float","xJ","=","1.0","-","(","1.0","-","xH",")","*","(","1.0","-","u_fog_params",".","x",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["float","xJ","=","0.0",";"]}]}}]},{type:"textline",tokens:["xD","=","mix","(","xD",",","xG",".","rgb",",","xJ",")",";","}"]},{type:"condition",parts:[{type:"if",expression:["PROCEDURAL_FOG"],
group:{type:"group",parts:[{type:"textline",tokens:["vec3","xR","(","in","mat4","xL",",","in","vec3","xM",")","{","vec3","xN","=","mix","(","xL","[","0","]",".","rgb",",","xL","[","1","]",".","rgb",",","max","(","sign","(","xM",".","x",")",",","0.0",")",")",";","vec3","xO","=","mix","(","xL","[","2","]",".","rgb",",","xL","[","3","]",".","rgb",",","max","(","sign","(","xM",".","z",")",",","0.0",")",")",";","vec3","xP","=","vec3","(","xL","[","0","]",".","a",",","xL","[","1","]",".","a",",","xL","[",
"2","]",".","a",")",";","vec3","xQ","=","mix","(","xN",",","xO",",","abs","(","xM",".","z",")",")",";","xQ","=","mix","(","xQ",",","xP",",","abs","(","xM",".","y",")",")",";","a_","(","xQ",")",";","return","xQ",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["void","xT","(","inout","float","xS",")","{","xS","-=","0.5",";","xS","=","4.0","*","(","xS","*","xS","*","xS",")","+","0.5",";","}","void","yi","(","inout","vec3",
"xU",",","in","float","xV",",","in","vec3","xW",",","in","float","xX",",","in","vec4","xY",",","in","vec4","xZ",",","in","float","x_",")","{","float","ya","=","xZ",".","w","*","xV",";","float","yb","=","exp","(","-","ya","*","ya",")",";","yb","=","clamp","(","yb",",","0.0",",","1.0",")",";","float","yc","=","max","(","xW",".","y",",","0.0",")",";","xV","=","max","(","xV","-","max","(","xX","/","yc",",","0.0",")",",","0.0",")",";","float","yd","=","xY",".","w","*","xV",";","float","ye","=","1.0","-",
"yd",";","ye","=","max","(","ye",",","0.0",")",";","xT","(","ye",")",";","ye","+=","max","(","x_","-","0.5",",","0.0",")",";","if","(","ye","<","yb",")","{","vec3","yf","=","vec3","(","0.0",",","0.02",",","0.05",")",";","vec3","yg","=","xY",".","rgb",";","xX","=","clamp","(","-","xX","*","0.03",",","0.0",",","0.8",")",";","vec3","yh","=","mix","(","yg",",","yf",",","min","(","yc",",","1.0",")",")",";","yh","=","mix","(","yh",",","vec3","(","0.0",")",",","xX",")",";","xU","=","mix","(","yh",",","xU",
",","ye",")",";","}","if","(","ye",">=","yb",")","{","xU","=","mix","(","xZ",".","rgb",",","xU",",","yb",")",";","}","}","void","yp","(","inout","vec3","yj",",","in","float","yk",",","in","float","yl",")","{","float","ym","=","u_underwater_fog_color_density",".","w","*","yk",";","float","yn","=","1.0","-","ym",";","yn","=","clamp","(","yn",",","0.0",",","1.0",")",";","xT","(","yn",")",";","yl","=","clamp","(","-","yl","*","0.03",",","0.0",",","0.8",")",";","vec3","yo","=","mix","(","u_underwater_fog_color_density",
".","rgb",",","vec3","(","0.0",")",",","yl",")",";","yj","=","mix","(","yo",",","yj",",","yn",")",";","}"]}]}}]},{type:"textline",tokens:["void","yw","(","inout","vec3","yq",",","float","yr",",","vec3","ys",",","float","yt",")","{"]},{type:"condition",parts:[{type:"if",expression:["PROCEDURAL_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","yu","=","xR","(","u_cube_fog",",","ys",")",";","vec4","yv","=","vec4","(","yu",",","u_fog_color_density",".","a",")",";"]}]}},{type:"else",group:{type:"group",
parts:[{type:"textline",tokens:["vec4","yv","=","u_fog_color_density",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["yi","(","yq",",","yr",",","ys",",","u_cam_water_depth",",","u_underwater_fog_color_density",",","yv",",","yt",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["xK","(","yq",",","yr",",","bQ",".","y",",","yv",")",";"]}]}}]},{type:"textline",tokens:["}"]}]},exports["include/lighting_nodes.glslf"]=
{type:"group",parts:[{type:"var",name:"LAMP_IND",tokens:["0"]},{type:"var",name:"LAMP_SPOT_SIZE",tokens:["0"]},{type:"var",name:"LAMP_SPOT_BLEND",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_DIST",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_FACT_IND",tokens:["0"]},{type:"var",name:"LAMP_FAC_CHANNELS",tokens:["rgb"]},{type:"var",name:"LAMP_SHADOW_MAP_IND",tokens:["0"]},{type:"define",name:"M_PI",tokens:["3.14159265359"]},{type:"textline",tokens:["float","yz","=","0.0",";","float","yA","=","1.0",";","float",
"yB","=","0.5",";","vec3","yC","=","vec3","(","yz",")",";"]},{type:"node",name:"LIGHTING_BEGIN",declarations:[{type:"node_out",name:"yR",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"yS",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"yT",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"yU",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"yV",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"yW",qualifier:["vec2"],is_optional:true},{type:"node_out",
name:"yX",qualifier:["vec2"],is_optional:true},{type:"node_out",name:"yY",qualifier:["float"],is_optional:true},{type:"node_out",name:"yZ",qualifier:["float"],is_optional:true},{type:"node_out",name:"y_",qualifier:["vec4"],is_optional:true}],statements:[{type:"textline",tokens:["yR","=","yD",";","yS","=","yE",";","yT","=","yF",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_yU"],statements:[{type:"textline",tokens:["yU","=","yG",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",
expression:["USE_OUT_yV"],statements:[{type:"textline",tokens:["yV","=","yI",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_yX"],statements:[{type:"textline",tokens:["yX","=","yK",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_yW"],statements:[{type:"textline",tokens:["yW","=","yL",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_yY"],statements:[{type:"textline",tokens:["yY","=","yM",";"]}]}]},{type:"node_condition",
parts:[{type:"node_if",expression:["USE_OUT_yZ"],statements:[{type:"textline",tokens:["yZ","=","yN",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_y_"],statements:[{type:"textline",tokens:["y_","=","yO",";"]}]}]}]},{type:"node",name:"LIGHTING_AMBIENT",declarations:[{type:"node_in",name:"za",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"zb",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"zc",qualifier:["vec3"],is_optional:false},{type:"node_out",
name:"zd",qualifier:["vec4"],is_optional:false},{type:"node_out",name:"ze",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["zd","=","vec4","(","za","+","zc","*","zb",",","yz",")",";","ze","=","yC",";"]}]},{type:"node",name:"LIGHTING_LAMP",declarations:[{type:"node_in",name:"zf",qualifier:["float"],is_optional:false},{type:"node_out",name:"zg",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"zh",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"zi",
qualifier:["vec3"],is_optional:false},{type:"node_out",name:"zj",qualifier:["float"],is_optional:false}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["NODES_GLOW",{type:"logic_negative_expr",places:1},"NUM_LIGHTS",0,{type:"g_expr",places:2},{type:"logical_and_expr",places:2}],statements:[{type:"textline",tokens:["zh","=","u_light_factors","[","LAMP_LIGHT_FACT_IND","]",".","LAMP_FAC_CHANNELS",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["LAMP_TYPE","HEMI",
{type:"equal_expr",places:2}],statements:[{type:"textline",tokens:["zj","=","yB",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["zj","=","yz",";"]}]}]},{type:"textline",tokens:["zi","=","u_light_color_intensities","[","LAMP_IND","]",";","if","(","LAMP_SHADOW_MAP_IND","!=","-","1",")","zi","*=","zf",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["LAMP_TYPE","SPOT",{type:"equal_expr",places:2},"LAMP_TYPE","POINT",{type:"equal_expr",places:2},{type:"logical_or_expr",
places:2}],statements:[{type:"textline",tokens:["vec3","zk","=","u_light_positions","[","LAMP_IND","]",";","zg","=","zk","-","yH",";"]},{type:"textline",tokens:["float","zl","=","length","(","zg",")",";","zi","*=","LAMP_LIGHT_DIST","/","(","LAMP_LIGHT_DIST","+","zl","*","zl",")",";","zg","=","normalize","(","zg",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["LAMP_TYPE","SPOT",{type:"equal_expr",places:2}],statements:[{type:"textline",tokens:["vec3","zm","=","u_light_directions",
"[","LAMP_IND","]",";","float","zn","=","dot","(","zg",",","zm",")",";","zn","*=","smoothstep","(","yz",",","yA",",","(","zn","-","LAMP_SPOT_SIZE",")","/","LAMP_SPOT_BLEND",")",";","zi","*=","zn",";"]}]}]}]},{type:"node_else",statements:[{type:"textline",tokens:["zg","=","u_light_directions","[","LAMP_IND","]",";"]}]}]}]}]}]},{type:"node",name:"DIFFUSE_FRESNEL",declarations:[{type:"node_in",name:"zo",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"zp",qualifier:["vec2"],is_optional:false},
{type:"node_in",name:"zq",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"zr",qualifier:["float"],is_optional:false},{type:"node_in",name:"zs",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"zt",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["zt","=","yz",";","if","(","zp",".","r","!=","yz",")","{","float","zu","=","(","yA","-","zr",")","*","dot","(","zq",",","zo",")","+","zr",";","if","(","zs","[","0","]","==","yz",")","{","zt","=","yA",";",
"}","else","{","float","zv","=","yA","+","abs","(","zu",")",";","zv","=","zs","[","1","]","+","(","yA","-","zs","[","1","]",")","*","pow","(","zv",",","zs","[","0","]",")",";","zt","=","clamp","(","zv",",","yz",",","yA",")",";","}","zt","=","max","(","zt",",","yz",")",";","}"]}]},{type:"node",name:"DIFFUSE_LAMBERT",declarations:[{type:"node_in",name:"zw",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"zx",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"zy",qualifier:["vec3"],
is_optional:false},{type:"node_in",name:"zz",qualifier:["float"],is_optional:false},{type:"node_out",name:"zA",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["zA","=","yz",";","if","(","zx",".","r","!=","yz",")","{","float","zB","=","(","yA","-","zz",")","*","dot","(","zy",",","zw",")","+","zz",";","zA","=","max","(","zB",",","yz",")",";","}"]}]},{type:"node",name:"DIFFUSE_OREN_NAYAR",declarations:[{type:"node_in",name:"zC",qualifier:["vec3"],is_optional:false},{type:"node_in",
name:"zD",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"zE",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"zF",qualifier:["float"],is_optional:false},{type:"node_in",name:"zG",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"zH",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["zH","=","yz",";","if","(","zD",".","r","!=","yz",")","{","float","zI","=","(","yA","-","zF",")","*","dot","(","zE",",","zC",")","+","zF",";","if","(","zG",
"[","0","]",">","yz",")","{","float","zJ","=","max","(","dot","(","zE",",","yJ",")",",","yz",")",";","float","zK","=","zG","[","0","]","*","zG","[","0","]",";","float","zL","=","yA","-","yB","*","(","zK","/","(","zK","+","0.33",")",")",";","vec3","zM","=","zC","-","zI","*","zE",";","vec3","zN","=","yJ","-","zJ","*","zE",";"]},{type:"textline",tokens:["if","(","length","(","zM",")","==","yz","||","length","(","zN",")","==","yz","||","abs","(","zI",")",">","yA","||","abs","(","zJ",")",">","yA",")"]},
{type:"textline",tokens:["zH","=","zI","*","zL",";","else","{","float","zO","=","acos","(","zI",")",";","float","zP","=","acos","(","zJ",")",";","vec3","zQ","=","normalize","(","zM",")",";","vec3","zR","=","normalize","(","zN",")",";","float","zS",",","zT",";","zS","=","max","(","zO",",","zP",")",";","zT","=","min","(","zO",",","zP",")",";","zT","*=","0.95",";","float","zU","=","max","(","dot","(","zQ",",","zR",")",",","yz",")",";","float","zV","=","0.45","*","(","zK","/","(","zK","+","0.09",")",
")",";","zH","=","zI","*","(","zL","+","(","zV","*","zU","*","sin","(","zS",")","*","tan","(","zT",")",")",")",";","}","}","else","zH","=","zI",";","zH","=","max","(","zH",",","yz",")",";","}"]}]},{type:"node",name:"DIFFUSE_MINNAERT",declarations:[{type:"node_in",name:"zW",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"zX",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"zY",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"zZ",qualifier:["float"],is_optional:false},
{type:"node_in",name:"z_",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"Aa",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Aa","=","yz",";","if","(","zX",".","r","!=","yz",")","{","float","Ab","=","(","yA","-","zZ",")","*","dot","(","zY",",","zW",")","+","zZ",";","float","Ac","=","max","(","dot","(","zY",",","yJ",")",",","yz",")",";","if","(","z_","[","0","]","<=","yA",")","Aa","=","Ab","*","pow","(","max","(","Ac","*","Ab",",","0.1",")",",","z_","[",
"0","]","-","yA",")",";","else","Aa","=","Ab","*","pow","(","1.0001","-","Ac",",","z_","[","0","]","-","yA",")",";","Aa","=","max","(","Aa",",","yz",")",";","}"]}]},{type:"node",name:"DIFFUSE_TOON",declarations:[{type:"node_in",name:"Ad",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Ae",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"Af",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Ag",qualifier:["float"],is_optional:false},{type:"node_in",name:"Ah",qualifier:["vec2"],
is_optional:false},{type:"node_out",name:"Ai",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Ai","=","yz",";","if","(","Ae",".","r","!=","yz",")","{","float","Aj","=","(","yA","-","Ag",")","*","dot","(","Af",",","Ad",")","+","Ag",";","float","Ak","=","acos","(","Aj",")",";","if","(","Ak","<","Ah","[","0","]",")","Ai","=","yA",";","else","if","(","Ak",">","(","Ah","[","0","]","+","Ah","[","1","]",")","||","Ah","[","1","]","==","yz",")","Ai","=","yz",";","else","Ai","=",
"yA","-","(","(","Ak","-","Ah","[","0","]",")","/","Ah","[","1","]",")",";","Ai","=","max","(","Ai",",","yz",")",";","}"]}]},{type:"node",name:"SPECULAR_PHONG",declarations:[{type:"node_in",name:"Al",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Am",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"An",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Ao",qualifier:["float"],is_optional:false},{type:"node_in",name:"Ap",qualifier:["vec2"],is_optional:false},{type:"node_out",
name:"Aq",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Aq","=","yz",";","if","(","Am",".","g","!=","yz",")","{","vec3","Ar","=","normalize","(","Al","+","yJ",")",";","Aq","=","(","yA","-","Ao",")","*","max","(","dot","(","An",",","Ar",")",",","yz",")","+","Ao",";","Aq","=","pow","(","Aq",",","Ap","[","0","]",")",";","}"]}]},{type:"node",name:"SPECULAR_WARDISO",declarations:[{type:"node_in",name:"As",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"At",qualifier:["vec2"],
is_optional:false},{type:"node_in",name:"Au",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Av",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"Aw",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Aw","=","yz",";","if","(","At",".","g","!=","yz",")","{","vec3","Ax","=","normalize","(","As","+","yJ",")",";","float","Ay","=","max","(","dot","(","Au",",","Ax",")",",","0.001",")",";"]},{type:"textline",tokens:["float","Az","=","max","(","dot","(",
"Au",",","yJ",")",",","0.01",")",";","float","AA","=","max","(","dot","(","Au",",","As",")",",","0.01",")",";","float","AB","=","tan","(","acos","(","Ay",")",")",";","float","AC","=","max","(","Av","[","0","]",",","0.001",")",";","Aw","=","AA","*","(","yA","/","(","4.0","*","M_PI","*","AC","*","AC",")",")","*","(","exp","(","-","(","AB","*","AB",")","/","(","AC","*","AC",")",")","/","(","sqrt","(","Az","*","AA",")",")",")",";","}"]}]},{type:"node",name:"SPECULAR_TOON",declarations:[{type:"node_in",
name:"AD",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"AE",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"AF",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"AG",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"AH",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["AH","=","yz",";","if","(","AE",".","g","!=","yz",")","{","vec3","AI","=","normalize","(","AD","+","yJ",")",";","float","AJ","=","acos","(","dot","(","AI",",",
"AF",")",")",";","if","(","AJ","<","AG","[","0","]",")","AH","=","yA",";","else","if","(","AJ",">=","AG","[","0","]","+","AG","[","1","]","||","AG","[","1","]","==","yz",")","AH","=","yz",";","else","AH","=","yA","-","(","AJ","-","AG","[","0","]",")","/","AG","[","1","]",";","}"]}]},{type:"node",name:"SPECULAR_BLINN",declarations:[{type:"node_in",name:"AK",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"AL",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"AM",qualifier:["vec3"],
is_optional:false},{type:"node_in",name:"AN",qualifier:["float"],is_optional:false},{type:"node_in",name:"AO",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"AP",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["AP","=","yz",";","if","(","AL",".","g","!=","yz",")","{","if","(","AO","[","0","]","<","1.0","||","AO","[","1","]","==","yz",")","AP","=","yz",";","else","{","if","(","AO","[","1","]","<","100.0",")","AO","[","1","]","=","sqrt","(","1.0","/","AO","[",
"1","]",")",";","else","AO","[","1","]","=","10.0","/","AO","[","1","]",";","vec3","AQ","=","normalize","(","yJ","+","AK",")",";","float","AR","=","(","yA","-","AN",")","*","max","(","dot","(","AM",",","AQ",")",",","yz",")","+","AN",";","if","(","AR","<","yz",")","AP","=","yz",";","else","{","float","AS","=","max","(","dot","(","AM",",","yJ",")",",","0.01",")",";","float","AT","=","dot","(","AM",",","AK",")",";","if","(","AT","<=","0.01",")","AP","=","yz",";","else","{","float","AU","=","max","(",
"dot","(","yJ",",","AQ",")",",","0.01",")",";","float","AV","=","yA",";","float","AW","=","(","2.0","*","AR","*","AS",")","/","AU",";","float","AX","=","(","2.0","*","AR","*","AT",")","/","AU",";","float","AY","=","min","(","min","(","AV",",","AW",")",",","AX",")",";","float","AZ","=","sqrt","(","pow","(","AO","[","0","]",",","2.0",")","+","pow","(","AU",",","2.0",")","-","yA",")",";","float","A_","=","pow","(","AZ","-","AU",",","2.0",")","/","pow","(","AZ","+","AU",",","2.0",")","*","(","yA","+",
"pow","(","AU","*","(","AZ","+","AU",")","-","yA",",","2.0",")","/","pow","(","AU","*","(","AZ","-","AU",")","+","yA",",","2.0",")",")",";","float","Ba","=","acos","(","AR",")",";","AP","=","max","(","A_","*","AY","*","exp","(","-","pow","(","Ba",",","2.0",")","/","(","2.0","*","pow","(","AO","[","1","]",",","2.0",")",")",")",",","yz",")",";","}","}","}","}"]}]},{type:"node",name:"LIGHTING_APPLY",declarations:[{type:"node_in",name:"Bb",qualifier:["vec4"],is_optional:false},{type:"node_in",name:"Bc",
qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Bd",qualifier:["float"],is_optional:false},{type:"node_in",name:"Be",qualifier:["float"],is_optional:false},{type:"node_in",name:"Bf",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Bg",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Bh",qualifier:["vec4"],is_optional:false},{type:"node_in",name:"Bi",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Bj",qualifier:["vec3"],is_optional:false},{type:"node_in",
name:"Bk",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Bl",qualifier:["float"],is_optional:false},{type:"node_out",name:"Bm",qualifier:["vec4"],is_optional:false},{type:"node_out",name:"Bn",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["Bn","=","Bc","+","Bk","*","Bj","*","Be",";","Bm","=","Bb","+","vec4","(","Bk","*","Bi","*","Bd",",","Be",")",";"]}]},{type:"node",name:"LIGHTING_END",declarations:[{type:"node_in",name:"Bo",qualifier:["vec4"],is_optional:false},
{type:"node_in",name:"Bp",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["yP","=","Bo",".","rgb",";","yQ","=","Bp",";"]}]},{type:"nodes_global"},{type:"textline",tokens:["void","Bq","(","vec3","yD",",","vec3","yE",",","vec3","yF",",","vec3","yG",",","vec3","yH",",","vec3","yI",",","vec3","yJ",",","vec2","yK",",","vec2","yL",",","float","yM",",","float","yN",",","vec4","yO",",","out","vec3","yP",",","out","vec3","yQ",")","{"]},{type:"nodes_main"},{type:"textline",tokens:["}"]}]},
exports["include/particles.glslv"]={type:"group",parts:[{type:"var",name:"EPSILON",tokens:["0.0001"]},{type:"textline",tokens:["struct","Bt","{","float","a",";","vec3","b",";","float","c",";","vec3","d",";","float","e",";","}",";"]},{type:"condition",parts:[{type:"if",expression:["SIZE_RAMP_LENGTH",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["void","BA","(","inout","float","Bu",",","float","Bv",",","vec2","Bw",",","vec2","Bx",")","{","float","By","=","Bx",".","x",
"-","Bw",".","x",";","float","Bz","=","(","Bv","-","Bw",".","x",")","/","By",";","Bu","=","mix","(","Bu",",","Bx",".","y",",","clamp","(","Bz",",","0.0",",","1.0",")",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["COLOR_RAMP_LENGTH",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["void","BH","(","inout","vec3","BB",",","float","BC",",","vec4","BD",",","vec4","BE",")","{","float","BF","=","BE",".","x","-","BD",".","x",";","float","BG","=","(","BC",
"-","BD",".","x",")","/","BF",";","BB","=","mix","(","BB",",","BE",".","yzw",",","clamp","(","BG",",","0.0",",","1.0",")",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SIZE_RAMP_LENGTH",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["float","BN","(","float","BI",",","float","BJ",",","vec2","BK","[","SIZE_RAMP_LENGTH","]",")","{","float","BL","=","BI","/","BJ",";","float","BM","=","BK","[","0","]",".","y",";"]},{type:"condition",parts:[{type:"if",
expression:["SIZE_RAMP_LENGTH",1,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["BA","(","BM",",","BL",",","BK","[","0","]",",","BK","[","1","]",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SIZE_RAMP_LENGTH",2,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["BA","(","BM",",","BL",",","BK","[","1","]",",","BK","[","2","]",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SIZE_RAMP_LENGTH",3,{type:"g_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["BA","(","BM",",","BL",",","BK","[","2","]",",","BK","[","3","]",")",";"]}]}}]},{type:"textline",tokens:["return","BM",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["COLOR_RAMP_LENGTH",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","BT","(","float","BO",",","float","BP",",","vec4","BQ","[","COLOR_RAMP_LENGTH","]",")","{","float","BR","=","BO","/","BP",";","vec3","BS","=","BQ","[",
"0","]",".","yzw",";"]},{type:"condition",parts:[{type:"if",expression:["COLOR_RAMP_LENGTH",1,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["BH","(","BS",",","BR",",","BQ","[","0","]",",","BQ","[","1","]",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["COLOR_RAMP_LENGTH",2,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["BH","(","BS",",","BR",",","BQ","[","1","]",",","BQ","[","2","]",")",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["COLOR_RAMP_LENGTH",3,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["BH","(","BS",",","BR",",","BQ","[","2","]",",","BQ","[","3","]",")",";"]}]}}]},{type:"textline",tokens:["return","BS",";","}"]}]}}]},{type:"textline",tokens:["float","Cb","(","float","BU",",","float","BV",",","float","BW",",","float","BX",")","{","float","BY","=","max","(","0.01",",","min","(","BV",",","BW",")",")",";","float","BZ","=","max","(","0.01",",","min","(","BV",",","BX",")",")",
";","float","B_","=","BV","-","BZ",";","float","Ca","=","clamp","(","BU","/","BY",",","0.0",",","1.0",")","-","step","(","B_",",","BU",")","*","(","BU","-","B_",")","/","BZ",";","return","Ca",";","}","Bt","Ch","(",")","{","Bt","Cc",";","float","Cd",";","if","(","u_p_cyclic","==","1",")","{","Cd","=","mod","(","u_p_time",",","u_p_length",")","-","a_p_delay",";","if","(","Cd","<","0.0",")","Cd","+=","u_p_length",";","}","if","(","u_p_cyclic","!=","1",")","{","Cd","=","u_p_time","-","a_p_delay",";",
"}","if","(","Cd","<","0.0","||","Cd",">=","a_p_lifetime",")","{","Cc",".","a","=","0.0001",";","Cc",".","b","=","vec3","(","99999.0",",","0.0",",","0.0",")",";","}","if","(","!","(","Cd","<","0.0","||","Cd",">=","a_p_lifetime",")",")","{"]},{type:"condition",parts:[{type:"if",expression:["WORLD_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","Ce","=","a_position",";","vec3","Cf","=","a_normal",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","Ce",
"=","(","u_model_matrix","*","vec4","(","a_position",",","1.0",")",")",".","xyz",";","vec3","Cf","=","(","u_model_matrix","*","vec4","(","a_normal",",","0.0",")",")",".","xyz",";"]}]}}]},{type:"textline",tokens:["Ce","+=","u_p_nfactor","*","Cd","*","Cf",";","Ce","+=","a_p_vels",".","xyz","*","Cd",";","Ce",".","y","-=","u_p_gravity","*","Cd","*","Cd","/","2.0",";","float","Cg","=","max","(","u_p_mass",",","EPSILON",")",";","Ce","+=","(","u_p_wind_fac","*","u_wind","/","Cg",")","*","Cd","*","Cd","/",
"2.0",";","Cc",".","b","=","Ce",";","Cc",".","e","=","a_p_vels",".","w","*","Cd",";"]},{type:"condition",parts:[{type:"if",expression:["SIZE_RAMP_LENGTH",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Cc",".","a","=","BN","(","Cd",",","u_p_max_lifetime",",","u_p_size_ramp",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Cc",".","a","=","1.0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["COLOR_RAMP_LENGTH",0,{type:"g_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Cc",".","d","=","BT","(","Cd",",","u_p_max_lifetime",",","u_p_color_ramp",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Cc",".","d","=","vec3","(","1.0",")",";"]}]}}]},{type:"textline",tokens:["Cc",".","c","=","Cb","(","Cd",",","a_p_lifetime",",","u_p_fade_in",",","u_p_fade_out",")",";","}","return","Cc",";","}"]}]},exports["include/blending.glslf"]={type:"group",parts:[{type:"textline",tokens:["float",
"Cj","=","0.0",";","float","Ck","=","1.0",";","vec3","Cl","=","vec3","(","Cj",")",";","vec3","Cm","=","vec3","(","Ck",")",";","vec3","Ct","(","vec3","Cn",")","{","vec4","Co","=","vec4","(","Cj",",","-","Ck","/","3.0",",","2.0","/","3.0",",","-","Ck",")",";","vec4","Cp","=","mix","(","vec4","(","Cn",".","bg",",","Co",".","wz",")",",","vec4","(","Cn",".","gb",",","Co",".","xy",")",",","step","(","Cn",".","b",",","Cn",".","g",")",")",";","vec4","Cq","=","mix","(","vec4","(","Cp",".","xyw",",","Cn",".",
"r",")",",","vec4","(","Cn",".","r",",","Cp",".","yzx",")",",","step","(","Cp",".","x",",","Cn",".","r",")",")",";","float","Cr","=","Cq",".","x","-","min","(","Cq",".","w",",","Cq",".","y",")",";","float","Cs","=","1.0e-10",";","return","vec3","(","abs","(","Cq",".","z","+","(","Cq",".","w","-","Cq",".","y",")","/","(","6.0","*","Cr","+","Cs",")",")",",","Cr","/","(","Cq",".","x","+","Cs",")",",","Cq",".","x",")",";","}","vec3","Cx","(","vec3","Cu",")","{","vec4","Cv","=","vec4","(","Ck",",","2.0",
"/","3.0",",","Ck","/","3.0",",","3.0",")",";","vec3","Cw","=","abs","(","fract","(","vec3","(","Cu",".","r",",","Cu",".","r",",","Cu",".","r",")","+","Cv",".","xyz",")","*","6.0","-","Cv",".","www",")",";","return","Cu",".","b","*","mix","(","Cv",".","xxx",",","clamp","(","Cw","-","Cv",".","xxx",",","Cj",",","Ck",")",",","Cu",".","g",")",";","}","vec3","CB","(","vec3","Cy",",","vec3","Cz",",","float","CA",")","{","return","mix","(","Cy",",","Cz",",","CA",")",";","}","vec3","CF","(","vec3","CC",",",
"vec3","CD",",","float","CE",")","{","return","CE","*","CC","+","CD",";","}","vec3","CJ","(","vec3","CG",",","vec3","CH",",","float","CI",")","{","return","CH","-","CI","*","CG",";","}","vec3","CO","(","vec3","CK",",","vec3","CL",",","float","CM",")","{","float","CN","=","Ck","-","CM",";","return","(","vec3","(","CN",")","+","CM","*","CK",")","*","CL",";","}","vec3","CT","(","vec3","CP",",","vec3","CQ",",","float","CR",")","{","vec3","CS","=","vec3","(","Ck","-","CR",")",";","return","Cm","-","(",
"CS","+","CR","*","(","Cm","-","CP",")",")","*","(","Cm","-","CQ",")",";","}","vec3","CY","(","vec3","CU",",","vec3","CV",",","float","CW",")","{","vec3","CX","=","vec3","(","Ck","-","CW",")",";","return","mix","(","CV","*","(","CX","+","2.0","*","CW","*","CU",")",",","Cm","-","(","CX","+","2.0","*","CW","*","(","Cm","-","CU",")",")","*","(","Cm","-","CV",")",",","step","(","0.5",",","CV",")",")",";","}","vec3","Db","(","vec3","CZ",",","vec3","C_",",","float","Da",")","{","return","mix","(","C_",
",","abs","(","CZ","-","C_",")",",","Da",")",";","}","vec3","Df","(","vec3","Dc",",","vec3","Dd",",","float","De",")","{","return","mix","(","Dd",",","Dd","/","(","Dc","+","step","(","Dc",",","Cl",")",")",",","De",")",";","}","vec3","Dj","(","vec3","Dg",",","vec3","Dh",",","float","Di",")","{","return","mix","(","Dh",",","min","(","Dg",",","Dh",")",",","Di",")",";","}","vec3","Dn","(","vec3","Dk",",","vec3","Dl",",","float","Dm",")","{","return","max","(","Dm","*","Dk",",","Dl",")",";","}","vec3",
"Du","(","vec3","Do",",","vec3","Dp",",","float","Dq",")","{","vec3","Dr","=","Ct","(","Dp",")",";","if","(","Dr",".","y","!=","Cj",")","{","vec3","Ds","=","Ct","(","Do",")",";","vec3","Dt","=","Cx","(","vec3","(","Dr",".","x",",","Ds",".","yz",")",")",";","return","mix","(","Do",",","Dt",",","Dq",")",";","}","return","Do",";","}","vec3","DA","(","vec3","Dv",",","vec3","Dw",",","float","Dx",")","{","vec3","Dy","=","Ct","(","Dv",")",";","if","(","Dy",".","y","!=","Cj",")","{","vec3","Dz","=","Ct",
"(","Dw",")",";","return","Cx","(","vec3","(","Dy",".","x",",","mix","(","Dy",".","y",",","Dz",".","y",",","Dx",")",",","Dy",".","z",")",")",";","}","return","Dv",";","}","vec3","DG","(","vec3","DB",",","vec3","DC",",","float","DD",")","{","vec3","DE","=","Ct","(","DB",")",";","vec3","DF","=","Ct","(","DC",")",";","return","Cx","(","vec3","(","DE",".","xy",",","mix","(","DE",".","z",",","DF",".","z",",","DD",")",")",")",";","}","vec3","DN","(","vec3","DH",",","vec3","DI",",","float","DJ",")","{",
"vec3","DK","=","Ct","(","DI",")",";","if","(","DK",".","y","!=","Cj",")","{","vec3","DL","=","Ct","(","DH",")",";","vec3","DM","=","Cx","(","vec3","(","DK",".","xy",",","DL",".","z",")",")",";","return","mix","(","DH",",","DM",",","DJ",")",";","}","return","DH",";","}","vec3","DS","(","vec3","DO",",","vec3","DP",",","float","DQ",")","{","vec3","DR","=","Cm","-","(","Cm","-","DP",")","*","(","Cm","-","DO",")",";","return","mix","(","DO",",","(","(","Cm","-","DO",")","*","DP","*","DO",")","+","DO",
"*","DR",",","DQ",")",";","}","vec3","DW","(","vec3","DT",",","vec3","DU",",","float","DV",")","{","return","DT","+","DV","*","(","2.0","*","DU","-","Ck",")",";","}","float","Eb","(","float","DX",",","float","DY",",","float","DZ",",","float","D_",")","{","float","Ea","=","Ck","-","D_",";","return","(","Ea","+","DZ","*","DX",")","*","DY",";","}","float","Eh","(","float","Ec",",","float","Ed",",","float","Ee",",","float","Ef",")","{","float","Eg","=","Ck","-","Ef",";","return","Ck","-","(","Eg","+",
"Ee","*","(","Ck","-","Ec",")",")","*","(","Ck","-","Ed",")",";","}","float","En","(","float","Ei",",","float","Ej",",","float","Ek",",","float","El",")","{","float","Em","=","Ck","-","El",";","return","mix","(","Ej","*","(","Em","+","2.0","*","Ek","*","Ei",")",",","Ck","-","(","Em","+","2.0","*","Ek","*","(","Ck","-","Ei",")",")","*","(","Ck","-","Ej",")",",","step","(","0.5",",","Ej",")",")",";","}"]}]},exports["include/depth_fetch.glslf"]={type:"group",parts:[{type:"textline",tokens:["float","EA",
"(","in","sampler2D","Et",",","in","vec2","Eu",",","in","vec2","Ev",")","{","float","Ew","=","texture2D","(","Et",",","Eu",")",".","r",";","float","Ex","=","Ev",".","x",";","float","Ey","=","Ev",".","y",";","float","Ez","=","2.0","*","Ex","/","(","Ex","+","Ey","-","(","2.0","*","Ew","-","1.0",")","*","(","Ey","-","Ex",")",")",";","return","Ez",";","}"]}]}};b4w.module["animation"]=function(exports,require){var m_anim=require("__animation");var m_print=require("__print");var m_armat=require("__armature");var m_obj_util=require("__obj_util");exports.SLOT_0=m_anim.SLOT_0;exports.SLOT_1=m_anim.SLOT_1;exports.SLOT_2=m_anim.SLOT_2;exports.SLOT_3=m_anim.SLOT_3;exports.SLOT_4=m_anim.SLOT_4;exports.SLOT_5=m_anim.SLOT_5;exports.SLOT_6=m_anim.SLOT_6;exports.SLOT_7=m_anim.SLOT_7;exports.SLOT_ALL=m_anim.SLOT_ALL;exports.OBJ_ANIM_TYPE_NONE=m_anim.OBJ_ANIM_TYPE_NONE;
exports.OBJ_ANIM_TYPE_ARMATURE=m_anim.OBJ_ANIM_TYPE_ARMATURE;exports.OBJ_ANIM_TYPE_OBJECT=m_anim.OBJ_ANIM_TYPE_OBJECT;exports.OBJ_ANIM_TYPE_VERTEX=m_anim.OBJ_ANIM_TYPE_VERTEX;exports.OBJ_ANIM_TYPE_SOUND=m_anim.OBJ_ANIM_TYPE_SOUND;exports.OBJ_ANIM_TYPE_PARTICLES=m_anim.OBJ_ANIM_TYPE_PARTICLES;exports.OBJ_ANIM_TYPE_MATERIAL=m_anim.OBJ_ANIM_TYPE_MATERIAL;exports.AB_CYCLIC=m_anim.AB_CYCLIC;exports.AB_FINISH_RESET=m_anim.AB_FINISH_RESET;exports.AB_FINISH_STOP=m_anim.AB_FINISH_STOP;var _tsr8_tmp=new Float32Array(8);
exports.is_animated=function(obj){return m_anim.is_animated(obj)};exports.get_actions=function(){m_print.error("get_actions() deprecated, use get_anim_names() instead");var anames=[];var actions=m_anim.get_all_actions();for(var i=0;i<actions.length;i++)anames.push(m_anim.strip_baked_suffix(actions[i]["name"]));return anames};exports.get_current_action=function(obj,slot_num){m_print.error("get_current_action() deprecated, use get_current_anim_name() instead");return exports.get_current_anim_name(obj,
slot_num)};exports.get_anim_names=function(obj){if(!m_anim.obj_is_animatable(obj))return[];return m_anim.get_anim_names(obj)};exports.get_current_anim_name=function(obj,slot_num){if(!m_anim.is_animated(obj))return null;slot_num=slot_num||m_anim.SLOT_0;return m_anim.get_anim_by_slot_num(obj,slot_num)};exports.apply=function(obj,name,slot_num){if(slot_num>m_anim.SLOT_7){m_print.error("Can't apply animation to slot "+slot_num+' for object "'+obj.name+'". Object can have maximum of 8 animation slots');
return}slot_num=slot_num||m_anim.SLOT_0;if(m_anim.is_animated(obj)){var applied_slot=m_anim.get_slot_num_by_anim(obj,name);if(applied_slot!=-1&&applied_slot!=slot_num){m_print.error('Animation "'+name+'" is already applied to object "'+obj.name+'" (slot "'+applied_slot+'").');return}}if(!m_anim.validate_action_by_name(obj,name)){m_print.error('No fcurves in action "'+name+'"');return}m_anim.apply(obj,name,slot_num)};exports.remove=function(obj){m_anim.remove(obj)};exports.remove_slot_animation=function(obj,
slot_num){if(!m_anim.is_animated(obj))return;slot_num=slot_num||m_anim.SLOT_0;m_anim.remove_slot_animation(obj,slot_num)};exports.apply_def=function(obj){m_anim.apply_def(obj)};exports.play=function(obj,finish_callback,slot_num){if(!m_anim.is_animated(obj)){m_print.error('Object "'+obj.name+'" has no applied animation');return}slot_num=slot_num||m_anim.SLOT_0;m_anim.play(obj,finish_callback,slot_num);m_anim.update_object_animation(obj,0,slot_num,true)};exports.stop=function(obj,slot_num){if(m_anim.is_animated(obj)){slot_num=
slot_num||m_anim.SLOT_0;m_anim.stop(obj,slot_num)}};exports.is_play=function(obj,slot_num){if(!m_anim.is_animated(obj))return false;slot_num=slot_num||m_anim.SLOT_0;return m_anim.is_play(obj,slot_num)};exports.set_current_frame_float=function(obj,cff,slot_num){m_print.error("set_current_frame_float() deprecated, use set_frame() instead");exports.set_frame(obj,cff,slot_num)};exports.get_current_frame_float=function(obj,slot_num){m_print.error("get_current_frame_float() deprecated, use get_frame() instead");
return exports.get_frame(obj,slot_num)};exports.set_frame=function(obj,frame,slot_num){if(!m_anim.is_animated(obj))return;slot_num=slot_num||m_anim.SLOT_0;m_anim.set_frame(obj,frame,slot_num)};exports.set_first_frame=function(obj,slot_num){if(!m_anim.is_animated(obj))return;m_anim.set_first_frame(obj,slot_num)};exports.set_last_frame=function(obj,slot_num){if(!m_anim.is_animated(obj))return;slot_num=slot_num||m_anim.SLOT_0;var start=m_anim.get_anim_start_frame(obj,slot_num);var len=m_anim.get_anim_length(obj,
slot_num);m_anim.set_frame(obj,start+len-m_anim.LAST_FRAME_EPSILON,slot_num)};exports.get_frame=function(obj,slot_num){if(!m_anim.is_animated(obj))return 0;slot_num=slot_num||m_anim.SLOT_0;return m_anim.get_current_frame_float(obj,slot_num)};exports.set_speed=function(obj,speed,slot_num){if(!m_anim.is_animated(obj))return;slot_num=slot_num||m_anim.SLOT_0;speed=speed||1;m_anim.set_speed(obj,speed,slot_num)};exports.get_speed=function(obj,slot_num){if(!m_anim.is_animated(obj))return 0;slot_num=slot_num||
m_anim.SLOT_0;if(!obj.anim_slots[slot_num])return 0;return m_anim.get_speed(obj,slot_num)};exports.get_frame_range=function(obj,slot_num){m_print.error("get_frame_range() deprecated, use get_anim_start_frame() and get_anim_length() instead");if(m_anim.is_animated(obj)){slot_num=slot_num||m_anim.SLOT_0;var anim_slot=obj.anim_slots[slot_num];if(anim_slot)return[anim_slot.start,anim_slot.start+anim_slot.length]}return null};exports.get_anim_start_frame=function(obj,slot_num){if(m_anim.is_animated(obj)){slot_num=
slot_num||m_anim.SLOT_0;if(!obj.anim_slots[slot_num])return-1;else return m_anim.get_anim_start_frame(obj,slot_num)}return-1};exports.get_anim_length=function(obj,slot_num){if(m_anim.is_animated(obj)){slot_num=slot_num||m_anim.SLOT_0;if(!obj.anim_slots[slot_num])return-1;else return m_anim.get_anim_length(obj,slot_num)}return-1};exports.cyclic=function(obj,cyclic_flag,slot_num){m_print.error("cyclic() deprecated, use set_behavior() instead");var behavior=cyclic_flag?m_anim.AB_CYCLIC:m_anim.AB_FINISH_RESET;
exports.set_behavior(obj,behavior,slot_num)};exports.is_cyclic=function(obj,slot_num){m_print.error("is_cyclic() deprecated, use get_behavior() instead");if(!m_anim.is_animated(obj))return false;slot_num=slot_num||m_anim.SLOT_0;return m_anim.is_cyclic(obj,slot_num)};exports.set_behavior=function(obj,behavior,slot_num){if(!m_anim.is_animated(obj))return;slot_num=slot_num||m_anim.SLOT_0;m_anim.set_behavior(obj,behavior,slot_num)};exports.get_behavior=function(obj,slot_num){if(!m_anim.is_animated(obj))return null;
slot_num=slot_num||m_anim.SLOT_0;return m_anim.get_behavior(obj,slot_num)};exports.apply_smoothing=function(obj,trans_period,quat_period,slot_num){slot_num=slot_num||m_anim.SLOT_0;if(m_anim.is_animated(obj))m_anim.apply_smoothing(obj,trans_period,quat_period,slot_num)};exports.update_object_animation=function(obj,elapsed,slot_num,force_update){m_print.error("update_object_animation() deprecated, use set_frame() instead");if(!m_anim.is_animated(obj))return;slot_num=slot_num||m_anim.SLOT_0;elapsed=
elapsed||0;force_update=force_update||false;m_anim.update_object_animation(obj,elapsed,slot_num,force_update)};exports.frame_to_sec=function(frame){return m_anim.frame_to_sec(frame)};exports.get_bone_translation=function(armobj,bone_name,dest){m_print.error("get_bone_translation() deprecated, use armature.get_bone_tsr() instead");if(!m_obj_util.is_armature(armobj))return null;if(!m_armat.check_bone(armobj,bone_name)){m_print.error('There is no bone: "',bone_name,'" in "',armobj.name,'".');return null}if(!dest)var dest=
new Float32Array(3);var tsr=_tsr8_tmp;m_armat.get_bone_tsr(armobj,bone_name,false,false,tsr);dest[0]=tsr[0];dest[1]=tsr[1];dest[2]=tsr[2];return dest};exports.get_first_armature_object=function(obj){m_print.error("get_first_armature_object() deprecated");return null};exports.get_slot_num_by_anim=function(obj,anim_name){if(!m_anim.is_animated(obj)||!anim_name)return null;return m_anim.get_slot_num_by_anim(obj,anim_name)};exports.get_anim_type=function(obj,slot_num){if(!m_anim.is_animated(obj))return null;
return m_anim.get_anim_type(obj,slot_num)};exports.apply_to_first_empty_slot=function(obj,name){return m_anim.apply_to_first_empty_slot(obj,name)};exports.get_skel_mix_factor=function(armobj){return armobj.render.anim_mix_factor};exports.set_skel_mix_factor=function(armobj,factor,time){if(!m_obj_util.is_armature(armobj)){m_print.error("Can't blend animation. Object \""+armobj.name+'" is not armature');return}factor=Math.min(Math.max(factor,0),1);if(armobj.render.anim_mix_factor==factor)return;time=
time||0;m_anim.set_skel_mix_factor(armobj,factor,time)}};b4w.module["anchors"]=function(exports,require){var m_anchors=require("__anchors");var m_print=require("__print");exports.attach_move_cb=m_anchors.attach_move_cb;exports.detach_move_cb=m_anchors.detach_move_cb;exports.is_anchor=m_anchors.is_anchor;exports.get_element_id=m_anchors.get_element_id};b4w.module["armature"]=function(exports,require){var m_armat=require("__armature");var m_obj_util=require("__obj_util");var m_trans=require("__transform");var m_print=require("__print");exports.get_bone_tsr=function(armobj,bone_name,dest){if(!m_obj_util.is_armature(armobj))return null;if(!m_armat.check_bone(armobj,bone_name)){m_print.error('There is no bone: "',bone_name,'" in "',armobj.name,'".');return null}if(!dest)var dest=new Float32Array(8);m_armat.get_bone_tsr(armobj,bone_name,false,false,
dest);return dest};exports.get_bone_tsr_rel=function(armobj,bone_name,dest){if(!m_obj_util.is_armature(armobj))return null;if(!m_armat.check_bone(armobj,bone_name)){m_print.error('There is no bone: "',bone_name,'" in "',armobj.name,'".');return null}if(!dest)var dest=new Float32Array(8);m_armat.get_bone_tsr(armobj,bone_name,false,true,dest);return dest};exports.set_bone_tsr=function(armobj,bone_name,tsr){if(!m_obj_util.is_armature(armobj))return;if(!m_armat.check_bone(armobj,bone_name)){m_print.error('There is no bone: "',
bone_name,'" in "',armobj.name,'".');return}m_armat.set_bone_tsr(armobj,bone_name,tsr,false);m_trans.update_transform(armobj)};exports.set_bone_tsr_rel=function(armobj,bone_name,tsr){if(!m_obj_util.is_armature(armobj))return;if(!m_armat.check_bone(armobj,bone_name)){m_print.error('There is no bone: "',bone_name,'" in "',armobj.name,'".');return}m_armat.set_bone_tsr(armobj,bone_name,tsr,true);m_trans.update_transform(armobj)}};b4w.module["assets"]=function(exports,require){var m_assets=require("__assets");exports.AT_ARRAYBUFFER=m_assets.AT_ARRAYBUFFER;exports.AT_JSON=m_assets.AT_JSON;exports.AT_TEXT=m_assets.AT_TEXT;exports.AT_AUDIOBUFFER=m_assets.AT_AUDIOBUFFER;exports.AT_IMAGE_ELEMENT=m_assets.AT_IMAGE_ELEMENT;exports.AT_AUDIO_ELEMENT=m_assets.AT_AUDIO_ELEMENT;exports.enqueue=function(assets_pack,asset_cb,pack_cb,progress_cb){m_assets.enqueue(assets_pack,asset_cb,pack_cb,progress_cb)}};b4w.module["camera"]=function(exports,require){var m_cam=require("__camera");var m_cfg=require("__config");var m_cons=require("__constraints");var m_cont=require("__container");var m_mat3=require("__mat3");var m_mat4=require("__mat4");var m_obj_util=require("__obj_util");var m_phy=require("__physics");var m_print=require("__print");var m_trans=require("__transform");var m_util=require("__util");var m_vec3=require("__vec3");var m_vec4=require("__vec4");var cfg_ctl=m_cfg.controls;var _vec2_tmp=new Float32Array(2);
var _vec3_tmp=new Float32Array(3);var _vec3_tmp2=new Float32Array(3);var _vec4_tmp=new Float32Array(4);var _mat3_tmp=new Float32Array(9);var PIVOT_DEFAULT_DIST=10;exports.MS_STATIC=m_cam.MS_STATIC;exports.MS_ANIMATION=m_cam.MS_STATIC;exports.MS_TARGET_CONTROLS=m_cam.MS_TARGET_CONTROLS;exports.MS_EYE_CONTROLS=m_cam.MS_EYE_CONTROLS;exports.MS_HOVER_CONTROLS=m_cam.MS_HOVER_CONTROLS;exports.is_camera=function(obj){m_print.error("camera.is_camera() deprecated, use objects.is_camera() instead");return m_obj_util.is_camera(obj)};
exports.is_target_camera=m_cam.is_target_camera;exports.is_eye_camera=m_cam.is_eye_camera;exports.is_hover_camera=m_cam.is_hover_camera;exports.set_move_style=function(camobj,move_style){if(!m_obj_util.is_camera(camobj)){m_print.error("set_move_style(): Wrong object");return false}if(move_style!=m_cam.MS_STATIC&&move_style!=m_cam.MS_EYE_CONTROLS&&move_style!=m_cam.MS_HOVER_CONTROLS&&move_style!=m_cam.MS_TARGET_CONTROLS){m_print.error("set_move_style(): Wrong camera move style");return false}camobj.render.move_style=
move_style;camobj.render.horizontal_limits=null;camobj.render.vertical_limits=null;camobj.render.hover_angle_limits=null;camobj.render.use_distance_limits=false;m_cam.init_ortho_props(camobj);switch(move_style){case m_cam.MS_STATIC:case m_cam.MS_EYE_CONTROLS:case m_cam.MS_HOVER_CONTROLS:break;case m_cam.MS_TARGET_CONTROLS:var cam_eye=get_eye(camobj,_vec3_tmp);var view_vector=m_util.quat_to_dir(camobj.render.quat,m_util.AXIS_MY,_vec3_tmp2);var pivot=m_vec3.scaleAndAdd(cam_eye,view_vector,PIVOT_DEFAULT_DIST,
view_vector);m_vec3.copy(pivot,camobj.render.pivot);break}m_trans.update_transform(camobj);m_phy.sync_transform(camobj);return true};exports.get_move_style=function(camobj){if(!m_obj_util.is_camera(camobj)){m_print.error("get_move_style(): Wrong object");return null}return m_cam.get_move_style(camobj)};exports.set_velocity_params=function(camobj,velocity){if(!m_cam.is_target_camera(camobj)&&!m_cam.is_eye_camera(camobj)&&!m_cam.is_hover_camera(camobj)){m_print.error("set_velocity_params(): Wrong object or camera move style");
return}var render=camobj.render;render.velocity_trans=m_util.clamp(velocity[0],0,Infinity);render.velocity_rot=m_util.clamp(velocity[1],0,Infinity);render.velocity_zoom=m_util.clamp(velocity[2],0,1)};exports.get_velocity_params=function(camobj,dest){if(!m_cam.is_target_camera(camobj)&&!m_cam.is_eye_camera(camobj)&&!m_cam.is_hover_camera(camobj)){m_print.error("get_velocity_params(): Wrong object or camera move style");return null}if(!dest)dest=new Float32Array(3);var render=camobj.render;dest[0]=
render.velocity_trans;dest[1]=render.velocity_rot;dest[2]=render.velocity_zoom;return dest};exports.set_look_at=function(camobj,eye,target,up){var render=camobj.render;m_cam.eye_target_up_to_trans_quat(eye,target,up,render.trans,render.quat);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.get_eye=get_eye;function get_eye(camobj,dest){if(!m_obj_util.is_camera(camobj)){m_print.error("get_eye(): Wrong object");return null}if(!dest)var dest=new Float32Array(3);m_vec3.copy(camobj.render.trans,
dest);return dest}exports.set_pivot=set_pivot;function set_pivot(camobj,coords){if(!m_cam.is_target_camera(camobj)){m_print.error("set_pivot(): Wrong object or camera move style");return}m_vec3.copy(coords,camobj.render.pivot);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)}exports.set_trans_pivot=set_trans_pivot;function set_trans_pivot(camobj,trans,pivot){if(!m_cam.is_target_camera(camobj)){m_print.error("set_trans_pivot(): Wrong object or camera move style");return}m_vec3.copy(trans,
camobj.render.trans);m_vec3.copy(pivot,camobj.render.pivot);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)}exports.get_pivot=function(camobj,dest){if(!m_cam.is_target_camera(camobj)){m_print.error("get_pivot(): Wrong object or camera move style");return null}if(!dest)var dest=new Float32Array(3);var render=camobj.render;m_vec3.copy(render.pivot,dest);return dest};exports.rotate_pivot=function(camobj,delta_phi,delta_theta){m_print.error("rotate_pivot() deprecated, use rotate_camera() or rotate_target_camera() instead");
exports.rotate_target_camera(camobj,delta_phi,delta_theta)};exports.move_pivot=function(camobj,trans_h_delta,trans_v_delta){if(!m_cam.is_target_camera(camobj)){m_print.error("move_pivot(): wrong object");return}var render=camobj.render;if(render.use_panning){var mat=m_mat3.fromMat4(render.world_matrix,_mat3_tmp);var trans_vector=_vec3_tmp;var dist_vector=m_vec3.subtract(render.trans,render.pivot,_vec3_tmp2);trans_vector[0]=trans_h_delta;trans_vector[1]=0;trans_vector[2]=trans_v_delta;m_vec3.scale(trans_vector,
m_vec3.len(dist_vector),trans_vector);m_vec3.transformMat3(trans_vector,mat,trans_vector);m_vec3.add(render.pivot,trans_vector,render.pivot);m_vec3.add(render.trans,trans_vector,render.trans);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)}};exports.rotate_hover_cam=function(camobj,angle){m_print.error("rotate_hover_cam() deprecated, use rotate_camera() or rotate_hover_camera() instead");exports.rotate_hover_camera(camobj,angle,0)};exports.get_hover_cam_angle=function(camobj){m_print.error("get_hover_cam_angle() deprecated, use get_camera_angles() instead");
if(!m_cam.is_hover_camera(camobj)){m_print.error("get_hover_cam_angle(): wrong object or camera move style");return null}return-m_cam.get_camera_angles(camobj,_vec2_tmp)[1]};exports.set_hover_cam_angle=function(camobj,angle){m_print.error("set_hover_cam_angle() deprecated, use rotate_camera() or rotate_hover_camera() instead");if(!m_cam.is_hover_camera(camobj)){m_print.error("set_hover_cam_angle(): wrong object or camera move style");return}var render=camobj.render;if(!render.use_distance_limits){m_print.error("set_hover_cam_angle(): distance/hover_angle limits are not defined or disabled");
return}var angles=m_cam.get_camera_angles(camobj,_vec2_tmp);var angle_ccw=-angle;var rot_angle=angle_ccw-angles[1];if(rot_angle)m_cam.rotate_hover_camera(camobj,0,rot_angle);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.get_hover_angle_limits=function(camobj,angles){if(!m_cam.is_hover_camera(camobj)){m_print.error("get_hover_angle_limits(): wrong object");return null}if(camobj.render.hover_angle_limits){if(!angles)angles=new Float32Array(2);angles[0]=camobj.render.hover_angle_limits.down;
angles[1]=camobj.render.hover_angle_limits.up}else m_print.error("get_hover_angle_limits(): camera hasn't angle limits");return angles};exports.get_cam_dist_limits=function(camobj,dist){if(!m_cam.is_hover_camera(camobj)&&!m_cam.is_target_camera(camobj)){m_print.error("get_cam_dist_limits(): wrong object");return null}if(camobj.render.use_distance_limits){if(!dist)dist=new Float32Array(2);dist[0]=camobj.render.distance_max;dist[1]=camobj.render.distance_min}else m_print.error("get_cam_dist_limits(): camera hasn't distance limits");
return dist};exports.translate_hover_cam_v=function(camobj,trans){m_print.error("translate_hover_cam_v() deprecated, use hover_cam_set_translation() instead");exports.hover_cam_set_translation(camobj,trans)};exports.hover_cam_set_translation=function(camobj,trans){if(!m_cam.is_hover_camera(camobj)){m_print.error("hover_cam_set_translation(): wrong object");return}var render=camobj.render;if(render.use_distance_limits){var trans_delta=m_vec3.subtract(trans,render.trans,_vec3_tmp);m_vec3.add(trans_delta,
render.hover_pivot,render.hover_pivot)}m_trans.set_translation(camobj,trans);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.set_hover_pivot=set_hover_pivot;function set_hover_pivot(camobj,coords){if(!m_cam.is_hover_camera(camobj)){m_print.error("set_hover_pivot(): Wrong object or camera move style");return}var render=camobj.render;if(render.use_distance_limits&&render.hover_angle_limits){var pivot_delta=m_vec3.subtract(coords,render.hover_pivot,_vec3_tmp);var trans=m_vec3.add(pivot_delta,
render.trans,pivot_delta);m_trans.set_translation(camobj,trans)}m_vec3.copy(coords,render.hover_pivot);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)}exports.get_hover_cam_pivot=function(camobj,dest){if(!m_cam.is_hover_camera(camobj)){m_print.error("get_hover_cam_pivot(): wrong object");return null}if(!dest)dest=new Float32Array(3);m_vec3.copy(camobj.render.hover_pivot,dest);return dest};exports.has_distance_limits=function(camobj){if(!m_cam.is_target_camera(camobj)&&!m_cam.is_hover_camera(camobj)){m_print.error("has_distance_limits(): wrong object");
return null}return camobj.render.use_distance_limits};exports.apply_vertical_limits=function(camobj,down_value,up_value,space){var ms=m_cam.get_move_style(camobj);switch(ms){case m_cam.MS_TARGET_CONTROLS:case m_cam.MS_EYE_CONTROLS:space=space|m_trans.SPACE_WORLD;break;case m_cam.MS_HOVER_CONTROLS:if(down_value>up_value){m_print.error("apply_vertical_limits(): wrong vertical limits");return}break;default:m_print.error("apply_vertical_limits(): wrong object");return;break}var render=camobj.render;render.vertical_limits=
{down:down_value,up:up_value};m_cam.prepare_vertical_limits(camobj,space==m_trans.SPACE_LOCAL);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.clear_vertical_limits=function(camobj){var render=camobj.render;render.vertical_limits=null};exports.get_vertical_limits=function(camobj,dest){if(!m_cam.is_target_camera(camobj)&&!m_cam.is_eye_camera(camobj)&&!m_cam.is_hover_camera(camobj)){m_print.error("get_vertical_limits(): wrong object");return null}var render=camobj.render;dest=
dest||new Float32Array(2);if(render.vertical_limits){dest[0]=render.vertical_limits.down;dest[1]=render.vertical_limits.up;return dest}return null};exports.has_vertical_limits=function(camobj){if(!m_cam.is_target_camera(camobj)&&!m_cam.is_eye_camera(camobj)&&!m_cam.is_hover_camera(camobj)){m_print.error("has_vertical_limits(): wrong object");return null}return Boolean(camobj.render.vertical_limits)};exports.apply_horizontal_limits=function(camobj,left_value,right_value,space){var ms=m_cam.get_move_style(camobj);
switch(ms){case m_cam.MS_TARGET_CONTROLS:case m_cam.MS_EYE_CONTROLS:space=space|m_trans.SPACE_WORLD;break;case m_cam.MS_HOVER_CONTROLS:if(left_value>right_value){m_print.error("apply_horizontal_limits(): wrong horizontal limits");return}break;default:m_print.error("apply_horizontal_limits(): wrong object");return;break}camobj.render.horizontal_limits={left:left_value,right:right_value};m_cam.prepare_horizontal_limits(camobj,space==m_trans.SPACE_LOCAL);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};
exports.clear_horizontal_limits=function(camobj){var render=camobj.render;render.horizontal_limits=null};exports.get_horizontal_limits=function(camobj,dest){if(!m_cam.is_target_camera(camobj)&&!m_cam.is_eye_camera(camobj)&&!m_cam.is_hover_camera(camobj)){m_print.error("get_horizontal_limits(): wrong object");return null}var render=camobj.render;dest=dest||new Float32Array(2);if(render.horizontal_limits){dest[0]=render.horizontal_limits.left;dest[1]=render.horizontal_limits.right;return dest}return null};
exports.has_horizontal_limits=function(camobj){if(!m_cam.is_target_camera(camobj)&&!m_cam.is_eye_camera(camobj)&&!m_cam.is_hover_camera(camobj)){m_print.error("has_horizontal_limits(): wrong object");return null}return Boolean(camobj.render.horizontal_limits)};exports.apply_hover_angle_limits=function(camobj,down_angle,up_angle){if(m_cam.is_hover_camera(camobj)){if(down_angle<up_angle){m_print.error("apply_hover_angle_limits(): wrong hover angle limits");return}var down_limit=m_util.angle_wrap_periodic(down_angle,
-Math.PI,Math.PI);var up_limit=m_util.angle_wrap_periodic(up_angle,-Math.PI,Math.PI);down_limit=m_util.clamp(down_limit,-Math.PI/2,0);up_limit=m_util.clamp(up_limit,-Math.PI/2,0);var render=camobj.render;render.hover_angle_limits={down:down_limit,up:up_limit};m_cam.hover_camera_update_distance(camobj)}else{m_print.error("apply_hover_angle_limits(): wrong object");return}m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.clear_hover_angle_limits=function(camobj){if(!m_cam.is_hover_camera(camobj)){m_print.error("clear_hover_angle_limits(): wrong object");
return}camobj.render.hover_angle_limits=null};exports.apply_distance_limits=function(camobj,min,max){if(!m_cam.is_target_camera(camobj)&&!m_cam.is_hover_camera(camobj)){m_print.error("apply_distance_limits(): wrong object");return}if(min>max){m_print.error("apply_distance_limits(): wrong distance limits");return}var render=camobj.render;render.use_distance_limits=true;render.distance_min=min;render.distance_max=max;m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.clear_distance_limits=
function(camobj){if(!m_cam.is_target_camera(camobj)&&!m_cam.is_hover_camera(camobj)){m_print.error("clear_distance_limits(): wrong object");return}camobj.render.use_distance_limits=false};exports.set_eye_params=function(camobj,h_angle,v_angle){m_print.error("set_eye_params() deprecated, use rotate_camera() or rotate_eye_camera() instead");exports.rotate_eye_camera(camobj,h_angle,Math.PI/2-v_angle)};exports.is_look_up=function(camobj){var quat=camobj.render.quat;var dir=_vec3_tmp;m_util.quat_to_dir(quat,
m_util.AXIS_MY,dir);if(dir[1]>=0)return true;else return false};exports.rotate_camera=function(camobj,phi,theta,phi_is_abs,theta_is_abs){var move_style=exports.get_move_style(camobj);switch(move_style){case m_cam.MS_STATIC:break;case m_cam.MS_TARGET_CONTROLS:m_cam.rotate_target_camera(camobj,phi,theta,phi_is_abs,theta_is_abs);break;case m_cam.MS_EYE_CONTROLS:m_cam.rotate_eye_camera(camobj,phi,theta,phi_is_abs,theta_is_abs);break;case m_cam.MS_HOVER_CONTROLS:m_cam.rotate_hover_camera(camobj,phi,theta,
phi_is_abs,theta_is_abs);break;default:m_print.error("rotate_camera(): Wrong object");break}m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.rotate_target_camera=function(camobj,phi,theta,phi_is_abs,theta_is_abs){if(!m_cam.is_target_camera(camobj)){m_print.error("rotate_target_camera(): wrong object");return}m_cam.rotate_target_camera(camobj,phi,theta,phi_is_abs,theta_is_abs);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.rotate_eye_camera=function(camobj,
phi,theta,phi_is_abs,theta_is_abs){if(!m_cam.is_eye_camera(camobj)){m_print.error("rotate_eye_camera(): wrong object");return}m_cam.rotate_eye_camera(camobj,phi,theta,phi_is_abs,theta_is_abs);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.rotate_hover_camera=function(camobj,phi,theta,phi_is_abs,theta_is_abs){if(!m_cam.is_hover_camera(camobj)){m_print.error("rotate_hover_camera(): wrong object");return}m_cam.rotate_hover_camera(camobj,phi,theta,phi_is_abs,theta_is_abs);m_trans.update_transform(camobj);
m_phy.sync_transform(camobj)};exports.rotate=function(camobj,delta_phi,delta_theta){m_print.error("rotate() deprecated, use rotate_camera() or rotate_eye_camera() instead");exports.rotate_eye_camera(camobj,delta_phi,-delta_theta)};exports.get_camera_angles=function(camobj,dest){if(!dest)var dest=new Float32Array(2);m_cam.get_camera_angles(camobj,dest);return dest};exports.get_camera_angles_char=function(camobj,dest){if(!dest)var dest=new Float32Array(2);m_cam.get_camera_angles_char(camobj,dest);return dest};
exports.get_angles=function(camobj,dest){m_print.error("get_angles() deprecated, use get_camera_angles() instead");if(!dest)var dest=new Float32Array(2);m_cam.get_angles(camobj,dest);return dest};exports.set_stereo_distance=function(camobj,conv_dist){var cameras=camobj.render.cameras;for(var i=0;i<cameras.length;i++){var cam=cameras[i];if(cam.type==m_cam.TYPE_STEREO_LEFT||cam.type==m_cam.TYPE_STEREO_RIGHT)m_cam.set_stereo_params(cam,conv_dist,cam.stereo_eye_dist)}};exports.get_stereo_distance=function(camobj){var cameras=
camobj.render.cameras;for(var i=0;i<cameras.length;i++){var cam=cameras[i];if(cam.type==m_cam.TYPE_STEREO_LEFT||cam.type==m_cam.TYPE_STEREO_RIGHT)return cam.stereo_conv_dist}return 0};exports.is_underwater=function(camobj){m_print.error("is_underwater() deprecated, always returns false");var render=camobj.render;return render.underwater};exports.translate_view=function(camobj,x,y,angle){var cameras=camobj.render.cameras;for(var i=0;i<cameras.length;i++){var cam=cameras[i];if(!cam.reflection_plane)m_cam.set_projection(cam,
cam.aspect);var vec3_tmp=_vec3_tmp;vec3_tmp[0]=-x;vec3_tmp[1]=-y;vec3_tmp[2]=0;m_mat4.translate(cam.proj_matrix,vec3_tmp,cam.proj_matrix);m_mat4.rotateZ(cam.proj_matrix,angle,cam.proj_matrix);m_mat4.multiply(cam.proj_matrix,cam.view_matrix,cam.view_proj_matrix);m_cam.calc_view_proj_inverse(cam);m_cam.calc_sky_vp_inverse(cam)}};exports.get_fov=function(camobj){return m_util.rad(camobj.render.cameras[0].fov)};exports.set_fov=function(camobj,fov){var cameras=camobj.render.cameras;for(var i=0;i<cameras.length;i++){var cam=
cameras[i];cam.fov=m_util.deg(fov);if(!cam.reflection_plane)m_cam.set_projection(cam,cam.aspect);m_mat4.multiply(cam.proj_matrix,cam.view_matrix,cam.view_proj_matrix);m_cam.calc_view_proj_inverse(cam);m_cam.calc_sky_vp_inverse(cam)}};exports.correct_up=function(camobj,y_axis){if(!y_axis)y_axis=m_util.AXIS_Y;m_cons.correct_up(camobj,y_axis)};exports.zoom_object=function(camobj,obj){if(!m_cam.is_target_camera(camobj)){m_print.error("zoom_object(): wrong object");return}var calc_bs_center=false;var center=
_vec3_tmp;m_trans.get_object_center(obj,calc_bs_center,center);set_pivot(camobj,center);m_trans.update_transform(camobj);var radius=m_trans.get_object_size(obj);var ang_radius=m_cam.get_angular_diameter(camobj)/2;var dist_need=radius/Math.sin(ang_radius);var dist_current=m_trans.obj_point_distance(camobj,center);m_trans.move_local(camobj,0,dist_need-dist_current,0);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.set_ortho_scale=function(camobj,ortho_scale){if(!m_obj_util.is_camera(camobj)||
!exports.is_ortho_camera(camobj)){m_print.error("set_ortho_scale(): wrong object");return}var render=camobj.render;if(m_cam.is_target_camera(camobj)){var dir_dist=m_vec3.dist(render.trans,render.pivot);render.init_top=ortho_scale/2*render.init_dist/dir_dist}else if(m_cam.is_hover_camera(camobj)&&exports.has_distance_limits(camobj)){var dir_dist=m_vec3.distance(render.trans,render.hover_pivot);render.init_top=ortho_scale/2*render.init_dist/dir_dist}else camobj.render.cameras[0].top=ortho_scale/2;m_cam.update_ortho_scale(camobj)};
exports.get_ortho_scale=function(camobj){if(!m_obj_util.is_camera(camobj)||!exports.is_ortho_camera(camobj)){m_print.error("get_ortho_scale(): wrong object");return null}return camobj.render.cameras[0].top*2};exports.is_ortho_camera=function(camobj){if(!m_obj_util.is_camera(camobj)){m_print.error("is_ortho_camera(): wrong object");return null}return camobj.render.cameras[0].type==m_cam.TYPE_ORTHO};exports.calc_ray=function(camobj,canvas_x,canvas_y,dest){if(!dest)var dest=new Float32Array(3);var cam=
camobj.render.cameras[0];switch(cam.type){case m_cam.TYPE_PERSP:case m_cam.TYPE_PERSP_ASPECT:case m_cam.TYPE_STEREO_LEFT:case m_cam.TYPE_STEREO_RIGHT:var top_1m=Math.tan(cam.fov*Math.PI/360);var right_1m=top_1m*cam.aspect;var dir=_vec4_tmp;var viewport_xy=m_cont.canvas_to_viewport_coords(canvas_x,canvas_y,_vec2_tmp,cam);dir[0]=(2*viewport_xy[0]/cam.width-1)*right_1m;dir[1]=-1;dir[2]=(2*viewport_xy[1]/cam.height-1)*top_1m;dir[3]=0;var wm=camobj.render.world_matrix;m_vec4.transformMat4(dir,wm,dir);
dest[0]=dir[0];dest[1]=dir[1];dest[2]=dir[2];m_vec3.normalize(dest,dest);return dest;default:m_print.error("Non-compatible camera");return dest}};exports.project_point=function(camobj,point,dest){if(!dest)var dest=new Float32Array(2);return m_cam.project_point(camobj,point,dest)}};b4w.module["config"]=function(exports,require){var m_cfg=require("__config");exports.P_LOW=m_cfg.P_LOW;exports.P_HIGH=m_cfg.P_HIGH;exports.P_ULTRA=m_cfg.P_ULTRA;exports.P_CUSTOM=m_cfg.P_CUSTOM;exports.set=m_cfg.set;exports.get=m_cfg.get;exports.reset=m_cfg.reset;exports.get_std_assets_path=m_cfg.get_std_assets_path};b4w.module["controls"]=function(exports,require){var m_ctl=require("__controls");var m_print=require("__print");exports.CT_CONTINUOUS=m_ctl.CT_CONTINUOUS;exports.CT_TRIGGER=m_ctl.CT_TRIGGER;exports.CT_SHOT=m_ctl.CT_SHOT;exports.CT_LEVEL=m_ctl.CT_LEVEL;exports.CT_CHANGE=m_ctl.CT_CHANGE;exports.KEY_BACKSPACE=8;exports.KEY_TAB=9;exports.KEY_ENTER=13;exports.KEY_SHIFT=16;exports.KEY_CTRL=17;exports.KEY_ALT=18;exports.KEY_PAUSE=19;exports.KEY_CAPSLOCK=20;exports.KEY_ESC=27;exports.KEY_SPACE=32;exports.KEY_LEFT=
37;exports.KEY_UP=38;exports.KEY_RIGHT=39;exports.KEY_DOWN=40;exports.KEY_1=49;exports.KEY_2=50;exports.KEY_3=51;exports.KEY_4=52;exports.KEY_5=53;exports.KEY_6=54;exports.KEY_7=55;exports.KEY_8=56;exports.KEY_9=57;exports.KEY_A=65;exports.KEY_B=66;exports.KEY_C=67;exports.KEY_D=68;exports.KEY_E=69;exports.KEY_F=70;exports.KEY_G=71;exports.KEY_H=72;exports.KEY_I=73;exports.KEY_J=74;exports.KEY_K=75;exports.KEY_L=76;exports.KEY_M=77;exports.KEY_N=78;exports.KEY_O=79;exports.KEY_P=80;exports.KEY_Q=
81;exports.KEY_R=82;exports.KEY_S=83;exports.KEY_T=84;exports.KEY_U=85;exports.KEY_V=86;exports.KEY_W=87;exports.KEY_X=88;exports.KEY_Y=89;exports.KEY_Z=90;exports.KEY_NUM0=96;exports.KEY_NUM1=97;exports.KEY_NUM2=98;exports.KEY_NUM3=99;exports.KEY_NUM4=100;exports.KEY_NUM5=101;exports.KEY_NUM6=102;exports.KEY_NUM7=103;exports.KEY_NUM8=104;exports.KEY_NUM9=105;exports.KEY_DEC_POINT=110;exports.KEY_SEMI_COLON=186;exports.KEY_EQUAL_SIGN=187;exports.KEY_COMMA=188;exports.KEY_DASH=189;exports.KEY_PERIOD=
190;exports.KEY_FORWARD_SLASH=191;exports.KEY_GRAVE_ACCENT=192;exports.KEY_LEFT_SQ_BRACKET=219;exports.KEY_BACK_SLASH=220;exports.KEY_RIGHT_SQ_BRACKET=221;exports.KEY_SINGLE_QUOTE=222;exports.PL_SINGLE_TOUCH_MOVE=m_ctl.PL_SINGLE_TOUCH_MOVE;exports.PL_MULTITOUCH_MOVE_ZOOM=m_ctl.PL_MULTITOUCH_MOVE_ZOOM;exports.PL_MULTITOUCH_MOVE_PAN=m_ctl.PL_MULTITOUCH_MOVE_PAN;exports.create_custom_sensor=m_ctl.create_custom_sensor;exports.create_keyboard_sensor=m_ctl.create_keyboard_sensor;exports.create_collision_sensor=
function(obj_src,collision_id,calc_pos_norm){collision_id=collision_id||"ANY";calc_pos_norm=calc_pos_norm||false;return m_ctl.create_collision_sensor(obj_src,collision_id,calc_pos_norm)};exports.create_collision_impulse_sensor=m_ctl.create_collision_impulse_sensor;exports.create_ray_sensor=function(obj_src,from,to,collision_id,is_binary_value,calc_pos_norm,ign_src_rot){collision_id=collision_id||"ANY";is_binary_value=is_binary_value||false;calc_pos_norm=calc_pos_norm||false;ign_src_rot=ign_src_rot||
false;return m_ctl.create_ray_sensor(obj_src,from,to,collision_id,is_binary_value,calc_pos_norm,ign_src_rot)};exports.create_mouse_click_sensor=m_ctl.create_mouse_click_sensor;exports.create_mouse_wheel_sensor=m_ctl.create_mouse_wheel_sensor;exports.create_mouse_move_sensor=m_ctl.create_mouse_move_sensor;exports.create_touch_move_sensor=m_ctl.create_touch_move_sensor;exports.create_touch_zoom_sensor=m_ctl.create_touch_zoom_sensor;exports.create_motion_sensor=m_ctl.create_motion_sensor;exports.create_vertical_velocity_sensor=
m_ctl.create_vertical_velocity_sensor;exports.create_gyro_angles_sensor=m_ctl.create_gyro_angles_sensor;exports.create_gyro_delta_sensor=m_ctl.create_gyro_delta_sensor;exports.create_timer_sensor=function(period,do_repeat){return m_ctl.create_timer_sensor(period,do_repeat||false)};exports.reset_timer_sensor=m_ctl.reset_timer_sensor;exports.create_elapsed_sensor=m_ctl.create_elapsed_sensor;exports.create_timeline_sensor=m_ctl.create_timeline_sensor;exports.create_selection_sensor=function(obj,auto_release){return m_ctl.create_selection_sensor(obj,
auto_release||false)};exports.set_custom_sensor=function(sensor,value){m_ctl.sensor_set_value(sensor,value)};exports.get_custom_sensor=function(sensor){return sensor.value};exports.get_sensor_value=m_ctl.get_sensor_value;exports.get_sensor_payload=m_ctl.get_sensor_payload;exports.create_sensor_manifold=function(obj,id,type,sensors,logic_fun,callback,callback_param){callback_param=callback_param===undefined?null:callback_param;var logic_fun=logic_fun||m_ctl.default_AND_logic_fun;m_ctl.create_sensor_manifold(obj,
id,type,sensors,logic_fun,callback,callback_param)};exports.create_kb_sensor_manifold=function(obj,id,type,key,callback,callback_param){var kb_sensor=m_ctl.create_keyboard_sensor(key);callback_param=callback_param===undefined?null:callback_param;var logic_fun=m_ctl.default_AND_logic_fun;m_ctl.create_sensor_manifold(obj,id,type,[kb_sensor],logic_fun,callback,callback_param)};exports.check_sensor_manifolds=function(obj){return m_ctl.check_sensor_manifold(obj,null)};exports.check_sensor_manifold=m_ctl.check_sensor_manifold;
exports.remove_sensor_manifolds=function(obj){m_print.error("remove_sensor_manifolds() deprecated, use"+" remove_sensor_manifold() instead");m_ctl.remove_sensor_manifold(obj,null)};exports.remove_sensor_manifold=m_ctl.remove_sensor_manifold;exports.reset=m_ctl.reset;exports.register_keyboard_events=m_ctl.register_keyboard_events;exports.register_mouse_events=function(element,prevent_default,allow_element_exit){m_ctl.register_mouse_events(element,prevent_default,!!allow_element_exit)};exports.register_wheel_events=
m_ctl.register_wheel_events;exports.register_touch_events=m_ctl.register_touch_events;exports.register_device_orientation=m_ctl.register_device_orientation;exports.unregister_keyboard_events=m_ctl.unregister_keyboard_events;exports.unregister_mouse_events=m_ctl.unregister_mouse_events;exports.unregister_wheel_events=m_ctl.unregister_wheel_events;exports.unregister_touch_events=m_ctl.unregister_touch_events;exports.unregister_device_orientation=m_ctl.unregister_device_orientation};b4w.module["constraints"]=function(exports,require){var m_cam=require("__camera");var m_cons=require("__constraints");var m_obj_util=require("__obj_util");var m_phy=require("__physics");var m_print=require("__print");var m_trans=require("__transform");exports.append_stiff=function(obj,target,offset,rotation_offset,scale_offset){scale_offset=scale_offset||1;if(target instanceof Array&&target.length==2)m_cons.append_stiff_bone(obj,target[0],target[1],offset,rotation_offset,scale_offset);else m_cons.append_stiff_obj(obj,
target,offset,rotation_offset,scale_offset);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports.append_semi_stiff=function(obj,target,offset,rotation_offset){m_cons.append_semi_stiff_obj(obj,target,offset,rotation_offset);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports.append_semi_stiff_cam=function(obj,target,offset,rotation_offset,clamp_left,clamp_right,clamp_up,clamp_down){if(!m_cam.is_eye_camera(obj)){m_print.error("append_semi_stiff_cam(): wrong object type, only EYE"+
" camera objects can be parented.");return}m_cons.append_semi_stiff_cam_obj(obj,target,offset,rotation_offset,clamp_left,clamp_right,clamp_up,clamp_down);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports.append_semi_soft_cam=function(obj,target,offset,softness){if(!m_cam.is_eye_camera(obj)){m_print.error("append_semi_soft_cam(): wrong object type, only EYE"+" camera objects can be parented.");return}if(!softness||softness<0)softness=.25;m_cons.append_semi_soft_cam_obj(obj,target,offset,
softness);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports.append_stiff_trans=function(obj,target,offset){m_cons.append_stiff_trans_obj(obj,target,offset);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports.append_copy_trans=function(obj,target,offset){m_cons.append_copy_trans_obj(obj,target,offset);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports.append_stiff_trans_rot=function(obj,target,offset,rotation_offset){m_cons.append_stiff_trans_rot_obj(obj,target,
offset,rotation_offset,1);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports.append_track=function(obj,target){if(target.length==3)m_cons.append_track_point(obj,target);else m_cons.append_track_obj(obj,target);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports.append_follow=function(obj,target,dist_min,dist_max){if(target.length==3)m_cons.append_follow_point(obj,target,dist_min,dist_max);else m_cons.append_follow_obj(obj,target,dist_min,dist_max);m_trans.update_transform(obj);
m_phy.sync_transform(obj)};exports.append_stiff_viewport=function(obj,camobj,positioning){m_cons.append_stiff_viewport(obj,camobj,positioning);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports.remove=function(obj){if(obj.constraint)m_cons.remove(obj)};exports.get_parent=function(obj){m_print.error("constraints.get_parent() deprecated, use objects.get_parent() instead");return m_obj_util.get_parent(obj)}};b4w.module["container"]=function(exports,require){var m_cont=require("__container");var m_print=require("__print");exports.get_canvas=m_cont.get_canvas;exports.get_container=m_cont.get_container;exports.insert_to_container=function(elem,stack_order){if(arguments.length!=2){m_print.error("insert_to_container(): two arguments required");return}if(!elem||!stack_order)return;m_cont.insert_to_container(elem,stack_order)};exports.set_canvas_offsets=m_cont.set_canvas_offsets;exports.update_canvas_offsets=
m_cont.update_canvas_offsets;exports.client_to_canvas_coords=m_cont.client_to_canvas_coords;exports.force_offsets_updating=m_cont.force_offsets_updating};b4w.module["data"]=function(exports,require){var m_data=require("__data");var m_print=require("__print");var m_util=require("__util");exports.load=m_data.load;exports.unload=function(data_id){data_id=data_id|0;m_data.unload(data_id)};exports.set_debug_resources_root=m_data.set_debug_resources_root;exports.is_primary_loaded=m_data.is_primary_loaded;exports.load_and_add_new=m_data.load;exports.cleanup=exports.unload};b4w.module["debug"]=function(exports,require){var m_batch=require("__batch");var m_cfg=require("__config");var m_ctl=require("__controls");var m_debug=require("__debug");var m_ext=require("__extensions");var m_obj=require("__objects");var m_obj_util=require("__obj_util");var m_phy=require("__physics");var m_print=require("__print");var m_scenes=require("__scenes");var m_scgraph=require("__scenegraph");var m_sfx=require("__sfx");var m_shaders=require("__shaders");var m_textures=require("__textures");
var m_util=require("__util");var m_vec3=require("vec3");var cfg_def=m_cfg.defaults;exports.WM_NONE=m_debug.WM_NONE;exports.WM_OPAQUE_WIREFRAME=m_debug.WM_OPAQUE_WIREFRAME;exports.WM_TRANSPARENT_WIREFRAME=m_debug.WM_TRANSPARENT_WIREFRAME;exports.WM_FRONT_BACK_VIEW=m_debug.WM_FRONT_BACK_VIEW;exports.WM_DEBUG_SPHERES=m_debug.WM_DEBUG_SPHERES;exports.physics_stats=function(){m_phy.debug_workers()};exports.physics_id=function(id){m_print.log("O",m_phy.find_obj_by_body_id(id));var bundles=m_phy.get_active_scene()._physics.bundles;
for(var i=0;i<bundles.length;i++){var bundle=bundles[i];var phy=bundle.physics;if(phy.body_id==id)m_print.log("B",bundle)}};exports.visible_objects=function(){var scene=m_scenes.get_active();var objs=m_obj.get_scene_objs(scene,"MESH",m_obj.DATA_ID_ALL);var main_subscenes=[m_scenes.get_subs(scene,"MAIN_OPAQUE"),m_scenes.get_subs(scene,"MAIN_BLEND")];for(var i=0;i<main_subscenes.length;i++){var subs_main=main_subscenes[i];var bundles=subs_main.bundles;if(!bundles.length)continue;m_print.group(subs_main.type,
"DYNAMIC");for(var j=0;j<objs.length;j++){var obj=objs[j];var render=obj.render;if(render.type!="DYNAMIC")continue;for(var k=0;k<bundles.length;k++){var bundle=bundles[k];if(bundle.do_render&&bundle.obj_render==render){m_print.log_raw(obj.name,obj);break}}}m_print.groupEnd();m_print.groupCollapsed(subs_main.type,"STATIC");for(var j=0;j<objs.length;j++){var obj=objs[j];var render=obj.render;if(render.type=="DYNAMIC")continue;for(var k=0;k<bundles.length;k++){var bundle=bundles[k];if(bundle.do_render&&
bundle.obj_render==render){m_print.log_raw(obj.name,obj);break}}}m_print.groupEnd()}};exports.object_info=function(name){var scene=m_scenes.get_active();var objs=m_obj.get_scene_objs(scene,"MESH",m_obj.DATA_ID_ALL);for(var i=0;i<objs.length;i++){var obj=objs[i];if(obj.name!=name)continue;m_print.log("Object",obj);var subscenes=m_scenes.get_all_subscenes(scene);for(var j=0;j<subscenes.length;j++){var subs=subscenes[j];var bundles=subs.bundles;var print_bundles=[];for(var k=0;k<bundles.length;k++)if(bundles[k].obj_render==
obj.render)print_bundles.push(bundles[k]);m_print.log("Subscene "+subs.type,print_bundles)}}};exports.objects_stat=function(){var scene=m_scenes.get_active();console.log("Armatures: "+m_obj.get_scene_objs(scene,"ARMATURE",m_obj.DATA_ID_ALL).length);console.log("Cameras: "+m_obj.get_scene_objs(scene,"CAMERA",m_obj.DATA_ID_ALL).length);console.log("Curves: "+m_obj.get_scene_objs(scene,"CURVE",m_obj.DATA_ID_ALL).length);console.log("Empties: "+m_obj.get_scene_objs(scene,"EMPTY",m_obj.DATA_ID_ALL).length);
console.log("Lamps: "+m_obj.get_scene_objs(scene,"LAMP",m_obj.DATA_ID_ALL).length);console.log("Meshes: "+m_obj.get_scene_objs(scene,"MESH",m_obj.DATA_ID_ALL).length);console.log("Speakers: "+m_obj.get_scene_objs(scene,"SPEAKER",m_obj.DATA_ID_ALL).length)};exports.num_vertices=function(){var num=0;var scene=m_scenes.get_active();var main_subscenes=[m_scenes.get_subs(scene,"MAIN_OPAQUE"),m_scenes.get_subs(scene,"MAIN_BLEND")];for(var i=0;i<main_subscenes.length;i++){var subs=main_subscenes[i];if(!subs)continue;
var bundles=subs.bundles;for(var j=0;j<bundles.length;j++){var batch=bundles[j].batch;if(batch)num+=batch.num_vertices}}return num};exports.num_triangles=function(){var num=0;var scene=m_scenes.get_active();var main_subscenes=[m_scenes.get_subs(scene,"MAIN_OPAQUE"),m_scenes.get_subs(scene,"MAIN_BLEND")];for(var i=0;i<main_subscenes.length;i++){var subs=main_subscenes[i];if(!subs)continue;var bundles=subs.bundles;for(var j=0;j<bundles.length;j++){var batch=bundles[j].batch;if(batch)num+=batch.num_triangles}}return num};
exports.num_draw_calls=function(){var scene=m_scenes.get_active();var main_subscenes=[m_scenes.get_subs(scene,"MAIN_OPAQUE"),m_scenes.get_subs(scene,"MAIN_BLEND")];var number=main_subscenes[0].bundles.length+main_subscenes[1].bundles.length;var reflect_subs=m_scenes.subs_array(scene,["MAIN_PLANE_REFLECT","MAIN_CUBE_REFLECT"]);for(var i=0;i<reflect_subs.length;i++){var subs=reflect_subs[i];if(subs.type=="MAIN_PLANE_REFLECT")number+=subs.bundles.length;else number+=6*subs.bundles.length}return number};
exports.num_shaders=function(){var compiled_shaders=m_shaders.get_compiled_shaders();return m_util.get_dict_length(compiled_shaders)};exports.geometry_stats=function(){var scene=m_scenes.get_active();var subscenes=m_scenes.get_all_subscenes(scene);var unique_batches={};for(var i=0;i<subscenes.length;i++){var subs=subscenes[i];if(subs.type=="SINK"||subs.type=="WIREFRAME")continue;var bundles=subs.bundles;for(var j=0;j<bundles.length;j++){var batch=bundles[j].batch;var render=bundles[j].obj_render;
if(batch)if(subs.type!="COLOR_PICKING"&&subs.type!="OUTLINE_MASK"||render.origin_selectable||render.origin_outlining)unique_batches[batch.id]=batch}}var vbo_number=0;var vbo_memory=0;var ibo_number=0;var ibo_memory=0;for(var id in unique_batches){var batch=unique_batches[id];var bufs_data=batch.bufs_data;if(bufs_data.debug_ibo_bytes){ibo_number++;ibo_memory+=bufs_data.debug_ibo_bytes/(1024*1024)}vbo_number++;vbo_memory+=bufs_data.debug_vbo_bytes/(1024*1024)}return{"vbo_number":vbo_number,"vbo_memory":vbo_memory,
"ibo_number":ibo_number,"ibo_memory":ibo_memory}};exports.num_textures=function(){var tex_list=[];var memory=0;var scene=m_scenes.get_active();var main_subscenes=[m_scenes.get_subs(scene,"MAIN_OPAQUE"),m_scenes.get_subs(scene,"MAIN_BLEND")];for(var i=0;i<main_subscenes.length;i++){var subs=main_subscenes[i];if(!subs)continue;var bundles=subs.bundles;for(var j=0;j<bundles.length;j++){var batch=bundles[j].batch;if(batch){var batch_texs=batch.textures;for(var k=0;k<batch_texs.length;k++){var batch_tex=
batch_texs[k];if(batch_tex.source==="IMAGE"||batch_tex.source==="ENVIRONMENT_MAP"){var tex=batch_tex.w_texture;if(tex_list.indexOf(tex)===-1){tex_list.push(tex);var mem=batch_tex.width*batch_tex.height*4/(1024*1024)/batch_tex.compress_ratio;mem*=1.3333;memory+=mem}}}}}}return{"number":tex_list.length,"memory":memory}};exports.num_render_targets=function(){var list=[];var memory=0;var scene=m_scenes.get_active();var subscenes=m_scenes.get_all_subscenes(scene);for(var i=0;i<subscenes.length;i++){var subs=
subscenes[i];if(subs.type=="SINK")continue;var cam=subs.camera;var c_at=cam.color_attachment;var d_at=cam.depth_attachment;var subs_textures=[cam.color_attachment,cam.depth_attachment];subs_textures.push.apply(subs_textures,subs.textures_internal);for(var j=0;j<subs_textures.length;j++){var tex=subs_textures[j];if(m_textures.is_texture(tex)&&list.indexOf(tex)==-1){list.push(tex);memory+=cam.width*cam.height*m_textures.get_texture_channel_size(tex)}}}return{"number":list.length,"memory":memory/1024/
1024}};exports.make_camera_frustum_shot=function(){var active_scene=m_scenes.get_active();var subs_main=m_scenes.get_subs(active_scene,"MAIN_OPAQUE");if(!subs_main)return;m_scenes.make_frustum_shot(subs_main.camera,subs_main,[1,1,0])};exports.make_light_frustum_shot=function(){var active_scene=m_scenes.get_active();var subs_main=m_scenes.get_subs(active_scene,"MAIN_OPAQUE");var subscenes_shadow=m_scenes.subs_array(active_scene,["SHADOW_CAST"]);if(!subs_main)return;for(var i=0;i<subscenes_shadow.length;i++){var subs_shadow=
subscenes_shadow[i];var color;switch(i){case 0:color=[1,0,0];break;case 1:color=[0,1,0];break;case 2:color=[0,0,1];break;default:color=[1,0,1]}m_scenes.make_frustum_shot(subs_shadow.camera,subs_main,color)}};exports.scenegraph_to_dot=function(){var scenes=m_scenes.get_all_scenes();for(var i=0;i<scenes.length;i++){var scene=scenes[i];var graph=m_scenes.get_graph(scene);m_print.log("\n"+m_scgraph.debug_convert_to_dot(graph))}};exports.scenes_to_dot=function(){};exports.controls_info=m_ctl.debug;exports.object_distance=
function(obj,obj2){var dist=m_vec3.dist(obj.render.trans,obj2.render.trans);return dist};exports.msg=m_debug.msg;exports.fbmsg=m_debug.fbmsg;exports.print_telemetry=m_debug.print_telemetry;exports.plot_telemetry=m_debug.plot_telemetry;exports.fbres=function(fun,timeout){if(!timeout)timeout=16;var cb=function(){m_debug.fbmsg("FBRES",fun());setTimeout(cb,timeout)};cb()};exports.assert_constants=function(){var VEC3_IDENT=new Float32Array(3);var QUAT4_IDENT=new Float32Array([0,0,0,1]);var AXIS_X=new Float32Array([1,
0,0]);var AXIS_Y=new Float32Array([0,1,0]);var AXIS_Z=new Float32Array([0,0,1]);var AXIS_MX=new Float32Array([-1,0,0]);var AXIS_MY=new Float32Array([0,-1,0]);var AXIS_MZ=new Float32Array([0,0,-1]);if(!m_util.cmp_arr(VEC3_IDENT,m_util.VEC3_IDENT))throw"Wrong VEC3_IDENT";if(!m_util.cmp_arr(QUAT4_IDENT,m_util.QUAT4_IDENT))throw"Wrong QUAT4_IDENT";if(!m_util.cmp_arr(AXIS_X,m_util.AXIS_X))throw"Wrong AXIS_X";if(!m_util.cmp_arr(AXIS_Y,m_util.AXIS_Y))throw"Wrong AXIS_Y";if(!m_util.cmp_arr(AXIS_Z,m_util.AXIS_Z))throw"Wrong AXIS_Z";
if(!m_util.cmp_arr(AXIS_MX,m_util.AXIS_MX))throw"Wrong AXIS_MX";if(!m_util.cmp_arr(AXIS_MY,m_util.AXIS_MY))throw"Wrong AXIS_MY";if(!m_util.cmp_arr(AXIS_MZ,m_util.AXIS_MZ))throw"Wrong AXIS_MZ";};exports.mute_music=function(){var spks=m_sfx.get_speaker_objects();for(var i=0;i<spks.length;i++){var spk=spks[i];if(m_sfx.get_spk_behavior(spk)=="BACKGROUND_MUSIC")m_sfx.mute(spk,true)}};exports.check_finite=function(o){m_debug.check_finite(o)};exports.set_debug_params=function(params){var active_scene=m_scenes.get_active();
var subs_wireframe=m_scenes.get_subs(active_scene,"WIREFRAME");if(subs_wireframe){if(typeof params.wireframe_mode=="number")switch(params.wireframe_mode){case m_debug.WM_NONE:case m_debug.WM_OPAQUE_WIREFRAME:case m_debug.WM_TRANSPARENT_WIREFRAME:case m_debug.WM_FRONT_BACK_VIEW:case m_debug.WM_DEBUG_SPHERES:m_scenes.set_wireframe_mode(subs_wireframe,params.wireframe_mode);break;default:m_print.error("set_debug_params(): Wrong wireframe mode");break}if(typeof params.wireframe_edge_color=="object")m_scenes.set_wireframe_edge_color(subs_wireframe,
params.wireframe_edge_color)}else throw"Wireframe subscene not found.";};exports.get_error_quantity=function(){return m_print.get_error_count()};exports.get_warning_quantity=function(){return m_print.get_warning_count()};exports.clear_errors_warnings=function(){return m_print.clear_errors_warnings()};exports.analyze_shaders=function(opt_shader_id_part){var compiled_shaders=m_shaders.get_compiled_shaders();var count=0;for(var shader_id in compiled_shaders){if(opt_shader_id_part&&shader_id.indexOf(opt_shader_id_part)===
-1)continue;count++}var msg="of "+count+" analyzing...";var rslts={};for(var shader_id in compiled_shaders){if(opt_shader_id_part&&shader_id.indexOf(opt_shader_id_part)===-1)continue;var cshader=compiled_shaders[shader_id];var stat=get_shaders_stat(cshader.vshader,cshader.fshader);var shaders_info=cshader.shaders_info;var title=shaders_info.vert+" + "+shaders_info.frag;stat.cshader=cshader;stat.shaders_info=shaders_info;var stats=rslts[title]=rslts[title]||[];stats.push(stat);m_print.log(msg)}for(var title in rslts){m_print.group("%c"+
title,"color: #800");var stats=rslts[title];print_shader_stats_nvidia(stats);m_print.groupEnd()}};exports.fake_load=m_debug.fake_load;function get_shaders_stat(vshader,fshader){var ext_ds=m_ext.get_debug_shaders();if(!ext_ds){m_print.error("WEBGL_debug_shaders not found"+" (run Chrome with --enable-privileged-webgl-extensions)");return}var vsrc=ext_ds.getTranslatedShaderSource(vshader);var fsrc=ext_ds.getTranslatedShaderSource(fshader);var vout=post_sync("/nvidia_vert",vsrc);var vstats=parse_shader_assembly(vout);
var fout=post_sync("/nvidia_frag",fsrc);var fstats=parse_shader_assembly(fout);return{vsrc:vsrc,vout:vout,vstats:vstats,fsrc:fsrc,fout:fout,fstats:fstats}}function parse_shader_assembly(data){var stats={};if(!data)return stats;var lines=data.split("\n");for(var i=0;i<lines.length;i++){var line=lines[i];if(line.search(new RegExp(/^[A-Z.]+ /))==-1)continue;var op=line.split(" ")[0];if(!(op in stats))stats[op]=0;stats[op]++}var alu_ops=0;var tex_ops=0;for(var op in stats)switch(op){case "KIL":case "TEX":case "TXB":case "TXP":case "KIL.F":case "TEX.F":case "TXB.F":case "TXD.F":case "TXL.F":case "TXQ.F":case "TXP.F":tex_ops+=
stats[op];break;default:alu_ops+=stats[op];break}stats["ALU_OPS"]=alu_ops;stats["TEX_OPS"]=tex_ops;return stats}function post_sync(path,data){var req=new XMLHttpRequest;req.open("POST",path,false);req.send(data);if(req.status==200)return req.responseText;else throw"Error POST XHR: "+req.status;}function print_shader_stats_nvidia(stats){stats.sort(function(a,b){return b.fstats["ALU_OPS"]-a.fstats["ALU_OPS"]});for(var j=0;j<stats.length;j++){var stat=stats[j];var fstats=stat.fstats;var vstats=stat.vstats;
var mat_names=find_material_names_by_comp_shader(stat.cshader);mat_names=mat_names?"\t\t("+mat_names.join(", ")+")":"\t\t(NA)";m_print.groupCollapsed("FRAG --\x3e","ALU",fstats["ALU_OPS"],"TEX",fstats["TEX_OPS"],"\t\tVERT --\x3e","ALU",vstats["ALU_OPS"],"TEX",vstats["TEX_OPS"],mat_names);m_print.groupCollapsed("directives");var dirs=stat.shaders_info.directives;for(var i=0;i<dirs.length;i++){var dir=dirs[i];m_print.log(dir[0],dir[1])}m_print.groupEnd();m_print.groupCollapsed("vert src");m_print.log(stat.vsrc);
m_print.groupEnd();m_print.groupCollapsed("vert stats");for(var op in vstats)if(op!="ALU_OPS"&&op!="TEX_OPS")m_print.log(op,vstats[op]);m_print.groupEnd();m_print.groupCollapsed("frag src");m_print.log(stat.fsrc);m_print.groupEnd();m_print.groupCollapsed("frag stats");for(var op in fstats)if(op!="ALU_OPS"&&op!="TEX_OPS")m_print.log(op,fstats[op]);m_print.groupEnd();m_print.groupEnd()}}function find_material_names_by_comp_shader(cshader){var scenes=m_scenes.get_all_scenes();for(var i=0;i<scenes.length;i++){var scene=
scenes[i];var objects=m_obj.get_scene_objs(scene,"MESH",m_obj.DATA_ID_ALL);for(var j=0;j<objects.length;j++){var obj=objects[j];var scene_data=m_obj_util.get_scene_data(obj,scene);if(!scene_data||!scene_data.batches.length)continue;var batches=scene_data.batches;for(var k=0;k<batches.length;k++){var batch=batches[k];if(batch.shader==cshader&&batch.material_names.length)return batch.material_names}}}return null}};b4w.module["geometry"]=function(exports,require){var m_batch=require("__batch");var m_geom=require("__geometry");var m_print=require("__print");var m_render=require("__renderer");exports.extract_vertex_array=function(obj,mat_name,attrib_name){if(!m_geom.has_dyn_geom(obj)){m_print.error("Wrong object:",obj.name);return null}var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch){var bufs_data=batch.bufs_data;if(bufs_data&&bufs_data.pointers&&bufs_data.pointers[attrib_name])return m_geom.extract_array(bufs_data,
attrib_name);else{m_print.error("Attribute not found:"+attrib_name);return null}}else{m_print.error("Wrong material:",mat_name);return null}};exports.extract_index_array=function(obj,mat_name){if(!m_geom.has_dyn_geom(obj)){m_print.error("Wrong object:",obj.name);return null}var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch){var bufs_data=batch.bufs_data;if(bufs_data&&bufs_data.pointers)return bufs_data.ibo_array;else{m_print.error("Buffer data not found");return null}}else{m_print.error("Wrong material:",
mat_name);return null}};exports.update_vertex_array=function(obj,mat_name,attrib_name,array){var types=["MAIN","DEPTH","COLOR_ID"];if(!m_geom.has_dyn_geom(obj)){m_print.error("Wrong object:",obj.name);return}for(var i=0;i<types.length;i++){var type=types[i];var batch=m_batch.find_batch_material(obj,mat_name,type);if(batch){var bufs_data=batch.bufs_data;if(bufs_data&&bufs_data.pointers&&bufs_data.pointers[attrib_name])m_geom.update_bufs_data_array(bufs_data,attrib_name,0,array)}}};exports.override_geometry=
function(obj,mat_name,ibo_array,positions_array,smooth_normals){var types=["MAIN","DEPTH","COLOR_ID"];if(!m_geom.has_dyn_geom(obj)){m_print.error("Wrong object:",obj.name);return}if(!(ibo_array instanceof Uint16Array)&&!(ibo_array instanceof Uint32Array)){m_print.error("Wrong ibo_array type");return}if(!(positions_array instanceof Float32Array)){m_print.error("Wrong positions_array type");return}for(var i=0;i<types.length;i++){var type=types[i];var batch=m_batch.find_batch_material(obj,mat_name,type);
if(batch){var bufs_data=batch.bufs_data;if(bufs_data){m_geom.update_bufs_data_index_array(bufs_data,batch.draw_mode,ibo_array);var new_vbo_size=0;for(var attr in bufs_data.pointers){var pointer=bufs_data.pointers[attr];new_vbo_size+=positions_array.length/3*pointer.num_comp}bufs_data.vbo_array=new Float32Array(new_vbo_size);var vbo_array=bufs_data.vbo_array;var offset=0;for(var attr in bufs_data.pointers){var pointer=bufs_data.pointers[attr];switch(attr){case "a_position":vbo_array.set(positions_array,
offset);pointer.offset=offset;pointer.length=positions_array.length;offset+=pointer.length;break;case "a_normal":var shared_indices;if(smooth_normals)shared_indices=m_geom.calc_shared_indices(ibo_array,positions_array,positions_array);var normals=m_geom.calc_normals(ibo_array,positions_array,shared_indices);vbo_array.set(normals,offset);pointer.offset=offset;pointer.length=positions_array.length;offset+=pointer.length;break;case "a_tangent":pointer.offset=offset;pointer.length=positions_array.length/
3*pointer.num_comp;var new_tangent_array=new Float32Array(pointer.length);for(var j=0;j<new_tangent_array.length;j+=4){new_tangent_array[j]=1;new_tangent_array[j+3]=1}vbo_array.set(new_tangent_array,offset);offset+=pointer.length;break;default:pointer.offset=offset;pointer.length=positions_array.length/3*pointer.num_comp;var new_array=new Float32Array(pointer.length);vbo_array.set(new_array,offset);offset+=pointer.length;break}}m_geom.update_gl_buffers(bufs_data);m_render.assign_attribute_setters(batch);
var child_batch=m_batch.find_batch_material_forked(obj,batch);if(child_batch&&child_batch.bufs_data)child_batch.bufs_data=bufs_data}}}};exports.set_shape_key_value=function(obj,key_name,value){if(!m_geom.check_shape_keys(obj)){m_print.error("Wrong object:",obj.name);return}if(!m_geom.has_shape_key(obj,key_name)){m_print.error("Wrong key name:",key_name);return}var float_value=parseFloat(value);m_geom.apply_shape_key(obj,key_name,float_value)};exports.check_shape_keys=function(obj){return m_geom.check_shape_keys(obj)};
exports.get_shape_keys_names=function(obj){if(!m_geom.check_shape_keys(obj)){m_print.error("Wrong object:",obj.name);return null}return m_geom.get_shape_keys_names(obj)};exports.get_shape_key_value=function(obj,key_name){if(!m_geom.check_shape_keys(obj)){m_print.error("Wrong object:",obj.name);return null}if(!m_geom.has_shape_key(obj,key_name)){m_print.error("Wrong key name:",key_name);return null}return m_geom.get_shape_key_value(obj,key_name)}};b4w.module["hud"]=function(exports,require){var m_hud=require("__hud");var m_print=require("__print");exports.draw_mixer_strip=m_hud.draw_mixer_strip;exports.plot_array=m_hud.plot_array};b4w.module["lights"]=function(exports,require){var m_lights=require("__lights");var m_obj=require("__objects");var m_obj_util=require("__obj_util");var m_print=require("__print");var m_scenes=require("__scenes");var m_trans=require("__transform");var m_util=require("__util");var m_vec3=require("__vec3");var _sun_pos=new Float32Array(3);var _date={};var _julian_date=0;var _max_sun_angle=60;exports.get_lamps=function(lamps_type){var scene=m_scenes.get_active();var lamps=m_obj.get_scene_objs(scene,"LAMP",
m_obj.DATA_ID_ALL);if(!lamps_type)return lamps;var rslt=[];for(var i=0;i<lamps.length;i++){var lamp=lamps[i];if(lamp.light.type===lamps_type)rslt.push(lamp)}return rslt};exports.get_sun_params=get_sun_params;function get_sun_params(){var scene=m_scenes.get_active();var lamps=m_obj.get_scene_objs(scene,"LAMP",m_obj.DATA_ID_ALL);var sun=null;for(var i=0;i<lamps.length;i++){var lamp=lamps[i];var light=lamp.light;if(light.type=="SUN"){sun=lamp;break}}if(sun){var cur_dir=sun.light.direction;var angle_hor=
Math.atan2(cur_dir[2],cur_dir[0])*180/Math.PI+90;if(angle_hor>180)angle_hor-=360;var angle_vert=Math.atan2(cur_dir[1],Math.sqrt(cur_dir[0]*cur_dir[0]+cur_dir[2]*cur_dir[2]))*180/Math.PI;var sun_params={};sun_params.hor_position=angle_hor;sun_params.vert_position=angle_vert;return sun_params}else return null}exports.set_sun_params=set_sun_params;function set_sun_params(sun_params){var scene=m_scenes.get_active();var lamps=m_obj.get_scene_objs(scene,"LAMP",m_obj.DATA_ID_ALL);for(var i=0;i<lamps.length;i++){var lamp=
lamps[i];var light=lamp.light;if(light.type=="SUN"){var sun=lamp;break}}if(!sun){m_print.error("There is no sun on the scene");return}if(typeof sun_params.hor_position=="number"&&typeof sun_params.vert_position=="number"){var angle_hor=(180-sun_params.hor_position)/180*Math.PI;var angle_vert=(90-sun_params.vert_position)/180*Math.PI;var sun_render=sun.render;m_trans.set_rotation_euler(sun,[angle_vert,angle_hor,0]);var dir=new Float32Array(3);m_util.quat_to_dir(sun_render.quat,m_util.AXIS_Y,dir);var dist_to_center=
m_vec3.length(sun_render.trans);m_vec3.copy(dir,_sun_pos);m_vec3.scale(_sun_pos,dist_to_center,_sun_pos);m_trans.set_translation(sun,_sun_pos);m_trans.update_transform(sun);var sun_light=sun.light;if(sun_light.dynamic_intensity){var def_env_color=scene["world"]["light_settings"]["environment_energy"];var energy=Math.cos(Math.abs(angle_vert));var sun_energy=Math.max(Math.min(3*energy,1),0)*sun_light.default_energy;var env_energy=Math.max(energy,.1)*def_env_color;m_lights.set_light_energy(sun_light,
sun_energy);m_scenes.set_environment_colors(scene,env_energy,null,null)}m_scenes.update_lamp_scene(sun,scene)}}exports.set_day_time=set_day_time;function set_day_time(time){var scene=m_scenes.get_active();var lamps=m_obj.get_scene_objs(scene,"LAMP",m_obj.DATA_ID_ALL);for(var i=0;i<lamps.length;i++){var lamp=lamps[i];var light=lamp.light;if(light.type=="SUN"){var sun=lamp;break}}if(!sun){m_print.error("There is no sun on the scene");return}update_sun_position(time)}exports.set_date=function(date){_date.y=
date.getDate();_date.m=date.getMonth();_date.d=date.getFullYear();if(!_date.y){m_print.error("There is no year 0 in the Julian system!");return}if(_date.y==1582&&date.m==10&&date.d>4&&date.d<15){m_print.error("The dates 5 through 14 October, 1582, do not exist in the Gregorian system!");return}_julian_date=calendar_to_julian(_date)};exports.set_max_sun_angle=function(angle){_max_sun_angle=Math.min(Math.max(angle,0),90)};exports.get_light_params=function(lamp_obj){if(m_obj_util.is_lamp(lamp_obj))var light=
lamp_obj.light;else{m_print.error("get_light_params(): Wrong object");return false}var type=get_light_type(lamp_obj);if(type)switch(type){case "SPOT":var rslt={"light_type":type,"light_color":light.color,"light_energy":light.energy,"light_spot_blend":light.spot_blend,"light_spot_size":light.spot_size,"light_distance":light.distance};break;case "POINT":var rslt={"light_type":type,"light_color":light.color,"light_energy":light.energy,"light_distance":light.distance};break;default:var rslt={"light_type":type,
"light_color":light.color,"light_energy":light.energy};break}if(rslt)return rslt;else return false};exports.get_light_type=get_light_type;function get_light_type(lamp_obj){if(m_obj_util.is_lamp(lamp_obj))return lamp_obj.light.type;else m_print.error("get_light_type(): Wrong object");return false}exports.set_light_params=function(lamp_obj,light_params){if(m_obj_util.is_lamp(lamp_obj))var light=lamp_obj.light;else{m_print.error("set_light_params(): Wrong object");return}var scene=m_scenes.get_active();
if(typeof light_params.light_energy=="number"){m_lights.set_light_energy(light,light_params.light_energy);m_scenes.update_lamp_scene(lamp_obj,scene)}if(typeof light_params.light_color=="object"){m_lights.set_light_color(light,light_params.light_color);m_scenes.update_lamp_scene(lamp_obj,scene)}if(typeof light_params.light_spot_blend=="number"){m_lights.set_light_spot_blend(light,light_params.light_spot_blend);m_scenes.update_lamp_scene(lamp_obj,scene)}if(typeof light_params.light_spot_size=="number"){m_lights.set_light_spot_size(light,
light_params.light_spot_size);m_scenes.update_lamp_scene(lamp_obj,scene)}if(typeof light_params.light_distance=="number"){m_lights.set_light_distance(light,light_params.light_distance);m_scenes.update_lamp_scene(lamp_obj,scene)}m_obj.update_all_mesh_shaders(scene)};function update_sun_position(time){var day=_date.d;var month=_date.m;var year=_date.y;var angle_hor=time<12?time*15:(time-24)*15;var angle_vert=-Math.cos(time/12*Math.PI)*_max_sun_angle;var sun_params={};sun_params.hor_position=angle_hor;
sun_params.vert_position=angle_vert;set_sun_params(sun_params)}function get_sun_coordinates(jul_date,days){var n=jul_date-2451545;var l=280.46+.9856474*n;l=l%360;var g=357.528+.9856003*n;g=g%360;g*=Math.PI/180;var e_longitude=l+1.915*Math.sin(g)+.02*Math.sin(2*g);var r=1.00014-.01671*Math.cos(g)-1.4E-4*Math.cos(2*g);var oblique=23.439-4E-7*n;return oblique}function calendar_to_julian(date){var y=date.y;var m=date.m;var d=date.d;var jy,ja,jm;if(m>2){jy=y;jm=m+1}else{jy=y-1;jm=m+13}var intgr=Math.floor(Math.floor(365.25*
jy)+Math.floor(30.6001*jm)+d+1720995);var gregcal=15+31*(10+12*1582);if(d+31*(m+12*y)>=gregcal){ja=Math.floor(.01*jy);intgr+=2-ja+Math.floor(.25*ja)}var jd0=intgr*1E5;var jd=Math.floor(jd0);if(jd0-jd>.5)++jd;return jd/1E5}};b4w.module["material"]=function(exports,require){var m_batch=require("__batch");var m_cfg=require("__config");var m_obj_util=require("__obj_util");var m_print=require("__print");var m_shaders=require("__shaders");var cfg_def=m_cfg.defaults;exports.inherit_material=function(obj_from,mat_from_name,obj_to,mat_to_name){if(!m_obj_util.is_dynamic_mesh(obj_to)||!m_obj_util.is_dynamic_mesh(obj_from)){m_print.error("Wrong or batched object(s)");return}m_batch.inherit_material(obj_from,mat_from_name,obj_to,
mat_to_name)};function check_batch_material(obj,mat_name){var scenes_data=obj.scenes_data;var batches=scenes_data[0].batches;for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.material_names.indexOf(mat_name)>-1)return batch.type=="MAIN"}return false}exports.get_materials_names=function(obj){var mat_names=new Array;var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var batches=scenes_data[i].batches;for(var j=0;j<batches.length;j++)for(var k=0;k<batches[j].material_names.length;k++)if(mat_names.indexOf(batches[j].material_names[k])==
-1)mat_names.push(batches[j].material_names[k])}return mat_names};exports.set_diffuse_color=function(obj,mat_name,color){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch){batch.diffuse_color.set(color);var reflect_batch=m_batch.find_batch_material_forked(obj,mat_name,"MAIN");if(reflect_batch)reflect_batch.diffuse_color.set(color)}else m_print.error('Couldn\'t set property "diffuse_color"!')};exports.get_diffuse_color=function(obj,mat_name){var batch=m_batch.find_batch_material(obj,
mat_name,"MAIN");if(batch){var color=new Float32Array(4);color.set(batch.diffuse_color);return color}else m_print.error('Couldn\'t get property "diffuse_color"!')};exports.set_diffuse_intensity=function(obj,mat_name,intensity){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch){batch.diffuse_intensity=intensity;var reflect_batch=m_batch.find_batch_material_forked(obj,mat_name,"MAIN");if(reflect_batch)reflect_batch.diffuse_intensity=intensity}else m_print.error('Couldn\'t set property "diffuse_color"!')};
exports.get_diffuse_intensity=function(obj,mat_name){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch)return batch.diffuse_intensity;else m_print.error('Couldn\'t get property "diffuse_intensity"!')};exports.set_specular_color=function(obj,mat_name,color){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch){batch.specular_color.set(color);var reflect_batch=m_batch.find_batch_material_forked(obj,mat_name,"MAIN");if(reflect_batch)reflect_batch.specular_color.set(color)}else m_print.error('Couldn\'t set property "specular_color"!')};
exports.get_specular_color=function(obj,mat_name){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch){var color=new Array(3);color[0]=batch.specular_color[0];color[1]=batch.specular_color[1];color[2]=batch.specular_color[2];return color}else m_print.error('Couldn\'t get property "specular_color"!')};exports.set_specular_color_factor=function(obj,mat_name,factor){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch){batch.specular_color_factor=factor;var reflect_batch=
m_batch.find_batch_material_forked(obj,mat_name,"MAIN");if(reflect_batch)reflect_batch.specular_color_factor=factor}else m_print.error('Couldn\'t set property "specular_color_factor"!')};exports.get_specular_color_factor=function(obj,mat_name){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch)return batch.specular_color_factor;else m_print.error('Couldn\'t get property "specular_color_factor"!')};exports.set_specular_intensity=function(obj,mat_name,intensity){if(!check_specular_intensity(obj,
mat_name))m_print.error('Property "specular_intensity" is missing!');var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");batch.specular_params[0]=intensity;var reflect_batch=m_batch.find_batch_material_forked(obj,mat_name,"MAIN");if(reflect_batch)reflect_batch.specular_params[0]=intensity};exports.get_specular_intensity=function(obj,mat_name){if(!check_specular_intensity(obj,mat_name))m_print.error('Property "specular_intensity" is missing!');var batch=m_batch.find_batch_material(obj,mat_name,
"MAIN");return batch.specular_params[0]};exports.check_specular_intensity=check_specular_intensity;function check_specular_intensity(obj,mat_name){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");return Boolean(batch&&batch.specular_params[0])}exports.set_specular_hardness=function(obj,mat_name,hardness){if(!check_specular_hardness(obj,mat_name))m_print.error('Property "specular_hardness" is missing!');var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");batch.specular_params[1]=hardness;
var reflect_batch=m_batch.find_batch_material_forked(obj,mat_name,"MAIN");if(reflect_batch)reflect_batch.specular_params[1]=hardness};exports.get_specular_hardness=function(obj,mat_name){if(!check_specular_hardness(obj,mat_name))m_print.error('Property "specular_hardness" is missing!');var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");return batch.specular_params[1]};exports.check_specular_hardness=check_specular_hardness;function check_specular_hardness(obj,mat_name){var batch=m_batch.find_batch_material(obj,
mat_name,"MAIN");return Boolean(batch&&batch.specular_params[1])}exports.set_emit_factor=function(obj,mat_name,emit_factor){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch){batch.emit=emit_factor;var reflect_batch=m_batch.find_batch_material_forked(obj,mat_name,"MAIN");if(reflect_batch)reflect_batch.emit=emit_factor}else m_print.error('Couldn\'t set property "emit_factor"!')};exports.get_emit_factor=function(obj,mat_name){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");
if(batch)return batch.emit;else m_print.error('Couldn\'t get property "emit_factor"!')};exports.set_ambient_factor=function(obj,mat_name,ambient_factor){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch){batch.ambient=ambient_factor;var reflect_batch=m_batch.find_batch_material_forked(obj,mat_name,"MAIN");if(reflect_batch)reflect_batch.ambient=ambient_factor}else m_print.error('Couldn\'t set property "ambient_factor"!')};exports.get_ambient_factor=function(obj,mat_name){var batch=
m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch)return batch.ambient;else m_print.error('Couldn\'t get property "ambient_factor"!')};exports.set_diffuse_color_factor=function(obj,mat_name,diffuse_color_factor){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch){batch.diffuse_color_factor=diffuse_color_factor;var reflect_batch=m_batch.find_batch_material_forked(obj,mat_name,"MAIN");if(reflect_batch)reflect_batch.diffuse_color_factor=diffuse_color_factor}else m_print.error('Couldn\'t set property "diffuse_color_factor"!')};
exports.get_diffuse_color_factor=function(obj,mat_name){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch)return batch.diffuse_color_factor;else m_print.error('Couldn\'t get property "diffuse_color_factor"!')};exports.set_alpha_factor=function(obj,mat_name,alpha_factor){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch){batch.alpha_factor=alpha_factor;var reflect_batch=m_batch.find_batch_material_forked(obj,mat_name,"MAIN");if(reflect_batch)reflect_batch.alpha_factor=
alpha_factor}else m_print.error('Couldn\'t set property "alpha_factor"!')};exports.get_alpha_factor=function(obj,mat_name){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch)return batch.alpha_factor;else m_print.error('Couldn\'t get property "alpha_factor"!')};exports.get_material_extended_params=function(obj,mat_name){if(!obj||!mat_name){m_print.error("missing arguments in get_material_params");return null}if(!check_batch_material(obj,mat_name))return null;var batch=m_batch.find_batch_material(obj,
mat_name,"MAIN");if(!batch)return null;var mat_params={};if(batch.type=="MAIN"){mat_params.reflect_factor=batch.reflect_factor;mat_params.fresnel=batch.fresnel_params[2];mat_params.fresnel_factor=5*(1-batch.fresnel_params[3]);mat_params.parallax_scale=batch.parallax_scale;mat_params.parallax_steps=m_batch.get_batch_directive(batch,"PARALLAX_STEPS")[1]}return mat_params};exports.get_water_material_params=function(obj,water_mat_name){if(!obj||!water_mat_name){m_print.error("missing arguments in get_water_material_params");
return null}if(!check_batch_material(obj,water_mat_name))return null;var batch=m_batch.find_batch_material(obj,water_mat_name,"MAIN");if(!batch||!batch.water)return null;if(!batch){m_print.error("material not found");return null}var water_mat_params={};if(batch.type=="MAIN"){if(cfg_def.shore_distance){var shlwc=water_mat_params.shallow_water_col=new Array(3);shlwc[0]=batch.shallow_water_col[0];shlwc[1]=batch.shallow_water_col[1];shlwc[2]=batch.shallow_water_col[2];var shrwc=water_mat_params.shore_water_col=
new Array(3);shrwc[0]=batch.shore_water_col[0];shrwc[1]=batch.shore_water_col[1];shrwc[2]=batch.shore_water_col[2];water_mat_params.shallow_water_col_fac=batch.shallow_water_col_fac;water_mat_params.shore_water_col_fac=batch.shore_water_col_fac}water_mat_params.foam_factor=batch.foam_factor;water_mat_params.norm_uv_velocity=batch.water_norm_uv_velocity;water_mat_params.absorb_factor=m_batch.get_batch_directive(batch,"ABSORB")[1];water_mat_params.sss_strength=m_batch.get_batch_directive(batch,"SSS_STRENGTH")[1];
water_mat_params.sss_width=m_batch.get_batch_directive(batch,"SSS_WIDTH")[1];water_mat_params.dst_noise_scale0=m_batch.get_batch_directive(batch,"DST_NOISE_SCALE_0")[1];water_mat_params.dst_noise_scale1=m_batch.get_batch_directive(batch,"DST_NOISE_SCALE_1")[1];water_mat_params.dst_noise_freq0=m_batch.get_batch_directive(batch,"DST_NOISE_FREQ_0")[1];water_mat_params.dst_noise_freq1=m_batch.get_batch_directive(batch,"DST_NOISE_FREQ_1")[1];water_mat_params.dir_min_shore_fac=m_batch.get_batch_directive(batch,
"DIR_MIN_SHR_FAC")[1];water_mat_params.dir_freq=m_batch.get_batch_directive(batch,"DIR_FREQ")[1];water_mat_params.dir_noise_scale=m_batch.get_batch_directive(batch,"DIR_NOISE_SCALE")[1];water_mat_params.dir_noise_freq=m_batch.get_batch_directive(batch,"DIR_NOISE_FREQ")[1];water_mat_params.dir_min_noise_fac=m_batch.get_batch_directive(batch,"DIR_MIN_NOISE_FAC")[1];water_mat_params.dst_min_fac=m_batch.get_batch_directive(batch,"DST_MIN_FAC")[1];water_mat_params.waves_hor_fac=m_batch.get_batch_directive(batch,
"WAVES_HOR_FAC")[1]}return water_mat_params};exports.set_material_extended_params=function(obj,mat_name,mat_params){if(!obj||!mat_name||!mat_params){m_print.error("missing arguments in set_material_params");return}if(!check_batch_material(obj,mat_name)){m_print.error("setting material params is not possible");return}var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(!batch){m_print.error("material not found");return}var batches=[batch];var reflect_batch=m_batch.find_batch_material_forked(obj,
mat_name,"MAIN");if(reflect_batch)batches.push(reflect_batch);for(var i=0;i<batches.length;i++){var batch=batches[i];if(typeof mat_params.material_reflectivity=="number"){var refl=mat_params.material_reflectivity;batch.reflect_factor=refl}if(typeof mat_params.material_fresnel=="number"){var fresnel=mat_params.material_fresnel;batch.fresnel_params[2]=fresnel}if(typeof mat_params.material_fresnel_factor=="number"){var fresnel_factor=1-mat_params.material_fresnel_factor/5;batch.fresnel_params[3]=fresnel_factor}if(typeof mat_params.material_parallax_scale==
"number"){var parallax_scale=mat_params.material_parallax_scale;batch.parallax_scale=parallax_scale}if(typeof mat_params.material_parallax_steps=="number"){var parallax_steps=m_shaders.glsl_value(parseFloat(mat_params.material_parallax_steps));m_batch.set_batch_directive(batch,"PARALLAX_STEPS",parallax_steps);m_batch.update_shader(batch,true)}}};exports.set_water_material_params=function(obj,water_mat_name,water_mat_params){if(!obj||!water_mat_name||!water_mat_params){m_print.error("missing arguments in set_water_material_params");
return}if(!check_batch_material(obj,water_mat_name)){m_print.error("setting water material params is not possible");return}var batch=m_batch.find_batch_material(obj,water_mat_name,"MAIN");if(!batch){m_print.error("material not found");return}var batches=[batch];var reflect_batch=m_batch.find_batch_material_forked(obj,water_mat_name,"MAIN");if(reflect_batch)batches.push(reflect_batch);for(var i=0;i<batches.length;i++){var batch=batches[i];if(cfg_def.shore_distance){if(typeof water_mat_params.shallow_water_col==
"object")batch.shallow_water_col.set(water_mat_params.shallow_water_col);if(typeof water_mat_params.shallow_water_col_fac=="number")batch.shallow_water_col_fac=water_mat_params.shallow_water_col_fac;if(typeof water_mat_params.shore_water_col=="object")batch.shore_water_col.set(water_mat_params.shore_water_col);if(typeof water_mat_params.shore_water_col_fac=="number")batch.shore_water_col_fac=water_mat_params.shore_water_col_fac}if(cfg_def.shore_smoothing&&batch.water_shore_smoothing){if(typeof water_mat_params.shore_smoothing==
"boolean")if(water_mat_params.shore_smoothing)m_batch.set_batch_directive(batch,"SHORE_SMOOTHING",1);else m_batch.set_batch_directive(batch,"SHORE_SMOOTHING",0);if(typeof water_mat_params.absorb_factor=="number"){var absorb_factor=m_shaders.glsl_value(parseFloat(water_mat_params.absorb_factor));m_batch.set_batch_directive(batch,"ABSORB",absorb_factor)}}if(typeof water_mat_params.foam_factor=="number"&&cfg_def.foam)batch.foam_factor=water_mat_params.foam_factor;if(typeof water_mat_params.norm_uv_velocity==
"number")batch.water_norm_uv_velocity=water_mat_params.norm_uv_velocity;if(cfg_def.water_dynamic&&batch.water_dynamic){if(typeof water_mat_params.water_dynamic=="boolean")if(water_mat_params.water_dynamic)m_batch.set_batch_directive(batch,"DYNAMIC",1);else m_batch.set_batch_directive(batch,"DYNAMIC",0);if(typeof water_mat_params.waves_height=="number"){var waves_height=m_shaders.glsl_value(parseFloat(water_mat_params.waves_height));m_batch.set_batch_directive(batch,"WAVES_HEIGHT",waves_height)}if(typeof water_mat_params.waves_length==
"number"){var waves_length=m_shaders.glsl_value(parseFloat(water_mat_params.waves_length));m_batch.set_batch_directive(batch,"WAVES_LENGTH",waves_length)}if(typeof water_mat_params.sss_strength=="number"){var waves_length=m_shaders.glsl_value(parseFloat(water_mat_params.sss_strength));m_batch.set_batch_directive(batch,"SSS_STRENGTH",waves_length)}if(typeof water_mat_params.sss_width=="number"){var waves_length=m_shaders.glsl_value(parseFloat(water_mat_params.sss_width));m_batch.set_batch_directive(batch,
"SSS_WIDTH",waves_length)}if(typeof water_mat_params.dst_noise_scale0=="number"){var dst_noise_scale0=m_shaders.glsl_value(parseFloat(water_mat_params.dst_noise_scale0));m_batch.set_batch_directive(batch,"DST_NOISE_SCALE_0",dst_noise_scale0)}if(typeof water_mat_params.dst_noise_scale1=="number"){var dst_noise_scale1=m_shaders.glsl_value(parseFloat(water_mat_params.dst_noise_scale1));m_batch.set_batch_directive(batch,"DST_NOISE_SCALE_1",dst_noise_scale1)}if(typeof water_mat_params.dst_noise_freq0==
"number"){var dst_noise_freq0=m_shaders.glsl_value(parseFloat(water_mat_params.dst_noise_freq0));m_batch.set_batch_directive(batch,"DST_NOISE_FREQ_0",dst_noise_freq0)}if(typeof water_mat_params.dst_noise_freq1=="number"){var dst_noise_freq1=m_shaders.glsl_value(parseFloat(water_mat_params.dst_noise_freq1));m_batch.set_batch_directive(batch,"DST_NOISE_FREQ_1",dst_noise_freq1)}if(typeof water_mat_params.dir_min_shore_fac=="number"){var dir_min_shore_fac=m_shaders.glsl_value(parseFloat(water_mat_params.dir_min_shore_fac));
m_batch.set_batch_directive(batch,"DIR_MIN_SHR_FAC",dir_min_shore_fac)}if(typeof water_mat_params.dir_freq=="number"){var dir_freq=m_shaders.glsl_value(parseFloat(water_mat_params.dir_freq));m_batch.set_batch_directive(batch,"DIR_FREQ",dir_freq)}if(typeof water_mat_params.dir_noise_scale=="number"){var dir_noise_scale=m_shaders.glsl_value(parseFloat(water_mat_params.dir_noise_scale));m_batch.set_batch_directive(batch,"DIR_NOISE_SCALE",dir_noise_scale)}if(typeof water_mat_params.dir_noise_freq=="number"){var dir_noise_freq=
m_shaders.glsl_value(parseFloat(water_mat_params.dir_noise_freq));m_batch.set_batch_directive(batch,"DIR_NOISE_FREQ",dir_noise_freq)}if(typeof water_mat_params.dir_min_noise_fac=="number"){var dir_min_noise_fac=m_shaders.glsl_value(parseFloat(water_mat_params.dir_min_noise_fac));m_batch.set_batch_directive(batch,"DIR_MIN_NOISE_FAC",dir_min_noise_fac)}if(typeof water_mat_params.dst_min_fac=="number"){var dst_min_fac=m_shaders.glsl_value(parseFloat(water_mat_params.dst_min_fac));m_batch.set_batch_directive(batch,
"DST_MIN_FAC",dst_min_fac)}if(typeof water_mat_params.waves_hor_fac=="number"){var waves_hor_fac=m_shaders.glsl_value(parseFloat(water_mat_params.waves_hor_fac));m_batch.set_batch_directive(batch,"WAVES_HOR_FAC",waves_hor_fac)}}m_batch.update_shader(batch,true)}}};b4w.module["particles"]=function(exports,require){var m_particles=require("__particles");var m_print=require("__print");exports.set_size=function(obj,psys_name,size){if(!m_particles.obj_has_particles(obj)){m_print.error('"',obj.name,'" has no particle systems');return}m_particles.set_size(obj,psys_name,size)};exports.set_normal_factor=function(obj,psys_name,nfactor){if(!m_particles.obj_has_particles(obj)){m_print.error('"',obj.name,'" has no particle systems');return}m_particles.set_normal_factor(obj,
psys_name,nfactor)};exports.set_factor=function(obj,psys_name,factor){if(!m_particles.obj_has_particles(obj)){m_print.error('"',obj.name,'" has no particle systems');return}factor=Math.min(factor,1);factor=Math.max(factor,0);m_particles.set_factor(obj,psys_name,factor)}};b4w.module["physics"]=function(exports,require){var m_cfg=require("__config");var m_ipc=require("__ipc");var m_phy=require("__physics");var m_print=require("__print");var m_util=require("__util");var cfg_phy=m_cfg.physics;exports.CM_WALK=0;exports.CM_RUN=1;exports.CM_CLIMB=2;exports.CM_FLY=3;exports.enable_simulation=function(obj){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.enable_simulation(obj)};exports.disable_simulation=function(obj){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+
obj.name);return}m_phy.disable_simulation(obj)};exports.has_physics=function(obj){return m_phy.obj_has_physics(obj)};exports.has_simulated_physics=function(obj){return m_phy.has_simulated_physics(obj)};exports.has_dynamic_physics=function(obj){return m_phy.has_dynamic_physics(obj)};exports.set_gravity=function(obj,gravity){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.set_gravity(obj,gravity)};exports.set_damping=function(obj,damping,rotation_damping){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+
obj.name);return}var body_id=obj.physics.body_id;m_phy.post_msg("set_damping",body_id,damping,rotation_damping)};exports.reset_damping=function(obj){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}var phy_set=obj.physics_settings;var damping=phy_set.damping;var rdamping=phy_set.rotation_damping;var body_id=obj.physics.body_id;m_phy.post_msg("set_damping",body_id,damping,rdamping)};exports.set_transform=function(obj,trans,quat){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+
obj.name);return}m_phy.set_transform.apply(this,arguments)};exports.sync_transform=function(obj){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.sync_transform(obj)};exports.apply_velocity=function(obj){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.apply_velocity.apply(this,arguments)};exports.apply_velocity_world=function(obj){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);
return}m_phy.apply_velocity_world.apply(this,arguments)};exports.apply_force=function(obj,fx_local,fy_local,fz_local){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.apply_force.apply(this,arguments)};exports.apply_torque=function(obj,tx_local,ty_local,tz_local){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.apply_torque.apply(this,arguments)};exports.vehicle_throttle=function(obj,engine_force){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+
obj.name);return}if(!m_phy.is_vehicle_chassis(obj)&&!m_phy.is_vehicle_hull(obj))m_print.error("Wrong object");m_phy.vehicle_throttle(obj,m_util.clamp(engine_force,-1,1))};exports.vehicle_throttle_inc=function(obj,engine_force_inc,dir){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}if(!m_phy.is_vehicle_chassis(obj)&&!m_phy.is_vehicle_hull(obj))m_print.error("Wrong object");engine_force_inc=m_util.clamp(engine_force_inc,0,1);var vehicle=obj.vehicle;var force=
vehicle.engine_force;if(dir==-1||dir==1){force+=dir*engine_force_inc;force=Math.max(-1,Math.min(force,1))}else if(dir==0&&force>=0){force-=engine_force_inc;force=Math.max(0,force)}else if(dir==0&&force<0){force+=engine_force_inc;force=Math.min(0,force)}else m_print.error("Wrong steering direction");m_phy.vehicle_throttle(obj,m_util.clamp(force,-1,1))};exports.vehicle_steer=function(obj,steering_value){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}if(!m_phy.is_vehicle_chassis(obj)&&
!m_phy.is_vehicle_hull(obj))m_print.error("Wrong object");m_phy.vehicle_steer(obj,m_util.clamp(steering_value,-1,1))};exports.vehicle_steer_inc=function(obj,steering_value_inc,dir){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}if(!m_phy.is_vehicle_chassis(obj)&&!m_phy.is_vehicle_hull(obj))m_print.error("Wrong object");steering_value_inc=m_util.clamp(steering_value_inc,0,1);var vehicle=obj.vehicle;var steering=vehicle.steering;if(dir==-1||dir==1){steering+=
dir*steering_value_inc;steering=Math.max(-1,Math.min(steering,1))}else if(dir==0&&steering>=0){steering-=steering_value_inc;steering=Math.max(0,steering)}else if(dir==0&&steering<0){steering+=steering_value_inc;steering=Math.min(0,steering)}else m_print.error("Wrong steering direction");m_phy.vehicle_steer(obj,m_util.clamp(steering,-1,1))};exports.vehicle_brake=function(obj,brake_force){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}if(!m_phy.is_vehicle_chassis(obj)&&
!m_phy.is_vehicle_hull(obj))m_print.error("Wrong object");m_phy.vehicle_brake(obj,m_util.clamp(brake_force,0,1))};exports.vehicle_brake_inc=function(obj,brake_force_inc){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}if(!m_phy.is_vehicle_chassis(obj)&&!m_phy.is_vehicle_hull(obj))m_print.error("Wrong object");brake_force_inc=m_util.clamp(brake_force_inc,-1,1);var vehicle=obj.vehicle;var brake_force=vehicle.brake_force;brake_force+=brake_force*brake_force_inc;
m_phy.vehicle_brake(obj,m_util.clamp(brake_force,0,1))};exports.is_vehicle_chassis=function(obj){return m_phy.is_vehicle_chassis(obj)};exports.is_vehicle_hull=function(obj){return m_phy.is_vehicle_hull(obj)};exports.get_vehicle_name=function(obj){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return null}if(m_phy.is_vehicle_chassis(obj)||m_phy.is_vehicle_hull(obj))return obj.vehicle_settings.name;else{m_print.error("Wrong object");return null}};exports.get_vehicle_throttle=
function(obj){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return null}if(m_phy.is_vehicle_chassis(obj)||m_phy.is_vehicle_hull(obj))return obj.vehicle.engine_force;else{m_print.error("Wrong object");return null}};exports.get_vehicle_steering=function(obj){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return null}if(m_phy.is_vehicle_chassis(obj)||m_phy.is_vehicle_hull(obj))return obj.vehicle.steering;else m_print.error("Wrong object")};
exports.get_vehicle_brake=function(obj){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return null}if(m_phy.is_vehicle_chassis(obj)||m_phy.is_vehicle_hull(obj))return obj.vehicle.brake_force;else m_print.error("Wrong object")};exports.get_vehicle_speed=function(obj){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return null}if(m_phy.is_vehicle_chassis(obj)||m_phy.is_vehicle_hull(obj))return m_phy.get_vehicle_speed(obj);else m_print.error("Wrong object")};
exports.is_character=function(obj){return m_phy.is_character(obj)};exports.set_character_move_dir=function(obj,forw,side){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.set_character_move_dir(obj,forw,side)};exports.set_character_move_type=function(obj,type){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.set_character_move_type(obj,type)};exports.set_character_walk_velocity=function(obj,velocity){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+
obj.name);return}m_phy.set_character_walk_velocity(obj,velocity)};exports.set_character_run_velocity=function(obj,velocity){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.set_character_run_velocity(obj,velocity)};exports.set_character_fly_velocity=function(obj,velocity){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.set_character_fly_velocity(obj,velocity)};exports.character_jump=function(obj){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+
obj.name);return}m_phy.character_jump(obj)};exports.character_rotation_inc=function(obj,h_angle,v_angle){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.character_rotation_inc(obj,h_angle,v_angle)};exports.set_character_rotation_quat=function(obj,quat){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.set_character_rotation_quat(obj,quat)};exports.set_character_rotation=function(obj,angle_h,angle_v){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+
obj.name);return}m_phy.set_character_rotation(obj,angle_h,angle_v)};exports.set_character_rotation_v=function(obj,angle){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.set_character_rotation_v(obj,angle)};exports.set_character_rotation_h=function(obj,angle){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.set_character_rotation_h(obj,angle)};exports.append_collision_test=function(obj_src,collision_id,callback,
calc_pos_norm){if(!m_phy.obj_has_physics(obj_src)){m_print.error("No physics for object "+obj_src.name);return}calc_pos_norm=calc_pos_norm||false;m_phy.append_collision_test(obj_src,collision_id,callback,calc_pos_norm)};exports.remove_collision_test=function(obj,collision_id,callback){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}var collision_id=collision_id||"ANY";m_phy.remove_collision_test(obj,collision_id,callback)};exports.apply_collision_impulse_test=
function(obj,callback){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.apply_collision_impulse_test(obj,callback)};exports.clear_collision_impulse_test=function(obj){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.clear_collision_impulse_test(obj)};exports.append_ray_test=function(obj_src,from,to,collision_id,callback,autoremove){autoremove=autoremove||false;var calc_all_hits=false;var calc_pos_norm=false;
var ign_src_rot=false;return m_phy.append_ray_test(obj_src,from,to,collision_id,callback,autoremove,calc_all_hits,calc_pos_norm,ign_src_rot)};exports.append_ray_test_ext=function(obj_src,from,to,collision_id,callback,autoremove,calc_all_hits,calc_pos_norm,ign_src_rot){autoremove=autoremove||false;calc_all_hits=calc_all_hits||false;calc_pos_norm=calc_pos_norm||false;ign_src_rot=ign_src_rot||false;return m_phy.append_ray_test(obj_src,from,to,collision_id,callback,autoremove,calc_all_hits,calc_pos_norm,
ign_src_rot)};exports.remove_ray_test=function(id){if(!m_phy.is_ray_test(id)){m_print.error("Wrong ray test ID");return}m_phy.remove_ray_test(id)};exports.change_ray_test_from_to=function(id,from,to){if(!m_phy.is_ray_test(id)){m_print.error("Wrong ray test ID");return}m_phy.change_ray_test_from_to(id,from,to)};exports.apply_constraint=function(pivot_type,obj_a,trans_a,quat_a,obj_b,trans_b,quat_b,limits,stiffness,damping){if(!m_phy.obj_has_physics(obj_a)||!m_phy.obj_has_physics(obj_b)){m_print.error("Wrong objects");
return}m_phy.apply_constraint(pivot_type,obj_a,trans_a,quat_a,obj_b,trans_b,quat_b,limits,stiffness,damping)};exports.clear_constraint=function(obj_a){if(!m_phy.obj_has_physics(obj_a)||!m_phy.has_constraint(obj_a)){m_print.error("Wrong object");return}m_phy.clear_constraint(obj_a)};exports.pull_to_constraint_pivot=function(obj_a,trans_a,quat_a,obj_b,trans_b,quat_b){if(!m_phy.obj_has_physics(obj_a)||!m_phy.obj_has_physics(obj_b)){m_print.error("Wrong objects");return}m_phy.pull_to_constraint_pivot(obj_a,
trans_a,quat_a,obj_b,trans_b,quat_b)};exports.get_worker_listeners=m_ipc.get_worker_listeners};b4w.module["rgb"]=function(exports,require){var m_print=require("__print");var m_util=require("__util");var _rgb_tmp=new Float32Array(3);exports.create=function(){var dest=new Float32Array(3);return dest};exports.from_values=function(r,g,b){var dest=new Float32Array(3);dest[0]=r;dest[1]=g;dest[2]=b;return dest};exports.set=function(r,g,b,dest){dest[0]=r;dest[1]=g;dest[2]=b;return dest};exports.css_to_rgb=function(css_red,css_green,css_blue,dest){dest=dest||new Float32Array(3);dest[0]=css_red/255;
dest[1]=css_green/255;dest[2]=css_blue/255;m_util.srgb_to_lin(dest,dest);return dest};exports.rgb_to_css=function(rgb){var srgb=m_util.lin_to_srgb(rgb,_rgb_tmp);return[Math.round(255*srgb[0]),Math.round(255*srgb[1]),Math.round(255*srgb[2])]};exports.rgb_to_css_hex=function(rgb){var col_to_hex=function(num){var s=Math.round(255*num).toString(16);return s.length==1?"0"+s:s};var srgb=m_util.lin_to_srgb(rgb,_rgb_tmp);return"#"+col_to_hex(srgb[0])+col_to_hex(srgb[1])+col_to_hex(srgb[2])}};
b4w.module["rgba"]=function(exports,require){var m_print=require("__print");var m_util=require("__util");var _rgb_tmp=new Float32Array(3);exports.create=function(){var dest=new Float32Array(4);dest[3]=1;return dest};exports.from_values=function(r,g,b,a){var dest=new Float32Array(4);dest[0]=r;dest[1]=g;dest[2]=b;dest[3]=a;return dest};exports.set=function(r,g,b,a,dest){dest[0]=r;dest[1]=g;dest[2]=b;dest[3]=a;return dest};exports.css_to_rgba=function(css_red,css_green,css_blue,css_alpha,dest){dest=
dest||new Float32Array(4);dest[0]=css_red/255;dest[1]=css_green/255;dest[2]=css_blue/255;dest[3]=css_alpha;m_util.srgb_to_lin(dest,dest);return dest};exports.rgba_to_css=function(rgba){var srgb=m_util.lin_to_srgb(rgba,_rgb_tmp);return[Math.round(255*srgb[0]),Math.round(255*srgb[1]),Math.round(255*srgb[2]),rgba[3]]}};b4w.module["scenes"]=function(exports,require){var m_batch=require("__batch");var m_cam=require("__camera");var m_data=require("__data");var m_graph=require("__graph");var m_obj=require("__objects");var m_obj_util=require("__obj_util");var m_phy=require("__physics");var m_print=require("__print");var m_scenes=require("__scenes");var m_util=require("__util");exports.DATA_ID_ALL=m_obj.DATA_ID_ALL;exports.set_active=function(scene_name){var scenes=m_scenes.get_all_scenes();m_scenes.set_active(m_util.keysearch("name",
scene_name,scenes))};exports.get_active=function(){if(!m_scenes.check_active())return"";else return m_scenes.get_active()["name"]};exports.get_scenes=function(){var scenes=m_scenes.get_all_scenes();var scene_names=[];for(var i=0;i<scenes.length;i++)scene_names.push(scenes[i]["name"]);return scene_names};exports.get_active_camera=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return false}else return m_scenes.get_camera(m_scenes.get_active())};exports.get_object_by_name=function(name,
data_id){var obj=m_obj.get_object(m_obj.GET_OBJECT_BY_NAME,name,data_id|0);if(obj)return obj;else m_print.error("get object "+name+": not found")};exports.get_object_by_dupli_name=function(empty_name,dupli_name,data_id){var obj=m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME,empty_name,dupli_name,data_id|0);if(obj)return obj;else m_print.error("get object "+dupli_name+": not found")};exports.get_object_by_dupli_name_list=function(name_list,data_id){var obj=m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME_LIST,
name_list,data_id|0);if(obj)return obj;else m_print.error("get object "+name_list+": not found")};exports.get_object_data_id=function(obj){return m_scenes.get_object_data_id(obj)};exports.pick_object=m_obj.pick_object;exports.outlining_is_enabled=function(obj){return obj&&obj.render&&obj.render.outlining};exports.set_outline_intensity=function(obj,value){if(obj&&obj.render&&obj.render.outlining)obj.render.outline_intensity=value;else m_print.error("set_outline_intensity(): wrong object")};exports.get_outline_intensity=
function(obj){if(obj&&obj.render&&obj.render.outlining)return obj.render.outline_intensity;else m_print.error("get_outline_intensity(): wrong object")};exports.apply_outline_anim=function(obj,tau,T,N){if(obj&&obj.render&&obj.render.outlining)m_obj.apply_outline_anim(obj,tau,T,N);else m_print.error("apply_outline_anim(): wrong object")};exports.apply_outline_anim_def=function(obj){if(obj&&obj.render&&obj.render.outlining){var oa_set=obj.render.outline_anim_settings_default;m_obj.apply_outline_anim(obj,
oa_set.outline_duration,oa_set.outline_period,oa_set.outline_relapses)}else m_print.error("apply_outline_anim_def(): wrong object")};exports.clear_outline_anim=function(obj){if(obj&&obj.render&&obj.render.outlining)m_obj.clear_outline_anim(obj);else m_print.error("clear_outline_anim(): wrong object")};exports.set_outline_color=m_scenes.set_outline_color;exports.get_outline_color=function(dest){var scene=m_scenes.get_active();var subs=m_scenes.get_subs(scene,"OUTLINE");if(subs){dest=dest||new Float32Array(3);
dest.set(subs.outline_color);return dest}};exports.set_glow_intensity=function(obj,value){m_print.error("set_glow_intensity() deprecated, use set_outline_intensity() instead");exports.set_outline_intensity(obj,value)};exports.get_glow_intensity=function(obj){m_print.error("get_glow_intensity() deprecated, use get_outline_intensity() instead");exports.get_outline_intensity(obj)};exports.apply_glow_anim=function(obj,tau,T,N){m_print.error("apply_glow_anim() deprecated, use apply_outline_anim() instead");
exports.apply_outline_anim(obj,tau,T,N)};exports.apply_glow_anim_def=function(obj){m_print.error("apply_glow_anim_def() deprecated, use apply_outline_anim_def() instead");exports.apply_outline_anim_def(obj)};exports.clear_glow_anim=function(obj){m_print.error("clear_glow_anim() deprecated, use clear_outline_anim() instead");exports.clear_outline_anim(obj)};exports.set_glow_color=function(color){m_print.error("set_glow_color() deprecated, use set_outline_color() instead");exports.set_outline_color(color)};
exports.get_glow_color=function(dest){m_print.error("get_glow_color() deprecated, use get_outline_color() instead");exports.get_outline_color(dest)};exports.get_shadow_params=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();var shadow_cast=m_scenes.get_subs(active_scene,"SHADOW_CAST");if(!shadow_cast)return null;var shs=active_scene._render.shadow_params;var subs_main=m_scenes.get_subs(active_scene,"MAIN_OPAQUE");var subs_depth=
m_scenes.get_subs(active_scene,"DEPTH");var shadow_params={};shadow_params.csm_resolution=shs.csm_resolution;shadow_params.self_shadow_polygon_offset=shadow_cast.self_shadow_polygon_offset;if(subs_depth)shadow_params.self_shadow_normal_offset=subs_depth.self_shadow_normal_offset;shadow_params.enable_csm=shs.enable_csm;shadow_params.csm_num=shs.csm_num;shadow_params.csm_first_cascade_border=shs.csm_first_cascade_border;shadow_params.first_cascade_blur_radius=shs.first_cascade_blur_radius;shadow_params.csm_last_cascade_border=
shs.csm_last_cascade_border;shadow_params.last_cascade_blur_radius=shs.last_cascade_blur_radius;shadow_params.fade_last_cascade=shs.fade_last_cascade;shadow_params.blend_between_cascades=shs.blend_between_cascades;if(shs.enable_csm){shadow_params.csm_borders=m_scenes.get_csm_borders(active_scene,subs_main.camera);shadow_params.blur_radii=new Float32Array(shs.csm_num);shadow_params.blur_radii.set(subs_main.camera.pcf_blur_radii.subarray(0,shs.csm_num))}else{shadow_params.csm_borders=null;shadow_params.blur_radii=
null}return shadow_params};exports.set_shadow_params=function(shadow_params){if(!m_scenes.check_active()){m_print.error("No active scene");return}var active_scene=m_scenes.get_active();if(typeof shadow_params.self_shadow_polygon_offset=="number")m_graph.traverse(active_scene._render.graph,function(node,attr){if(attr.type==="SHADOW_CAST")attr.self_shadow_polygon_offset=shadow_params.self_shadow_polygon_offset});var subs_depth=m_scenes.get_subs(active_scene,"DEPTH");if(subs_depth){if(typeof shadow_params.self_shadow_normal_offset==
"number")subs_depth.self_shadow_normal_offset=shadow_params.self_shadow_normal_offset;if(typeof shadow_params.pcf_blur_radius=="number")subs_depth.pcf_blur_radius=shadow_params.pcf_blur_radius}var subs_main_blend=m_scenes.get_subs(active_scene,"MAIN_BLEND");if(subs_main_blend){if(typeof shadow_params.self_shadow_normal_offset=="number")subs_main_blend.self_shadow_normal_offset=shadow_params.self_shadow_normal_offset;if(typeof shadow_params.pcf_blur_radius=="number")subs_main_blend.pcf_blur_radius=
shadow_params.pcf_blur_radius;subs_main_blend.need_perm_uniforms_update=true}var shs=active_scene._render.shadow_params;if(typeof shadow_params.csm_first_cascade_border=="number")shs.csm_first_cascade_border=shadow_params.csm_first_cascade_border;if(typeof shadow_params.first_cascade_blur_radius=="number")shs.first_cascade_blur_radius=shadow_params.first_cascade_blur_radius;if(typeof shadow_params.csm_last_cascade_border=="number")shs.csm_last_cascade_border=shadow_params.csm_last_cascade_border;
if(typeof shadow_params.last_cascade_blur_radius=="number")shs.last_cascade_blur_radius=shadow_params.last_cascade_blur_radius;if(subs_depth){var bundles=subs_depth.bundles;for(var i=0;i<bundles.length;i++){var bundle=bundles[i];if(!bundle.obj_render.shadow_receive)continue;var batch=bundle.batch;m_batch.assign_shadow_receive_dirs(batch,shs);m_batch.update_shader(batch)}subs_depth.need_perm_uniforms_update=true}var upd_cameras=active_scene._camera.render.cameras;for(var i=0;i<upd_cameras.length;i++)m_cam.update_camera_shadows(upd_cameras[i],
shs);m_scenes.schedule_shadow_update(active_scene)};exports.get_environment_colors=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();return m_scenes.get_environment_colors(active_scene)};exports.set_environment_colors=function(opt_environment_energy,opt_horizon_color,opt_zenith_color){if(!m_scenes.check_active()){m_print.error("No active scene");return}var active_scene=m_scenes.get_active();m_scenes.set_environment_colors(active_scene,
parseFloat(opt_environment_energy),opt_horizon_color,opt_zenith_color)};exports.get_fog_color_density=function(dest){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();return m_scenes.get_fog_color_density(active_scene,dest)};exports.set_fog_color_density=function(val){if(!m_scenes.check_active()){m_print.error("No active scene");return}var active_scene=m_scenes.get_active();m_scenes.set_fog_color_density(active_scene,val)};exports.get_ssao_params=
function(){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();return m_scenes.get_ssao_params(active_scene)};exports.set_ssao_params=function(ssao_params){if(!m_scenes.check_active()){m_print.error("No active scene");return}var active_scene=m_scenes.get_active();m_scenes.set_ssao_params(active_scene,ssao_params)};exports.get_color_correction_params=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return null}var active_scene=
m_scenes.get_active();var subs=m_scenes.get_subs(active_scene,"COMPOSITING");if(!subs)return null;var compos_params={};compos_params.brightness=subs.brightness;compos_params.contrast=subs.contrast;compos_params.exposure=subs.exposure;compos_params.saturation=subs.saturation;return compos_params};exports.set_color_correction_params=function(color_corr_params){if(!m_scenes.check_active()){m_print.error("No active scene");return}var active_scene=m_scenes.get_active();var subs=m_scenes.get_subs(active_scene,
"COMPOSITING");if(!subs)return;if(typeof color_corr_params.brightness=="number")subs.brightness=color_corr_params.brightness;if(typeof color_corr_params.contrast=="number")subs.contrast=color_corr_params.contrast;if(typeof color_corr_params.exposure=="number")subs.exposure=color_corr_params.exposure;if(typeof color_corr_params.saturation=="number")subs.saturation=color_corr_params.saturation;subs.need_perm_uniforms_update=true};exports.get_sky_params=function(){if(!m_scenes.check_active()){m_print.error("No active scene");
return false}var active_scene=m_scenes.get_active();return m_scenes.get_sky_params(active_scene)};exports.set_sky_params=function(sky_params){if(!m_scenes.check_active()){m_print.error("No active scene");return}var active_scene=m_scenes.get_active();m_scenes.set_sky_params(active_scene,sky_params)};exports.get_dof_params=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();var subs=m_scenes.get_subs(active_scene,"DOF");if(subs)return m_scenes.get_dof_params(active_scene);
else return null};exports.set_dof_params=function(dof_params){if(!m_scenes.check_active()){m_print.error("No active scene");return}var active_scene=m_scenes.get_active();m_scenes.set_dof_params(active_scene,dof_params)};exports.get_god_rays_params=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();var subs=m_scenes.get_subs(active_scene,"GOD_RAYS");if(subs)return m_scenes.get_god_rays_params(active_scene);else return null};
exports.set_god_rays_params=function(god_rays_params){if(!m_scenes.check_active()){m_print.error("No active scene");return}var active_scene=m_scenes.get_active();m_scenes.set_god_rays_params(active_scene,god_rays_params)};exports.get_bloom_params=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();var subs=m_scenes.get_subs(active_scene,"BLOOM");if(subs)return m_scenes.get_bloom_params(active_scene);else return null};exports.set_bloom_params=
function(bloom_params){if(!m_scenes.check_active()){m_print.error("No active scene");return}var active_scene=m_scenes.get_active();m_scenes.set_bloom_params(active_scene,bloom_params)};exports.get_glow_material_params=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();var subs=m_scenes.get_subs(active_scene,"GLOW_COMBINE");if(subs)return m_scenes.get_glow_material_params(active_scene);else return null};exports.set_glow_material_params=
function(glow_material_params){if(!m_scenes.check_active()){m_print.error("No active scene");return}var active_scene=m_scenes.get_active();m_scenes.set_glow_material_params(active_scene,glow_material_params)};exports.get_wind_params=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();return m_scenes.get_wind_params(active_scene)};exports.set_wind_params=function(wind_params){if(!m_scenes.check_active()){m_print.error("No active scene");
return}var active_scene=m_scenes.get_active();m_obj.set_wind_params(active_scene,wind_params)};exports.get_water_surface_level=m_scenes.get_water_surface_level;exports.set_water_params=function(water_params){if(!m_scenes.check_active()){m_print.error("No active scene");return}var active_scene=m_scenes.get_active();m_scenes.set_water_params(active_scene,water_params)};exports.get_water_mat_params=function(water_params){if(!m_scenes.check_active()){m_print.error("No active scene");return}var active_scene=
m_scenes.get_active();m_scenes.get_water_mat_params(active_scene,water_params)};exports.update_scene_materials_params=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return}var active_scene=m_scenes.get_active();m_scenes.update_scene_permanent_uniforms(active_scene)};exports.hide_object=function(obj){if(m_obj_util.is_dynamic_mesh(obj)||m_obj_util.is_empty(obj))m_scenes.hide_object(obj);else m_print.error("show/hide is only supported for dynamic meshes/empties")};exports.show_object=
function(obj){if(m_obj_util.is_dynamic_mesh(obj)||m_obj_util.is_empty(obj))m_scenes.show_object(obj);else m_print.error("show/hide is only supported for dynamic meshes/empties")};exports.is_hidden=function(obj){if(m_obj_util.is_dynamic_mesh(obj)||m_obj_util.is_empty(obj))return m_scenes.is_hidden(obj);else{m_print.error("show/hide is only supported for dynamic meshes/empties");return false}};exports.is_visible=function(obj){return obj.render.is_visible};exports.check_object=function(obj){if(!m_scenes.check_active()){m_print.error("No active scene");
return false}return m_obj.objects_storage_check(obj,m_scenes.get_active())};exports.check_object_by_name=function(name,data_id){var obj=m_obj.get_object(m_obj.GET_OBJECT_BY_NAME,name,data_id|0);if(obj)return true;else return false};exports.check_object_by_dupli_name=function(empty_name,dupli_name,data_id){var obj=m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME,empty_name,dupli_name,data_id|0);if(obj)return true;else return false};exports.check_object_by_dupli_name_list=function(name_list,data_id){var obj=
m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME_LIST,name_list,data_id|0);if(obj)return true;else return false};exports.get_all_objects=function(type,data_id){var scene=m_scenes.get_active();if(!type)type="ALL";if(!data_id&&data_id!==0)data_id=m_obj.DATA_ID_ALL;return m_obj.get_scene_objs(scene,type,data_id)};exports.get_object_name=function(obj){if(!obj){m_print.error("Wrong object name");return""}return obj.origin_name};exports.get_object_name_hierarchy=function(obj){if(!obj){m_print.error("Wrong object name");
return null}var names=[];var curr_obj=obj;while(curr_obj){names.push(curr_obj.origin_name);curr_obj=m_obj_util.get_dg_parent(curr_obj)}return names.reverse()};exports.get_object_type=function(obj){if(!(obj&&obj.type)){m_print.error("Wrong object");return"UNDEFINED"}return obj.type};exports.get_object_dg_parent=function(obj){m_print.error("scenes.get_object_dg_parent() deprecated, use objects.get_dg_parent() instead");return m_obj_util.get_dg_parent(obj)};exports.get_object_children=function(obj){return obj.cons_descends.slice(0)};
exports.get_first_character=function(){var sobjs=m_obj.get_scene_objs(m_scenes.get_active(),"MESH",m_obj.DATA_ID_ALL);for(var i=0;i<sobjs.length;i++){var obj=sobjs[i];if(m_phy.is_character(obj))return obj}return null};exports.get_shore_dist=function(trans,v_dist_mult){if(!v_dist_mult&&v_dist_mult!==0)v_dist_mult=1;return m_scenes.get_shore_dist(trans,v_dist_mult)};exports.get_cam_water_depth=function(){return m_scenes.get_cam_water_depth()};exports.get_type_mesh_object=function(obj){if(m_obj_util.is_mesh(obj))return obj.render.type;
return null};exports.get_meta_tags=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();return m_scenes.get_meta_tags(active_scene)};exports.append_object=function(obj,scene_name){if(!obj.render.is_copied){m_print.error('object "'+obj.name+'" has been created not by coping.');return}if(scene_name){var scenes=m_scenes.get_all_scenes();var scene=m_util.keysearch("name",scene_name,scenes)}else var scene=m_scenes.get_active();m_scenes.append_object(scene,
obj,true)};exports.remove_object=function(obj){if(!obj.render.is_copied){m_print.error("Can't remove object \""+obj.name+'". It was not copied.');return}var scene=m_scenes.get_active();m_data.prepare_object_unloading(scene,obj,false);m_obj.remove_object(obj)};exports.marker_frame=function(name){var active_scene=m_scenes.get_active();if(active_scene["timeline_markers"]&&name in active_scene["timeline_markers"])return m_scenes.marker_frame(active_scene,name);else{m_print.error('"'+name+'" marker not found.');
return 0}};exports.get_mb_params=function(){var scene=m_scenes.get_active();var mb_subs=m_scenes.get_subs(scene,"MOTION_BLUR");if(mb_subs){var mb_params={mb_factor:mb_subs.mb_factor,mb_decay_threshold:mb_subs.mb_decay_threshold};return mb_params}else return null};exports.set_mb_params=function(mb_params){var scene=m_scenes.get_active();var mb_subs=m_scenes.get_subs(scene,"MOTION_BLUR");if(mb_subs){if(typeof mb_params.mb_decay_threshold=="number")mb_subs.mb_decay_threshold=mb_params.mb_decay_threshold;
if(typeof mb_params.mb_factor=="number")mb_subs.mb_factor=mb_params.mb_factor}else m_print.error("The motion blur subscene doesn't exist.")};exports.can_select_objects=function(){var scene=m_scenes.get_active();return Boolean(m_scenes.get_subs(scene,"COLOR_PICKING"))}};b4w.module["sfx"]=function(exports,require){var m_obj_util=require("__obj_util");var m_scs=require("__scenes");var m_sfx=require("__sfx");var m_print=require("__print");exports.play=function(obj,when,duration){m_sfx.play(obj,when,duration)};exports.play_def=function(obj){m_sfx.play_def(obj)};exports.is_play=function(obj){return m_sfx.is_play(obj)};exports.speaker_play=function(obj,cyclic,duration,playrate){m_print.error("speaker_play() deprecated, use play() or play_def() instead");m_sfx.cyclic(obj,
cyclic);if(playrate)m_sfx.playrate(obj,playrate);m_sfx.play(obj,0,duration)};exports.speaker_stop=function(obj){m_print.error("speaker_stop() deprecated, use stop() instead");m_sfx.stop(obj)};exports.stop=function(obj){m_sfx.stop(obj)};exports.pause=function(obj){m_sfx.speaker_pause(obj)};exports.resume=function(obj){m_sfx.speaker_resume(obj)};exports.speaker_playback_rate=function(obj,playrate){m_print.error("speaker_playback_rate() deprecated, use playrate() instead");m_sfx.playrate(obj,playrate)};
exports.playrate=function(obj,playrate){m_sfx.playrate(obj,playrate)};exports.get_playrate=function(obj){return m_sfx.get_playrate(obj)};exports.cyclic=function(obj,cyclic){m_sfx.cyclic(obj,cyclic)};exports.is_cyclic=function(obj){return m_sfx.is_cyclic(obj)};exports.listener_reset_speed=function(speed,dir){m_sfx.listener_reset_speed(speed,dir)};exports.speaker_reset_speed=function(obj,speed,dir){m_sfx.speaker_reset_speed(obj,speed,dir)};exports.get_volume=function(obj){if(obj&&typeof obj==="object")return m_sfx.get_volume(obj);
else return m_sfx.get_master_volume()};exports.set_volume=function(obj,volume){if(obj&&typeof obj==="object")m_sfx.set_volume(obj,volume);else m_sfx.set_master_volume(volume)};exports.mute=function(obj,muted){if(obj&&typeof obj==="object")m_sfx.mute(obj,muted);else m_sfx.mute_master(muted)};exports.is_muted=function(obj){if(obj&&typeof obj==="object")return m_sfx.is_muted(obj);else return m_sfx.is_master_muted()};exports.get_speaker_objects=function(){return m_sfx.get_speaker_objects().slice(0)};
exports.get_speakers=function(){m_print.error("get_speakers() deprecated, use get_speaker_objects() instead");return exports.get_speaker_objects()};exports.check_active_speakers=m_sfx.check_active_speakers;exports.set_compressor_params=function(params){m_sfx.set_compressor_params(m_scs.get_active(),params)};exports.get_compressor_params=function(){return m_sfx.get_compressor_params(m_scs.get_active())};exports.duck=function(obj,value,time){if(obj&&typeof obj==="object")m_sfx.duck(obj,value,time);
else m_sfx.duck_master(value,time)};exports.unduck=function(obj){if(obj&&typeof obj==="object")m_sfx.unduck(obj);else m_sfx.unduck_master()};exports.apply_playlist=m_sfx.apply_playlist;exports.clear_playlist=m_sfx.clear_playlist;exports.detect_audio_container=m_sfx.detect_audio_container;exports.detect_video_container=m_sfx.detect_video_container;exports.set_positional_params=m_sfx.set_positional_params;exports.get_positional_params=m_sfx.get_positional_params;exports.set_filter_params=m_sfx.set_filter_params;
exports.get_filter_params=m_sfx.get_filter_params;exports.get_filter_freq_response=m_sfx.get_filter_freq_response;exports.get_duration=function(obj){if(!obj||!m_obj_util.is_speaker(obj)){m_print.error('Object "'+(obj?obj.name:undefined)+'" is not a valid speaker');return}return m_sfx.get_duration(obj)}};b4w.module["textures"]=function(exports,require){var m_print=require("__print");var m_textures=require("__textures");exports.get_canvas_texture_context=function(id,data_id){if(!data_id)data_id=0;var canvas_context=m_textures.get_canvas_context(id,data_id);if(canvas_context)return canvas_context;else m_print.error('Canvas texture with ID "'+id+'" not found!')};exports.update_canvas_texture_context=function(id,data_id){if(!data_id)data_id=0;if(!m_textures.update_canvas_context(id,data_id))m_print.error('Canvas texture with ID "'+
id+'" not found!')};exports.play_video=function(texture_name,data_id){if(!data_id)data_id=0;if(!m_textures.play_video(texture_name,data_id))m_print.error('Texture with name "'+texture_name+'" not found!')};exports.pause_video=function(texture_name,data_id){if(!data_id)data_id=0;if(!m_textures.pause_video(texture_name,data_id))m_print.error('Texture with name "'+texture_name+'" not found!')};exports.reset_video=function(texture_name,data_id){if(!data_id)data_id=0;if(!m_textures.reset_video(texture_name,
data_id))m_print.error('Texture with name "'+texture_name+'" not found!')}};b4w.module["time"]=function(exports,require){var m_time=require("__time");exports.set_timeout=m_time.set_timeout;exports.clear_timeout=m_time.clear_timeout;exports.get_timeline=m_time.get_timeline;exports.animate=m_time.animate;exports.clear_animation=m_time.clear_animation};b4w.module["transform"]=function(exports,require){var m_obj_util=require("__obj_util");var m_phy=require("__physics");var m_print=require("__print");var m_quat=require("__quat");var m_trans=require("__transform");var m_util=require("__util");var _vec3_tmp=new Float32Array(3);var _quat4_tmp=new Float32Array(4);exports.SPACE_LOCAL=m_trans.SPACE_LOCAL;exports.SPACE_WORLD=m_trans.SPACE_WORLD;exports.set_translation=function(obj,x,y,z){if(m_obj_util.is_dynamic(obj)){_vec3_tmp[0]=x;_vec3_tmp[1]=y;_vec3_tmp[2]=
z;m_trans.set_translation(obj,_vec3_tmp);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.set_translation_rel=function(obj,x,y,z){if(m_obj_util.is_dynamic(obj)){_vec3_tmp[0]=x;_vec3_tmp[1]=y;_vec3_tmp[2]=z;m_trans.set_translation_rel(obj,_vec3_tmp);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.set_translation_v=function(obj,trans){if(m_obj_util.is_dynamic(obj)){m_trans.set_translation(obj,
trans);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.set_translation_rel_v=function(obj,trans){if(m_obj_util.is_dynamic(obj)){m_trans.set_translation_rel(obj,trans);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.set_translation_obj_rel=function(obj,x,y,z,obj_ref){if(m_obj_util.is_dynamic(obj)){_vec3_tmp[0]=x;_vec3_tmp[1]=y;_vec3_tmp[2]=
z;var trans=obj_ref.render.trans;var quat=obj_ref.render.quat;m_util.transform_vec3(_vec3_tmp,1,quat,trans,_vec3_tmp);m_trans.set_translation(obj,_vec3_tmp);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.get_translation=function(obj,dest){if(!dest)var dest=new Float32Array(3);m_trans.get_translation(obj,dest);return dest};exports.get_translation_rel=function(obj,dest){if(!dest)var dest=new Float32Array(3);m_trans.get_translation_rel(obj,
dest);return dest};exports.set_rotation=function(obj,x,y,z,w){if(m_obj_util.is_dynamic(obj)){_quat4_tmp[0]=x;_quat4_tmp[1]=y;_quat4_tmp[2]=z;_quat4_tmp[3]=w;m_trans.set_rotation(obj,_quat4_tmp);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.set_rotation_rel=function(obj,x,y,z,w){if(m_obj_util.is_dynamic(obj)){_quat4_tmp[0]=x;_quat4_tmp[1]=y;_quat4_tmp[2]=z;_quat4_tmp[3]=w;m_trans.set_rotation_rel(obj,_quat4_tmp);
m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.set_rotation_quat=function(){m_print.error("set_rotation_quat() deprecated, use set_rotation() instead");return exports.set_rotation};exports.set_rotation_v=function(obj,quat){if(m_obj_util.is_dynamic(obj)){m_trans.set_rotation(obj,quat);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.set_rotation_rel_v=
function(obj,quat){if(m_obj_util.is_dynamic(obj)){m_trans.set_rotation_rel(obj,quat);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.set_rotation_quat_v=function(){m_print.error("set_rotation_quat_v() deprecated, use set_rotation_v() instead");return exports.set_rotation_v};exports.get_rotation=function(obj,opt_dest){if(!opt_dest)var opt_dest=new Float32Array(4);m_trans.get_rotation(obj,opt_dest);return opt_dest};
exports.get_rotation_rel=function(obj,opt_dest){if(!opt_dest)var opt_dest=new Float32Array(4);m_trans.get_rotation_rel(obj,opt_dest);return opt_dest};exports.get_rotation_quat=function(){m_print.error("get_rotation_quat() deprecated, use get_rotation() instead");return exports.get_rotation};exports.set_rotation_euler=function(obj,x,y,z){if(m_obj_util.is_dynamic(obj)){_vec3_tmp[0]=x;_vec3_tmp[1]=y;_vec3_tmp[2]=z;m_trans.set_rotation_euler(obj,_vec3_tmp);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+
obj.name+'" is not dynamic.')};exports.set_rotation_euler_rel=function(obj,x,y,z){if(m_obj_util.is_dynamic(obj)){_vec3_tmp[0]=x;_vec3_tmp[1]=y;_vec3_tmp[2]=z;m_trans.set_rotation_euler_rel(obj,_vec3_tmp);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.set_rotation_euler_v=function(obj,euler){if(m_obj_util.is_dynamic(obj)){m_trans.set_rotation_euler(obj,euler);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+
obj.name+'" is not dynamic.')};exports.set_rotation_euler_rel_v=function(obj,euler){if(m_obj_util.is_dynamic(obj)){m_trans.set_rotation_euler_rel(obj,euler);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.set_scale=function(obj,scale){if(m_obj_util.is_dynamic(obj)){m_trans.set_scale(obj,scale);m_trans.update_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.set_scale_rel=function(obj,
scale){if(m_obj_util.is_dynamic(obj)){m_trans.set_scale_rel(obj,scale);m_trans.update_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.get_scale=function(obj){return m_trans.get_scale(obj)};exports.get_scale_rel=function(obj){return m_trans.get_scale_rel(obj)};exports.empty_reset_transform=function(obj){if(obj.type!="EMPTY"){m_print.error("Wrong object: "+obj.name);return}for(var i=0;i<obj.cons_descends.length;i++)if(!m_obj_util.is_dynamic(obj.cons_descends[i])){m_print.error('Wrong object: "'+
obj.cons_descends[i].name+'" is not dynamic.');return}m_trans.set_translation(obj,[0,0,0]);m_trans.set_rotation(obj,[0,0,0,1]);m_trans.set_scale(obj,1);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports.get_object_size=function(obj){if(!m_obj_util.is_mesh(obj)){m_print.error("Wrong object: "+obj.name);return 0}return m_trans.get_object_size(obj)};exports.get_object_center=function(obj,calc_bs_center,dest){if(!m_obj_util.is_mesh(obj)){m_print.error("Wrong object: "+obj.name);return null}return m_trans.get_object_center(obj,
calc_bs_center,dest)};exports.move_local=function(obj,dx,dy,dz){if(m_obj_util.is_dynamic(obj)){m_trans.move_local(obj,dx,dy,dz);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.rotate_x_local=function(obj,angle){if(m_obj_util.is_dynamic(obj)){var quat=m_quat.setAxisAngle(m_util.AXIS_X,angle,_quat4_tmp);m_trans.rotate_local(obj,quat);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+
obj.name+'" is not dynamic.')};exports.rotate_y_local=function(obj,angle){if(m_obj_util.is_dynamic(obj)){var quat=m_quat.setAxisAngle(m_util.AXIS_Y,angle,_quat4_tmp);m_trans.rotate_local(obj,quat);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.rotate_z_local=function(obj,angle){if(m_obj_util.is_dynamic(obj)){var quat=m_quat.setAxisAngle(m_util.AXIS_Z,angle,_quat4_tmp);m_trans.rotate_local(obj,quat);m_trans.update_transform(obj);
m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.get_object_bounding_box=function(obj){return m_trans.get_object_bounding_box(obj)};exports.set_tsr=function(obj,tsr){if(m_obj_util.is_dynamic(obj)){m_trans.set_tsr(obj,tsr);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.set_tsr_rel=function(obj,tsr){if(m_obj_util.is_dynamic(obj)){m_trans.set_tsr_rel(obj,tsr);m_trans.update_transform(obj);
m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.get_tsr=function(obj,dest){if(!dest)var dest=new Float32Array(8);m_trans.get_tsr(obj,dest);return dest};exports.get_tsr_rel=function(obj,dest){if(!dest)var dest=new Float32Array(8);m_trans.get_tsr_rel(obj,dest);return dest};exports.distance=function(obj1,obj2){return m_trans.distance(obj1,obj2)}};b4w.module["tsr"]=function(exports,require){var m_print=require("__print");var m_tsr=require("__tsr");exports.create=m_tsr.create;exports.from_values=m_tsr.from_values;exports.copy=m_tsr.copy;exports.identity=m_tsr.identity;exports.create_sep=m_tsr.create_sep;exports.set_sep=m_tsr.set_sep;exports.set_trans=m_tsr.set_trans;exports.set_scale=m_tsr.set_scale;exports.set_transcale=m_tsr.set_transcale;exports.set_quat=m_tsr.set_quat;exports.get_trans_view=m_tsr.get_trans_view;exports.get_scale=m_tsr.get_scale;
exports.get_quat_view=m_tsr.get_quat_view;exports.invert=m_tsr.invert;exports.to_mat4=function(tsr,dest){if(!dest)var dest=new Float32Array(16);m_tsr.to_mat4(tsr,dest);return dest};exports.from_mat4=m_tsr.from_mat4;exports.multiply=m_tsr.multiply;exports.transform_vec3=m_tsr.transform_vec3;exports.transform_vec3_inv=m_tsr.transform_vec3_inv;exports.transform_vectors=m_tsr.transform_vectors;exports.transform_dir_vectors=m_tsr.transform_dir_vectors;exports.transform_dir_vec3=m_tsr.transform_dir_vec3;
exports.transform_tangents=m_tsr.transform_tangents;exports.translate=m_tsr.translate;exports.interpolate=m_tsr.interpolate};b4w.module["util"]=function(exports,require){var m_obj_util=require("__obj_util");var m_print=require("__print");var m_util=require("__util");var m_vec3=require("__vec3");exports.AXIS_X=new Float32Array([1,0,0]);exports.AXIS_Y=new Float32Array([0,1,0]);exports.AXIS_Z=new Float32Array([0,0,1]);exports.AXIS_MX=new Float32Array([-1,0,0]);exports.AXIS_MY=new Float32Array([0,-1,0]);exports.AXIS_MZ=new Float32Array([0,0,-1]);exports.f32=function(param){param=param||0;return new Float32Array(param)};exports.assert=
m_util.assert;exports.keyfind=m_util.keyfind;exports.keysearch=m_util.keysearch;exports.matrix_to_quat=function(matrix){return m_util.matrix_to_quat(matrix)};exports.euler_to_quat=function(euler,quat){if(!quat)quat=new Float32Array(4);return m_util.euler_to_quat(euler,quat)};exports.quat_to_euler=function(quat,euler){if(!euler)euler=new Float32Array(3);return m_util.quat_to_euler(quat,euler)};exports.sign=m_util.sign;exports.clamp=m_util.clamp;exports.quat_to_dir=m_util.quat_to_dir;exports.ground_project_quat=
function(quat,dest){return m_util.quat_project(quat,m_util.AXIS_MY,m_util.AXIS_Y,m_util.AXIS_MZ,dest)};exports.cam_quat_to_mesh_quat=function(cam_quat,dest){return m_util.cam_quat_to_mesh_quat(cam_quat,dest)};exports.quat_project=function(quat,quat_ident_dir,plane,plane_ident_dir,dest){if(m_vec3.dot(plane,plane_ident_dir)!=0){m_print.error("Wrong in-plane direction");return null}return m_util.quat_project(quat,quat_ident_dir,plane,plane_ident_dir,dest)};exports.hash_code=m_util.hash_code;exports.smooth=
m_util.smooth;exports.smooth_v=m_util.smooth_v;exports.is_vector=m_util.is_vector;exports.correct_cam_quat_up=m_util.correct_cam_quat_up;exports.quat_to_angle_axis=m_util.quat_to_angle_axis;exports.random_from_array=m_util.random_from_array;exports.xz_direction=m_util.xz_direction;exports.line_plane_intersect=m_util.line_plane_intersect;exports.is_mesh=function(obj){m_print.error("util.is_mesh() deprecated, use objects.is_mesh() instead");return m_obj_util.is_mesh(obj)};exports.is_armature=function(obj){m_print.error("util.is_armature() deprecated, use objects.is_armature() instead");
return m_obj_util.is_armature(obj)};exports.angle_wrap_0_2pi=m_util.angle_wrap_0_2pi;exports.angle_wrap_periodic=m_util.angle_wrap_periodic;exports.smooth_step=m_util.smooth_step;exports.lerp=m_util.lerp};if(typeof module=="object"&&module.exports)GLOBAL.b4w={module:{}};b4w.module["version"]=function(exports,require){var m_print=require("__print");var m_version=require("__version");exports.version=m_version.version;exports.version_str=m_version.version_str;exports.type=m_version.type;exports.date=m_version.date;exports.date_str=m_version.date_str};if(typeof module=="object"&&module.exports)b4w.module["version"](exports);b4w.module["objects"]=function(exports,require){var m_geom=require("__geometry");var m_obj=require("__objects");var m_obj_util=require("__obj_util");var m_print=require("__print");var m_scenes=require("__scenes");var m_util=require("__util");exports.get_meta_tags=function(obj){if(obj)return m_obj.get_meta_tags(obj)};exports.copy=function(obj,name,deep_copy){if(!m_obj_util.is_mesh(obj)){m_print.error('object "'+obj.name+'" is not of type "MESH".');return false}if(!m_obj_util.is_dynamic(obj)){m_print.error('object "'+
obj.name+'" is not dynamic.');return false}if(!(m_geom.has_dyn_geom(obj)||m_geom.check_shape_keys(obj))&&deep_copy){m_print.error('object "'+obj.name+'" has not dynamic '+"geometry for deep copying.");return false}var objs=m_obj.get_scene_objs(m_scenes.get_active(),"MESH",m_obj.DATA_ID_ALL);if(objs.indexOf(obj)==-1){m_print.error('object "'+obj.name+'" does not belong to the '+"active scene.");return false}name=name||"";return m_obj.copy(obj,name,deep_copy)};exports.set_nodemat_value=function(obj,
name_list,value){if(!m_obj_util.is_mesh(obj)){m_print.error('The type of the object "'+obj.name+'" is not "MESH".');return}m_obj.set_nodemat_value(obj,name_list,value)};exports.set_nodemat_rgb=function(obj,name_list,r,g,b){if(!m_obj_util.is_mesh(obj)){m_print.error('The type of the object "'+obj.name+'" is not "MESH".');return}m_obj.set_nodemat_rgb(obj,name_list,r,g,b)};exports.update_boundings=function(obj){if(!m_obj_util.is_mesh(obj)){m_print.error('The type of the object "'+obj.name+'" is not "MESH".');
return}if(!(m_geom.has_dyn_geom(obj)||m_geom.check_shape_keys(obj))){m_print.error('object "'+obj.name+'" has not dynamic '+"geometry.");return}m_obj.update_boundings(obj)};exports.get_parent=m_obj_util.get_parent;exports.get_dg_parent=m_obj_util.get_dg_parent;exports.is_mesh=m_obj_util.is_mesh;exports.is_armature=m_obj_util.is_armature;exports.is_speaker=m_obj_util.is_speaker;exports.is_camera=m_obj_util.is_camera;exports.is_lamp=m_obj_util.is_lamp;exports.is_empty=m_obj_util.is_empty};b4w.module["main"]=function(exports,require){var m_anchors=require("__anchors");var m_anim=require("__animation");var m_assets=require("__assets");var m_cfg=require("__config");var m_compat=require("__compat");var m_cont=require("__container");var m_ctl=require("__controls");var m_data=require("__data");var m_debug=require("__debug");var m_ext=require("__extensions");var m_geom=require("__geometry");var m_hud=require("__hud");var m_nla=require("__nla");var m_lnodes=require("__logic_nodes");var m_obj=
require("__objects");var m_phy=require("__physics");var m_print=require("__print");var m_render=require("__renderer");var m_scenes=require("__scenes");var m_sfx=require("__sfx");var m_shaders=require("__shaders");var m_textures=require("__textures");var m_time=require("__time");var m_trans=require("__transform");var m_armat=require("__armature");var m_util=require("__util");var m_version=require("__version");var cfg_ctx=m_cfg.context;var cfg_def=m_cfg.defaults;var _elem_canvas_webgl=null;var _elem_canvas_hud=
null;var _last_abs_time=0;var _pause_time=0;var _resume_time=0;var _loop_cb=[];var _fps_callback=function(){};var _fps_counter=function(){};var _render_callback=function(){};var _canvas_data_url_callback=null;var CONTEXT_NAMES=["webgl","experimental-webgl"];var _gl=null;var _requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){return window.setTimeout(callback,
1E3/cfg_def.max_fps)}}();exports.init=function(elem_canvas_webgl,elem_canvas_hud){m_cfg.set_paths();m_print.set_verbose(cfg_def.console_verbose);var ver_str=m_version.version_str()+" "+m_version.type()+" ("+m_version.date_str()+")";m_print.log("%cINIT ENGINE","color: #00a",ver_str);if(!window["WebGLRenderingContext"])return null;setup_clock();_elem_canvas_webgl=elem_canvas_webgl;m_compat.apply_context_alpha_hack(gl);var gl=get_context(elem_canvas_webgl);if(!gl)return null;_gl=gl;init_context(_elem_canvas_webgl,
gl);m_cfg.apply_quality();m_compat.set_hardware_defaults(gl);m_shaders.load_shaders();if(cfg_def.ie11_edge_touchscreen_hack)elem_canvas_webgl.style["touch-action"]="none";m_print.log("%cSET PRECISION:","color: #00a",cfg_def.precision);if(elem_canvas_hud){m_hud.init(elem_canvas_hud);_elem_canvas_hud=elem_canvas_hud}else{m_cfg.defaults.show_hud_debug_info=false;m_cfg.sfx.mix_mode=false}return gl};function setup_clock(){if(!window.performance){m_print.log("Apply performance workaround");window.performance=
{}}var curr_time=Date.now();if(!window.performance.now){m_print.log("Apply performance.now() workaround");window.performance.now=function(){return Date.now()-curr_time}}m_time.set_timeline(0)}function get_context(canvas){var ctx=null;for(var i=0;i<CONTEXT_NAMES.length;i++){var name=CONTEXT_NAMES[i];try{ctx=canvas.getContext(name,cfg_ctx)}catch(e){}if(ctx)break}if(ctx)m_compat.detect_tegra_invalid_enum_issue(ctx);return ctx}function init_context(canvas,gl){canvas.addEventListener("webglcontextlost",
function(event){event.preventDefault();m_print.error("WebGL context lost");pause()},false);m_ext.setup_context(gl);var rinfo=m_ext.get_renderer_info();if(rinfo)m_print.log("%cRENDERER INFO:","color: #00a",gl.getParameter(rinfo.UNMASKED_VENDOR_WEBGL)+", "+gl.getParameter(rinfo.UNMASKED_RENDERER_WEBGL));m_render.setup_context(gl);m_geom.setup_context(gl);m_textures.setup_context(gl);m_shaders.setup_context(gl);m_debug.setup_context(gl);m_data.setup_canvas(canvas);m_cont.init(canvas);m_scenes.setup_dim(canvas.width,
canvas.height,1);m_sfx.init();_fps_counter=init_fps_counter();loop()}exports.set_check_gl_errors=function(val){m_debug.set_check_gl_errors(val)};exports.resize=function(width,height,update_canvas_css){if(update_canvas_css!==false){_elem_canvas_webgl.style.width=width+"px";_elem_canvas_webgl.style.height=height+"px";if(_elem_canvas_hud){_elem_canvas_hud.style.width=width+"px";_elem_canvas_hud.style.height=height+"px"}}if(_elem_canvas_hud){_elem_canvas_hud.width=width;_elem_canvas_hud.height=height;
m_hud.update_dim()}if(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i))cfg_def.canvas_resolution_factor=1;var cw=Math.floor(width*cfg_def.canvas_resolution_factor);var ch=Math.floor(height*cfg_def.canvas_resolution_factor);if(cfg_def.allow_hidpi&&window.devicePixelRatio>1){cw*=window.devicePixelRatio;ch*=window.devicePixelRatio}_elem_canvas_webgl.width=cw;_elem_canvas_webgl.height=ch;if(cw>_gl.drawingBufferWidth||ch>_gl.drawingBufferHeight){m_print.warn("Canvas size exceeds platform limits, downscaling");
var downscale=Math.min(_gl.drawingBufferWidth/cw,_gl.drawingBufferHeight/ch);cw*=downscale;ch*=downscale;_elem_canvas_webgl.width=cw;_elem_canvas_webgl.height=ch}m_scenes.setup_dim(cw,ch,cw/width);if(m_scenes.check_active())m_trans.update_transform(m_scenes.get_active()._camera);frame(m_time.get_timeline(),0);m_data.update_media_controls(_elem_canvas_webgl.width,_elem_canvas_webgl.height)};exports.set_fps_callback=function(fps_cb){_fps_callback=fps_cb};exports.clear_fps_callback=function(){_fps_callback=
function(){}};exports.set_render_callback=function(callback){set_render_callback(callback)};function set_render_callback(callback){_render_callback=callback}exports.clear_render_callback=function(){clear_render_callback()};function clear_render_callback(){_render_callback=function(){}}exports.global_timeline=function(){return m_time.get_timeline()};exports.redraw=function(){m_print.error("redraw() deprecated");frame(m_time.get_timeline(),0)};exports.pause=pause;function pause(){if(is_paused())return;
_pause_time=performance.now()/1E3;m_sfx.pause();m_phy.pause();m_textures.pause();m_anchors.pause()}exports.resume=function(){if(!is_paused())return;_resume_time=performance.now()/1E3;m_sfx.resume();m_phy.resume();m_textures.play(true);m_anchors.resume()};exports.is_paused=is_paused;function is_paused(){return _resume_time<_pause_time}function loop(){_requestAnimFrame(loop);var abstime=performance.now()/1E3;if(!_last_abs_time)_last_abs_time=abstime;var delta=abstime-_last_abs_time;if(delta<1/cfg_def.max_fps)return;
var timeline=m_time.get_timeline();for(var i=0;i<_loop_cb.length;i++)_loop_cb[i](timeline,delta);if(!is_paused()){if(_resume_time>_last_abs_time)delta-=_resume_time-Math.max(_pause_time,_last_abs_time);timeline+=delta;m_time.set_timeline(timeline);m_debug.update();m_assets.update();m_data.update();frame(timeline,delta);_fps_counter(delta)}_last_abs_time=abstime}function frame(timeline,delta){if(!m_data.is_primary_loaded())return;m_hud.reset();m_trans.update(delta);m_lnodes.update(timeline,delta);
m_nla.update(timeline,delta);m_sfx.update(timeline,delta);if(delta)m_anim.update(delta);if(!m_data.is_primary_loaded())return;m_phy.update(timeline,delta);if(!m_data.is_primary_loaded())return;_render_callback(delta,timeline);if(!m_data.is_primary_loaded())return;m_ctl.update(timeline,delta);if(!m_data.is_primary_loaded())return;m_anchors.update();m_obj.update(timeline,delta);m_scenes.update(timeline,delta);m_anchors.update_visibility();if(_canvas_data_url_callback){_canvas_data_url_callback(_elem_canvas_webgl.toDataURL());
_canvas_data_url_callback=null}}function init_fps_counter(){var fps_avg=60;var fps_frame_counter=0;var interval=cfg_def.fps_measurement_interval;var interval_cb=cfg_def.fps_callback_interval;var fps_counter=function(delta){if(delta<1/cfg_def.max_fps)return;fps_avg=m_util.smooth(1/delta,fps_avg,delta,interval);var phy_fps_avg=m_phy.get_fps();fps_frame_counter=(fps_frame_counter+1)%interval_cb;if(fps_frame_counter==0)_fps_callback(Math.round(fps_avg),phy_fps_avg)};return fps_counter}exports.reset=function(){m_data.unload(0);
_elem_canvas_webgl=null;_elem_canvas_hud=null;_last_abs_time=0;_pause_time=0;_resume_time=0;_fps_callback=function(){};_fps_counter=function(){};_render_callback=function(){};_loop_cb.length=0;_gl=null;m_time.reset()};exports.canvas_data_url=function(callback){_canvas_data_url_callback=callback};exports.get_canvas_elem=function(){return _elem_canvas_webgl};exports.detect_mobile=function(){return m_compat.detect_mobile()};exports.append_loop_cb=function(callback){for(var i=0;i<_loop_cb.length;i++)if(_loop_cb[i]==
callback)return;_loop_cb.push(callback)};exports.remove_loop_cb=function(callback){for(var i=0;i<_loop_cb.length;i++)if(_loop_cb[i]==callback){_loop_cb.splice(i,1);break}}};b4w.module["nla"]=function(exports,require){var m_nla=require("__nla");var m_time=require("__time");var m_print=require("__print");var m_util=require("__util");exports.set_frame=function(frame){frame=m_util.clamp(frame,m_nla.get_frame_start(),m_nla.get_frame_end());if(m_nla.check_logic_nodes()){m_print.error("The active scene is using NLA script.");return}m_nla.set_frame(frame,m_time.get_timeline())};exports.get_frame=function(){return m_nla.get_frame(m_time.get_timeline())};exports.stop=function(){if(m_nla.check_logic_nodes()){m_print.error("The active scene is using NLA script.");
return}m_nla.stop_nla()};exports.play=function(callback){if(m_nla.check_logic_nodes()){m_print.error("The active scene is using NLA script.");return}m_nla.play_nla(callback)};exports.is_play=function(){return m_nla.is_play()};exports.get_frame_start=function(){return m_nla.get_frame_start()};exports.get_frame_end=function(){return m_nla.get_frame_end()};exports.check_nla=function(){return m_nla.check_nla()};exports.check_nla_scripts=function(){return m_nla.check_logic_nodes()};exports.check_logic_nodes=
function(){return m_nla.check_logic_nodes()};exports.set_range=function(start_frame,end_frame){if(m_nla.check_logic_nodes()){m_print.error("The active scene is using NLA script.");return}end_frame=parseFloat(end_frame)||m_nla.get_frame_end();start_frame=parseFloat(start_frame)||m_nla.get_frame_end();end_frame=m_util.clamp(end_frame,m_nla.get_frame_start(),m_nla.get_frame_end());start_frame=m_util.clamp(start_frame,m_nla.get_frame_start(),end_frame);m_nla.set_range(start_frame,end_frame)};exports.reset_range=
function(){if(m_nla.check_logic_nodes()){m_print.error("The active scene is using NLA script.");return}m_nla.reset_range()};exports.set_cyclic=function(is_cyclic){if(m_nla.check_logic_nodes()){m_print.error("The active scene is using NLA script.");return}m_nla.set_cyclic(is_cyclic)};exports.clear_callback=function(){if(m_nla.check_logic_nodes()){m_print.error("The active scene is using NLA script.");return}m_nla.clear_callback()}};b4w.module["app"]=function(exports,require){var m_anim=require("animation");var m_cam=require("camera");var m_cfg=require("config");var m_cons=require("constraints");var m_cont=require("container");var m_ctl=require("controls");var m_data=require("data");var m_dbg=require("debug");var m_main=require("main");var m_phy=require("physics");var m_print=require("print");var m_scs=require("scenes");var m_trans=require("transform");var m_util=require("util");var m_vec3=require("vec3");var TARGET_KEY_ZOOM_POW1=
1;var TARGET_KEY_ZOOM_POW2=.15;var TARGET_TOUCH_ZOOM_FACTOR=.03;var EYE_KEY_TRANS_FACTOR=5;var EYE_ROTATION_DECREMENT=.5;var TARGET_EYE_MOUSE_ROT_MULT_PX=.003;var TARGET_EYE_MOUSE_PAN_MULT_PX=7.5E-4;var TARGET_EYE_TOUCH_ROT_MULT_PX=.003;var TARGET_EYE_TOUCH_PAN_MULT_PX=7.5E-4;var TARGET_EYE_KEY_ROT_FACTOR=2;var HOVER_MOUSE_PAN_MULT_PX=.003;var HOVER_MOUSE_ROT_MULT_PX=7.5E-4;var HOVER_TOUCH_PAN_MULT_PX=.003;var HOVER_TOUCH_ROT_MULT_PX=.003;var HOVER_KEY_TRANS_FACTOR=.5;var HOVER_KEY_ZOOM_FACTOR=30;
var HOVER_MOUSE_TOUCH_TRANS_FACTOR=.2;var HOVER_MOUSE_ZOOM_FACTOR=2;var HOVER_TOUCH_ZOOM_FACTOR=2;var HOVER_ANGLE_MIN=2;var HOVER_SPEED_MIN=1;var HOVER_STATIC_MOVE_FACTOR=10;var _smooth_factor=1;var CAM_SMOOTH_ZOOM_MOUSE=.1;var CAM_SMOOTH_ZOOM_TOUCH=.15;var CAM_SMOOTH_ROT_TRANS_MOUSE=.08;var CAM_SMOOTH_ROT_TRANS_TOUCH=.12;var COLL_RESPONSE_NORMAL_FACTOR=.01;var CHAR_HEAD_POSITION=.5;var EPSILON_DISTANCE=.001;var EPSILON_DELTA=1E-5;var _fps_logger_elem=null;var _camera_controls_is_used=false;var _disable_default_pivot=
false;var _disable_letter_controls=false;var _disable_zoom=false;var _vec2_tmp=new Float32Array(2);var _vec2_tmp2=new Float32Array(2);var _vec3_tmp=new Float32Array(3);var _vec3_tmp2=new Float32Array(3);var _vec3_tmp3=new Float32Array(3);var _quat4_tmp=new Float32Array(4);var _vec3_tmp4=new Float32Array(3);exports.init=function(options){options=options||{};var autoresize=false;var canvas_container_id=null;var callback=function(){};var error_purge_elements=null;var fps_elem_id=null;var force_container_ratio=
0;var fps_wrapper_id=null;var gl_debug=false;var key_pause_enabled=true;var pause_invisible=true;var report_init_failure=true;var sfx_mix_mode=false;var show_fps=false;var show_hud_debug_info=false;var track_container_position=false;for(var opt in options)switch(opt){case "canvas_container_id":canvas_container_id=options.canvas_container_id;break;case "callback":callback=options.callback;break;case "autoresize":autoresize=options.autoresize;break;case "do_not_use_onload":break;case "gl_debug":gl_debug=
options.gl_debug;break;case "show_hud_debug_info":show_hud_debug_info=options.show_hud_debug_info;break;case "sfx_mix_mode":sfx_mix_mode=options.sfx_mix_mode;break;case "show_fps":show_fps=options.show_fps;break;case "track_container_position":track_container_position=options.track_container_position;break;case "fps_wrapper_id":fps_wrapper_id=options.fps_wrapper_id;break;case "fps_elem_id":fps_elem_id=options.fps_elem_id;break;case "error_purge_elements":error_purge_elements=options.error_purge_elements;
break;case "report_init_failure":report_init_failure=options.report_init_failure;break;case "pause_invisible":pause_invisible=options.pause_invisible;break;case "key_pause_enabled":key_pause_enabled=options.key_pause_enabled;break;case "force_container_ratio":force_container_ratio=options.force_container_ratio;break;default:m_cfg.set(opt,options[opt]);break}var on_key_pause=function(e){if(e.keyCode==m_ctl.KEY_P)if(m_main.is_paused())m_main.resume();else m_main.pause()};if(key_pause_enabled)document.addEventListener("keydown",
on_key_pause,false);m_cfg.set("show_hud_debug_info",show_hud_debug_info);m_cfg.set("sfx_mix_mode",sfx_mix_mode);var init_hud_canvas=show_hud_debug_info||sfx_mix_mode||null;var onload_cb=function(){var init_ok=setup_canvas(canvas_container_id,init_hud_canvas,report_init_failure,error_purge_elements);var canvas_elem=m_cont.get_canvas();if(!init_ok){callback(canvas_elem,false);return}var canvas_container_elem=m_cont.get_container();resize_to_container();m_main.set_check_gl_errors(gl_debug);if(show_fps){create_fps_logger_elem(fps_elem_id,
fps_wrapper_id);m_main.set_fps_callback(fps_callback)}if(pause_invisible)handle_page_visibility();if(force_container_ratio)m_main.append_loop_cb(function(){canvas_container_elem.style.height=canvas_container_elem.clientWidth/force_container_ratio+"px"});if(autoresize)m_main.append_loop_cb(function(){var ccw=canvas_container_elem.clientWidth;var cch=canvas_container_elem.clientHeight;if(ccw!=canvas_elem.clientWidth||cch!=canvas_elem.clientHeight)m_main.resize(ccw,cch,true)});if(track_container_position)m_main.append_loop_cb(function(){m_cont.force_offsets_updating()});
callback(canvas_elem,true)};var onunload_cb=function(){m_data.cleanup()};if(document.readyState=="complete")window.setTimeout(onload_cb,0);else window.addEventListener("load",onload_cb,false);window.addEventListener("unload",onunload_cb,false)};function handle_page_visibility(){var was_paused=m_main.is_paused();var visibility_change=function(){if(document.hidden){was_paused=m_main.is_paused();m_main.pause()}else if(!was_paused)m_main.resume()};document.addEventListener("visibilitychange",visibility_change,
false)}function setup_canvas(canvas_container_id,init_hud_canvas,report_init_failure,purge_elements){var canvas_elem=document.createElement("canvas");var append_to=document.getElementById(canvas_container_id);canvas_elem.style.position="absolute";canvas_elem.style.left=0;canvas_elem.style.top=0;canvas_elem.style.width=append_to.offsetWidth+"px";canvas_elem.style.height=append_to.offsetHeight+"px";canvas_elem.width=append_to.offsetWidth*window.devicePixelRatio;canvas_elem.height=append_to.offsetHeight*
window.devicePixelRatio;if(init_hud_canvas){var canvas_elem_hud=document.createElement("canvas");canvas_elem_hud.style.position="absolute";canvas_elem.style.left=0;canvas_elem.style.top=0;canvas_elem_hud.style.pointerEvents="none"}else var canvas_elem_hud=null;if(!append_to){m_print.error('Warning: canvas container "'+canvas_container_id+'" not found, appending to body');append_to=document.body}append_to.appendChild(canvas_elem);if(!m_main.init(canvas_elem,canvas_elem_hud)){if(report_init_failure)report_app_error("Browser could not initialize WebGL",
"For more info visit","https://www.blend4web.com/troubleshooting",purge_elements);return false}if(canvas_elem_hud)m_cont.insert_to_container(canvas_elem_hud,"LAST");return true}function create_fps_logger_elem(fps_elem_id,fps_wrapper_id){if(fps_elem_id){if(fps_wrapper_id)document.getElementById(fps_wrapper_id).style.display="block";_fps_logger_elem=document.getElementById(fps_elem_id)}else{_fps_logger_elem=document.createElement("div");_fps_logger_elem.innerHTML=0;_fps_logger_elem.style.cssText="position:absolute;"+
"top: 23px;"+"right: 20px;"+"font-size: 45px;"+"line-height: 50px;"+"font-weight: bold;"+"color: #000;";m_cont.insert_to_container(_fps_logger_elem,"JUST_AFTER_CANVAS")}}function fps_callback(fps,phy_fps){var fps_str=String(fps);if(phy_fps)fps_str+="/"+String(phy_fps);_fps_logger_elem.innerHTML=fps_str}function elem_cloned(elem_id){var target=document.getElementById(elem_id);var new_element=target.cloneNode(true);target.parentNode.replaceChild(new_element,target);return new_element}exports.resize_to_container=
resize_to_container;function resize_to_container(){var canvas_container_elem=m_cont.get_container();var w=canvas_container_elem.clientWidth;var h=canvas_container_elem.clientHeight;m_main.resize(w,h,true)}exports.set_onclick=function(elem_id,callback){var elem=elem_cloned(elem_id);elem.addEventListener("mouseup",function(e){callback(elem.value)},false)};exports.set_onchange=function(elem_id,callback){var elem=elem_cloned(elem_id);elem.addEventListener("change",function(e){var checked=elem.checked;
var rslt=checked!=undefined?checked:elem.value;callback(rslt)},false)};exports.set_onkeypress=function(elem_id,callback){var elem=elem_cloned(elem_id);elem.addEventListener("keypress",function(e){callback(e.keyCode,elem.value)},false)};function trans_hover_cam_horiz_local(camobj,dir,fact){if(m_cam.has_distance_limits(camobj)){var obj_trans=m_trans.get_translation(camobj,_vec3_tmp);var hover_pivot=m_cam.get_hover_cam_pivot(camobj,_vec3_tmp2);var dir_vector=m_vec3.subtract(obj_trans,hover_pivot,_vec3_tmp);
var dist=Math.max(m_vec3.len(dir_vector),HOVER_SPEED_MIN)}else var dist=HOVER_STATIC_MOVE_FACTOR;var obj_quat=m_trans.get_rotation(camobj,_quat4_tmp);var abs_dir=m_util.quat_to_dir(obj_quat,dir,_vec3_tmp);abs_dir[1]=0;m_vec3.normalize(abs_dir,abs_dir);m_vec3.scale(abs_dir,dist*fact,abs_dir);var obj_trans=m_trans.get_translation(camobj,_vec3_tmp2);m_vec3.add(obj_trans,abs_dir,obj_trans);m_cam.hover_cam_set_translation(camobj,obj_trans)}function trans_hover_cam_updown(camobj,fact){if(!m_cam.has_distance_limits(camobj)){var obj_trans=
m_trans.get_translation(camobj,_vec3_tmp);var trans_delta=m_vec3.scale(m_util.AXIS_Y,-fact,_vec3_tmp2);m_vec3.add(obj_trans,trans_delta,obj_trans);m_cam.hover_cam_set_translation(camobj,obj_trans)}else{var limits=m_cam.get_hover_angle_limits(camobj,_vec2_tmp);if(limits[1]-limits[0]<0){var y_angle=m_cam.get_camera_angles(camobj,_vec2_tmp2)[1];var angle_factor=(limits[0]-y_angle)/(limits[0]-limits[1]);var dist_limits=m_cam.get_cam_dist_limits(camobj);angle_factor=Math.max(angle_factor,HOVER_ANGLE_MIN/
dist_limits[0]);m_cam.rotate_hover_camera(camobj,0,angle_factor*fact)}}}function trans_eye_cam_local(camobj,fact_x,fact_y,fact_z){fact_x*=EYE_KEY_TRANS_FACTOR;fact_y*=EYE_KEY_TRANS_FACTOR;fact_z*=EYE_KEY_TRANS_FACTOR;m_trans.move_local(camobj,fact_x,fact_y,fact_z)}function calc_fact_from(fact_to){return fact_to/(1-fact_to)}function trans_targ_cam_local(camobj,fact_view,elapsed){var obj_trans=m_trans.get_translation(camobj,_vec3_tmp);var pivot=m_cam.get_pivot(camobj,_vec3_tmp2);var dist=m_vec3.dist(obj_trans,
pivot);var abs_fact_view=Math.abs(fact_view);var fact=Math.pow(abs_fact_view*elapsed,TARGET_KEY_ZOOM_POW1-Math.pow(abs_fact_view*elapsed,TARGET_KEY_ZOOM_POW2));if(fact_view<0)if(dist>EPSILON_DISTANCE)fact_view=-dist*fact;else fact_view=0;else fact_view=dist*calc_fact_from(fact);m_trans.move_local(camobj,0,fact_view,0)}function get_dest_mouse_touch(obj,value,fact,dist,dest_value){var t_mult=dist*fact;for(var i=value;i>0;--i){dist+=t_mult;dest_value+=t_mult;t_mult=dist*fact}return dest_value}function get_dest_zoom(obj,
value,velocity_zoom,dest_value,dev_fact,use_pivot){if(use_pivot){var cam_pivot=m_cam.get_pivot(obj,_vec3_tmp);var cam_eye=m_cam.get_eye(obj);var dist=m_vec3.dist(cam_pivot,cam_eye)+dest_value;if(value>0)dest_value=get_dest_mouse_touch(obj,value,-velocity_zoom,dist,dest_value);else dest_value=get_dest_mouse_touch(obj,-value,calc_fact_from(velocity_zoom),dist,dest_value)}else dest_value-=value*dev_fact*velocity_zoom;return dest_value}exports.enable_camera_controls=enable_camera_controls;function enable_camera_controls(disable_default_pivot,
disable_letter_controls,disable_zoom){_camera_controls_is_used=true;_disable_default_pivot=disable_default_pivot;_disable_letter_controls=disable_letter_controls;_disable_zoom=disable_zoom;var obj=m_scs.get_active_camera();var use_pivot=false;var character=null;var use_hover=false;switch(m_cam.get_move_style(obj)){case m_cam.MS_TARGET_CONTROLS:var use_pivot=!disable_default_pivot;break;case m_cam.MS_EYE_CONTROLS:var character=m_scs.get_first_character();break;case m_cam.MS_STATIC:return;case m_cam.MS_HOVER_CONTROLS:var use_hover=
true;break}var velocity=m_cam.get_velocity_params(obj,_vec3_tmp4);var elapsed=m_ctl.create_elapsed_sensor();if(m_phy.has_simulated_physics(obj)){var collision=m_ctl.create_collision_sensor(obj,null,true);var collision_cb=function(obj,id,pulse){if(pulse==1){var coll_dist=m_ctl.get_sensor_payload(obj,id,0).coll_dist;if(coll_dist<0){var coll_norm=m_ctl.get_sensor_payload(obj,id,0).coll_norm;var recover_offset=_vec3_tmp;m_vec3.scale(coll_norm,-.25*coll_dist,recover_offset);var trans=m_trans.get_translation(obj,
_vec3_tmp2);m_vec3.add(trans,recover_offset,trans);m_trans.set_translation_v(obj,trans)}}};m_ctl.create_sensor_manifold(obj,"CAMERA_COLLISION",m_ctl.CT_CONTINUOUS,[collision],null,collision_cb)}if(character){var trans=m_trans.get_translation(obj);var quat=m_trans.get_rotation(obj);var char_quat=m_util.cam_quat_to_mesh_quat(quat);trans[1]-=CHAR_HEAD_POSITION;m_phy.set_transform(character,trans,char_quat);m_cons.append_stiff_trans(obj,character,[0,.5,0]);var char_dir=new Float32Array(2);var is_fly=
true;m_phy.set_character_move_type(character,m_phy.CM_FLY);var move_type_cb=function(){is_fly=!is_fly;m_phy.set_character_move_type(character,is_fly?m_phy.CM_FLY:m_phy.CM_WALK)};m_ctl.create_kb_sensor_manifold(obj,"TOGGLE_CHAR_MOVE_TYPE",m_ctl.CT_SHOT,m_ctl.KEY_C,move_type_cb)}var key_cb=function(obj,id,pulse){if(pulse==1){var elapsed=m_ctl.get_sensor_value(obj,id,0);m_cam.get_velocity_params(obj,velocity);switch(id){case "FORWARD":if(character)char_dir[0]=1;else if(use_hover){var hover_angle=m_cam.get_camera_angles(obj,
_vec2_tmp2)[1];var axis=Math.abs(hover_angle)>=Math.PI/4?m_util.AXIS_MZ:m_util.AXIS_MY;trans_hover_cam_horiz_local(obj,axis,velocity[0]*HOVER_KEY_TRANS_FACTOR*elapsed)}else if(use_pivot)trans_targ_cam_local(obj,-velocity[2],elapsed);else trans_eye_cam_local(obj,0,-velocity[0]*elapsed,0);break;case "BACKWARD":if(character)char_dir[0]=-1;else if(use_hover){var hover_angle=m_cam.get_camera_angles(obj,_vec2_tmp2)[1];var axis=Math.abs(hover_angle)>=Math.PI/4?m_util.AXIS_Z:m_util.AXIS_Y;trans_hover_cam_horiz_local(obj,
axis,velocity[0]*HOVER_KEY_TRANS_FACTOR*elapsed)}else if(use_pivot)trans_targ_cam_local(obj,velocity[2],elapsed);else trans_eye_cam_local(obj,0,velocity[0]*elapsed,0);break;case "UP":if(use_hover)trans_hover_cam_updown(obj,-velocity[2]*HOVER_KEY_ZOOM_FACTOR*elapsed);else if(!character)trans_eye_cam_local(obj,0,0,-velocity[0]*elapsed);break;case "DOWN":if(use_hover)trans_hover_cam_updown(obj,velocity[2]*HOVER_KEY_ZOOM_FACTOR*elapsed);else if(!character)trans_eye_cam_local(obj,0,0,velocity[0]*elapsed);
break;case "LEFT":if(character)char_dir[1]=1;else if(use_hover)trans_hover_cam_horiz_local(obj,m_util.AXIS_MX,velocity[0]*HOVER_KEY_TRANS_FACTOR*elapsed);else trans_eye_cam_local(obj,-velocity[0]*elapsed,0,0);break;case "RIGHT":if(character)char_dir[1]=-1;else if(use_hover)trans_hover_cam_horiz_local(obj,m_util.AXIS_X,velocity[0]*HOVER_KEY_TRANS_FACTOR*elapsed);else trans_eye_cam_local(obj,velocity[0]*elapsed,0,0);break;case "ROT_LEFT":if(use_pivot)m_cam.rotate_target_camera(obj,-velocity[1]*TARGET_EYE_KEY_ROT_FACTOR*
elapsed,0);else m_cam.rotate_eye_camera(obj,velocity[1]*TARGET_EYE_KEY_ROT_FACTOR*elapsed,0);break;case "ROT_RIGHT":if(use_pivot)m_cam.rotate_target_camera(obj,velocity[1]*TARGET_EYE_KEY_ROT_FACTOR*elapsed,0);else m_cam.rotate_eye_camera(obj,-velocity[1]*TARGET_EYE_KEY_ROT_FACTOR*elapsed,0);break;case "ROT_UP":if(use_pivot)m_cam.rotate_target_camera(obj,0,-velocity[1]*TARGET_EYE_KEY_ROT_FACTOR*elapsed);else m_cam.rotate_eye_camera(obj,0,velocity[1]*TARGET_EYE_KEY_ROT_FACTOR*elapsed);break;case "ROT_DOWN":if(use_pivot)m_cam.rotate_target_camera(obj,
0,velocity[1]*TARGET_EYE_KEY_ROT_FACTOR*elapsed);else m_cam.rotate_eye_camera(obj,0,-velocity[1]*TARGET_EYE_KEY_ROT_FACTOR*elapsed);break;default:break}}else switch(id){case "FORWARD":case "BACKWARD":if(character)char_dir[0]=0;break;case "LEFT":case "RIGHT":if(character)char_dir[1]=0;break}if(character){m_phy.set_character_move_dir(character,char_dir[0],char_dir[1]);var angles=m_cam.get_camera_angles_char(obj,_vec2_tmp);m_phy.set_character_rotation(character,angles[0],angles[1])}};if(!disable_letter_controls){var key_w=
m_ctl.create_keyboard_sensor(m_ctl.KEY_W);var key_s=m_ctl.create_keyboard_sensor(m_ctl.KEY_S);var key_a=m_ctl.create_keyboard_sensor(m_ctl.KEY_A);var key_d=m_ctl.create_keyboard_sensor(m_ctl.KEY_D);var key_r=m_ctl.create_keyboard_sensor(m_ctl.KEY_R);var key_f=m_ctl.create_keyboard_sensor(m_ctl.KEY_F)}else var key_w=key_s=key_a=key_d=key_r=key_f=m_ctl.create_custom_sensor(0);var key_up=m_ctl.create_keyboard_sensor(m_ctl.KEY_UP);var key_down=m_ctl.create_keyboard_sensor(m_ctl.KEY_DOWN);var key_left=
m_ctl.create_keyboard_sensor(m_ctl.KEY_LEFT);var key_right=m_ctl.create_keyboard_sensor(m_ctl.KEY_RIGHT);var key_single_logic=null;var key_double_logic=function(s){return s[0]&&(s[1]||s[2])};if(!use_hover){m_ctl.create_sensor_manifold(obj,"FORWARD",m_ctl.CT_CONTINUOUS,[elapsed,key_w],key_single_logic,key_cb);m_ctl.create_sensor_manifold(obj,"BACKWARD",m_ctl.CT_CONTINUOUS,[elapsed,key_s],key_single_logic,key_cb)}if(use_pivot){m_ctl.create_sensor_manifold(obj,"ROT_UP",m_ctl.CT_CONTINUOUS,[elapsed,key_up,
key_r],key_double_logic,key_cb);m_ctl.create_sensor_manifold(obj,"ROT_DOWN",m_ctl.CT_CONTINUOUS,[elapsed,key_down,key_f],key_double_logic,key_cb);m_ctl.create_sensor_manifold(obj,"ROT_LEFT",m_ctl.CT_CONTINUOUS,[elapsed,key_left,key_a],key_double_logic,key_cb);m_ctl.create_sensor_manifold(obj,"ROT_RIGHT",m_ctl.CT_CONTINUOUS,[elapsed,key_right,key_d],key_double_logic,key_cb)}else if(use_hover){m_ctl.create_sensor_manifold(obj,"LEFT",m_ctl.CT_CONTINUOUS,[elapsed,key_left,key_a],key_double_logic,key_cb);
m_ctl.create_sensor_manifold(obj,"RIGHT",m_ctl.CT_CONTINUOUS,[elapsed,key_right,key_d],key_double_logic,key_cb);m_ctl.create_sensor_manifold(obj,"FORWARD",m_ctl.CT_CONTINUOUS,[elapsed,key_up,key_w],key_double_logic,key_cb);m_ctl.create_sensor_manifold(obj,"BACKWARD",m_ctl.CT_CONTINUOUS,[elapsed,key_down,key_s],key_double_logic,key_cb);m_ctl.create_sensor_manifold(obj,"UP",m_ctl.CT_CONTINUOUS,[elapsed,key_f],key_double_logic,key_cb);m_ctl.create_sensor_manifold(obj,"DOWN",m_ctl.CT_CONTINUOUS,[elapsed,
key_r],key_double_logic,key_cb)}else{m_ctl.create_sensor_manifold(obj,"UP",m_ctl.CT_CONTINUOUS,[elapsed,key_r],key_double_logic,key_cb);m_ctl.create_sensor_manifold(obj,"DOWN",m_ctl.CT_CONTINUOUS,[elapsed,key_f],key_double_logic,key_cb);m_ctl.create_sensor_manifold(obj,"LEFT",m_ctl.CT_CONTINUOUS,[elapsed,key_a],key_double_logic,key_cb);m_ctl.create_sensor_manifold(obj,"RIGHT",m_ctl.CT_CONTINUOUS,[elapsed,key_d],key_double_logic,key_cb);m_ctl.create_sensor_manifold(obj,"ROT_UP",m_ctl.CT_CONTINUOUS,
[elapsed,key_up],key_double_logic,key_cb);m_ctl.create_sensor_manifold(obj,"ROT_DOWN",m_ctl.CT_CONTINUOUS,[elapsed,key_down],key_double_logic,key_cb);m_ctl.create_sensor_manifold(obj,"ROT_LEFT",m_ctl.CT_CONTINUOUS,[elapsed,key_left],key_double_logic,key_cb);m_ctl.create_sensor_manifold(obj,"ROT_RIGHT",m_ctl.CT_CONTINUOUS,[elapsed,key_right],key_double_logic,key_cb)}if(!disable_zoom){var dest_zoom_mouse=0;var mouse_wheel=m_ctl.create_mouse_wheel_sensor();var dest_zoom_touch=0;var touch_zoom=m_ctl.create_touch_zoom_sensor();
var mouse_wheel_cb=function(obj,id,pulse){if(pulse==1){var value=m_ctl.get_sensor_value(obj,id,0);m_cam.get_velocity_params(obj,velocity);if(use_pivot||use_hover)dest_zoom_mouse=get_dest_zoom(obj,value,velocity[2],dest_zoom_mouse,HOVER_MOUSE_ZOOM_FACTOR,use_pivot);else{var factor=value*velocity[2];velocity[0]*=1+factor;m_cam.set_velocity_params(obj,velocity)}}};m_ctl.create_sensor_manifold(obj,"MOUSE_WHEEL",m_ctl.CT_LEVEL,[mouse_wheel],null,mouse_wheel_cb);var touch_zoom_cb=function(obj,id,pulse,
param){if(pulse==1){var value=m_ctl.get_sensor_value(obj,id,0);m_cam.get_velocity_params(obj,velocity);if(m_ctl.get_sensor_payload(obj,id,0)===m_ctl.PL_MULTITOUCH_MOVE_ZOOM)dest_zoom_touch=get_dest_zoom(obj,value,velocity[2]*TARGET_TOUCH_ZOOM_FACTOR,dest_zoom_touch,HOVER_TOUCH_ZOOM_FACTOR,use_pivot)}};m_ctl.create_sensor_manifold(obj,"TOUCH_ZOOM",m_ctl.CT_LEVEL,[touch_zoom],null,touch_zoom_cb);var zoom_interp_cb=function(obj,id,pulse){if(pulse==1&&(use_pivot||use_hover))if(Math.abs(dest_zoom_mouse)>
EPSILON_DELTA||Math.abs(dest_zoom_touch)>EPSILON_DELTA){var value=m_ctl.get_sensor_value(obj,id,0);var zoom_mouse=m_util.smooth(dest_zoom_mouse,0,value,smooth_coeff_zoom_mouse());dest_zoom_mouse-=zoom_mouse;var zoom_touch=m_util.smooth(dest_zoom_touch,0,value,smooth_coeff_zoom_touch());dest_zoom_touch-=zoom_touch;if(use_hover)trans_hover_cam_updown(obj,-(zoom_mouse+zoom_touch));else{var cam_pivot=m_cam.get_pivot(obj,_vec3_tmp);var cam_eye=m_cam.get_eye(obj,_vec3_tmp2);var dist=m_vec3.dist(cam_pivot,
cam_eye);if(dist+zoom_mouse+zoom_touch>EPSILON_DISTANCE)m_trans.move_local(obj,0,zoom_mouse+zoom_touch,0);else{var dir=m_vec3.subtract(cam_eye,cam_pivot,_vec3_tmp2);var dir_normalize=m_vec3.normalize(dir,_vec3_tmp3);m_vec3.scale(dir_normalize,EPSILON_DISTANCE,dir_normalize);m_vec3.add(cam_pivot,dir_normalize,dir);m_trans.set_translation_v(obj,dir);dest_zoom_mouse=0;dest_zoom_touch=0}}}else{dest_zoom_mouse=0;dest_zoom_touch=0}};m_ctl.create_sensor_manifold(obj,"ZOOM_INTERPOL",m_ctl.CT_CONTINUOUS,[elapsed],
null,zoom_interp_cb)}var dest_x_mouse=0;var dest_y_mouse=0;var dest_pan_x_mouse=0;var dest_pan_y_mouse=0;var mouse_move_x=m_ctl.create_mouse_move_sensor("X");var mouse_move_y=m_ctl.create_mouse_move_sensor("Y");var mouse_down=m_ctl.create_mouse_click_sensor();var mouse_cb=function(obj,id,pulse,param){if(pulse==1){var value=m_ctl.get_sensor_value(obj,id,1);m_cam.get_velocity_params(obj,velocity);if(!use_hover){var left_mult=TARGET_EYE_MOUSE_ROT_MULT_PX*velocity[1];var right_mult=TARGET_EYE_MOUSE_PAN_MULT_PX*
velocity[0]}else{var left_mult=HOVER_MOUSE_PAN_MULT_PX*velocity[0];var right_mult=HOVER_MOUSE_ROT_MULT_PX*velocity[1]}if(m_ctl.get_sensor_payload(obj,id,0)===1){dest_x_mouse+=param=="X"?-value*left_mult:0;dest_y_mouse+=param=="Y"?-value*left_mult:0}else if(m_ctl.get_sensor_payload(obj,id,0)===2||m_ctl.get_sensor_payload(obj,id,0)===3){dest_pan_x_mouse+=param=="X"?-value*right_mult:0;dest_pan_y_mouse+=param=="Y"?-value*right_mult:0}}};m_ctl.create_sensor_manifold(obj,"MOUSE_X",m_ctl.CT_LEVEL,[mouse_down,
mouse_move_x],null,mouse_cb,"X");m_ctl.create_sensor_manifold(obj,"MOUSE_Y",m_ctl.CT_LEVEL,[mouse_down,mouse_move_y],null,mouse_cb,"Y");var dest_x_touch=0;var dest_y_touch=0;var dest_pan_x_touch=0;var dest_pan_y_touch=0;var touch_move_x=m_ctl.create_touch_move_sensor("X");var touch_move_y=m_ctl.create_touch_move_sensor("Y");var touch_cb=function(obj,id,pulse,param){if(pulse==1){if(use_hover)var r_mult=HOVER_TOUCH_PAN_MULT_PX*velocity[0];else var r_mult=TARGET_EYE_TOUCH_ROT_MULT_PX*velocity[1];var value=
m_ctl.get_sensor_value(obj,id,0);if(m_ctl.get_sensor_payload(obj,id,0)===m_ctl.PL_SINGLE_TOUCH_MOVE){dest_x_touch+=param=="X"?-value*r_mult:0;dest_y_touch+=param=="Y"?-value*r_mult:0}else if(m_ctl.get_sensor_payload(obj,id,0)===m_ctl.PL_MULTITOUCH_MOVE_PAN){if(!use_hover)var pan_mult=TARGET_EYE_TOUCH_PAN_MULT_PX*velocity[0];else var pan_mult=HOVER_TOUCH_ROT_MULT_PX*velocity[1];dest_pan_x_touch+=param=="X"?-value*pan_mult:0;dest_pan_y_touch+=param=="Y"?-value*pan_mult:0}}};m_ctl.create_sensor_manifold(obj,
"TOUCH_X",m_ctl.CT_LEVEL,[touch_move_x],null,touch_cb,"X");m_ctl.create_sensor_manifold(obj,"TOUCH_Y",m_ctl.CT_LEVEL,[touch_move_y],null,touch_cb,"Y");var rot_trans_interp_cb=function(obj,id,pulse){if(pulse==1&&(Math.abs(dest_x_mouse)>EPSILON_DELTA||Math.abs(dest_y_mouse)>EPSILON_DELTA||Math.abs(dest_x_touch)>EPSILON_DELTA||Math.abs(dest_y_touch)>EPSILON_DELTA||Math.abs(dest_pan_x_mouse)>EPSILON_DELTA||Math.abs(dest_pan_y_mouse)>EPSILON_DELTA||Math.abs(dest_pan_x_touch)>EPSILON_DELTA||Math.abs(dest_pan_y_touch)>
EPSILON_DELTA)){var value=m_ctl.get_sensor_value(obj,id,0);var x_mouse=m_util.smooth(dest_x_mouse,0,value,smooth_coeff_rot_trans_mouse());var y_mouse=m_util.smooth(dest_y_mouse,0,value,smooth_coeff_rot_trans_mouse());dest_x_mouse-=x_mouse;dest_y_mouse-=y_mouse;var x_touch=m_util.smooth(dest_x_touch,0,value,smooth_coeff_rot_trans_touch());var y_touch=m_util.smooth(dest_y_touch,0,value,smooth_coeff_rot_trans_touch());dest_x_touch-=x_touch;dest_y_touch-=y_touch;var trans_x_mouse=m_util.smooth(dest_pan_x_mouse,
0,value,smooth_coeff_rot_trans_mouse());var trans_y_mouse=m_util.smooth(dest_pan_y_mouse,0,value,smooth_coeff_rot_trans_mouse());dest_pan_x_mouse-=trans_x_mouse;dest_pan_y_mouse-=trans_y_mouse;var trans_x_touch=m_util.smooth(dest_pan_x_touch,0,value,smooth_coeff_rot_trans_touch());var trans_y_touch=m_util.smooth(dest_pan_y_touch,0,value,smooth_coeff_rot_trans_touch());dest_pan_x_touch-=trans_x_touch;dest_pan_y_touch-=trans_y_touch;if(use_pivot){m_cam.rotate_target_camera(obj,x_mouse+x_touch,y_mouse+
y_touch);m_cam.move_pivot(obj,trans_x_mouse+trans_x_touch,trans_y_mouse+trans_y_touch)}else if(use_hover){if(x_mouse+x_touch)trans_hover_cam_horiz_local(obj,m_util.AXIS_X,(x_mouse+x_touch)*HOVER_MOUSE_TOUCH_TRANS_FACTOR);if(y_mouse+y_touch){var hover_angle=m_cam.get_camera_angles(obj,_vec2_tmp2)[1];var axis=Math.abs(hover_angle)>Math.PI/4?m_util.AXIS_Z:m_util.AXIS_Y;trans_hover_cam_horiz_local(obj,axis,(y_mouse+y_touch)*HOVER_MOUSE_TOUCH_TRANS_FACTOR)}m_cam.rotate_hover_camera(obj,trans_x_mouse+trans_x_touch,
0)}else{m_cam.rotate_eye_camera(obj,(x_mouse+x_touch)*EYE_ROTATION_DECREMENT,(y_mouse+y_touch)*EYE_ROTATION_DECREMENT);if(character){var angles=m_cam.get_camera_angles_char(obj,_vec2_tmp);m_phy.set_character_rotation(character,angles[0],angles[1])}}}};m_ctl.create_sensor_manifold(obj,"ROT_TRANS_INTERPOL",m_ctl.CT_CONTINUOUS,[elapsed],null,rot_trans_interp_cb);m_ctl.create_kb_sensor_manifold(obj,"DEC_STEREO_DIST",m_ctl.CT_SHOT,m_ctl.KEY_LEFT_SQ_BRACKET,function(obj,id,pulse){var dist=m_cam.get_stereo_distance(obj);
m_cam.set_stereo_distance(obj,.9*dist)});m_ctl.create_kb_sensor_manifold(obj,"INC_STEREO_DIST",m_ctl.CT_SHOT,m_ctl.KEY_RIGHT_SQ_BRACKET,function(obj,id,pulse){var dist=m_cam.get_stereo_distance(obj);m_cam.set_stereo_distance(obj,1.1*dist)})}exports.disable_camera_controls=disable_camera_controls;function disable_camera_controls(){var cam=m_scs.get_active_camera();_camera_controls_is_used=false;var cam_std_manifolds=["FORWARD","BACKWARD","ROT_UP","ROT_DOWN","ROT_LEFT","ROT_RIGHT","UP","DOWN","LEFT",
"RIGHT","MOUSE_WHEEL","TOUCH_ZOOM","ZOOM_INTERPOL","MOUSE_X","MOUSE_Y","TOUCH_X","TOUCH_Y","ROT_TRANS_INTERPOL"];for(var i=0;i<cam_std_manifolds.length;i++)m_ctl.remove_sensor_manifold(cam,cam_std_manifolds[i]);if(m_cam.get_move_style(cam)==m_cam.MS_EYE_CONTROLS&&m_scs.get_first_character())m_cons.remove(cam)}exports.set_camera_move_style=function(move_style){var disable_enable=_camera_controls_is_used;if(disable_enable)disable_camera_controls();var cam=m_scs.get_active_camera();m_cam.set_move_style(cam,
move_style);if(disable_enable)enable_camera_controls(_disable_default_pivot,_disable_letter_controls,_disable_zoom)};exports.enable_object_controls=function(obj){var trans_speed=1;var is_vehicle=m_phy.is_vehicle_chassis(obj)||m_phy.is_vehicle_hull(obj);var key_cb=function(obj,id,pulse){if(pulse==1){var elapsed=m_ctl.get_sensor_value(obj,id,0);switch(id){case "FORWARD":if(is_vehicle)m_phy.vehicle_throttle(obj,1);else m_trans.move_local(obj,0,0,trans_speed*elapsed);break;case "BACKWARD":if(is_vehicle)m_phy.vehicle_throttle(obj,
-1);else m_trans.move_local(obj,0,0,-trans_speed*elapsed);break;case "LEFT":if(is_vehicle)m_phy.vehicle_steer(obj,-1);else m_trans.move_local(obj,trans_speed*elapsed,0,0);break;case "RIGHT":if(is_vehicle)m_phy.vehicle_steer(obj,1);else m_trans.move_local(obj,-trans_speed*elapsed,0,0);break;default:break}}else switch(id){case "FORWARD":case "BACKWARD":if(is_vehicle)m_phy.vehicle_throttle(obj,0);break;case "LEFT":case "RIGHT":if(is_vehicle)m_phy.vehicle_steer(obj,0);break;default:break}};var elapsed=
m_ctl.create_elapsed_sensor();var key_w=m_ctl.create_keyboard_sensor(m_ctl.KEY_W);var key_s=m_ctl.create_keyboard_sensor(m_ctl.KEY_S);var key_a=m_ctl.create_keyboard_sensor(m_ctl.KEY_A);var key_d=m_ctl.create_keyboard_sensor(m_ctl.KEY_D);var key_up=m_ctl.create_keyboard_sensor(m_ctl.KEY_UP);var key_down=m_ctl.create_keyboard_sensor(m_ctl.KEY_DOWN);var key_left=m_ctl.create_keyboard_sensor(m_ctl.KEY_LEFT);var key_right=m_ctl.create_keyboard_sensor(m_ctl.KEY_RIGHT);var key_logic=function(s){return s[0]&&
(s[1]||s[2])};m_ctl.create_sensor_manifold(obj,"FORWARD",m_ctl.CT_CONTINUOUS,[elapsed,key_w,key_up],key_logic,key_cb);m_ctl.create_sensor_manifold(obj,"BACKWARD",m_ctl.CT_CONTINUOUS,[elapsed,key_s,key_down],key_logic,key_cb);m_ctl.create_sensor_manifold(obj,"LEFT",m_ctl.CT_CONTINUOUS,[elapsed,key_a,key_left],key_logic,key_cb);m_ctl.create_sensor_manifold(obj,"RIGHT",m_ctl.CT_CONTINUOUS,[elapsed,key_d,key_right],key_logic,key_cb)};exports.disable_object_controls=function(obj){var obj_std_manifolds=
["FORWARD","BACKWARD","LEFT","RIGHT"];for(var i=0;i<obj_std_manifolds.length;i++)m_ctl.remove_sensor_manifold(obj,obj_std_manifolds[i])};exports.enable_controls=function(allow_element_exit){var elem=m_cont.get_container();allow_element_exit=allow_element_exit||false;m_ctl.register_keyboard_events(document,false);m_ctl.register_mouse_events(elem,true,allow_element_exit);m_ctl.register_wheel_events(elem,true);m_ctl.register_touch_events(elem,true);m_ctl.register_device_orientation()};exports.disable_controls=
function(){var elem=m_cont.get_container();m_ctl.unregister_keyboard_events(document);m_ctl.unregister_mouse_events(elem);m_ctl.unregister_wheel_events(elem);m_ctl.unregister_touch_events(elem);m_ctl.unregister_device_orientation()};exports.enable_debug_controls=function(){m_ctl.create_kb_sensor_manifold(null,"CAMERA_SHOT",m_ctl.CT_SHOT,m_ctl.KEY_K,function(){m_dbg.make_camera_frustum_shot()});m_ctl.create_kb_sensor_manifold(null,"LIGHT_SHOT",m_ctl.CT_SHOT,m_ctl.KEY_L,function(){m_dbg.make_light_frustum_shot()});
m_ctl.create_kb_sensor_manifold(null,"TELEMETRY",m_ctl.CT_SHOT,m_ctl.KEY_T,function(){m_dbg.plot_telemetry()})};exports.request_fullscreen=request_fullscreen;function request_fullscreen(elem,enabled_cb,disabled_cb){enabled_cb=enabled_cb||function(){};disabled_cb=disabled_cb||function(){};function on_fullscreen_change(){if(document.fullscreenElement===elem||document.webkitFullScreenElement===elem||document.mozFullScreenElement===elem||document.webkitIsFullScreen||document.msFullscreenElement===elem)enabled_cb();
else{document.removeEventListener("fullscreenchange",on_fullscreen_change,false);document.removeEventListener("webkitfullscreenchange",on_fullscreen_change,false);document.removeEventListener("mozfullscreenchange",on_fullscreen_change,false);document.removeEventListener("MSFullscreenChange",on_fullscreen_change,false);disabled_cb()}}document.addEventListener("fullscreenchange",on_fullscreen_change,false);document.addEventListener("webkitfullscreenchange",on_fullscreen_change,false);document.addEventListener("mozfullscreenchange",
on_fullscreen_change,false);document.addEventListener("MSFullscreenChange",on_fullscreen_change,false);elem.requestFullScreen=elem.requestFullScreen||elem.webkitRequestFullScreen||elem.mozRequestFullScreen||elem.msRequestFullscreen;if(elem.requestFullScreen==elem.webkitRequestFullScreen)elem.requestFullScreen(Element.ALLOW_KEYBOARD_INPUT);else elem.requestFullScreen()}exports.exit_fullscreen=exit_fullscreen;function exit_fullscreen(){var exit_fs=document.exitFullscreen||document.webkitExitFullscreen||
document.mozCancelFullScreen||document.msExitFullscreen;if(typeof exit_fs!="function")throw"B4W App: exit fullscreen method is not supported";exit_fs.apply(document)}exports.check_fullscreen=check_fullscreen;function check_fullscreen(){var fullscreenEnabled=window.document.fullscreenEnabled||window.document.mozFullScreenEnabled||window.document.msFullscreenEnabled||window.document.webkitFullscreenEnabled;if(fullscreenEnabled)return true;return false}function toggle_camera_collisions_usage(){var camobj=
m_scs.get_active_camera();if(m_anim.is_detect_collisions_used(camobj))m_anim.detect_collisions(camobj,false);else m_anim.detect_collisions(camobj,true)}exports.report_app_error=report_app_error;function report_app_error(text_message,link_message,link,purge_elements){var elem=document.createElement("div");var top_elem=document.createElement("div");var bottom_elem=document.createElement("div");if(purge_elements)for(var i=0;i<purge_elements.length;i++){var purge_elem=document.getElementById(purge_elements[i]);
if(purge_elem)purge_elem.parentNode.removeChild(purge_elem)}elem.style.cssText="z-index:10;width:100%;height:auto;position:absolute;top:50%;margin-top:150px;text-align:center;";top_elem.style.cssText="color:#fff;font-size:24px;";bottom_elem.style.cssText="color:#fff;font-size:20px;";top_elem.innerHTML=text_message;bottom_elem.innerHTML=link_message+"   "+'<a style="color:#fff;font-size:20px;width:100%;" href="'+link+'">'+link.replace("https://www.","")+"</a>";elem.appendChild(top_elem);elem.appendChild(bottom_elem);
document.body.appendChild(elem)}exports.get_url_params=function(allow_param_array){allow_param_array=!!allow_param_array;var url=location.href.toString();if(url.indexOf("?")==-1)return null;var params=url.split("?")[1].split("&");var out={};for(var i=0;i<params.length;i++){var param=params[i].split("=");var prop_name=param[0];if(param.length>1){var prop_val=param[1];if(allow_param_array)if(prop_name in out)out[prop_name].push(prop_val);else out[prop_name]=[prop_val];else out[prop_name]=prop_val}else if(allow_param_array){if(!(prop_name in
out))out[prop_name]=[]}else out[prop_name]=""}return out};exports.css_animate=function(elem,prop,from,to,timeout,opt_prefix,opt_suffix,opt_callback){if(!elem||!prop||!isFinite(from)||!isFinite(to)||!isFinite(timeout))return;opt_prefix=opt_prefix||"";opt_suffix=opt_suffix||"";opt_callback=opt_callback||function(){};var elem_style=elem.style;var vendor_prop=prop.charAt(0).toUpperCase()+prop.slice(1);if(elem_style[prop]!=undefined);else if(elem_style["webkit"+vendor_prop]!=undefined)prop="webkit"+vendor_prop;
else if(elem_style["ms"+vendor_prop]!=undefined)prop="ms"+vendor_prop;else if(elem_style["moz"+vendor_prop]!=undefined)prop="moz"+vendor_prop;else return;function css_anim_cb(val){if(!elem)return;elem_style[prop]=opt_prefix+val+opt_suffix;if(from>to&&val<=to||from<to&&val>=to){elem_style[prop]=opt_prefix+to+opt_suffix;opt_callback()}}animate(elem,from,to,timeout,css_anim_cb)};exports.attr_animate=function(elem,attr_name,from,to,timeout,opt_callback){if(!elem||!attr_name||!isFinite(from)||!isFinite(to)||
!isFinite(timeout))return;opt_callback=opt_callback||function(){};function attr_anim_cb(val){if(!elem)return;if(val>=0)elem.setAttribute(attr_name,val);if(from>to&&val<=to||from<to&&val>=to){elem.setAttribute(attr_name,to);opt_callback()}}animate(elem,from,to,timeout,attr_anim_cb)};function animate(elem,from,to,timeout,anim_cb){var start=performance.now();function cb(){var elapsed_total=performance.now()-start;var value=from+elapsed_total*(to-from)/timeout;anim_cb(value);if(elapsed_total>=timeout||
!elem.parentNode)m_main.remove_loop_cb(cb)}m_main.append_loop_cb(cb)}exports.queue_animate=function(queue){if(!queue.length)return;var queue_obj=queue.shift();var elem=queue_obj.elem;var prop=queue_obj.prop;var from=queue_obj.from;var to=queue_obj.to;var duration=queue_obj.duration;var prefix=queue_obj.opt_prefix;var suffix=queue_obj.opt_suffix;var cb=function(){if(queue_obj.cb)queue_obj.cb();exports.queue_animate(queue)};if(queue_obj.type=="css")exports.css_animate(elem,prop,from,to,duration,prefix,
suffix,cb);else if(queue_obj.type=="attr")exports.attr_animate(elem,prop,from,to,duration,cb)};function smooth_coeff_zoom_mouse(){return CAM_SMOOTH_ZOOM_MOUSE*_smooth_factor}function smooth_coeff_zoom_touch(){return CAM_SMOOTH_ZOOM_TOUCH*_smooth_factor}function smooth_coeff_rot_trans_mouse(){return CAM_SMOOTH_ROT_TRANS_MOUSE*_smooth_factor}function smooth_coeff_rot_trans_touch(){return CAM_SMOOTH_ROT_TRANS_TOUCH*_smooth_factor}exports.set_camera_smooth_factor=function(value){_smooth_factor=value};
exports.get_camera_smooth_factor=function(){return _smooth_factor}};b4w.module["camera_anim"]=function(exports,require){var m_cam=require("camera");var m_ctl=require("controls");var m_print=require("print");var m_scs=require("scenes");var m_time=require("time");var m_trans=require("transform");var m_tsr=require("tsr");var m_util=require("util");var m_vec3=require("vec3");var m_quat=require("quat");var PI=Math.PI;var ROTATION_OFFSET=.2;var ROTATION_LIMITS_EPS=1E-6;var DEFAULT_CAM_LIN_SPEED=1;var DEFAULT_CAM_ANGLE_SPEED=.01;var DEFAULT_CAM_ROTATE_TIME=1E3;var _vec2_tmp=
new Float32Array(2);var _vec2_tmp2=new Float32Array(2);var _vec3_tmp=new Float32Array(3);var _vec3_tmp2=new Float32Array(3);var _vec3_tmp3=new Float32Array(3);var _quat4_tmp=new Float32Array(4);var _angle_limits_tmp=new Float32Array(2);var _angle_limits_tmp2=new Float32Array(2);var _tsr_tmp=new Float32Array(8);var _tsr_tmp2=new Float32Array(8);var _tsr_tmp3=new Float32Array(8);var _is_camera_moving=false;var _is_camera_rotating=false;var _is_camera_stop_moving=false;var _is_camera_stop_rotating=false;
exports.track_to_target=function(cam_obj,target,rot_speed,zoom_mult,zoom_time,zoom_delay,callback,zoom_cb){if(!m_cam.is_eye_camera(cam_obj)){m_print.error("track_to_target(): wrong object");return}if(!cam_obj)return;if(!target)return;else if(m_util.is_vector(target))var obj_pos=target;else{var obj_pos=_vec3_tmp3;m_trans.get_object_center(target,false,obj_pos)}var rot_sp=rot_speed||1;var zoom_m=zoom_mult||2;var zoom_t=zoom_time||1;var zoom_d=zoom_delay||1;var def_dir=_vec3_tmp2;def_dir[0]=0;def_dir[1]=
-1;def_dir[2]=0;var cam_quat=m_trans.get_rotation(cam_obj);var cam_dir=m_util.quat_to_dir(cam_quat,def_dir);var cam_angles=m_cam.get_camera_angles(cam_obj,_vec2_tmp);var dir_to_obj=_vec3_tmp;var cam_pos=m_trans.get_translation(cam_obj);m_vec3.subtract(obj_pos,cam_pos,dir_to_obj);m_vec3.normalize(dir_to_obj,dir_to_obj);var rot_quat=m_quat.rotationTo(cam_dir,dir_to_obj,m_quat.create());var quat=_quat4_tmp;m_quat.multiply(rot_quat,cam_quat,quat);m_util.correct_cam_quat_up(quat,false);var sub_vec=_vec3_tmp2;
m_vec3.subtract(obj_pos,cam_pos,sub_vec);var zoom_distance=m_vec3.length(sub_vec)*(1-1/zoom_m);var angle_to_obj_y=Math.asin(dir_to_obj[1]);var angle_to_obj_x=Math.acos(-dir_to_obj[2]/Math.abs(Math.cos(angle_to_obj_y)));if(dir_to_obj[0]>0)angle_to_obj_x=2*Math.PI-angle_to_obj_x;var angle_x=angle_to_obj_x-cam_angles[0];var angle_y=angle_to_obj_y-cam_angles[1];var cam_dir_z=_vec3_tmp3;cam_dir_z[0]=0;cam_dir_z[1]=0;cam_dir_z[2]=-1;var cam_rot_quat=m_trans.get_rotation(cam_obj);var cam_rot_dir=m_util.quat_to_dir(cam_rot_quat,
cam_dir_z);if(cam_rot_dir[1]<0){if(cam_dir[1]>0)angle_y=angle_to_obj_y-Math.PI+cam_angles[1];else angle_y=angle_to_obj_y+Math.PI+cam_angles[1];if(angle_x>0)angle_x=-Math.PI+angle_x;else angle_x=Math.PI+angle_x}else if(Math.abs(angle_x)>Math.PI)if(angle_x>0)angle_x=angle_x-2*Math.PI;else angle_x=angle_x+2*Math.PI;var cur_time=0;var elapsed=m_ctl.create_elapsed_sensor();var rot_end_time_x=Math.abs(angle_x/rot_sp);var rot_end_time_y=Math.abs(angle_y/rot_sp);var rot_end_time=rot_end_time_x>rot_end_time_y?
rot_end_time_x:rot_end_time_y;var zoom_end_time=rot_end_time+zoom_t;var zoom_end_delay=zoom_end_time+zoom_d;var finish_time=zoom_end_delay+zoom_t;var dest_ang_x=angle_x;var dest_ang_y=angle_y;var dest_trans_x=zoom_distance;var smooth_function=function(x){var f=6*x*(1-x);return f};var track_cb=function(obj,id,pulse){if(pulse){if(!m_cam.is_eye_camera(obj)){disable_cb();return}var value=m_ctl.get_sensor_value(obj,id,0);cur_time+=value;if(cur_time<rot_end_time){var delta_x=angle_x/rot_end_time*value;
var delta_y=angle_y/rot_end_time*value;var time_ratio=cur_time/rot_end_time;var slerp=smooth_function(time_ratio);delta_x*=slerp;delta_y*=slerp;dest_ang_x-=delta_x;dest_ang_y-=delta_y;m_cam.rotate_eye_camera(obj,delta_x,delta_y)}else if(cur_time<zoom_end_time){if(dest_ang_x){m_cam.rotate_eye_camera(obj,dest_ang_x,dest_ang_y);dest_ang_x=0;if(zoom_cb)zoom_cb()}var time_ratio=(cur_time-rot_end_time)/zoom_t;var delta=-zoom_distance*value/zoom_t;dest_trans_x-=delta_x;delta*=smooth_function(time_ratio);
m_trans.move_local(obj,0,delta,0)}else if(cur_time<zoom_end_delay){if(dest_trans_x){m_trans.move_local(obj,0,dest_trans_x,0);dest_trans_x=0}}else if(cur_time<finish_time){var time_ratio=(cur_time-zoom_end_delay)/zoom_t;var delta=zoom_distance*value/zoom_t;delta*=smooth_function(time_ratio);m_trans.move_local(obj,0,delta,0)}else{m_trans.set_translation_v(obj,cam_pos);disable_cb()}}};var disable_cb=function(){m_ctl.remove_sensor_manifold(cam_obj,"TRACK_TO_TARGET");if(callback)callback()};m_ctl.create_sensor_manifold(cam_obj,
"TRACK_TO_TARGET",m_ctl.CT_CONTINUOUS,[elapsed],null,track_cb)};function init_limited_rotation_ratio(obj,limits,auto_rotate_ratio){var phi=m_cam.get_camera_angles(obj,_vec2_tmp)[0];var delts=get_delta_to_limits(phi,limits[0],limits[1],_vec2_tmp2);return auto_rotate_ratio*Math.min(1,delts[0]/ROTATION_OFFSET,delts[1]/ROTATION_OFFSET)}function get_delta_to_limits(angle,limit_from,limit_to,dest){var delta_to_min=m_util.angle_wrap_0_2pi(angle-limit_from);var delta_to_max=m_util.angle_wrap_0_2pi(limit_to-
angle);if(Math.abs(delta_to_min)<ROTATION_LIMITS_EPS||2*Math.PI-Math.abs(delta_to_min)<ROTATION_LIMITS_EPS)delta_to_min=0;if(Math.abs(delta_to_max)<ROTATION_LIMITS_EPS||2*Math.PI-Math.abs(delta_to_max)<ROTATION_LIMITS_EPS)delta_to_max=0;dest[0]=delta_to_min;dest[1]=delta_to_max;return dest}exports.auto_rotate=function(auto_rotate_ratio,callback){callback=callback||function(){};var obj=m_scs.get_active_camera();if(m_cam.get_move_style(obj)==m_cam.MS_STATIC){m_print.error("auto_rotate(): wrong camera type");
return}var angle_limits=null;var rot_offset=0;var cur_rotate_ratio=0;function update_limited_rotation_params(curr_limits){angle_limits=angle_limits||_angle_limits_tmp;angle_limits.set(curr_limits);rot_offset=Math.min(ROTATION_OFFSET,m_util.angle_wrap_0_2pi(angle_limits[1]-angle_limits[0])/2);cur_rotate_ratio=init_limited_rotation_ratio(obj,angle_limits,auto_rotate_ratio)}function elapsed_cb(obj,id,pulse){if(pulse==1){var move_style=m_cam.get_move_style(obj);if(move_style==m_cam.MS_STATIC)disable_cb();
else if(move_style!=m_cam.MS_HOVER_CONTROLS&&m_cam.has_horizontal_limits(obj)){var curr_limits=m_cam.get_horizontal_limits(obj,_angle_limits_tmp2);if(angle_limits===null||curr_limits[0]!=angle_limits[0]||curr_limits[1]!=angle_limits[1])update_limited_rotation_params(curr_limits);limited_auto_rotate(obj,id)}else{angle_limits=null;unlimited_auto_rotate(obj,id)}}}function limited_auto_rotate(obj,id){var value=m_ctl.get_sensor_value(obj,id,0);var phi=m_cam.get_camera_angles(obj,_vec2_tmp)[0];var delts=
get_delta_to_limits(phi,angle_limits[0],angle_limits[1],_vec2_tmp2);if(delts[1]>rot_offset&&delts[0]>rot_offset)cur_rotate_ratio=m_util.sign(cur_rotate_ratio)*auto_rotate_ratio;else if(delts[1]<rot_offset)cur_rotate_ratio=cur_rotate_ratio-Math.pow(auto_rotate_ratio,2)/(2*ROTATION_OFFSET)*value;else if(delts[0]<rot_offset)cur_rotate_ratio=cur_rotate_ratio+Math.pow(auto_rotate_ratio,2)/(2*ROTATION_OFFSET)*value;m_cam.rotate_camera(obj,value*cur_rotate_ratio,0)}function unlimited_auto_rotate(obj,id){var value=
m_ctl.get_sensor_value(obj,id,0);m_cam.rotate_camera(obj,value*auto_rotate_ratio,0)}function disable_cb(){m_ctl.remove_sensor_manifold(obj,"AUTO_ROTATE");m_ctl.remove_sensor_manifold(obj,"DISABLE_AUTO_ROTATE");callback()}if(!m_ctl.check_sensor_manifold(obj,"AUTO_ROTATE")){var mouse_move_x=m_ctl.create_mouse_move_sensor("X");var mouse_move_y=m_ctl.create_mouse_move_sensor("Y");var mouse_down=m_ctl.create_mouse_click_sensor();var touch_move=m_ctl.create_touch_move_sensor();var touch_zoom=m_ctl.create_touch_zoom_sensor();
var elapsed=m_ctl.create_elapsed_sensor();var logic_func=function(s){return s[0]&&s[2]||s[1]&&s[2]||s[3]||s[4]};m_ctl.create_sensor_manifold(obj,"DISABLE_AUTO_ROTATE",m_ctl.CT_LEVEL,[mouse_move_x,mouse_move_y,mouse_down,touch_move,touch_zoom],logic_func,disable_cb);m_ctl.create_sensor_manifold(obj,"AUTO_ROTATE",m_ctl.CT_CONTINUOUS,[elapsed],function(s){return s[0]},elapsed_cb)}else disable_cb()};exports.is_auto_rotate=function(){var obj=m_scs.get_active_camera();return m_ctl.check_sensor_manifold(obj,
"AUTO_ROTATE")};exports.check_auto_rotate=function(){var obj=m_scs.get_active_camera();var cam_type=m_cam.get_move_style(obj);if(cam_type==m_cam.MS_STATIC)return false;return true};exports.move_camera_to_point=function(cam_obj,point_obj,cam_lin_speed,cam_angle_speed,cb){if(m_cam.get_move_style(cam_obj)!=m_cam.MS_STATIC){m_print.error("move_camera_to_point(): wrong camera type");return}if(_is_camera_moving)return;if(!cam_obj){m_print.error("move_camera_to_point(): you must specify the camera object");
return}if(!point_obj){m_print.error("move_camera_to_point(): you must specify the point object");return}cam_lin_speed=cam_lin_speed||DEFAULT_CAM_LIN_SPEED;cam_angle_speed=cam_angle_speed||DEFAULT_CAM_ANGLE_SPEED;if(m_util.is_vector(cam_obj))var cam_tsr=cam_obj;else var cam_tsr=m_trans.get_tsr(cam_obj,_tsr_tmp);if(m_util.is_vector(point_obj))var point_tsr=point_obj;else var point_tsr=m_trans.get_tsr(point_obj,_tsr_tmp2);var distance=m_vec3.distance(m_tsr.get_trans_view(cam_tsr),m_tsr.get_trans_view(point_tsr));
var move_time=distance/cam_lin_speed;var current_cam_dir=m_util.quat_to_dir(m_tsr.get_quat_view(cam_tsr),m_util.AXIS_MY,_vec3_tmp);var target_cam_dir=m_util.quat_to_dir(m_tsr.get_quat_view(point_tsr),m_util.AXIS_MY,_vec3_tmp2);var vec_dot=Math.min(Math.abs(m_vec3.dot(current_cam_dir,target_cam_dir)),1);var angle=Math.acos(vec_dot);var rotate_time=angle/cam_angle_speed;var time=Math.max(move_time,rotate_time)*1E3;_is_camera_moving=true;var cur_animator=m_time.animate(0,1,time,function(e){var new_tsr=
m_tsr.interpolate(cam_tsr,point_tsr,m_util.smooth_step(e),_tsr_tmp3);if(_is_camera_stop_moving){m_time.clear_animation(cur_animator);_is_camera_stop_moving=false;_is_camera_moving=false;return}m_trans.set_tsr(cam_obj,new_tsr);if(e==1){_is_camera_moving=false;if(cb)cb()}})};exports.rotate_camera=function(cam_obj,angle_phi,angle_theta,time,cb){if(_is_camera_rotating)return;if(!cam_obj){m_print.error("rotate_camera(): you must specify the camera object");return}if(!angle_phi&&!angle_theta){m_print.error("rotate_camera(): you must specify the rotation angle");
return}time=time||DEFAULT_CAM_ROTATE_TIME;_is_camera_rotating=true;var delta_phi=0;var delta_theta=0;var angle=angle_phi!=0?angle_phi:angle_theta;var cur_animator=m_time.animate(0,angle,time,function(e){if(_is_camera_stop_rotating){m_time.clear_animation(cur_animator);_is_camera_stop_rotating=false;_is_camera_rotating=false;return}delta_phi-=e;delta_theta-=e;if(angle_theta&&angle_phi)m_cam.rotate_camera(cam_obj,delta_phi,delta_theta);else if(angle_theta)m_cam.rotate_camera(cam_obj,0,delta_theta);
else if(angle_phi)m_cam.rotate_camera(cam_obj,delta_phi,0);delta_phi=e;delta_theta=e;if(e==angle){_is_camera_rotating=false;if(cb)cb()}})};exports.stop_cam_moving=function(){_is_camera_stop_moving=true};exports.stop_cam_rotating=function(){_is_camera_stop_rotating=true};exports.is_moving=function(){return _is_camera_moving};exports.is_rotating=function(){return _is_camera_rotating}};b4w.module["gyroscope"]=function(exports,require){var m_ctl=require("controls");var m_scenes=require("scenes");var m_cam=require("camera");var _begin_angles=new Float32Array(3);var _curr_angles=new Float32Array(3);var VERTICAL_BETA_ANGLE_THRESHOLD_UP=Math.PI*110/180;var VERTICAL_BETA_ANGLE_THRESHOLD_DOWN=Math.PI*70/180;var VERTICAL_GAMMA_ANGLE_THRESHOLD_UP=Math.PI*70/180;var VERTICAL_GAMMA_ANGLE_THRESHOLD_DOWN=-Math.PI*70/180;exports.enable_camera_rotation=function(){var cam_obj=m_scenes.get_active_camera();
create_camera_rotation_sensors(cam_obj)};function create_camera_rotation_sensors(obj){var g_a_sensor=m_ctl.create_gyro_angles_sensor();var save_angles=true;var cam_rotate_cb=function(obj,id,pulse){if(pulse>0){_curr_angles=m_ctl.get_sensor_payload(obj,id,0);if(save_angles){_begin_angles[0]=_curr_angles[0];_begin_angles[1]=_curr_angles[1];_begin_angles[2]=_curr_angles[2];save_angles=false}var delta_beta=0;var delta_gamma=0;if(window.orientation==0){delta_beta=_curr_angles[1]-_begin_angles[1];delta_gamma=
_curr_angles[0]-_begin_angles[0];if(_curr_angles[1]>VERTICAL_BETA_ANGLE_THRESHOLD_DOWN&&_curr_angles[1]<VERTICAL_BETA_ANGLE_THRESHOLD_UP)delta_gamma=0}if(window.orientation==180){delta_beta=_curr_angles[1]-_begin_angles[1];if(_curr_angles[1]<0)delta_beta=-delta_beta;delta_gamma=_begin_angles[0]-_curr_angles[0];if(delta_beta>Math.PI/2||delta_beta<-Math.PI/2)delta_beta=0;if(_curr_angles[1]>-VERTICAL_BETA_ANGLE_THRESHOLD_UP&&_curr_angles[1]<-VERTICAL_BETA_ANGLE_THRESHOLD_DOWN)delta_gamma=0}if(window.orientation==
-90){delta_beta=_curr_angles[0]-_begin_angles[0];if(delta_beta>Math.PI/2||delta_beta<-Math.PI/2)delta_beta=0;delta_gamma=_begin_angles[1]-_curr_angles[1];if(_curr_angles[0]>VERTICAL_GAMMA_ANGLE_THRESHOLD_UP||_curr_angles[0]<VERTICAL_GAMMA_ANGLE_THRESHOLD_DOWN)delta_gamma=0}if(window.orientation==90){delta_beta=_begin_angles[0]-_curr_angles[0];if(delta_beta>Math.PI/2||delta_beta<-Math.PI/2)delta_beta=0;delta_gamma=_curr_angles[1]-_begin_angles[1];if(_curr_angles[0]>VERTICAL_GAMMA_ANGLE_THRESHOLD_UP||
_curr_angles[0]<VERTICAL_GAMMA_ANGLE_THRESHOLD_DOWN)delta_gamma=0}m_cam.rotate_camera(obj,delta_gamma,delta_beta);_begin_angles[0]=_curr_angles[0];_begin_angles[1]=_curr_angles[1];_begin_angles[2]=_curr_angles[2]}};m_ctl.create_sensor_manifold(obj,"CAMERA_ROTATE_GYRO",m_ctl.CT_CONTINUOUS,[g_a_sensor],null,cam_rotate_cb)}};b4w.module["mixer"]=function(exports,require){var m_ctl=require("controls");var m_debug=require("debug");var m_hud=require("hud");var m_scenes=require("scenes");var m_sfx=require("sfx");var m_util=require("util");var TIMER_SLOW_PERIOD=.15;var TIMER_FAST_PERIOD=.05;var _mixer_strips=[];var _active_strip=0;var _filter_freq_arr=null;var _filter_mag_arr=null;var _filter_phase_arr=null;exports.enable_mixer_controls=function(){init();var key_left_sqbr=m_ctl.create_keyboard_sensor(m_ctl.KEY_LEFT_SQ_BRACKET);
var key_right_sqbr=m_ctl.create_keyboard_sensor(m_ctl.KEY_RIGHT_SQ_BRACKET);var key_semi=m_ctl.create_keyboard_sensor(m_ctl.KEY_SEMI_COLON);var key_quote=m_ctl.create_keyboard_sensor(m_ctl.KEY_SINGLE_QUOTE);var key_shift=m_ctl.create_keyboard_sensor(m_ctl.KEY_SHIFT);var timer_slow=m_ctl.create_timer_sensor(TIMER_SLOW_PERIOD,true);var timer_fast=m_ctl.create_timer_sensor(TIMER_FAST_PERIOD,true);var mixer_keys=[key_left_sqbr,key_right_sqbr,key_semi,key_quote,key_shift,timer_slow,timer_fast];var switch_strip_logic=
function(s){return(s[0]||s[1])&&!s[4]};var switch_strip_logic_hold=function(s){return(s[0]||s[1])&&!s[4]&&s[5]};var switch_param_logic=function(s){return(s[0]||s[1])&&s[4]};var switch_spk_cb=function(obj,id,pulse){if(pulse==1){var dir=Boolean(m_ctl.get_sensor_value(obj,id,0))?-1:1;switch_strip(dir);if(id=="SWITCH_STRIP")m_ctl.reset_timer_sensor(obj,id,5,TIMER_SLOW_PERIOD+.3);else m_ctl.reset_timer_sensor(obj,id,5,TIMER_SLOW_PERIOD)}else m_ctl.reset_timer_sensor(obj,id,5,10)};m_ctl.create_sensor_manifold(null,
"SWITCH_STRIP",m_ctl.CT_TRIGGER,mixer_keys,switch_strip_logic,switch_spk_cb);m_ctl.create_sensor_manifold(null,"SWITCH_STRIP_HOLD",m_ctl.CT_SHOT,mixer_keys,switch_strip_logic_hold,switch_spk_cb);var switch_param_cb=function(obj,id,pulse){var dir=Boolean(m_ctl.get_sensor_value(obj,id,0))?-1:1;switch_param(dir)};m_ctl.create_sensor_manifold(null,"SWITCH_PARAM",m_ctl.CT_SHOT,mixer_keys,switch_param_logic,switch_param_cb);var inc_dec_cb=function(obj,id,pulse){if(pulse==1){var dir=Boolean(m_ctl.get_sensor_value(obj,
id,2))?-1:1;param_inc_dec(dir);if(id=="INC_DEC")m_ctl.reset_timer_sensor(obj,id,6,TIMER_FAST_PERIOD+.3);else m_ctl.reset_timer_sensor(obj,id,6,TIMER_FAST_PERIOD)}else m_ctl.reset_timer_sensor(obj,id,6,10)};var inc_dec_logic=function(s){return(s[2]||s[3])&&!s[4]};var inc_dec_logic_hold=function(s){return(s[2]||s[3])&&!s[4]&&s[6]};m_ctl.create_sensor_manifold(null,"INC_DEC",m_ctl.CT_TRIGGER,mixer_keys,inc_dec_logic,inc_dec_cb);m_ctl.create_sensor_manifold(null,"INC_DEC_HOLD",m_ctl.CT_SHOT,mixer_keys,
inc_dec_logic_hold,inc_dec_cb);var mute_solo_cb=function(obj,id,pulse){var mute_solo=Boolean(m_ctl.get_sensor_value(obj,id,2));if(mute_solo)switch_mute();else switch_solo()};var mute_solo_logic=function(s){return(s[2]||s[3])&&s[4]};m_ctl.create_sensor_manifold(null,"MUTE_SOLO",m_ctl.CT_SHOT,mixer_keys,mute_solo_logic,mute_solo_cb);var elapsed=m_ctl.create_elapsed_sensor();m_ctl.create_sensor_manifold(null,"MIXER_DRAW",m_ctl.CT_CONTINUOUS,[elapsed],null,function(){draw()});var timer=m_ctl.create_timer_sensor(1,
true);m_ctl.create_sensor_manifold(null,"MIXER_UPDATE",m_ctl.CT_TRIGGER,[timer],null,function(){var strip_range=active_strip_range();for(var i=strip_range[0];i<=strip_range[1];i++)update_strip_params(_mixer_strips[i])})};function init(){_mixer_strips.length=0;_active_strip=0;_filter_freq_arr=gen_freq_arr(100);_filter_mag_arr=new Float32Array(_filter_freq_arr.length);_filter_phase_arr=new Float32Array(_filter_freq_arr.length);var speakers=m_sfx.get_speaker_objects();if(!speakers.length)return;_mixer_strips.push(create_master_strip());
for(var i=0;i<speakers.length;i++){var spk=speakers[i];_mixer_strips.push(create_speaker_strip(spk))}_mixer_strips.sort(function(a,b){if(a.id=="MASTER")return-1;else if(b.id=="MASTER")return 1;else if(a.id=="COMPRESSOR")return-1;else if(b.id=="COMPRESSOR")return 1;else if(a.id.toUpperCase()<b.id.toUpperCase())return-1;else if(a.id.toUpperCase()>b.id.toUpperCase())return 1;else return 0})}function gen_freq_arr(steps){var FMIN=20;var FMAX=2E4;var freq_arr=new Float32Array(steps);var freq_base=FMAX/
FMIN;var freq_pow=0;for(var i=0;i<steps;i++){freq_arr[i]=FMIN*Math.pow(freq_base,freq_pow);freq_pow+=1/(steps-1)}return freq_arr}function create_master_strip(){var strip=init_strip("MASTER");strip.params.push(["VOLUME",m_sfx.get_volume(null),0,1,50,false]);var cparams=m_sfx.get_compressor_params();if(cparams){strip.params.push(["THRESHOLD",cparams["threshold"],-100,0,100,false]);strip.params.push(["KNEE",cparams["knee"],0,40,40,false]);strip.params.push(["RATIO",cparams["ratio"],1,20,20,false]);strip.params.push(["ATTACK",
cparams["attack"],0,1,1E3,false]);strip.params.push(["RELEASE",cparams["release"],0,1,1E3,false])}strip.mute=m_sfx.is_muted(null)?1:0;strip.solo=-1;return strip}function init_strip(id){return{id:id,params:[],active_param:0,mute:-1,solo:-1,speaker:null}}function create_speaker_strip(spk){var strip=init_strip(m_scenes.get_object_name(spk));strip.mute=m_sfx.is_muted(spk)?1:0;strip.solo=0;strip.speaker=spk;return strip}function switch_strip(dir){if(!_mixer_strips.length)return;if(dir==1&&_active_strip<
_mixer_strips.length-1)_active_strip++;else if(dir==-1&&_active_strip>0)_active_strip--;var strip_range=active_strip_range();for(var i=strip_range[0];i<=strip_range[1];i++)update_strip_params(_mixer_strips[i])}function update_strip_params(strip){if(!strip.speaker)return;strip.params.length=0;strip.params.push(["VOLUME",m_sfx.get_volume(strip.speaker),0,1,50,false]);var pparams=m_sfx.get_positional_params(strip.speaker);if(pparams){strip.params.push(["DIST_REF",pparams["dist_ref"],0,1E3,1E4,false]);
strip.params.push(["ATTENUATION",pparams["attenuation"],0,50,1E3,false]);strip.params.push(["DIST_MAX",pparams["dist_max"],0,1E4,1E4,false])}var fparams=m_sfx.get_filter_params(strip.speaker);if(fparams){strip.params.push(["EQ_FREQ",fparams["freq"],20,2E4,100,true]);strip.params.push(["EQ_Q",fparams["Q"],0,10,100,false]);strip.params.push(["EQ_GAIN",fparams["gain"],-70,30,100,false])}m_util.clamp(strip.active_param,0,strip.params.length-1)}function switch_param(dir){var strip=_mixer_strips[_active_strip];
if(!strip)return;if(dir==1&&strip.active_param<strip.params.length-1)strip.active_param++;else if(dir==-1&&strip.active_param>0)strip.active_param--}function param_inc_dec(dir){var strip=_mixer_strips[_active_strip];if(!strip)return;var param=strip.params[strip.active_param];if(param[5])param[1]*=Math.pow(param[3]/param[2],dir/param[4]);else param[1]+=dir*((param[3]-param[2])/param[4]);param[1]=m_util.clamp(param[1],param[2],param[3]);switch(param[0]){case "VOLUME":if(strip.id!="MASTER")m_sfx.set_volume(strip.speaker,
param[1]);else m_sfx.set_volume(null,param[1]);break;case "DIST_REF":var pparams=m_sfx.get_positional_params(strip.speaker);pparams["dist_ref"]=param[1];m_sfx.set_positional_params(strip.speaker,pparams);break;case "ATTENUATION":var pparams=m_sfx.get_positional_params(strip.speaker);pparams["attenuation"]=param[1];m_sfx.set_positional_params(strip.speaker,pparams);break;case "DIST_MAX":var pparams=m_sfx.get_positional_params(strip.speaker);pparams["dist_max"]=param[1];m_sfx.set_positional_params(strip.speaker,
pparams);break;case "EQ_FREQ":var fparams=m_sfx.get_filter_params(strip.speaker);fparams["freq"]=param[1];m_sfx.set_filter_params(strip.speaker,fparams);break;case "EQ_Q":var fparams=m_sfx.get_filter_params(strip.speaker);fparams["Q"]=param[1];m_sfx.set_filter_params(strip.speaker,fparams);break;case "EQ_GAIN":var fparams=m_sfx.get_filter_params(strip.speaker);fparams["gain"]=param[1];m_sfx.set_filter_params(strip.speaker,fparams);break;case "THRESHOLD":var cparams=m_sfx.get_compressor_params();cparams["threshold"]=
param[1];m_sfx.set_compressor_params(cparams);break;case "KNEE":var cparams=m_sfx.get_compressor_params();cparams["knee"]=param[1];m_sfx.set_compressor_params(cparams);break;case "RATIO":var cparams=m_sfx.get_compressor_params();cparams["ratio"]=param[1];m_sfx.set_compressor_params(cparams);break;case "ATTACK":var cparams=m_sfx.get_compressor_params();cparams["attack"]=param[1];m_sfx.set_compressor_params(cparams);break;case "RELEASE":var cparams=m_sfx.get_compressor_params();cparams["release"]=param[1];
m_sfx.set_compressor_params(cparams);break;default:throw"Unknown strip param";break}}function switch_mute(){var strip=_mixer_strips[_active_strip];if(!strip)return;if(strip.mute>=0)flip_strip_mute(strip)}function flip_strip_mute(strip){var id=strip.id;if(id!="MASTER")if(strip.mute==0){strip.mute=1;m_sfx.mute(strip.speaker,true);if(strip.solo==1){strip.solo=0;if(!is_other_solo(strip))unmute_other(strip)}}else{strip.mute=0;if(!is_other_solo(strip))m_sfx.mute(strip.speaker,false)}else if(strip.mute==
0){strip.mute=1;m_sfx.mute(null,true)}else{strip.mute=0;m_sfx.mute(null,false)}}function is_other_solo(strip){for(var i=0;i<_mixer_strips.length;i++){var strip_i=_mixer_strips[i];if(strip_i!=strip&&strip_i.solo==1)return true}return false}function mute_other(strip){for(var i=0;i<_mixer_strips.length;i++){var strip_i=_mixer_strips[i];if(strip_i!=strip&&strip_i.mute==0&&strip_i.solo==0)m_sfx.mute(strip_i.speaker,true)}}function unmute_other(strip){for(var i=0;i<_mixer_strips.length;i++){var strip_i=
_mixer_strips[i];if(strip_i!=strip&&strip_i.mute==0&&strip_i.solo==0)m_sfx.mute(strip_i.speaker,false)}}function switch_solo(){var strip=_mixer_strips[_active_strip];if(!strip)return;if(strip.solo>=0)flip_strip_solo(strip)}function flip_strip_solo(strip){if(strip.solo==0){strip.solo=1;m_sfx.mute(strip.speaker,false);if(strip.mute==1)strip.mute=0;mute_other(strip)}else{strip.solo=0;if(is_other_solo(strip))m_sfx.mute(strip.speaker,true);else unmute_other(strip)}}function draw(){if(!_mixer_strips[_active_strip])return;
var strip_range=active_strip_range();for(var i=strip_range[0];i<=strip_range[1];i++){var strip=_mixer_strips[i];m_hud.draw_mixer_strip(strip.id,i==_active_strip,i%8,strip.params,strip.active_param,strip.mute,strip.solo);if(strip.speaker&&m_sfx.get_filter_params(strip.speaker)){m_sfx.get_filter_freq_response(strip.speaker,_filter_freq_arr,_filter_mag_arr,_filter_phase_arr);for(var j=0;j<_filter_mag_arr.length;j++){var mag=_filter_mag_arr[j];_filter_mag_arr[j]=20*Math.log(mag)/Math.LN10}m_hud.plot_array("EQ",
i%8,_filter_mag_arr,20,2E4,-10,10)}}}function active_strip_range(){if(_mixer_strips.length==0)return[0,-1];var strip_low=Math.floor(_active_strip/8)*8;var strip_high=strip_low+7;strip_low=m_util.clamp(strip_low,0,_mixer_strips.length-1);strip_high=m_util.clamp(strip_high,0,_mixer_strips.length-1);return[strip_low,strip_high]}};b4w.module["npc_ai"]=function(exports,require){var m_anim=require("animation");var m_ctl=require("controls");var m_main=require("main");var m_quat=require("quat");var m_scs=require("scenes");var m_trans=require("transform");var m_util=require("util");var m_vec3=require("vec3");var _ev_tracks=[];var _mat3_tmp=new Float32Array(9);var _vec3_tmp=new Float32Array(3);var _vec3_tmp_2=new Float32Array(3);var _vec3_tmp_3=new Float32Array(3);var _vec3_tmp_4=new Float32Array(3);var _quat4_tmp=new Float32Array(4);
var _quat4_tmp_2=new Float32Array(4);var _quat4_tmp_3=new Float32Array(4);var NT_WALKING=exports.NT_WALKING=10;var NT_FLYING=exports.NT_FLYING=20;var NT_SWIMMING=exports.NT_SWIMMING=30;var MS_IDLE=10;var MS_MOVING=20;var NPC_MAX_ACTIVITY_DISTANCE=100;exports.new_event_track=function(graph){graph.destination=new Float32Array(3);graph.start=[];graph.ended=[];graph.fired=[];graph.y_correction=null;graph.prev_hit_pos=null;graph.y_cor_water=null;graph.reached=true;graph.rotation_mult=1;if(!graph.random)for(var i=
0;i<graph.path.length;i++){graph.start[i]=-1;graph.ended[i]=false;graph.fired[i]=false}_ev_tracks.push(graph)};function run_track(elapsed,ev_track){var destination=ev_track.destination;var base_pos=_vec3_tmp;m_trans.get_translation(ev_track.empty,base_pos);var current_loc=_vec3_tmp_2;m_trans.get_translation(ev_track.collider,current_loc);var y_correction=0;if(ev_track.y_cor_water)y_correction=ev_track.y_cor_water;else if(ev_track.y_correction){y_correction=ev_track.y_correction;if(ev_track.type==
NT_WALKING)y_correction*=.5;if(ev_track.type==NT_SWIMMING)y_correction*=elapsed}switch(ev_track.type){case NT_WALKING:if(ev_track.random&&ev_track.reached){destination[0]=(Math.random()*12-6)*ev_track.speed+base_pos[0];destination[2]=(Math.random()*12-6)*ev_track.speed+base_pos[2];move_destination_if_too_close(ev_track,destination,current_loc);ev_track.reached=false}destination[1]=current_loc[1];if(y_correction)destination[1]+=y_correction;break;case NT_FLYING:case NT_SWIMMING:if(ev_track.random&&
ev_track.reached){if(ev_track.type==NT_SWIMMING){ev_track.speed=Math.random()+.1;var magnitude=ev_track.max_depth-ev_track.min_depth}else var magnitude=ev_track.max_height-ev_track.min_height;var rot_speed=ev_track.rot_speed;destination[0]=Math.random()*10-5+base_pos[0];destination[1]=current_loc[1]+(Math.random()*magnitude-.5*magnitude);destination[2]=Math.random()*10-5+base_pos[2];ev_track.reached=false}if(y_correction)destination[1]=current_loc[1]+y_correction;break}anim_translation(elapsed,ev_track)}
function move_destination_if_too_close(ev_track,dest,cur_loc){var cur_rot_q=_quat4_tmp_2;var cur_hor_dir=_vec3_tmp_3;var speed=ev_track.speed;var rot_speed=ev_track.rot_speed;m_trans.get_rotation(ev_track.collider,cur_rot_q);m_vec3.transformQuat(m_util.AXIS_Z,cur_rot_q,cur_hor_dir);cur_hor_dir[1]=0;m_vec3.normalize(cur_hor_dir,cur_hor_dir);var sin_half_rot_angle=Math.sin(rot_speed/2);var walk_radius=.5*speed/sin_half_rot_angle;var dist=m_vec3.dist(dest,cur_loc);if(dist<2*walk_radius)m_vec3.scaleAndAdd(dest,
cur_hor_dir,2*walk_radius-dist,dest)}function anim_translation(elapsed,ev_track){var cur_loc=_vec3_tmp;var cur_dir=_vec3_tmp_2;var new_hor_dir=_vec3_tmp_3;var new_rot_q=_quat4_tmp_3;var rig=ev_track.rig;var collider=ev_track.collider;var dest=ev_track.destination;var speed=ev_track.speed;var actions=ev_track.actions;var cur_anim=m_anim.get_current_anim_name(rig);if(m_anim.is_play(rig)&&actions.idle&&actions.idle.indexOf(cur_anim)!=-1)return;m_trans.get_translation(collider,cur_loc);var delta_x=dest[0]-
cur_loc[0];var delta_z=dest[2]-cur_loc[2];var left_to_pass=Math.sqrt(delta_x*delta_x+delta_z*delta_z);if(left_to_pass>2*speed*elapsed){ev_track.state=MS_MOVING;m_util.xz_direction(dest,cur_loc,new_hor_dir);dest_anim_correction(ev_track,dest,left_to_pass,new_hor_dir);hor_rot(ev_track,cur_dir,elapsed,new_rot_q,new_hor_dir);vert_rot(ev_track,cur_dir,elapsed,new_rot_q);m_trans.set_rotation_v(collider,new_rot_q);trans_obj(elapsed,new_rot_q,ev_track,cur_loc,dest)}else if(ev_track.type==NT_WALKING)if(!actions.move){ev_track.state=
MS_IDLE;ev_track.reached=true}else if(cur_anim&&actions.move.indexOf(cur_anim)!=-1&&m_anim.is_play(rig))ev_track.state=MS_MOVING;else{ev_track.state=MS_IDLE;ev_track.reached=true}else if(ev_track.type==NT_SWIMMING||ev_track.type==NT_FLYING)ev_track.reached=true;if(need_proper_animation(ev_track))apply_animation(ev_track)}function hor_rot(ev_track,cur_dir,elapsed,new_rot_q,new_hor_dir){var cur_rot_q=_quat4_tmp_2;var cur_hor_dir=_vec3_tmp_4;m_trans.get_rotation(ev_track.collider,cur_rot_q);m_vec3.transformQuat(m_util.AXIS_Z,
cur_rot_q,cur_dir);cur_hor_dir[0]=cur_dir[0];cur_hor_dir[1]=0;cur_hor_dir[2]=cur_dir[2];m_vec3.normalize(cur_hor_dir,cur_hor_dir);var vec_dot=m_vec3.dot(cur_hor_dir,new_hor_dir);var angle_to_turn=Math.acos(vec_dot);var angle_ratio=Math.abs(angle_to_turn)/Math.PI;var slerp=elapsed/angle_ratio*ev_track.rot_speed*ev_track.rotation_mult;m_quat.rotationTo(cur_hor_dir,new_hor_dir,new_rot_q);m_quat.rotationTo(m_util.AXIS_Z,cur_hor_dir,cur_rot_q);if(Math.abs(vec_dot)>=1){m_quat.copy(cur_rot_q,new_rot_q);
return}m_quat.multiply(new_rot_q,cur_rot_q,new_rot_q);m_quat.slerp(cur_rot_q,new_rot_q,Math.min(slerp,1),new_rot_q)}function vert_rot(ev_track,cur_dir,elapsed,new_rot_q){if(ev_track.type==NT_FLYING)return;elapsed=Math.max(elapsed,1/60);var new_vert_q=_quat4_tmp;var cur_vert_q=_quat4_tmp_2;var cur_vert_angle=Math.asin(cur_dir[1]);m_quat.setAxisAngle(m_util.AXIS_X,-cur_vert_angle,cur_vert_q);var delta_hor_dist=ev_track.speed*elapsed;var delta_vert_dist=ev_track.y_correction;var new_vert_angle=Math.atan(delta_vert_dist/
delta_hor_dist);m_quat.setAxisAngle(m_util.AXIS_X,-new_vert_angle,new_vert_q);m_quat.slerp(cur_vert_q,new_vert_q,elapsed,new_vert_q);m_quat.multiply(new_rot_q,new_vert_q,new_rot_q)}function trans_obj(elapsed,new_rot_q,ev_track,cur_loc,dest){var new_dir=_vec3_tmp_3;var new_loc=_vec3_tmp_4;var def_dir=m_util.AXIS_Z;m_util.quat_to_dir(new_rot_q,def_dir,new_dir);m_vec3.scale(new_dir,ev_track.speed*elapsed,new_loc);m_vec3.add(new_loc,cur_loc,new_loc);if(ev_track.type!=NT_WALKING)new_loc[1]=(dest[1]-cur_loc[1])*
elapsed*.1+cur_loc[1];else new_loc[1]=dest[1];m_trans.set_translation_v(ev_track.collider,new_loc)}exports.enable_animation=function(){if(!_ev_tracks.length)return;create_sensors();var elapsed_cb=function(obj,id,pulse){if(pulse==1){var elapsed=m_ctl.get_sensor_value(obj,id,0);for(var i=0;i<_ev_tracks.length;i++)process_event_track(_ev_tracks[i],elapsed)}};var elapsed_sensor=m_ctl.create_elapsed_sensor();m_ctl.create_sensor_manifold(_ev_tracks[0].collider,"ELAPSED",m_ctl.CT_CONTINUOUS,[elapsed_sensor],
function(s){return s[0]},elapsed_cb)};exports.disable_animation=function(){if(_ev_tracks.length<=0)return;for(var i=0;i<_ev_tracks.length;i++){var ev=_ev_tracks[i];if(m_ctl.check_sensor_manifolds(ev.collider))m_ctl.remove_sensor_manifold(ev.collider);if(m_anim.is_play(ev.rig))m_anim.stop(ev.rig)}};function elapsed_cb(obj,id,pulse){if(pulse==1)for(var i=0;i<_ev_tracks.length;i++){var elapsed=m_ctl.get_sensor_value(obj,id,0);process_event_track(_ev_tracks[i],elapsed)}}function process_event_track(ev_track,
elapsed){if(!m_scs.is_visible(ev_track.obj))return;if(ev_track.random)run_track(elapsed,ev_track);else{var focus_time=m_main.global_timeline();for(var j=0;j<ev_track.path.length;j++){if(ev_track.ended[j])continue;if(!ev_track.fired[j]){ev_track.fired[j]=true;ev_track.destination[0]=ev_track.path[j][0];ev_track.destination[1]=ev_track.path[j][1];ev_track.destination[2]=ev_track.path[j][2];ev_track.start[j]=focus_time+ev_track.delay[j]}if(focus_time<ev_track.start[j])break;run_track(elapsed,ev_track);
ev_track.ended[j]=ev_track.reached;break}if(is_all_ended(ev_track))unset_all_fired(ev_track)}}function unset_all_fired(track){for(var i=0;i<track.path.length;i++){track.fired[i]=false;track.ended[i]=false}}function is_all_ended(track){for(var i=0;i<track.path.length;i++)if(track.ended[i]==false)return false;return true}function ground_cb(obj,id,pulse,ev){if(!ev)return;if(pulse==1){var hit_pos;switch(ev.type){case NT_FLYING:hit_pos=100*flying_npc_hit_position(obj,id);if(hit_pos<ev.min_height)ev.y_correction=
10;else if(hit_pos>ev.max_height)ev.y_correction=-10;else ev.y_correction=0;break;case NT_WALKING:hit_pos=m_ctl.get_sensor_payload(obj,id,0).hit_fract;if(ev.prev_hit_pos==hit_pos)ev.y_correction=0;else ev.y_correction=1-hit_pos*100;ev.prev_hit_pos=hit_pos;break;case NT_SWIMMING:hit_pos=m_ctl.get_sensor_payload(obj,id,0).hit_fract;if(id=="CLOSE_GROUND"){ev.y_correction=hit_pos*100-1;if(ev.y_correction<.1)ev.y_correction=.05;else ev.y_correction=0}else if(id=="CLOSE_WATER"){ev.y_cor_water=hit_pos*100;
if(ev.y_cor_water<ev.min_depth)ev.y_cor_water=-.02;else if(ev.y_cor_water>ev.max_depth)ev.y_cor_water=.02;else ev.y_cor_water=0}break}}else ev.y_correction=0}function flying_npc_hit_position(obj,id){for(var i=0;i<3;i++){var hit_pos=m_ctl.get_sensor_payload(obj,id,i).hit_fract;if(hit_pos)return hit_pos}}function create_sensors(){for(var i=0;i<_ev_tracks.length;i++){var ev_track=_ev_tracks[i];create_track_ray_sensors(ev_track);create_track_collision_sensors(ev_track);if(ev_track.rig&&m_anim.get_current_anim_name(ev_track.rig))m_anim.play(ev_track.rig)}}
function create_track_ray_sensors(ev_track){var ZERO_POINT=m_vec3.create();var collider=ev_track.collider;switch(ev_track.type){case NT_FLYING:var near_ground_sens=m_ctl.create_ray_sensor(collider,ZERO_POINT,[0,-100,0],"TERRAIN",true);var near_stone_sens=m_ctl.create_ray_sensor(collider,ZERO_POINT,[0,-100,0],"STONE",true);var near_water_sens=m_ctl.create_ray_sensor(collider,ZERO_POINT,[0,-100,0],"WATER",true);var ground_sens_arr=[near_ground_sens,near_stone_sens,near_water_sens];m_ctl.create_sensor_manifold(collider,
"CLOSE_GROUND",m_ctl.CT_CONTINUOUS,ground_sens_arr,function(s){return s[0]||s[1]||s[2]},ground_cb,ev_track);break;case NT_WALKING:var near_ground_sens=m_ctl.create_ray_sensor(collider,[0,1,0],[0,-99,0],"TERRAIN",true);var ground_sens_arr=[near_ground_sens];m_ctl.create_sensor_manifold(collider,"CLOSE_GROUND",m_ctl.CT_CONTINUOUS,ground_sens_arr,null,ground_cb,ev_track);break;case NT_SWIMMING:var near_ground_sens=m_ctl.create_ray_sensor(collider,[0,1,0],[0,-99,0],"TERRAIN",true);var near_water_sens=
m_ctl.create_ray_sensor(collider,ZERO_POINT,[0,100,0],"WATER",true);var ground_sens_arr=[near_ground_sens];var water_sens_arr=[near_water_sens];m_ctl.create_sensor_manifold(collider,"CLOSE_WATER",m_ctl.CT_CONTINUOUS,water_sens_arr,null,ground_cb,ev_track);m_ctl.create_sensor_manifold(collider,"CLOSE_GROUND",m_ctl.CT_CONTINUOUS,ground_sens_arr,null,ground_cb,ev_track);break}}function create_track_collision_sensors(ev_track){var collider=ev_track.collider;if(ev_track.type!=NT_WALKING)return;var need_payload=
false;var collision_sensor=m_ctl.create_collision_sensor(collider,"CONSTRUCTION",need_payload);function collision_cb(obj,id,pulse){if(pulse==1){m_trans.get_translation(ev_track.empty,ev_track.destination);ev_track.rotation_mult=4}else ev_track.rotation_mult=1}m_ctl.create_sensor_manifold(collider,"CONSTRUCTION_COLL",m_ctl.CT_CONTINUOUS,[collision_sensor],null,collision_cb)}function need_proper_animation(ev_track){var obj=ev_track.rig;if(!m_anim.is_play(obj))return true;var cur_anim=m_anim.get_current_anim_name(obj);
if(!cur_anim)return true;var actions=ev_track.actions;switch(ev_track.state){case MS_IDLE:if(!actions.idle)return false;if(actions.idle.indexOf(cur_anim)==-1)return true;break;case MS_MOVING:if(!actions.move)return false;if(actions.move.indexOf(cur_anim)!=-1)return false;if(actions.move_start&&actions.move_start.indexOf(cur_anim)!=-1)return false;if(actions.move_blends&&actions.move_blends.indexOf(cur_anim)!=-1)return false;break;default:return false}return true}function apply_animation(ev_track){var obj=
ev_track.rig;if(m_anim.is_play(obj))return;var anim_to_play=null;switch(ev_track.state){case MS_IDLE:anim_to_play=get_idle_animation(ev_track);break;case MS_MOVING:anim_to_play=get_move_animation(ev_track);break}if(anim_to_play){m_anim.apply(obj,anim_to_play);m_anim.set_behavior(obj,m_anim.AB_FINISH_RESET);m_anim.set_frame(obj,0);m_anim.play(obj)}}function get_idle_animation(ev_track){var actions=ev_track.actions;if(!actions.idle)return null;return m_util.random_from_array(actions.idle)}function get_move_animation(ev_track){var cur_anim=
m_anim.get_current_anim_name(ev_track.rig);var actions=ev_track.actions;if(need_move_blend_animation(ev_track,cur_anim))return get_proper_move_blend_animation(ev_track,cur_anim);if(need_move_animation(ev_track,cur_anim))return get_proper_move_animation(ev_track,cur_anim);if(need_move_start_animation(ev_track,cur_anim))return m_util.random_from_array(actions.move_start);return null}function need_move_animation(ev_track,cur_anim){var actions=ev_track.actions;if(!actions.move)return false;if(actions.move.indexOf(cur_anim)!=
-1)return true;if(!(actions.move_blends||actions.move_start))return true;if(!actions.move_start&&!cur_anim)return true;if(actions.move_blends&&actions.move_blends.indexOf(cur_anim)!=-1)return true;if(actions.move_start&&actions.move_start.indexOf(cur_anim)!=-1)return true;return false}function need_move_blend_animation(ev_track,cur_anim){var actions=ev_track.actions;if(!actions.move_blends)return false;if(actions.move_blends.indexOf(cur_anim)!=-1)return false;if(actions.move&&actions.move.indexOf(cur_anim)!=
-1){var identifier=Math.random();return identifier>.33}return false}function need_move_start_animation(ev_track,cur_anim){var actions=ev_track.actions;if(!actions.move_start)return false;if(actions.move_start.indexOf(cur_anim)!=-1)return false;if(actions.move&&actions.move.indexOf(cur_anim)==-1)return true;return false}function get_proper_move_blend_animation(ev_track,cur_anim){var actions=ev_track.actions;var ind=actions.move.indexOf(cur_anim);return actions.move_blends[ind]}function get_proper_move_animation(ev_track,
cur_anim){var actions=ev_track.actions;if(!actions.move_blends)return m_util.random_from_array(actions.move);var move_blend_anim_ind=actions.move_blends.indexOf(cur_anim);if(move_blend_anim_ind!=-1){var ind=move_blend_anim_ind+1;ind=ind<actions.move.length?ind:0;return actions.move[ind]}if(actions.move.indexOf(cur_anim)!=-1)return cur_anim;else return m_util.random_from_array(actions.move)}function dest_anim_correction(ev_track,dest,l_to_p,new_dir){var obj=ev_track.rig;if(!m_anim.is_animated(obj))return;
var speed=ev_track.speed;var left_to_pass=l_to_p;var cur_frame=m_anim.get_frame(obj);var anim_length=m_anim.get_anim_length(obj);var path_per_cycle=anim_length/24*speed;var left_to_pass_anim=(1-cur_frame/anim_length)*path_per_cycle;var correlation=left_to_pass/left_to_pass_anim;if(correlation<.9){var scale=left_to_pass_anim-left_to_pass;m_vec3.scaleAndAdd(dest,new_dir,scale,dest)}}};b4w.module["mouse"]=function(exports,require){var m_cam=require("camera");var m_cont=require("container");var m_ctl=require("controls");var m_phy=require("physics");var m_print=require("print");var m_scs=require("scenes");var m_util=require("util");var m_main=require("main");var FPS_MOUSE_MULT=4E-4;var DRAG_MOUSE_DELTA_MULT=2;var _smooth_factor=1;var CAM_SMOOTH_CHARACTER_MOUSE=.1;var CAM_SMOOTH_CHARACTER_TOUCH=.2;var PLS_NONE=0;var PLS_POINTERLOCK=1;var PLS_DRAG=2;var _mouse_x=0;var _mouse_y=0;var _mouse_delta=
new Float32Array(2);var _vec2_tmp=new Float32Array(2);var _use_mouse_control_cb=null;var _chosen_object=null;var _plock_state=PLS_NONE;exports.request_pointerlock=function(elem,enabled_cb,disabled_cb,mouse_move_cb,use_mouse_control_cb){if(_plock_state==PLS_POINTERLOCK)return;_plock_state=PLS_POINTERLOCK;enabled_cb=enabled_cb||function(){};disabled_cb=disabled_cb||function(){};use_mouse_control_cb=use_mouse_control_cb||function(){return true};mouse_move_cb=mouse_move_cb||function(e){if(use_mouse_control_cb()){if(typeof e.movementX==
"number"){var mx=e.movementX;var my=e.movementY}else if(typeof e.webkitMovementX=="number"){var mx=e.webkitMovementX;var my=e.webkitMovementY}else if(typeof e.mozMovementX=="number"){var mx=e.mozMovementX;var my=e.mozMovementY}else{var mx=0;var my=0}_mouse_delta[0]+=mx;_mouse_delta[1]+=my}};function on_pointerlock_change(){if(document.pointerLockElement===elem||document.webkitPointerLockElement===elem||document.mozPointerLockElement===elem){exit_mouse_drag(elem);elem.addEventListener("mousemove",
mouse_move_cb,false);var camera=m_scs.get_active_camera();if(!m_ctl.check_sensor_manifold(camera,"SMOOTH_PL")){var elapsed=m_ctl.create_elapsed_sensor();m_ctl.create_sensor_manifold(camera,"SMOOTH_PL",m_ctl.CT_CONTINUOUS,[elapsed],null,smooth_cb)}enabled_cb()}else{elem.removeEventListener("mousemove",mouse_move_cb,false);_plock_state=PLS_NONE;document.removeEventListener("pointerlockchange",on_pointerlock_change,false);document.removeEventListener("webkitpointerlockchange",on_pointerlock_change,false);
document.removeEventListener("mozpointerlockchange",on_pointerlock_change,false);disabled_cb()}}document.addEventListener("pointerlockchange",on_pointerlock_change,false);document.addEventListener("webkitpointerlockchange",on_pointerlock_change,false);document.addEventListener("mozpointerlockchange",on_pointerlock_change,false);var request_plock=elem.requestPointerLock||elem.webkitRequestPointerLock||elem.mozRequestPointerLock;if(typeof request_plock==="function")request_plock.apply(elem);else m_print.error("Pointer lock is not available")};
exports.exit_pointerlock=exit_pointerlock;function exit_pointerlock(){if(_plock_state==PLS_POINTERLOCK)_plock_state=PLS_NONE;var exit_plock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock;if(typeof exit_plock==="function")exit_plock.apply(document);m_ctl.remove_sensor_manifold(m_scs.get_active_camera(),"SMOOTH_PL")}exports.check_pointerlock=function(elem){var request_plock=elem.requestPointerLock||elem.webkitRequestPointerLock||elem.mozRequestPointerLock;if(typeof request_plock===
"function")return true;else return false};exports.request_mouse_drag=request_mouse_drag;function request_mouse_drag(elem,use_mouse_control_cb){if(_plock_state==PLS_DRAG)return;_plock_state=PLS_DRAG;exit_pointerlock();_use_mouse_control_cb=use_mouse_control_cb||function(){return true};elem.addEventListener("mousedown",drag_mouse_down_cb,false);elem.addEventListener("mouseup",drag_mouse_up_cb,false);var camera=m_scs.get_active_camera();if(!m_ctl.check_sensor_manifold(camera,"SMOOTH_DRAG")){var elapsed=
m_ctl.create_elapsed_sensor();m_ctl.create_sensor_manifold(camera,"SMOOTH_DRAG",m_ctl.CT_CONTINUOUS,[elapsed],null,smooth_cb)}}exports.exit_mouse_drag=exit_mouse_drag;function exit_mouse_drag(elem){if(_plock_state==PLS_DRAG)_plock_state=PLS_NONE;elem.removeEventListener("mousedown",drag_mouse_down_cb,false);elem.removeEventListener("mouseup",drag_mouse_up_cb,false);elem.removeEventListener("mousemove",drag_mouse_move_cb,false);m_ctl.remove_sensor_manifold(m_scs.get_active_camera(),"SMOOTH_DRAG")}
function drag_mouse_move_cb(e){if(_use_mouse_control_cb()){_mouse_delta[0]+=(e.clientX-_mouse_x)*DRAG_MOUSE_DELTA_MULT;_mouse_delta[1]+=(e.clientY-_mouse_y)*DRAG_MOUSE_DELTA_MULT;_mouse_x=e.clientX;_mouse_y=e.clientY}e.preventDefault()}function drag_mouse_down_cb(e){_mouse_x=e.clientX;_mouse_y=e.clientY;e.currentTarget.addEventListener("mousemove",drag_mouse_move_cb,false);e.preventDefault()}function drag_mouse_up_cb(e){e.currentTarget.removeEventListener("mousemove",drag_mouse_move_cb,false);e.preventDefault()}
function smooth_cb(obj,id,pulse){if(Math.abs(_mouse_delta[0])>.01||Math.abs(_mouse_delta[1])>.01){var elapsed=m_ctl.get_sensor_value(obj,id,0);var rot_x=m_util.smooth(_mouse_delta[0],0,elapsed,smooth_coeff_mouse());var rot_y=m_util.smooth(_mouse_delta[1],0,elapsed,smooth_coeff_mouse());var character=m_scs.get_first_character();var camera=m_scs.get_active_camera();m_cam.rotate_eye_camera(camera,-rot_x*FPS_MOUSE_MULT,-rot_y*FPS_MOUSE_MULT);_mouse_delta[0]-=rot_x;_mouse_delta[1]-=rot_y;if(character){var angles=
m_cam.get_camera_angles_char(camera,_vec2_tmp);m_phy.set_character_rotation(character,angles[0],angles[1])}}}exports.enable_mouse_hover_outline=enable_mouse_hover_outline;function enable_mouse_hover_outline(){if(!m_main.detect_mobile()){var main_canvas=m_main.get_canvas_elem();main_canvas.addEventListener("mousemove",objects_outline)}}exports.enable_mouse_hover_glow=enable_mouse_hover_glow;function enable_mouse_hover_glow(){m_print.error("enable_mouse_hover_glow() deprecated, use enable_mouse_hover_outline() instead");
enable_mouse_hover_outline()}exports.disable_mouse_hover_outline=disable_mouse_hover_outline;function disable_mouse_hover_outline(){if(!m_main.detect_mobile()){var main_canvas=m_main.get_canvas_elem();main_canvas.removeEventListener("mousemove",objects_outline);if(_chosen_object)m_scs.set_outline_intensity(_chosen_object,0)}}exports.disable_mouse_hover_glow=disable_mouse_hover_glow;function disable_mouse_hover_glow(){m_print.error("disable_mouse_hover_glow() deprecated, use disable_mouse_hover_outline() instead");
disable_mouse_hover_outline()}function objects_outline(e){var canvas_xy=m_cont.client_to_canvas_coords(e.clientX,e.clientY,_vec2_tmp);var obj=m_scs.pick_object(canvas_xy[0],canvas_xy[1]);if(obj){if(m_scs.outlining_is_enabled(obj))m_scs.set_outline_intensity(obj,1);if(m_scs.outlining_is_enabled(_chosen_object)&&obj!=_chosen_object)m_scs.set_outline_intensity(_chosen_object,0)}else if(m_scs.outlining_is_enabled(_chosen_object))m_scs.set_outline_intensity(_chosen_object,0);_chosen_object=obj}exports.get_coords_x=
get_coords_x;function get_coords_x(event){if("clientX"in event)return event.clientX;else if(event.touches&&"clientX"in event.touches[0])return event.touches[0].clientX;else return-1}exports.get_coords_y=get_coords_y;function get_coords_y(event){if("clientY"in event)return event.clientY;else if(event.touches&&"clientY"in event.touches[0])return event.touches[0].clientY;else return-1}function smooth_coeff_mouse(){return CAM_SMOOTH_CHARACTER_MOUSE*_smooth_factor}function smooth_coeff_touch(){return CAM_SMOOTH_CHARACTER_TOUCH*
_smooth_factor}exports.set_plock_smooth_factor=function(value){_smooth_factor=value};exports.get_plock_smooth_factor=function(){return _smooth_factor}};b4w.module["preloader"]=function(exports,require){var m_app=require("app");var _preloader={};var _canvas_container_elem=null;exports.create_simple_preloader=function(options){var canvas_container_id=null;var background_container_id=null;var bar_color="#bf9221";var bg_color="#000";for(var opt in options)switch(opt){case "canvas_container_id":canvas_container_id=options.canvas_container_id;break;case "background_container_id":background_container_id=options.background_container_id;break;case "bg_color":bg_color=
options.bg_color;break;case "bar_color":bar_color=options.bar_color;break;case "preloader_fadeout":_preloader.fadeout=options.preloader_fadeout;break}var container=document.createElement("div");var frame=document.createElement("div");container.id="simple_preloader_container";var bar=document.createElement("div");var caption=document.createElement("div");var background_container=document.getElementById(background_container_id);_canvas_container_elem=document.getElementById(canvas_container_id);container.style.cssText=
"z-index: 4;"+"background-color: "+bg_color+";"+"width: 100%;"+"height: 100%;"+"position: absolute;"+"margin: 0;"+"padding: 0;"+"top: 0;"+"left: 0;";frame.style.cssText="position: absolute;"+"left: 50%;"+"top: 82%;"+"width: 300px;"+"height: 20px;"+"margin-left: -150px;"+"margin-top: -10px;"+"border-style:solid;"+"border-width:4px;"+"border-color: "+"#000"+";"+"border-radius: 0px;";bar.style.cssText="position: absolute;"+"left: 0px;"+"top: 1px;"+"width: 0px;"+"height: 18px;"+"background-color: "+bar_color+
";"+"border-radius: 0px;";caption.style.cssText="position: absolute;"+"left: 50%;"+"top: 50%;"+"width: 100%;"+"height: 100%;"+"margin-left: -150px;"+"margin-top: -10px;"+"text-align: center;"+"font-size: 17px;"+"font-weight: bold;"+"color: #000;"+"font-family: Verdana;"+frame.appendChild(bar);frame.appendChild(caption);container.appendChild(frame);document.body.appendChild(container);_preloader.type="SIMPLE";_preloader.container=container;_preloader.bar=bar;_preloader.caption=caption;_preloader.background=
background_container};exports.create_rotation_preloader=function(options){var canvas_container_id=null;var background_container_id=null;var frame_bg_color="rgba(0,0,0,0)";var frame_class="";var anim_elem_class="";var bg_color="rgba(0,0,0,0)";for(var opt in options)switch(opt){case "canvas_container_id":canvas_container_id=options.canvas_container_id;break;case "background_container_id":background_container_id=options.background_container_id;break;case "frame_bg_color":frame_bg_color=options.frame_bg_color;
break;case "bg_color":bg_color=options.bg_color;break;case "frame_class":frame_class=options.frame_class;break;case "anim_elem_class":anim_elem_class=options.anim_elem_class;break}var container=document.createElement("div");var frame=document.createElement("div");var anim_elem=document.createElement("div");var caption=document.createElement("div");var background_container=document.getElementById(background_container_id);_canvas_container_elem=document.getElementById(canvas_container_id);container.style.cssText=
"z-index: 4;"+"background-color: "+bg_color+";"+"width: 100%;"+"height: 100%;"+"position: absolute;"+"margin: 0;"+"padding: 0;"+"top: 0;"+"left: 0;";frame.style.cssText="position: absolute;"+"left: 50%;"+"top: 50%;"+"width: 117px;"+"height: 117px;"+"margin-left: -58px;"+"margin-top: -58px;"+"background-color: "+frame_bg_color+";";anim_elem.style.cssText="position: absolute;"+"left: 0px;"+"top: 0px;"+"width: 100%;"+"height: 100%;"+"background-position: center;"+"background-repeat: no-repeat;";caption.style.cssText=
"position: absolute;"+"width: 100%;"+"height: 100%;"+"text-align: center;"+"margin-top: 38px;"+"font-size: 36px;"+"color: #ffffff;"+"font-family: Arial;"+"font-weight: bold;";anim_elem.className=anim_elem_class;frame.appendChild(anim_elem);frame.className=frame_class;frame.appendChild(caption);container.appendChild(frame);_canvas_container_elem.appendChild(container);_preloader.type="ROTATION";_preloader.container=container;_preloader.anim_elem=anim_elem;_preloader.caption=caption;_preloader.background=
background_container};exports.create_advanced_preloader=function(options){var img_width=options.img_width;var preloader_width=options.preloader_width;var canvas_container_id=options.canvas_container_id;var preloader_container_id=options.preloader_container_id;var band_width=preloader_width-img_width;var ratio=preloader_width/band_width;var preloader_bar=document.getElementById(options.preloader_bar_id);var fill_band=document.getElementById(options.fill_band_id);var preloader_caption=document.getElementById(options.preloader_caption_id);
var preloader_container=document.getElementById(options.preloader_container_id);var background_container=document.getElementById(options.background_container_id);_canvas_container_elem=document.getElementById(canvas_container_id);_preloader.type="ADVANCED";_preloader.bar=preloader_bar;_preloader.fill=fill_band;_preloader.ratio=ratio;_preloader.caption=preloader_caption;_preloader.container=preloader_container;_preloader.background=background_container};exports.update_preloader=function(percentage){_preloader.caption.innerHTML=
percentage+"%";if(_preloader.type=="SIMPLE")_preloader.bar.style.width=percentage+"%";if(_preloader.type=="ADVANCED"){_preloader.bar.style.width=percentage/_preloader.ratio+"%";_preloader.fill.style.width=100-percentage+"%"}if(_preloader.type=="ROTATION")_preloader.anim_elem.style.transform="rotate("+percentage+"deg)";if(percentage==100)if(_preloader.fadeout){m_app.css_animate(_preloader.background,"opacity",1,0,1500,null,null,function(){_preloader.background.parentNode.removeChild(_preloader.background)});
m_app.css_animate(_preloader.container,"opacity",1,0,1E3,null,null,function(){_preloader.container.parentNode.removeChild(_preloader.container)})}else{_preloader.container.parentNode.removeChild(_preloader.container);if(_preloader.background)_preloader.background.parentNode.removeChild(_preloader.background)}}};b4w.module["storage"]=function(exports,require){var m_print=require("__print");var _prefix="";var _storage=null;exports.init=init;function init(prefix){_prefix=prefix;try{_storage=window.localStorage}catch(e){m_print.warn("Applying chrome localStorage bug workaround");_storage=null}if(!_storage){m_print.warn("localStorage is not available, initializing temporary storage");_storage={}}}exports.set=function(key,value){var b4w_st=get_b4w_storage();b4w_st[key]=String(value);set_b4w_storage(b4w_st)};function get_b4w_storage(){if(_storage[_prefix])return JSON.parse(_storage[_prefix]);
else return{}}function set_b4w_storage(b4w_storage){_storage[_prefix]=JSON.stringify(b4w_storage)}exports.cleanup=function(){delete _storage[_prefix]};exports.get=function(key){var b4w_st=get_b4w_storage();if(b4w_st[key])return b4w_st[key];else return""};exports.debug=function(){m_print.log(get_b4w_storage())};init("b4w")};b4w.module["screenshooter"]=function(exports,require){var m_main=require("main");exports.shot=function(){var cb=function(data){var a=window.document.createElement("a");document.body.appendChild(a);a.style.display="none";a.href=data;a.download="screenshot.png";a.click();document.body.removeChild(a)};m_main.canvas_data_url(cb)}};
