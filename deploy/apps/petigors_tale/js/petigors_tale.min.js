if(b4w.module_check("game_config"))throw"Failed to register module: game_config";
b4w.register("game_config",function(a,b){a.DEFAULT_POS=new Float32Array([0,-4,0]);a.LEVEL_LOAD_DELAY=1.5;a.GEM_OFFSET=new Float32Array([0,1,0]);a.GEM_ROT_OFFSET=new Float32Array([0,0,0,1]);a.GEM_SCALE_OFFSET=.6;a.GM_SPARE=0;a.GM_CARRIED=1;a.GM_LAYING=2;a.SHUTTER_EMITTER_EMPTY="shutter_glass";a.SHUTTER_EMITTER_NAME="glass_shutter_emitter";a.CL_BLUE=0;a.CL_PURPLE=1;a.CL_RED=2;a.CL_GREEN=3;a.CL_YELLOW=4;a.CL_MULTI=5;a.CHAR_EMPTY="petigor";a.CHAR_ARMAT="petigor_armature";a.CHAR_MODEL="petigor_model";
a.CHAR_PICKER="petigor_picker";a.CHAR_LIGHT="sword_light";a.CHAR_SPHERE="lava_shield_prot";a.CHAR_SWORD_SWITCHER="flaming_sword_switcher";a.MOUSE_ROT_MULT=2;a.TOUCH_ROT_MULT=.007;a.CAM_SOFTNESS=.2;a.CAM_OFFSET=new Float32Array([0,8,-15]);a.CHAR_RAY_LENGTH=1.2;a.MAX_CHAR_HP=100;a.CHAR_ATTACK_DIST=2;a.CHAR_ATTACK_STR=35;a.CHAR_ATTACK_ANIM_FRAME=12;a.CH_STILL=0;a.CH_RUN=1;a.CH_ATTACK=2;a.CH_JUMP=3;a.CH_VICTORY=4;a.LAVA_DAMAGE_INTERVAL=.02;a.BONUS_SPAWN_CHANCE=.5;a.BONUS_HP_INCR=30;a.BONUS_SHIELD_TIME=
10;a.BONUS_SHIELD_EFFECT=.33;a.BONUS_LAVA_PROT_TIME=15;a.BONUS_LIFETIME=15;a.BONUS_FLASH_SPEED=3;a.BTYPE_HP=0;a.BTYPE_LAVA=1;a.BTYPE_SHIELD=2;a.CHAR_IDLE_ANIM="petigor_idle_combat";a.CHAR_RUN_ANIM="petigor_run";a.CHAR_STRAFE="petigor_strafe";a.CHAR_JUMP_ANIM="petigor_jump";a.CHAR_DEATH_ANIMS=["petigor_death_01","petigor_death_02"];a.CHAR_ATTACK_ANIMS=["petigor_atack_01","petigor_atack_02","petigor_atack_03"];a.CHAR_VICTORY_ANIM="petigor_victory";a.CHAR_HEAL_PICK_ANIM="heal_pick";a.CHAR_LAVA_PROT_ANIM=
"lava_prot_pick";a.CHAR_SHIELD_PICK_ANIM="shield_pick";a.SHIELD_FLASH_LENGTH=.9;a.LAVA_FALL_LENGTH=1;a.GOLEM_SPEED=.8;a.GOLEM_ROT_SPEED=1;a.GOLEM_ATTACK_DIST=2;a.GOLEM_ATTACK_STRENGTH=20;a.GOLEM_ATTACK_ANIM_FRAME=30;a.GOLEMS_SPAWN_INTERVAL=3;a.GOLEM_HP=100;a.STONE_GOLEMS_SP_MULT=1.5;a.GS_WALKING=0;a.GS_ATTACKING=1;a.GS_GETTING_OUT=2;a.GS_NONE=3;a.EN_TYPE_GOLEM_LAVA=0;a.EN_TYPE_GOLEM_STONE=1;a.GT_POINT=0;a.GT_CHAR=1;a.GT_OBELISK=2;a.GOLEM_LAVA_DEATH_EMPTY=["golem_lava_death"];a.GOLEM_DEATH_RIG=["golem_death_armature"];
a.GOLEM_DEATH_BLOW=["golem_death_blow"];a.STONE_GOLEM_EMITTER_EMPTY="golem_stone_getout";a.STONE_GOLEM_EMITTER=["golem_stone_getout","golem_stone_getout_emitter"];a.HP_BONUSES_EMPTIES=["potion_hp","potion_hp.001","potion_hp.002"];a.SHIELD_BONUSES_EMPTIES=["potion_def"];a.LAVA_BONUSES_EMPTIES=["potion_lava"];a.CAMERA_INDICTAOR=["camera_indicator","camera_indicator"];a.CAM_INDICATOR_VAL="mask_switcher";a.CHAR_RUN_SPEAKER="speaker_petigor_run";a.CHAR_WIN_SPEAKER="character_win_voice";a.CHAR_ATTACK_SPEAKER=
"speaker_petigor_sword_miss";a.CHAR_ATTACK_VOICE_SPKS=["speaker_petigor_voice_atack_01","speaker_petigor_voice_atack_02","speaker_petigor_voice_atack_03"];a.CHAR_HURT_SPKS=["speaker_petigor_voice_hurt_01","speaker_petigor_voice_hurt_02"];a.CHAR_JUMP_SPKS=["speaker_petigor_voice_jump_01","speaker_petigor_voice_jump_02"];a.CHAR_SWORD_SPEAKER="speaker_petigor_sword_hit";a.CHAR_DEATH_SPEAKER="speaker_petigor_voice_death_01";a.CHAR_LANDING_SPEAKER="speaker_petigor_jump_ends";a.GEM_PICKUP_SPEAKER="speaker_petigor_gem_pickup";
a.GEM_MOUNT_SPEAKER="speaker_petigor_gem_mount";a.CHAR_HEAL_SPEAKER="speaker_petigor_bonus_heal";a.CHAR_LAVA_SPEAKER="speaker_petigor_bonus_lava";a.CHAR_SHIELD_SPEAKER="speaker_petigor_bonus_shield";a.GOLEM_WALK_SPEAKER="golem_walk";a.GOLEM_ATTACK_SPEAKER="golem_atack_miss";a.GOLEM_HIT_SPEAKER="golem_atack_hit";a.GOLEM_GETOUT_SPEAKER="golem_getout";a.GEM_DESTR_SPEAKER="gem_destroy";a.WIN_SPEAKER="final_win"});if(b4w.module_check("obelisks"))throw"Failed to register module: obelisks";
b4w.register("obelisks",function(a,b){function E(a){switch(a){case "BG":return r.CL_BLUE;case "RG":return r.CL_RED;case "GG":return r.CL_GREEN;case "YG":return r.CL_YELLOW;case "PG":return r.CL_PURPLE}}function w(){for(var a=0;a<l.NUM_OBELISKS;a++){var g=l.ISLES_SHIELD_DUPLI_NAME_LIST;g[2]="island_shield_"+a;g=n.get_object_by_dupli_name_list(g);A.stop(g);A.set_behavior(g,A.AB_FINISH_STOP)}}function v(a,g){var b="obelisk_"+a,d=x[a];if(0<g){var f=l.OBELISKS_GEMS_NAME[a]+"_0"+(d.num_gems+1),b=n.get_object_by_dupli_name(b,
f);n.show_object(b);y.play_def(m);d.gem_health=l.OBELISK_GEM_HEALTH}else if(0>g){f=l.OBELISKS_GEMS_NAME[a]+"_0"+d.num_gems;b=n.get_object_by_dupli_name(b,f);n.hide_object(b);var f=K,p=z;c.get_translation(b,f);c.get_rotation(b,p);h(f,p)}d.num_gems+=g;G(a)}function G(a){if(q(a)&&("volcano"!=l.LEVEL_NAME||!u.island_has_enemies(a))){var g=x[a];if(l.ISLES_SHIELD_DUPLI_NAME_LIST){var b=l.ISLES_SHIELD_DUPLI_NAME_LIST;b[2]="island_shield_"+a;b=n.get_object_by_dupli_name_list(b);A.play(b);a=n.get_object_by_dupli_name("obelisk_"+
a,l.ISLAND_SPEAKER);y.play_def(a)}g.shine_obj&&(A.set_behavior(g.shine_obj,A.AB_FINISH_STOP),A.play(g.shine_obj));a:{for(g=0;g<l.NUM_OBELISKS;g++)if(!q(g)){g=!1;break a}g=!0}g&&k()}}function h(a,g){var b=n.get_object_by_dupli_name(r.SHUTTER_EMITTER_EMPTY,r.SHUTTER_EMITTER_NAME);c.set_translation_v(b,a);c.set_rotation_v(b,g);n.show_object(b);A.play(b,function(){n.hide_object(b)});var d=n.get_object_by_dupli_name(r.SHUTTER_EMITTER_EMPTY,r.GEM_DESTR_SPEAKER);y.play_def(d)}function k(){var a=n.get_object_by_name(r.WIN_SPEAKER);
y.play_def(a);y.clear_playlist();p.show_victory_element(1);if(l.STAIRS_OBJ){var b=n.get_object_by_name(l.STAIRS_OBJ,l.STAIRS_OBJ),a=n.get_object_by_dupli_name(l.STAIRS_OBJ,l.STAIRS_EMITTER),f=n.get_object_by_dupli_name(l.STAIRS_OBJ,l.STAIRS_MAGIC),d=n.get_object_by_dupli_name_list(l.ISLANDS_DOOR);n.show_object(a);A.apply(a,"dust");A.play(a);n.show_object(f);A.apply_def(f);A.set_behavior(f,A.AB_FINISH_STOP);A.play(f);setTimeout(function(){n.show_object(b);n.hide_object(d)},1E3)}else"dungeon"==l.LEVEL_NAME&&
(a=n.get_object_by_dupli_name("lava_death_controller","lava_death_controller"),A.set_behavior(a,A.AB_FINISH_STOP),A.play(a));g.run_victory()}function q(a){return x[a].num_gems==l.OBELISK_NUM_GEMS}function D(){for(var a=0;a<l.NUM_OBELISKS;a++){x[a].num_gems=0;for(var g=1;g<=l.OBELISK_NUM_GEMS;g++){var b=n.get_object_by_dupli_name("obelisk_"+a,l.OBELISKS_GEMS_NAME[a]+"_0"+g);b&&n.hide_object(b)}switch(l.LEVEL_NAME){case "volcano":g=l.ISLES_SHIELD_DUPLI_NAME_LIST;g[2]="island_shield_"+a;g=n.get_object_by_dupli_name_list(g);
A.set_frame(g,0);g=n.get_object_by_name(l.STAIRS_OBJ);b=n.get_object_by_dupli_name_list(l.ISLANDS_DOOR);n.show_object(b);n.hide_object(g);break;case "dungeon":g=n.get_object_by_dupli_name("level_02_enviroment",l.FLOOR_MAGIC_NAME),f.set_nodemat_value(g,["floor_magic_0"+(a+1),"Value"],0)}}}function B(a){for(var g=0;g<l.NUM_OBELISKS;g++)if(x[g].color==a)return g;return-1}var F=b("controls"),n=b("scenes"),A=b("animation"),y=b("sfx"),c=b("transform"),f=b("objects");b("constraints");var r=b("game_config"),
g=b("character"),u=b("enemies");b("environment");var p=b("interface"),l=null,m=null,K=new Float32Array(3),z=new Float32Array(4),x=[];a.init=function(a,b){l=b;var c=g.get_wrapper();x.length=0;var d=function(a,t,b){1==b&&c.gem_slot&&a.num_gems!=l.OBELISK_NUM_GEMS&&(t=c.gem_slot.color,t==a.color||t==r.CL_MULTI)&&(g.remove_gem(),a=B(a.color),v(a,1))};l.ISLES_SHIELD_DUPLI_NAME_LIST&&w();if(l.FLOOR_MAGIC_NAME)var p=n.get_object_by_dupli_name("level_02_enviroment",l.FLOOR_MAGIC_NAME),u=function(a,t,g,b){g=
b.num_gems/l.OBELISK_NUM_GEMS;var d=b.magic_val;a=F.get_sensor_value(a,t,0);d!=g&&(d<g?b.magic_val+=.25*a:d>g&&(b.magic_val-=.25*a),f.set_nodemat_value(p,["floor_magic_0"+(b.id+1),"Value"],b.magic_val))};for(var k=0;k<l.NUM_OBELISKS;k++){var h="obelisk_"+k,y=n.get_object_by_dupli_name(h,"obelisk_collision"),z=l.OBELISKS_GEMS_NAME[k],K={num_gems:0,gem_health:0,color:E(z),id:k,magic_val:0,shine_obj:null},y=F.create_collision_sensor(y,"CHARACTER");F.create_sensor_manifold(K,"FILL_OBELISK_"+z,F.CT_TRIGGER,
[y],null,d);l.FLOOR_MAGIC_NAME&&(f.set_nodemat_value(p,["floor_magic_0"+(k+1),"Value"],0),F.create_sensor_manifold(p,"FLOOR_MAGIC"+k,F.CT_CONTINUOUS,[a],null,u,K));l.OBELISK_SHINE&&(h=n.get_object_by_dupli_name(h,l.OBELISK_SHINE+"_0"+(k+1)),K.shine_obj=h,A.apply_def(h));x.push(K)}m=n.get_object_by_dupli_name(r.CHAR_EMPTY,r.GEM_MOUNT_SPEAKER);D()};a.try_to_capture=G;a.is_filled=q;a.num_gems=function(a){return x[a].num_gems};a.damage_obelisk=function(a){--x[a].gem_health||(x[a].gem_health=l.OBELISK_GEM_HEALTH,
v(a,-1))};a.reset=D;a.get_id_by_color=B});if(b4w.module_check("gems"))throw"Failed to register module: gems";
b4w.register("gems",function(a,b){function E(a){if(a.state!=k.GM_SPARE)return!1;if(a.color==k.CL_MULTI)return!0;a=q.get_id_by_color(a.color);return!q.is_filled(a)}var w=b("controls"),v=b("scenes");b("sfx");var G=b("transform");b("util");var h=b("constraints");b("vec3");var k=b("game_config"),q=b("obelisks"),D=b("character"),B=null,F=null;a.init=function(a){F=a;B=[];a=function(a,b,f,l){1==f&&D.add_gem(l)};for(var b=0;b<F.GEMS_EMPTIES.length;b++){var h=F.GEMS_EMPTIES[b],c=F.GEMS_NAMES[b],f=v.get_object_by_name(h),
h=v.get_object_by_dupli_name(h,c);if(f&&h){switch(v.get_object_name(h)){case "gem_B":var r=k.CL_BLUE;break;case "gem_R":r=k.CL_RED;break;case "gem_G":r=k.CL_GREEN;break;case "gem_Y":r=k.CL_YELLOW;break;case "gem_P":r=k.CL_PURPLE;break;case "gem_M":r=k.CL_MULTI}f={empty:f,color:r,state:k.GM_SPARE};B.push(f);c=w.create_collision_sensor(h,"CHARACTER");w.create_sensor_manifold(h,"PICK_GEM",w.CT_TRIGGER,[c],null,a,f)}}};a.spawn=function(a){for(var b=0,h=0;h<B.length;h++)E(B[h])&&b++;if(b)for(b=Math.floor(b*
Math.random()),h=0;h<B.length;h++){var c=B[h];if(E(c)&&0==b--){G.set_translation_v(c.empty,a);c.state=k.GM_LAYING;break}}};a.reset=function(){for(var a=0;a<B.length;a++){var b=B[a],y=b.empty;h.remove(y);G.set_translation_v(y,k.DEFAULT_POS);b.state=k.GM_SPARE}}});if(b4w.module_check("interface"))throw"Failed to register module: interface";
b4w.register("interface",function(a,b){function E(a,b){function f(c,m,p){c=l-q.get_timeline();0>c?h.remove_sensor_manifold(null,"SHOW_"+a.id):a.style.opacity=1-c/b}a.style.visibility="visible";if(b){a.style.opacity=0;var l=q.get_timeline()+b;if(!h.check_sensor_manifold(null,"SHOW_"+a.id)){var c=h.create_elapsed_sensor();h.create_sensor_manifold(null,"SHOW_"+a.id,h.CT_CONTINUOUS,[c],null,f)}}else a.style.opacity=1}function w(a,b){function f(p,k,r){p=m-q.get_timeline();0>p?(a.style.visibility="hidden",
h.remove_sensor_manifold(null,"HIDE_"+a.id)):a.style.opacity=p/b*c}if(b){var c=a.style.opacity,m=q.get_timeline()+b;if(!h.check_sensor_manifold(null,"HIDE_"+a.id)){var k=h.create_elapsed_sensor();h.create_sensor_manifold(null,"HIDE_"+a.id,h.CT_CONTINUOUS,[k],null,f)}}else a.style.opacity=0,a.style.visibility="hidden"}var v=b("character"),G=b("game_config"),h=b("controls"),k=b("main"),q=b("time"),D=b("data"),B=b("config");b("mouse");var F=b("container"),n=B.get_std_assets_path()+"petigors_tale/",A=
null,y=null,c=null,f=null,r=null;a.init=function(b,u,p,l,m,K,z){function x(){k.resume();w(J,.5);w(fa);m()}function v(){E(Y)}function q(a){a.preventDefault();a.stopPropagation();E(Z)}function B(){E(T)}function d(){k.resume();D.unload();w(U);w(ha);w(J);w(fa);w(Q);w(aa);w(e);w(ca);E(ga);ja.removeEventListener("mouseup",m);k.detect_mobile()?(document.getElementById("canvas3d").removeEventListener("touchstart",A),document.getElementById("control_jump").removeEventListener("touchstart",y),document.getElementById("control_attack").removeEventListener("touchstart",
c),document.getElementById("canvas3d").removeEventListener("touchmove",f),document.getElementById("canvas3d").removeEventListener("touchend",r),D.load(n+"intro_LQ.json",p,l,!0)):D.load(n+"intro_HQ.json",p,l,!0)}function G(){k.resume();w(J);w(fa);b(u);m()}function I(){w(M);w(O);b(u);m()}function N(){"visible"!=J.style.visibility&&(k.pause(),w(M),E(J),E(fa))}function L(a){a.stopPropagation();a.preventDefault();w(O);w(Q);w(e);w(ca);switch(K){case "level_01":z("level_02");break;case "level_02":z("under_construction")}}
var M=document.getElementById("replay"),Q=document.getElementById("life_bar"),J=document.getElementById("game_menu"),P=document.getElementById("menu_resume"),t=document.getElementById("menu_help"),S=document.getElementById("menu_restart"),C=document.getElementById("menu_exit"),W=document.getElementById("menu_credits"),ca=document.getElementById("control_circle"),e=document.getElementById("controls"),aa=document.getElementById("game_menu_calling"),ba=document.getElementById("next_level"),O=document.getElementById("victory"),
Y=document.getElementById("credits_panel"),Z=document.getElementById("authors_list"),da=document.getElementById("authors_list_exit"),X=document.getElementById("authors_click_area"),T=document.getElementById("help_panel"),ga=document.getElementById("preloader_cont"),U=document.getElementById("back_to_menu"),ha=document.getElementById("under_construct"),fa=document.getElementById("canvas_shadow"),ja=F.get_canvas();k.detect_mobile()?(P.addEventListener("touchstart",x,!1),t.addEventListener("touchstart",
B,!1),C.addEventListener("touchstart",d,!1),W.addEventListener("touchstart",v,!1),X.addEventListener("touchstart",q,!1),S.addEventListener("touchstart",G,!1),M.addEventListener("touchstart",I,!1),O.addEventListener("touchstart",I,!1),Y.addEventListener("touchstart",function(){w(Y)},!1),da.addEventListener("touchstart",function(){w(Z)},!1),T.addEventListener("touchstart",function(){w(T)},!1),ba.addEventListener("touchstart",L,!1),T.setAttribute("mobile","1"),U.addEventListener("touchstart",d,!1),aa.addEventListener("touchstart",
N,!1)):(P.addEventListener("click",x,!1),t.addEventListener("click",B,!1),C.addEventListener("click",d,!1),W.addEventListener("click",v,!1),X.addEventListener("click",q,!1),S.addEventListener("click",G,!1),M.addEventListener("click",I,!1),O.addEventListener("click",I,!1),Y.addEventListener("click",function(){w(Y)},!1),da.addEventListener("click",function(){w(Z)},!1),T.addEventListener("click",function(){w(T)},!1),ba.addEventListener("click",L,!1),T.setAttribute("mobile","0"),U.addEventListener("click",
d,!1),aa.addEventListener("click",N,!1));"under_construction"==K?(U=document.getElementById("back_to_menu"),ha=document.getElementById("under_construct"),E(U),E(ha)):(E(Q),k.detect_mobile()&&E(aa),h.create_kb_sensor_manifold(null,"SHOW_MENU",h.CT_SHOT,h.KEY_ESC,N),a.update_hp_bar())};a.update_hp_bar=function(){var a=v.get_wrapper().hp,b=document.getElementById("life_bar_green"),f=document.getElementById("life_bar_red");document.getElementById("life_bar_mid");var c=100/G.MAX_CHAR_HP,m=Math.max(a*c,
0),a=Math.min((G.MAX_CHAR_HP-a)*c,100);b.style.width=m+"%";f.style.width=a+"%"};a.setup_touch_controls=function(a,b,p,l,m,k,z){function x(a){a.preventDefault();var b=window.innerWidth;a=a.changedTouches;for(var e=0;e<a.length;e++){var t=a[e],g=t.clientX,d=t.clientY;g>b/2?(B[0]=g,B[1]=d,L=t.identifier):(D[0]=g,D[1]=d,F=t.identifier,J.style.left=g-S+"px",J.style.top=d-S+"px",E(J),P.style.left=g-C+"px",P.style.top=d-C+"px",E(P))}}function n(a){a.preventDefault();a=a.changedTouches;for(var b=0;b<a.length;b++){var e=
a[b];h.set_custom_sensor(m,1);M=e.identifier}}function v(a){a.preventDefault();a=a.changedTouches;for(var b=0;b<a.length;b++){var e=a[b];h.set_custom_sensor(k,1);Q=e.identifier}}function q(t){t.preventDefault();h.set_custom_sensor(b,0);h.set_custom_sensor(l,0);h.set_custom_sensor(p,0);h.set_custom_sensor(a,0);var d=window.innerWidth;t=t.changedTouches;for(var e=0;e<t.length;e++){var f=t[e],c=f.clientX,C=f.clientY;if(c>d/2&&f.identifier==L){var m=B[0]-c,f=B[1]-C;B[0]=c;B[1]=C;z(G.TOUCH_ROT_MULT*m,
G.TOUCH_ROT_MULT*f)}else if(f.identifier==F){J.style.left=c-S+"px";J.style.top=C-S+"px";m=c-D[0];f=C-D[1];c=Math.sqrt(m*m+f*f);if(16>c)break;C=m/c;f=-f/c;C>Math.cos(3*Math.PI/8)?h.set_custom_sensor(a,1):C<-Math.cos(3*Math.PI/8)&&h.set_custom_sensor(p,1);f>Math.sin(Math.PI/8)?h.set_custom_sensor(b,1):f<-Math.sin(Math.PI/8)&&h.set_custom_sensor(l,1)}}}function d(t){t.preventDefault();t=t.changedTouches;for(var d=0;d<t.length;d++)t[d].identifier==F?(h.set_custom_sensor(b,0),h.set_custom_sensor(l,0),
h.set_custom_sensor(p,0),h.set_custom_sensor(a,0),w(J),w(P),F=null):t[d].identifier==L?L=null:t[d].identifier==M?(h.set_custom_sensor(m,0),M=null):t[d].identifier==Q&&(h.set_custom_sensor(k,0),Q=null)}var D=new Float32Array(2),B=new Float32Array(2),F,L,M,Q,J=document.getElementById("control_tap"),P=document.getElementById("control_circle"),t=document.getElementById("controls"),S=J.clientWidth/2,C=P.clientWidth/2;document.getElementById("canvas3d").addEventListener("touchstart",x,!1);document.getElementById("control_jump").addEventListener("touchstart",
n,!1);document.getElementById("control_attack").addEventListener("touchstart",v,!1);document.getElementById("canvas3d").addEventListener("touchmove",q,!1);document.getElementById("canvas3d").addEventListener("touchend",d,!1);t.addEventListener("touchend",d,!1);E(t);A=x;y=n;c=v;f=q;r=d};a.show_replay_button=function(a){var b=document.getElementById("replay");E(b,a)};a.hide_replay_button=function(a){var b=document.getElementById("replay");w(b,a)};a.show_victory_element=function(a){var b=document.getElementById("victory");
E(b,a)};a.hide_victory_element=function(a){var b=document.getElementById("victory");w(b,a)};a.show_elem=E});if(b4w.module_check("bonuses"))throw"Failed to register module: bonuses";
b4w.register("bonuses",function(a,b){function E(a){function b(a,g,f,m){if(1==f)switch(G.set_translation_v(m.empty,v.DEFAULT_POS),m.type){case v.BTYPE_HP:D.apply_hp_potion();q.play_def(F);break;case v.BTYPE_LAVA:c<=v.LAVA_FALL_LENGTH&&D.apply_lava_protect();c=v.BONUS_LAVA_PROT_TIME;q.play_def(n);break;case v.BTYPE_SHIELD:y<=v.SHIELD_FLASH_LENGTH&&D.apply_shield(),y=v.BONUS_SHIELD_TIME,q.play_def(A)}}function g(a,b,g,f){a=h.get_sensor_value(a,b,0);f.lifetime-=a;0<f.lifetime?(a=f.lifetime,4<a||(f=f.body,
a*=v.BONUS_FLASH_SPEED,.5<(1>a?a:a%Math.floor(a))?k.hide_object(f):k.show_object(f))):(G.set_translation_v(f.empty,v.DEFAULT_POS),f.is_spawned=!1)}for(var u=0;u<B.length;u++){var p=B[u],l=p.body,m=h.create_collision_sensor(l,"CHARACTER");h.create_sensor_manifold(l,"BONUS",h.CT_TRIGGER,[m],null,b,p);h.create_sensor_manifold(l,"BONUS_LIFETIME",h.CT_CONTINUOUS,[a],null,g,p)}}function w(a,b,g){for(var c=0;c<a.length;c++){var p;p=a[c];var l=b,m=g;p={empty:k.get_object_by_name(p),body:k.get_object_by_dupli_name(p,
m),lifetime:v.BONUS_LIFETIME,type:l,is_spawned:!1};B.push(p)}}var v=b("game_config"),G=b("transform"),h=b("controls"),k=b("scenes"),q=b("sfx"),D=b("character"),B=[],F=null,n=null,A=null,y=0,c=0;new Float32Array(3);a.init=function(a,b){F=k.get_object_by_dupli_name(v.CHAR_EMPTY,v.CHAR_HEAL_SPEAKER);n=k.get_object_by_dupli_name(v.CHAR_EMPTY,v.CHAR_LAVA_SPEAKER);A=k.get_object_by_dupli_name(v.CHAR_EMPTY,v.CHAR_SHIELD_SPEAKER);B.length=0;w(v.HP_BONUSES_EMPTIES,v.BTYPE_HP,"potion_HP");w(v.LAVA_BONUSES_EMPTIES,
v.BTYPE_LAVA,"potion_LAVA");w(v.SHIELD_BONUSES_EMPTIES,v.BTYPE_SHIELD,"potion_SHIELD");E(a);h.create_sensor_manifold(null,"BONUS_TIMER",h.CT_CONTINUOUS,[a],null,function(a,b){var f=h.get_sensor_value(a,b,0);0<y&&(y-f<v.SHIELD_FLASH_LENGTH&&D.remove_shield(),y-=f);0<c&&(c-f<v.LAVA_FALL_LENGTH&&D.remove_lava_protect(),c-=f)})};a.spawn=function(a){for(var b=Math.floor(3*Math.random()),g=0;g<B.length;g++){var c=B[g];if(!c.is_spawned&&c.type==b)return a[1]+=.05,G.set_translation_v(c.empty,a),c.lifetime=
v.BONUS_LIFETIME,c.is_spawned=!0,k.show_object(c.body),!0}return!1};a.reset=function(){for(var a=0;a<B.length;a++)G.set_translation_v(B[a].empty,v.DEFAULT_POS)};a.set_shield_time=function(a){y=a};a.set_lava_protect_time=function(a){c=a};a.lava_protect_time_left=function(){return c};a.shield_time_left=function(){return y}});if(b4w.module_check("enemies"))throw"Failed to register module: enemies";
b4w.register("enemies",function(a,b){function E(a,b){var d=a.empty.name;a.walk_speaker=c.get_object_by_dupli_name(d,m.GOLEM_WALK_SPEAKER);a.attack_speaker=c.get_object_by_dupli_name(d,m.GOLEM_ATTACK_SPEAKER);a.hit_speaker=c.get_object_by_dupli_name(d,m.GOLEM_HIT_SPEAKER);a.getout_speaker=c.get_object_by_dupli_name(d,m.GOLEM_GETOUT_SPEAKER);switch(b){case "lava":a.type=m.EN_TYPE_GOLEM_LAVA;break;case "stone":a.type=m.EN_TYPE_GOLEM_STONE}a.death_anim="golem_death";a.walk_anim="golem_walk";a.atack_anim=
["golem_atack_01","golem_atack_02","golem_atack_03"];a.getout_anim="golem_"+b+"_getout";a.death_empty_name="golem_"+b+"_death";d=g.get_object_bounding_box(a.body);a.height=d.max_y-d.min_y}function w(a,b,C){if(0>=a.hp){b=a.empty;C=c.get_object_by_name(a.death_empty_name);var l=c.get_object_by_dupli_name(a.death_empty_name,m.GOLEM_DEATH_RIG),p=c.get_object_by_dupli_name(a.death_empty_name,m.GOLEM_DEATH_BLOW),e=I,n=M;g.get_translation(b,e);g.get_rotation(b,n);g.set_translation_v(C,e);g.set_rotation_v(C,
n);f.apply(l,a.death_anim);f.set_behavior(l,f.AB_FINISH_STOP);f.play(l);f.play(p);r.stop(a.walk_speaker);g.set_translation_v(b,m.DEFAULT_POS);ea.spawn(e);"volcano"==d.LEVEL_NAME&&(b=a.island_id,a.island_id=-1,x.try_to_capture(b));a.hp=100;F(a,m.GS_NONE)}else if(K.get_wrapper().state!=m.CH_VICTORY)switch(C=y.get_sensor_value(a,b,1),a.dist_to_ground=10*C-a.height/2,a.state){case m.GS_ATTACKING:!a.attack_done&&f.get_frame(a.rig)>=m.GOLEM_ATTACK_ANIM_FRAME&&(a.last_target==m.GT_CHAR?z.check_attack(a.attack_point,
K.get_wrapper().phys_body,m.GOLEM_ATTACK_DIST)&&(b=m.GOLEM_ATTACK_STRENGTH,0<V.shield_time_left()&&(b*=m.BONUS_SHIELD_EFFECT),K.change_hp(-b),r.play_def(a.hit_speaker)):a.last_target==m.GT_OBELISK&&(b=a.island_id,x.num_gems(b)&&x.damage_obelisk(b),r.play_def(a.hit_speaker)),a.attack_done=!0);break;case m.GS_WALKING:b=y.get_sensor_value(a,b,0),C=K.get_wrapper(),"volcano"==d.LEVEL_NAME?(l=a.island_id,C.island==l&&0<C.hp?(h(a,C.phys_body,b),a.last_target=m.GT_CHAR):x.num_gems(l)?(C=c.get_object_by_dupli_name("obelisk_"+
l,"obelisk"),h(a,C,b),a.last_target=m.GT_OBELISK):k(a,b)):"dungeon"==d.LEVEL_NAME?0<C.hp&&z.check_visibility(a,C)&&a.can_see_char?(h(a,C.phys_body,b),a.last_target=m.GT_CHAR):k(a,b):k(a,b)}}function v(a){for(var b=[],f=[],l=[],p=[],e=0;e<d.LAVA_GOLEM_SPAWN_POINTS.length;e++){var h=c.get_object_by_name(d.LAVA_GOLEM_SPAWN_POINTS[e]),k=g.get_translation(h),h=g.get_rotation(h);b.push(k);l.push(h)}if(d.STONE_GOLEM_SPAWN_POINTS)for(e=0;e<d.STONE_GOLEM_SPAWN_POINTS.length;e++)h=c.get_object_by_name(d.STONE_GOLEM_SPAWN_POINTS[e]),
k=g.get_translation(h),h=g.get_rotation(h),f.push(k),p.push(h);y.create_sensor_manifold(null,"GOLEMS_SPAWN",y.CT_CONTINUOUS,[a],null,function(a,e){var g;a:{for(g=0;g<R.length;g++){var c=R[g];if(c.state==m.GS_NONE){g=c;break a}}g=null}if(g&&(c=y.get_sensor_value(a,e,0),J-=c,0>=J)){J=m.GOLEMS_SPAWN_INTERVAL;if("volcano"==d.LEVEL_NAME){if(c=n(),null==c)return}else c=0;g.type==m.EN_TYPE_GOLEM_LAVA?G(g,c,b,l):G(g,c,f,p)}})}function G(a,b,c,f){var l=a.empty,e="volcano"==d.LEVEL_NAME?c.length/d.NUM_OBELISKS:
c.length,h=Math.floor(Math.random()*e),e=e*b+h;c=c[e];f=f[e];g.set_translation_v(l,c);g.set_rotation_v(l,f);F(a,m.GS_GETTING_OUT);r.play_def(a.getout_speaker);"volcano"==d.LEVEL_NAME?(a.island_id=b,p.copy(c,a.dest_pos)):q(a,c)}function h(a,b,d){var c=I,l=N;g.get_translation(a.empty,c);g.get_translation(b,l);l[1]=c[1];p.copy(l,a.dest_pos);b=p.distance(c,l);c=D(a,d);Math.abs(c)<Math.PI/6&&b>=m.GOLEM_ATTACK_DIST?B(a,d):Math.abs(c)<.05*Math.PI&&(d=a.empty,b=a.attack_point,c=I,l=N,a.attack_done=!1,F(a,
m.GS_ATTACKING),g.get_translation(d,c),p.scaleAndAdd(c,l,m.GOLEM_ATTACK_DIST,b),b[1]+=a.height/2,r.is_play(a.walk_speaker)&&r.stop(a.walk_speaker),r.play_def(a.attack_speaker));a.type==m.EN_TYPE_GOLEM_STONE&&(f.set_speed(a.rig,m.STONE_GOLEMS_SP_MULT),a.speed=m.GOLEM_SPEED*m.STONE_GOLEMS_SP_MULT)}function k(a,b){f.set_speed(a.rig,1);a.speed=m.GOLEM_SPEED;var l=a.dest_pos,h=I;g.get_translation(a.empty,h);var k=h[1];h[1]=l[1];l=p.distance(h,l);h[1]=k;if(!(.05<l&&a.last_target==m.GT_POINT)){if("volcano"==
d.LEVEL_NAME)b:{for(var k=a.dest_pos,l=a.dest_point,e=a.island_id,n=d.GOLEM_PATROL_POINTS,x=n.length/d.NUM_OBELISKS,z=Math.random(),r=Math.floor(x*z),v=0,z=0;z<x;z++)if(z!=l&&v++==r){e=c.get_object_by_name(n[x*e+z]);g.get_translation(e,k);k[1]=h[1];a.prev_dest=l;a.dest_point=z;break b}a.dest_point=-1}else a.last_target==m.GT_CHAR?q(a,h):(k=a.dest_pos,l=a.dest_point,e=d.GOLEM_PATROL_POINTS,n=d.GOLEM_PATROL_MAP[l],x=n.length-1,z=Math.random(),n=n[Math.floor(x*z)],e=c.get_object_by_name(e[n]),g.get_translation(e,
k),k[1]=h[1],a.prev_dest=l,a.dest_point=n);a.last_target=m.GT_POINT}h=D(a,b);Math.abs(h)<Math.PI/6&&B(a,b)}function q(a,b){for(var f=d.GOLEM_PATROL_POINTS,l=f.length,m=a.dest_pos,e=1E3,h=-1,k=0;k<l;k++){var n=c.get_object_by_name(f[k]);g.get_translation(n,N);n=p.distance(N,b);n<e&&(e=n,h=k,p.copy(N,m),m[1]=b[1])}a.dest_point=h}function D(a,b){var d=a.empty,c=a.dest_pos,f=I,e=N,h=L,k=M,n=Q;g.get_translation(d,f);g.get_rotation(d,k);p.transformQuat(u.AXIS_Z,k,e);p.subtract(c,f,h);h[1]=0;p.normalize(h,
h);l.rotationTo(e,h,n);l.multiply(n,k,n);c=p.dot(e,h);c=Math.acos(1<c?1:-1>c?-1:c);f=Math.abs(c)/Math.PI;l.slerp(k,n,Math.min(b/f*m.GOLEM_ROT_SPEED,1),n);g.set_rotation_v(d,n);return c}function B(a,b){var c=I,d=N,f=M,e=a.empty,l=a.walk_speaker;g.get_rotation(e,f);g.get_translation(e,c);p.transformQuat(u.AXIS_Z,f,d);p.scaleAndAdd(c,d,a.speed*b,c);d=b/3;c[1]-=a.dist_to_ground>d?d:a.dist_to_ground<-d?-d:d;g.set_translation_v(e,c);r.is_play(l)||(r.play_def(l),r.cyclic(l,!0))}function F(a,b){var c=a.rig;
switch(b){case m.GS_WALKING:f.apply(c,a.walk_anim);f.set_behavior(c,f.AB_CYCLIC);f.play(c);break;case m.GS_ATTACKING:var d=Math.floor(a.atack_anim.length*Math.random());f.apply(c,a.atack_anim[d]);f.play(c,function(){a.state!=m.GS_NONE&&F(a,m.GS_WALKING)});break;case m.GS_GETTING_OUT:f.apply(c,a.getout_anim),f.play(c,function(){a.state!=m.GS_NONE&&F(a,m.GS_WALKING)})}a.state=b}function n(){for(var a=d.NUM_OBELISKS,b=0;b<R.length;b++)A(b)||a--;if(0==a)return null;for(var a=Math.floor(Math.random()*
a),c=0,b=0;b<d.NUM_OBELISKS;b++)if(A(b)&&c++==a)return b;return null}function A(a){if(x.is_filled(a))return!1;for(var b=0;b<R.length;b++)if(R[b].island_id==a)return!1;return!0}var y=b("controls"),c=b("scenes"),f=b("animation"),r=b("sfx"),g=b("transform"),u=b("util"),p=b("vec3"),l=b("quat"),m=b("game_config"),K=b("character"),z=b("combat"),x=b("obelisks"),V=b("bonuses"),ea=b("gems"),H=b("physics"),d=null,R=[],I=new Float32Array(3),N=new Float32Array(3),L=new Float32Array(3),M=new Float32Array(4),Q=
new Float32Array(4),J=0,P=new Float32Array(3);a.init=function(a,b){function f(a,b,c){b=y.get_sensor_value(a,"CHAR_RAY",0);c=y.get_sensor_payload(a,"CHAR_RAY",0);a.can_see_char=0==b?!0:!1;b=c.ray_test_id;c=K.get_wrapper();c=g.get_translation(c.phys_body,I);a=g.get_translation(a.empty,N);H.change_ray_test_from_to(b,a,c)}d=b;J=m.GOLEMS_SPAWN_INTERVAL;for(var l=R.length=0;l<d.GOLEMS_EMPTIES.length;l++){var h=d.GOLEMS_EMPTIES[l],e=c.get_object_by_name(h),k=c.get_object_by_dupli_name(h,"golem_collider"),
h=c.get_object_by_dupli_name(h,"golem_armature");k&&h&&e&&(e={body:k,rig:h,empty:e,height:0,type:m.EN_TYPE_GOLEM_LAVA,view_distance:10,walk_speaker:null,attack_speaker:null,hit_speaker:null,getout_speaker:null,death_empty_name:null,hp:m.GOLEM_HP,speed:m.GOLEM_SPEED,island_id:-1,dest_point:-1,prev_dest:-1,dest_pos:new Float32Array(3),dist_to_ground:0,can_see_char:!1,last_target:m.GT_POINT,state:m.GS_NONE,attack_point:new Float32Array(3),attack_done:!1},h=-1!=k.name.indexOf("lava")?"lava":"stone",E(e,
h),k=y.create_ray_sensor(k,P,[0,-10,0],"GROUND",!1,!1,!0),h=y.create_ray_sensor(null,P,[0,-10,0],"COMMON",!0,!1,!0),y.create_sensor_manifold(e,"CHAR_RAY",y.CT_CONTINUOUS,[h],function(a){return!0},f),y.create_sensor_manifold(e,"GOLEM",y.CT_CONTINUOUS,[a,k],function(a){return!0},w),R.push(e),z.append_enemy(e))}v(a)};a.reset=function(){J=m.GOLEMS_SPAWN_INTERVAL;for(var a=0;a<R.length;a++){var b=R[a];b.island_id=-1;F(b,m.GS_NONE);g.set_translation_v(b.empty,m.DEFAULT_POS);r.stop(b.walk_speaker)}};a.island_has_enemies=
function(a){for(var b=0;b<R.length;b++)if(R[b].island_id==a)return!0;return!1}});if(b4w.module_check("combat"))throw"Failed to register module: combat";
b4w.register("combat",function(a,b){function E(a,b,k){var n=h;w.get_translation(b,n);return v.distance(n,a)<k?!0:!1}var w=b("transform"),v=b("vec3"),G=b("game_config"),h=new Float32Array(3),k=new Float32Array(3),q=[];a.append_enemy=function(a){q.push(a)};a.process_attack_on_enemies=function(a,b){for(var h=0;h<q.length;h++){var k=q[h];if(!(0>=k.hp||k.state==G.GS_NONE)&&E(a,k.empty,b))return k.hp-=G.CHAR_ATTACK_STR,!0}return!1};a.check_attack=E;a.check_visibility=function(a,b){var q=w.get_translation(a.body,
h),n=w.get_translation(b.body,k);return v.distance(q,n)>a.view_distance?!1:!0}});if(b4w.module_check("character"))throw"Failed to register module: character";
b4w.register("character",function(a,b){function E(a){function b(){0<e.hp&&e.state!=d.CH_VICTORY&&(I.show_elem(c),I.show_elem(f),y.pause())}var c=document.getElementById("game_menu"),f=document.getElementById("canvas_shadow");a=ea.get_canvas();0<e.hp&&!y.is_paused()&&e.state!=d.CH_VICTORY&&x.request_pointerlock(a,null,b,null,null,function(a,b){aa(d.MOUSE_ROT_MULT*a,d.MOUSE_ROT_MULT*b)})}function w(){for(var a=function(a,b,c){e.island=1==c?parseInt(b[b.length-1]):-1},b=0;b<L.NUM_OBELISKS;b++){var d=
c.create_collision_sensor(e.picker,"ISLAND"+b);c.create_sensor_manifold(e.picker,"ISLE_COLL"+b,c.CT_TRIGGER,[d],null,a)}}function v(a){var b=c.create_ray_sensor(e.phys_body,[0,0,0],[0,-d.CHAR_RAY_LENGTH,0],"GROUND",!0),f=c.create_ray_sensor(e.phys_body,[0,0,0],[0,-d.CHAR_RAY_LENGTH,0],"LAVA",!0),g=c.create_ray_sensor(e.phys_body,[0,0,0],[0,-d.CHAR_RAY_LENGTH,0],"COMMON",!0);c.create_sensor_manifold(e.phys_body,"GROUND SENS",c.CT_TRIGGER,[b,f,g],function(a){return a[0]||a[1]||a[2]},function(b,e,d){c.set_custom_sensor(a,
1==d?1:0)})}function G(a,b,f,l,h){function k(a,b,f){if(e.state==d.CH_ATTACK)r.set_character_move_dir(a,0,0);else{var g=c.get_sensor_value(a,b,6);if(1==f){switch(b){case "FORWARD":t.forw_back=1;break;case "BACKWARD":t.forw_back=-1;break;case "LEFT":t.left_right=1;break;case "RIGHT":t.left_right=-1}e.state!=d.CH_JUMP&&(e.state=d.CH_RUN)}else{switch(b){case "FORWARD":case "BACKWARD":t.forw_back=0;break;case "LEFT":case "RIGHT":t.left_right=0}e.state!=d.CH_JUMP&&(e.state=d.CH_STILL)}(t.forw_back||t.left_right)&&
g?u.is_play(M)||u.play_def(M):u.is_play(M)&&u.stop(M);r.set_character_move_dir(a,t.forw_back,t.left_right)}}var m=c.create_keyboard_sensor(c.KEY_W),p=c.create_keyboard_sensor(c.KEY_S),n=c.create_keyboard_sensor(c.KEY_UP),x=c.create_keyboard_sensor(c.KEY_DOWN),z=c.create_keyboard_sensor(c.KEY_A),C=c.create_keyboard_sensor(c.KEY_D);a=[m,n,a,p,x,b,h,z,f,C,l];var t=e.move_state;c.create_sensor_manifold(e.phys_body,"FORWARD",c.CT_CONTINUOUS,a,function(a){return a[0]||a[1]||a[2]},k);c.create_sensor_manifold(e.phys_body,
"BACKWARD",c.CT_CONTINUOUS,a,function(a){return a[3]||a[4]||a[5]},k);c.create_sensor_manifold(e.phys_body,"LEFT",c.CT_CONTINUOUS,a,function(a){return a[7]||a[8]},k);c.create_sensor_manifold(e.phys_body,"RIGHT",c.CT_CONTINUOUS,a,function(a){return a[9]||a[10]},k);c.create_sensor_manifold(e.phys_body,"CHAR_ANIM",c.CT_CONTINUOUS,[h],function(a){return!0},function(a,b,f){e.state!=d.CH_ATTACK&&(c.get_sensor_value(a,b,0),a=g.get_current_anim_name(e.rig),b=d.CHAR_IDLE_ANIM,e.state==d.CH_JUMP?b=d.CHAR_JUMP_ANIM:
1==t.forw_back?b=d.CHAR_RUN_ANIM:-1==t.forw_back?(b=d.CHAR_RUN_ANIM,g.set_speed(e.rig,-1)):1==t.left_right?(b=d.CHAR_STRAFE,g.set_speed(e.rig,-1)):-1==t.left_right&&(b=d.CHAR_STRAFE),a!=b&&(g.apply(e.rig,b),g.play(e.rig),g.set_behavior(e.rig,g.AB_CYCLIC)))});e.body&&(g.apply(e.body,d.CHAR_HEAL_PICK_ANIM),g.apply(e.body,d.CHAR_LAVA_PROT_ANIM,g.SLOT_1),g.apply(e.body,d.CHAR_SHIELD_PICK_ANIM,g.SLOT_2));u.stop(M)}function h(a,b){var f=c.create_keyboard_sensor(c.KEY_SPACE);c.create_sensor_manifold(e.phys_body,
"JUMP",c.CT_TRIGGER,[f,a,b],function(a){return(a[0]||a[1])&&a[2]},function(a,b,c){1==c&&e.state!=d.CH_ATTACK&&(e.state=d.CH_JUMP,r.character_jump(a),b=Math.floor(C.length*Math.random()),u.play_def(C[b]),g.apply(e.rig,d.CHAR_JUMP_ANIM),g.set_behavior(e.rig,g.AB_FINISH_STOP),g.play(e.rig),e.move_state.forw_back=0,e.move_state.left_right=0)});c.create_sensor_manifold(e.phys_body,"LANDING",c.CT_TRIGGER,[b],null,function(a,b,c){1==c&&(u.play_def(P),e.state!=d.CH_ATTACK&&(e.state=d.CH_STILL))})}function k(a,
b){function f(a){g.apply(e.rig,d.CHAR_IDLE_ANIM);g.set_behavior(e.rig,g.AB_CYCLIC);g.play(e.rig);e.state=d.CH_STILL}var h=c.create_mouse_click_sensor(),k=!1;c.create_sensor_manifold(e.phys_body,"ATTACK",c.CT_TRIGGER,[h,a],function(a){return a[0]||a[1]},function(a,b,c){1==c&&e.state!=d.CH_ATTACK&&(e.state=d.CH_ATTACK,e.move_state.forw_back=0,e.move_state.left_right=0,a=Math.floor(ba.length*Math.random()),g.apply(e.rig,ba[a]),g.set_behavior(e.rig,g.AB_FINISH_STOP),g.play(e.rig,f),r.set_character_move_dir(e.phys_body,
0,0),k=!1,u.is_play(M)&&u.stop(M),u.play_def(Q),a=Math.floor(W.length*Math.random()),u.play_def(W[a]))});c.create_sensor_manifold(e.phys_body,"DAMAGE_GOLEMS",c.CT_CONTINUOUS,[b],null,function(a,b,c){if(e.state==d.CH_ATTACK&&!k&&g.get_frame(e.rig)>=d.CHAR_ATTACK_ANIM_FRAME){a=X;b=T;c=ga;var f=U,h=d.CHAR_ATTACK_DIST;l.get_translation(e.phys_body,a);l.get_rotation(e.phys_body,f);K.transformQuat(m.AXIS_Z,f,b);K.scaleAndAdd(a,b,h,c);R.process_attack_on_enemies(c,h)&&(u.play_def(J),g.play(e.hitsparks));
k=!0}})}function q(){c.check_sensor_manifolds(e.phys_body)&&c.remove_sensor_manifold(e.phys_body);r.set_character_move_dir(e.phys_body,0,0);u.stop(M);ea.get_canvas();y.detect_mobile()||x.exit_pointerlock()}function D(){var a=0;c.create_sensor_manifold(e.phys_body,"CHAR_HURT",c.CT_CONTINUOUS,[c.create_elapsed_sensor()],null,function(){var b=Math.max(Y-p.get_timeline()+1,0);b==a&&0==a?a=b:(a=b,H.set_nodemat_value(Z,["camera_indicator",d.CAM_INDICATOR_VAL],b))})}function B(){N.set_lava_protect_time(0);
H.set_nodemat_value(e.lava_shield_prot,["lava_shield_prot","lava_prot_switcher"],0)}function F(){N.set_shield_time(0);H.set_nodemat_value(e.lava_shield_prot,["lava_shield_prot","shield_switcher"],0)}function n(a){if(!(0>=e.hp)){var b=p.get_timeline();if(0>a&&Y<b-.5){var c=Math.floor(ca.length*Math.random());u.play_def(ca[c]);Y=b}e.hp+=a;e.hp=Math.min(e.hp,d.MAX_CHAR_HP);0>=e.hp&&(q(),L.MUSIC_SPEAKERS&&(u.clear_playlist(),a=f.get_object_by_dupli_name_list(L.MUSIC_INTRO_SPEAKER),b=f.get_object_by_dupli_name_list(L.MUSIC_END_SPEAKER),
u.stop(a),u.play_def(b)),a=f.get_object_by_dupli_name(d.CHAR_EMPTY,d.CHAR_DEATH_SPEAKER),u.play_def(a),a=Math.floor(O.length*Math.random()),g.apply(e.rig,O[a]),g.set_behavior(e.rig,g.AB_FINISH_STOP),g.play(e.rig),I.show_replay_button(1),e.gem_slot&&A(),0<N.shield_time_left()&&F(),0<N.lava_protect_time_left()&&B(),H.set_nodemat_value(Z,["camera_indicator",d.CAM_INDICATOR_VAL],1));I.update_hp_bar()}}function A(){var a=e.gem_slot.empty;z.remove(a);l.set_translation_v(a,d.DEFAULT_POS);l.set_scale(a,1);
e.gem_slot.state=d.GM_SPARE;e.gem_slot=null}var y=b("main"),c=b("controls"),f=b("scenes"),r=b("physics"),g=b("animation"),u=b("sfx"),p=b("time"),l=b("transform"),m=b("util"),K=b("vec3"),z=b("constraints"),x=b("mouse"),V=b("camera"),ea=b("container"),H=b("objects");b("quat");var d=b("game_config"),R=b("combat"),I=b("interface"),N=b("bonuses");b("environment");var L=null,M=null,Q=null,J=null,P=null,t=null,S=null,C=[],W=[],ca=[],e=null,aa=null,ba=[],O=[],Y=-100,Z=null,da=new Float32Array(2),X=new Float32Array(3),
T=new Float32Array(3),ga=new Float32Array(3),U=new Float32Array(4);a.init_wrapper=function(a,b){L=a;e={phys_body:f.get_first_character(),rig:f.get_object_by_dupli_name(d.CHAR_EMPTY,d.CHAR_ARMAT),body:f.get_object_by_dupli_name(d.CHAR_EMPTY,d.CHAR_MODEL),picker:f.get_object_by_dupli_name(d.CHAR_EMPTY,d.CHAR_PICKER),target:f.get_object_by_dupli_name(d.CHAR_EMPTY,"camera_target"),lava_shield_prot:f.get_object_by_dupli_name(d.CHAR_EMPTY,d.CHAR_SPHERE),hitsparks:f.get_object_by_dupli_name(d.CHAR_EMPTY,
"sword_hitsparks_emitter"),foot_smoke:f.get_object_by_dupli_name(d.CHAR_EMPTY,"foots_smoke_emitter"),hp:d.MAX_CHAR_HP,state:d.CH_STILL,move_state:{forw_back:0,left_right:0},gem_slot:null,island:-1};g.apply_def(e.hitsparks);g.set_behavior(e.hitsparks,g.AB_FINISH_RESET);H.set_nodemat_value(e.lava_shield_prot,["lava_shield_prot","lava_prot_switcher"],0);H.set_nodemat_value(e.lava_shield_prot,["lava_shield_prot","shield_switcher"],0);f.hide_object(e.foot_smoke);a&&"dungeon"==a.LEVEL_NAME&&H.set_nodemat_value(e.body,
["petigor",d.CHAR_SWORD_SWITCHER],1);C.length=0;W.length=0;ca.length=0;ba.length=0;O.length=0;M=f.get_object_by_dupli_name(d.CHAR_EMPTY,d.CHAR_RUN_SPEAKER);Q=f.get_object_by_dupli_name(d.CHAR_EMPTY,d.CHAR_ATTACK_SPEAKER);J=f.get_object_by_dupli_name(d.CHAR_EMPTY,d.CHAR_SWORD_SPEAKER);P=f.get_object_by_dupli_name(d.CHAR_EMPTY,d.CHAR_LANDING_SPEAKER);S=f.get_object_by_dupli_name(d.CHAR_EMPTY,d.CHAR_WIN_SPEAKER);t=f.get_object_by_dupli_name(d.CHAR_EMPTY,d.GEM_PICKUP_SPEAKER);u.cyclic(S,!0);for(var c=
0;c<d.CHAR_JUMP_SPKS.length;c++){var l=f.get_object_by_dupli_name(d.CHAR_EMPTY,d.CHAR_JUMP_SPKS[c]);C.push(l)}for(c=0;c<d.CHAR_ATTACK_VOICE_SPKS.length;c++)l=f.get_object_by_dupli_name(d.CHAR_EMPTY,d.CHAR_ATTACK_VOICE_SPKS[c]),W.push(l);for(c=0;c<d.CHAR_HURT_SPKS.length;c++)l=f.get_object_by_dupli_name(d.CHAR_EMPTY,d.CHAR_HURT_SPKS[c]),ca.push(l);for(c=0;c<d.CHAR_ATTACK_ANIMS.length;c++)ba.push(d.CHAR_ATTACK_ANIMS[c]);for(c=0;c<d.CHAR_DEATH_ANIMS.length;c++)O.push(d.CHAR_DEATH_ANIMS[c]);D()};a.setup_controls=
function(a){function b(a,c){r.character_rotation_inc(e.phys_body,a,0);c&&(V.eye_rotate(q,0,c),V.get_camera_angles(q,X),A[2]=-u*Math.cos(X[1]),A[1]=-u*Math.sin(X[1]),z.append_semi_stiff_cam(q,e.target,A,null,0,0,B,.01))}L&&"volcano"==L.LEVEL_NAME&&w();var g=c.create_custom_sensor(0),m=c.create_custom_sensor(0),p=c.create_custom_sensor(0),n=c.create_custom_sensor(0),t=c.create_custom_sensor(0),x=c.create_custom_sensor(0),C=c.create_custom_sensor(0);v(C);var q=f.get_active_camera(),A=new Float32Array(d.CAM_OFFSET),
u=K.length(A),B=Math.PI/3;aa=b;y.detect_mobile()?I.setup_touch_controls(g,p,m,n,t,x,b):ea.get_canvas().addEventListener("mouseup",E,!1);G(p,n,m,g,C);h(t,C);k(x,a);a=l.get_translation(e.target,X);z.append_semi_stiff_cam(q,e.target,A,null,0,0,B,.01);V.eye_set_look_at(q,null,a);L&&(Z=f.get_object_by_dupli_name_list(d.CAMERA_INDICTAOR),H.set_nodemat_value(Z,["camera_indicator",d.CAM_INDICATOR_VAL],0))};a.pointerlock_cb=E;a.run_victory=function(){e.state=d.CH_VICTORY;q();g.apply(e.rig,d.CHAR_VICTORY_ANIM);
g.set_behavior(e.rig,g.AB_CYCLIC);g.play(e.rig);u.play_def(S);var a=f.get_active_camera();z.remove(a);var b={pivot:l.get_translation(e.target)};V.target_setup(a,b);c.create_elapsed_sensor();c.create_sensor_manifold(a,"CAMERA_ROTATION",c.CT_CONTINUOUS,[c.create_elapsed_sensor()],null,function(a,b,e){e=V.get_camera_angles(a,da);var d=V.target_get_distance(a);b=c.get_sensor_value(a,b,0);V.target_rotate(a,.1*b,e[1]<L.VICT_CAM_VERT_ANGLE?.05*b:0);d>L.VICT_CAM_DIST&&V.target_set_distance(a,d-b)})};a.reset=
function(){e.state=d.CH_STILL;e.hp=d.MAX_CHAR_HP;e.island=-1;e.move_state.forw_back=0;e.move_state.left_right=0;L&&(l.get_rotation(e.phys_body,U),r.set_transform(e.phys_body,L.CHAR_DEF_POS,U),r.set_character_move_dir(e.phys_body,0,0),f.hide_object(e.foot_smoke));u.stop(S);var a=f.get_active_camera();c.check_sensor_manifold(a,"CAMERA_ROTATION")&&c.remove_sensor_manifold(a,"CAMERA_ROTATION");V.eye_setup(a);D()};a.apply_hp_potion=function(){n(d.BONUS_HP_INCR);g.play(e.body)};a.apply_lava_protect=function(){g.set_behavior(e.body,
g.AB_FINISH_STOP,g.SLOT_1);g.play(e.body,null,g.SLOT_1);H.set_nodemat_value(e.lava_shield_prot,["lava_shield_prot","lava_prot_switcher"],1)};a.remove_lava_protect=B;a.apply_shield=function(){g.set_behavior(e.body,g.AB_FINISH_STOP,g.SLOT_2);g.play(e.body,null,g.SLOT_2);H.set_nodemat_value(e.lava_shield_prot,["lava_shield_prot","shield_switcher"],1)};a.remove_shield=F;a.change_hp=n;a.add_gem=function(a){var b=a.empty;if(e.gem_slot){if(e.gem_slot==a)return;A()}b=a.empty;z.append_stiff(b,e.phys_body,
d.GEM_OFFSET,d.GEM_ROT_OFFSET,d.GEM_SCALE_OFFSET);a.state=d.GM_CARRIED;e.gem_slot=a;u.play_def(t)};a.remove_gem=A;a.get_wrapper=function(){return e}});if(b4w.module_check("environment"))throw"Failed to register module: environment";
b4w.register("environment",function(a,b){function E(a){function b(a,f,g,l,d,k){c.spawn(d)&&(D.set_translation_v(r,d),h.play(z))}var f=k.create_timer_sensor(a.BONUS_SPAWN_PERIOD,!0),r=q.get_object_by_name(a.BONUS_SPAWN_SPHERE),z=q.get_object_by_dupli_name(a.BONUS_SPAWN_SPHERE,a.BONUS_SPAWN_SPHERE);h.set_behavior(z,h.AB_FINISH_RESET);h.set_frame(z,0);k.create_sensor_manifold(null,"BONUS_SPAWN",k.CT_SHOT,[f],null,function(a,c,f){a=g;a[0]=40*Math.random()-20;a[1]=20;a[2]=40*Math.random()-20;c=u;u[0]=
a[0];u[2]=a[2];u[1]=-10;n.append_ray_test_ext(null,a,c,"GROUND",b,!0,!1,!0,!1)})}function w(a,b){function m(a,b,c,d){b=k.get_sensor_value(a,b,0);c=q.get_object_name(a);r[c]+=b;r[c]<=f.ROCK_FALL_DELAY||(c=g,D.get_translation(a,c),c[1]-=f.ROCK_SPEED*b,D.set_translation_v(a,c),-5>c[1]?k.set_custom_sensor(d,1):k.set_custom_sensor(d,0))}function n(a,b,d,l){var m=g,e=l[0];l=l[1];var p=A.get_wrapper();D.get_translation(p.phys_body,m);d=k.get_sensor_value(a,b,0)?0:1;b=k.get_sensor_payload(a,b,d).coll_pos;
m=B.distance(m,b);D.set_translation_v(e,b);h.set_frame(e,0,h.SLOT_ALL);h.play(e,null,h.SLOT_ALL);m<f.ROCK_DAMAGE_RADIUS&&p.state!=y.CH_VICTORY&&(e=-f.ROCK_DAMAGE,0<c.shield_time_left()&&(e*=y.BONUS_SHIELD_EFFECT),A.change_hp(e));v(a);a=q.get_object_name(a);r[a]=0;(a=Math.random()<y.BONUS_SPAWN_CHANCE)&&0==d&&c.spawn(b);F.play_def(l)}function z(a,b,c,d){c=k.get_sensor_value(a,b,0)?0:1;b=k.get_sensor_payload(a,b,c).hit_fract;c=g;var l=q.get_object_name(a);r[l]<=f.ROCK_FALL_DELAY&&(D.get_translation(a,
c),c[1]-=b*f.ROCK_RAY_LENGTH-.01,D.set_translation_v(d,c));D.set_scale(d,1-b)}for(var x=0;x<f.ROCK_EMPTIES.length;x++)for(var w=f.ROCK_EMPTIES[x],u=0;u<f.ROCK_NAMES.length;u++){var E=f.ROCK_NAMES[u],d=f.BURST_EMITTER_NAMES[u],G=f.MARK_NAMES[u],I=q.get_object_by_dupli_name(w,E),d=q.get_object_by_dupli_name(w,d),G=q.get_object_by_dupli_name(w,G),N=q.get_object_by_dupli_name(w,f.ROCK_HIT_SPEAKERS[u]),L=k.create_collision_sensor(I,"LAVA",!0),M=k.create_collision_sensor(I,"GROUND",!0),Q=k.create_custom_sensor(0),
J=k.create_ray_sensor(I,[0,0,0],[0,-f.ROCK_RAY_LENGTH,0],"GROUND",!0),P=k.create_ray_sensor(I,[0,0,0],[0,-f.ROCK_RAY_LENGTH,0],"LAVA",!0);k.create_sensor_manifold(I,"ROCK_FALL",k.CT_CONTINUOUS,[a],null,m,Q);k.create_sensor_manifold(I,"ROCK_CRASH",k.CT_SHOT,[M,L,Q],function(a){return a[0]||a[1]||a[2]},n,[d,N]);k.create_sensor_manifold(I,"MARK_POS",k.CT_CONTINUOUS,[J,P],function(a){return a[0]||a[1]},z,G);v(I);r[E]=0}}function v(a){var b=g;b[0]=32*Math.random()-16;b[1]=16*Math.random()+8;b[2]=32*Math.random()-
16;D.set_translation_v(a,b)}function G(a){var b=0,g=A.get_wrapper(),n=k.create_ray_sensor(g.phys_body,[0,0,0],[0,-y.CHAR_RAY_LENGTH,0],"LAVA",!0);k.remove_sensor_manifold(g.phys_body,"LAVA_COLLISION");k.create_sensor_manifold(g.phys_body,"LAVA_COLLISION",k.CT_CONTINUOUS,[n,a],function(a){return a[0]},function(a,f,h,n){1==h?(q.show_object(g.foot_smoke),a=k.get_sensor_value(a,f,1),b+=a,b>=y.LAVA_DAMAGE_INTERVAL&&(a=a<y.LAVA_DAMAGE_INTERVAL?1:Math.floor(a/y.LAVA_DAMAGE_INTERVAL),0>=c.lava_protect_time_left()&&
A.change_hp(-a),b=0)):(q.hide_object(g.foot_smoke),b=0)});"dungeon"==f.LEVEL_NAME&&(a=q.get_object_by_dupli_name("level_02_enviroment","lava"),h.apply_def(a),h.set_behavior(a,h.AB_FINISH_STOP),h.stop(a),h.set_frame(a,0),a=q.get_object_by_dupli_name("lava_death_controller","lava_death_controller"),h.apply_def(a))}var h=b("animation"),k=b("controls"),q=b("scenes"),D=b("transform"),B=b("vec3"),F=b("sfx"),n=b("physics"),A=b("character"),y=b("game_config"),c=b("bonuses"),f=null,r={},g=new Float32Array(3),
u=new Float32Array(3);a.init=function(a,b){f=b;G(a);f.ROCK_EMPTIES&&w(a,f);"dungeon"==f.LEVEL_NAME&&E(b)};a.reset=function(a){if("volcano"==f.LEVEL_NAME)for(var b=0;b<f.ROCK_EMPTIES.length;b++)for(var c=f.ROCK_EMPTIES[b],g=0;g<f.ROCK_NAMES.length;g++){var h=f.ROCK_NAMES[g],k=q.get_object_by_dupli_name(c,h);v(k);r[h]=0}G(a)};a.disable_environment=function(){if(f.ROCK_EMPTIES)for(var a=0;a<f.ROCK_EMPTIES.length;a++)for(var b=f.ROCK_EMPTIES[a],c=0;c<f.ROCK_NAMES.length;c++){var g=f.MARK_NAMES[c],h=q.get_object_by_dupli_name(b,
f.ROCK_NAMES[c]),g=q.get_object_by_dupli_name(b,g);k.remove_sensor_manifold(h);v(h);D.set_translation_v(g,y.DEFAULT_POS)}}});if(b4w.module_check("game_main"))throw"Failed to register module: game_main";
b4w.register("game_main",function(a,b){function E(){var a=k.get_object_by_dupli_name_list(["training_scene","training_dummy","training_dummy"]),b=k.get_object_by_dupli_name_list(["training_scene","Circle"]),c=B.create(),f=B.create();F.apply_constraint("GENERIC_6_DOF_SPRING",a,[0,-1.05,0],c,b,[-3.5,.1,-1.6],f,{use_limit_x:!0,use_limit_y:!0,use_limit_z:!0,use_angular_limit_x:!0,use_angular_limit_y:!0,use_angular_limit_z:!1,limit_max_x:0,limit_min_x:0,limit_max_y:0,limit_min_y:0,limit_max_z:0,limit_min_z:0,
limit_angle_max_x:.5,limit_angle_min_x:-.5,limit_angle_max_y:.5,limit_angle_min_y:-.5,limit_angle_max_z:.5,limit_angle_min_z:-.5},[0,0,0,200,200,200],[2,2,2,.01,.01,.01])}function w(a){h.remove_sensor_manifold(null,"PLAYLIST");A.reset();p&&(g.reset(),y.reset(),f.reset(),r.reset(),u.reset(a));A.setup_controls(a);c.update_hp_bar();v()}function v(){if(p&&p.MUSIC_SPEAKERS){var a=k.get_object_by_dupli_name_list(p.MUSIC_INTRO_SPEAKER),b=k.get_object_by_dupli_name_list(p.MUSIC_END_SPEAKER);a&&b&&(q.play_def(a),
q.stop(b),a=q.get_duration(a)*q.get_playrate(a),h.create_sensor_manifold(null,"PLAYLIST",h.CT_SHOT,[h.create_timer_sensor(a)],null,function(a,b,c){h.remove_sensor_manifold(null,"PLAYLIST");if(!(0>=A.get_wrapper().hp)){a=[];b=p.MUSIC_SPEAKERS;for(c=0;c<b.length;c++){var f=k.get_object_by_dupli_name_list(b[c]);a.push(f)}q.apply_playlist(a,0,!0)}}))}}var G=b("app"),h=b("controls"),k=b("scenes");b("print");var q=b("sfx"),D=b("container"),B=b("quat"),F=b("physics");b("transform");var n=b("game_config"),
A=b("character");b("combat");var y=b("bonuses"),c=b("interface"),f=b("enemies"),r=b("obelisks"),g=b("gems"),u=b("environment"),p=null;new Float32Array(3);new Float32Array(3);new Float32Array(3);new Float32Array(3);new Float32Array(4);new Float32Array(4);a.level_load_cb=function(a,m,q,z,x){a=h.create_elapsed_sensor();p=null;if("under_construction"!=m){if("level_01"==m||"level_02"==m)p=b(m+"_config");if("level_02"!=m){var B=k.get_object_by_dupli_name(n.CHAR_EMPTY,n.CHAR_LIGHT);k.hide_object(B)}"training"==
m&&E();A.init_wrapper(p,m);A.setup_controls(a);p&&(y.init(a,p),f.init(a,p),g.init(p),u.init(a,p),r.init(a,p),v())}else G.enable_camera_controls();setTimeout(function(){D.get_container().style.opacity=1},1E3);c.init(w,a,z,q,A.pointerlock_cb,m,x)}});if(b4w.module_check("start_menu"))throw"Failed to register module: intro_main";
b4w.register("start_menu",function(a,b){function E(a,b){b?(O=a,document.getElementById("preloader_cont").style.visibility="visible",p.detect_mobile()?K.load(ia+"intro_LQ.json",w,r,!0):K.load(ia+"intro_HQ.json",w,r,!0)):ea.log("b4w init failure")}function w(a){S=t=!1;C=null;Y=O.width/2;Z=O.height/2;d.enqueue([["config",d.AT_JSON,"js/intro_config.json"]],v,null);a=x.get_active_camera();m.get_camera_angles(a,da);setTimeout(function(){I.get_container().style.opacity=1},1E3);p.detect_mobile()?O.addEventListener("touchstart",
D,!1):(O.addEventListener("mousedown",B,!1),O.addEventListener("mousemove",q,!1),setTimeout(function(){t||S||y()},1E4))}function v(a,b,c,d){b=a.buttons_info;c=z.create_elapsed_sensor();for(d=0;d<b.length;d++){var e=b[d],f=x.get_object_by_dupli_name_list(e.button_name.split("*"));if(f){var f=f.name,g=x.get_object_by_dupli_name_list(e.mouse_over_speaker.split("*"));H.stop(g);var l=[],m=e.glow_obj_names;if("object"==typeof m)for(var n=0;n<m.length;n++){var q=x.get_object_by_dupli_name_list(m[n].split("*"));
q&&l.push(q)}else l.push(x.get_object_by_dupli_name_list(m.split("*")));W[f]={glow_objs:l,speaker:g,level_name:e.level_name,material:e.material,value_node_name:e.value_node_name,glow_grow_time:e.glow_grow_time,min_glow_value:e.min_glow_value,max_glow_value:e.max_glow_value,glow_curr_value:e.min_glow_value,outline_grow_time:e.outline_grow_time,min_outline_value:e.min_outline_value,max_outline_value:e.max_outline_value,outline_curr_value:e.min_outline_value}}}z.create_sensor_manifold(null,"GLOW",z.CT_CONTINUOUS,
[c],null,h);z.create_sensor_manifold(null,"ROT_CAMERA",z.CT_CONTINUOUS,[c],null,k);G(a);b=1;"ru"==ha&&(b=0);c=x.get_object_by_dupli_name_list(a.language_obj.split("*"));R.set_nodemat_value(c,["main_menu_stone","language_switcher"],b);p.detect_mobile()||(fa=x.get_object_by_name(a.back_to_menu_obj_name),R.set_nodemat_value(fa,["back_to_main_menu","back_button_language"],b));b=x.get_active_camera();ga=a.camera_rotation_fac;Q.copy(a.camera_pivot,T);L.get_translation(b,U);X=Q.distance(T,U)}function G(a){e=
x.get_object_by_dupli_name_list(a.intro_speaker.split("*"));ba=x.get_object_by_dupli_name_list(a.end_speaker.split("*"));a=a.playlist_speakers;for(var b=0;b<a.length;b++){var c=x.get_object_by_dupli_name_list(a[b].split("*"));H.stop(c);aa.push(c);H.mute(c,!1)}a=H.get_duration(e)*H.get_playrate(e);H.mute(e,!1);H.mute(ba,!1);H.stop(ba);H.play_def(e);z.create_sensor_manifold(null,"PLAYLIST",z.CT_SHOT,[z.create_timer_sensor(a)],null,function(a,b,c){ca||(H.stop(e),H.apply_playlist(aa,0,!0))})}function h(a,
b,c){a=z.get_sensor_value(a,b,0);for(var e in W){b=W[e];var d=b.glow_curr_value,f=b.min_glow_value,g=b.max_glow_value,h=a/b.glow_grow_time;c=b.outline_curr_value;var k=b.min_outline_value,l=b.max_outline_value,m=a/b.outline_grow_time;C&&e==C.name&&(d<g&&(b.glow_curr_value+=h),void 0!==c&&c<l&&(b.outline_curr_value+=m));C&&e==C.name||(d>f&&(b.glow_curr_value-=h),void 0!==c&&c>k&&(b.outline_curr_value-=m));if(void 0!==d&&b.glow_curr_value!=d)for(d=0;d<b.glow_objs.length;d++)R.set_nodemat_value(b.glow_objs[d],
[b.material,b.value_node_name],b.glow_curr_value);if(void 0!==c&&b.outline_curr_value!=c)for(d=0;d<b.glow_objs.length;d++)x.set_outline_intensity(b.glow_objs[d],b.outline_curr_value)}}function k(a,b,c){N.is_play()||null===X||(a=x.get_active_camera(),c=O.width/2,b=O.height/2,m.get_camera_angles(a,ja),c=da[0]-(c-Y)/O.width*ga,b=-da[1]-(b-Z)/O.height*ga,U[0]=T[0]+X*Math.sin(c),U[1]=T[1]+X*Math.sin(b),U[2]=T[2]+X*Math.cos(c),m.static_set_look_at(a,U,T),m.correct_up(a))}function q(a){a.preventDefault&&
a.preventDefault();var b=a.clientX;a=a.clientY;var c=x.pick_object(b,a);c&&c!=C?(C=c,(c=W[c.name])&&c.speaker&&H.play_def(c.speaker)):!c&&C&&(C=null);Y=b;Z=a}function D(a){a.preventDefault&&a.preventDefault();a=a.changedTouches[0];F(a.clientX,a.clientY)}function B(a){a.preventDefault&&a.preventDefault();F(a.clientX,a.clientY)}function F(a,b){var d=x.pick_object(a,b);if(d&&W[d.name]){var e=W[d.name];e.level_name?(n(),setTimeout(function(){f(e.level_name)},1E3*J.LEVEL_LOAD_DELAY)):p.detect_mobile()||
(c(),n(),A())}}function n(){S=!0;p.detect_mobile()?O.removeEventListener("touchstart",D,!1):(O.removeEventListener("mousedown",B),O.removeEventListener("mousemove",q))}function A(){t||y();z.remove_sensor_manifold(null,"ROT_CAMERA");z.create_sensor_manifold(null,"TIMELINE_CHECK",z.CT_SHOT,[z.create_elapsed_sensor()],function(a){return N.get_frame()>=N.get_frame_end()},function(){f("level_01")})}function y(){H.duck(null,0,1);var a=x.get_object_by_name("environment_LQ");document.getElementById("preloader_cont").style.visibility=
"visible";K.load(ia+"intro_HQ_environment.json",function(){x.hide_object(a);H.duck(null,1,1);t=!0},r,!0,!1)}function c(a){for(a=0;a<aa.length;a++){var b=aa[a];H.is_play(b)&&H.duck(b,0,1)}H.duck(e,0,1);setTimeout(function(){H.clear_playlist();ca=!0;H.play_def(ba)},1E3)}function f(a){var b=ia+a+".json";K.unload(K.DATA_ID_ALL);document.getElementById("preloader_cont").style.visibility="visible";K.load(b,function(b){P.level_load_cb(b,a,r,w,f)},r,!0)}function r(a){var b=document.getElementById("prelod_dynamic_path"),
c=b.nextElementSibling;b.style.width=a+"%";c.innerHTML=a+"%";100==a&&g()}function g(){var a=document.getElementById("preloader_cont");setTimeout(function(){a.style.visibility="hidden"},1E3)}function u(){function a(b){y.setAttribute("lang",b);k.setAttribute("src","interface/start_game_"+b+".png");ha=b}function b(a){n.setAttribute("quality",a);document.location.hash="quality="+a}function c(){m.style.display="inline-block"}function d(){t.className="brand hover"}function e(){u.className="soc hover"}function f(){m.style.display=
""}function g(){t.className="brand"}function h(){u.className="soc"}var k=document.getElementById("start_game"),m=document.getElementById("start_game_hover"),n=document.getElementById("quality"),q=document.getElementById("start_cont"),r=document.getElementById("lang_ru"),v=document.getElementById("lang_en"),w=document.getElementById("low_qual"),x=document.getElementById("high_qual"),y=document.body,t=document.getElementsByClassName("brand")[0],u=document.getElementsByClassName("soc")[0];q.style.display=
"block";q.style.opacity=1;document.location.hash="quality=high";r.addEventListener("click",function(){a("ru")},!1);v.addEventListener("click",function(){a("en")},!1);w.addEventListener("click",function(){b("low")},!1);x.addEventListener("click",function(){b("high")},!1);p.detect_mobile()?(k.addEventListener("touchstart",c),k.addEventListener("touchend",f),t.addEventListener("touchstart",d),t.addEventListener("touchend",g),u.addEventListener("touchstart",e),u.addEventListener("touchend",h),b("low")):
(k.addEventListener("mousedown",c),k.addEventListener("mouseup",f),k.addEventListener("mouseleave",f),t.addEventListener("mousedown",d),t.addEventListener("mouseup",g),t.addEventListener("mouseleave",g),u.addEventListener("mousedown",e),u.addEventListener("mouseup",h),u.addEventListener("mouseleave",h));k.addEventListener("click",function(){q.style.visibility="hidden";var a=p.detect_mobile(),b="DEBUG"==M.type(),c="high"!=document.getElementById("quality").getAttribute("quality")||a?V.P_LOW:V.P_HIGH;
l.init({canvas_container_id:"canvas3d",callback:E,quality:c,physics_enabled:!0,console_verbose:!0,alpha:!1,physics_use_workers:!a,show_fps:b,autoresize:!0})},!1)}var p=b("main"),l=b("app"),m=b("camera"),K=b("data"),z=b("controls"),x=b("scenes"),V=b("config"),ea=b("print"),H=b("sfx");b("time");var d=b("assets"),R=b("objects"),I=b("container");b("util");var N=b("nla"),L=b("transform"),M=b("version"),Q=b("vec3");b("quat");var J=b("game_config"),P=b("game_main"),t=!1,S=!1,C=null,W={},ca=!1,e=null,aa=
[],ba=null,O=null,Y=0,Z=0,da=new Float32Array(2),X=null,T=new Float32Array(3),ga=0,U=new Float32Array(3),ha="en",fa=null,ja=new Float32Array(2),ia=V.get_std_assets_path()+"petigors_tale/";a.init=function(){window.addEventListener("load",u)}});b4w.require("start_menu").init("en");
