if(b4w.module_check("game_config"))throw"Failed to register module: game_config";
b4w.register("game_config",function(a,b){a.DEFAULT_POS=new Float32Array([0,-4,0]);a.GEM_OFFSET=new Float32Array([0,1,0]);a.GEM_ROT_OFFSET=new Float32Array([0,0,0,1]);a.GEM_SCALE_OFFSET=.6;a.CL_BLUE=0;a.CL_PURPLE=1;a.CL_RED=2;a.CL_GREEN=3;a.CL_YELLOW=4;a.CL_MULTI=5;a.ROT_SPEED=2;a.CAM_SOFTNESS=.2;a.CAM_OFFSET=new Float32Array([0,6,-16]);a.CHAR_RAY_LENGTH=1.2;a.MAX_CHAR_HP=100;a.CHAR_ATTACK_DIST=2;a.CHAR_ATTACK_STR=35;a.CHAR_ATTACK_ANIM_FRAME=12;a.CH_STILL=0;a.CH_RUN=1;a.CH_ATTACK=2;a.LAVA_DAMAGE_INTERVAL=
.01;a.BONUS_SPAWN_CHANCE=.5;a.BONUS_HP_INCR=30;a.BONUS_SHIELD_TIME=10;a.BONUS_SHIELD_EFFECT=.33;a.BONUS_LAVA_PROT_TIME=15;a.BONUS_LIFETIME=10;a.BONUS_FLASH_SPEED=3;a.SHIELD_FLASH_LENGTH=.9;a.LAVA_FALL_LENGTH=1;a.GOLEM_SPEED=.8;a.GOLEM_ROT_SPEED=1;a.GOLEM_ATTACK_DIST=2;a.GOLEM_ATTACK_STRENGTH=20;a.GOLEM_ATTACK_ANIM_FRAME=30;a.GOLEMS_SPAWN_INTERVAL=3;a.GOLEM_HP=100;a.GS_WALKING=0;a.GS_ATTACKING=1;a.GS_GETTING_OUT=2;a.GS_NONE=3;a.EN_TYPE_GOLEM_LAVA=0;a.EN_TYPE_GOLEM_STONE=1;a.GT_POINT=0;a.GT_CHAR=1;
a.GT_OBELISK=2;a.HP_BONUSES_EMPTIES=["potion_hp","potion_hp.001","potion_hp.002"];a.SHIELD_BONUSES_EMPTIES=["potion_def"];a.LAVA_BONUSES_EMPTIES=["potion_lava"];a.GOLEM_LAVA_DEATH_EMPTY=["golem_lava_death"];a.GOLEM_DEATH_RIG=["golem_death_armature"];a.GOLEM_DEATH_BLOW=["golem_death_blow"];a.GM_SPARE=0;a.GM_CARRIED=1;a.GM_LAYING=2;a.SHUTTER_EMITTER_EMPTY="shutter_glass";a.SHUTTER_EMITTER_NAME="glass_shutter_emitter";a.CHAR_RUN_SPEAKER="character_run";a.CHAR_ATTACK_SPEAKER="sword_miss";a.CHAR_ATTACK_VOICE_SPKS=
["character_voice_atack_01","character_voice_atack_02","character_voice_atack_03"];a.CHAR_HURT_SPKS=["character_voice_hurt_01","character_voice_hurt_02"];a.CHAR_JUMP_SPKS=["character_voice_jump_01","character_voice_jump_02"];a.CHAR_SWORD_SPEAKER="sword_hit";a.CHAR_DEATH_SPEAKER="character_voice_death_01";a.CHAR_LANDING_SPEAKER="character_jump_ends";a.GEM_PICKUP_SPEAKER="gem_pickup";a.GEM_MOUNT_SPEAKER="gem_mount";a.CHAR_HEAL_SPEAKER="bonus_heal";a.CHAR_LAVA_SPEAKER="bonus_lava";a.CHAR_SHIELD_SPEAKER=
"bonus_shield";a.GOLEM_WALK_SPEAKER="golem_walk";a.GOLEM_ATTACK_SPEAKER="golem_atack_miss";a.GOLEM_HIT_SPEAKER="golem_atack_hit";a.GOLEM_GETOUT_SPEAKER="golem_getout";a.GEM_DESTR_SPEAKER="gem_destroy";a.WIN_SPEAKER="final_win";a.BTYPE_HP=0;a.BTYPE_LAVA=1;a.BTYPE_SHIELD=2});if(b4w.module_check("obelisks"))throw"Failed to register module: obelisks";
b4w.register("obelisks",function(a,b){function F(d){switch(d){case "BG":return c.CL_BLUE;case "RG":return c.CL_RED;case "GG":return c.CL_GREEN;case "YG":return c.CL_YELLOW;case "PG":return c.CL_PURPLE}}function C(){for(var c=0;c<k.NUM_OBELISKS;c++){var d=k.ISLES_SHIELD_DUPLI_NAME_LIST;d[2]="island_shield_"+c;d=t.get_object_by_dupli_name_list(d);y.stop(d);y.set_behavior(d,y.AB_FINISH_STOP)}}function r(c,a){var b="obelisk_"+c,h=w[c];if(0<a){var g=k.OBELISKS_GEMS_NAME[c]+"_0"+(h.num_gems+1),b=t.get_object_by_dupli_name(b,
g);t.show_object(b);d.play_def(H);h.gem_health=k.OBELISK_GEM_HEALTH}else if(0>a){g=k.OBELISKS_GEMS_NAME[c]+"_0"+h.num_gems;b=t.get_object_by_dupli_name(b,g);t.hide_object(b);var g=p,q=P;l.get_translation(b,g);l.get_rotation(b,q);f(g,q)}h.num_gems+=a;u(c)}function u(a){if(v(a)&&("volcano"!=k.LEVEL_NAME||!m.island_has_enemies(a))){if("volcano"==k.LEVEL_NAME){var b=k.ISLES_SHIELD_DUPLI_NAME_LIST;b[2]="island_shield_"+a;b=t.get_object_by_dupli_name_list(b);y.play(b);a=t.get_object_by_dupli_name("obelisk_"+
a,k.ISLAND_SPEAKER);d.play_def(a)}a:{for(a=0;a<k.NUM_OBELISKS;a++)if(!v(a)){a=!1;break a}a=!0}a&&(h.disable_controls(),g.disable_environment(),d.clear_playlist(),a=t.get_object_by_name(c.WIN_SPEAKER),d.play_def(a),a=h.get_wrapper(),y.apply(a.rig,"character_idle_01"),y.set_behavior(a.rig,y.AB_CYCLIC),y.play(a.rig),n())}}function f(a,b){var h=t.get_object_by_dupli_name(c.SHUTTER_EMITTER_EMPTY,c.SHUTTER_EMITTER_NAME);l.set_translation_v(h,a);l.set_rotation_v(h,b);t.show_object(h);y.play(h,function(){t.hide_object(h)});
var g=t.get_object_by_dupli_name(c.SHUTTER_EMITTER_EMPTY,c.GEM_DESTR_SPEAKER);d.play_def(g)}function n(){I.show_victory_element(1);B.check_sensor_manifold(null,"UPDATE_VIC_INTERFACE")&&B.remove_sensor_manifold(null,"UPDATE_VIC_INTERFACE");B.create_sensor_manifold(null,"UPDATE_VIC_INTERFACE",B.CT_SHOT,[B.create_timer_sensor(3)],null,function(c,a,d){I.hide_victory_element(1);I.show_replay_button(1)})}function v(c){return w[c].num_gems==k.OBELISK_NUM_GEMS}function x(){for(var c=0;c<k.NUM_OBELISKS;c++){w[c].num_gems=
0;for(var a=1;a<=k.OBELISK_NUM_GEMS;a++){var d=t.get_object_by_dupli_name("obelisk_"+c,k.OBELISKS_GEMS_NAME[c]+"_0"+a);d&&t.hide_object(d)}switch(k.LEVEL_NAME){case "volcano":a=k.ISLES_SHIELD_DUPLI_NAME_LIST;a[2]="island_shield_"+c;a=t.get_object_by_dupli_name_list(a);y.set_frame(a,0);break;case "dungeon":a=t.get_object_by_dupli_name("level_02_enviroment",k.FLOOR_MAGIC_NAME),q.set_nodemat_value(a,["floor_magic_0"+(c+1),"Value"],0)}}}function A(c){for(var a=0;a<k.NUM_OBELISKS;a++)if(w[a].color==c)return a;
return-1}var B=b("controls"),t=b("scenes"),y=b("animation"),d=b("sfx"),l=b("transform"),q=b("objects"),c=b("game_config"),h=b("character"),m=b("enemies"),g=b("environment"),I=b("interface"),k=null,H=null,p=new Float32Array(3),P=new Float32Array(4),w=[];a.init=function(a,d){k=d;var b=h.get_wrapper(),g=function(e,a,d){1==d&&b.gem_slot&&e.num_gems!=k.OBELISK_NUM_GEMS&&(a=b.gem_slot.color,a==e.color||a==c.CL_MULTI)&&(h.remove_gem(),e=A(e.color),r(e,1))};if("volcano"==k.LEVEL_NAME)C();else if("dungeon"==
k.LEVEL_NAME)var f=t.get_object_by_dupli_name("level_02_enviroment",k.FLOOR_MAGIC_NAME),l=function(c,a,d,z){d=z.num_gems/k.OBELISK_NUM_GEMS;var b=z.magic_val;c=B.get_sensor_value(c,a,0);b!=d&&(b<d?z.magic_val+=.25*c:b>d&&(z.magic_val-=.25*c),q.set_nodemat_value(f,["floor_magic_0"+(z.id+1),"Value"],z.magic_val))};for(var m=0;m<k.NUM_OBELISKS;m++){var z=t.get_object_by_dupli_name("obelisk_"+m,"obelisk_collision"),J=k.OBELISKS_GEMS_NAME[m],O={num_gems:0,gem_health:0,color:F(J),id:m,magic_val:0},z=B.create_collision_sensor(z,
"CHARACTER");B.create_sensor_manifold(O,"FILL_OBELISK_"+J,B.CT_TRIGGER,[z],null,g);w.push(O);"dungeon"==k.LEVEL_NAME&&(q.set_nodemat_value(f,["floor_magic_0"+(m+1),"Value"],0),B.create_sensor_manifold(f,"FLOOR_MAGIC"+m,B.CT_CONTINUOUS,[a],null,l,O))}H=t.get_object_by_dupli_name("character",c.GEM_MOUNT_SPEAKER);x()};a.try_to_capture=u;a.is_filled=v;a.num_gems=function(c){return w[c].num_gems};a.damage_obelisk=function(c){--w[c].gem_health||(w[c].gem_health=k.OBELISK_GEM_HEALTH,r(c,-1))};a.reset=x;
a.get_id_by_color=A});if(b4w.module_check("gems"))throw"Failed to register module: gems";
b4w.register("gems",function(a,b){function F(a){if(a.state!=n.GM_SPARE)return!1;if(a.color==n.CL_MULTI)return!0;a=v.get_id_by_color(a.color);return!v.is_filled(a)}var C=b("controls"),r=b("scenes");b("animation");b("sfx");var u=b("transform");b("util");var f=b("constraints");b("vec3");var n=b("game_config"),v=b("obelisks"),x=b("character"),A=[],B=null;a.init=function(a){B=a;a=function(a,c,d,b){1==d&&x.add_gem(b)};for(var b=0;b<B.GEMS_EMPTIES.length;b++){var d=B.GEMS_EMPTIES[b],f=B.GEMS_NAMES[b],q=
r.get_object_by_name(d),d=r.get_object_by_dupli_name(d,f);if(q&&d){switch(r.get_object_name(d)){case "gem_B":var c=n.CL_BLUE;break;case "gem_R":c=n.CL_RED;break;case "gem_G":c=n.CL_GREEN;break;case "gem_Y":c=n.CL_YELLOW;break;case "gem_P":c=n.CL_PURPLE;break;case "gem_M":c=n.CL_MULTI}q={empty:q,color:c,state:n.GM_SPARE};A.push(q);f=C.create_collision_sensor(d,"CHARACTER");C.create_sensor_manifold(d,"PICK_GEM",C.CT_TRIGGER,[f],null,a,q)}}};a.spawn=function(a){for(var b=0,d=0;d<A.length;d++)F(A[d])&&
b++;if(b)for(b=Math.floor(b*Math.random()),d=0;d<A.length;d++){var f=A[d];if(F(f)&&0==b--){u.set_translation_v(f.empty,a);f.state=n.GM_LAYING;break}}};a.reset=function(){for(var a=0;a<A.length;a++){var b=A[a],d=b.empty;f.remove(d);u.set_translation_v(d,n.DEFAULT_POS);b.state=n.GM_SPARE}}});if(b4w.module_check("interface"))throw"Failed to register module: interface";
b4w.register("interface",function(a,b){function F(a,b){function n(q,c,h){q=d-v.get_timeline();0>q?f.remove_sensor_manifold(null,"SHOW_"+a.id):a.style.opacity=1-q/b}b=b||0;a.style.opacity=0;a.style.visibility="visible";var d=v.get_timeline()+b;if(!f.check_sensor_manifold(null,"SHOW_"+a.id)){var l=f.create_elapsed_sensor();f.create_sensor_manifold(null,"SHOW_"+a.id,f.CT_CONTINUOUS,[l],null,n)}}function C(a,b){function n(c,h,q){c=l-v.get_timeline();0>c?(a.style.visibility="hidden",f.remove_sensor_manifold(null,
"HIDE_"+a.id)):a.style.opacity=c/b*d}b=b||0;var d=a.style.opacity,l=v.get_timeline()+b;if(!f.check_sensor_manifold(null,"HIDE_"+a.id)){var q=f.create_elapsed_sensor();f.create_sensor_manifold(null,"HIDE_"+a.id,f.CT_CONTINUOUS,[q],null,n)}}var r=b("character"),u=b("game_config"),f=b("controls"),n=b("main"),v=b("time"),x=b("data"),A=b("config").get_std_assets_path()+"petigors_tale/";a.init=function(a,b,r,d){function l(){k.style.visibility="hidden";n.resume()}function q(){E.style.visibility="visible"}
function c(){D.style.visibility="visible"}function h(){n.resume();x.unload();k.style.visibility="hidden";C.style.visibility="visible";n.detect_mobile()?x.load(A+"intro_LQ.json",r,d,!0):x.load(A+"intro_HQ.json",r,d,!0)}function m(){n.resume();k.style.visibility="hidden";a(b)}function g(){I.style.visibility="hidden";a(b)}var I=document.getElementById("replay");document.getElementById("life_bar").style.visibility="visible";var k=document.getElementById("game_menu"),H=document.getElementById("menu_resume"),
p=document.getElementById("menu_help"),u=document.getElementById("menu_restart"),w=document.getElementById("menu_exit"),v=document.getElementById("menu_credits"),E=document.getElementById("credits_panel"),D=document.getElementById("help_panel"),C=document.getElementById("preloader_bg");n.detect_mobile()?(H.addEventListener("touchstart",l,!1),p.addEventListener("touchstart",c,!1),w.addEventListener("touchstart",h,!1),v.addEventListener("touchstart",q,!1),u.addEventListener("touchstart",m,!1),I.addEventListener("touchstart",
g,!1),E.addEventListener("touchstart",function(){E.style.visibility="hidden"},!1),D.addEventListener("touchstart",function(){D.style.visibility="hidden"},!1)):(H.addEventListener("click",l,!1),p.addEventListener("click",c,!1),w.addEventListener("click",h,!1),v.addEventListener("click",q,!1),u.addEventListener("click",m,!1),I.addEventListener("click",g,!1),E.addEventListener("click",function(){E.style.visibility="hidden"},!1),D.addEventListener("click",function(){D.style.visibility="hidden"},!1));
f.create_kb_sensor_manifold(null,"SHOW_MENU",f.CT_SHOT,f.KEY_ESC,function(){"visible"!=k.style.visibility&&(k.style.visibility="visible",n.pause())})};a.show_game_menu=function(){document.getElementById("game_menu").style.visibility="visible"};a.update_hp_bar=function(a){a=r.get_wrapper().hp;var b=document.getElementById("life_bar_green"),f=document.getElementById("life_bar_red"),d=document.getElementById("life_bar_mid"),l=192/u.MAX_CHAR_HP,q=Math.max(a*l,0);a=Math.min((u.MAX_CHAR_HP-a)*l,192);b.style.width=
q+"px";f.style.width=a+"px";d.style.left=q+19+"px"};a.setup_touch_controls=function(a,b,n,d,l,q){function c(c){c.preventDefault();c=c.changedTouches;for(var h=0;h<c.length;h++)c[h].identifier==m?(f.set_custom_sensor(b,0),f.set_custom_sensor(d,0),f.set_custom_sensor(n,0),f.set_custom_sensor(a,0),k.style.visibility="hidden",x.style.visibility="hidden",m=null):c[h].identifier==g?(f.set_custom_sensor(l,0),g=null):c[h].identifier==r&&(f.set_custom_sensor(q,0),r=null)}var h=new Float32Array(2),m,g,r,k=
document.getElementById("control_tap"),x=document.getElementById("control_circle"),p=k.clientWidth/2,u=x.clientWidth/2;document.getElementById("canvas3d").addEventListener("touchstart",function(a){a.preventDefault();var c=window.innerWidth;a=a.changedTouches;for(var b=0;b<a.length;b++){var d=a[b],g=d.clientX,f=d.clientY;if(g>c/2)break;h[0]=g;h[1]=f;m=d.identifier;k.style.visibility="visible";k.style.left=g-p+"px";k.style.top=f-p+"px";x.style.visibility="visible";x.style.left=g-u+"px";x.style.top=
f-u+"px"}},!1);document.getElementById("control_jump").addEventListener("touchstart",function(a){a.preventDefault();a=a.changedTouches;for(var c=0;c<a.length;c++){var b=a[c];f.set_custom_sensor(l,1);g=b.identifier}},!1);document.getElementById("control_attack").addEventListener("touchstart",function(a){a.preventDefault();a=a.changedTouches;for(var c=0;c<a.length;c++){var b=a[c];f.set_custom_sensor(q,1);r=b.identifier}},!1);document.getElementById("canvas3d").addEventListener("touchmove",function(c){c.preventDefault();
f.set_custom_sensor(b,0);f.set_custom_sensor(d,0);f.set_custom_sensor(n,0);f.set_custom_sensor(a,0);var g=window.innerWidth;c=c.changedTouches;for(var q=0;q<c.length;q++){var m=c[q],l=m.clientX,m=m.clientY;if(l>g/2)break;k.style.left=l-p+"px";k.style.top=m-p+"px";var l=l-h[0],m=m-h[1],r=Math.sqrt(l*l+m*m);if(16>r)break;l/=r;m=-m/r;l>Math.cos(3*Math.PI/8)?f.set_custom_sensor(a,1):l<-Math.cos(3*Math.PI/8)&&f.set_custom_sensor(n,1);m>Math.sin(Math.PI/8)?f.set_custom_sensor(b,1):m<-Math.sin(Math.PI/8)&&
f.set_custom_sensor(d,1)}},!1);document.getElementById("canvas3d").addEventListener("touchend",c,!1);document.getElementById("controls").addEventListener("touchend",c,!1);document.getElementById("control_jump").style.visibility="visible";document.getElementById("control_attack").style.visibility="visible"};a.show_replay_button=function(a){var b=document.getElementById("replay");F(b,a)};a.hide_replay_button=function(a){var b=document.getElementById("replay");C(b,a)};a.show_victory_element=function(a){var b=
document.getElementById("victory");F(b,a)};a.hide_victory_element=function(a){var b=document.getElementById("victory");C(b,a)}});if(b4w.module_check("bonuses"))throw"Failed to register module: bonuses";
b4w.register("bonuses",function(a,b){function F(a){function c(a,c,b,h){if(1==b)switch(u.set_translation_v(h.empty,r.DEFAULT_POS),h.type){case r.BTYPE_HP:x.apply_hp_potion();v.play_def(B);break;case r.BTYPE_LAVA:l<=r.LAVA_FALL_LENGTH&&x.apply_lava_protect();l=r.BONUS_LAVA_PROT_TIME;v.play_def(t);break;case r.BTYPE_SHIELD:d<=r.SHIELD_FLASH_LENGTH&&x.apply_shield(),d=r.BONUS_SHIELD_TIME,v.play_def(y)}}function b(a,c,d,h){a=f.get_sensor_value(a,c,0);h.lifetime-=a;0<h.lifetime?(a=h.lifetime,4<a||(h=h.body,
a*=r.BONUS_FLASH_SPEED,.5<(1>a?a:a%Math.floor(a))?n.hide_object(h):n.show_object(h))):(u.set_translation_v(h.empty,r.DEFAULT_POS),h.is_spawned=!1)}for(var m=0;m<A.length;m++){var g=A[m],I=g.body,k=f.create_collision_sensor(I,"CHARACTER");f.create_sensor_manifold(I,"BONUS",f.CT_TRIGGER,[k],null,c,g);f.create_sensor_manifold(I,"BONUS_LIFETIME",f.CT_CONTINUOUS,[a],null,b,g)}}function C(a,c,b){for(var d=0;d<a.length;d++){var g;var f=a[d];g=c;var l=b,t=n.get_object_by_name(f),f=n.get_object_by_dupli_name(f,
l);g=t&&f?{empty:t,body:f,lifetime:r.BONUS_LIFETIME,type:g,is_spawned:!1}:null;g&&A.push(g)}}var r=b("game_config"),u=b("transform"),f=b("controls"),n=b("scenes"),v=b("sfx"),x=b("character"),A=[],B=null,t=null,y=null,d=0,l=0;new Float32Array(3);a.init=function(a,c){B=n.get_object_by_dupli_name("character",r.CHAR_HEAL_SPEAKER);t=n.get_object_by_dupli_name("character",r.CHAR_LAVA_SPEAKER);y=n.get_object_by_dupli_name("character",r.CHAR_SHIELD_SPEAKER);C(r.HP_BONUSES_EMPTIES,r.BTYPE_HP,"potion_HP");
C(r.LAVA_BONUSES_EMPTIES,r.BTYPE_LAVA,"potion_LAVA");C(r.SHIELD_BONUSES_EMPTIES,r.BTYPE_SHIELD,"potion_SHIELD");F(a);f.create_sensor_manifold(null,"BONUS_TIMER",f.CT_CONTINUOUS,[a],null,function(a,c){var b=f.get_sensor_value(a,c,0);0<d&&(d-b<r.SHIELD_FLASH_LENGTH&&x.remove_shield(),d-=b);0<l&&(l-b<r.LAVA_FALL_LENGTH&&x.remove_lava_protect(),l-=b)})};a.spawn=function(a){for(var c=Math.floor(3*Math.random()),b=0;b<A.length;b++){var d=A[b];if(!d.is_spawned&&d.type==c){a[1]+=.05;u.set_translation_v(d.empty,
a);d.lifetime=r.BONUS_LIFETIME;d.is_spawned=!0;n.show_object(d.body);break}}};a.reset=function(){function a(c){for(var b=0;b<c.length;b++){var d=n.get_object_by_name(c[b]);u.set_translation_v(d,r.DEFAULT_POS)}}a(r.HP_BONUSES_EMPTIES);a(r.SHIELD_BONUSES_EMPTIES);a(r.LAVA_BONUSES_EMPTIES)};a.set_shield_time=function(a){d=a};a.set_lava_protect_time=function(a){l=a};a.lava_protect_time_left=function(){return l};a.shield_time_left=function(){return d}});if(b4w.module_check("enemies"))throw"Failed to register module: enemies";
b4w.register("enemies",function(a,b){function F(a,c){var b=a.empty.name;a.walk_speaker=y.get_object_by_dupli_name(b,g.GOLEM_WALK_SPEAKER);a.attack_speaker=y.get_object_by_dupli_name(b,g.GOLEM_ATTACK_SPEAKER);a.hit_speaker=y.get_object_by_dupli_name(b,g.GOLEM_HIT_SPEAKER);a.getout_speaker=y.get_object_by_dupli_name(b,g.GOLEM_GETOUT_SPEAKER);switch(c){case "lava":a.type=g.EN_TYPE_GOLEM_LAVA;break;case "stone":a.type=g.EN_TYPE_GOLEM_STONE}a.death_anim="golem_death";a.walk_anim="golem_walk";a.atack_anim=
["golem_atack_01","golem_atack_02","golem_atack_03"];a.getout_anim="golem_"+c+"_getout";a.death_empty_name="golem_"+c+"_death";b=q.get_object_bounding_box(a.body);a.height=b.max_y-b.min_y}function C(a,c,b){if(0>=a.hp){c=a.empty;b=y.get_object_by_name(a.death_empty_name);var e=y.get_object_by_dupli_name(a.death_empty_name,g.GOLEM_DEATH_RIG),h=y.get_object_by_dupli_name(a.death_empty_name,g.GOLEM_DEATH_BLOW),m=E,n=N;q.get_translation(c,m);q.get_rotation(c,n);q.set_translation_v(b,m);q.set_rotation_v(b,
n);d.apply(e,a.death_anim);d.set_behavior(e,d.AB_FINISH_STOP);d.play(e);d.play(h);l.stop(a.walk_speaker);q.set_translation_v(c,g.DEFAULT_POS);P.spawn(m);"volcano"==w.LEVEL_NAME&&(c=a.island_id,a.island_id=-1,H.try_to_capture(c));a.hp=100;x(a,g.GS_NONE)}else switch(b=t.get_sensor_value(a,c,1),a.dist_to_ground=10*b-a.height/2,a.state){case g.GS_ATTACKING:!a.attack_done&&d.get_frame(a.rig)>=g.GOLEM_ATTACK_ANIM_FRAME&&(a.last_target==g.GT_CHAR?k.check_attack(a.attack_point,I.get_wrapper().phys_body,g.GOLEM_ATTACK_DIST)&&
(c=g.GOLEM_ATTACK_STRENGTH,0<p.shield_time_left()&&(c*=g.BONUS_SHIELD_EFFECT),I.change_hp(-c),l.play_def(a.hit_speaker)):a.last_target==g.GT_OBELISK&&(c=a.island_id,H.num_gems(c)&&H.damage_obelisk(c),l.play_def(a.hit_speaker)),a.attack_done=!0);break;case g.GS_WALKING:c=t.get_sensor_value(a,c,0),b=I.get_wrapper(),"volcano"==w.LEVEL_NAME?(e=a.island_id,b.island==e&&0<b.hp?(u(a,b.phys_body,c),a.last_target=g.GT_CHAR):H.num_gems(e)?(b=y.get_object_by_dupli_name("obelisk_"+e,"obelisk"),u(a,b,c),a.last_target=
g.GT_OBELISK):f(a,c)):"dungeon"==w.LEVEL_NAME?0<b.hp&&k.check_visibility(a,b)?(u(a,b.phys_body,c),a.speed=2*g.GOLEM_SPEED,d.set_speed(a.rig,2),a.last_target=g.GT_CHAR):f(a,c):f(a,c)}}function r(a){for(var c=[],b=[],d=0;d<w.GOLEM_SPAWN_POINTS.length;d++){var f=y.get_object_by_name(w.GOLEM_SPAWN_POINTS[d]),m=q.get_translation(f),f=q.get_rotation(f);c.push(m);b.push(f)}t.create_sensor_manifold(null,"GOLEMS_SPAWN",t.CT_CONTINUOUS,[a],null,function(a,d){var e;a:{for(e=0;e<G.length;e++){var z=G[e];if(z.state==
g.GS_NONE){e=z;break a}}e=null}if(e&&(z=t.get_sensor_value(a,d,0),K-=z,0>=K)){K=g.GOLEMS_SPAWN_INTERVAL;if("volcano"==w.LEVEL_NAME){if(z=A(),null==z)return}else z=0;var f=z,m=e.empty,z="volcano"==w.LEVEL_NAME?c.length/w.NUM_OBELISKS:c.length,k=Math.floor(Math.random()*z),k=z*f+k,z=c[k],k=b[k];q.set_translation_v(m,z);q.set_rotation_v(m,k);x(e,g.GS_GETTING_OUT);l.play_def(e.getout_speaker);if("volcano"==w.LEVEL_NAME)e.island_id=f,h.copy(z,e.dest_pos);else{for(var f=w.GOLEM_PATROL_POINTS,m=f.length,
k=e.dest_pos,n=1E3,aa=-1,V=0;V<m;V++){var p=y.get_object_by_name(f[V]);q.get_translation(p,D);p=h.distance(D,z);p<n&&(n=p,aa=V,h.copy(D,k),k[1]=z[1])}e.dest_point=aa}}})}function u(a,c,b){var e=E,f=D;q.get_translation(a.empty,e);q.get_translation(c,f);f[1]=e[1];h.copy(f,a.dest_pos);c=h.distance(e,f);e=n(a,b);c>=g.GOLEM_ATTACK_DIST?v(a,b):e<.05*Math.PI&&(b=a.empty,c=a.attack_point,e=E,f=D,d.set_speed(a.rig,2),a.attack_done=!1,x(a,g.GS_ATTACKING),q.get_translation(b,e),h.scaleAndAdd(e,f,g.GOLEM_ATTACK_DIST,
c),c[1]+=a.height/2,l.is_play(a.walk_speaker)&&l.stop(a.walk_speaker),l.play_def(a.attack_speaker))}function f(a,c){a.speed=g.GOLEM_SPEED;d.set_speed(a.rig,1);var b=a.dest_pos,e=E;q.get_translation(a.empty,e);var f=e[1];e[1]=b[1];b=h.distance(e,b);e[1]=f;if(!(.05<b&&a.last_target==g.GT_POINT))if(a.last_target=g.GT_POINT,"volcano"==w.LEVEL_NAME)b:{for(var f=a.dest_pos,b=a.dest_point,m=a.island_id,k=w.GOLEM_PATROL_POINTS,l=k.length/w.NUM_OBELISKS,p=Math.random(),r=Math.floor(l*p),t=0,p=0;p<l;p++)if(p!=
b&&t++==r){m=y.get_object_by_name(k[l*m+p]);q.get_translation(m,f);f[1]=e[1];a.prev_dest=b;a.dest_point=p;break b}a.dest_point=-1}else f=a.dest_pos,b=a.dest_point,m=w.GOLEM_PATROL_POINTS,k=w.GOLEM_PATROL_MAP[b],l=k.length-1,p=Math.random(),k=k[Math.floor(l*p)],m=y.get_object_by_name(m[k]),q.get_translation(m,f),f[1]=e[1],a.prev_dest=b,a.dest_point=k;n(a,c);v(a,c)}function n(a,b){var d=a.empty,e=a.dest_pos,f=E,k=D,l=M,p=N,n=L;q.get_translation(d,f);q.get_rotation(d,p);h.transformQuat(c.AXIS_Z,p,k);
h.subtract(e,f,l);l[1]=0;h.normalize(l,l);m.rotationTo(k,l,n);m.multiply(n,p,n);e=h.dot(k,l);e=Math.acos(1<e?1:-1>e?-1:e);f=Math.abs(e)/Math.PI;m.slerp(p,n,Math.min(b/f*g.GOLEM_ROT_SPEED,1),n);q.set_rotation_v(d,n);return e}function v(a,b){var d=E,e=D,f=N,g=a.empty,k=a.walk_speaker;q.get_rotation(g,f);q.get_translation(g,d);h.transformQuat(c.AXIS_Z,f,e);h.scaleAndAdd(d,e,a.speed*b,d);e=b/3;d[1]-=a.dist_to_ground>e?e:a.dist_to_ground<-e?-e:e;q.set_translation_v(g,d);l.is_play(k)||(l.play_def(k),l.cyclic(k,
!0))}function x(a,c){var b=a.rig;switch(c){case g.GS_WALKING:d.apply(b,a.walk_anim);d.set_behavior(b,d.AB_CYCLIC);d.play(b);break;case g.GS_ATTACKING:var e=Math.floor(a.atack_anim.length*Math.random());d.apply(b,a.atack_anim[e]);d.play(b,function(){a.state!=g.GS_NONE&&x(a,g.GS_WALKING)});break;case g.GS_GETTING_OUT:d.apply(b,a.getout_anim),d.play(b,function(){a.state!=g.GS_NONE&&x(a,g.GS_WALKING)})}a.state=c}function A(){for(var a=w.NUM_OBELISKS,b=0;b<G.length;b++)B(b)||a--;if(0==a)return null;for(var a=
Math.floor(Math.random()*a),c=0,b=0;b<w.NUM_OBELISKS;b++)if(B(b)&&c++==a)return b;return null}function B(a){if(H.is_filled(a))return!1;for(var b=0;b<G.length;b++)if(G[b].island_id==a)return!1;return!0}var t=b("controls"),y=b("scenes"),d=b("animation"),l=b("sfx"),q=b("transform"),c=b("util"),h=b("vec3"),m=b("quat"),g=b("game_config"),I=b("character"),k=b("combat"),H=b("obelisks"),p=b("bonuses"),P=b("gems"),w=null,G=[],E=new Float32Array(3),D=new Float32Array(3),M=new Float32Array(3),N=new Float32Array(4),
L=new Float32Array(4),K=0;a.init=function(a,b){w=b;K=g.GOLEMS_SPAWN_INTERVAL;for(var c=0;c<w.GOLEMS_EMPTIES.length;c++){var d=w.GOLEMS_EMPTIES[c],f=y.get_object_by_name(d),h=y.get_object_by_dupli_name(d,"golem_collider"),d=y.get_object_by_dupli_name(d,"golem_armature");h&&d&&f&&(f={body:h,rig:d,empty:f,height:0,type:g.EN_TYPE_GOLEM_LAVA,view_distance:10,walk_speaker:null,attack_speaker:null,hit_speaker:null,getout_speaker:null,death_empty_name:null,hp:g.GOLEM_HP,speed:g.GOLEM_SPEED,island_id:-1,dest_point:-1,
prev_dest:-1,dest_pos:new Float32Array(3),dist_to_ground:0,last_target:g.GT_POINT,state:g.GS_NONE,attack_point:new Float32Array(3),attack_done:!1},d=-1!=h.name.indexOf("lava")?"lava":"stone",F(f,d),h=t.create_ray_sensor(h,[0,0,0],[0,-10,0],"GROUND",!1,!1,!0),t.create_sensor_manifold(f,"GOLEM",t.CT_CONTINUOUS,[a,h],function(a){return!0},C),G.push(f),k.append_enemy(f))}r(a)};a.reset=function(){K=g.GOLEMS_SPAWN_INTERVAL;for(var a=0;a<G.length;a++){var b=G[a];b.island_id=-1;x(b,g.GS_NONE);q.set_translation_v(b.empty,
g.DEFAULT_POS);l.stop(b.walk_speaker)}};a.island_has_enemies=function(a){for(var b=0;b<G.length;b++)if(G[b].island_id==a)return!0;return!1}});if(b4w.module_check("combat"))throw"Failed to register module: combat";
b4w.register("combat",function(a,b){function F(a,b,n){var t=f;C.get_translation(b,t);return r.distance(t,a)<n?!0:!1}var C=b("transform"),r=b("vec3"),u=b("game_config"),f=new Float32Array(3),n=new Float32Array(3),v=[];a.append_enemy=function(a){v.push(a)};a.process_attack_on_enemies=function(a,b){for(var f=0;f<v.length;f++){var n=v[f];if(!(0>=n.hp||n.state==u.GS_NONE)&&F(a,n.empty,b))return n.hp-=u.CHAR_ATTACK_STR,!0}return!1};a.check_attack=F;a.check_visibility=function(a,b){var u=C.get_translation(a.body,
f),t=C.get_translation(b.body,n);return r.distance(u,t)>a.view_distance?!1:!0}});if(b4w.module_check("character"))throw"Failed to register module: character";
b4w.register("character",function(a,b){function F(){for(var a=function(a,b,c){e.island=1==c?parseInt(b[b.length-1]):-1},b=0;b<E.NUM_OBELISKS;b++){var c=d.create_collision_sensor(e.picker,"ISLAND"+b);d.create_sensor_manifold(e.picker,"ISLE_COLL"+b,d.CT_TRIGGER,[c],null,a)}}function C(a){var b=d.create_ray_sensor(e.phys_body,[0,0,0],[0,-p.CHAR_RAY_LENGTH,0],"GROUND",!0),c=d.create_ray_sensor(e.phys_body,[0,0,0],[0,-p.CHAR_RAY_LENGTH,0],"LAVA",!0),f=d.create_ray_sensor(e.phys_body,[0,0,0],[0,-p.CHAR_RAY_LENGTH,
0],"COMMON",!0);d.create_sensor_manifold(e.phys_body,"GROUND SENS",d.CT_TRIGGER,[b,c,f],function(a){return a[0]||a[1]||a[2]},function(b,c,e){d.set_custom_sensor(a,1==e?1:0)})}function r(a,b,f){function g(a,b,f){if(e.state==p.CH_ATTACK)q.set_character_move_dir(a,0,0);else{var k=d.get_sensor_value(a,b,6);if(1==f){switch(b){case "FORWARD":var m=1;break;case "BACKWARD":m=-1}e.state==p.CH_STILL&&k&&(c.apply(e.rig,"character_run"),c.play(e.rig),c.set_behavior(e.rig,c.AB_CYCLIC));e.state=p.CH_RUN}else m=
0,e.state==p.CH_RUN&&k&&(c.apply(e.rig,"character_idle_01"),c.set_behavior(e.rig,c.AB_CYCLIC),c.play(e.rig)),e.state=p.CH_STILL;m&&k?h.is_play(D)||h.play_def(D):h.is_play(D)&&h.stop(D);q.set_character_move_dir(a,m,0)}}var k=d.create_keyboard_sensor(d.KEY_W),m=d.create_keyboard_sensor(d.KEY_S),l=d.create_keyboard_sensor(d.KEY_UP),n=d.create_keyboard_sensor(d.KEY_DOWN);a=[k,l,a,m,n,b,f];d.create_sensor_manifold(e.phys_body,"FORWARD",d.CT_CONTINUOUS,a,function(a){return a[0]||a[1]||a[2]},g);d.create_sensor_manifold(e.phys_body,
"BACKWARD",d.CT_CONTINUOUS,a,function(a){return a[3]||a[4]||a[5]},g);c.apply(e.rig,"character_idle_01");c.play(e.rig);c.set_behavior(e.rig,c.AB_CYCLIC);e.body&&(c.apply(e.body,"HEAL_run"),c.apply(e.body,"LAVA_grow",c.SLOT_1),c.apply(e.body,"SHIELD_grow",c.SLOT_2));e.shield_sphere&&c.apply(e.shield_sphere,"SHIELD_GLOW_grow");h.stop(D)}function u(a,b,c){function f(a,b,c){if(e.state!=p.CH_ATTACK){var h=d.get_sensor_value(a,"LEFT",6);if(1==c)switch(b){case "LEFT":q.character_rotation_inc(a,h*p.ROT_SPEED,
0);break;case "RIGHT":q.character_rotation_inc(a,-h*p.ROT_SPEED,0)}}}var h=d.create_keyboard_sensor(d.KEY_A),g=d.create_keyboard_sensor(d.KEY_D),k=d.create_keyboard_sensor(d.KEY_LEFT),m=d.create_keyboard_sensor(d.KEY_RIGHT);a=[h,k,b,g,m,a,c];d.create_sensor_manifold(e.phys_body,"LEFT",d.CT_CONTINUOUS,a,function(a){return a[0]||a[1]||a[2]},f);d.create_sensor_manifold(e.phys_body,"RIGHT",d.CT_CONTINUOUS,a,function(a){return a[3]||a[4]||a[5]},f)}function f(a,b){var f=d.create_keyboard_sensor(d.KEY_SPACE);
d.create_sensor_manifold(e.phys_body,"JUMP",d.CT_TRIGGER,[f,a,b],function(a){return a[0]||a[1]},function(a,b,f){1==f&&e.state!=p.CH_ATTACK&&(q.character_jump(a),d.get_sensor_value(a,b,2)&&(b=Math.floor(2*Math.random()),h.play_def(z[b]),c.apply(e.rig,"character_jump"),c.set_behavior(e.rig,c.AB_FINISH_STOP),c.play(e.rig)))});d.create_sensor_manifold(e.phys_body,"LANDING",d.CT_TRIGGER,[b],null,function(a,b,d){1==d&&(h.play_def(L),e.state==p.CH_STILL?(c.apply(e.rig,"character_idle_01"),c.set_behavior(e.rig,
c.AB_CYCLIC),c.play(e.rig)):e.state==p.CH_RUN&&(c.apply(e.rig,"character_run"),c.set_behavior(e.rig,c.AB_CYCLIC),c.play(e.rig)))})}function n(a,b){function f(a){c.apply(e.rig,"character_idle_01");c.set_behavior(e.rig,c.AB_CYCLIC);c.play(e.rig);e.state=p.CH_STILL}var m=d.create_keyboard_sensor(d.KEY_ENTER),l=!1;d.create_sensor_manifold(e.phys_body,"ATTACK",d.CT_TRIGGER,[m,a],function(a){return a[0]||a[1]},function(a,b,d){1==d&&e.state!=p.CH_ATTACK&&(e.state=p.CH_ATTACK,a=Math.floor(3*Math.random())+
1,c.apply(e.rig,"character_atack_0"+a),c.set_behavior(e.rig,c.AB_FINISH_STOP),c.play(e.rig,f),q.set_character_move_dir(e.phys_body,0,0),l=!1,h.is_play(D)&&h.stop(D),h.play_def(M),a=Math.floor(3*Math.random()),h.play_def(J[a]))});d.create_sensor_manifold(e.phys_body,"DAMAGE_GOLEMS",d.CT_CONTINUOUS,[b],null,function(a,b,d){if(e.state==p.CH_ATTACK&&!l&&c.get_frame(e.rig)>=p.CHAR_ATTACK_ANIM_FRAME){a=S;b=U;d=T;var f=Q,m=p.CHAR_ATTACK_DIST;g.get_translation(e.phys_body,a);g.get_rotation(e.phys_body,f);
k.transformQuat(I.AXIS_Z,f,b);k.scaleAndAdd(a,b,m,d);P.process_attack_on_enemies(d,m)&&(h.play_def(N),c.play(e.hitsparks));l=!0}})}function v(){d.check_sensor_manifolds(e.phys_body)&&d.remove_sensor_manifold(e.phys_body);q.set_character_move_dir(e.phys_body,0,0);h.stop(D)}function x(){c.apply(e.body,"LAVA_fall",c.SLOT_1);c.set_behavior(e.body,c.AB_FINISH_STOP,c.SLOT_1);c.play(e.body,null,c.SLOT_1);G.set_lava_protect_time(0)}function A(){c.apply(e.body,"SHIELD_flash",c.SLOT_2);c.set_behavior(e.body,
c.AB_FINISH_STOP,c.SLOT_2);c.play(e.body,null,c.SLOT_2);c.apply(e.shield_sphere,"SHIELD_GLOW_fall");c.set_behavior(e.shield_sphere,c.AB_FINISH_STOP);c.play(e.shield_sphere);G.set_shield_time(0)}function B(a){if(!(0>=e.hp)){var b=m.get_timeline();if(0>a&&R<b-.5){var d=Math.floor(2*Math.random());h.play_def(O[d]);R=b}e.hp+=a;e.hp=Math.min(e.hp,p.MAX_CHAR_HP);0>=e.hp&&(v(),E.MUSIC_SPEAKERS&&(h.clear_playlist(),a=l.get_object_by_dupli_name("enviroment",E.MUSIC_INTRO_SPEAKER),h.stop(a),a=l.get_object_by_dupli_name("enviroment",
E.MUSIC_END_SPEAKER),h.play_def(a)),a=l.get_object_by_dupli_name("character",p.CHAR_DEATH_SPEAKER),h.play_def(a),c.apply(e.rig,"character_death"),c.set_behavior(e.rig,c.AB_FINISH_STOP),c.play(e.rig),w.show_replay_button(1),e.gem_slot&&t(),0<G.shield_time_left&&A(),0<G.lava_protect_time_left&&x());w.update_hp_bar()}}function t(){var a=e.gem_slot.empty;H.remove(a);g.set_translation_v(a,p.DEFAULT_POS);g.set_scale(a,1);e.gem_slot.state=p.GM_SPARE;e.gem_slot=null}var y=b("main"),d=b("controls"),l=b("scenes"),
q=b("physics"),c=b("animation"),h=b("sfx"),m=b("time"),g=b("transform"),I=b("util"),k=b("vec3"),H=b("constraints"),p=b("game_config"),P=b("combat"),w=b("interface"),G=b("bonuses");b("environment");var E=null,D=null,M=null,N=null,L=null,K=null,z=[],J=[],O=[],e=null,R=-100,S=new Float32Array(3),U=new Float32Array(3),T=new Float32Array(3),Q=new Float32Array(4);a.init_wrapper=function(a,b){E=a;e={phys_body:l.get_first_character(),rig:l.get_object_by_dupli_name("character","character_rig"),body:l.get_object_by_dupli_name("character",
"character_body_"+b),picker:l.get_object_by_dupli_name("character","character_picker"),shield_sphere:l.get_object_by_dupli_name("character","shield_sphere"),hitsparks:l.get_object_by_dupli_name("character","sword_hitsparks_emitter"),hp:p.MAX_CHAR_HP,state:p.CH_STILL,gem_slot:null,island:-1};c.apply_def(e.hitsparks);c.set_behavior(e.hitsparks,c.AB_FINISH_RESET)};a.setup_controls=function(a){D=l.get_object_by_dupli_name("character",p.CHAR_RUN_SPEAKER);M=l.get_object_by_dupli_name("character",p.CHAR_ATTACK_SPEAKER);
N=l.get_object_by_dupli_name("character",p.CHAR_SWORD_SPEAKER);L=l.get_object_by_dupli_name("character",p.CHAR_LANDING_SPEAKER);K=l.get_object_by_dupli_name("character",p.GEM_PICKUP_SPEAKER);for(var b=0;b<p.CHAR_JUMP_SPKS.length;b++){var c=l.get_object_by_dupli_name("character",p.CHAR_JUMP_SPKS[b]);z.push(c)}for(b=0;b<p.CHAR_ATTACK_VOICE_SPKS.length;b++)c=l.get_object_by_dupli_name("character",p.CHAR_ATTACK_VOICE_SPKS[b]),J.push(c);for(b=0;b<p.CHAR_HURT_SPKS.length;b++)c=l.get_object_by_dupli_name("character",
p.CHAR_HURT_SPKS[b]),O.push(c);"volcano"==E.LEVEL_NAME&&F();var b=d.create_custom_sensor(0),c=d.create_custom_sensor(0),e=d.create_custom_sensor(0),h=d.create_custom_sensor(0),g=d.create_custom_sensor(0),k=d.create_custom_sensor(0),m=d.create_custom_sensor(0);C(m);y.detect_mobile()&&w.setup_touch_controls(b,e,c,h,g,k);r(e,h,m);u(b,c,a);f(g,m);n(k,a)};a.disable_controls=v;a.reset=function(){e.state=p.CH_STILL;e.hp=p.MAX_CHAR_HP;e.island=-1;g.get_rotation(e.phys_body,Q);q.set_transform(e.phys_body,
E.CHAR_DEF_POS,Q);q.set_character_move_dir(e.phys_body,0,0)};a.apply_hp_potion=function(){B(p.BONUS_HP_INCR);c.play(e.body)};a.apply_lava_protect=function(){c.apply(e.body,"LAVA_grow",c.SLOT_1);c.set_behavior(e.body,c.AB_FINISH_STOP,c.SLOT_1);c.play(e.body,null,c.SLOT_1)};a.remove_lava_protect=x;a.apply_shield=function(){c.apply(e.body,"SHIELD_grow",c.SLOT_2);c.set_behavior(e.body,c.AB_FINISH_STOP,c.SLOT_2);c.play(e.body,null,c.SLOT_2);c.apply(e.shield_sphere,"SHIELD_GLOW_grow");c.set_behavior(e.shield_sphere,
c.AB_FINISH_STOP);c.play(e.shield_sphere)};a.remove_shield=A;a.change_hp=B;a.add_gem=function(a){var b=a.empty;if(e.gem_slot){if(e.gem_slot==a)return;t()}b=a.empty;H.append_stiff(b,e.phys_body,p.GEM_OFFSET,p.GEM_ROT_OFFSET,p.GEM_SCALE_OFFSET);a.state=p.GM_CARRIED;e.gem_slot=a;h.play_def(K)};a.remove_gem=t;a.get_wrapper=function(){return e}});if(b4w.module_check("environment"))throw"Failed to register module: environment";
b4w.register("environment",function(a,b){function F(a,b){function m(a,b,c){b=f.get_sensor_value(a,b,0);c=n.get_object_name(a);l[c]+=b;l[c]<=d.ROCK_FALL_DELAY||(c=q,v.get_translation(a,c),c[1]-=d.ROCK_SPEED*b,v.set_translation_v(a,c))}function g(a,b,c,e){var h=q,g=e[0];e=e[1];c=B.get_wrapper();v.get_translation(c.phys_body,h);c=f.get_sensor_value(a,b,0)?0:1;b=f.get_sensor_payload(a,b,c).coll_pos;h=x.distance(h,b);v.set_translation_v(g,b);u.set_frame(g,0,u.SLOT_ALL);u.play(g,null,u.SLOT_ALL);C(a);h<
d.ROCK_DAMAGE_RADIUS&&(g=-d.ROCK_DAMAGE,0<y.shield_time_left()&&(g*=t.BONUS_SHIELD_EFFECT),B.change_hp(g));a=n.get_object_name(a);l[a]=0;(a=Math.random()<t.BONUS_SPAWN_CHANCE)&&0==c&&y.spawn(b);A.play_def(e)}function r(a,b,c,e){c=f.get_sensor_value(a,b,0)?0:1;b=f.get_sensor_payload(a,b,c).hit_fract;c=q;var h=n.get_object_name(a);l[h]<=d.ROCK_FALL_DELAY&&(v.get_translation(a,c),c[1]-=b*d.ROCK_RAY_LENGTH-.01,v.set_translation_v(e,c));v.set_scale(e,1-b)}for(var k=0;k<d.ROCK_EMPTIES.length;k++)for(var H=
d.ROCK_EMPTIES[k],p=0;p<d.ROCK_NAMES.length;p++){var F=d.ROCK_NAMES[p],w=d.BURST_EMITTER_NAMES[p],G=d.MARK_NAMES[p],E=n.get_object_by_dupli_name(H,F),w=n.get_object_by_dupli_name(H,w),G=n.get_object_by_dupli_name(H,G),D=n.get_object_by_dupli_name(H,d.ROCK_HIT_SPEAKERS[p]),M=f.create_collision_sensor(E,"LAVA",!0),N=f.create_collision_sensor(E,"GROUND",!0),L=f.create_ray_sensor(E,[0,0,0],[0,-d.ROCK_RAY_LENGTH,0],"GROUND",!0),K=f.create_ray_sensor(E,[0,0,0],[0,-d.ROCK_RAY_LENGTH,0],"LAVA",!0);f.create_sensor_manifold(E,
"ROCK_FALL",f.CT_CONTINUOUS,[a],null,m);f.create_sensor_manifold(E,"ROCK_CRASH",f.CT_SHOT,[N,M],function(a){return a[0]||a[1]},g,[w,D]);f.create_sensor_manifold(E,"MARK_POS",f.CT_CONTINUOUS,[L,K],function(a){return a[0]||a[1]},r,G);C(E);l[F]=0}}function C(a){var b=q;b[0]=32*Math.random()-16;b[1]=16*Math.random()+8;b[2]=32*Math.random()-16;v.set_translation_v(a,b)}function r(a){var b=0,m=B.get_wrapper(),g=f.create_ray_sensor(m.phys_body,[0,0,0],[0,-t.CHAR_RAY_LENGTH,0],"LAVA",!0);f.create_sensor_manifold(m.phys_body,
"LAVA_COLLISION",f.CT_CONTINUOUS,[g,a],function(a){return a[0]},function(a,c,d,g){1==d?(a=f.get_sensor_value(a,c,1),b+=a,b>=t.LAVA_DAMAGE_INTERVAL&&(a=a<t.LAVA_DAMAGE_INTERVAL?1:Math.floor(a/t.LAVA_DAMAGE_INTERVAL),0>=y.lava_protect_time_left()&&B.change_hp(-a),b=0)):b=0});"dungeon"==d.LEVEL_NAME&&(a=n.get_object_by_dupli_name("level_02_enviroment","lava"),u.apply_def(a),u.set_behavior(a,u.AB_FINISH_STOP),u.stop(a),u.set_frame(a,0),a=n.get_object_by_dupli_name("lava_death_controller","lava_death_controller"),
u.stop(a),u.set_frame(a,0))}var u=b("animation"),f=b("controls"),n=b("scenes"),v=b("transform"),x=b("vec3"),A=b("sfx"),B=b("character"),t=b("game_config"),y=b("bonuses"),d=null,l={},q=new Float32Array(3);a.init=function(a,b){d=b;r(a);d.ROCK_EMPTIES&&F(a,d)};a.reset=function(){if("volcano"==d.LEVEL_NAME)for(var a=0;a<d.ROCK_EMPTIES.length;a++)for(var b=d.ROCK_EMPTIES[a],f=0;f<d.ROCK_NAMES.length;f++){var g=d.ROCK_NAMES[f],q=n.get_object_by_dupli_name(b,g);C(q);l[g]=0}};a.disable_environment=function(){if(d.ROCK_EMPTIES)for(var a=
0;a<d.ROCK_EMPTIES.length;a++)for(var b=d.ROCK_EMPTIES[a],m=0;m<d.ROCK_NAMES.length;m++){var g=d.MARK_NAMES[m],l=n.get_object_by_dupli_name(b,d.ROCK_NAMES[m]),g=n.get_object_by_dupli_name(b,g);f.remove_sensor_manifold(l);C(l);v.set_translation_v(g,t.DEFAULT_POS)}}});if(b4w.module_check("game_main"))throw"Failed to register module: game_main";
b4w.register("game_main",function(a,b){function F(a){u.remove_sensor_manifold(null,"PLAYLIST");A.reset();l.reset();B.reset();y.reset();d.reset();q.reset();A.setup_controls(a);t.update_hp_bar();r()}function C(a){var b=n.get_active_camera(),c=n.get_object_by_dupli_name("character","camera_target");f.append_semi_soft_cam(b,c,x.CAM_OFFSET,x.CAM_SOFTNESS);a=u.create_ray_sensor(c,x.CAM_OFFSET,[0,0,0],"VISUAL_BLOCKER",!0,!0,!1);u.create_sensor_manifold(c,"CAM_ADJUSTMENT",u.CT_TRIGGER,[a],null,function(a,
d,h){f.remove(b);1==h?f.append_semi_soft_cam(b,c,[0,12,-9],x.CAM_SOFTNESS):f.append_semi_soft_cam(b,c,x.CAM_OFFSET,x.CAM_SOFTNESS)})}function r(){if(c.MUSIC_SPEAKERS){var a=n.get_object_by_dupli_name("enviroment",c.MUSIC_INTRO_SPEAKER),b=n.get_object_by_dupli_name("enviroment",c.MUSIC_END_SPEAKER);a&&b&&(v.play_def(a),v.stop(b),a=v.get_duration(a)*v.get_playrate(a),u.create_sensor_manifold(null,"PLAYLIST",u.CT_SHOT,[u.create_timer_sensor(a)],null,function(a,b,d){u.remove_sensor_manifold(null,"PLAYLIST");
if(!(0>=A.get_wrapper().hp)){a=[];b=c.MUSIC_SPEAKERS;for(d=0;d<b.length;d++){var f=n.get_object_by_dupli_name("enviroment",b[d]);a.push(f)}v.apply_playlist(a,0,!0)}}))}}b("app");b("main");var u=b("controls"),f=b("constraints"),n=b("scenes");b("config");b("print");var v=b("sfx");b("transform");b("physics");b("vec3");b("quat");var x=b("game_config"),A=b("character");b("combat");var B=b("bonuses"),t=b("interface"),y=b("enemies"),d=b("obelisks"),l=b("gems"),q=b("environment"),c=null;new Float32Array(3);
new Float32Array(3);new Float32Array(3);new Float32Array(3);new Float32Array(4);new Float32Array(4);a.level_load_cb=function(a,f,g,n){c=b(f+"_config");A.init_wrapper(c,f);a=u.create_elapsed_sensor();B.init(a,c);y.init(a,c);d.init(a,c);l.init(c);q.init(a,c);r();A.setup_controls(a);C(a);t.init(F,a,n,g)}});if(b4w.module_check("start_menu"))throw"Failed to register module: intro_main";
b4w.register("start_menu",function(a,b){function F(a,b){b?(J=a,a.style.visibility="visible",l.enable_controls(a),document.getElementById("preloader_bg").style.visibility="visible",C()?c.load(Y+"intro_LQ.json",r,d,!0):c.load(Y+"intro_HQ.json",r,d,!0)):I.log("b4w init failure")}function C(){return navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||
navigator.userAgent.match(/Windows Phone/i)?!0:!1}function r(a){O=J.width/2;e=J.height/2;q.get_camera_angles(m.get_active_camera(),R);p.enqueue([["config",p.AT_JSON,"js/intro_config.json"]],u,null);J.addEventListener("mousemove",x,!1);J.addEventListener("mouseup",A,!1)}function u(a,b,c,d){b=a.buttons_info;c=h.create_elapsed_sensor();for(d=0;d<b.length;d++){var e=b[d],g=m.get_object_by_dupli_name_list(e.button_name.split("*"));if(g){var g=g.name,l=m.get_object_by_dupli_name_list(e.mouse_over_speaker.split("*"));
k.stop(l);var p=[],q=e.glow_obj_names;if("object"==typeof q)for(var r=0;r<q.length;r++){var t=m.get_object_by_dupli_name_list(q[r].split("*"));t&&p.push(t)}else p.push(m.get_object_by_dupli_name_list(q.split("*")));M[g]={glow_objs:p,speaker:l,level_name:e.level_name,material:e.material,value_node_name:e.value_node_name,glow_grow_time:e.glow_grow_time,min_glow_value:e.min_glow_value,max_glow_value:e.max_glow_value,glow_curr_value:e.min_glow_value,outline_grow_time:e.outline_grow_time,min_outline_value:e.min_outline_value,
max_outline_value:e.max_outline_value,outline_curr_value:e.min_outline_value,stop_playlist:e.stop_playlist_onclick}}}h.create_sensor_manifold(null,"GLOW",h.CT_CONTINUOUS,[c],null,n);h.create_sensor_manifold(null,"ROT_CAMERA",h.CT_CONTINUOUS,[c],null,v);f(a);b=m.get_object_by_dupli_name_list(a.language_obj.split("*"));c=1;"ru"==Z&&(c=0);P.set_nodemat_value(b,["stones_n_dolmens","language_switcher"],c);S=a.camera_rotation_fac;U=a.environment_start_anim_delay;T=a.environment_anim_length;Q=a.environment_energy_final;
W=a.environment_horizon_final;X=a.environment_zenith_final}function f(a){L=m.get_object_by_dupli_name_list(a.intro_speaker.split("*"));z=m.get_object_by_dupli_name_list(a.end_speaker.split("*"));a=a.playlist_speakers;for(var b=0;b<a.length;b++){var c=m.get_object_by_dupli_name_list(a[b].split("*"));k.stop(c);K.push(c);k.mute(c,!1)}a=k.get_duration(L)*k.get_playrate(L);k.mute(L,!1);k.mute(z,!1);k.stop(z);k.play_def(L);h.create_sensor_manifold(null,"PLAYLIST",h.CT_SHOT,[h.create_timer_sensor(a)],null,
function(a,b,c){N||(k.stop(L),k.apply_playlist(K,0,!0))})}function n(a,b,c){a=h.get_sensor_value(a,b,0);for(var d in M){b=M[d];var e=b.glow_curr_value,f=b.min_glow_value,g=b.max_glow_value,k=a/b.glow_grow_time;c=b.outline_curr_value;var l=b.min_outline_value,n=b.max_outline_value,p=a/b.outline_grow_time;D&&d==D.name&&(e<g&&(b.glow_curr_value+=k),void 0!==c&&c<n&&(b.outline_curr_value+=p));D&&d==D.name||(e>f&&(b.glow_curr_value-=k),void 0!==c&&c>l&&(b.outline_curr_value-=p));if(void 0!==e&&b.glow_curr_value!=
e)for(e=0;e<b.glow_objs.length;e++)P.set_nodemat_value(b.glow_objs[e],[b.material,b.value_node_name],b.glow_curr_value);if(void 0!==c&&b.outline_curr_value!=c)for(e=0;e<b.glow_objs.length;e++)m.set_outline_intensity(b.glow_objs[e],b.outline_curr_value)}}function v(a,b,c){c=m.get_active_camera();q.is_target_camera(c)&&(h.get_sensor_value(a,b,0),a=J.width/2,b=J.height/2,q.get_camera_angles(c,ba),q.target_rotate(c,R[0]-(a-O)/J.width*S,R[1]-(b-e)/J.height*S,!0,!0))}function x(a){a.preventDefault&&a.preventDefault();
var b=a.clientX;a=a.clientY;var c=m.pick_object(b,a);c&&c!=D?(D=c,(c=M[c.name])&&c.speaker&&k.play_def(c.speaker)):!c&&D&&(D=null);O=b;e=a}function A(a){a.preventDefault&&a.preventDefault();(a=m.pick_object(a.clientX,a.clientY))&&M[a.name]&&(a=M[a.name],a.stop_playlist&&(B(),t()),a.level_name&&y(a.level_name))}function B(a){for(a=0;a<K.length;a++){var b=K[a];k.is_play(b)&&k.duck(b,0,1)}k.duck(L,0,1);setTimeout(function(){k.clear_playlist();N=!0;k.play_def(z)},1E3)}function t(){var a=m.get_environment_colors(),
b=a[0],c=a[1],d=a[2],e=0,f=0,g=[0,0,0],k=[0,0,0],l=function(){var a=(f-H.get_timeline())/T;if(0>=a)h.remove_sensor_manifold(null,"ANIMATE_ENV"),m.set_environment_colors(Q,W,X);else{var e=w.lerp(a,Q,b);G.lerp(W,c,a,g);G.lerp(X,d,a,k);m.set_environment_colors(e,g,k)}};setTimeout(function(){e=H.get_timeline();f=e+T;var a=h.create_elapsed_sensor();h.create_sensor_manifold(null,"ANIMATE_ENV",h.CT_CONTINUOUS,[a],null,l)},1E3*U)}function y(a){var b=Y+a+".json";J.removeEventListener("mouseup",A);J.removeEventListener("touchscreen",
A);J.removeEventListener("mousemove",x);c.unload();document.getElementById("preloader_bg").style.visibility="visible";c.load(b,function(b){E.level_load_cb(b,a,d,r)},d,!0)}function d(a){var b=document.getElementById("prelod_dynamic_path"),c=b.nextElementSibling;b.style.width=a+"%";c.innerHTML=a+"%";100==a&&(document.getElementById("preloader_bg").style.visibility="hidden")}var l=b("app");b("camera_anim");var q=b("camera"),c=b("data"),h=b("controls");b("constraints");var m=b("scenes"),g=b("config"),
I=b("print"),k=b("sfx"),H=b("time"),p=b("assets"),P=b("objects");b("container");var w=b("util"),G=b("vec3");b("quat");b("game_config");var E=b("game_main"),D=null,M={},N=!1,L=null,K=[],z=null,J=null,O=0,e=0,R=new Float32Array(2),S=0,U,T,Q,W,X,Z="en",ba=new Float32Array(2),Y=g.get_std_assets_path()+"petigors_tale/";a.init=function(a){Z=a;a=C();var b=0!=document.getElementById("quality_select").selectedIndex||a?g.P_LOW:g.P_HIGH;l.init({canvas_container_id:"canvas3d",callback:F,physics_enabled:!0,quality:b,
console_verbose:!0,show_fps:!0,alpha:!1,physics_use_workers:!a,autoresize:!0})}});
function menu_initialization(){function a(a){if("ru"==a){b.innerHTML="\u041d\u0430\u0447\u0430\u0442\u044c \u0418\u0433\u0440\u0443";F.innerHTML=F.innerHTML.replace("Quality","\u041a\u0430\u0447\u0435\u0441\u0442\u0432\u043e");var f=document.getElementById("quality_select");f.options.length=0;f.options[0]=new Option("\u0412\u044b\u0441","high",!0,!1);f.options[1]=new Option("\u041d\u0438\u0437","high",!1,!1);r.style.backgroundImage="url(interface/title_bg_ru.png)"}else b.innerHTML="Start Game",F.innerHTML=
F.innerHTML.replace("\u041a\u0430\u0447\u0435\u0441\u0442\u0432\u043e","Quality"),f=document.getElementById("quality_select"),f.options.length=0,f.options[0]=new Option("High","high",!0,!1),f.options[1]=new Option("Low","high",!1,!1),r.style.backgroundImage="url(interface/title_bg_en.png)";n=a}var b=document.getElementById("start_game"),F=document.getElementById("quality"),C=document.getElementById("start_menu"),r=document.getElementsByTagName("body")[0],u=document.getElementById("languages_flag_ru"),
f=document.getElementById("languages_flag_en"),n="en";u.addEventListener("click",function(){a("ru")},!1);f.addEventListener("click",function(){a("en")},!1);b.addEventListener("click",function(){C.style.visibility="hidden";b4w.require("start_menu").init(n)},!1)};
