b4w.register("space_disaster",function(ga,d){function ha(b,a){a?ia.load(ja+"space_disaster.json",ka):console.log("b4w init failure")}function la(b,a){for(var u=""+b;u.length<a;)u="0"+u;return u}function ka(b){ma();J.check_browser_support()&&na();oa(J.check_browser_support());pa();qa(J.check_browser_support());ra();sa();ta();W()}function qa(c){for(var a=function(e,a,n){var f=b.get_sensor_value(e,a,0),u=b.get_sensor_value(e,a,1),x=b.get_sensor_value(e,a,2),g=b.get_sensor_value(e,a,3),k=b.get_sensor_value(e,
a,4),h=b.get_sensor_value(e,a,5),R=b.get_sensor_value(e,a,6),S=b.get_sensor_value(e,a,7);n=b.get_sensor_payload(e,a,8);var A=b.get_sensor_value(e,a,9),m=b.get_sensor_value(e,a,10);a=.2*A;var d=N.get_velocities(e,Y);f&&(l-=5*d.trans*A);x&&(l+=5*d.trans*A);g&&(q+=5*d.trans*A);u&&(q-=5*d.trans*A);(k||h||R||S)&&Z(m);q+=5*d.trans*A*n[0];l-=5*d.trans*A*n[1];c||(f=N.get_camera_angles(e,ua)[1]-n[3]*a,N.eye_rotate(e,-n[2]*a,f,!1,!0))},u=function(e){var c=b.create_gamepad_btns_sensor(e,t.DPAD_DOWN_GAMEPAD_BTN),
n=b.create_gamepad_btns_sensor(e,t.DPAD_LEFT_GAMEPAD_BTN),f=b.create_gamepad_btns_sensor(e,t.DPAD_UP_GAMEPAD_BTN),u=b.create_gamepad_btns_sensor(e,t.DPAD_RIGHT_GAMEPAD_BTN),x=b.create_gamepad_btns_sensor(e,t.R1_GAMEPAD_BTN),g=b.create_gamepad_btns_sensor(e,t.R2_GAMEPAD_BTN),h=b.create_gamepad_btns_sensor(e,t.L1_GAMEPAD_BTN),d=b.create_gamepad_btns_sensor(e,t.L2_GAMEPAD_BTN),R=b.create_gamepad_axes_sensor(0),S=b.create_elapsed_sensor(),A=b.create_timeline_sensor(),m=k.get_active_camera();b.create_sensor_manifold(m,
"CONTROLLER_CAMERA_MOVE"+e,b.CT_CONTINUOUS,[c,n,f,u,x,g,h,d,R,S,A],function(){return!0},a)},x=0;4>x;x++)u(x)}function oa(c){if(!c){var a=va.get_canvas();a.addEventListener("mouseup",function(b){wa.request_pointerlock(a)},!1)}c=b.create_timeline_sensor();var u=b.create_mouse_click_sensor();b.create_sensor_manifold(null,"MOUSE_SHOOT",b.CT_POSITIVE,[c,u],null,function(a,e,c){a=b.get_sensor_value(a,e,0);Z(a)})}function pa(){var c=b.create_keyboard_sensor(b.KEY_W),a=b.create_keyboard_sensor(b.KEY_S),u=
b.create_keyboard_sensor(b.KEY_A),g=b.create_keyboard_sensor(b.KEY_D),e=function(a,e,c,n){if(1==c)switch(c=b.get_sensor_value(a,e,0),a=N.get_velocities(a,Y),e){case "LEFT":q-=5*a.trans*c;break;case "RIGHT":q+=5*a.trans*c;break;case "UP":l+=5*a.trans*c;break;case "DOWN":l-=5*a.trans*c}},z=b.create_elapsed_sensor(),n=k.get_active_camera();b.create_sensor_manifold(n,"LEFT",b.CT_CONTINUOUS,[z,u],null,e);b.create_sensor_manifold(n,"RIGHT",b.CT_CONTINUOUS,[z,g],null,e);b.create_sensor_manifold(n,"UP",b.CT_CONTINUOUS,
[z,c],null,e);b.create_sensor_manifold(n,"DOWN",b.CT_CONTINUOUS,[z,a],null,e)}function xa(){var b=h.cockpit_empty,a=v;a[0]=0;a[1]=0;a[2]=0;g.set_translation_v(b,a);b=k.get_active_camera();g.set_translation_v(b,a);(b=h.camera_asteroids_obj)&&g.set_translation_v(b,a);(b=h.environment_empty)&&g.set_translation_v(b,a);l=q=0;h.hp=100;(a=h.cockpit_mesh_obj)&&G.set_nodemat_value(a,["screen","life"],.19)}function ma(){h={cockpit_empty:k.get_object_by_name("cockpit"),cockpit_mesh_obj:k.get_object_by_dupli_name("cockpit",
"cockpit"),camera_asteroids_obj:k.get_object_by_name("Camera_asteroids"),laser_obj:k.get_object_by_dupli_name("cockpit","laser"),laser_arm:k.get_object_by_dupli_name("cockpit","laser_arm"),lighting:k.get_object_by_name("lighting"),cockpit_light:k.get_object_by_name("cockpit_light"),speaker_strike:k.get_object_by_dupli_name("cockpit","speaker_laser_strike"),speaker_alarm:k.get_object_by_dupli_name("cockpit","speaker_alarm"),speaker_ast_hit:k.get_object_by_dupli_name("cockpit","asteroid_hit"),crosshair_obj:k.get_object_by_name("crosshair"),
crosshair_base_obj:k.get_object_by_name("crosshair_base"),environment_empty:k.get_object_by_name("environment"),environment_tunnel_obj:k.get_object_by_dupli_name("environment","Circle"),environment_sphere_obj:k.get_object_by_dupli_name("environment","Sphere"),environment_arm:k.get_object_by_dupli_name("environment","environment_arm"),hp:100};var c=h.cockpit_empty,a=h.cockpit_mesh_obj,u=h.camera_asteroids_obj,x=h.laser_arm,e=h.crosshair_obj,z=h.environment_empty,n=h.environment_arm;if(c&&z){var f=
O.get_bone_tsr(n,"move",B.create()),d=b.create_elapsed_sensor();b.create_sensor_manifold(c,"COCKPIT_TRANSLATION",b.CT_POSITIVE,[d],null,function(a,e,c){if(1E-4<Math.abs(q)||1E-4<Math.abs(l)){c=b.get_sensor_value(a,e,0);e=y.smooth(q,0,c,1);var d=y.smooth(l,0,c,1);q-=e;l-=d;c=g.get_translation(a,v);c[0]+=e;c[1]+=d;g.set_translation_v(a,c);e=k.get_active_camera();g.set_translation_v(e,c);g.set_translation_v(u,c);c[0]-=q/2;c[1]-=l/2;g.set_translation_v(z,c);e=y.clamp(.0625*q,.0625*-Math.PI,.0625*Math.PI);
c=r.setAxisAngle(y.AXIS_MZ,e,w);d=-y.clamp(.0625*l,.0625*-Math.PI,.0625*Math.PI)/4;d=r.setAxisAngle(y.AXIS_MX,d,K);c=r.multiply(c,d,w);g.set_rotation_v(a,c);if(a=h.environment_sphere_obj)c=g.get_rotation(a,w),d=y.clamp(.0625*l,.0625*-Math.PI,.0625*Math.PI)*aa,d=r.setAxisAngle(y.AXIS_MX,d,K),d=r.multiply(c,d,w),e=r.setAxisAngle(y.AXIS_MY,-e*aa,K),d=r.multiply(c,e,w),g.set_rotation_v(a,d);a=B.get_trans_view(f);a=m.copy(a,v);a[0]+=q;a[1]+=l;e=B.copy(f,L);e=B.set_trans(a,e);O.set_bone_tsr(n,"move",e)}})}x&&
e&&(d=b.create_elapsed_sensor(),b.create_sensor_manifold(x,"LASER_ARM",b.CT_CONTINUOUS,[d],null,function(b,a,c){b=g.get_rotation(e,w);b=m.transformQuat(y.AXIS_MY,b,v);b=m.scale(b,100,v);a=g.get_rotation(x,w);a=r.invert(a,w);b=m.transformQuat(b,a,v);a=B.identity(L);45>b[0]&&(a=B.set_trans(b,L));O.set_bone_tsr(x,"left_laser",a);a=B.identity(L);-45<b[0]&&(a=B.set_trans(b,L));O.set_bone_tsr(x,"right_laser",a)}));if(e){var F=k.get_active_camera(),d=b.create_elapsed_sensor();b.create_sensor_manifold(e,
"CROSSHAIR",b.CT_CONTINUOUS,[d],null,function(a,c,e){e=g.get_translation(F,v);g.set_translation_v(a,e);e=g.get_rotation(F,w);var n=g.get_rotation(a,K);c=b.get_sensor_value(a,c,0);c=r.lerp(n,e,5*c,w);g.set_rotation_v(a,c)})}c=Boolean(navigator.getUserMedia)?navigator.getUserMedia.bind(navigator):Boolean(navigator.webkitGetUserMedia)?navigator.webkitGetUserMedia.bind(navigator):Boolean(navigator.mozGetUserMedia)?navigator.mozGetUserMedia.bind(navigator):Boolean(navigator.msGetUserMedia)?navigator.msGetUserMedia.bind(navigator):
null;if(a&&Boolean(c)){var d=function(b){var c=document.createElement("video");c.setAttribute("autoplay","true");c.src=window.URL.createObjectURL(b);var e=ba.get_canvas_ctx(a,"camera_01");if(e){var n=function(){e.drawImage(c,0,0,c.videoWidth,c.videoHeight,0,0,e.canvas.width,e.canvas.height);ba.update_canvas_ctx(a,"camera_01");setTimeout(function(){n()},ya)};c.onloadedmetadata=function(b){n()}}},X=function(){console.error("Couldn't initialize getUserMedia.")};try{var Q={video:{width:1280,height:720}};
c(Q,d,X)}catch(p){Q={video:{mandatory:{maxWidth:1024,maxHeight:768,minWidth:1024,minHeight:768}}},c(Q,d,X)}}}function ta(){var c=k.get_active_camera();if(c){var a=b.create_timeline_sensor();b.create_sensor_manifold(c,"SHAKE_COCKPIT",b.CT_CONTINUOUS,[a,T],null,function(a,c,e){a=b.get_sensor_value(a,c,0);1>a-P?(q+=(Math.random()-.5)*(1-(a-P)/1),l+=(Math.random()-.5)*(1-(a-P)/1)):b.set_custom_sensor(T,0)})}}function na(){J.enable_hmd(J.HMD_ALL_AXES_MOUSE_NONE);var c=b.create_elapsed_sensor(),a=b.create_hmd_position_sensor(),
d=!1,g=m.create();m.create();var e=k.get_active_camera();b.create_sensor_manifold(e,"HMD_TRANSLATE_CAMERA",b.CT_CONTINUOUS,[c,a],null,function(a,c,e){0<e&&(a=b.get_sensor_payload(a,c,1),t.get_device_by_type_element(t.DEVICE_HMD),d?(c=m.subtract(a,g,H),m.scale(c,15,c),q+=c[0],l+=c[1],m.copy(a,g)):(m.copy(a,g),d=!0))})}function U(b){for(var a=0;a<C.length;a++)if(C[a].name==b)return C[a]}function ra(){for(var c=0;11>c;c++){var a="asteroid."+la(c,3),d=k.get_object_by_name(a);if(d){for(var h=k.get_object_children(d),
e=null,z=null,n=null,f=0;f<h.length;f++)G.is_armature(h[f])&&(e=h[f]),"explosion_emitter"==k.get_object_name(h[f])&&(z=h[f]),G.is_speaker(h[f])&&(n=h[f]);for(var h=k.get_object_by_name(a+"_copy"),l=null,F=k.get_object_children(h),f=0;f<F.length;f++)G.is_mesh(F[f])&&(l=F[f]);d={name:a,ast_obj:d,ast_arm:e,ast_copy_obj:h,ast_copy_mesh_obj:l,ast_emitter_obj:z,ast_speaker:n,active:!1,angular_velosity:r.create(),velosity:m.create(),strength:100,is_destroyed:!1};C.push(d);M(d);e=b.create_elapsed_sensor();
b.create_sensor_manifold(d,"UPDATE_ASTEROID"+a,b.CT_CONTINUOUS,[e],null,function(a,c,e){if(a.active){var d=a.ast_obj;e=g.get_translation(d,v);c=b.get_sensor_value(a,c,0);var n=m.scale(a.velosity,c,H);m.add(e,n,e);g.set_translation_v(d,e);c=r.slerp(za,a.angular_velosity,c,w);n=g.get_rotation(d,K);c=r.multiply(n,c,w);g.set_rotation_v(d,c);if(d=a.ast_copy_obj)g.set_translation_v(d,e),g.set_rotation_v(d,c);20<e[2]&&M(a)}})}}}function Aa(b){b=k.get_object_name_hierarchy(b)[0];b=U(b);b.is_destroyed=!1;
M(b)}function M(b){var a=b.ast_obj,d=v;d[0]=0;d[1]=0;d[2]=-1E3;r.identity(w);g.set_translation_v(a,d);(a=b.ast_copy_obj)&&g.set_translation_v(a,d);m.set(0,0,0,b.velosity);r.identity(b.angular_velosity);b.active=!1;b.strength=100}function Z(c){if(1.2<c-ca){b.set_custom_sensor(V,1);var a=h.laser_obj;a&&(p.apply(a,"laser_strike"),p.play(a),p.set_behavior(a,p.AB_FINISH_STOP));da=ca=c;(c=h.speaker_strike)&&D.play_def(c);if(c=h.lighting)p.apply(c,"laser_strike_lighting"),p.play(c)}}function sa(){var c=
function(a,c,d){b.get_sensor_value(a,c,0)-da>Ba&&(b.set_custom_sensor(V,0),(d=h.speaker_strike)&&D.is_playing(d)&&D.stop(d));d=g.get_translation(a,v);var f=g.get_rotation(a,w),f=m.transformQuat(y.AXIS_MY,f,H),f=m.scale(f,100,H),f=m.add(f,d,f),l=b.get_sensor_value(a,c,1);c=Ca.append_ray_test(null,d,f,"crash",function(a,b,c,e){a=c;c=700*l;e=k.get_object_name_hierarchy(a)[0];b=k.get_object_name_hierarchy(a)[1];if((a=U(e))&&!a.is_destroyed&&(a.strength-=c,0>a.strength)){m.set(0,0,0,a.velosity);r.identity(a.angular_velosity);
if(c=a.ast_arm)p.apply(c,b+"_disruption"),p.play(c,Aa);if(b=a.ast_copy_mesh_obj)p.apply(b,"asteroid_fading"),p.play(b);if(b=h.lighting)p.apply(b,"asteroid_burst"),p.play(b);if(c=a.ast_emitter_obj)b=g.get_translation(a.ast_obj,v),g.set_translation_v(c,b),p.apply(c,"explosion"),p.play(c);if(c=a.ast_speaker)b=g.get_translation(a.ast_obj,v),g.set_translation_v(c,b),D.play_def(c);a.is_destroyed=!0}},!0)},a=h.crosshair_obj;if(a){var d=b.create_timeline_sensor(),l=b.create_elapsed_sensor();b.create_sensor_manifold(a,
"BURST",b.CT_POSITIVE,[d,l,V],null,c)}}function W(){ea.log("START GAME.");xa();var c=b.create_timeline_sensor(),a=k.get_active_camera();b.create_sensor_manifold(a,"ASTEROID_SPAWN",b.CT_POSITIVE,[c],null,function(a,c,d){c=b.get_sensor_value(a,c,0);if(c-fa>I)for(var f=0;f<C.length;f++)if(d=C[f],!d.active){f=g.get_translation(a,v);a=d;a.active=!0;d=m.copy(f,H);d[0]+=2*(2*Math.random()-1);d[1]+=2*(2*Math.random()-1);d[2]=0;f=m.copy(f,v);f[0]+=20*(2*Math.random()-1);f[1]+=20*Math.random()/2;f[2]=-100;
g.set_translation_v(a.ast_obj,f);var k=a.ast_copy_obj;k&&g.set_translation_v(k,f);d=m.subtract(d,f,H);m.normalize(d,d);d=m.scale(d,E,d);E=50>E?E+1:E;(f=h.cockpit_mesh_obj)&&G.set_nodemat_value(f,["screen","speed"],1-(E-20)/30*8%8*.1);m.copy(d,a.velosity);d=m.set(2*Math.random()-1,2*Math.random()-1,2*Math.random()-1,v);a.angular_velosity=r.setAxisAngle(d,Math.PI*(2*Math.random()-1)*10,a.angular_velosity);fa=c;I=.5<I?I-.02:I;break}});var d=b.create_collision_sensor(a,"crash",!1),l=0;b.create_sensor_manifold(a,
"CRASH",b.CT_CONTINUOUS,[d,c],null,function(c,d,g){g=b.get_sensor_value(c,d,1);if(!(1>g-l)){l=g;h.hp-=12.4;var f=h.cockpit_mesh_obj;f&&G.set_nodemat_value(f,["screen","life"],1-.8*h.hp/100);if(0<h.hp){if(c=b.get_sensor_payload(c,d,0).coll_obj){f&&(p.apply(f,"cockpit_shader_alarm",p.SLOT_0),p.apply(f,"screen_shader_alarm",p.SLOT_1),p.play(f,null,p.SLOT_ALL));if(d=h.cockpit_light)p.apply(d,"cockpit_light_alarm"),p.play(d);if(d=h.speaker_alarm)D.is_playing(d)&&D.stop(d),D.play_def(d);(d=h.speaker_ast_hit)&&
D.play_def(d);c=k.get_object_name_hierarchy(c)[0];(c=U(c))&&M(c);b.set_custom_sensor(T,1);P=g}}else{ea.log("PLAYERS HP IS LESS 0. RESTART GAME.");for(g=0;g<C.length;g++)M(C[g]);E=20;I=2;b.remove_sensor_manifold(a,"CRASH");b.remove_sensor_manifold(a,"ASTEROID_SPAWN");W()}}})}var Da=d("app"),p=d("animation"),O=d("armature"),N=d("camera"),Ea=d("config"),va=d("container"),b=d("controls"),ia=d("data"),J=d("hmd"),t=d("input"),wa=d("mouse"),r=d("quat"),G=d("objects"),ea=d("print"),Ca=d("physics"),k=d("scenes"),
D=d("sfx"),ba=d("textures"),g=d("transform"),B=d("tsr"),m=d("vec3"),Fa=d("version"),y=d("util"),w=r.create(),K=r.create(),ua=new Float32Array(2),v=m.create(),H=m.create(),L=B.create(),za=new Float32Array([0,0,0,1]),ya=1E3/24,Ba=5/6,aa=1/512,I=2,fa=0,E=20,h=null,C=[],Y={},q=0,l=0,P=0,ca=0,da=0,V=b.create_custom_sensor(0),T=b.create_custom_sensor(0);Fa.type();var ja=Ea.get_std_assets_path()+"space_disaster/";ga.init=function(){if(t.can_use_device(t.DEVICE_HMD)){var b=t.get_device_by_type_element(t.DEVICE_HMD);
t.register_device(b)}Da.init({canvas_container_id:"main_canvas_container",callback:ha,console_verbose:!0,autoresize:!0,stereo:t.can_use_device(t.DEVICE_HMD)?"HMD":"NONE"})}});b4w.require("space_disaster").init();
