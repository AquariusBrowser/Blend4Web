b4w.register("space_disaster",function(ga,k){function ha(b,a){a?ia.load(ja+"space_disaster.json",ka):console.log("b4w init failure")}function la(b,a){for(var u=""+b;u.length<a;)u="0"+u;return u}function ka(b){ma();H.check_browser_support()&&na();oa(H.check_browser_support());pa();qa(H.check_browser_support());ra();sa();ta();W();b=l.get_object_by_name("sundtrack_entrance");var a=l.get_object_by_name("sundtrack_loop_A");z.play(b,0,0);z.play(a,69,0)}function qa(d){ua.update();for(var a=function(c,a,
n){var f=b.get_sensor_value(c,a,0),u=b.get_sensor_value(c,a,1),x=b.get_sensor_value(c,a,2),g=b.get_sensor_value(c,a,3),l=b.get_sensor_value(c,a,4),h=b.get_sensor_value(c,a,5),P=b.get_sensor_value(c,a,6),Q=b.get_sensor_value(c,a,7),R=b.get_sensor_value(c,a,8),p=b.get_sensor_value(c,a,9);n=b.get_sensor_value(c,a,10);var k=b.get_sensor_value(c,a,11),e=b.get_sensor_value(c,a,12),t=b.get_sensor_value(c,a,13);a=.2*e;var r=L.get_velocities(c,Y);f&&(m+=5*r.trans*e);x&&(m-=5*r.trans*e);g&&(q-=5*r.trans*e);
u&&(q+=5*r.trans*e);(l||h||P||Q)&&Z(t);d||(q-=5*r.trans*e*R,m+=5*r.trans*e*p,f=L.get_camera_angles(c,va)[1]-k*a,L.eye_rotate(c,-n*a,f,!1,!0))},u=function(c){var d=b.create_gamepad_btn_sensor(r.GMPD_BUTTON_12,c),n=b.create_gamepad_btn_sensor(r.GMPD_BUTTON_15,c),f=b.create_gamepad_btn_sensor(r.GMPD_BUTTON_13,c),u=b.create_gamepad_btn_sensor(r.GMPD_BUTTON_14,c),x=b.create_gamepad_btn_sensor(r.GMPD_BUTTON_4,c),g=b.create_gamepad_btn_sensor(r.GMPD_BUTTON_5,c),h=b.create_gamepad_btn_sensor(r.GMPD_BUTTON_6,
c),e=b.create_gamepad_btn_sensor(r.GMPD_BUTTON_7,c),P=b.create_gamepad_axis_sensor(r.GMPD_AXIS_0,c),Q=b.create_gamepad_axis_sensor(r.GMPD_AXIS_1,c),R=b.create_gamepad_axis_sensor(r.GMPD_AXIS_2,c),p=b.create_gamepad_axis_sensor(r.GMPD_AXIS_3,c),k=b.create_elapsed_sensor(),m=b.create_timeline_sensor(),q=l.get_active_camera();b.create_sensor_manifold(q,"CONTROLLER_CAMERA_MOVE"+c,b.CT_CONTINUOUS,[d,n,f,u,x,g,h,e,P,Q,R,p,k,m],function(){return!0},a)},x=0;4>x;x++)u(x)}function oa(d){if(!d){var a=aa.get_canvas();
a.addEventListener("mouseup",function(b){wa.request_pointerlock(a)},!1)}var u=!1;aa.get_container().addEventListener("click",function(b){r.request_fullscreen_hmd();u=!0});d=b.create_timeline_sensor();b.create_sensor_manifold(null,"MOUSE_SHOOT",b.CT_POSITIVE,[d],null,function(a,c,d){u&&(a=b.get_sensor_value(a,c,0),Z(a),u=!1)})}function pa(){var d=b.create_keyboard_sensor(b.KEY_W),a=b.create_keyboard_sensor(b.KEY_S),u=b.create_keyboard_sensor(b.KEY_A),g=b.create_keyboard_sensor(b.KEY_D),c=function(a,
c,d,n){if(1==d)switch(d=b.get_sensor_value(a,c,0),a=L.get_velocities(a,Y),c){case "LEFT":q-=5*a.trans*d;break;case "RIGHT":q+=5*a.trans*d;break;case "UP":m+=5*a.trans*d;break;case "DOWN":m-=5*a.trans*d}},C=b.create_elapsed_sensor(),n=l.get_active_camera();b.create_sensor_manifold(n,"LEFT",b.CT_CONTINUOUS,[C,u],null,c);b.create_sensor_manifold(n,"RIGHT",b.CT_CONTINUOUS,[C,g],null,c);b.create_sensor_manifold(n,"UP",b.CT_CONTINUOUS,[C,d],null,c);b.create_sensor_manifold(n,"DOWN",b.CT_CONTINUOUS,[C,a],
null,c)}function xa(){var b=h.cockpit_empty,a=v;a[0]=0;a[1]=0;a[2]=0;g.set_translation_v(b,a);b=l.get_active_camera();g.set_translation_v(b,a);(b=h.camera_asteroids_obj)&&g.set_translation_v(b,a);(b=h.environment_empty)&&g.set_translation_v(b,a);m=q=0;h.hp=100;(a=h.cockpit_mesh_obj)&&E.set_nodemat_value(a,["screen","life"],.19)}function ma(){h={cockpit_empty:l.get_object_by_name("cockpit"),cockpit_mesh_obj:l.get_object_by_dupli_name("cockpit","cockpit"),camera_asteroids_obj:l.get_object_by_name("Camera_asteroids"),
laser_obj:l.get_object_by_dupli_name("cockpit","laser"),laser_arm:l.get_object_by_dupli_name("cockpit","laser_arm"),lighting:l.get_object_by_name("lighting"),cockpit_light:l.get_object_by_name("cockpit_light"),speaker_strike:l.get_object_by_dupli_name("cockpit","speaker_laser_strike"),speaker_alarm:l.get_object_by_dupli_name("cockpit","speaker_alarm"),speaker_ast_hit:l.get_object_by_dupli_name("cockpit","asteroid_hit"),crosshair_obj:l.get_object_by_name("crosshair"),crosshair_base_obj:l.get_object_by_name("crosshair_base"),
environment_empty:l.get_object_by_name("environment"),environment_tunnel_obj:l.get_object_by_dupli_name("environment","Circle"),environment_sphere_obj:l.get_object_by_dupli_name("environment","Sphere"),environment_arm:l.get_object_by_dupli_name("environment","environment_arm"),hp:100};var d=h.cockpit_empty,a=h.cockpit_mesh_obj,u=h.camera_asteroids_obj,x=h.laser_arm,c=h.crosshair_obj,C=h.environment_empty,n=h.environment_arm;if(d&&C){var f=M.get_bone_tsr(n,"move",A.create()),e=b.create_elapsed_sensor();
b.create_sensor_manifold(d,"COCKPIT_TRANSLATION",b.CT_POSITIVE,[e],null,function(a,c,d){if(1E-4<Math.abs(q)||1E-4<Math.abs(m)){d=b.get_sensor_value(a,c,0);c=y.smooth(q,0,d,1);var e=y.smooth(m,0,d,1);q-=c;m-=e;d=g.get_translation(a,v);d[0]+=c;d[1]+=e;g.set_translation_v(a,d);c=l.get_active_camera();g.set_translation_v(c,d);g.set_translation_v(u,d);d[0]-=q/2;d[1]-=m/2;g.set_translation_v(C,d);c=y.clamp(.0625*q,.0625*-Math.PI,.0625*Math.PI);d=t.setAxisAngle(y.AXIS_MZ,c,w);e=-y.clamp(.0625*m,.0625*-Math.PI,
.0625*Math.PI)/4;e=t.setAxisAngle(y.AXIS_MX,e,I);d=t.multiply(d,e,w);g.set_rotation_v(a,d);if(a=h.environment_sphere_obj)d=g.get_rotation(a,w),e=y.clamp(.0625*m,.0625*-Math.PI,.0625*Math.PI)*ba,e=t.setAxisAngle(y.AXIS_MX,e,I),e=t.multiply(d,e,w),c=t.setAxisAngle(y.AXIS_MY,-c*ba,I),e=t.multiply(d,c,w),g.set_rotation_v(a,e);a=A.get_trans_view(f);a=p.copy(a,v);a[0]+=q;a[1]+=m;c=A.copy(f,J);c=A.set_trans(a,c);M.set_bone_tsr(n,"move",c)}})}h.environment_tunnel_obj&&(e=b.create_elapsed_sensor());x&&c&&
(e=b.create_elapsed_sensor(),b.create_sensor_manifold(x,"LASER_ARM",b.CT_CONTINUOUS,[e],null,function(b,a,d){b=g.get_rotation(c,w);b=p.transformQuat(y.AXIS_MY,b,v);b=p.scale(b,100,v);a=g.get_rotation(x,w);a=t.invert(a,w);b=p.transformQuat(b,a,v);a=A.identity(J);45>b[0]&&(a=A.set_trans(b,J));M.set_bone_tsr(x,"left_laser",a);a=A.identity(J);-45<b[0]&&(a=A.set_trans(b,J));M.set_bone_tsr(x,"right_laser",a)}));if(c){var k=l.get_active_camera(),e=b.create_elapsed_sensor();b.create_sensor_manifold(c,"CROSSHAIR",
b.CT_CONTINUOUS,[e],null,function(a,c,d){d=g.get_translation(k,v);g.set_translation_v(a,d);d=g.get_rotation(k,w);var n=g.get_rotation(a,I);c=b.get_sensor_value(a,c,0);c=t.lerp(n,d,5*c,w);g.set_rotation_v(a,c)})}d=Boolean(navigator.getUserMedia)?navigator.getUserMedia.bind(navigator):Boolean(navigator.webkitGetUserMedia)?navigator.webkitGetUserMedia.bind(navigator):Boolean(navigator.mozGetUserMedia)?navigator.mozGetUserMedia.bind(navigator):Boolean(navigator.msGetUserMedia)?navigator.msGetUserMedia.bind(navigator):
null;if(a&&Boolean(d)){var e=function(b){var c=document.createElement("video");c.setAttribute("autoplay","true");c.src=window.URL.createObjectURL(b);var d=ca.get_canvas_ctx(a,"camera_01");if(d){var n=function(){d.drawImage(c,0,0,c.videoWidth,c.videoHeight,0,0,d.canvas.width,d.canvas.height);ca.update_canvas_ctx(a,"camera_01");setTimeout(function(){n()},ya)};c.onloadedmetadata=function(b){n()}}},X=function(){S.warn("Web-camera is not avaliable. Please check web-camera connection and allow access to the web-camera.")};
try{var O={video:{width:1280,height:720}};d(O,e,X)}catch(r){O={video:{mandatory:{maxWidth:1024,maxHeight:768,minWidth:1024,minHeight:768}}},d(O,e,X)}}}function ta(){var d=l.get_active_camera();if(d){var a=b.create_timeline_sensor();b.create_sensor_manifold(d,"SHAKE_COCKPIT",b.CT_CONTINUOUS,[a,T],null,function(a,d,c){a=b.get_sensor_value(a,d,0);1>a-N?(q+=(Math.random()-.5)*(1-(a-N)/1),m+=(Math.random()-.5)*(1-(a-N)/1)):b.set_custom_sensor(T,0)})}}function na(){za.update();H.enable_hmd(H.HMD_ALL_AXES_MOUSE_NONE);
var d=b.create_elapsed_sensor(),a=b.create_hmd_position_sensor(),e=!1,g=p.create();p.create();var c=l.get_active_camera();b.create_sensor_manifold(c,"HMD_TRANSLATE_CAMERA",b.CT_CONTINUOUS,[d,a],null,function(a,c,d){0<d&&(a=b.get_sensor_payload(a,c,1),r.get_device_by_type_element(r.DEVICE_HMD),e?(c=p.subtract(a,g,F),p.scale(c,15,c),q+=c[0],m+=c[1],p.copy(a,g)):(p.copy(a,g),e=!0))})}function U(b){for(var a=0;a<B.length;a++)if(B[a].name==b)return B[a]}function ra(){for(var d=0;11>d;d++){var a="asteroid."+
la(d,3),e=l.get_object_by_name(a);if(e){for(var h=l.get_object_children(e),c=null,k=null,n=null,f=0;f<h.length;f++)E.is_armature(h[f])&&(c=h[f]),"explosion_emitter"==l.get_object_name(h[f])&&(k=h[f]),E.is_speaker(h[f])&&(n=h[f]);for(var h=l.get_object_by_name(a+"_copy"),m=null,q=l.get_object_children(h),f=0;f<q.length;f++)E.is_mesh(q[f])&&(m=q[f]);e={name:a,ast_obj:e,ast_arm:c,ast_copy_obj:h,ast_copy_mesh_obj:m,ast_emitter_obj:k,ast_speaker:n,active:!1,angular_velosity:t.create(),velosity:p.create(),
strength:100,is_destroyed:!1};B.push(e);K(e);c=b.create_elapsed_sensor();b.create_sensor_manifold(e,"UPDATE_ASTEROID"+a,b.CT_CONTINUOUS,[c],null,function(a,c,d){if(a.active){var e=a.ast_obj;d=g.get_translation(e,v);c=b.get_sensor_value(a,c,0);var n=p.scale(a.velosity,c,F);p.add(d,n,d);g.set_translation_v(e,d);c=t.slerp(Aa,a.angular_velosity,c,w);n=g.get_rotation(e,I);c=t.multiply(n,c,w);t.normalize(c,c);g.set_rotation_v(e,c);if(e=a.ast_copy_obj)g.set_translation_v(e,d),g.set_rotation_v(e,c);20<d[2]&&
K(a)}})}}}function Ba(b){b=l.get_object_name_hierarchy(b)[0];b=U(b);b.is_destroyed=!1;K(b)}function K(b){var a=b.ast_obj,e=v;e[0]=0;e[1]=0;e[2]=-1E3;t.identity(w);g.set_translation_v(a,e);(a=b.ast_copy_obj)&&g.set_translation_v(a,e);p.set(0,0,0,b.velosity);t.identity(b.angular_velosity);b.active=!1;b.strength=100}function Z(d){if(1.2<d-da){b.set_custom_sensor(V,1);var a=h.laser_obj;a&&(e.apply(a,"laser_strike"),e.play(a),e.set_behavior(a,e.AB_FINISH_STOP));ea=da=d;(d=h.speaker_strike)&&z.play_def(d);
if(d=h.lighting)e.apply(d,"laser_strike_lighting"),e.play(d)}}function sa(){var d=function(a,d,n){b.get_sensor_value(a,d,0)-ea>Ca&&(b.set_custom_sensor(V,0),(n=h.speaker_strike)&&z.is_playing(n)&&z.stop(n));n=g.get_translation(a,v);var f=g.get_rotation(a,w),f=p.transformQuat(y.AXIS_MY,f,F),f=p.scale(f,100,F),f=p.add(f,n,f),k=b.get_sensor_value(a,d,1);d=Da.append_ray_test(null,n,f,"crash",function(b,a,c,d){b=c;c=700*k;d=l.get_object_name_hierarchy(b)[0];a=l.get_object_name_hierarchy(b)[1];if((b=U(d))&&
!b.is_destroyed&&(b.strength-=c,0>b.strength)){p.set(0,0,0,b.velosity);t.identity(b.angular_velosity);if(c=b.ast_arm)e.apply(c,a+"_disruption"),e.play(c,Ba);if(a=b.ast_copy_mesh_obj)e.apply(a,"asteroid_fading"),e.play(a);if(a=h.lighting)e.apply(a,"asteroid_burst"),e.play(a);if(c=b.ast_emitter_obj)a=g.get_translation(b.ast_obj,v),g.set_translation_v(c,a),e.apply(c,"explosion"),e.play(c);if(c=b.ast_speaker)a=g.get_translation(b.ast_obj,v),g.set_translation_v(c,a),z.play_def(c);b.is_destroyed=!0}},!0)},
a=h.crosshair_obj;if(a){var k=b.create_timeline_sensor(),m=b.create_elapsed_sensor();b.create_sensor_manifold(a,"BURST",b.CT_POSITIVE,[k,m,V],null,d)}}function W(){S.log("START GAME.");xa();var d=b.create_timeline_sensor(),a=l.get_active_camera();b.create_sensor_manifold(a,"ASTEROID_SPAWN",b.CT_POSITIVE,[d],null,function(a,d,e){d=b.get_sensor_value(a,d,0);if(d-fa>G)for(var f=0;f<B.length;f++)if(e=B[f],!e.active){f=g.get_translation(a,v);a=e;a.active=!0;e=p.copy(f,F);e[0]+=3*(2*Math.random()-1);e[1]+=
3*(2*Math.random()-1);e[2]=0;f=p.copy(f,v);f[0]+=20*(2*Math.random()-1);f[1]+=20*Math.random()/2;f[2]=-100;g.set_translation_v(a.ast_obj,f);var k=a.ast_copy_obj;k&&g.set_translation_v(k,f);e=p.subtract(e,f,F);p.normalize(e,e);e=p.scale(e,D,e);D=40>D?D+1:D;(f=h.cockpit_mesh_obj)&&E.set_nodemat_value(f,["screen","speed"],1-(D-20)/20*8%8*.1);p.copy(e,a.velosity);e=p.set(2*Math.random()-1,2*Math.random()-1,2*Math.random()-1,v);a.angular_velosity=t.setAxisAngle(e,Math.PI*(2*Math.random()-1)*10,a.angular_velosity);
fa=d;G=.2<G?G-.03:G;break}});var k=b.create_collision_sensor(a,"crash",!1),m=0;b.create_sensor_manifold(a,"CRASH",b.CT_CONTINUOUS,[k,d],null,function(c,d,g){g=b.get_sensor_value(c,d,1);if(!(1>g-m)){m=g;h.hp-=12.4;var f=h.cockpit_mesh_obj;f&&E.set_nodemat_value(f,["screen","life"],1-.8*h.hp/100);if(0<h.hp){if(c=b.get_sensor_payload(c,d,0).coll_obj){f&&(e.apply(f,"cockpit_shader_alarm",e.SLOT_0),e.apply(f,"screen_shader_alarm",e.SLOT_1),e.play(f,null,e.SLOT_ALL));if(d=h.cockpit_light)e.apply(d,"cockpit_light_alarm"),
e.play(d);if(d=h.speaker_alarm)z.is_playing(d)&&z.stop(d),z.play_def(d);(d=h.speaker_ast_hit)&&z.play_def(d);c=l.get_object_name_hierarchy(c)[0];(c=U(c))&&K(c);b.set_custom_sensor(T,1);N=g}}else{S.log("PLAYERS HP IS LESS 0. RESTART GAME.");for(g=0;g<B.length;g++)K(B[g]);D=20;G=2;b.remove_sensor_manifold(a,"CRASH");b.remove_sensor_manifold(a,"ASTEROID_SPAWN");W()}}})}var Ea=k("app"),e=k("animation"),M=k("armature"),L=k("camera"),Fa=k("config"),aa=k("container"),b=k("controls"),ia=k("data"),ua=k("gp_conf"),
H=k("hmd"),za=k("hmd_conf"),r=k("input"),wa=k("mouse"),t=k("quat"),E=k("objects"),S=k("print"),Da=k("physics"),l=k("scenes"),z=k("sfx"),ca=k("textures"),g=k("transform"),A=k("tsr"),p=k("vec3"),Ga=k("version"),y=k("util"),w=t.create(),I=t.create(),va=new Float32Array(2),v=p.create(),F=p.create(),J=A.create(),Aa=new Float32Array([0,0,0,1]),ya=1E3/24,Ca=5/6,ba=1/512,G=2,fa=0,D=20,h=null,B=[],Y={},q=0,m=0,N=0,da=0,ea=0,V=b.create_custom_sensor(0),T=b.create_custom_sensor(0);Ga.type();var ja=Fa.get_std_assets_path()+
"space_disaster/";ga.init=function(){Ea.init({canvas_container_id:"main_canvas_container",callback:ha,console_verbose:!0,autoresize:!0,stereo:"HMD"})}});b4w.require("space_disaster").init();
